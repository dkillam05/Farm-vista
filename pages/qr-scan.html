<!-- =====================================================================
/Farm-vista/pages/qr/scan.html
Fix: unwrap nested launch.html?to=... and guard against double navigation
===================================================================== -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>QR Scanner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <style>
    body{margin:0;background:var(--page-bg,#f6f7f6);}
    .page{max-width:860px;margin:0 auto;padding:clamp(14px,2.5vw,20px)}
    .card{background:#fff;border:1px solid var(--border,#e5e7eb);border-radius:14px;box-shadow:0 1px 0 rgba(0,0,0,.04);overflow:hidden}
    .card .body{padding:12px}
    .viewport{position:relative;background:#000;border-radius:12px;overflow:hidden;min-height:60vh;display:grid;place-items:center}
    video{width:100%;height:100%;object-fit:cover}
    canvas{display:none}
    .reticle{position:absolute;inset:0;pointer-events:none}
    .reticle::before{
      content:""; position:absolute; left:50%; top:50%; width:min(72vmin,380px); height:min(72vmin,380px);
      transform:translate(-50%,-50%);
      border:3px solid rgba(255,255,255,.95); border-radius:18px; box-shadow:0 0 0 200vmax rgba(0,0,0,.36) inset;
    }
    .row{display:flex; gap:10px; margin-top:12px}
    .btn{flex:1 1 auto; border-radius:12px; padding:14px; font-weight:800; font-size:16px;
      border:1px solid var(--border,#e5e7eb); cursor:pointer;}
    .btn-cancel{background:#fff;color:#111}
    .status{margin-top:8px;font-size:13px}
    .ok{color:#3B7E46}.bad{color:#b91c1c}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
</head>
<body>
  <fv-shell>
    <div class="page container">
      <div class="card">
        <div class="body">
          <div class="viewport">
            <video id="video" playsinline muted></video>
            <div class="reticle" aria-hidden="true"></div>
            <canvas id="canvas"></canvas>
          </div>
          <div class="row">
            <button id="btnCancel" class="btn btn-cancel">Cancel</button>
          </div>
          <div id="status" class="status"></div>
        </div>
      </div>
    </div>
  </fv-shell>

<script>
(function(){
  const APP_SCOPE = '/Farm-vista/';
  const LAUNCH = (to) => `${location.origin}${APP_SCOPE}launch.html?to=${encodeURIComponent(to)}`;
  let didNav = false; // prevent double navigate

  const $ = (id)=> document.getElementById(id);
  const video = $('video'), canvas = $('canvas'), status = $('status');
  const btnCancel = $('btnCancel');

  let stream = null, raf = null, running = false;

  function setStatus(msg, ok=true){ status.innerHTML = (ok?'<span class="ok">✓</span> ':'<span class="bad">⚠</span> ')+msg; }

  function normalize(href){
    try { return new URL(href, location.origin).href; } catch {
      const path = href.startsWith('/') ? href : '/'+href;
      return new URL(path, location.origin).href;
    }
  }

  function unwrapLaunch(url){
    try{
      const u = new URL(url, location.origin);
      if (u.pathname.includes('/launch.html') && u.searchParams.has('to')){
        return unwrapLaunch(u.searchParams.get('to'));
      }
    }catch{}
    return url;
  }

  function go(targetAbs){
    if (didNav) return;
    didNav = true;
    location.href = LAUNCH(targetAbs);
  }

  function cleanup(){
    running = false;
    if (raf) cancelAnimationFrame(raf), raf=null;
    if (stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
  }

  async function start(){
    try{
      cleanup();
      stream = await navigator.mediaDevices.getUserMedia({
        video:{ facingMode:'environment', width:{ideal:1280}, height:{ideal:720} }, audio:false
      });
      video.srcObject = stream;
      await video.play();
      running = true;
      setStatus('Camera running…');

      const ctx = canvas.getContext('2d', { willReadFrequently:true });

      (function tick(){
        if (!running) return;
        if (!video.videoWidth){ raf=requestAnimationFrame(tick); return; }
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        ctx.drawImage(video,0,0,canvas.width,canvas.height);
        const img = ctx.getImageData(0,0,canvas.width,canvas.height);

        const code = jsQR(img.data, img.width, img.height, { inversionAttempts:'attemptBoth' });

        if (code && code.data){
          cleanup();
          setStatus('QR detected. Opening…');
          let abs = normalize(code.data.trim());
          abs = unwrapLaunch(abs);
          go(abs);
          return;
        }
        raf = requestAnimationFrame(tick);
      })();
    }catch(e){
      console.error(e);
      setStatus('Camera access failed. Check permissions.', false);
    }
  }

  btnCancel.addEventListener('click', ()=>{
    cleanup();
    if (window.history.length > 1) history.back();
    else location.replace(APP_SCOPE);
  });

  document.addEventListener('visibilitychange', ()=>{ if (document.visibilityState==='visible' && !running && !stream) start(); });
  start();
})();
</script>
</body>
</html>
