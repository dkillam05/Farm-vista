<!doctype html><html lang="en"><head>
  <meta charset="utf-8"/>
  <title>FarmVista • Expenditures – Add</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <!-- Quick local OCR (images/screenshots). Keep this one line: -->
  <script defer src="/Farm-vista/js/ocr-tesseract.js"></script>

  <style>
    .section{border:1px solid var(--border); border-radius:14px; background:var(--surface); box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));}
    .section-head{display:grid; grid-template-columns:36px 1fr; gap:12px; align-items:center; padding:14px 16px; border-bottom:1px solid var(--border); background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);}
    .section-head .icon{width:24px; height:24px; color:#2F6C3C; display:grid; place-items:center;}
    .section-body{padding:16px; display:grid; gap:14px;}

    .grid-2{display:grid; gap:10px; grid-template-columns:1fr 1fr;}
    .grid-3{display:grid; gap:10px; grid-template-columns:1fr 1fr 1fr;}
    @media(max-width:880px){ .grid-2, .grid-3 { grid-template-columns:1fr; } }

    .field label{display:block; font-weight:800; margin:0 0 6px 0;}
    .input, .select, .textarea{
      width:100%; font:inherit; font-size:16px; color:var(--text);
      background:var(--card-surface,var(--surface)); border:1px solid var(--border);
      border-radius:10px; padding:12px; outline:none;
    }
    .textarea{min-height:96px; resize:vertical;}

    /* Receipt area: clean by default (no box) */
    .rc-actions{display:flex; gap:10px; flex-wrap:wrap}
    .btn{display:inline-flex; align-items:center; justify-content:center; min-width:140px; padding:12px 16px; border-radius:12px; border:1px solid var(--border); background:var(--card-surface,var(--surface)); font-weight:800; color:var(--text); cursor:pointer;}
    .btn-primary{border-color:transparent; background:#2F6C3C; color:#fff;}
    .linklike{border:0; background:none; color:var(--accent,#2F6C3C); font-weight:700; cursor:pointer; padding:0}

    /* Preview only after selection */
    #preview[hidden]{display:none !important;}
    .thumb{width:120px; height:120px; border:1px solid var(--border); border-radius:10px; overflow:hidden; display:grid; place-items:center; background:#f6f7f6;}
    .thumb img{width:100%; height:100%; object-fit:cover;}
    .help{font-size:13px; color:var(--muted,#67706B);}

    .toast{position:fixed; left:50%; bottom:calc(env(safe-area-inset-bottom,0px) + 72px); transform:translateX(-50%); background:#2F6C3C; color:#fff; padding:10px 14px; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,.25); z-index:99999; display:none;}
    .toast.show{display:block; animation:fadeout 2.8s forwards;}
    @keyframes fadeout{0%{opacity:1} 85%{opacity:1} 100%{opacity:0}}
    .page{max-width:1100px; margin:0 auto; padding:clamp(14px,3vw,22px); padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + 96px)!important;}
    .page-title{margin:0 0 8px 0;}
    .page-sub{margin:0 0 14px 0; color:var(--muted,#67706B);}
  </style>

  <script>(function(){
    if(!customElements.get('fv-shell')){
      const s=document.createElement('script'); s.src='/Farm-vista/js/fv-shell.js'; s.defer=true; document.head.appendChild(s);
    }
  })();</script>
</head><body>
  <fv-shell>
    <div class="page container">
      <h1 class="page-title">New Expenditure</h1>
      <p class="page-sub">Take a photo or import your receipt and we’ll read it automatically. You can edit any field before saving.</p>

      <section class="section">
        <header class="section-head">
          <div class="icon" aria-hidden="true">
            <!-- Tabler (MIT) receipt icon -->
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                 stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
              <path d="M5 4h14v16l-2 -1l-2 1l-2 -1l-2 1l-2 -1l-2 1z"/>
              <path d="M14 8h-4M14 12h-4"/>
            </svg>
          </div>
          <div>
            <strong>Receipt</strong>
            <div class="help">Choose one: Take Photo or Import. OCR will auto-run.</div>
          </div>
        </header>

        <div class="section-body">
          <!-- Clean: only two buttons -->
          <div class="rc-actions">
            <button id="btnTake" class="btn">Take Photo</button>
            <button id="btnImport" class="btn">Import</button>
            <button id="btnReplace" class="linklike" type="button" hidden>Replace</button>
          </div>

          <!-- Preview/status appear only after selection -->
          <div id="preview" hidden>
            <div id="thumb" class="thumb" aria-live="polite"></div>
            <div id="ocrStatus" class="help"></div>
          </div>

          <!-- hidden inputs -->
          <input id="camInput"  type="file" accept="image/*,.pdf" capture="environment" hidden>
          <input id="fileInput" type="file" accept="image/*,.pdf" hidden>

          <!-- Submitted by / dates -->
          <div class="grid-2">
            <div class="field">
              <label for="who">Submitted By</label>
              <input id="who" class="input" placeholder="Your name">
            </div>
            <div class="field">
              <label for="submitted">Submitted Date</label>
              <input id="submitted" class="input" type="date">
            </div>
          </div>

          <!-- Core receipt fields -->
          <div class="grid-3">
            <div class="field">
              <label for="merchant">Merchant</label>
              <input id="merchant" class="input" placeholder="Store / vendor">
            </div>
            <div class="field">
              <label for="rdate">Receipt Date</label>
              <input id="rdate" class="input" type="date">
            </div>
            <div class="field">
              <label for="category">Category</label>
              <select id="category" class="select">
                <option value="">—</option>
                <option>Fuel</option><option>Repairs/Parts</option><option>Supplies</option>
                <option>Meals</option><option>Lodging</option><option>Fees/Tolls</option><option>Other</option>
              </select>
            </div>
          </div>

          <!-- Single total in USD -->
          <div class="grid-2">
            <div class="field">
              <label for="total">Total (USD)</label>
              <input id="total" class="input" inputmode="decimal" placeholder="$0.00">
            </div>
            <div class="field">
              <label for="paymethod">Payment Method</label>
              <select id="paymethod" class="select">
                <option value="">—</option>
                <option value="reimb">Out-of-pocket (reimburse)</option>
                <option value="card">Company card</option>
              </select>
            </div>
          </div>

          <div class="field">
            <label for="project">Project/Field (optional)</label>
            <input id="project" class="input" placeholder="Project, field, or tag">
          </div>

          <div class="field">
            <label for="notes">Notes</label>
            <textarea id="notes" class="textarea" placeholder="Anything helpful for accounting…"></textarea>
          </div>

          <div class="rc-actions">
            <button id="btnClear" class="btn" type="button">Clear</button>
            <button id="btnSave" class="btn btn-primary" type="button">Save</button>
          </div>
        </div>
      </section>
    </div>
  </fv-shell>

  <div id="toast" class="toast" role="status" aria-live="polite">Saved.</div>

  <script>
  (function(){
    "use strict";
    const $ = id => document.getElementById(id);
    const todayISO = () => new Date(Date.now()-new Date().getTimezoneOffset()*60000).toISOString().slice(0,10);

    const who=$("who"), submitted=$("submitted"), merchant=$("merchant"),
          rdate=$("rdate"), category=$("category"), total=$("total"),
          paymethod=$("paymethod"), project=$("project"), notes=$("notes");

    submitted.value = todayISO();

    /* USD formatting */
    const usdFmt = new Intl.NumberFormat("en-US", {style:"currency", currency:"USD"});
    const parseUSD = str => {
      if(!str) return "";
      const n = Number(String(str).replace(/[^0-9.-]/g,""));
      return isFinite(n) ? n : "";
    };
    total.addEventListener("blur", e=>{
      const v = parseUSD(e.target.value);
      e.target.value = v==="" ? "" : usdFmt.format(v);
    });

    /* Receipt capture */
    const btnTake=$("btnTake"), btnImport=$("btnImport"), btnReplace=$("btnReplace");
    const camInput=$("camInput"), fileInput=$("fileInput");
    const preview=$("preview"), thumb=$("thumb"), ocrStatus=$("ocrStatus");
    let file=null;

    btnTake.addEventListener("click", ()=> camInput.click());
    btnImport.addEventListener("click", ()=> fileInput.click());
    btnReplace.addEventListener("click", ()=> fileInput.click());

    camInput.addEventListener("change", () => handleFiles(camInput.files));
    fileInput.addEventListener("change", () => handleFiles(fileInput.files));

    function handleFiles(list){
      if(!list || !list.length) return;
      file = list[0];

      // Show preview only after selection
      thumb.innerHTML = "";
      if(file.type.startsWith("image/")){
        const img = document.createElement("img");
        img.alt = file.name; img.src = URL.createObjectURL(file);
        thumb.appendChild(img);
      }
      preview.hidden = false;
      btnReplace.hidden = false;

      // Quick OCR handles images; if PDF, show a gentle note.
      if(file.type === "application/pdf"){
        ocrStatus.textContent = "PDF OCR isn’t available in quick mode. Please take a photo or import an image.";
        return;
      }

      runOCR(file);
    }

    async function runOCR(f){
      ocrStatus.textContent = "Reading receipt…";
      try{
        let text = "";
        if(window.FV_OCR && typeof window.FV_OCR.imageToText === "function"){
          const out = await window.FV_OCR.imageToText(f);
          text = (out && out.text) || "";
        }else{
          text = prompt("OCR service not wired yet.\nPaste receipt text to auto-fill:", "") || "";
        }
        if(!text.trim()){ ocrStatus.textContent = "No text detected. Fill in manually."; return; }
        ocrStatus.textContent = "Parsing…";
        autoFillFromText(text);
        ocrStatus.textContent = "Auto-filled from receipt. Review and save.";
      }catch(e){
        console.error(e);
        ocrStatus.textContent = "OCR failed. You can fill in manually.";
      }
    }

    function autoFillFromText(t){
      try{
        const lines = t.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);

        const merch = lines.find(s=>/[A-Za-z]/.test(s) && !/total/i.test(s) && s.length>2);
        if(merch && !merchant.value) merchant.value = merch.slice(0,64);

        const dateMatch = t.match(/(\b\d{4}[-/]\d{1,2}[-/]\d{1,2}\b|\b\d{1,2}[-/]\d{1,2}[-/]\d{2,4}\b)/);
        if(dateMatch && !rdate.value){
          const raw = dateMatch[1].replace(/-/g,'/');
          const p = raw.split('/');
          rdate.value = (p[0].length===4)
            ? [p[0], p[1].padStart(2,'0'), p[2].padStart(2,'0')].join('-')
            : [(p[2].length===2?('20'+p[2]):p[2]), p[0].padStart(2,'0'), p[1].padStart(2,'0')].join('-');
        }

        const totalMatch = t.match(/(?:grand\s*total|amount\s*due|total)\s*[:$]?\s*([0-9]+[.,][0-9]{2})/i)
                         || t.match(/^\s*([0-9]+[.,][0-9]{2})\s*$/m);
        if(totalMatch && !total.value){
          total.value = usdFmt.format(Number(String(totalMatch[1]).replace(',','')));
        }

        if(!category.value){
          if(/diesel|gas|fuel|pump/i.test(t)) category.value = "Fuel";
          else if(/hotel|motel|inn|lodging/i.test(t)) category.value = "Lodging";
          else if(/restaurant|cafe|food|meal/i.test(t)) category.value = "Meals";
          else if(/toll|fee/i.test(t)) category.value = "Fees/Tolls";
          else if(/parts|repair|service/i.test(t)) category.value = "Repairs/Parts";
          else if(/supply|supplies/i.test(t)) category.value = "Supplies";
        }
      }catch(e){ console.warn("parse fail", e); }
    }

    function showToast(msg="Saved."){
      const t = $("toast"); t.textContent = msg; t.classList.remove("show"); void t.offsetWidth; t.classList.add("show");
    }

    $("btnSave").addEventListener("click", async ()=>{
      if(!who.value.trim()){ alert("Please enter who submitted this."); return; }
      if(!rdate.value){ alert("Please set the receipt date."); return; }
      const totalNum = parseUSD(total.value); if(totalNum===""){ alert("Please enter the total."); return; }

      const payload = {
        who: who.value.trim(),
        submitted: submitted.value || todayISO(),
        merchant: merchant.value.trim(),
        rdate: rdate.value,
        category: category.value,
        total: totalNum,
        paymethod: paymethod.value,
        project: project.value.trim(),
        notes: notes.value.trim(),
        status: "Submitted",
        t: Date.now()
      };

      try{
        if(window.firebase?.firestore){
          const db = firebase.firestore();
          await db.collection("expenditures").add({
            ...payload,
            createdAt: (firebase.firestore.FieldValue && firebase.firestore.FieldValue.serverTimestamp) ? firebase.firestore.FieldValue.serverTimestamp() : null
          });
        }
        showToast("Saved.");
      }catch(e){
        console.error(e);
        showToast("Saved locally.");
      }
    });

    $("btnClear").addEventListener("click", ()=>{
      ["merchant","rdate","category","total","paymethod","project","notes"].forEach(id=>{
        const el=$(id); if(el.tagName==="SELECT") el.selectedIndex=0; else el.value="";
      });
      preview.hidden = true; btnReplace.hidden = true; ocrStatus.textContent = "";
      // keep 'who' and 'submitted'
    });
  })();
  </script>
</body></html>