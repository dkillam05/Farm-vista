<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FarmVista • Crop Plan — Flexible View</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#3B7E46" />

  <script src="/Farm-vista/js/theme-boot.js"></script>

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest" />
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png" />
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png" />
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css" />
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css" />

  <style>
    :root{
      --card-max: 1200px;
      --page-bottom-gap: 72px;
      --accent: #2F6C3C;
    }

    body{ background: var(--app-bg, var(--surface)); }

    .wrap{
      max-width: var(--card-max);
      margin: 0 auto;
      padding: clamp(14px,3vw,22px);
      padding-bottom: calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + var(--page-bottom-gap)) !important;
      box-sizing:border-box;
      overflow: visible;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:120px;
      padding:10px 14px;
      border-radius:12px;
      border:1px solid var(--border);
      font-weight:800;
      text-decoration:none;
      cursor:pointer;
      user-select:none;
      color:var(--text) !important;
      background:var(--card-surface,var(--surface));
      font-size:0.9rem;
      gap:6px;
      white-space:nowrap;
    }
    .btn-quiet{ min-width:auto; padding-inline:10px; }
    .btn-primary{
      border-color:transparent;
      background:#2F6C3C;
      color:#fff !important;
    }

    .hero{
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));
      overflow: visible;
      position: relative;
      z-index: 1;
    }
    .hero-head{
      display:grid;
      grid-template-columns:36px 1fr;
      gap:12px;
      align-items:center;
      padding:14px 16px;
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);
      border-bottom:1px solid var(--border);
      border-top-left-radius:14px;
      border-top-right-radius:14px;
    }
    .hero-head .icon{
      width:24px;
      height:24px;
      color:var(--accent);
      display:grid;
      place-items:center;
      font-size:18px;
    }
    .hero-head h1{
      margin:0;
      font-size:clamp(20px,3.2vw,26px);
      line-height:1.2;
    }
    .muted{ color:var(--muted,#67706B); }

    .body{
      padding:16px;
      display:grid;
      gap:14px;
      overflow: visible;
    }

    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:flex-end;
      justify-content:space-between;
    }
    .toolbar-left{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .page-header-meta{ font-size:0.9rem; opacity:0.85; }

    .filters{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:flex-end;
      margin-top:4px;
      position: relative;
      z-index: 50;
    }
    .filters-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:flex-end;
      width:100%;
    }
    .filter-field{
      display:flex;
      flex-direction:column;
      gap:3px;
      min-width:160px;
      flex:1 1 220px;
      font-size:0.8rem;
      min-width: 0;
    }
    .filter-label{
      text-transform:uppercase;
      letter-spacing:0.08em;
      opacity:0.78;
    }
    .filter-select{
      width:100%;
      height:34px;
      line-height:34px;
      border-radius:999px;
      border:1px solid var(--border);
      padding:0 10px;
      background:var(--card-surface,var(--surface));
      color:var(--text);
      font-size:0.9rem;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      box-sizing:border-box;
      position:relative;
      z-index:60;
      display:block;
    }
    .filter-select option{ white-space: nowrap; }

    .kpis{
      display:grid;
      grid-template-columns:repeat(4, minmax(0,1fr));
      gap:10px;
      margin-top:6px;
    }
    .kpi{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 12px;
      background:linear-gradient(135deg, rgba(59,126,70,0.06), var(--surface));
      box-shadow:var(--shadow-soft, var(--shadow));
    }
    .kpi .lab{
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:0.10em;
      opacity:0.78;
      font-weight:900;
    }
    .kpi .val{
      font-size:18px;
      font-weight:950;
      margin-top:2px;
    }
    .kpi .note{
      font-size:11px;
      opacity:0.78;
      margin-top:2px;
      line-height:1.25;
    }
    @media (max-width:860px){
      .kpis{ grid-template-columns:repeat(2, minmax(0,1fr)); }
    }

    .section{
      margin-top:10px;
      border-top:1px solid var(--border);
      padding-top:12px;
    }

    .empty{
      padding:14px 16px;
      border-radius:12px;
      border:1px dashed var(--border);
      background:var(--card-surface, var(--surface));
      font-size:0.95rem;
      opacity:0.9;
    }

    .card{
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--card-surface, var(--surface));
      box-shadow:var(--shadow-soft, var(--shadow));
      padding:12px 14px;
    }

    /* --------------------------
       Clarity: FARM vs CROP totals
       -------------------------- */
    .farm-head{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:10px;
      margin:10px 0 8px;
      font-size:12px;
      font-weight:950;
      letter-spacing:0.10em;
      text-transform:uppercase;

      padding:8px 10px;
      border-bottom:1px solid color-mix(in srgb, var(--border) 70%, transparent);
      background:linear-gradient(90deg, rgba(47,108,60,.07), transparent);
      border-radius:12px;
    }
    .farm-head small{
      font-size:11px;
      letter-spacing:0.06em;
      text-transform:none;
      opacity:0.78;
      font-weight:900;
      white-space:nowrap;
    }

    .crop-row-head{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:10px;
      margin:10px 0 8px;
      font-size:12px;
      font-weight:950;
      letter-spacing:0.10em;
      text-transform:uppercase;
      opacity:0.98;

      padding:6px 8px;
      border-bottom:1px dashed color-mix(in srgb, var(--border) 70%, transparent);
      border-radius:10px;
    }
    .crop-row-head small{
      font-size:11px;
      letter-spacing:0.06em;
      text-transform:none;
      opacity:0.78;
      font-weight:900;
      white-space:nowrap;
    }

    .tag{
      margin-left:8px;
      font-size:10px;
      font-weight:950;
      letter-spacing:.14em;
      text-transform:uppercase;
      color:var(--muted,#67706B);
      padding:3px 8px;
      border-radius:999px;
      border:1px solid color-mix(in srgb, var(--border) 70%, transparent);
      background:color-mix(in srgb, var(--surface) 92%, rgba(47,108,60,.08));
      display:inline-flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }
    .tag.crop{
      background:color-mix(in srgb, var(--surface) 94%, rgba(0,0,0,.02));
    }

    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:12px;
      border:1px solid color-mix(in srgb, var(--border) 80%, transparent);
      background:var(--surface);
    }
    .table th, .table td{
      text-align:left;
      padding:10px 10px;
      border-bottom:1px solid color-mix(in srgb, var(--border) 70%, transparent);
      vertical-align:top;
      font-size:0.92rem;
    }
    .table th{
      font-size:0.78rem;
      text-transform:uppercase;
      letter-spacing:0.08em;
      opacity:0.78;
      font-weight:950;
      background:color-mix(in srgb, var(--surface) 92%, #3B7E46 8%);
    }
    .table tr:last-child td{ border-bottom:0; }
    .right{ text-align:right; }
    .mono{ font-variant-numeric: tabular-nums; }

    .crop-icon{
      width:26px;
      height:26px;
      border-radius:999px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      background:rgba(59,126,70,0.10);
      border:1px solid color-mix(in srgb, var(--border) 70%, transparent);
      flex:0 0 auto;
    }
    .crop-icon svg{
      width:16px;
      height:16px;
      display:block;
      fill:currentColor;
      color:var(--accent);
    }

    .bottom-actions{ margin-top:16px; display:flex; justify-content:flex-end; }

    #fv-print-frame{
      position:fixed;
      right:0;
      bottom:0;
      width:0;
      height:0;
      border:0;
      visibility:hidden;
    }

    /* --------------------------
       FV modal: MATCH Trial Summary chooser look
       -------------------------- */
    .fv-modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.35);
      display:none;
      z-index:12000;
    }
    .fv-modal{
      position:absolute;
      left:50%;
      top:50%;
      transform:translate(-50%, -50%);
      width:min(560px, calc(100vw - 28px));
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--card-surface, var(--surface));
      box-shadow:0 18px 50px rgba(0,0,0,.28);
      padding:16px 18px 14px;
    }
    .fv-modal .row{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .fv-modal .title{
      font-weight:950;
      font-size:1.02rem;
      margin:0;
      line-height:1.2;
    }
    .fv-modal .x{
      width:34px;
      height:34px;
      display:grid;
      place-items:center;
      border-radius:999px;
      border:1px solid color-mix(in srgb, var(--border) 70%, transparent);
      background:color-mix(in srgb, var(--surface) 85%, var(--border) 15%);
      cursor:pointer;
      user-select:none;
    }
    .fv-modal .x svg{ width:16px; height:16px; opacity:.75; }
    .fv-modal .sub{
      margin:6px 0 10px;
      color:var(--muted,#67706B);
      font-weight:800;
      font-size:0.86rem;
      line-height:1.35;
    }
    .fv-modal .actions{
      display:flex;
      gap:10px;
      margin-top:10px;
    }
    .fv-choose-btn{
      flex:1 1 0;
      border-radius:12px;
      padding:11px 14px;
      font-weight:900;
      font-size:0.95rem;
      border:1px solid var(--border);
      background:var(--card-surface, var(--surface));
      color:var(--text);
      cursor:pointer;
      user-select:none;
      white-space:nowrap;
    }
    .fv-choose-btn.primary{
      border-color:transparent;
      background:#2F6C3C;
      color:#fff;
    }
    @media (max-width:520px){
      .fv-modal{ padding:14px 14px 12px; }
      .fv-modal .actions{ flex-direction:column; }
      .fv-choose-btn{ width:100%; }
    }
  </style>

  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true;
        document.head.appendChild(s);
      }
    })();
  </script>

  <script type="module">
    import {
      ready,
      getFirestore,
      collection, getDocs,
      doc, getDoc,
      query, limit
    } from '/Farm-vista/js/firebase-init.js';

    import { NAV_MENU } from '/Farm-vista/js/menu.js';

    const CONFIG = {
      PLANS_ROOT: 'field_crop_plans_v2',     // ✅ v2 only
      FIELDS_COLLECTION: 'fields',           // ✅ used to compute "unplanned"
      FARMS_COLLECTION: 'farms',
      COMPANY_DOC_PATH: ['company','main']
    };

    const $ = (sel, root=document) => root.querySelector(sel);

    const fmt0 = new Intl.NumberFormat('en-US', { maximumFractionDigits: 0 });
    const fmt2 = new Intl.NumberFormat('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

    const STATE = {
      db: null,
      company: null,
      farmsById: new Map(),
      years: [],
      fields: [],            // ✅ active fields cache
      rows: [],
      filtered: []
    };

    function escapeHtml(str){
      return String(str || '').replace(/[&<>"']/g, m => (
        { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]
      ));
    }

    function toDateMaybe(ts){
      if(!ts) return null;
      try{
        if(ts.toDate) return ts.toDate();
        if(ts && typeof ts === 'object' && ts.__time__){
          const d = new Date(ts.__time__);
          return Number.isFinite(d.getTime()) ? d : null;
        }
        if(ts && typeof ts === 'object' && typeof ts.seconds === 'number'){
          const d = new Date(ts.seconds * 1000);
          return Number.isFinite(d.getTime()) ? d : null;
        }
        if(typeof ts === 'string' || typeof ts === 'number'){
          const d = new Date(ts);
          return Number.isFinite(d.getTime()) ? d : null;
        }
      }catch(_){}
      return null;
    }

    function formatDate(d){
      if(!d) return '';
      try{ return d.toLocaleDateString(undefined,{month:'short',day:'numeric',year:'numeric'}); }
      catch{ return ''; }
    }
    function formatDateTime(d){
      if(!d) return '';
      try{ return d.toLocaleString(); }
      catch{ return ''; }
    }

    function safeNum(x){
      const n = Number(x);
      return Number.isFinite(n) ? n : 0;
    }

    function normCrop(c){
      let s = String(c ?? '').trim().toLowerCase();
      s = s.replace(/[_]+/g, ' ');
      s = s.replace(/\s+/g, ' ').trim();

      const NONE = new Set([
        '', 'none', 'no', 'na', 'n/a', 'null', 'nil',
        '-', '—', '--', '?',
        'tbd', 'unknown', 'unplanned', 'not set', 'unset'
      ]);
      if(NONE.has(s)) return '';

      if(s === 'corn' || s.startsWith('corn ') || s === 'maize') return 'corn';
      if(s === 'soy' || s === 'soybean' || s === 'soybeans' || s === 'soy bean' || s === 'beans' || s.startsWith('soy ')) return 'soybeans';

      return '';
    }

    function cropKeyForRow(r){
      const n = normCrop(r?.crop);
      if(n === 'corn') return 'corn';
      if(n === 'soybeans') return 'soybeans';
      return 'unplanned';
    }

    function cropLabelFromKey(k){
      const kk = String(k||'').toLowerCase();
      if(kk === 'corn') return 'Corn';
      if(kk === 'soybeans') return 'Soybeans';
      return 'Unplanned';
    }

    function farmNameForId(farmId){
      const id = String(farmId||'').trim();
      const f = id ? (STATE.farmsById.get(id) || null) : null;
      return (f?.name || id || 'Unknown farm');
    }

    function svgCorn(){
      return `
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M12 2c2.8 1.5 5 4.8 5 8.7 0 4.6-3 8.4-5 10.8-2-2.4-5-6.2-5-10.8C7 6.8 9.2 3.5 12 2z"/>
          <path d="M6.5 9.5c-2.6 1.4-3.8 4.2-3.5 7.2 2.8-.2 5.2-1.3 6.9-3.2-1.4-1.2-2.4-2.5-3.4-4z" opacity=".65"/>
          <path d="M17.5 9.5c2.6 1.4 3.8 4.2 3.5 7.2-2.8-.2-5.2-1.3-6.9-3.2 1.4-1.2 2.4-2.5 3.4-4z" opacity=".65"/>
        </svg>
      `;
    }
    function svgSoy(){
      return `
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M9.2 3.8c3 0 5.4 2.9 5.4 6.5S12.2 18.6 9.2 18.6 3.8 15.7 3.8 12.1 6.2 3.8 9.2 3.8z"/>
          <path d="M15.8 5.4c2.5.6 4 3.5 3.4 6.6-.6 3.1-3.1 5-5.6 4.4-2.5-.6-4-3.5-3.4-6.6.6-3.1 3.1-5 5.6-4.4z" opacity=".75"/>
        </svg>
      `;
    }
    function svgUnplanned(){
      return `
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M12 2 1.8 20.2c-.4.7.1 1.6.9 1.6h18.6c.8 0 1.3-.9.9-1.6L12 2z"/>
          <path d="M12 8.2c.6 0 1 .4 1 1v5.7c0 .6-.4 1-1 1s-1-.4-1-1V9.2c0-.6.4-1 1-1z" fill="#fff" opacity=".95"/>
          <path d="M12 17.7a1.2 1.2 0 1 1 0 2.4 1.2 1.2 0 0 1 0-2.4z" fill="#fff" opacity=".95"/>
        </svg>
      `;
    }
    function cropIconForKey(k){
      const kk = String(k||'').toLowerCase();
      if(kk === 'corn') return svgCorn();
      if(kk === 'soybeans') return svgSoy();
      return svgUnplanned();
    }

    async function loadCompanyHeader(){
      if (STATE.company) return STATE.company;
      try{
        const [col,id] = CONFIG.COMPANY_DOC_PATH;
        const ref = doc(STATE.db, col, id);
        const snap = await getDoc(ref);
        const d = snap.exists() ? (snap.data() || {}) : {};
        const name = d.name || '';
        const address = [
          d.addressStreet || '',
          [d.addressCity, d.addressState].filter(Boolean).join(', '),
          d.addressZip || ''
        ].filter(Boolean).join(' · ');
        const phone = d.phone || '';
        const email = d.email || '';
        const logoUrl = d?.logo?.url || d?.logoUrl || '';
        STATE.company = { name, address, phone, email: (email || ''), logoUrl };
      }catch(e){
        console.warn('[crop-plan-report] company header load failed', e);
        STATE.company = { name:'', address:'', phone:'', email:'', logoUrl:'' };
      }
      return STATE.company;
    }

    async function loadFarms(){
      STATE.farmsById.clear();
      try{
        const snap = await getDocs(collection(STATE.db, CONFIG.FARMS_COLLECTION));
        snap.docs.forEach(ds=>{
          const d = ds.data() || {};
          const name = (d.name || d.farmName || d.title || ds.id || '').toString().trim();
          STATE.farmsById.set(ds.id, { id: ds.id, name });
        });
      }catch(e){
        console.warn('[crop-plan-report] farms load failed (farmId fallback)', e);
      }
    }

    async function loadFields(){
      STATE.fields = [];
      try{
        const snap = await getDocs(collection(STATE.db, CONFIG.FIELDS_COLLECTION));
        const rows = snap.docs.map(ds=>{
          const d = ds.data() || {};
          const status = String(d.status || '').trim().toLowerCase();
          return {
            id: ds.id,
            status,
            farmId: d.farmId || '',
            name: (d.name || d.fieldName || d.title || ds.id || '').toString().trim(),
            tillable: safeNum(d.tillable),
            acres: safeNum(d.acres)
          };
        });
        STATE.fields = rows.filter(f => !f.status || f.status === 'active');
      }catch(e){
        console.error('[crop-plan-report] loadFields failed:', e);
        STATE.fields = [];
      }
    }

    async function loadAvailableYears(){
      STATE.years = [];
      try{
        const snap = await getDocs(collection(STATE.db, CONFIG.PLANS_ROOT));
        const yrs = snap.docs
          .map(d => String(d.id || '').trim())
          .map(s => Number(s))
          .filter(n => Number.isFinite(n));
        yrs.sort((a,b)=>b-a);
        STATE.years = yrs;
      }catch(_){}

      if(!STATE.years.length){
        const nowY = new Date().getFullYear();
        const candidates = [];
        for(let y = nowY - 2; y <= nowY + 6; y++) candidates.push(y);

        const found = [];
        for(const y of candidates){
          try{
            const ref = collection(STATE.db, CONFIG.PLANS_ROOT, String(y), 'fields');
            const s = await getDocs(query(ref, limit(1)));
            if(!s.empty) found.push(y);
          }catch(_e){}
        }
        found.sort((a,b)=>b-a);
        STATE.years = found;
      }

      if(!STATE.years.length){
        STATE.years = [new Date().getFullYear() + 1];
      }
    }

    function setSelectOptions(selectEl, optionsHtml, currentValue){
      if(!selectEl) return;
      selectEl.innerHTML = optionsHtml;
      if(currentValue != null){
        const exists = Array.from(selectEl.options).some(o => o.value === currentValue);
        selectEl.value = exists ? currentValue : (selectEl.options[0]?.value || '');
      }
    }

    function hydrateYearDropdown(){
      const yearSel = $('#filterYear');
      const years = STATE.years || [];
      const cur = yearSel?.value || '';
      const opts = years.map(y => `<option value="${y}">${y}</option>`).join('');
      setSelectOptions(yearSel, opts || `<option value="">No crop years found</option>`, cur);
    }

    async function loadPlansForYear(yearStr){
      STATE.rows = [];
      const y = String(yearStr || '').trim();
      if(!y) return;

      const planByField = new Map();

      try{
        const snap = await getDocs(collection(STATE.db, CONFIG.PLANS_ROOT, y, 'fields'));
        snap.docs.forEach(ds=>{
          const d = ds.data() || {};
          planByField.set(ds.id, {
            crop: d.crop,
            updatedAt: toDateMaybe(d.updatedAt),
            updatedBy: d.updatedBy || '',
            farmId: d.farmId || '',
            fieldName: d.fieldName || '',
            acres: safeNum(d.acres)
          });
        });
      }catch(e){
        console.error('[crop-plan-report] loadPlansForYear plan read failed:', e);
      }

      const rows = (STATE.fields || []).map(f=>{
        const p = planByField.get(f.id) || null;

        const farmId = (p?.farmId || f.farmId || '');
        const fieldName = (p?.fieldName || f.name || f.id);
        const acres = (p && Number.isFinite(p.acres) && p.acres > 0)
          ? p.acres
          : (f.tillable || f.acres || 0);

        return {
          id: f.id,
          year: y,
          farmId,
          fieldName,
          acres: safeNum(acres),
          crop: p?.crop ?? '',
          status: 'active',
          updatedAt: p?.updatedAt || null,
          updatedBy: p?.updatedBy || ''
        };
      });

      STATE.rows = rows;
      STATE.rows.sort((a,b)=>{
        const fa = farmNameForId(a.farmId).localeCompare(farmNameForId(b.farmId));
        if(fa) return fa;
        return (a.fieldName||'').localeCompare(b.fieldName||'');
      });
    }

    function computeFarmsFromRows(rows){
      const set = new Set();
      (rows||[]).forEach(r=>{
        if(r.farmId) set.add(String(r.farmId));
      });
      return Array.from(set).sort((a,b)=>farmNameForId(a).localeCompare(farmNameForId(b)));
    }

    function hydrateFarmDropdown(){
      const farmSel = $('#filterFarm');
      const cur = farmSel?.value || 'all';
      const farms = computeFarmsFromRows(STATE.rows);
      const opts = [
        `<option value="all">All farms</option>`,
        ...farms.map(id => `<option value="${escapeHtml(id)}">${escapeHtml(farmNameForId(id))}</option>`)
      ].join('');
      setSelectOptions(farmSel, opts, cur);
    }

    function getFilters(){
      return {
        year: ($('#filterYear')?.value || ''),
        farm: ($('#filterFarm')?.value || 'all'),
        crop: ($('#filterCrop')?.value || 'all'),
        view: ($('#filterView')?.value || 'cropFirst')
      };
    }

    function calcKpis(rows){
      const totalFields = rows.length;
      const totalAcres = rows.reduce((s,r)=>s + safeNum(r.acres), 0);
      const cornAcres = rows.filter(r=>cropKeyForRow(r)==='corn').reduce((s,r)=>s + safeNum(r.acres), 0);
      const soyAcres  = rows.filter(r=>cropKeyForRow(r)==='soybeans').reduce((s,r)=>s + safeNum(r.acres), 0);
      const farmCount = new Set(rows.map(r=>String(r.farmId||'')).filter(Boolean)).size;

      let last = null;
      rows.forEach(r=>{
        const d = r.updatedAt;
        if(d && (!last || d.getTime() > last.getTime())) last = d;
      });

      return { totalFields, totalAcres, cornAcres, soyAcres, farmCount, lastUpdated:last };
    }

    function groupCropThenFarm(rows){
      const cropMap = new Map(); // cropKey -> farmName -> rows
      rows.forEach(r=>{
        const c = cropKeyForRow(r);
        if(!cropMap.has(c)) cropMap.set(c, new Map());
        const farmName = farmNameForId(r.farmId);
        const fm = cropMap.get(c);
        if(!fm.has(farmName)) fm.set(farmName, []);
        fm.get(farmName).push(r);
      });

      const cropOrder = (k)=> k==='corn'?0 : k==='soybeans'?1 : k==='unplanned'?2 : 3;
      const cropKeys = Array.from(cropMap.keys()).sort((a,b)=> cropOrder(a)-cropOrder(b) || a.localeCompare(b));

      return cropKeys.map(c=>{
        const fm = cropMap.get(c);
        const farms = Array.from(fm.entries()).sort((a,b)=>a[0].localeCompare(b[0]));
        farms.forEach(([_, arr])=>{
          arr.sort((a,b)=>(a.fieldName||'').localeCompare(b.fieldName||''));
        });
        return [c, farms];
      });
    }

    function groupFarmThenCrop(rows){
      const farmMap = new Map(); // farmName -> cropKey -> rows
      rows.forEach(r=>{
        const farmName = farmNameForId(r.farmId);
        if(!farmMap.has(farmName)) farmMap.set(farmName, new Map());
        const cm = farmMap.get(farmName);
        const c = cropKeyForRow(r);
        if(!cm.has(c)) cm.set(c, []);
        cm.get(c).push(r);
      });

      const farms = Array.from(farmMap.entries()).sort((a,b)=>a[0].localeCompare(b[0]));
      const cropOrder = (k)=> k==='corn'?0 : k==='soybeans'?1 : k==='unplanned'?2 : 3;

      return farms.map(([farmName, cm])=>{
        const crops = Array.from(cm.entries()).sort((a,b)=> cropOrder(a[0]) - cropOrder(b[0]) || a[0].localeCompare(b[0]));
        crops.forEach(([_, arr])=>{
          arr.sort((a,b)=>(a.fieldName||'').localeCompare(b.fieldName||''));
        });
        return [farmName, crops];
      });
    }

    function buildTableOnScreen(rows){
      const acres = rows.reduce((s,r)=>s + safeNum(r.acres), 0);
      return `
        <div class="card">
          <table class="table" role="table">
            <thead>
              <tr><th>Field</th><th class="right">Acres</th></tr>
            </thead>
            <tbody>
              ${rows.map(r=>`
                <tr>
                  <td>${escapeHtml(r.fieldName || '—')}</td>
                  <td class="right mono">${fmt2.format(safeNum(r.acres))}</td>
                </tr>
              `).join('')}
            </tbody>
            <tfoot>
              <tr>
                <td style="font-weight:950;">Total</td>
                <td class="right mono" style="font-weight:950;">${fmt2.format(acres)}</td>
              </tr>
            </tfoot>
          </table>
        </div>
      `;
    }

    function applyFilters(){
      const { farm, crop } = getFilters();
      const f = String(farm || 'all');
      const c = String(crop || 'all').toLowerCase();

      let out = (STATE.rows || []);
      if(f !== 'all') out = out.filter(r => String(r.farmId||'') === f);
      if(c !== 'all') out = out.filter(r => cropKeyForRow(r) === c);

      STATE.filtered = out;
      render();
    }

    function render(){
      const rows = STATE.filtered || [];
      const k = calcKpis(rows);
      const { view } = getFilters();

      const metaEl = $('#cpCount');
      if(metaEl){
        const parts = [];
        parts.push(`${fmt0.format(k.totalFields)} field${k.totalFields===1?'':'s'}`);
        parts.push(`${fmt0.format(k.farmCount)} farm${k.farmCount===1?'':'s'}`);
        if(k.lastUpdated) parts.push(`Last update: ${formatDateTime(k.lastUpdated)}`);
        metaEl.textContent = parts.join(' • ');
      }

      $('#kpiFields').textContent = fmt0.format(k.totalFields);
      $('#kpiAcres').textContent  = fmt2.format(k.totalAcres);
      $('#kpiCorn').textContent   = fmt2.format(k.cornAcres);
      $('#kpiSoy').textContent    = fmt2.format(k.soyAcres);

      const body = $('#reportBody');
      body.innerHTML = '';

      if(!rows.length){
        body.innerHTML = `<div class="empty">No crop plan fields match the current filters.</div>`;
        return;
      }

      if(view === 'farmFirst'){
        const farms = groupFarmThenCrop(rows);
        farms.forEach(([farmName, crops])=>{
          const flat = crops.flatMap(([,arr])=>arr);
          const farmAc = flat.reduce((s,r)=>s + safeNum(r.acres), 0);

          const sec = document.createElement('section');
          sec.className = 'section';
          sec.innerHTML = `
            <div class="farm-head" style="margin-top:0;">
              <div>
                ${escapeHtml(farmName)}
                <span class="tag">Farm total</span>
              </div>
              <small>${fmt0.format(flat.length)} fields • ${fmt2.format(farmAc)} ac</small>
            </div>
          `;
          body.appendChild(sec);

          crops.forEach(([cropKey, arr])=>{
            const ac = arr.reduce((s,r)=>s + safeNum(r.acres), 0);
            const head = document.createElement('div');
            head.className = 'crop-row-head';
            head.innerHTML = `
              <div style="display:flex;align-items:center;gap:10px;">
                <span class="crop-icon">${cropIconForKey(cropKey)}</span>
                <span>${escapeHtml(cropLabelFromKey(cropKey))}</span>
                <span class="tag crop">Crop total</span>
              </div>
              <small>${fmt0.format(arr.length)} fields • ${fmt2.format(ac)} ac</small>
            `;
            body.appendChild(head);

            const wrap = document.createElement('div');
            wrap.innerHTML = buildTableOnScreen(arr);
            body.appendChild(wrap);
          });
        });
      } else {
        const grouped = groupCropThenFarm(rows);
        grouped.forEach(([cropKey, farms])=>{
          const flat = farms.flatMap(([,arr])=>arr);
          const cropAc = flat.reduce((s,r)=>s + safeNum(r.acres), 0);

          const sec = document.createElement('section');
          sec.className = 'section';
          sec.innerHTML = `
            <div class="farm-head" style="margin-top:0;">
              <div style="display:flex;align-items:center;gap:10px;">
                <span class="crop-icon">${cropIconForKey(cropKey)}</span>
                <span>${escapeHtml(cropLabelFromKey(cropKey))}</span>
                <span class="tag crop">Crop total</span>
              </div>
              <small>${fmt0.format(flat.length)} fields • ${fmt2.format(cropAc)} ac</small>
            </div>
          `;
          body.appendChild(sec);

          farms.forEach(([farmName, arr])=>{
            const farmAc = arr.reduce((s,r)=>s + safeNum(r.acres), 0);
            const head = document.createElement('div');
            head.className = 'crop-row-head';
            head.innerHTML = `
              <div>
                ${escapeHtml(farmName)}
                <span class="tag">Farm total</span>
              </div>
              <small>${fmt0.format(arr.length)} fields • ${fmt2.format(farmAc)} ac</small>
            `;
            body.appendChild(head);

            const wrap = document.createElement('div');
            wrap.innerHTML = buildTableOnScreen(arr);
            body.appendChild(wrap);
          });
        });
      }
    }

    function summarizeFilters(){
      const { year, farm, crop, view } = getFilters();
      const yTxt = year ? `Crop Year: ${year}` : 'Crop Year: —';
      const fTxt = (farm === 'all') ? 'All farms' : `Farm: ${farmNameForId(farm)}`;
      const cTxt = (crop === 'all') ? 'All crops' : `Crop: ${cropLabelFromKey(crop)}`;
      const vTxt = (view === 'farmFirst') ? 'View: Farm → Crop' : 'View: Crop → Farm';
      return `${yTxt} • ${fTxt} • ${cTxt} • ${vTxt}`;
    }

    function groupForPrint(rows){
      const { view } = getFilters();
      if(view === 'farmFirst') return { mode:'farmFirst', data: groupFarmThenCrop(rows) };
      return { mode:'cropFirst', data: groupCropThenFarm(rows) };
    }

    function printTableHtml(rows){
      const total = rows.reduce((s,r)=>s + safeNum(r.acres), 0);
      return `
        <table class="t">
          <thead>
            <tr><th>Field</th><th class="r">Acres</th></tr>
          </thead>
          <tbody>
            ${rows.map(r=>`
              <tr>
                <td>${escapeHtml(r.fieldName || '—')}</td>
                <td class="r mono">${fmt2.format(safeNum(r.acres))}</td>
              </tr>
            `).join('')}
            <tr class="tot">
              <td>Total</td>
              <td class="r mono">${fmt2.format(total)}</td>
            </tr>
          </tbody>
        </table>
      `;
    }

    function buildPrintHtml({ company, runStr, runDateOnly, filterSummary, kpis, grouped }){
      const esc = escapeHtml;

      const blocks = (grouped.mode === 'farmFirst')
        ? grouped.data.map(([farmName, crops])=>{
            const flat = crops.flatMap(([,arr])=>arr);
            const farmAc = flat.reduce((s,r)=>s + safeNum(r.acres), 0);
            return `
              <section class="sec">
                <div class="h2">
                  <div>${esc(farmName)}</div>
                  <div class="sm">${flat.length} fields • ${esc(fmt2.format(farmAc))} ac</div>
                </div>
                ${crops.map(([cropKey, arr])=>{
                  const ac = arr.reduce((s,r)=>s + safeNum(r.acres), 0);
                  return `
                    <div class="h3">
                      <div>${esc(cropLabelFromKey(cropKey))}</div>
                      <div class="sm">${arr.length} fields • ${esc(fmt2.format(ac))} ac</div>
                    </div>
                    ${printTableHtml(arr)}
                  `;
                }).join('')}
              </section>
            `;
          }).join('')
        : grouped.data.map(([cropKey, farms])=>{
            const flat = farms.flatMap(([,arr])=>arr);
            const cropAc = flat.reduce((s,r)=>s + safeNum(r.acres), 0);
            return `
              <section class="sec">
                <div class="h2">
                  <div>${esc(cropLabelFromKey(cropKey))}</div>
                  <div class="sm">${flat.length} fields • ${esc(fmt2.format(cropAc))} ac</div>
                </div>
                ${farms.map(([farmName, arr])=>{
                  const farmAc = arr.reduce((s,r)=>s + safeNum(r.acres), 0);
                  return `
                    <div class="h3">
                      <div>${esc(farmName)}</div>
                      <div class="sm">${arr.length} fields • ${esc(fmt2.format(farmAc))} ac</div>
                    </div>
                    ${printTableHtml(arr)}
                  `;
                }).join('')}
              </section>
            `;
          }).join('');

      return `<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Crop Plan — Detailed</title>
  <style>
    :root{
      --g:#3B7E46; --b:#D1D5DB; --t:#111827; --m:#6B7280; --bg:#F3F4F6;
    }
    *{box-sizing:border-box;}
    html,body{margin:0;padding:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;color:var(--t);background:var(--bg);}
    body{display:flex;justify-content:center;padding:22px 12px;}
    .page{width:100%;max-width:920px;background:#fff;border-radius:14px;box-shadow:0 10px 30px rgba(15,23,42,0.12);padding:20px 22px 22px;}
    .hdr{display:grid;grid-template-columns:auto 1fr auto;gap:14px;align-items:center;border-bottom:2px solid var(--g);padding-bottom:12px;margin-bottom:14px;}
    .logo{width:60px;height:60px;border-radius:16px;border:1px solid var(--b);overflow:hidden;background:#fff;display:flex;align-items:center;justify-content:center;}
    .logo img{width:100%;height:100%;object-fit:cover;display:block;}
    .logo-fallback{width:60px;height:60px;border-radius:16px;border:1px solid var(--b);display:flex;align-items:center;justify-content:center;font-size:24px;font-weight:900;color:#fff;background:radial-gradient(circle at 30% 0%, #4CAF50, var(--g));}
    .co-name{font-size:16px;font-weight:900;margin:0 0 2px;}
    .co-line{font-size:11px;color:var(--m);margin:0;line-height:1.35;}
    .meta{text-align:right;font-size:11px;color:var(--m);line-height:1.35;white-space:nowrap;}
    .meta strong{color:var(--t);}
    .title{margin:0;font-size:18px;font-weight:950;letter-spacing:0.06em;text-transform:uppercase;}
    .subtitle{margin:4px 0 0;font-size:12px;color:var(--m);line-height:1.35;}
    .summary{margin-top:10px;padding:8px 10px;border-radius:12px;background:linear-gradient(90deg, rgba(59,126,70,0.10), transparent);border:1px solid rgba(59,126,70,0.22);display:flex;flex-wrap:wrap;gap:6px 14px;font-size:11px;}
    .pill{display:inline-flex;gap:6px;align-items:baseline;white-space:nowrap;}
    .k{font-size:10px;text-transform:uppercase;letter-spacing:0.10em;color:var(--m);font-weight:700;}
    .v{font-weight:800;color:var(--t);}
    .kpis{margin-top:12px;display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;}
    .kpi{border:1px solid var(--b);border-radius:12px;padding:9px 10px;background:linear-gradient(135deg, rgba(59,126,70,0.06), #fff);}
    .kpi .lab{font-size:10px;text-transform:uppercase;letter-spacing:0.10em;color:var(--m);font-weight:900;}
    .kpi .val{font-size:18px;font-weight:950;margin-top:2px;}
    .kpi .note{font-size:10px;color:var(--m);margin-top:2px;line-height:1.25;}
    .sec{margin-top:16px;border-top:1px solid #EEF2F7;padding-top:14px;}
    .h2{display:flex;justify-content:space-between;align-items:baseline;gap:10px;font-size:12px;font-weight:950;letter-spacing:0.10em;text-transform:uppercase;margin:0 0 8px;}
    .h3{margin:10px 0 6px;display:flex;justify-content:space-between;align-items:baseline;gap:10px;font-size:11px;font-weight:950;letter-spacing:0.10em;text-transform:uppercase;}
    .sm{font-size:11px;color:var(--m);letter-spacing:0.06em;text-transform:none;font-weight:900;white-space:nowrap;}
    .t{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--b);border-radius:12px;overflow:hidden;}
    .t th,.t td{padding:9px 10px;border-bottom:1px solid #EEF2F7;font-size:11px;}
    .t th{text-transform:uppercase;letter-spacing:0.10em;font-weight:950;color:var(--m);background:rgba(59,126,70,0.06);}
    .t tr:last-child td{border-bottom:0;}
    .r{text-align:right;}
    .mono{font-variant-numeric:tabular-nums;}
    .tot td{font-weight:950;}
    .footer{margin-top:16px;padding-top:10px;border-top:1px solid var(--b);display:flex;justify-content:space-between;gap:12px;font-size:10px;color:var(--m);line-height:1.3;}
    @media (max-width:860px){.kpis{grid-template-columns:repeat(2,minmax(0,1fr));}.meta{white-space:normal;}}
    @media print{html,body{background:#fff;padding:0;} body{box-shadow:none;} .page{max-width:none;border-radius:0;box-shadow:none;padding:9mm 10mm;} thead{display:table-header-group;}}
  </style>
</head>
<body>
  <div class="page">
    <header class="hdr">
      ${
        (company.logoUrl)
          ? `<div class="logo"><img src="${esc(company.logoUrl)}" alt="Company logo"></div>`
          : `<div class="logo-fallback"><span>DF</span></div>`
      }
      <div>
        <p class="co-name">${esc(company.name || '')}</p>
        <p class="co-line">
          ${company.address ? esc(company.address) + '<br>' : ''}
          ${company.phone ? 'Phone: ' + esc(company.phone) : ''}${company.phone && company.email ? ' · ' : ''}
          ${company.email ? 'Email: ' + esc(company.email) : ''}
        </p>
      </div>
      <div class="meta">
        <div><strong>Crop Planning</strong></div>
        <div>Generated: ${esc(runStr)}</div>
        <div>Prepared by: ${esc(company.name || 'FarmVista')}</div>
      </div>
    </header>

    <h1 class="title">Crop Plan — Detailed</h1>
    <p class="subtitle">Totals print only once per table (end of crop/farm), even across page breaks.</p>

    <div class="summary">
      <div class="pill"><span class="k">Filters</span><span class="v">${esc(filterSummary)}</span></div>
      <div class="pill"><span class="k">Fields</span><span class="v">${kpis.totalFields}</span></div>
      <div class="pill"><span class="k">Total acres</span><span class="v">${esc(fmt2.format(kpis.totalAcres))}</span></div>
    </div>

    <div class="kpis">
      <div class="kpi"><div class="lab">Fields</div><div class="val">${kpis.totalFields}</div><div class="note">Matching filters</div></div>
      <div class="kpi"><div class="lab">Total Acres</div><div class="val">${esc(fmt2.format(kpis.totalAcres))}</div><div class="note">All crops</div></div>
      <div class="kpi"><div class="lab">Corn Acres</div><div class="val">${esc(fmt2.format(kpis.cornAcres))}</div><div class="note">Recognized corn</div></div>
      <div class="kpi"><div class="lab">Soy Acres</div><div class="val">${esc(fmt2.format(kpis.soyAcres))}</div><div class="note">Recognized soybeans</div></div>
    </div>

    ${blocks}

    <footer class="footer">
      <div></div>
      <div>FarmVista • Crop Planning • ${esc(runDateOnly || '')}</div>
    </footer>
  </div>
</body>
</html>`;
    }

    function buildPrintHtmlSummary({ company, runStr, runDateOnly, filterSummary, kpis, rows }){
      const byFarm = new Map();

      rows.forEach(r=>{
        const farmName = farmNameForId(r.farmId);
        if(!byFarm.has(farmName)){
          byFarm.set(farmName, { name:farmName, acres:0, fields:0, corn:0, soy:0, unp:0 });
        }
        const o = byFarm.get(farmName);
        const ac = safeNum(r.acres);
        o.acres += ac;
        o.fields += 1;

        const ck = cropKeyForRow(r);
        if(ck === 'corn') o.corn += ac;
        else if(ck === 'soybeans') o.soy += ac;
        else o.unp += ac;
      });

      const farms = Array.from(byFarm.values()).sort((a,b)=>a.name.localeCompare(b.name));
      const esc = escapeHtml;

      return `<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Crop Plan — Summary</title>
  <style>
    :root{--g:#3B7E46;--b:#D1D5DB;--t:#111827;--m:#6B7280;--bg:#F3F4F6;}
    *{box-sizing:border-box;}
    html,body{margin:0;padding:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;color:var(--t);background:var(--bg);}
    body{display:flex;justify-content:center;padding:22px 12px;}
    .page{width:100%;max-width:920px;background:#fff;border-radius:14px;box-shadow:0 10px 30px rgba(15,23,42,0.12);padding:20px 22px 22px;}
    .hdr{display:flex;justify-content:space-between;gap:12px;align-items:flex-end;border-bottom:2px solid var(--g);padding-bottom:12px;margin-bottom:14px;}
    .title{margin:0;font-size:18px;font-weight:950;letter-spacing:0.06em;text-transform:uppercase;}
    .sub{margin:4px 0 0;font-size:12px;color:var(--m);line-height:1.35;}
    .meta{text-align:right;font-size:11px;color:var(--m);line-height:1.35;white-space:nowrap;}
    .summary{margin-top:10px;padding:8px 10px;border-radius:12px;background:linear-gradient(90deg, rgba(59,126,70,0.10), transparent);border:1px solid rgba(59,126,70,0.22);font-size:11px;}
    .kpis{margin-top:12px;display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px;}
    .kpi{border:1px solid var(--b);border-radius:12px;padding:9px 10px;background:linear-gradient(135deg, rgba(59,126,70,0.06), #fff);}
    .kpi .lab{font-size:10px;text-transform:uppercase;letter-spacing:0.10em;color:var(--m);font-weight:900;}
    .kpi .val{font-size:18px;font-weight:950;margin-top:2px;}
    table{width:100%;border-collapse:separate;border-spacing:0;border:1px solid var(--b);border-radius:12px;overflow:hidden;margin-top:14px;}
    th,td{padding:9px 10px;border-bottom:1px solid #EEF2F7;font-size:11px;}
    th{text-transform:uppercase;letter-spacing:0.10em;font-weight:950;color:var(--m);background:rgba(59,126,70,0.06);}
    tr:last-child td{border-bottom:0;}
    .r{text-align:right;}
    .mono{font-variant-numeric:tabular-nums;}
    .footer{margin-top:12px;color:var(--m);font-size:10px;display:flex;justify-content:space-between;gap:12px;}
    @media (max-width:860px){.kpis{grid-template-columns:repeat(2,minmax(0,1fr));}.meta{white-space:normal;}}
    @media print{html,body{background:#fff;padding:0;} body{box-shadow:none;} .page{max-width:none;border-radius:0;box-shadow:none;padding:9mm 10mm;} thead{display:table-header-group;}}
  </style>
</head>
<body>
  <div class="page">
    <div class="hdr">
      <div>
        <h1 class="title">Crop Plan — Summary</h1>
        <div class="sub">${esc(filterSummary)}</div>
      </div>
      <div class="meta">
        <div><strong>${esc(company.name || 'FarmVista')}</strong></div>
        <div>Generated: ${esc(runStr)}</div>
      </div>
    </div>

    <div class="summary"><strong>Totals</strong> • Fields: ${kpis.totalFields} • Total Acres: ${esc(fmt2.format(kpis.totalAcres))}</div>

    <div class="kpis">
      <div class="kpi"><div class="lab">Fields</div><div class="val">${kpis.totalFields}</div></div>
      <div class="kpi"><div class="lab">Total Acres</div><div class="val">${esc(fmt2.format(kpis.totalAcres))}</div></div>
      <div class="kpi"><div class="lab">Corn Acres</div><div class="val">${esc(fmt2.format(kpis.cornAcres))}</div></div>
      <div class="kpi"><div class="lab">Soy Acres</div><div class="val">${esc(fmt2.format(kpis.soyAcres))}</div></div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Farm</th>
          <th class="r">Fields</th>
          <th class="r">Total Acres</th>
          <th class="r">Corn</th>
          <th class="r">Soybeans</th>
          <th class="r">Unplanned</th>
        </tr>
      </thead>
      <tbody>
        ${farms.map(f=>`
          <tr>
            <td>${esc(f.name)}</td>
            <td class="r mono">${fmt0.format(f.fields)}</td>
            <td class="r mono">${esc(fmt2.format(f.acres))}</td>
            <td class="r mono">${esc(fmt2.format(f.corn))}</td>
            <td class="r mono">${esc(fmt2.format(f.soy))}</td>
            <td class="r mono">${esc(fmt2.format(f.unp))}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>

    <div class="footer">
      <div></div>
      <div>FarmVista • ${esc(runDateOnly || '')}</div>
    </div>
  </div>
</body>
</html>`;
    }

    function openPrintChoice(){
      const m = document.getElementById('fvPrintChoice');
      if(!m) return;
      m.style.display = 'block';
      m.setAttribute('aria-hidden','false');
    }
    function closePrintChoice(){
      const m = document.getElementById('fvPrintChoice');
      if(!m) return;
      m.style.display = 'none';
      m.setAttribute('aria-hidden','true');
    }

    async function printHtmlViaIframe(html){
      let iframe = document.getElementById('fv-print-frame');
      if (!iframe){
        iframe = document.createElement('iframe');
        iframe.id = 'fv-print-frame';
        document.body.appendChild(iframe);
      }

      const win = iframe.contentWindow || iframe.contentDocument;
      const docu = iframe.contentDocument || iframe.contentWindow.document;

      docu.open();
      docu.write(html);
      docu.close();

      setTimeout(() => {
        try{ win.focus(); win.print(); }
        catch(err){
          console.warn('[crop-plan-report] iframe print failed, falling back to window.print()', err);
          window.print();
        }
      }, 450);
    }

    async function runPrintDetailed(){
      const rows = STATE.filtered || [];
      const company = await loadCompanyHeader();
      const now = new Date();
      const runStr = formatDateTime(now);
      const runDateOnly = formatDate(now);

      const filterSummary = summarizeFilters();
      const kpis = calcKpis(rows);
      const grouped = groupForPrint(rows);

      const html = buildPrintHtml({ company, runStr, runDateOnly, filterSummary, kpis, grouped });
      await printHtmlViaIframe(html);
    }

    async function runPrintSummary(){
      const rows = STATE.filtered || [];
      const company = await loadCompanyHeader();
      const now = new Date();
      const runStr = formatDateTime(now);
      const runDateOnly = formatDate(now);

      const filterSummary = summarizeFilters();
      const kpis = calcKpis(rows);

      const html = buildPrintHtmlSummary({ company, runStr, runDateOnly, filterSummary, kpis, rows });
      await printHtmlViaIframe(html);
    }

    async function handlePrintClick(){
      const rows = STATE.filtered || [];
      if(!rows.length){
        alert('No crop plan fields match the current filters to print.');
        return;
      }
      openPrintChoice();
    }

    function wireEvents(){
      $('#btnBack')?.addEventListener('click', () => {
        location.href = '/Farm-vista/pages/reports/reports-predefined.html';
      });

      $('#filterYear')?.addEventListener('change', async () => {
        const { year } = getFilters();
        await loadPlansForYear(year);
        hydrateFarmDropdown();
        applyFilters();
      });

      $('#filterFarm')?.addEventListener('change', () => applyFilters());
      $('#filterCrop')?.addEventListener('change', () => applyFilters());
      $('#filterView')?.addEventListener('change', () => render());

      $('#btnPrint')?.addEventListener('click', handlePrintClick);
      $('#btnPrintBottom')?.addEventListener('click', handlePrintClick);

      // modal close + actions (match trial summary behavior)
      document.getElementById('btnPrintX')?.addEventListener('click', closePrintChoice);
      document.getElementById('btnPrintCancel')?.addEventListener('click', closePrintChoice);

      document.getElementById('btnPrintSummary')?.addEventListener('click', async ()=>{
        closePrintChoice();
        await runPrintSummary();
      });
      document.getElementById('btnPrintDetailed')?.addEventListener('click', async ()=>{
        closePrintChoice();
        await runPrintDetailed();
      });

      document.getElementById('fvPrintChoice')?.addEventListener('click', (e)=>{
        if(e.target && e.target.id === 'fvPrintChoice') closePrintChoice();
      });

      window.addEventListener('keydown', (e)=>{
        if(e.key === 'Escape') closePrintChoice();
      });
    }

    (async function boot(){
      await ready;
      STATE.db = getFirestore();

      const shell = document.querySelector('fv-shell');
      if (shell) shell.nav = NAV_MENU;

      await Promise.all([ loadFarms(), loadAvailableYears(), loadFields() ]);
      hydrateYearDropdown();

      const yearSel = $('#filterYear');
      const defaultYear = yearSel?.value || String(STATE.years?.[0] || '');
      if(yearSel && defaultYear) yearSel.value = defaultYear;

      await loadPlansForYear(defaultYear);
      hydrateFarmDropdown();

      wireEvents();
      applyFilters();
    })();
  </script>
</head>

<body>
  <fv-shell>
    <div class="wrap">
      <section class="hero">
        <header class="hero-head">
          <div class="icon" aria-hidden="true">🗂️</div>
          <div>
            <h1>Crop Plan — Flexible View</h1>
            <p class="muted">
              Filters: <strong>Crop Year</strong>, <strong>Farm</strong>, <strong>Crop Type</strong>.
              View Mode toggles <strong>Crop → Farm</strong> or <strong>Farm → Crop</strong>.
              PDF totals now print only once per section (no duplicates across pages).
            </p>
          </div>
        </header>

        <div class="body">
          <div class="toolbar">
            <div class="toolbar-left">
              <button id="btnBack" type="button" class="btn btn-quiet">← Back to Reports</button>
              <button id="btnPrint" type="button" class="btn btn-primary">Print / Save PDF</button>
            </div>
            <div class="page-header-meta" id="cpCount">Loading…</div>
          </div>

          <div class="filters" aria-label="Crop plan filters">
            <div class="filters-row">
              <div class="filter-field">
                <label class="filter-label" for="filterYear">Crop Year</label>
                <select id="filterYear" class="filter-select">
                  <option value="">Loading…</option>
                </select>
              </div>

              <div class="filter-field">
                <label class="filter-label" for="filterFarm">Farm</label>
                <select id="filterFarm" class="filter-select">
                  <option value="all">All farms</option>
                </select>
              </div>

              <div class="filter-field">
                <label class="filter-label" for="filterCrop">Crop Type</label>
                <select id="filterCrop" class="filter-select">
                  <option value="all">All</option>
                  <option value="corn">Corn</option>
                  <option value="soybeans">Soybeans</option>
                  <option value="unplanned">Unplanned</option>
                </select>
              </div>

              <div class="filter-field">
                <label class="filter-label" for="filterView">View Mode</label>
                <select id="filterView" class="filter-select">
                  <option value="cropFirst">Crop → Farm</option>
                  <option value="farmFirst">Farm → Crop</option>
                </select>
              </div>
            </div>
          </div>

          <div class="kpis" aria-label="Crop plan summary">
            <div class="kpi">
              <div class="lab">Fields</div>
              <div class="val" id="kpiFields">0</div>
              <div class="note">Matching filters</div>
            </div>
            <div class="kpi">
              <div class="lab">Total Acres</div>
              <div class="val mono" id="kpiAcres">0.00</div>
              <div class="note">All crops</div>
            </div>
            <div class="kpi">
              <div class="lab">Corn Acres</div>
              <div class="val mono" id="kpiCorn">0.00</div>
              <div class="note">Recognized corn</div>
            </div>
            <div class="kpi">
              <div class="lab">Soy Acres</div>
              <div class="val mono" id="kpiSoy">0.00</div>
              <div class="note">Recognized soybeans</div>
            </div>
          </div>

          <div id="reportBody">
            <div class="empty">Loading crop plan…</div>
          </div>

          <div class="bottom-actions">
            <button id="btnPrintBottom" type="button" class="btn btn-primary">Print / Save PDF</button>
          </div>
        </div>
      </section>

      <!-- FV modal print chooser (Trial Summary styled) -->
      <div id="fvPrintChoice" class="fv-modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="fv-modal">
          <div class="row">
            <div class="title">Choose report type</div>
            <button id="btnPrintX" type="button" class="x" aria-label="Close">
              <svg viewBox="0 0 24 24" fill="none" aria-hidden="true">
                <path d="M6 6l12 12M18 6L6 18" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </button>
          </div>
          <div class="sub">How do you want to print this crop plan?</div>
          <div class="sub" style="margin-top:0;">
            Summary reports match your other FarmVista PDF reports. Detailed reports include the field lists.
          </div>
          <div class="actions">
            <button id="btnPrintSummary" type="button" class="fv-choose-btn primary">Summary report</button>
            <button id="btnPrintDetailed" type="button" class="fv-choose-btn">Detailed report</button>
          </div>
          <div style="display:flex;justify-content:flex-end;margin-top:10px;">
            <button id="btnPrintCancel" type="button" class="btn btn-quiet">Cancel</button>
          </div>
        </div>
      </div>

      <iframe id="fv-print-frame"></iframe>
    </div>
  </fv-shell>
</body>
</html>
