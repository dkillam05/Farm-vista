<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FarmVista ‚Ä¢ Multiple Hybrid Trial Scoreboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#3B7E46" />

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest" />
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png" />
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png" />
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css" />
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css" />

  <style>
    :root{
      --card-max: 1200px;
      --page-bottom-gap: 72px;
      --accent: #2F6C3C;
    }

    body{
      background: var(--app-bg, var(--surface));
    }

    .wrap{
      max-width: var(--card-max);
      margin: 0 auto;
      padding: clamp(14px,3vw,22px);
      padding-bottom: calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + var(--page-bottom-gap)) !important;
      box-sizing:border-box;
    }

    .hero{
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));
      overflow:hidden;
    }
    .hero-head{
      display:grid;
      grid-template-columns:36px 1fr;
      gap:12px;
      align-items:center;
      padding:14px 16px;
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);
      border-bottom:1px solid var(--border);
    }
    .hero-head .icon{
      width:24px;
      height:24px;
      color:var(--accent);
      display:grid;
      place-items:center;
    }
    .hero-head h1{
      margin:0;
      font-size:clamp(20px,3.2vw,26px);
      line-height:1.2;
    }
    .muted{ color:var(--muted,#67706B); }

    .body{
      padding:16px;
      display:grid;
      gap:14px;
    }

    /* Toolbar + back / print buttons */
    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:flex-end;
      justify-content:space-between;
    }
    .toolbar-left{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:120px;
      padding:10px 14px;
      border-radius:12px;
      border:1px solid var(--border);
      font-weight:800;
      text-decoration:none;
      cursor:pointer;
      user-select:none;
      color:var(--text) !important;
      background:var(--card-surface,var(--surface));
      font-size:0.9rem;
      gap:6px;
    }
    .btn-quiet{
      min-width:auto;
      padding-inline:10px;
    }
    .btn-primary{
      border-color:transparent;
      background:#2F6C3C;
      color:#fff !important;
    }

    .page-header-meta{
      font-size:0.9rem;
      opacity:0.8;
    }

    /* Filters */
    .filters{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:flex-end;
      margin-top:4px;
    }
    .filter-field{
      display:flex;
      flex-direction:column;
      gap:3px;
      min-width:150px;
      flex:1 1 160px;
      font-size:0.8rem;
    }
    .filter-label{
      text-transform:uppercase;
      letter-spacing:0.08em;
      opacity:0.78;
    }
    .filter-select{
      border-radius:999px;
      border:1px solid var(--border);
      padding:6px 10px;
      font-size:0.9rem;
      background:var(--card-surface,var(--surface));
      color:var(--text);
      min-height:32px;
    }

    /* Scoreboard table card */
    .scorecard{
      margin-top:8px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--card-surface,var(--surface));
      box-shadow:var(--shadow-soft,var(--shadow));
      padding:12px 14px 10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .scorecard-note{
      font-size:0.85rem;
      color:var(--muted,#6b766e);
      display:flex;
      align-items:center;
      gap:6px;
    }
    .scorecard-note svg{
      width:14px;
      height:14px;
      flex-shrink:0;
    }

    .score-table-wrap{
      border-radius:10px;
      border:1px solid var(--border);
      overflow:auto;
      background:var(--surface);
    }

    .score-table{
      width:100%;
      border-collapse:collapse;
      font-size:0.8rem;
      min-width:720px;
    }

    .score-table thead{
      background:#f6faf7;
    }

    .score-table th,
    .score-table td{
      padding:6px 8px;
      border-bottom:1px solid #ebf0eb;
      text-align:left;
      white-space:nowrap;
    }

    .score-table th:first-child,
    .score-table td:first-child{
      padding-left:12px;
    }
    .score-table th:last-child,
    .score-table td:last-child{
      padding-right:12px;
    }

    .score-table th{
      font-weight:600;
      font-size:0.78rem;
      color:var(--muted,#6b766e);
      text-transform:uppercase;
      letter-spacing:0.08em;
    }

    .score-placeholder-row td{
      padding:18px 12px;
      text-align:center;
      color:var(--muted,#6b766e);
      font-size:0.8rem;
    }

    .rank-pill{
      border-radius:999px;
      padding:2px 10px;
      border:1px solid #d0ddcf;
      font-size:0.74rem;
      font-weight:500;
      display:inline-flex;
      align-items:center;
      gap:4px;
      background:#f7fbf7;
      color:#19351f;
    }
    .rank-pill span{
      font-size:0.7rem;
      text-transform:uppercase;
      letter-spacing:0.06em;
      color:var(--muted,#6b766e);
    }

    .cell-right{
      text-align:right;
    }

    /* Bottom print button */
    .bottom-actions{
      margin-top:16px;
      display:flex;
      justify-content:flex-end;
    }

    /* Hidden iframe for print */
    #fv-print-frame{
      position:fixed;
      right:0;
      bottom:0;
      width:0;
      height:0;
      border:0;
      visibility:hidden;
    }

    @media print{
      html,body{
        background:#fff;
      }
      .wrap{
        padding:0 !important;
      }
      .hero{
        border-radius:0;
        box-shadow:none;
        border:none;
      }
    }

    /* =========================
       EMBED MODE (dashboard)
       Only show filters + scorecard
       ========================= */
    html.embed-mode body{
      background:transparent;
    }
    html.embed-mode .wrap{
      max-width:none;
      margin:0;
      /* give extra vertical room when embedded so native dropdown can't clip */
      padding:0 0 56px 0;
      padding-bottom:56px !important;
      box-sizing:border-box;
      min-height:650px;
    }
    html.embed-mode .hero{
      border:none;
      border-radius:0;
      box-shadow:none;
      background:transparent;
    }
    html.embed-mode .hero-head,
    html.embed-mode .toolbar,
    html.embed-mode .bottom-actions{
      display:none !important;
    }
    html.embed-mode .scorecard{
      margin-top:0;
      box-shadow:none;
      border:none;
      padding:8px 0 0;
    }
  </style>

  <!-- detect embed mode from ?embed=1 -->
  <script>
    (function(){
      try{
        var params = new URL(location.href).searchParams;
        if (params.get('embed') === '1') {
          document.documentElement.classList.add('embed-mode');
        }
      }catch(e){
        console.warn('[mh-scoreboard] failed to parse URL for embed mode', e);
      }
    })();
  </script>

  <!-- lazy-load fv-shell unless we're embedded -->
  <script>
    (function(){
      var isEmbed = document.documentElement.classList.contains('embed-mode');
      if (isEmbed) {
        // In embed mode we don't want the app header/footer at all.
        return;
      }
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true;
        document.head.appendChild(s);
      }
    })();
  </script>

  <script type="module">
    import {
      ready,
      getFirestore,
      doc, getDoc
    } from '/Farm-vista/js/firebase-init.js';

    import { NAV_MENU } from '/Farm-vista/js/menu.js';

    const urlParams = new URL(location.href).searchParams;
    const IS_EMBED  = urlParams.get('embed') === '1';
    const URL_YEAR  = urlParams.get('year'); // used to preselect year when embedded

    const CONFIG = {
      COMPANY_DOC_PATH: ['company','main']
    };

    const $  = (sel, root=document) => root.querySelector(sel);

    const STATE = {
      db: null,
      company: null,
      rows: [],   // TODO: wire MH scoreboard data into this later
      filters: {
        year: null,
        status: 'active'
      },
      isEmbed: IS_EMBED
    };

    function escapeHtml(str){
      return String(str ?? '').replace(/[&<>"']/g, m => (
        { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]
      ));
    }

    function formatDate(d){
      if(!d) return '';
      try{
        return d.toLocaleDateString(undefined,{month:'short',day:'numeric',year:'numeric'});
      }catch{ return ''; }
    }

    function formatDateTime(d){
      if(!d) return '';
      try{
        return d.toLocaleString();
      }catch{ return ''; }
    }

    function updateMeta(){
      const meta = $('#mhSummaryMeta');
      if(!meta) return;

      const year   = STATE.filters.year;
      const status = STATE.filters.status;
      const count  = STATE.rows.length;

      if(!year){
        meta.textContent = 'Choose crop year and trial status. Scoreboard will populate once data is wired.';
        return;
      }

      let statusLabel = 'Active trials';
      if(status === 'completed') statusLabel = 'Completed trials';
      if(status === 'all')       statusLabel = 'All statuses';

      meta.textContent = `${year} ‚Ä¢ ${statusLabel} ‚Ä¢ ${count} entries`;
    }

    function renderScoreboard(){
      const tbody = $('#mhScoreBody');
      if(!tbody) return;

      const rows = STATE.rows; // in future, you can filter here by year/status

      if(!rows.length){
        tbody.innerHTML = `
          <tr class="score-placeholder-row">
            <td colspan="10">
              Select crop year and trial status. Multiple Hybrid entries will appear here once we wire Firestore.
            </td>
          </tr>
        `;
        return;
      }

      const nfYield = new Intl.NumberFormat(undefined,{maximumFractionDigits:1});
      const nfPct   = new Intl.NumberFormat(undefined,{maximumFractionDigits:2});

      tbody.innerHTML = rows.map(row => {
        const rankChip = row.rank != null
          ? `<span class="rank-pill"><strong>${row.rank}</strong> <span>rank</span></span>`
          : `<span class="rank-pill"><strong>‚Äî</strong> <span>rank</span></span>`;

        const y = (typeof row.yieldBuAc === 'number') ? nfYield.format(row.yieldBuAc) : '';
        const m = (typeof row.moisture === 'number') ? nfPct.format(row.moisture) : '';
        const p = (typeof row.pctVsCheck === 'number') ? nfPct.format(row.pctVsCheck) + '%' : '';

        return `
          <tr>
            <td>${rankChip}</td>
            <td>${escapeHtml(row.brand || '')}</td>
            <td>${escapeHtml(row.variety || '')}</td>
            <td>${escapeHtml(row.trait || '')}</td>
            <td>${escapeHtml(row.maturity || '')}</td>
            <td class="cell-right">${y}</td>
            <td class="cell-right">${m}</td>
            <td class="cell-right">${p}</td>
            <td>${escapeHtml(row.trialName || '')}</td>
            <td>${escapeHtml(row.farmField || '')}</td>
          </tr>
        `;
      }).join('');
    }

    async function loadCompanyHeader(){
      if(STATE.company) return STATE.company;
      try{
        const [col,id] = CONFIG.COMPANY_DOC_PATH;
        const ref = doc(STATE.db, col, id);
        const snap = await getDoc(ref);
        const d = snap.exists() ? (snap.data() || {}) : {};
        const name = d.name || '';
        const address = [
          d.addressStreet || '',
          [d.addressCity, d.addressState].filter(Boolean).join(', '),
          d.addressZip || ''
        ].filter(Boolean).join(' ¬∑ ');
        const phone = d.phone || '';
        const email = d.email || '';
        STATE.company = { name, address, phone, email };
      }catch(e){
        console.warn('[mh-scoreboard] failed to load company header', e);
        STATE.company = { name:'', address:'', phone:'', email:'' };
      }
      return STATE.company;
    }

    function buildPrintHtml({ company, runStr, runDateOnly, cropYearLabel, statusLabel, rows }){
      const totalEntries = rows.length;
      const brandSet = new Set();
      const varietySet = new Set();
      let maxYield = null;

      rows.forEach(r => {
        if(r.brand)   brandSet.add(r.brand);
        if(r.variety) varietySet.add(r.variety);
        if(typeof r.yieldBuAc === 'number'){
          maxYield = (maxYield == null) ? r.yieldBuAc : Math.max(maxYield, r.yieldBuAc);
        }
      });

      const nfYield = new Intl.NumberFormat(undefined,{maximumFractionDigits:1});
      const brandsCount   = brandSet.size;
      const varietiesCount= varietySet.size;
      const topYieldLabel = maxYield == null ? 'N/A' : nfYield.format(maxYield) + ' bu/ac';

      const filterSummary = `${cropYearLabel || 'All years'} ‚Ä¢ ${statusLabel || 'All statuses'}`;

      return `<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Multiple Hybrid Trial Scoreboard</title>
  <style>
    :root{
      --fv-green:#3B7E46;
      --fv-border:#D1D5DB;
      --fv-text:#111827;
      --fv-muted:#6B7280;
      --fv-bg:#F3F4F6;
    }
    *{box-sizing:border-box;}
    html,body{
      margin:0;
      padding:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      color:var(--fv-text);
      background:var(--fv-bg);
    }
    body{
      display:flex;
      justify-content:center;
      padding:24px 12px;
    }
    .page{
      width:100%;
      max-width:900px;
      background:#fff;
      border-radius:12px;
      box-shadow:0 10px 30px rgba(15,23,42,0.15);
      padding:24px 28px 28px;
    }
    .report-header{
      display:grid;
      grid-template-columns:auto 1fr auto;
      gap:16px;
      align-items:center;
      border-bottom:2px solid var(--fv-green);
      padding-bottom:14px;
      margin-bottom:18px;
    }
    .report-logo{
      width:64px;
      height:64px;
      border-radius:16px;
      border:1px solid var(--fv-border);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:26px;
      font-weight:800;
      color:#fff;
      background:radial-gradient(circle at 30% 0%, #4CAF50, var(--fv-green));
    }
    .report-logo span{letter-spacing:0.02em;}
    .company-block{min-width:0;}
    .company-name{
      font-size:18px;
      font-weight:800;
      margin:0 0 2px;
    }
    .company-line{
      font-size:12px;
      color:var(--fv-muted);
      margin:0;
    }
    .report-meta-top{
      text-align:right;
      font-size:11px;
      color:var(--fv-muted);
    }
    .report-meta-top strong{color:var(--fv-text);}
    .report-title-block{margin-bottom:16px;}
    .report-title{
      font-size:20px;
      font-weight:800;
      margin:4px 0 4px;
      letter-spacing:0.02em;
      text-transform:uppercase;
    }
    .report-subtitle{
      font-size:13px;
      color:var(--fv-muted);
      margin:0;
    }
    .report-summary-strip{
      margin-top:12px;
      padding:8px 10px;
      border-radius:10px;
      background:linear-gradient(90deg, rgba(59,126,70,0.08), transparent);
      border:1px solid rgba(59,126,70,0.20);
      font-size:11px;
      display:flex;
      flex-wrap:wrap;
      gap:6px 16px;
    }
    .summary-pill{
      display:inline-flex;
      align-items:center;
      gap:4px;
      white-space:nowrap;
    }
    .summary-label{
      text-transform:uppercase;
      letter-spacing:0.08em;
      font-weight:600;
      font-size:10px;
      color:var(--fv-muted);
    }
    .summary-value{
      font-weight:600;
      font-size:11px;
    }
    .section{margin-top:18px;}
    .section-heading-row{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
      margin-bottom:6px;
    }
    .section-title-main{
      font-size:15px;
      font-weight:700;
      letter-spacing:0.03em;
      text-transform:uppercase;
    }
    .section-note{
      font-size:11px;
      color:var(--fv-muted);
    }
    .kpi-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:6px;
    }
    .kpi-card{
      flex:1 1 140px;
      border-radius:10px;
      border:1px solid var(--fv-border);
      padding:8px 10px;
      background:linear-gradient(135deg, rgba(59,126,70,0.06), #ffffff);
    }
    .kpi-label{
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:var(--fv-muted);
      margin-bottom:2px;
    }
    .kpi-value{
      font-size:16px;
      font-weight:800;
    }
    .kpi-footnote{
      font-size:10px;
      color:var(--fv-muted);
      margin-top:2px;
    }
    .section-title{
      font-size:13px;
      text-transform:uppercase;
      letter-spacing:0.12em;
      color:var(--fv-muted);
      margin:0 0 4px;
    }
    .section-body{
      font-size:12px;
      line-height:1.5;
    }
    .table-wrap{
      margin-top:4px;
      border-radius:10px;
      border:1px solid var(--fv-border);
      overflow:hidden;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
    }
    thead{
      background:#F9FAFB;
    }
    th, td{
      padding:6px 8px;
      border-bottom:1px solid #E5E7EB;
      text-align:left;
      vertical-align:top;
      white-space:nowrap;
    }
    th{
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.08em;
      font-size:10px;
      color:#4B5563;
      border-bottom:1px solid #D1D5DB;
    }
    tr:nth-child(even) td{
      background:#F9FAFB;
    }
    .cell-right{text-align:right;}
    .report-footer{
      margin-top:18px;
      padding-top:8px;
      border-top:1px solid var(--fv-border);
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:10px;
      color:var(--fv-muted);
    }
    .footer-left{max-width:60%;}
    .footer-right{text-align:right;}
    @media print{
      html,body{background:#fff;padding:0;}
      body{box-shadow:none;}
      .page{
        max-width:none;
        border-radius:0;
        box-shadow:none;
        padding:12mm 14mm;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="report-header">
      <div class="report-logo">
        <span>DF</span>
      </div>
      <div class="company-block">
        <p class="company-name">${escapeHtml(company.name || '')}</p>
        <p class="company-line">
          ${company.address ? escapeHtml(company.address) + '<br>' : ''}
          ${company.phone ? 'Phone: ' + escapeHtml(company.phone) : ''}${company.phone && company.email ? ' ¬∑ ' : ''}
          ${company.email ? 'Email: ' + escapeHtml(company.email) : ''}
        </p>
      </div>
      <div class="report-meta-top">
        <div><strong>Multiple Hybrid Trial Scoreboard</strong></div>
        <div>Generated: ${escapeHtml(runStr)}</div>
        <div>Prepared by: ${escapeHtml(company.name || 'FarmVista')}</div>
      </div>
    </header>

    <section class="report-title-block">
      <h1 class="report-title">Multiple Hybrid Trial Scoreboard</h1>
      <p class="report-subtitle">
        Ranked multiple hybrid entries by yield and % vs check for the selected crop year and trial status.
      </p>

      <div class="report-summary-strip">
        <div class="summary-pill">
          <span class="summary-label">Crop Year</span>
          <span class="summary-value">${escapeHtml(cropYearLabel || 'All')}</span>
        </div>
        <div class="summary-pill">
          <span class="summary-label">Filters</span>
          <span class="summary-value">${escapeHtml(filterSummary)}</span>
        </div>
        <div class="summary-pill">
          <span class="summary-label">Entries</span>
          <span class="summary-value">${totalEntries}</span>
        </div>
      </div>
    </section>

    <section class="section">
      <div class="section-heading-row">
        <div class="section-title-main">Key Metrics</div>
        <div class="section-note">Snapshot at the time of report generation.</div>
      </div>
      <div class="kpi-row">
        <div class="kpi-card">
          <div class="kpi-label">Total Entries</div>
          <div class="kpi-value">${totalEntries}</div>
          <div class="kpi-footnote">Rows included in this scoreboard</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Brands</div>
          <div class="kpi-value">${brandsCount}</div>
          <div class="kpi-footnote">Unique seed brands represented</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Top Yield</div>
          <div class="kpi-value">${escapeHtml(topYieldLabel)}</div>
          <div class="kpi-footnote">Highest yield across entries</div>
        </div>
      </div>
    </section>

    <section class="section">
      <h2 class="section-title">Entries</h2>
      <div class="section-body">
        ${rows.length === 0 ? `
          <p>No scoreboard entries for the selected crop year and status yet.</p>
        ` : `
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th style="width:10%;">Rank</th>
                  <th style="width:12%;">Brand</th>
                  <th style="width:14%;">Variety</th>
                  <th style="width:10%;">Trait</th>
                  <th style="width:10%;">Maturity</th>
                  <th style="width:10%;">Yield (bu/ac)</th>
                  <th style="width:10%;">Moisture (%)</th>
                  <th style="width:10%;">% vs Check</th>
                  <th style="width:12%;">Trial</th>
                  <th>Farm / Field</th>
                </tr>
              </thead>
              <tbody>
                ${rows.map(r => {
                  const y = (typeof r.yieldBuAc === 'number') ? nfYield.format(r.yieldBuAc) : '';
                  const m = (typeof r.moisture === 'number') ? new Intl.NumberFormat(undefined,{maximumFractionDigits:2}).format(r.moisture) : '';
                  const p = (typeof r.pctVsCheck === 'number') ? new Intl.NumberFormat(undefined,{maximumFractionDigits:2}).format(r.pctVsCheck) + '%' : '';

                  const rankLabel = r.rank != null ? '#' + r.rank : '‚Äî';

                  return `
                    <tr>
                      <td>${escapeHtml(rankLabel)}</td>
                      <td>${escapeHtml(r.brand || '')}</td>
                      <td>${escapeHtml(r.variety || '')}</td>
                      <td>${escapeHtml(r.trait || '')}</td>
                      <td>${escapeHtml(r.maturity || '')}</td>
                      <td class="cell-right">${escapeHtml(y)}</td>
                      <td class="cell-right">${escapeHtml(m)}</td>
                      <td class="cell-right">${escapeHtml(p)}</td>
                      <td>${escapeHtml(r.trialName || '')}</td>
                      <td>${escapeHtml(r.farmField || '')}</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        `}
      </div>
    </section>

    <footer class="report-footer">
      <div class="footer-left">
        Internal use only. Multiple hybrid trial results are preliminary until fully reviewed.
      </div>
      <div class="footer-right">
        FarmVista ‚Ä¢ Multiple Hybrid Trial Scoreboard ‚Ä¢ ${escapeHtml(runDateOnly || '')}
      </div>
    </footer>
  </div>
</body>
</html>`;
    }

    async function handlePrintClick(){
      const yearSel   = $('#filterYear');
      const statusSel = $('#filterStatus');

      const cropYearLabel = yearSel?.value || '';
      let statusLabel = 'Active trials';
      if(statusSel){
        if(statusSel.value === 'completed') statusLabel = 'Completed trials';
        else if(statusSel.value === 'all')  statusLabel = 'All statuses';
      }

      const company = await loadCompanyHeader();
      const now = new Date();
      const runStr = formatDateTime(now);
      const runDateOnly = formatDate(now);

      const html = buildPrintHtml({
        company,
        runStr,
        runDateOnly,
        cropYearLabel,
        statusLabel,
        rows: STATE.rows   // in future: filtered rows
      });

      let iframe = document.getElementById('fv-print-frame');
      if(!iframe){
        iframe = document.createElement('iframe');
        iframe.id = 'fv-print-frame';
        document.body.appendChild(iframe);
      }

      const win = iframe.contentWindow || iframe.contentDocument;
      const doc = iframe.contentDocument || iframe.contentWindow.document;

      doc.open();
      doc.write(html);
      doc.close();

      setTimeout(() => {
        try{
          win.focus();
          win.print();
        }catch(err){
          console.warn('[mh-scoreboard] iframe print failed, falling back to window.print()', err);
          window.print();
        }
      }, 400);
    }

    function initFilters(){
      const yearSel = $('#filterYear');
      if(yearSel){
        const now = new Date();
        const currentYear = now.getFullYear();

        // use URL year if provided, otherwise current year
        let initialYear = currentYear;
        if (URL_YEAR && /^\d{4}$/.test(URL_YEAR)) {
          initialYear = parseInt(URL_YEAR, 10);
        }

        const years = [initialYear + 1, initialYear, initialYear - 1, initialYear - 2];

        years.forEach(y => {
          const opt = document.createElement('option');
          opt.value = String(y);
          opt.textContent = y;
          if(y === initialYear) opt.selected = true;
          yearSel.appendChild(opt);
        });

        STATE.filters.year = String(initialYear);

        yearSel.addEventListener('change', () => {
          STATE.filters.year = yearSel.value || null;
          updateMeta();
          // later: reload data by year
          console.log('[MH Scoreboard] Year changed:', STATE.filters.year);
        });
      }

      const statusSel = $('#filterStatus');
      if(statusSel){
        statusSel.addEventListener('change', () => {
          STATE.filters.status = statusSel.value || 'active';
          updateMeta();
          // later: reload / re-filter data by status
          console.log('[MH Scoreboard] Status changed:', STATE.filters.status);
        });
      }

      updateMeta();
    }

    (async function boot(){
      await ready;
      STATE.db = getFirestore();

      const shell = document.querySelector('fv-shell');
      if(shell) shell.nav = NAV_MENU;

      const backBtn = document.getElementById('btnBack');
      if(backBtn && !STATE.isEmbed){
        backBtn.addEventListener('click', () => {
          location.href = '/Farm-vista/pages/reports/reports-predefined.html';
        });
      }

      const printTop    = $('#btnPrint');
      const printBottom = $('#btnPrintBottom');
      if(printTop && !STATE.isEmbed)    printTop.addEventListener('click', handlePrintClick);
      if(printBottom && !STATE.isEmbed) printBottom.addEventListener('click', handlePrintClick);

      initFilters();
      renderScoreboard();
    })();
  </script>

  <!-- ===========================================
       Auto-resize: send height to parent for iframe
       =========================================== -->
  <script>
    (function(){
      try{
        if (window.parent && window.parent !== window) {
          const sendHeight = () => {
            const h = document.documentElement.scrollHeight || document.body.scrollHeight || 0;
            window.parent.postMessage(
              { type: 'fv-scorecard-height', height: h },
              window.location.origin
            );
          };

          const ro = new ResizeObserver(sendHeight);
          ro.observe(document.body);

          window.addEventListener('load', sendHeight);
          sendHeight();
        }
      }catch(e){
        console.warn('[mh-scoreboard] auto-resize failed', e);
      }
    })();
  </script>
</head>

<body>
  <fv-shell>
    <div class="wrap">
      <section class="hero">
        <header class="hero-head">
          <div class="icon" aria-hidden="true">üß¨</div>
          <div>
            <h1>Multiple Hybrid Trial Scoreboard</h1>
            <p class="muted">
              Compare multiple hybrid entries by brand, variety, and yield once MH yield data is wired in.
            </p>
          </div>
        </header>

        <div class="body">
          <div class="toolbar">
            <div class="toolbar-left">
              <button id="btnBack" type="button" class="btn btn-quiet">
                ‚Üê Back to Reports
              </button>
              <button id="btnPrint" type="button" class="btn btn-primary">
                Print / Save PDF
              </button>
            </div>
            <div class="page-header-meta" id="mhSummaryMeta">
              Choose crop year and trial status. Scoreboard will populate once data is wired.
            </div>
          </div>

          <div class="filters">
            <div class="filter-field">
              <label class="filter-label" for="filterYear">Crop Year</label>
              <select id="filterYear" class="filter-select">
                <!-- options added by JS -->
              </select>
            </div>

            <div class="filter-field">
              <label class="filter-label" for="filterStatus">Trial Status</label>
              <select id="filterStatus" class="filter-select">
                <option value="active">Active trials</option>
                <option value="completed">Completed trials</option>
                <option value="all">All statuses</option>
              </select>
            </div>
          </div>

          <section class="scorecard" aria-label="Multiple Hybrid trial scoreboard">
            <div class="scorecard-note">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="1.4" />
                <path d="M11.2 7.2h1.6v1.6h-1.6V7.2Zm0 3.2h1.6v6.4h-1.6v-6.4Z" fill="currentColor"/>
              </svg>
              Scoreboard columns and layout are fixed. Ranking and % vs check will be calculated from MH yield data later.
            </div>

            <div class="score-table-wrap">
              <table class="score-table">
                <thead>
                  <tr>
                    <th style="width:80px;">Rank</th>
                    <th>Brand</th>
                    <th>Variety</th>
                    <th>Trait</th>
                    <th>Maturity</th>
                    <th class="cell-right">Yield (bu/ac)</th>
                    <th class="cell-right">Moisture (%)</th>
                    <th class="cell-right">% vs Check</th>
                    <th>Trial</th>
                    <th>Farm / Field</th>
                  </tr>
                </thead>
                <tbody id="mhScoreBody">
                  <tr class="score-placeholder-row">
                    <td colspan="10">
                      Select crop year and trial status above. Multiple Hybrid entries will appear here once we wire Firestore.
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </section>

          <div class="bottom-actions">
            <button id="btnPrintBottom" type="button" class="btn btn-primary">
              Print / Save PDF
            </button>
          </div>
        </div>
      </section>
    </div>

    <!-- Hidden iframe used for print so we don't open a new tab -->
    <iframe id="fv-print-frame"></iframe>
  </fv-shell>
</body>
</html>
