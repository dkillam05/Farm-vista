<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FarmVista • Multiple Hybrid Trial Scoreboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#3B7E46" />

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest" />
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png" />
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png" />
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css" />
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css" />

  <style>
    :root{
      --card-max: 1200px;
      --page-bottom-gap: 56px;
      --accent: #2F6C3C;
    }

    html,
    body{
      margin:0;
      padding:0;
      max-width:100%;
      overflow-x:hidden;
      background: var(--app-bg, var(--surface));
    }

    body{
      background: var(--app-bg, var(--surface));
    }

    .wrap{
      max-width: var(--card-max);
      width:100%;
      margin: 0 auto;
      padding: clamp(12px,3vw,20px);
      padding-bottom: calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + var(--page-bottom-gap)) !important;
      box-sizing:border-box;
      overflow-x:hidden;
    }

    .hero{
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));
      overflow:visible;
    }
    .hero-head{
      display:grid;
      grid-template-columns:32px 1fr;
      gap:10px;
      align-items:center;
      padding:12px 14px;
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);
      border-bottom:1px solid var(--border);
    }
    .hero-head .icon{
      width:24px;
      height:24px;
      color:var(--accent);
      display:grid;
      place-items:center;
    }
    .hero-head h1{
      margin:0;
      font-size:clamp(19px,3.2vw,24px);
      line-height:1.2;
    }
    .muted{ color:var(--muted,#67706B); }

    .body{
      padding:14px;
      display:grid;
      gap:14px;
    }

    /* Toolbar + buttons */
    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:flex-end;
      justify-content:space-between;
    }
    .toolbar-left{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:120px;
      padding:9px 14px;
      border-radius:12px;
      border:1px solid var(--border);
      font-weight:800;
      text-decoration:none;
      cursor:pointer;
      user-select:none;
      color:var(--text) !important;
      background:var(--card-surface,var(--surface));
      font-size:0.9rem;
      gap:6px;
      white-space:nowrap;
    }
    .btn-quiet{
      min-width:auto;
      padding-inline:10px;
    }
    .btn-primary{
      border-color:transparent;
      background:#2F6C3C;
      color:#fff !important;
    }

    .page-header-meta{
      font-size:0.9rem;
      opacity:0.8;
      text-align:right;
    }

    /* Filters – match Field Trial Summary */
    .filters{
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:stretch;
      margin-top:4px;
    }
    .filters-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:flex-end;
    }
    .filter-field{
      display:flex;
      flex-direction:column;
      gap:3px;
      min-width:140px;
      flex:1 1 150px;
      font-size:0.8rem;
    }
    .filter-field--grow{
      flex:2 1 260px;
    }
    .filter-label{
      text-transform:uppercase;
      letter-spacing:0.08em;
      opacity:0.78;
    }
    .filter-select{
      border-radius:999px;
      border:1px solid var(--border);
      padding:6px 10px;
      font-size:0.9rem;
      background:var(--card-surface,var(--surface));
      color:var(--text);
      min-height:32px;
      width:100%;
    }

    /* Summary card (Variety Plot header) – DESKTOP KPI TILES */
    .trial-summary{
      margin-top:8px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--card-surface,var(--surface));
      padding:10px 12px 12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      font-size:0.86rem;
    }
    .trial-summary-empty{
      margin:0;
      font-size:0.85rem;
      color:var(--muted,#6b766e);
    }
    .trial-summary-head{
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:flex-start;
    }
    .trial-summary-title{
      font-weight:600;
      font-size:0.98rem;
    }
    .trial-summary-meta{
      font-size:0.8rem;
      color:var(--muted,#6b766e);
      margin-top:2px;
    }
    .status-chip{
      font-size:0.72rem;
      text-transform:uppercase;
      letter-spacing:0.08em;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(47,108,60,0.35);
      background:rgba(47,108,60,0.08);
      color:#23452c;
      white-space:nowrap;
    }

    .trial-summary-kpis{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      font-size:0.8rem;
    }
    .trial-summary-kpi{
      flex:1 1 90px;
      min-width:90px;
      border-radius:999px;
      border:1px solid var(--border);
      padding:8px 10px;
      background:var(--card-surface,var(--surface));
    }
    .kpi-label-small{
      display:block;
      text-transform:uppercase;
      letter-spacing:0.08em;
      font-size:0.7rem;
      color:var(--muted,#6b766e);
      margin-bottom:1px;
    }
    .kpi-value-small{
      font-size:1rem;
      font-weight:700;
    }

    .trial-summary-top{
      font-size:0.82rem;
      color:var(--muted,#5c665f);
    }
    .trial-summary-top strong{
      color:var(--text);
    }

    .trial-summary-footer{
      display:flex;
      justify-content:flex-start;
      margin-top:2px;
    }

    .helper-link{
      font-size:0.8rem;
      text-decoration:none;
      border-radius:999px;
      padding:4px 10px;
      border:1px solid rgba(47,108,60,0.4);
      background:rgba(47,108,60,0.06);
      color:#23452c !important;
      display:inline-flex;
      align-items:center;
      gap:4px;
      cursor:pointer;
    }
    .helper-link:hover{
      border-color:rgba(47,108,60,0.7);
      background:rgba(47,108,60,0.12);
    }

    /* MOBILE SUMMARY TILES (7 tiles under hero on phones) */
    .mh-mobile-summary{
      display:none;         /* turned on in mobile breakpoint */
      margin-top:8px;
    }
    .mh-mobile-tiles{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .mh-mobile-tile{
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--card-surface,var(--surface));
      padding:8px 12px;
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      font-size:0.86rem;
    }
    .mh-mobile-label{
      font-size:0.72rem;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:var(--muted,#6b766e);
      margin-right:8px;
      white-space:nowrap;
    }
    .mh-mobile-value{
      font-weight:700;
      font-size:0.9rem;
      text-align:right;
      flex:1;
    }
    .mh-mobile-sub{
      font-size:0.78rem;
      color:var(--muted,#6b766e);
      margin-top:2px;
    }
    .mh-mobile-helper{
      margin-top:4px;
      display:flex;
      justify-content:flex-start;
    }

    /* AI summary card (Plot Summary) */
    .ai-card{
      border-radius:12px;
      border:1px solid var(--border-subtle,var(--border));
      background:var(--card-surface,var(--surface));
      padding:12px 14px;
      font-size:0.9rem;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .ai-card-title{
      display:flex;
      align-items:center;
      gap:6px;
      font-weight:700;
      font-size:0.9rem;
    }
    .ai-chip{
      font-size:0.7rem;
      text-transform:uppercase;
      letter-spacing:0.08em;
      padding:3px 7px;
      border-radius:999px;
      border:1px solid var(--border-subtle,var(--border));
      background:color-mix(in srgb, var(--surface) 82%, var(--border) 18%);
    }
    .ai-summary-body{
      font-size:0.88rem;
      line-height:1.4;
    }
    .ai-summary-note{
      font-size:0.76rem;
      opacity:0.7;
    }
    .ai-summary-error{
      font-size:0.86rem;
      color:var(--danger,#A33A3A);
    }

    /* Scorecard wrapper */
    .scorecard{
      margin-top:8px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--card-surface,var(--surface));
      box-shadow:var(--shadow-soft,var(--shadow));
      padding:12px 14px 10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .scorecard-note{
      font-size:0.85rem;
      color:var(--muted,#6b766e);
      display:flex;
      align-items:center;
      gap:6px;
    }
    .scorecard-note svg{
      width:14px;
      height:14px;
      flex-shrink:0;
    }

    /* Desktop table */
    .score-table-wrap{
      border-radius:10px;
      border:1px solid var(--border);
      overflow:auto;
      background:var(--surface);
    }

    .score-table{
      width:100%;
      border-collapse:collapse;
      font-size:0.8rem;
      min-width:700px;
    }

    .score-table thead{
      background:#f6faf7;
    }

    .score-table th,
    .score-table td{
      padding:6px 8px;
      border-bottom:1px solid #ebf0eb;
      text-align:left;
      white-space:nowrap;
    }

    .score-table th:first-child,
    .score-table td:first-child{
      padding-left:12px;
    }
    .score-table th:last-child,
    .score-table td:last-child{
      padding-right:12px;
    }

    .score-table th{
      font-weight:600;
      font-size:0.78rem;
      color:var(--muted,#6b766e);
      text-transform:uppercase;
      letter-spacing:0.08em;
    }

    .score-placeholder-row td{
      padding:18px 12px;
      text-align:center;
      color:var(--muted,#6b766e);
      font-size:0.8rem;
    }

    .cell-right{
      text-align:right;
    }

    .bottom-actions{
      margin-top:16px;
      display:flex;
      justify-content:flex-end;
    }

    .desktop-only{
      display:block;
    }
    .mobile-only{
      display:none;
    }

    /* MOBILE SCORECARDS – now styled like trial field cards */
    .score-mobile-list{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .score-mobile-empty{
      padding:12px 10px;
      border-radius:10px;
      border:1px dashed var(--border);
      font-size:0.86rem;
      color:var(--muted,#6b766e);
      background:var(--card-surface,var(--surface));
    }
    .score-card{
      border-radius:12px;
      border:1px solid var(--border-subtle,var(--border));
      background:var(--card-surface,var(--surface));
      padding:10px 12px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .score-card-header{
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:flex-start;
    }
    .score-card-main{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .score-card-variety{
      font-weight:600;
      font-size:0.95rem;
    }
    .score-card-brand{
      font-size:0.8rem;
      opacity:0.8;
    }
    .score-card-adv{
      font-size:0.86rem;
      white-space:nowrap;
      font-weight:700;
    }
    .score-card-adv--pos::before{
      content:"+";
    }

    .score-card-tags{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      font-size:0.74rem;
      opacity:0.9;
    }
    .score-card-chip{
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--border-subtle,var(--border));
      background:color-mix(in srgb, var(--surface) 88%, var(--border) 12%);
    }

    .score-card-metrics{
      display:flex;
      flex-wrap:wrap;
      gap:8px 14px;
      font-size:0.8rem;
      margin-top:2px;
    }
    .score-card-metric{
      display:flex;
      flex-direction:column;
      gap:1px;
      min-width:90px;
    }
    .score-card-metric span{
      opacity:0.7;
      font-size:0.76rem;
    }
    .score-card-metric strong{
      font-size:0.9rem;
    }

    .score-card-footer{
      font-size:0.78rem;
      opacity:0.85;
      display:flex;
      justify-content:flex-end;
      margin-top:2px;
    }
    .score-card-entry{
      font-weight:500;
    }

    /* Hidden iframe for print */
    #fv-print-frame{
      position:fixed;
      right:0;
      bottom:0;
      width:0;
      height:0;
      border:0;
      visibility:hidden;
    }

    @media print{
      html,body{
        background:#fff;
      }
      .wrap{
        padding:0 !important;
      }
      .hero{
        border-radius:0;
        box-shadow:none;
        border:none;
      }
    }

    @media (max-width:640px){
      .wrap{
        padding-inline:10px;
      }

      /* Remove hero header on mobile (trial name + description) */
      .hero-head{
        display:none;
      }

      /* Desktop summary card hidden on mobile */
      .trial-summary{
        display:none;
      }

      /* Turn on MH mobile tiles + helper button area */
      .mh-mobile-summary{
        display:block;
      }

      .toolbar{
        flex-direction:column;
        align-items:stretch;
        gap:8px;
      }
      .toolbar-left{
        width:100%;
        justify-content:stretch;
      }
      .toolbar-left .btn{
        flex:1 1 auto;
        width:100%;
        justify-content:center;
      }
      .page-header-meta{
        text-align:left;
      }

      .bottom-actions{
        justify-content:stretch;
      }
      .bottom-actions .btn{
        width:100%;
        justify-content:center;
      }

      .desktop-only{
        display:none;
      }
      .mobile-only{
        display:block;
      }
    }

    /* Embed mode tweaks */
    html.embed-mode body{
      background:transparent;
    }
    html.embed-mode .wrap{
      max-width:none;
      margin:0;
      padding:0 0 56px 0;
      padding-bottom:56px !important;
      box-sizing:border-box;
      min-height:650px;
    }
    html.embed-mode .hero{
      border:none;
      border-radius:0;
      box-shadow:none;
      background:transparent;
      overflow:visible;
    }
    html.embed-mode .hero-head,
    html.embed-mode .toolbar,
    html.embed-mode .bottom-actions{
      display:none !important;
    }
    html.embed-mode .scorecard{
      margin-top:0;
      box-shadow:none;
      border:none;
      padding:8px 0 0;
    }
  </style>

  <!-- Detect embed mode -->
  <script>
    (function(){
      try{
        var params = new URL(location.href).searchParams;
        if (params.get('embed') === '1') {
          document.documentElement.classList.add('embed-mode');
        }
      }catch(e){
        console.warn('[mh-scoreboard] failed to parse URL for embed mode', e);
      }
    })();
  </script>

  <!-- Load shell (unless embedded) -->
  <script>
    (function(){
      var isEmbed = document.documentElement.classList.contains('embed-mode');
      if (isEmbed) return;
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true;
        document.head.appendChild(s);
      }
    })();
  </script>

  <!-- AI helper for Plot Summary -->
  <script src="/Farm-vista/js/ai-reports.js"></script>

  <script type="module">
    import {
      ready,
      getFirestore,
      doc, getDoc,
      collection, getDocs
    } from '/Farm-vista/js/firebase-init.js';

    import { NAV_MENU } from '/Farm-vista/js/menu.js';

    const urlParams = new URL(location.href).searchParams;
    const IS_EMBED  = urlParams.get('embed') === '1';
    const URL_YEAR  = urlParams.get('year');
    const URL_TRIAL = urlParams.get('trialId');

    const CONFIG = {
      COMPANY_DOC_PATH: ['company','main']
    };

    const $  = (sel, root=document) => root.querySelector(sel);

    function createEmptySummary(){
      return {
        trialName: '',
        cropYear: '',
        crop: '',
        status: '',
        fieldCount: 0,
        stripCount: 0,
        varietyCount: 0,
        topVariety: null,
        strongestWinner: null,
        plantDate: null,
        plotLengthFt: null,
        plotWidthFt: null,
        checkAvgYield: null,
        farmName: '',
        fieldName: '',
        checkVarietyBrand: '',
        checkVariety: ''
      };
    }

    const STATE = {
      db: null,
      company: null,
      rows: [],
      filters: {
        year: null,
        trialId: null,
        trialName: ''
      },
      summary: createEmptySummary(),
      isEmbed: IS_EMBED
    };

    const productMetaCache = new Map();

    function escapeHtml(str){
      return String(str ?? '').replace(/[&<>"']/g, m => (
        { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]
      ));
    }

    function coerceDate(val){
      if(!val) return null;
      try{
        if (val.toDate && typeof val.toDate === 'function') {
          return val.toDate();
        }
      }catch{}
      if (val instanceof Date) return val;
      const n = Date.parse(val);
      if (!Number.isNaN(n)) return new Date(n);
      return null;
    }

    function formatDate(d){
      if(!d) return '';
      try{
        return d.toLocaleDateString(undefined,{month:'short',day:'numeric',year:'numeric'});
      }catch{ return ''; }
    }

    function formatDateTime(d){
      if(!d) return '';
      try{
        return d.toLocaleString();
      }catch{ return ''; }
    }

    function getSelectedTrialLabel(){
      const trialSel = $('#filterTrial');
      if(!trialSel) return STATE.filters.trialName || '';
      const opt = trialSel.options[trialSel.selectedIndex];
      return opt ? opt.textContent || '' : '';
    }

    function updateMeta(){
      const meta = $('#mhSummaryMeta');
      if(!meta) return;

      const year = STATE.filters.year;
      const s = STATE.summary;

      if(!year || !s.trialName){
        meta.textContent = 'Choose crop year and Variety Plot trial. Scoreboard will populate once strips are available.';
        return;
      }

      const parts = [];
      parts.push(year);
      if(s.crop) parts.push(s.crop);
      if(s.status) parts.push(s.status);
      parts.push(`${s.varietyCount} varieties`);
      parts.push(`${s.fieldCount} field${s.fieldCount === 1 ? '' : 's'}`);
      parts.push(`${s.stripCount} strips`);

      meta.textContent = parts.join(' • ');
    }

    function renderSummaryCard(){
      const card = $('#trialSummaryCard');
      if(!card) return;

      const s = STATE.summary;
      const year = STATE.filters.year;

      if(!year || !s.trialName){
        card.innerHTML = `<p class="trial-summary-empty">Select crop year and Variety Plot trial to see a variety scoreboard summary.</p>`;
        renderMobileSummaryTiles();
        return;
      }

      const metaParts = [];
      const yr = s.cropYear || year;
      if(yr) metaParts.push(escapeHtml(String(yr)));
      if(s.crop) metaParts.push(escapeHtml(String(s.crop)));
      if(s.status) metaParts.push(escapeHtml(String(s.status)));

      const statusLabel = s.status
        ? (String(s.status).charAt(0).toUpperCase() + String(s.status).slice(1).toLowerCase())
        : '';

      const layoutParts = [];
      if (s.plantDate) {
        const d = formatDate(s.plantDate);
        if (d) layoutParts.push(`Planted ${d}`);
      }
      if (s.plotLengthFt || s.plotWidthFt) {
        const len = s.plotLengthFt ? `${s.plotLengthFt} ft` : '';
        const wid = s.plotWidthFt ? `${s.plotWidthFt} ft pass` : '';
        const combo = [len, wid].filter(Boolean).join(' × ');
        if (combo) layoutParts.push(`Plot layout ${combo}`);
      }
      if (typeof s.checkAvgYield === 'number' && Number.isFinite(s.checkAvgYield)) {
        layoutParts.push(`Check avg ${s.checkAvgYield.toFixed(1)} bu/ac`);
      }

      const layoutLine = layoutParts.length
        ? `<div class="trial-summary-meta">${layoutParts.map(escapeHtml).join(' • ')}</div>`
        : '';

      const farmFieldLine = (s.farmName || s.fieldName)
        ? `<div class="trial-summary-meta">${escapeHtml(s.farmName || '')}${s.farmName && s.fieldName ? ' • ' : ''}${escapeHtml(s.fieldName || '')}</div>`
        : '';

      const checkParts = [];
      if (s.checkVarietyBrand || s.checkVariety) {
        let name = `${s.checkVarietyBrand ? s.checkVarietyBrand + ' ' : ''}${s.checkVariety || ''}`.trim();
        if (name) checkParts.push(`${name} *`);
      }
      if (typeof s.checkAvgYield === 'number' && Number.isFinite(s.checkAvgYield)) {
        checkParts.push(`${s.checkAvgYield.toFixed(1)} bu/ac`);
      }
      const checkLine = checkParts.length
        ? `<div class="trial-summary-meta">Check: ${checkParts.map(escapeHtml).join(' • ')}</div>`
        : '';

      const top = s.topVariety;
      const topLine = top
        ? `Top yielder:
          <strong>${escapeHtml(top.variety || '(Variety)')}${top.isCheck ? ' *' : ''}</strong>
          ${top.brand ? ' · ' + escapeHtml(top.brand) : ''}
          ${typeof top.yieldBuAc === 'number'
            ? ` • ${top.yieldBuAc.toFixed(1)} bu/ac`
            : ''}
          ${typeof top.pctVsCheck === 'number'
            ? ` (${top.pctVsCheck.toFixed(1)}% vs check)`
            : ''}`
        : 'Top yielder will appear here once Variety Plot strips are entered for this trial.';

      const sw = s.strongestWinner;
      const swLine = sw
        ? `Strongest winner vs check:
          <strong>${escapeHtml(sw.variety || '(Variety)')}</strong>
          ${sw.brand ? ' · ' + escapeHtml(sw.brand) : ''}
          ${typeof sw.pctVsCheck === 'number'
            ? ` • ${sw.pctVsCheck.toFixed(1)}% vs check`
            : ''}`
        : 'Strongest winner vs check will appear here once more strips are entered.';

      const checkAvgLabel = (typeof s.checkAvgYield === 'number' && Number.isFinite(s.checkAvgYield))
        ? s.checkAvgYield.toFixed(1)
        : '—';

      card.innerHTML = `
        <div class="trial-summary-head">
          <div>
            <div class="trial-summary-title">
              ${escapeHtml(s.trialName || 'Variety Plot Trial')}
            </div>
            <div class="trial-summary-meta">
              ${metaParts.join(' • ')} • ${s.varietyCount} varieties
            </div>
            ${farmFieldLine}
            ${layoutLine}
            ${checkLine}
          </div>
          ${statusLabel
            ? `<span class="status-chip">${escapeHtml(statusLabel)}</span>`
            : ''}
        </div>

        <div class="trial-summary-kpis">
          <div class="trial-summary-kpi">
            <span class="kpi-label-small">Fields</span>
            <strong class="kpi-value-small">${s.fieldCount}</strong>
          </div>
          <div class="trial-summary-kpi">
            <span class="kpi-label-small">Strips</span>
            <strong class="kpi-value-small">${s.stripCount}</strong>
          </div>
          <div class="trial-summary-kpi">
            <span class="kpi-label-small">Varieties</span>
            <strong class="kpi-value-small">${s.varietyCount}</strong>
          </div>
          <div class="trial-summary-kpi">
            <span class="kpi-label-small">Check Avg (bu/ac)</span>
            <strong class="kpi-value-small">${checkAvgLabel}</strong>
          </div>
        </div>

        <div class="trial-summary-top">
          ${topLine}
        </div>
        <div class="trial-summary-top">
          ${swLine}
        </div>

        <div class="trial-summary-footer">
          <a href="/Farm-vista/docs/plot-layout.html"
             class="helper-link">
            Plot layout &amp; weighting guide
          </a>
        </div>
      `;

      // also update the mobile 7-tile summary
      renderMobileSummaryTiles();
    }

    // MOBILE: 7 summary tiles under hero (farm/field, varieties, plant date, pass size, check, top, strongest)
    function renderMobileSummaryTiles(){
      const container = document.getElementById('mhMobileTiles');
      if (!container) return;

      const s = STATE.summary;
      const year = STATE.filters.year;

      if (!year || !s.trialName) {
        container.innerHTML = `
          <div class="mh-mobile-tile">
            <div class="mh-mobile-label">Trial</div>
            <div class="mh-mobile-value">Select crop year &amp; Variety Plot trial</div>
          </div>
        `;
        return;
      }

      const farmField = [s.farmName, s.fieldName].filter(Boolean).join(' • ') || '—';
      const varietiesLabel = s.varietyCount ? String(s.varietyCount) : '—';
      const plantDateLabel = s.plantDate ? formatDate(s.plantDate) : '—';

      let passSizeLabel = '—';
      if (s.plotLengthFt || s.plotWidthFt) {
        const len = s.plotLengthFt ? `${s.plotLengthFt} ft` : '';
        const wid = s.plotWidthFt ? `${s.plotWidthFt} ft` : '';
        passSizeLabel = [len, wid].filter(Boolean).join(' × ') || '—';
      }

      const checkNameRaw = `${s.checkVarietyBrand ? s.checkVarietyBrand + ' ' : ''}${s.checkVariety || ''}`.trim();
      const checkName = checkNameRaw ? `${checkNameRaw} *` : '';
      const checkYield = (typeof s.checkAvgYield === 'number' && Number.isFinite(s.checkAvgYield))
        ? `${s.checkAvgYield.toFixed(1)} bu/ac`
        : '';
      const checkValue = (checkName || checkYield)
        ? `
          <div>${escapeHtml(checkName || '*')}</div>
          ${checkYield ? `<div class="mh-mobile-sub">${escapeHtml(checkYield)} avg</div>` : ''}
        `
        : '—';

      const top = s.topVariety;
      let topValue = '—';
      if (top) {
        const name = [top.brand, top.variety].filter(Boolean).join(' ');
        const nameMarked = name + (top.isCheck ? ' *' : '');
        const y = (typeof top.yieldBuAc === 'number' && Number.isFinite(top.yieldBuAc))
          ? `${top.yieldBuAc.toFixed(1)} bu/ac`
          : '';
        topValue = `
          <div>${escapeHtml(nameMarked || '(Top yielder)')}</div>
          ${y ? `<div class="mh-mobile-sub">${escapeHtml(y)}</div>` : ''}
        `;
      }

      const sw = s.strongestWinner;
      let swValue = '—';
      if (sw) {
        const name = [sw.brand, sw.variety].filter(Boolean).join(' ');
        const pct = (typeof sw.pctVsCheck === 'number' && Number.isFinite(sw.pctVsCheck))
          ? `${sw.pctVsCheck.toFixed(1)}% vs check`
          : '';
        swValue = `
          <div>${escapeHtml(name || '(Strongest winner)')}</div>
          ${pct ? `<div class="mh-mobile-sub">${escapeHtml(pct)}</div>` : ''}
        `;
      }

      container.innerHTML = `
        <div class="mh-mobile-tile">
          <div class="mh-mobile-label">Farm / field</div>
          <div class="mh-mobile-value">${escapeHtml(farmField)}</div>
        </div>

        <div class="mh-mobile-tile">
          <div class="mh-mobile-label">Varieties in plot</div>
          <div class="mh-mobile-value">${escapeHtml(varietiesLabel)}</div>
        </div>

        <div class="mh-mobile-tile">
          <div class="mh-mobile-label">Plant date</div>
          <div class="mh-mobile-value">${plantDateLabel ? escapeHtml(plantDateLabel) : '—'}</div>
        </div>

        <div class="mh-mobile-tile">
          <div class="mh-mobile-label">Pass size</div>
          <div class="mh-mobile-value">${escapeHtml(passSizeLabel)}</div>
        </div>

        <div class="mh-mobile-tile">
          <div class="mh-mobile-label">Check variety</div>
          <div class="mh-mobile-value">${checkValue}</div>
        </div>

        <div class="mh-mobile-tile">
          <div class="mh-mobile-label">Top yielder</div>
          <div class="mh-mobile-value">${topValue}</div>
        </div>

        <div class="mh-mobile-tile">
          <div class="mh-mobile-label">Strongest winner</div>
          <div class="mh-mobile-value">${swValue}</div>
        </div>
      `;
    }

    async function getProductMeta(productId){
      if (!productId) return null;
      if (productMetaCache.has(productId)) {
        return productMetaCache.get(productId);
      }
      try{
        const ref = doc(STATE.db, 'productsSeed', productId);
        const snap = await getDoc(ref);
        const d = snap.exists() ? (snap.data() || {}) : {};
        const meta = {
          trait: d.trait || '',
          traitLabel: d.traitLabel || ''
        };
        productMetaCache.set(productId, meta);
        return meta;
      }catch(e){
        console.warn('[mh-scoreboard] failed to load product meta', productId, e);
        productMetaCache.set(productId, null);
        return null;
      }
    }

    async function loadMhScoreboardRows(){
      const db = STATE.db;
      if(!db) return;

      STATE.rows = [];
      STATE.summary = createEmptySummary();

      const yearFilter = STATE.filters.year ? Number(STATE.filters.year) : null;
      const trialId    = STATE.filters.trialId;

      if(!yearFilter || !trialId){
        updateMeta();
        renderSummaryCard();
        kickOffAiSummary();
        return;
      }

      const trialRef  = doc(db, 'fieldTrials', trialId);
      const trialSnap = await getDoc(trialRef);
      if (!trialSnap.exists()) {
        console.warn('[MH Scoreboard] selected trial not found:', trialId);
        updateMeta();
        renderSummaryCard();
        kickOffAiSummary();
        return;
      }

      const tData = trialSnap.data() || {};

      if ((tData.seedTrialType || '').toString() !== 'Multiple Hybrid Trial') {
        console.warn('[MH Scoreboard] selected trial is not Multiple Hybrid Trial');
        updateMeta();
        renderSummaryCard();
        kickOffAiSummary();
        return;
      }

      if (yearFilter && Number(tData.cropYear) !== yearFilter) {
        console.warn('[MH Scoreboard] selected trial cropYear mismatch year filter');
        updateMeta();
        renderSummaryCard();
        kickOffAiSummary();
        return;
      }

      const st = (tData.status || '').toString().toLowerCase();
      if (st !== 'active' && st !== 'completed' && st !== 'complete') {
        console.warn('[MH Scoreboard] selected trial status not active/completed:', st);
        updateMeta();
        renderSummaryCard();
        kickOffAiSummary();
        return;
      }

      STATE.summary.trialName = tData.trialName || '(Unnamed Variety Plot)';
      STATE.summary.cropYear  = tData.cropYear || String(yearFilter);
      STATE.summary.crop      = tData.crop || tData.cropType || '';
      STATE.summary.status    = tData.status || '';

      if (tData.plantDate && !STATE.summary.plantDate) {
        const d = coerceDate(tData.plantDate);
        if (d) STATE.summary.plantDate = d;
      }

      const fieldsSnap = await getDocs(collection(trialRef, 'fields'));

      const fieldIdsWithData = new Set();
      let totalTestStrips = 0;

      const rows = [];

      let globalCheckSumAll = 0;
      let globalCheckCountAll = 0;
      let primaryCheckBrand = '';
      let primaryCheckVariety = '';

      for (const fieldDoc of fieldsSnap.docs) {
        const fieldData = fieldDoc.data() || {};
        const farmName  = fieldData.farmName  || '';
        const fieldName = fieldData.fieldName || '';

        if (!STATE.summary.farmName) STATE.summary.farmName = farmName;
        if (!STATE.summary.fieldName) STATE.summary.fieldName = fieldName;

        const mhStateRef = doc(fieldDoc.ref, 'multiHybrid', 'state');
        const mhSnap = await getDoc(mhStateRef);
        if (!mhSnap.exists()) continue;

        const mh = mhSnap.data() || {};
        const blocks = Array.isArray(mh.blocks) ? mh.blocks : [];

        if (!STATE.summary.plantDate && mh.plantDate) {
          const d = coerceDate(mh.plantDate);
          if (d) STATE.summary.plantDate = d;
        }
        if (STATE.summary.plotLengthFt == null) {
          const len = mh.passLengthFt ?? mh.plotLengthFt ?? mh.stripLengthFt ?? mh.lengthFt ?? null;
          if (len != null) STATE.summary.plotLengthFt = Number(len);
        }
        if (STATE.summary.plotWidthFt == null) {
          const wid = mh.passWidthFt ?? mh.plotWidthFt ?? mh.stripWidthFt ?? mh.widthFt ?? null;
          if (wid != null) STATE.summary.plotWidthFt = Number(wid);
        }

        const strips = [];

        blocks.forEach((b, idx) => {
          if (!b) return;
          if (b.voided) return;

          const rawYield = b.yieldBuPerAc;
          if (rawYield === null || rawYield === undefined || rawYield === '') return;

          const yieldNum = Number(rawYield);
          if (!Number.isFinite(yieldNum)) return;

          let entryNum;
          if (b.entryNumber !== null && b.entryNumber !== undefined && b.entryNumber !== '') {
            entryNum = Number(b.entryNumber);
          } else if (b.entryNum !== null && b.entryNum !== undefined && b.entryNum !== '') {
            entryNum = Number(b.entryNum);
          } else if (typeof b.rowIndex === 'number') {
            entryNum = b.rowIndex;
          } else {
            entryNum = idx + 1; // 1-based index
          }

          if (!Number.isFinite(entryNum)) {
            entryNum = idx + 1;
          }

          const isCheck = !!b.isCheck;
          const moisture = (typeof b.moisturePct === 'number') ? Number(b.moisturePct) : null;

          if (isCheck && !primaryCheckVariety) {
            primaryCheckBrand = b.brand || '';
            primaryCheckVariety = b.variety || '';
          }

          strips.push({
            entryNum,
            isCheck,
            yieldBuPerAc: yieldNum,
            brand:    b.brand    || '',
            variety:  b.variety  || '',
            trait:    b.trait    || '',
            maturity: b.maturity || '',
            productId: b.productId || null,
            farmName,
            fieldName,
            moisture
          });
        });

        if (!strips.length) continue;

        fieldIdsWithData.add(fieldDoc.id);

        strips.sort((a,b) => a.entryNum - b.entryNum);

        const checks = strips.filter(s => s.isCheck);
        const tests  = strips.filter(s => !s.isCheck);

        totalTestStrips += tests.length;

        if (checks.length) {
          for (const c of checks) {
            globalCheckSumAll += c.yieldBuPerAc || 0;
            globalCheckCountAll += 1;
          }
        }

        let globalCheckAvg = null;
        if (checks.length) {
          const sum = checks.reduce((acc,c) => acc + (c.yieldBuPerAc || 0), 0);
          globalCheckAvg = sum / checks.length;
        }

        for (const s of strips) {
          let pctVsCheck = null;

          if (!s.isCheck && checks.length && globalCheckAvg != null && globalCheckAvg > 0) {
            let leftCheck  = null;
            let rightCheck = null;

            for (const c of checks) {
              if (c.entryNum < s.entryNum) {
                if (!leftCheck || c.entryNum > leftCheck.entryNum) {
                  leftCheck = c;
                }
              } else if (c.entryNum > s.entryNum) {
                if (!rightCheck || c.entryNum < rightCheck.entryNum) {
                  rightCheck = c;
                }
              } else {
                leftCheck = c;
                rightCheck = null;
                break;
              }
            }

            const globalPart = 0.10 * globalCheckAvg;
            let localPart = 0;

            if (leftCheck && rightCheck) {
              const dL = s.entryNum - leftCheck.entryNum;
              const dR = rightCheck.entryNum - s.entryNum;
              const denom = dL + dR;

              if (denom > 0) {
                const weightLeft  = (dR / denom) * 0.90;
                const weightRight = (dL / denom) * 0.90;

                localPart =
                  weightLeft  * leftCheck.yieldBuPerAc +
                  weightRight * rightCheck.yieldBuPerAc;
              }
            } else if (leftCheck || rightCheck) {
              const single = leftCheck || rightCheck;
              localPart = 0.90 * single.yieldBuPerAc;
            }

            const effectiveCheck = globalPart + localPart;

            if (effectiveCheck > 0) {
              pctVsCheck = ((s.yieldBuPerAc - effectiveCheck) / effectiveCheck) * 100;
            }
          } else if (s.isCheck && globalCheckAvg != null && globalCheckAvg > 0) {
            pctVsCheck = 0;
          }

          const farmFieldLabel = [s.farmName, s.fieldName].filter(Boolean).join(' • ');

          rows.push({
            brand:    s.brand,
            variety:  s.variety,
            trait:    s.trait,
            maturity: s.maturity,
            productId: s.productId,
            yieldBuAc: s.yieldBuPerAc,
            pctVsCheck,
            trialName: STATE.summary.trialName,
            farmField: farmFieldLabel,
            isCheck:  s.isCheck,
            entryNumber: s.entryNum,
            rank: null,
            moisture: s.moisture
          });
        }
      }

      // enrich trait from productsSeed if missing
      for (const row of rows) {
        if (!row.trait && row.productId) {
          const meta = await getProductMeta(row.productId);
          if (meta && meta.trait) {
            row.trait = meta.trait;
          }
        }
      }

      // Rank per pass (non-check), by yield
      const sortedForRank = rows
        .filter(r => !r.isCheck && typeof r.yieldBuAc === 'number' && Number.isFinite(r.yieldBuAc))
        .slice()
        .sort((a,b) => (b.yieldBuAc || 0) - (a.yieldBuAc || 0));

      let rankCounter = 1;
      for (const r of sortedForRank) {
        r.rank = rankCounter++;
      }

      // Strongest winner vs check (by %)
      const sortedByPct = rows
        .filter(r => !r.isCheck && typeof r.pctVsCheck === 'number' && Number.isFinite(r.pctVsCheck))
        .slice()
        .sort((a,b) => (b.pctVsCheck || 0) - (a.pctVsCheck || 0));

      if (sortedByPct.length && sortedByPct[0].pctVsCheck > 0) {
        const best = sortedByPct[0];
        STATE.summary.strongestWinner = {
          brand: best.brand,
          variety: best.variety,
          yieldBuAc: best.yieldBuAc,
          pctVsCheck: best.pctVsCheck,
          isCheck: false
        };
      }

      // Fixed display order: by entryNumber only (never by yield)
      rows.sort((a,b) => {
        const aNum = (a.entryNumber != null) ? a.entryNumber : Number.MAX_SAFE_INTEGER;
        const bNum = (b.entryNumber != null) ? b.entryNumber : Number.MAX_SAFE_INTEGER;
        return aNum - bNum;
      });

      STATE.rows = rows;

      STATE.summary.fieldCount   = fieldIdsWithData.size;
      STATE.summary.stripCount   = rows.length;

      const varietySet = new Set();
      rows.forEach(r => {
        if (r.variety) varietySet.add(r.variety);
      });
      STATE.summary.varietyCount = varietySet.size;

      if (globalCheckCountAll > 0) {
        STATE.summary.checkAvgYield = globalCheckSumAll / globalCheckCountAll;
      } else {
        STATE.summary.checkAvgYield = null;
      }

      STATE.summary.checkVarietyBrand = primaryCheckBrand;
      STATE.summary.checkVariety      = primaryCheckVariety;

      if (sortedForRank.length) {
        const top = sortedForRank[0];
        STATE.summary.topVariety = {
          brand: top.brand,
          variety: top.variety,
          yieldBuAc: top.yieldBuAc,
          pctVsCheck: top.pctVsCheck,
          isCheck: top.isCheck
        };
      }

      console.log('[MH Scoreboard] Entry rows:', STATE.rows.length);
      updateMeta();
      renderSummaryCard();
      kickOffAiSummary();
    }

    // helper to tell parent iframe our height when embedded
    function sendEmbedHeight(){
      try{
        if (!(window.parent && window.parent !== window)) return;
        const h = document.documentElement.scrollHeight || document.body.scrollHeight || 0;
        if (!h) return;
        window.parent.postMessage(
          { type: 'fv-scorecard-height', height: h },
          window.location.origin
        );
      }catch(e){
        console.warn('[mh-scoreboard] auto-resize failed', e);
      }
    }

    function renderScoreboardTable(){
      const tbody = $('#mhScoreBody');
      if(!tbody) return;

      const rows = STATE.rows;

      if(!rows.length){
        tbody.innerHTML = `
          <tr class="score-placeholder-row">
            <td colspan="8">
              Select crop year and Variety Plot trial above. Entry rows will appear once strips are available.
            </td>
          </tr>
        `;
        return;
      }

      const nfYield = new Intl.NumberFormat(undefined,{maximumFractionDigits:1});
      const nfPct   = new Intl.NumberFormat(undefined,{maximumFractionDigits:2});

      tbody.innerHTML = rows.map(row => {
        const entryLabel = (row.entryNumber != null)
          ? String(row.entryNumber)
          : '';

        const varietyLabel = escapeHtml(row.variety || '') + (row.isCheck ? ' *' : '');

        const y = (typeof row.yieldBuAc === 'number')
          ? nfYield.format(row.yieldBuAc)
          : '';

        const p = (typeof row.pctVsCheck === 'number')
          ? nfPct.format(row.pctVsCheck) + '%'
          : '';

        let rankText = '';
        if (row.isCheck) {
          rankText = '-';
        } else if (typeof row.rank === 'number' && Number.isFinite(row.rank)) {
          rankText = String(row.rank);
        }

        return `
          <tr>
            <td>${escapeHtml(entryLabel)}</td>
            <td>${escapeHtml(row.brand || '')}</td>
            <td>${varietyLabel}</td>
            <td>${escapeHtml(row.trait || '')}</td>
            <td>${escapeHtml(row.maturity || '')}</td>
            <td class="cell-right">${y}</td>
            <td class="cell-right">${p}</td>
            <td class="cell-right">${escapeHtml(rankText)}</td>
          </tr>
        `;
      }).join('');
    }

    function renderScoreboardMobile(){
      const container = $('#mhScoreMobile');
      if(!container) return;

      const rows = STATE.rows;

      if(!rows.length){
        container.innerHTML = `
          <div class="score-mobile-empty">
            Select crop year and Variety Plot trial above. Entry rows will appear once strips are available.
          </div>
        `;
        return;
      }

      const nfYield = new Intl.NumberFormat(undefined,{maximumFractionDigits:1});
      const nfPct   = new Intl.NumberFormat(undefined,{maximumFractionDigits:2});
      const nfMoist = new Intl.NumberFormat(undefined,{maximumFractionDigits:1});

      container.innerHTML = rows.map(row => {
        const y = (typeof row.yieldBuAc === 'number') ? nfYield.format(row.yieldBuAc) : '—';
        const pctNum = (typeof row.pctVsCheck === 'number') ? row.pctVsCheck : null;
        const pctLabel = pctNum !== null ? nfPct.format(pctNum) + '%' : '—';
        const advClass = pctNum !== null
          ? (pctNum >= 0 ? 'score-card-adv score-card-adv--pos' : 'score-card-adv')
          : 'score-card-adv';

        const advText = pctNum !== null
          ? `${nfPct.format(pctNum)}% vs check`
          : '—';

        const entryLabel = (row.entryNumber != null)
          ? String(row.entryNumber)
          : '—';

        const moistLabel = (typeof row.moisture === 'number' && Number.isFinite(row.moisture))
          ? nfMoist.format(row.moisture) + '%'
          : '—';

        const rankLabel = row.isCheck
          ? '—'
          : (typeof row.rank === 'number' && Number.isFinite(row.rank) ? `#${row.rank}` : '—');

        const parts = [];
        if (row.brand) parts.push(row.brand);
        if (row.variety) parts.push(row.variety);
        let nameLine = parts.join(' ') || '(Variety not set)';
        if (row.trait) nameLine += ' ' + row.trait;
        if (row.isCheck) nameLine += ' *';

        const rmChip = row.maturity
          ? `<span class="score-card-chip">${escapeHtml(row.maturity)} RM</span>`
          : '';

        const typeChip = row.isCheck
          ? `<span class="score-card-chip">Check *</span>`
          : `<span class="score-card-chip">Test</span>`;

        const rankChip = (!row.isCheck && typeof row.rank === 'number' && Number.isFinite(row.rank))
          ? `<span class="score-card-chip">Rank #${row.rank}</span>`
          : '';

        return `
          <article class="score-card">
            <div class="score-card-header">
              <div class="score-card-main">
                <div class="score-card-variety">${escapeHtml(nameLine)}</div>
                <div class="score-card-tags">
                  ${rmChip}
                  ${typeChip}
                  ${rankChip}
                </div>
              </div>
              <div class="${advClass}">${advText}</div>
            </div>

            <div class="score-card-metrics">
              <div class="score-card-metric">
                <span>Moisture</span>
                <strong>${moistLabel}</strong>
              </div>
              <div class="score-card-metric">
                <span>Yield (bu/ac)</span>
                <strong>${y}</strong>
              </div>
              <div class="score-card-metric">
                <span>% vs Check</span>
                <strong>${pctLabel}</strong>
              </div>
              <div class="score-card-metric">
                <span>Rank</span>
                <strong>${rankLabel}</strong>
              </div>
            </div>

            <div class="score-card-footer">
              <span class="score-card-entry">Entry ${escapeHtml(entryLabel)}</span>
            </div>
          </article>
        `;
      }).join('');
    }

    function renderScoreboard(){
      renderScoreboardTable();
      renderScoreboardMobile();
      if (STATE.isEmbed) {
        sendEmbedHeight();
      }
    }

    async function loadCompanyHeader(){
      if(STATE.company) return STATE.company;
      try{
        const [col,id] = CONFIG.COMPANY_DOC_PATH;
        const ref = doc(STATE.db, col, id);
        const snap = await getDoc(ref);
        const d = snap.exists() ? (snap.data() || {}) : {};
        const name = d.name || '';
        const address = [
          d.addressStreet || '',
          [d.addressCity, d.addressState].filter(Boolean).join(', '),
          d.addressZip || ''
        ].filter(Boolean).join(' · ');
        const phone = d.phone || '';
        const email = d.email || '';
        STATE.company = { name, address, phone, email };
      }catch(e){
        console.warn('[mh-scoreboard] failed to load company header', e);
        STATE.company = { name:'', address:'', phone:'', email:'' };
      }
      return STATE.company;
    }

    function buildPrintHtml({ company, runStr, runDateOnly, cropYearLabel, trialLabel, rows }){
      const brandSet = new Set();
      const varietySet = new Set();
      let maxYield = null;

      rows.forEach(r => {
        if(r.brand)   brandSet.add(r.brand);
        if(r.variety) varietySet.add(r.variety);
        if(typeof r.yieldBuAc === 'number'){
          maxYield = (maxYield == null) ? r.yieldBuAc : Math.max(maxYield, r.yieldBuAc);
        }
      });

      const nfYield = new Intl.NumberFormat(undefined,{maximumFractionDigits:1});
      const brandsCount   = brandSet.size;
      const varietiesCount= varietySet.size;
      const topYieldLabel = maxYield == null ? 'N/A' : nfYield.format(maxYield) + ' bu/ac';

      const filterSummary = `${cropYearLabel || '—'} • ${trialLabel || 'Selected MH trial'}`;

      return `<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Multiple Hybrid Trial Scoreboard</title>
  <style>
    :root{
      --fv-green:#3B7E46;
      --fv-border:#D1D5DB;
      --fv-text:#111827;
      --fv-muted:#6B7280;
      --fv-bg:#F3F4F6;
    }
    *{box-sizing:border-box;}
    html,body{
      margin:0;
      padding:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      color:var(--fv-text);
      background:var(--fv-bg);
    }
    body{
      display:flex;
      justify-content:center;
      padding:24px 12px;
    }
    .page{
      width:100%;
      max-width:900px;
      background:#fff;
      border-radius:12px;
      box-shadow:0 10px 30px rgba(15,23,42,0.15);
      padding:24px 28px 28px;
    }
    .report-header{
      display:grid;
      grid-template-columns:auto 1fr auto;
      gap:16px;
      align-items:center;
      border-bottom:2px solid var(--fv-green);
      padding-bottom:14px;
      margin-bottom:18px;
    }
    .report-logo{
      width:64px;
      height:64px;
      border-radius:16px;
      border:1px solid var(--fv-border);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:26px;
      font-weight:800;
      color:#fff;
      background:radial-gradient(circle at 30% 0%, #4CAF50, var(--fv-green));
    }
    .report-logo span{letter-spacing:0.02em;}
    .company-block{min-width:0;}
    .company-name{
      font-size:18px;
      font-weight:800;
      margin:0 0 2px;
    }
    .company-line{
      font-size:12px;
      color:var(--fv-muted);
      margin:0;
    }
    .report-meta-top{
      text-align:right;
      font-size:11px;
      color:var(--fv-muted);
    }
    .report-meta-top strong{color:var(--fv-text);}
    .report-title-block{margin-bottom:16px;}
    .report-title{
      font-size:20px;
      font-weight:800;
      margin:4px 0 4px;
      letter-spacing:0.02em;
      text-transform:uppercase;
    }
    .report-subtitle{
      font-size:13px;
      color:var(--fv-muted);
      margin:0;
    }
    .report-summary-strip{
      margin-top:12px;
      padding:8px 10px;
      border-radius:10px;
      background:linear-gradient(90deg, rgba(59,126,70,0.08), transparent);
      border:1px solid rgba(59,126,70,0.20);
      font-size:11px;
      display:flex;
      flex-wrap:wrap;
      gap:6px 16px;
    }
    .summary-pill{
      display:inline-flex;
      align-items:center;
      gap:4px;
      white-space:nowrap;
    }
    .summary-label{
      text-transform:uppercase;
      letter-spacing:0.08em;
      font-weight:600;
      font-size:10px;
      color:var(--fv-muted);
    }
    .summary-value{
      font-weight:600;
      font-size:11px;
    }
    .section{margin-top:18px;}
    .section-heading-row{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
      margin-bottom:6px;
    }
    .section-title-main{
      font-size:15px;
      font-weight:700;
      letter-spacing:0.03em;
      text-transform:uppercase;
    }
    .section-note{
      font-size:11px;
      color:var(--fv-muted);
    }
    .kpi-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:6px;
    }
    .kpi-card{
      flex:1 1 140px;
      border-radius:10px;
      border:1px solid var(--fv-border);
      padding:8px 10px;
      background:linear-gradient(135deg, rgba(59,126,70,0.06), #ffffff);
    }
    .kpi-label{
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:var(--fv-muted);
      margin-bottom:2px;
    }
    .kpi-value{
      font-size:16px;
      font-weight:800;
    }
    .kpi-footnote{
      font-size:10px;
      color:var(--fv-muted);
      margin-top:2px;
    }
    .section-title{
      font-size:13px;
      text-transform:uppercase;
      letter-spacing:0.12em;
      color:var(--fv-muted);
      margin:0 0 4px;
    }
    .section-body{
      font-size:12px;
      line-height:1.5;
    }
    .table-wrap{
      margin-top:4px;
      border-radius:10px;
      border:1px solid var(--fv-border);
      overflow:hidden;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
    }
    thead{
      background:#F9FAFB;
    }
    th, td{
      padding:6px 8px;
      border-bottom:1px solid #E5E7EB;
      text-align:left;
      vertical-align:top;
      white-space:nowrap;
    }
    th{
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.08em;
      font-size:10px;
      color:#4B5563;
      border-bottom:1px solid #D1D5DB;
    }
    tr:nth-child(even) td{
      background:#F9FAFB;
    }
    .cell-right{text-align:right;}
    .report-footer{
      margin-top:18px;
      padding-top:8px;
      border-top:1px solid var(--fv-border);
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:10px;
      color:var(--fv-muted);
    }
    .footer-left{max-width:60%;}
    .footer-right{text-align:right;}
    @media print{
      html,body{background:#fff;padding:0;}
      body{box-shadow:none;}
      .page{
        max-width:none;
        border-radius:0;
        box-shadow:none;
        padding:12mm 14mm;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="report-header">
      <div class="report-logo">
        <span>DF</span>
      </div>
      <div class="company-block">
        <p class="company-name">${escapeHtml(company.name || '')}</p>
        <p class="company-line">
          ${company.address ? escapeHtml(company.address) + '<br>' : ''}
          ${company.phone ? 'Phone: ' + escapeHtml(company.phone) : ''}${company.phone && company.email ? ' · ' : ''}
          ${company.email ? 'Email: ' + escapeHtml(company.email) : ''}
        </p>
      </div>
      <div class="report-meta-top">
        <div><strong>Multiple Hybrid Trial Scoreboard</strong></div>
        <div>Generated: ${escapeHtml(runStr)}</div>
        <div>Prepared by: ${escapeHtml(company.name || 'FarmVista')}</div>
      </div>
    </header>

    <section class="report-title-block">
      <h1 class="report-title">Multiple Hybrid Trial Scoreboard</h1>
      <p class="report-subtitle">
        Entry-level scoreboard for Multiple Hybrid trials, using MH distance-weighted check math and equal weighting per strip.
      </p>

      <div class="report-summary-strip">
        <div class="summary-pill">
          <span class="summary-label">Crop Year</span>
          <span class="summary-value">${escapeHtml(cropYearLabel || '—')}</span>
        </div>
        <div class="summary-pill">
          <span class="summary-label">Filter</span>
          <span class="summary-value">${escapeHtml(filterSummary)}</span>
        </div>
        <div class="summary-pill">
          <span class="summary-label">Varieties</span>
          <span class="summary-value">${varietiesCount}</span>
        </div>
      </div>
    </section>

    <section class="section">
      <div class="section-heading-row">
        <div class="section-title-main">Key Metrics</div>
        <div class="section-note">Snapshot at the time of report generation.</div>
      </div>
      <div class="kpi-row">
        <div class="kpi-card">
          <div class="kpi-label">Varieties</div>
          <div class="kpi-value">${varietiesCount}</div>
          <div class="kpi-footnote">Unique MH varieties represented</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Brands</div>
          <div class="kpi-value">${brandsCount}</div>
          <div class="kpi-footnote">Unique seed brands</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Top Yield</div>
          <div class="kpi-value">${escapeHtml(topYieldLabel)}</div>
          <div class="kpi-footnote">Highest entry yield (bu/ac)</div>
        </div>
      </div>
    </section>

    <section class="section">
      <h2 class="section-title">Scoreboard Entries</h2>
      <div class="section-body">
        ${rows.length === 0 ? `
          <p>No Multiple Hybrid scoreboard entries for the selected crop year and trial yet.</p>
        ` : `
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th style="width:10%;">Entry #</th>
                  <th style="width:12%;">Brand</th>
                  <th style="width:14%;">Variety</th>
                  <th style="width:10%;">Trait</th>
                  <th style="width:10%;">Maturity</th>
                  <th style="width:10%;">Yield (bu/ac)</th>
                  <th style="width:10%;">% vs Check</th>
                  <th style="width:10%;">Rank</th>
                </tr>
              </thead>
              <tbody>
                ${rows.map(r => {
                  const entryLabel = (r.entryNumber != null) ? String(r.entryNumber) : '';
                  const y = (typeof r.yieldBuAc === 'number') ? nfYield.format(r.yieldBuAc) : '';
                  const p = (typeof r.pctVsCheck === 'number')
                    ? new Intl.NumberFormat(undefined,{maximumFractionDigits:2}).format(r.pctVsCheck) + '%'
                    : '';

                  const rankLabel = r.isCheck
                    ? '-'
                    : (typeof r.rank === 'number' && Number.isFinite(r.rank))
                      ? '#' + r.rank
                      : '';

                  const varietyLabel = (r.variety || '') + (r.isCheck ? ' *' : '');

                  return `
                    <tr>
                      <td>${escapeHtml(entryLabel)}</td>
                      <td>${escapeHtml(r.brand || '')}</td>
                      <td>${escapeHtml(varietyLabel)}</td>
                      <td>${escapeHtml(r.trait || '')}</td>
                      <td>${escapeHtml(r.maturity || '')}</td>
                      <td class="cell-right">${escapeHtml(y)}</td>
                      <td class="cell-right">${escapeHtml(p)}</td>
                      <td class="cell-right">${escapeHtml(rankLabel)}</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        `}
      </div>
    </section>

    <footer class="report-footer">
      <div class="footer-left">
        Internal use only. Multiple Hybrid trial results are preliminary until fully reviewed.
      </div>
      <div class="footer-right">
        FarmVista • Multiple Hybrid Trial Scoreboard • ${escapeHtml(runDateOnly || '')}
      </div>
    </footer>
  </div>
</body>
</html>`;
    }

    async function handlePrintClick(){
      const yearSel   = $('#filterYear');
      const trialSel  = $('#filterTrial');

      const cropYearLabel = yearSel?.value || '';
      const trialLabel = trialSel
        ? (trialSel.options[trialSel.selectedIndex]?.textContent || 'Selected MH trial')
        : 'Selected MH trial';

      const company = await loadCompanyHeader();
      const now = new Date();
      const runStr = formatDateTime(now);
      const runDateOnly = formatDate(now);

      const html = buildPrintHtml({
        company,
        runStr,
        runDateOnly,
        cropYearLabel,
        trialLabel,
        rows: STATE.rows
      });

      let iframe = document.getElementById('fv-print-frame');
      if(!iframe){
        iframe = document.createElement('iframe');
        iframe.id = 'fv-print-frame';
        document.body.appendChild(iframe);
      }

      const win = iframe.contentWindow || iframe.contentDocument;
      const doc = iframe.contentDocument || iframe.contentWindow.document;

      doc.open();
      doc.write(html);
      doc.close();

      setTimeout(() => {
        try{
          win.focus();
          win.print();
        }catch(err){
          console.warn('[mh-scoreboard] iframe print failed, falling back to window.print()', err);
          window.print();
        }
      }, 400);
    }

    async function populateTrialFilterOptions(){
      const trialSel = $('#filterTrial');
      if(!trialSel || !STATE.db) return;

      const db = STATE.db;
      const yearFilter = STATE.filters.year ? Number(STATE.filters.year) : null;

      trialSel.innerHTML = '';

      const trialsSnap = await getDocs(collection(db, 'fieldTrials'));
      const mhTrials = [];

      trialsSnap.forEach(docSnap => {
        const d = docSnap.data() || {};

        if ((d.seedTrialType || '').toString() !== 'Multiple Hybrid Trial') return;
        if (yearFilter && Number(d.cropYear) !== yearFilter) return;

        const st = (d.status || '').toString().toLowerCase();
        if (st !== 'active' && st !== 'completed' && st !== 'complete') return;

        mhTrials.push({
          id: docSnap.id,
          name: d.trialName || '(Unnamed Variety Plot)'
        });
      });

      mhTrials.sort((a,b) => a.name.localeCompare(b.name));

      if (!mhTrials.length) {
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'No Variety Plot trials';
        trialSel.appendChild(opt);
        trialSel.disabled = true;

        STATE.filters.trialId = null;
        STATE.filters.trialName = '';
        STATE.summary = createEmptySummary();
        updateMeta();
        renderSummaryCard();
        kickOffAiSummary();
        return;
      }

      trialSel.disabled = false;

      let selectedId = STATE.filters.trialId;

      if (!selectedId && URL_TRIAL) {
        const hasUrl = mhTrials.find(t => t.id === URL_TRIAL);
        if (hasUrl) selectedId = URL_TRIAL;
      }

      if (!selectedId || !mhTrials.find(t => t.id === selectedId)) {
        selectedId = mhTrials[0].id;
      }

      mhTrials.forEach(t => {
        const opt = document.createElement('option');
        opt.value = t.id;
        opt.textContent = t.name;
        if (t.id === selectedId) opt.selected = true;
        trialSel.appendChild(opt);
      });

      trialSel.value = selectedId;
      STATE.filters.trialId = selectedId;
      STATE.filters.trialName = getSelectedTrialLabel();
    }

    async function initFilters(){
      const yearSel = $('#filterYear');

      if(yearSel){
        const now = new Date();
        const currentYear = now.getFullYear();

        let initialYear = currentYear;
        if (URL_YEAR && /^\d{4}$/.test(URL_YEAR)) {
          initialYear = parseInt(URL_YEAR, 10);
        }

        const years = [initialYear + 1, initialYear, initialYear - 1, initialYear - 2];

        years.forEach(y => {
          const opt = document.createElement('option');
          opt.value = String(y);
          opt.textContent = y;
          if(y === initialYear) opt.selected = true;
          yearSel.appendChild(opt);
        });

        STATE.filters.year = String(initialYear);

        yearSel.addEventListener('change', async () => {
          STATE.filters.year = yearSel.value || null;
          STATE.filters.trialId = null;
          STATE.filters.trialName = '';
          await populateTrialFilterOptions();
          await loadMhScoreboardRows();
          renderScoreboard();
        });
      }

      const trialSel = $('#filterTrial');
      if(trialSel){
        trialSel.addEventListener('change', async () => {
          STATE.filters.trialId = trialSel.value || null;
          STATE.filters.trialName = getSelectedTrialLabel();
          await loadMhScoreboardRows();
          renderScoreboard();
        });
      }

      await populateTrialFilterOptions();
      updateMeta();
      renderSummaryCard();
      kickOffAiSummary();
    }

    function kickOffAiSummary(){
      const container = $('#aiSummary');
      if (!container) return;

      if (!STATE.summary.trialName || !STATE.filters.year || !STATE.filters.trialId) {
        container.innerHTML = '<div class="ai-summary-note">Select crop year and Variety Plot trial to generate a written summary of how each variety performed.</div>';
        return;
      }

      if (!window.FVAiReports) {
        container.innerHTML = '<div class="ai-summary-error">AI helper script is not available. Numeric summary above is still accurate.</div>';
        return;
      }

      const payload = {
        trial: {
          id: STATE.filters.trialId,
          trialName: STATE.summary.trialName,
          cropYear: STATE.summary.cropYear,
          crop: STATE.summary.crop,
          status: STATE.summary.status,
          plantDate: STATE.summary.plantDate,
          plotLengthFt: STATE.summary.plotLengthFt,
          plotWidthFt: STATE.summary.plotWidthFt,
          farmName: STATE.summary.farmName,
          fieldName: STATE.summary.fieldName
        },
        summary: STATE.summary,
        entries: STATE.rows.map(r => ({
          brand: r.brand,
          variety: r.variety,
          trait: r.trait,
          maturity: r.maturity,
          yieldBuAc: r.yieldBuAc,
          pctVsCheck: r.pctVsCheck,
          isCheck: r.isCheck,
          rank: r.rank,
          entryNumber: r.entryNumber,
          moisture: r.moisture
        }))
      };

      if (typeof window.FVAiReports.renderMhPlotSummary === 'function') {
        window.FVAiReports.renderMhPlotSummary(container, payload);
      } else if (typeof window.FVAiReports.renderTrialSummary === 'function') {
        // Fallback to existing helper if you haven't added a dedicated MH one yet
        window.FVAiReports.renderTrialSummary(container, payload);
      } else {
        container.innerHTML = '<div class="ai-summary-error">AI helper is loaded but no renderer is defined for Variety Plot summaries.</div>';
      }
    }

    (async function boot(){
      await ready;
      STATE.db = getFirestore();

      const shell = document.querySelector('fv-shell');
      if(shell) shell.nav = NAV_MENU;

      const backBtn = document.getElementById('btnBack');
      if(backBtn && !STATE.isEmbed){
        backBtn.addEventListener('click', () => {
          location.href = '/Farm-vista/pages/reports/reports-predefined.html';
        });
      }

      const printTop    = $('#btnPrint');
      const printBottom = $('#btnPrintBottom');
      if(printTop && !STATE.isEmbed)    printTop.addEventListener('click', handlePrintClick);
      if(printBottom && !STATE.isEmbed) printBottom.addEventListener('click', handlePrintClick);

      await initFilters();
      await loadMhScoreboardRows();
      renderScoreboard();
    })();

  </script>

</head>

<body>
  <fv-shell>
    <div class="wrap">
      <section class="hero">
        <header class="hero-head">
          <div class="icon" aria-hidden="true">🧬</div>
          <div>
            <h1>Multiple Hybrid Trial Scoreboard</h1>
            <p class="muted">
              Entry-level scoreboard for Multiple Hybrid trials, one row per pass. % vs check uses the Multiple Hybrid global + local distance-weighted check math.
              Varieties marked with * are checks; checks show “-” for rank.
            </p>
          </div>
        </header>

        <div class="body">
          <div class="toolbar">
            <div class="toolbar-left">
              <button id="btnBack" type="button" class="btn btn-quiet">
                ← Back to Reports
              </button>
              <button id="btnPrint" type="button" class="btn btn-primary">
                Print / Save PDF
              </button>
            </div>
            <div class="page-header-meta" id="mhSummaryMeta">
              Choose crop year and Variety Plot trial. Scoreboard will populate once strips are available.
            </div>
          </div>

          <!-- Filters: crop year + Variety Plot trial -->
          <div class="filters" aria-label="Scoreboard filters">
            <div class="filters-row">
              <div class="filter-field">
                <label class="filter-label" for="filterYear">Crop Year</label>
                <select id="filterYear" class="filter-select"></select>
              </div>

              <div class="filter-field filter-field--grow">
                <label class="filter-label" for="filterTrial">Variety Plots</label>
                <select id="filterTrial" class="filter-select"></select>
              </div>
            </div>
          </div>

          <!-- MOBILE: 7-tile summary that replaces hero on phones -->
          <section class="mh-mobile-summary mobile-only" aria-label="Variety Plot mobile summary">
            <div class="mh-mobile-tiles" id="mhMobileTiles">
              <!-- Filled by renderMobileSummaryTiles() -->
            </div>
            <div class="mh-mobile-helper">
              <a href="/Farm-vista/docs/plot-layout.html" class="helper-link">
                Plot layout &amp; weighting guide
              </a>
            </div>
          </section>

          <!-- Variety Plot header card (desktop KPI tiles) -->
          <section class="trial-summary" id="trialSummaryCard">
            <p class="trial-summary-empty">
              Select crop year and Variety Plot trial to see a variety scoreboard summary.
            </p>
          </section>

          <!-- AI Plot Summary -->
          <section class="ai-card" aria-label="AI summary of this Variety Plot" aria-live="polite">
            <div class="ai-card-title">
              <span>Plot Summary</span>
              <span class="ai-chip">AI Summary</span>
            </div>
            <div id="aiSummary" class="ai-summary-body">
              <div class="ai-summary-note">
                Select crop year and Variety Plot trial to generate a written summary of how each variety performed against the check.
              </div>
            </div>
          </section>

          <!-- Scoreboard -->
          <section class="scorecard" aria-label="Multiple Hybrid trial scoreboard">
            <div class="scorecard-note">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <circle cx="12" cy="12" r="10" fill="none" stroke="currentColor" stroke-width="1.4" />
                <path d="M11.2 7.2h1.6v1.6h-1.6V7.2Zm0 3.2h1.6v6.4h-1.6v-6.4Z" fill="currentColor"/>
              </svg>
              Each entry number is its own pass (including checks). Rank is based on yield for tests only; checks always show “-” for rank.
            </div>

            <!-- Desktop table -->
            <div class="score-table-wrap desktop-only">
              <table class="score-table">
                <thead>
                  <tr>
                    <th style="width:80px;">Entry #</th>
                    <th>Brand</th>
                    <th>Variety</th>
                    <th>Trait</th>
                    <th>Maturity</th>
                    <th class="cell-right">Yield (bu/ac)</th>
                    <th class="cell-right">% vs Check</th>
                    <th class="cell-right">Rank</th>
                  </tr>
                </thead>
                <tbody id="mhScoreBody">
                  <tr class="score-placeholder-row">
                    <td colspan="8">
                      Select crop year and Variety Plot trial above. Entry rows will appear once strips are available.
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Mobile stacked cards -->
            <div class="mobile-only">
              <div id="mhScoreMobile" class="score-mobile-list"></div>
            </div>
          </section>

          <div class="bottom-actions">
            <button id="btnPrintBottom" type="button" class="btn btn-primary">
              Print / Save PDF
            </button>
          </div>
        </div>
      </section>
    </div>

    <iframe id="fv-print-frame"></iframe>
  </fv-shell>
</body>
</html>
