<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FarmVista ‚Ä¢ Fields in Active Trials</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#3B7E46" />

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest" />
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png" />
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png" />
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css" />
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css" />

  <style>
    :root{
      --card-max: 1200px;
      --page-bottom-gap: 72px;
      --accent: #2F6C3C;
    }

    body{
      background: var(--app-bg, var(--surface));
    }

    .wrap{
      max-width: var(--card-max);
      margin: 0 auto;
      padding: clamp(14px,3vw,22px);
      padding-bottom: calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + var(--page-bottom-gap)) !important;
      box-sizing:border-box;
    }

    .hero{
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));
      overflow:visible;
    }
    .hero-head{
      display:grid;
      grid-template-columns:36px 1fr;
      gap:12px;
      align-items:center;
      padding:14px 16px;
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);
      border-bottom:1px solid var(--border);
    }
    .hero-head .icon{
      width:24px;
      height:24px;
      color:var(--accent);
      display:grid;
      place-items:center;
    }
    .hero-head h1{
      margin:0;
      font-size:clamp(20px,3.2vw,26px);
      line-height:1.2;
    }
    .muted{ color:var(--muted,#67706B); }

    .body{
      padding:16px;
      display:grid;
      gap:14px;
    }

    /* Toolbar + back / print buttons */
    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:flex-end;
      justify-content:space-between;
    }
    .toolbar-left{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:120px;
      padding:10px 14px;
      border-radius:12px;
      border:1px solid var(--border);
      font-weight:800;
      text-decoration:none;
      cursor:pointer;
      user-select:none;
      color:var(--text) !important;
      background:var(--card-surface,var(--surface));
      font-size:0.9rem;
      gap:6px;
    }
    .btn-quiet{
      min-width:auto;
      padding-inline:10px;
    }
    .btn-primary{
      border-color:transparent;
      background:#2F6C3C;
      color:#fff !important;
    }

    .page-header-meta{
      font-size:0.9rem;
      opacity:0.8;
    }

    /* Trial list */
    .wo-list {
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:8px;
    }

    .wo-empty {
      padding:14px 16px;
      border-radius:12px;
      border:1px dashed var(--border);
      background:var(--card-surface, var(--surface));
      font-size:0.95rem;
      opacity:0.9;
    }

    .wo-card {
      position:relative;
      border-radius:10px;
      border:1px solid var(--card-border, var(--border));
      background:var(--card-surface, var(--surface));
      box-shadow:var(--shadow-soft, var(--shadow));
      padding:12px 14px 10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .wo-row-top {
      display:flex;
      align-items:flex-start;
      gap:10px;
    }

    .wo-main {
      flex:1 1 auto;
      min-width:0;
    }

    .wo-title {
      font-weight:700;
      font-size:0.98rem;
      line-height:1.3;
    }

    .wo-sub {
      font-size:0.86rem;
      opacity:0.9;
      margin-top:2px;
    }

    .wo-meta {
      display:flex;
      flex-wrap:wrap;
      gap:6px 10px;
      margin-top:4px;
      font-size:0.8rem;
      opacity:0.85;
    }

    .wo-meta span {
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 7px;
      border-radius:999px;
      background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
    }

    .wo-meta-label {
      font-weight:600;
    }

    /* Farms + fields inside a trial */
    .farm-fields-block{
      margin-top:2px;
      padding-top:4px;
      border-top:1px solid var(--border);
      font-size:0.9rem;
    }
    .farm-fields-title{
      font-size:0.8rem;
      text-transform:uppercase;
      letter-spacing:0.06em;
      opacity:0.7;
      margin-bottom:4px;
    }

    .farm-group{
      margin-top:6px;
    }
    .farm-group-title{
      font-weight:600;
      font-size:0.9rem;
      margin:2px 0 4px;
    }

    .farm-table-wrap{
      border-radius:10px;
      border:1px solid var(--border);
      overflow:hidden;
    }
    table.farm-table{
      width:100%;
      border-collapse:collapse;
      font-size:0.82rem;
    }
    table.farm-table thead{
      background:var(--surface-alt,#F9FAFB);
    }
    table.farm-table th,
    table.farm-table td{
      padding:6px 8px;
      border-bottom:1px solid var(--border-subtle,#E5E7EB);
      text-align:left;
      vertical-align:top;
    }
    table.farm-table th{
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.06em;
      font-size:0.72rem;
      color:var(--muted,#4B5563);
    }
    table.farm-table tr:nth-child(even) td{
      background:var(--surface-subtle,#F9FAFB);
    }

    .yield-chip{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 7px;
      border-radius:999px;
      background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
      font-size:0.78rem;
      white-space:nowrap;
    }

    .yield-chip--no{
      background:color-mix(in srgb, var(--surface) 80%, var(--border) 20%);
      opacity:0.9;
    }

    /* Overlap section */
    .overlap-section{
      margin-top:18px;
      padding:12px 14px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--card-surface,var(--surface));
      box-shadow:var(--shadow-soft,var(--shadow));
    }
    .overlap-title{
      margin:0;
      font-size:0.96rem;
      font-weight:700;
    }
    .overlap-sub{
      margin:2px 0 8px;
      font-size:0.85rem;
      opacity:0.9;
    }
    .overlap-empty{
      font-size:0.85rem;
      opacity:0.9;
    }
    .overlap-list{
      margin:0;
      padding-left:18px;
      font-size:0.85rem;
    }
    .overlap-list li{
      margin:3px 0;
    }

    .bottom-actions{
      margin-top:16px;
      display:flex;
      justify-content:flex-end;
    }

    #fv-print-frame{
      position:fixed;
      right:0;
      bottom:0;
      width:0;
      height:0;
      border:0;
      visibility:hidden;
    }
  </style>

  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true;
        document.head.appendChild(s);
      }
    })();
  </script>

  <script type="module">
    import {
      ready,
      getFirestore,
      collection,
      getDocs,
      query,
      where,
      doc,
      getDoc
    } from '/Farm-vista/js/firebase-init.js';

    import { NAV_MENU } from '/Farm-vista/js/menu.js';

    const CONFIG = {
      TRIAL_COLLECTION: 'fieldTrials',
      COMPANY_DOC_PATH: ['company','main']
    };

    const $  = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    const STATE = {
      db: null,
      trials: [],       // [{id, trialName, trialType, crop, cropYear, opTask, treatment, farms:[{id,name,fields:[]}]}]
      totals: {
        trials: 0,
        fields: 0,
        farms: 0,
        fieldsWithYield: 0,
        fieldsNoYield: 0
      },
      overlaps: [],     // [{farmId,farmName,trials:[{id,name,crop,cropYear}]}]
      company: null
    };

    function escapeHtml(str){
      return String(str || '').replace(/[&<>"']/g, m => (
        { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]
      ));
    }

    function formatInt(n){
      const num = Number(n);
      if(!Number.isFinite(num)) return '0';
      return num.toLocaleString();
    }

    function formatDecimal(n, digits=1){
      const num = Number(n);
      if(!Number.isFinite(num)) return '';
      return num.toLocaleString(undefined, { maximumFractionDigits:digits, minimumFractionDigits:digits });
    }

    function extractYieldValue(blockData){
      if(blockData && typeof blockData === 'object'){
        const cand = ['yieldBpa','yieldBuPerAcre','yield','bpa'];
        for(const key of cand){
          if(typeof blockData[key] === 'number' && Number.isFinite(blockData[key])){
            return blockData[key];
          }
        }
      }
      return null;
    }

    async function loadCompanyHeader(){
      if(STATE.company) return STATE.company;
      try{
        const [col,id] = CONFIG.COMPANY_DOC_PATH;
        const ref = doc(STATE.db, col, id);
        const snap = await getDoc(ref);
        const d = snap.exists() ? (snap.data() || {}) : {};
        const name = d.name || '';
        const address = [
          d.addressStreet || '',
          [d.addressCity, d.addressState].filter(Boolean).join(', '),
          d.addressZip || ''
        ].filter(Boolean).join(' ¬∑ ');
        const phone = d.phone || '';
        const email = d.email || '';
        STATE.company = { name, address, phone, email };
      }catch(e){
        console.warn('[active-trials] failed to load company header', e);
        STATE.company = { name:'', address:'', phone:'', email:'' };
      }
      return STATE.company;
    }

    async function loadData(){
      const db = STATE.db;
      const trials = [];
      const totals = {
        trials: 0,
        fields: 0,
        farms: 0,
        fieldsWithYield: 0,
        fieldsNoYield: 0
      };

      const globalFarmIds = new Set();
      const globalFarmTrials = new Map(); // farmId -> {id,name,trialInfos: Map(trialId -> {id,name,crop,cropYear})}

      const trialsSnap = await getDocs(
        query(
          collection(db, CONFIG.TRIAL_COLLECTION),
          where('status','==','active')
        )
      );

      if(trialsSnap.empty){
        return { trials:[], totals, overlaps:[] };
      }

      for(const trialDoc of trialsSnap.docs){
        const tData = trialDoc.data() || {};
        const trialId = trialDoc.id;

        const trialName = tData.trialName || 'Unnamed trial';
        const trialType = tData.trialType || '';
        const crop      = tData.crop || '';
        const cropYear  = tData.cropYear || '';
        const opTask    = tData.operationTask || '';
        const treatment = tData.treatmentProduct || tData.treatment || '';

        const fieldsSnap = await getDocs(
          collection(db, CONFIG.TRIAL_COLLECTION, trialId, 'fields')
        );

        const farmMap = new Map();
        let trialFieldCount = 0;
        let trialFieldsWithYield = 0;

        for(const fieldDoc of fieldsSnap.docs){
          const fData = fieldDoc.data() || {};
          const fieldId   = fieldDoc.id;
          const farmId    = fData.farmId || '__unknown__';
          const farmName  = fData.farmName || 'Unknown farm';
          const fieldName = fData.fieldName || fData.name || 'Unnamed field';
          const tillable  = fData.tillable ?? fData.tillableAcres ?? null;
          const trialAc   = fData.trialAcres ?? null;

          // yieldBlocks
          const ySnap = await getDocs(
            collection(db, CONFIG.TRIAL_COLLECTION, trialId, 'fields', fieldId, 'yieldBlocks')
          );

          const blockCount = ySnap.size || 0;
          let yieldVals = [];

          ySnap.forEach(docSnap => {
            const yData = docSnap.data() || {};
            const val = extractYieldValue(yData);
            if(val !== null) yieldVals.push(Number(val));
          });

          let yieldSummary = {
            hasBlocks: blockCount > 0,
            hasYield: false,
            blockCount,
            avg: null,
            min: null,
            max: null
          };

          if(yieldVals.length){
            const sum = yieldVals.reduce((s,v)=>s+v,0);
            const avg = sum / yieldVals.length;
            const min = Math.min(...yieldVals);
            const max = Math.max(...yieldVals);
            yieldSummary = {
              hasBlocks: true,
              hasYield: true,
              blockCount,
              avg,
              min,
              max
            };
            trialFieldsWithYield++;
          }

          trialFieldCount++;

          if(!farmMap.has(farmId)){
            farmMap.set(farmId, {
              id: farmId,
              name: farmName,
              fields: []
            });
          }

          farmMap.get(farmId).fields.push({
            trialId,
            trialName,
            trialType,
            crop,
            cropYear,
            opTask,
            treatment,
            fieldId,
            fieldName,
            tillable,
            trialAc,
            yieldSummary
          });

          // global farm / trial tracking for overlap summary
          globalFarmIds.add(farmId);
          if(!globalFarmTrials.has(farmId)){
            globalFarmTrials.set(farmId, {
              id: farmId,
              name: farmName,
              trialInfos: new Map()
            });
          }
          const gf = globalFarmTrials.get(farmId);
          if(!gf.trialInfos.has(trialId)){
            gf.trialInfos.set(trialId, {
              id: trialId,
              name: trialName,
              crop,
              cropYear
            });
          }
        }

        const farmsArr = Array.from(farmMap.values())
          .map(f => ({
            ...f,
            fields: f.fields.slice().sort((a,b)=> (a.fieldName || '').localeCompare(b.fieldName || ''))
          }))
          .sort((a,b)=> (a.name || '').localeCompare(b.name || ''));

        totals.fields += trialFieldCount;
        totals.fieldsWithYield += trialFieldsWithYield;

        trials.push({
          id: trialId,
          trialName,
          trialType,
          crop,
          cropYear,
          opTask,
          treatment,
          farms: farmsArr,
          summary: {
            fields: trialFieldCount,
            farms: farmsArr.length,
            fieldsWithYield: trialFieldsWithYield
          }
        });
      }

      totals.trials = trials.length;
      totals.farms = globalFarmIds.size;
      totals.fieldsNoYield = totals.fields - totals.fieldsWithYield;

      // Overlaps: farms that appear in more than one active trial
      const overlaps = Array.from(globalFarmTrials.values())
        .filter(g => g.trialInfos.size > 1)
        .map(g => ({
          farmId: g.id,
          farmName: g.name,
          trials: Array.from(g.trialInfos.values())
            .sort((a,b)=> (a.name || '').localeCompare(b.name || ''))
        }))
        .sort((a,b)=> (a.farmName || '').localeCompare(b.farmName || ''));

      return { trials, totals, overlaps };
    }

    function finalizeState({ trials, totals, overlaps }){
      STATE.trials   = trials || [];
      STATE.totals   = totals || STATE.totals;
      STATE.overlaps = overlaps || [];
    }

    function renderList(){
      const listEl  = $('.wo-list');
      const emptyEl = $('.wo-empty');
      const metaEl  = $('#reportMeta');

      listEl.innerHTML = '';

      if(!STATE.trials.length){
        emptyEl.style.display = 'block';
        emptyEl.textContent = 'No fields are currently in active trials.';
        if(metaEl){
          metaEl.textContent = '0 fields in active trials';
        }
        return;
      }

      emptyEl.style.display = 'none';

      const { trials, fields, farms, fieldsWithYield, fieldsNoYield } = STATE.totals;

      if(metaEl){
        metaEl.textContent = `${formatInt(fields)} field${fields===1?'':'s'} ‚Ä¢ ${formatInt(farms)} farm${farms===1?'':'s'} ‚Ä¢ ${formatInt(trials)} active trial${trials===1?'':'s'} (${formatInt(fieldsWithYield)} with yield, ${formatInt(fieldsNoYield)} without)`;
      }

      for(const trial of STATE.trials){
        const card = document.createElement('article');
        card.className = 'wo-card';

        const cropBits = [];
        if(trial.crop) cropBits.push(trial.crop);
        if(trial.cropYear) cropBits.push(trial.cropYear);
        const cropText = cropBits.join(' ¬∑ ');

        const subBits = [];
        if(trial.trialType) subBits.push(trial.trialType);
        if(trial.opTask)   subBits.push(trial.opTask);
        if(trial.treatment) subBits.push(trial.treatment);
        const subText = subBits.join(' ¬∑ ');

        const { fields: fieldCount, farms: farmCount, fieldsWithYield } = trial.summary;

        card.innerHTML = `
          <div class="wo-row-top">
            <div class="wo-main">
              <div class="wo-title">${escapeHtml(trial.trialName || 'Unnamed trial')}</div>
              <div class="wo-sub">
                ${escapeHtml(cropText || '')}
                ${subText ? ` ¬∑ ${escapeHtml(subText)}` : ''}
              </div>
              <div class="wo-meta">
                <span><span class="wo-meta-label">Fields</span> ${fieldCount}</span>
                <span><span class="wo-meta-label">Farms</span> ${farmCount}</span>
                <span><span class="wo-meta-label">With yield</span> ${fieldsWithYield}</span>
              </div>
            </div>
          </div>
        `;

        const block = document.createElement('div');
        block.className = 'farm-fields-block';
        block.innerHTML = `
          <div class="farm-fields-title">Farms &amp; fields in this trial</div>
        `;

        trial.farms.forEach(farm => {
          const farmDiv = document.createElement('div');
          farmDiv.className = 'farm-group';

          const fieldRows = farm.fields.map(fd => {
            const y = fd.yieldSummary || {};
            let yieldText = '';
            if(y.hasYield){
              yieldText = `
                <span class="yield-chip">
                  ${formatDecimal(y.avg,1)} bu/ac
                </span><br>
                <span style="font-size:.75rem;opacity:.9;">
                  ${y.blockCount} blk ¬∑ range ${formatDecimal(y.min,1)}‚Äì${formatDecimal(y.max,1)}
                </span>
              `;
            }else if(y.hasBlocks){
              yieldText = `
                <span class="yield-chip yield-chip--no">
                  ${y.blockCount} block${y.blockCount===1?'':'s'} (yield not set)
                </span>
              `;
            }else{
              yieldText = `
                <span class="yield-chip yield-chip--no">
                  No yield data
                </span>
              `;
            }

            const acPieces = [];
            if(fd.trialAc != null){
              acPieces.push(`${formatDecimal(fd.trialAc,1)} ac`);
            }
            if(fd.tillable != null){
              acPieces.push(`${formatDecimal(fd.tillable,1)} tillable`);
            }
            const acText = acPieces.join(' / ') || '';

            return `
              <tr>
                <td>${escapeHtml(fd.fieldName || '')}</td>
                <td>${escapeHtml(acText)}</td>
                <td>${yieldText}</td>
              </tr>
            `;
          }).join('');

          farmDiv.innerHTML = `
            <div class="farm-group-title">${escapeHtml(farm.name || 'Unknown farm')}</div>
            <div class="farm-table-wrap">
              <table class="farm-table">
                <thead>
                  <tr>
                    <th style="width:40%">Field</th>
                    <th style="width:30%">Trial ac / Tillable</th>
                    <th style="width:30%">Yield summary</th>
                  </tr>
                </thead>
                <tbody>
                  ${fieldRows}
                </tbody>
              </table>
            </div>
          `;

          block.appendChild(farmDiv);
        });

        card.appendChild(block);
        listEl.appendChild(card);
      }
    }

    function renderOverlaps(){
      const listEl  = $('#overlapList');
      const emptyEl = $('#overlapEmpty');

      if(!listEl || !emptyEl) return;

      listEl.innerHTML = '';

      if(!STATE.overlaps.length){
        emptyEl.style.display = 'block';
        emptyEl.textContent = 'No farms are currently in more than one active trial.';
        return;
      }

      emptyEl.style.display = 'none';

      STATE.overlaps.forEach(entry => {
        const li = document.createElement('li');
        const count = entry.trials.length;
        const trialsText = entry.trials.map(t => {
          const bits = [t.name];
          const extra = [];
          if(t.crop) extra.push(t.crop);
          if(t.cropYear) extra.push(t.cropYear);
          const sub = extra.join(' ¬∑ ');
          if(sub) bits.push(`(${sub})`);
          return bits.filter(Boolean).join(' ');
        }).join('; ');

        li.innerHTML = `
          <strong>${escapeHtml(entry.farmName || 'Unknown farm')}</strong>
          ‚Äì ${count} active trials:
          ${escapeHtml(trialsText)}
        `;
        listEl.appendChild(li);
      });
    }

    function buildPrintHtml({ company, runStr, runDateOnly }){
      const trials   = STATE.trials   || [];
      const overlaps = STATE.overlaps || [];
      const { trials:trialCount, fields, farms, fieldsWithYield, fieldsNoYield } = STATE.totals;

      return `<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Fields in Active Trials</title>
  <style>
    :root{
      --fv-green:#3B7E46;
      --fv-border:#D1D5DB;
      --fv-text:#111827;
      --fv-muted:#6B7280;
      --fv-bg:#F3F4F6;
    }
    *{box-sizing:border-box;}
    html,body{
      margin:0;
      padding:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      color:var(--fv-text);
      background:var(--fv-bg);
    }
    body{
      display:flex;
      justify-content:center;
      padding:24px 12px;
    }
    .page{
      width:100%;
      max-width:900px;
      background:#fff;
      border-radius:12px;
      box-shadow:0 10px 30px rgba(15,23,42,0.15);
      padding:24px 28px 28px;
    }
    .report-header{
      display:grid;
      grid-template-columns:auto 1fr auto;
      gap:16px;
      align-items:center;
      border-bottom:2px solid var(--fv-green);
      padding-bottom:14px;
      margin-bottom:18px;
    }
    .report-logo{
      width:64px;
      height:64px;
      border-radius:16px;
      border:1px solid var(--fv-border);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:26px;
      font-weight:800;
      color:#fff;
      background:radial-gradient(circle at 30% 0%, #4CAF50, var(--fv-green));
    }
    .report-logo span{letter-spacing:0.02em;}
    .company-block{min-width:0;}
    .company-name{
      font-size:18px;
      font-weight:800;
      margin:0 0 2px;
    }
    .company-line{
      font-size:12px;
      color:var(--fv-muted);
      margin:0;
    }
    .report-meta-top{
      text-align:right;
      font-size:11px;
      color:var(--fv-muted);
    }
    .report-meta-top strong{color:var(--fv-text);}
    .report-title{
      font-size:20px;
      font-weight:800;
      margin:12px 0 4px;
      letter-spacing:0.02em;
      text-transform:uppercase;
    }
    .report-subtitle{
      font-size:13px;
      color:var(--fv-muted);
      margin:0 0 10px;
    }
    .summary-strip{
      display:flex;
      flex-wrap:wrap;
      gap:6px 14px;
      margin-top:4px;
      padding:8px 10px;
      border-radius:10px;
      background:linear-gradient(90deg, rgba(59,126,70,0.08), transparent);
      border:1px solid rgba(59,126,70,0.2);
      font-size:11px;
    }
    .summary-pill{
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .summary-label{
      text-transform:uppercase;
      letter-spacing:.08em;
      font-size:10px;
      color:var(--fv-muted);
    }
    .summary-value{
      font-weight:600;
    }
    .trial-block{
      margin-top:14px;
      page-break-inside:avoid;
    }
    .trial-title{
      font-size:14px;
      font-weight:700;
      margin:0 0 2px;
    }
    .trial-sub{
      font-size:11px;
      color:var(--fv-muted);
      margin:0 0 6px;
    }
    .farm-title{
      font-size:12px;
      font-weight:600;
      margin:4px 0 2px;
    }
    .table-wrap{
      border-radius:10px;
      border:1px solid var(--fv-border);
      overflow:hidden;
      margin-bottom:4px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
    }
    thead{
      background:#F9FAFB;
    }
    th,td{
      padding:6px 8px;
      border-bottom:1px solid #E5E7EB;
      text-align:left;
      vertical-align:top;
    }
    th{
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.08em;
      font-size:10px;
      color:#4B5563;
      border-bottom:1px solid #D1D5DB;
    }
    tr:nth-child(even) td{
      background:#F9FAFB;
    }
    .overlap-section{
      margin-top:16px;
      padding-top:8px;
      border-top:1px solid #D1D5DB;
    }
    .overlap-title{
      font-size:13px;
      font-weight:700;
      margin:0 0 4px;
    }
    .overlap-note{
      font-size:11px;
      color:#6B7280;
      margin:0 0 4px;
    }
    .report-footer{
      margin-top:18px;
      padding-top:8px;
      border-top:1px solid #D1D5DB;
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:10px;
      color:#6B7280;
    }
    @media print{
      html,body{background:#fff;padding:0;}
      body{box-shadow:none;}
      .page{
        max-width:none;
        border-radius:0;
        box-shadow:none;
        padding:12mm 14mm;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="report-header">
      <div class="report-logo"><span>DF</span></div>
      <div class="company-block">
        <p class="company-name">${escapeHtml(company.name || '')}</p>
        <p class="company-line">
          ${company.address ? escapeHtml(company.address) + '<br>' : ''}
          ${company.phone ? 'Phone: ' + escapeHtml(company.phone) : ''}${company.phone && company.email ? ' ¬∑ ' : ''}
          ${company.email ? 'Email: ' + escapeHtml(company.email) : ''}
        </p>
      </div>
      <div class="report-meta-top">
        <div><strong>Fields in Active Trials</strong></div>
        <div>Generated: ${escapeHtml(runStr)}</div>
        <div>Prepared by: ${escapeHtml(company.name || 'FarmVista')}</div>
      </div>
    </header>

    <h1 class="report-title">Fields in Active Trials</h1>
    <p class="report-subtitle">Trials with participating fields, grouped by trial then farm.</p>

    <div class="summary-strip">
      <div class="summary-pill">
        <span class="summary-label">Trials</span>
        <span class="summary-value">${formatInt(trialCount)}</span>
      </div>
      <div class="summary-pill">
        <span class="summary-label">Farms</span>
        <span class="summary-value">${formatInt(farms)}</span>
      </div>
      <div class="summary-pill">
        <span class="summary-label">Fields</span>
        <span class="summary-value">${formatInt(fields)}</span>
      </div>
      <div class="summary-pill">
        <span class="summary-label">With yield</span>
        <span class="summary-value">${formatInt(fieldsWithYield)}</span>
      </div>
      <div class="summary-pill">
        <span class="summary-label">No yield</span>
        <span class="summary-value">${formatInt(fieldsNoYield)}</span>
      </div>
    </div>

    ${trials.map(trial => {
      const cropBits = [];
      if(trial.crop) cropBits.push(trial.crop);
      if(trial.cropYear) cropBits.push(trial.cropYear);
      const cropText = cropBits.join(' ¬∑ ');

      const subBits = [];
      if(trial.trialType) subBits.push(trial.trialType);
      if(trial.opTask)   subBits.push(trial.opTask);
      if(trial.treatment) subBits.push(trial.treatment);
      const subText = subBits.join(' ¬∑ ');

      const fieldCount = trial.summary.fields;
      const farmCount  = trial.summary.farms;

      const farmsHtml = trial.farms.map(farm => {
        const rows = farm.fields.map(fd => {
          const y = fd.yieldSummary || {};
          let yieldText = '';
          if(y.hasYield){
            yieldText = formatDecimal(y.avg,1) + ' bu/ac (' +
                        y.blockCount + ' blk, ' +
                        formatDecimal(y.min,1) + '‚Äì' + formatDecimal(y.max,1) + ')';
          }else if(y.hasBlocks){
            yieldText = y.blockCount + ' block' + (y.blockCount===1?'':'s') + ', yield not set';
          }else{
            yieldText = 'No yield data';
          }

          const acPieces = [];
          if(fd.trialAc != null) acPieces.push(formatDecimal(fd.trialAc,1) + ' ac');
          if(fd.tillable != null) acPieces.push(formatDecimal(fd.tillable,1) + ' tillable');
          const acText = acPieces.join(' / ');

          return `
            <tr>
              <td>${escapeHtml(fd.fieldName || '')}</td>
              <td>${escapeHtml(acText)}</td>
              <td>${escapeHtml(yieldText)}</td>
            </tr>
          `;
        }).join('');

        return `
          <div class="farm-block">
            <div class="farm-title">${escapeHtml(farm.name || 'Unknown farm')}</div>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th style="width:40%">Field</th>
                    <th style="width:30%">Trial ac / Tillable</th>
                    <th style="width:30%">Yield summary</th>
                  </tr>
                </thead>
                <tbody>
                  ${rows}
                </tbody>
              </table>
            </div>
          </div>
        `;
      }).join('');

      return `
        <section class="trial-block">
          <h2 class="trial-title">${escapeHtml(trial.trialName || 'Unnamed trial')}</h2>
          <p class="trial-sub">
            ${escapeHtml(cropText || '')}
            ${subText ? ' ¬∑ ' + escapeHtml(subText) : ''}
            ¬∑ ${fieldCount} field${fieldCount===1?'':'s'} on ${farmCount} farm${farmCount===1?'':'s'}
          </p>
          ${farmsHtml}
        </section>
      `;
    }).join('')}

    <section class="overlap-section">
      <h2 class="overlap-title">Farms with overlapping trials</h2>
      <p class="overlap-note">Farms that appear in more than one active trial.</p>
      ${overlaps.length === 0
        ? '<p class="overlap-note">No farms are currently enrolled in multiple active trials.</p>'
        : `<ul>${overlaps.map(entry => {
            const count = entry.trials.length;
            const trialsText = entry.trials.map(t => {
              const bits = [t.name];
              const extra = [];
              if(t.crop) extra.push(t.crop);
              if(t.cropYear) extra.push(t.cropYear);
              const sub = extra.join(' ¬∑ ');
              if(sub) bits.push('(' + sub + ')');
              return bits.filter(Boolean).join(' ');
            }).join('; ');
            return `<li><strong>${escapeHtml(entry.farmName || 'Unknown farm')}</strong> ‚Äì ${count} trials: ${escapeHtml(trialsText)}</li>`;
          }).join('')}</ul>`
      }
    </section>

    <footer class="report-footer">
      <div>Internal use only. Yields are summarized from field trial yield blocks at the time of report generation.</div>
      <div>FarmVista ‚Ä¢ Fields in Active Trials ‚Ä¢ ${escapeHtml(runDateOnly || '')}</div>
    </footer>
  </div>
</body>
</html>`;
    }

    async function handlePrintClick(){
      if(!STATE.trials.length){
        alert('No fields in active trials to print.');
        return;
      }

      const company = await loadCompanyHeader();
      const now = new Date();
      const runStr = now.toLocaleString();
      const runDateOnly = now.toLocaleDateString();

      const html = buildPrintHtml({ company, runStr, runDateOnly });

      let iframe = document.getElementById('fv-print-frame');
      if (!iframe){
        iframe = document.createElement('iframe');
        iframe.id = 'fv-print-frame';
        document.body.appendChild(iframe);
      }

      const win = iframe.contentWindow || iframe.contentDocument;
      const doc = iframe.contentDocument || iframe.contentWindow.document;

      doc.open();
      doc.write(html);
      doc.close();

      setTimeout(() => {
        try{
          win.focus();
          win.print();
        }catch(err){
          console.warn('[active-trials-report] iframe print failed, falling back to window.print()', err);
          window.print();
        }
      }, 400);
    }

    (async function boot(){
      await ready;
      STATE.db = getFirestore();

      const shell = document.querySelector('fv-shell');
      if (shell) shell.nav = NAV_MENU;

      const backBtn = document.getElementById('btnBack');
      if(backBtn){
        backBtn.addEventListener('click', () => {
          location.href = '/Farm-vista/pages/reports/reports-predefined.html';
        });
      }

      try{
        const result = await loadData();
        finalizeState(result);
        renderList();
        renderOverlaps();
      }catch(err){
        console.error('Error loading active trial fields:', err);
        const emptyEl = $('.wo-empty');
        emptyEl.style.display = 'block';
        emptyEl.textContent = 'Error loading fields in active trials. Check console or Firestore rules.';
        const metaEl = $('#reportMeta');
        if(metaEl) metaEl.textContent = 'Error loading active trials';
        const overlapEmpty = $('#overlapEmpty');
        if(overlapEmpty){
          overlapEmpty.textContent = 'Error loading overlapping farms.';
        }
      }

      const printTop    = $('#btnPrint');
      const printBottom = $('#btnPrintBottom');
      if (printTop)    printTop.addEventListener('click', handlePrintClick);
      if (printBottom) printBottom.addEventListener('click', handlePrintClick);
    })();
  </script>
</head>

<body>
  <fv-shell>
    <div class="wrap">
      <section class="hero">
        <header class="hero-head">
          <div class="icon" aria-hidden="true">üß™</div>
          <div>
            <h1>Fields in Active Trials</h1>
            <p class="muted">
              Trials with fields currently enrolled, grouped by trial, then farm, then field. Yield summaries use any yield blocks found on the field.
            </p>
          </div>
        </header>

        <div class="body">
          <div class="toolbar">
            <div class="toolbar-left">
              <button id="btnBack" type="button" class="btn btn-quiet">
                ‚Üê Back to Reports
              </button>
              <button id="btnPrint" type="button" class="btn btn-primary">
                Print / Save PDF
              </button>
            </div>
            <div class="page-header-meta" id="reportMeta">
              Loading active trials‚Ä¶
            </div>
          </div>

          <section aria-label="Trials with fields in active trials">
            <div class="wo-empty">
              Loading fields in active trials‚Ä¶
            </div>
            <div class="wo-list"></div>
          </section>

          <section class="overlap-section" aria-label="Farms with overlapping trials">
            <h2 class="overlap-title">Farms with overlapping trials</h2>
            <p class="overlap-sub">Farms that appear in more than one active trial.</p>
            <div id="overlapEmpty" class="overlap-empty">
              Loading overlapping farms‚Ä¶
            </div>
            <ul id="overlapList" class="overlap-list"></ul>
          </section>

          <div class="bottom-actions">
            <button id="btnPrintBottom" type="button" class="btn btn-primary">
              Print / Save PDF
            </button>
          </div>
        </div>
      </section>
    </div>

    <iframe id="fv-print-frame"></iframe>
  </fv-shell>
</body>
</html>
