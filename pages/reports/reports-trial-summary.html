<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FarmVista • Field Trial Yield Summary</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#3B7E46" />

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest" />
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png" />
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png" />
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css" />
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css" />

  <style>
    :root{
      --card-max: 1200px;
      --page-bottom-gap: 56px;
      --accent: #2F6C3C;
    }

    html,
    body{
      margin:0;
      padding:0;
      max-width:100%;
      overflow-x:hidden;
      background: var(--app-bg, var(--surface));
    }

    .wrap{
      max-width: var(--card-max);
      width:100%;
      margin: 0 auto;
      padding: clamp(12px,3vw,20px);
      padding-bottom: calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + var(--page-bottom-gap)) !important;
      box-sizing:border-box;
      overflow-x:hidden;
    }

    .hero{
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));
      overflow:visible;
    }
    .hero-head{
      display:grid;
      grid-template-columns:32px 1fr;
      gap:10px;
      align-items:center;
      padding:12px 14px;
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);
      border-bottom:1px solid var(--border);
    }
    .hero-head .icon{
      width:24px;
      height:24px;
      color:var(--accent);
      display:grid;
      place-items:center;
    }
    .hero-head h1{
      margin:0;
      font-size:clamp(19px,3.2vw,24px);
      line-height:1.2;
    }
    .muted{ color:var(--muted,#67706B); }

    /* On-screen check/trial products line */
    .hero-products{
      margin:2px 0 0;
      font-size:0.82rem;
    }

    .body{
      padding:14px;
      display:grid;
      gap:14px;
    }

    /* Toolbar + back / print buttons */
    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:flex-end;
      justify-content:space-between;
    }
    .toolbar-left{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:120px;
      padding:9px 14px;
      border-radius:12px;
      border:1px solid var(--border);
      font-weight:800;
      text-decoration:none;
      cursor:pointer;
      user-select:none;
      color:var(--text) !important;
      background:var(--card-surface,var(--surface));
      font-size:0.9rem;
      gap:6px;
      white-space:nowrap;
    }
    .btn-quiet{
      min-width:auto;
      padding-inline:10px;
    }
    .btn-primary{
      border-color:transparent;
      background:#2F6C3C;
      color:#fff !important;
    }

    .page-header-meta{
      font-size:0.9rem;
      opacity:0.8;
      text-align:right;
    }

    /* Filters (under Back button) */
    .filters{
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:stretch;
      margin-top:4px;
    }
    .filters-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:flex-end;
    }
    .filter-field{
      display:flex;
      flex-direction:column;
      gap:3px;
      min-width:140px;
      flex:1 1 150px;
      font-size:0.8rem;
    }
    .filter-field--grow{
      flex:2 1 260px;
    }
    .filter-label{
      text-transform:uppercase;
      letter-spacing:0.08em;
      opacity:0.78;
    }
    .filter-select{
      border-radius:999px;
      border:1px solid var(--border);
      padding:6px 10px;
      font-size:0.9rem;
      background:var(--card-surface,var(--surface));
      color:var(--text);
      min-height:32px;
      width:100%;
    }

    /* Stat pills */
    .stats-grid{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:6px;
      font-size:0.82rem;
    }
    .stat-pill{
      display:flex;
      flex-direction:column;
      gap:4px;
      padding:7px 10px;
      border-radius:10px;
      border:1px solid var(--border-subtle,var(--border));
      background:color-mix(in srgb, var(--surface) 82%, var(--border) 18%);
      min-width:120px;
      box-sizing:border-box;
    }
    .stat-label{
      font-size:0.72rem;
      text-transform:uppercase;
      letter-spacing:0.08em;
      opacity:0.75;
    }
    .stat-value{
      font-weight:700;
      font-size:0.94rem;
    }

    /* Grouped KPI tiles */
    .stat-pill-group{
      min-width:220px;
    }
    .stat-group-rows{
      display:flex;
      flex-direction:column;
      gap:2px;
      font-size:0.8rem;
    }
    .stat-group-row{
      display:flex;
      justify-content:space-between;
      gap:6px;
    }
    .stat-group-label{
      opacity:0.8;
    }
    .stat-group-value{
      font-weight:600;
      white-space:nowrap;
    }

    /* AI summary card */
    .ai-card{
      border-radius:12px;
      border:1px solid var(--border-subtle,var(--border));
      background:var(--card-surface,var(--surface));
      padding:12px 14px;
      font-size:0.9rem;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .ai-card-title{
      display:flex;
      align-items:center;
      gap:6px;
      font-weight:700;
      font-size:0.9rem;
    }
    .ai-chip{
      font-size:0.7rem;
      text-transform:uppercase;
      letter-spacing:0.08em;
      padding:3px 7px;
      border-radius:999px;
      border:1px solid var(--border-subtle,var(--border));
      background:color-mix(in srgb, var(--surface) 82%, var(--border) 18%);
    }
    .ai-summary-body{
      font-size:0.88rem;
      line-height:1.4;
    }
    .ai-summary-note{
      font-size:0.76rem;
      opacity:0.7;
    }
    .ai-summary-error{
      font-size:0.86rem;
      color:var(--danger,#A33A3A);
    }

    /* Farms + fields block */
    .farm-fields-block{
      margin-top:2px;
      padding-top:4px;
      border-top:1px solid var(--border);
      font-size:0.9rem;
    }
    .farm-fields-title{
      font-size:0.8rem;
      text-transform:uppercase;
      letter-spacing:0.06em;
      opacity:0.7;
      margin-bottom:4px;
    }

    .farm-group{
      margin-top:6px;
    }
    .farm-group-title{
      font-weight:600;
      font-size:0.9rem;
      margin:2px 0 4px;
    }

    /* Desktop table layout */
    .farm-table-wrap{
      border-radius:10px;
      border:1px solid var(--border);
      overflow-x:auto;
      overflow-y:hidden;
      -webkit-overflow-scrolling:touch;
    }
    table.farm-table{
      width:100%;
      min-width:560px;
      border-collapse:collapse;
      font-size:0.82rem;
    }
    table.farm-table thead{
      background:var(--surface-alt,#F9FAFB);
    }
    table.farm-table th,
    table.farm-table td{
      padding:6px 8px;
      border-bottom:1px solid var(--border-subtle,#E5E7EB);
      text-align:left;
      vertical-align:top;
    }
    table.farm-table th{
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.06em;
      font-size:0.72rem;
      color:var(--muted,#4B5563);
    }
    table.farm-table tr:nth-child(even) td{
      background:var(--surface-subtle,#F9FAFB);
    }
    table.farm-table tbody tr{
      cursor:pointer;
    }
    table.farm-table tbody tr:hover{
      background:color-mix(in srgb, var(--surface) 90%, var(--accent) 10%);
    }

    .field-name-cell{
      font-weight:600;
      font-size:0.84rem;
    }
    .muted-small{
      font-size:0.76rem;
      opacity:0.75;
    }
    .numeric{
      text-align:right;
      white-space:nowrap;
    }

    .adv-pos{
      font-weight:700;
    }
    .adv-pos::before{
      content:"+";
    }
    .adv-neg{
      font-weight:700;
    }

    /* Include column (field checkbox) */
    .include-col{
      text-align:center;
      width:48px;
    }
    .include-cell{
      text-align:center;
    }
    .field-include-toggle{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
    }
    .field-include-toggle input[type="checkbox"]{
      width:14px;
      height:14px;
      margin:0;
      accent-color:var(--accent);
    }

    /* Disabled (excluded) fields */
    .farm-table tbody tr.field-disabled td{
      background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
      opacity:0.6;
    }
    .farm-table tbody tr.field-disabled:hover td{
      background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
    }

    /* Totals footer */
    .totals-card{
      margin-top:10px;
      border-radius:12px;
      border:1px solid var(--border-subtle,var(--border));
      background:var(--card-surface,var(--surface));
      padding:12px 14px;
      font-size:0.86rem;
      display:grid;
      gap:6px;
    }
    .totals-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px 18px;
      align-items:flex-end;
      justify-content:space-between;
    }
    .totals-label{
      font-weight:600;
    }
    .totals-metrics{
      display:flex;
      flex-wrap:wrap;
      gap:10px 14px;
      font-size:0.84rem;
    }
    .totals-metric{
      display:flex;
      flex-direction:column;
      gap:1px;
    }
    .totals-metric span:first-child{
      opacity:0.7;
      font-size:0.78rem;
    }

    /* Empty state + error */
    .wo-empty {
      padding:14px 16px;
      border-radius:12px;
      border:1px dashed var(--border);
      background:var(--card-surface, var(--surface));
      font-size:0.95rem;
      opacity:0.9;
    }
    .error-msg{
      color:var(--danger,#A33A3A);
      font-size:0.9rem;
    }

    .bottom-actions{
      margin-top:16px;
      display:flex;
      justify-content:flex-end;
    }

    /* Modal (field details + shared backdrop) */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.42);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:1400;
    }
    .modal-hidden{
      display:none !important;
    }
    .modal{
      width:min(900px, 94vw);
      max-height:calc(100vh - 80px);
      background:var(--surface);
      border-radius:14px;
      box-shadow:0 18px 40px rgba(0,0,0,.3);
      border:1px solid var(--border);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .modal-head{
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .modal-title-row{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-start;
    }
    .modal-title{
      font-size:1rem;
      font-weight:700;
    }
    .modal-sub{
      font-size:0.82rem;
      opacity:0.8;
    }
    .modal-close-btn{
      border:none;
      background:transparent;
      font-size:1.3rem;
      line-height:1;
      cursor:pointer;
      padding:2px 4px;
      border-radius:999px;
    }
    .modal-body{
      padding:12px 14px 14px;
      overflow:auto;
      display:grid;
      gap:10px;
      font-size:0.86rem;
    }
    .modal-section-title{
      font-size:0.84rem;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.06em;
      opacity:0.8;
      margin-bottom:4px;
    }
    .modal-summary-grid{
      display:flex;
      flex-wrap:wrap;
      gap:10px 16px;
    }
    .modal-summary-item{
      min-width:120px;
    }
    .modal-summary-item span:first-child{
      font-size:0.76rem;
      opacity:0.7;
    }
    .modal-summary-item span:last-child{
      font-weight:600;
    }

    /* Desktop blocks table */
    .blocks-table-wrap{
      border-radius:10px;
      border:1px solid var(--border-subtle,var(--border));
      overflow:hidden;
    }
    table.blocks-table{
      width:100%;
      border-collapse:collapse;
      font-size:0.8rem;
    }
    table.blocks-table th,
    table.blocks-table td{
      padding:6px 8px;
      border-bottom:1px solid color-mix(in srgb, var(--surface) 88%, var(--border) 12%);
      text-align:left;
      vertical-align:top;
    }
    table.blocks-table thead{
      background:color-mix(in srgb, var(--surface) 78%, var(--border) 22%);
    }
    table.blocks-table th{
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.06em;
      font-size:0.74rem;
    }
    table.blocks-table tbody tr:last-child td{
      border-bottom:none;
    }

    /* Mobile block cards */
    .block-card-list{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .block-card{
      border-radius:10px;
      border:1px solid var(--border-subtle,var(--border));
      background:var(--card-surface,var(--surface));
      padding:8px 10px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .block-card-header{
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:flex-start;
      margin-bottom:2px;
    }
    .block-card-title{
      font-size:0.9rem;
      font-weight:600;
    }
    .block-card-type{
      font-size:0.78rem;
      opacity:0.75;
      text-transform:uppercase;
      letter-spacing:0.06em;
    }
    .block-card-main{
      display:flex;
      flex-wrap:wrap;
      gap:6px 16px;
      font-size:0.8rem;
    }
    .block-card-metric{
      display:flex;
      flex-direction:column;
      gap:1px;
      min-width:120px;
    }
    .block-card-metric span:first-child{
      font-size:0.72rem;
      opacity:0.7;
      text-transform:uppercase;
      letter-spacing:0.06em;
    }
    .block-card-metric span:last-child{
      font-weight:600;
    }
    .block-card-notes{
      margin-top:4px;
      font-size:0.8rem;
    }

    .block-notes-main{
      margin-bottom:2px;
    }
    .block-meta{
      margin-top:4px;
      font-size:0.76rem;
      opacity:0.9;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .block-meta-line strong{
      font-weight:600;
    }

    /* Files & photos thumbnails */
    .thumb-grid{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .thumb{
      width:90px;
      height:70px;
      border-radius:8px;
      overflow:hidden;
      border:1px solid var(--border-subtle,var(--border));
      background:var(--surface-variant, #222);
      display:block;
      text-decoration:none;
      cursor:pointer;
    }
    .thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .thumb-empty{
      font-size:0.8rem;
      opacity:0.7;
    }
    .thumb.thumb-file{
      background:var(--surface-subtle,#F3F4F6);
      display:flex;
      align-items:stretch;
    }
    .thumb-file-inner{
      padding:6px 6px;
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:flex-start;
      gap:3px;
      width:100%;
      height:100%;
      box-sizing:border-box;
    }
    .thumb-file-ext{
      font-size:0.7rem;
      font-weight:700;
      text-transform:uppercase;
    }
    .thumb-file-name{
      font-size:0.7rem;
      line-height:1.1;
      overflow:hidden;
      text-overflow:ellipsis;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient:vertical;
    }

    /* Photo viewer modal */
    .photo-modal{
      width:min(900px, 96vw);
      max-height:calc(100vh - 80px);
    }
    .photo-modal-body{
      padding:0;
      background:#000;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .photo-modal-body img{
      max-width:100%;
      max-height:calc(100vh - 120px);
      display:block;
    }

    /* Print-type chooser modal */
    .print-modal{
      max-width:420px;
      width:92vw;
    }
    .print-modal-head{
      background:linear-gradient(135deg, rgba(47,108,60,0.12), transparent);
    }
    .print-modal-title{
      font-size:1rem;
      font-weight:700;
    }
    .print-modal-sub{
      font-size:0.86rem;
      opacity:0.9;
      margin-top:4px;
    }
    .print-modal-body{
      padding:14px 16px 16px;
      display:grid;
      gap:10px;
      font-size:0.88rem;
    }
    .print-modal-buttons{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      justify-content:flex-end;
      margin-top:6px;
    }
    .print-modal-btn{
      flex:1 1 120px;
    }
    .print-modal-note{
      font-size:0.8rem;
      opacity:0.8;
    }

    /* Desktop vs mobile layout toggles */
    .desktop-only{
      display:block;
    }
    .mobile-only{
      display:none;
    }

    /* Mobile field cards */
    .field-card-list{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .farm-mobile-group{
      margin-top:8px;
    }
    .farm-mobile-title{
      font-size:0.8rem;
      text-transform:uppercase;
      letter-spacing:0.06em;
      opacity:0.7;
      margin-bottom:4px;
    }
    .field-card{
      border-radius:12px;
      border:1px solid var(--border-subtle,var(--border));
      background:var(--card-surface,var(--surface));
      padding:10px 12px;
      display:flex;
      flex-direction:column;
      gap:6px;
      cursor:pointer;
    }
    .field-card-header{
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:flex-start;
    }
    .field-card-name{
      font-weight:600;
      font-size:0.95rem;
    }
    .field-card-header-right{
      display:flex;
      align-items:flex-start;
      gap:6px;
    }
    .field-card-adv{
      font-size:0.86rem;
      white-space:nowrap;
    }
    .field-card-meta{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      font-size:0.78rem;
      opacity:0.82;
    }
    .field-card-chip{
      padding:3px 8px;
      border-radius:999px;
      border:1px solid var(--border-subtle,var(--border));
      background:color-mix(in srgb, var(--surface) 88%, var(--border) 12%);
    }
    .field-card-metrics{
      display:flex;
      flex-wrap:wrap;
      gap:8px 14px;
      font-size:0.8rem;
    }
    .field-card-metric{
      display:flex;
      flex-direction:column;
      gap:1px;
      min-width:90px;
    }
    .field-card-metric span{
      opacity:0.7;
      font-size:0.76rem;
    }
    .field-card-metric strong{
      font-size:0.9rem;
    }

    .field-card.field-disabled{
      background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
      opacity:0.6;
    }

    .field-card-excluded-label{
      font-size:0.72rem;
      opacity:0.75;
    }

    /* Mobile tweaks */
    @media (max-width:640px){
      .wrap{
        padding-inline:10px;
      }

      .toolbar{
        flex-direction:column;
        align-items:stretch;
        gap:8px;
      }
      .toolbar-left{
        width:100%;
        justify-content:stretch;
      }
      .toolbar-left .btn{
        flex:1 1 auto;
        width:100%;
        justify-content:center;
      }
      .page-header-meta{
        text-align:left;
      }

      .stats-grid{
        flex-direction:column;
      }
      .stat-pill{
        min-width:0;
      }

      .totals-row{
        align-items:flex-start;
      }
      .totals-metrics{
        width:100%;
        flex-direction:column;
        gap:4px;
      }
      .totals-metric{
        padding-top:4px;
        border-top:1px solid var(--border-subtle,var(--border));
      }
      .totals-metric:first-child{
        border-top:none;
      }

      .bottom-actions{
        justify-content:stretch;
      }
      .bottom-actions .btn{
        width:100%;
        justify-content:center;
      }

      .modal{
        width:100vw;
        max-height:calc(100vh - 32px);
        border-radius:12px;
        margin:0 8px;
      }

      .desktop-only{
        display:none;
      }
      .mobile-only{
        display:block;
      }
    }

    /* Hidden iframe for print */
    #fv-print-frame{
      position:fixed;
      right:0;
      bottom:0;
      width:0;
      height:0;
      border:0;
      visibility:hidden;
    }
  </style>

  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true;
        document.head.appendChild(s);
      }
    })();
  </script>

  <script src="/Farm-vista/js/ai-reports.js"></script>
  <!-- Cloud PDF helper (if present) -->
  <script src="/Farm-vista/js/fv-pdf.js"></script>

  <script type="module">
    import {
      ready,
      getFirestore,
      doc,
      getDoc,
      collection,
      getDocs
    } from '/Farm-vista/js/firebase-init.js';

    import { NAV_MENU } from '/Farm-vista/js/menu.js';

    const CONFIG = {
      COMPANY_DOC_PATH: ['company','main']
    };

    const $  = (sel, root=document) => root.querySelector(sel);

    const STATE = {
      db: null,
      trials: [],       // [{id, data}]
      trialId: null,
      trialDoc: null,
      fields: [],       // [{id, data, blocks, stats}]
      fieldInclusion: {}, // { fieldId: true/false } — false = excluded
      selectedYear: 'all',
      totals: {
        fieldCount: 0,
        tillableAll: 0,
        checkAcresAll: 0,
        trialAcresAll: 0,
        // weighted
        checkAvgAll: null,
        trialAvgAll: null,
        advantageAll: null,
        checkAvgWeighted: null,
        trialAvgWeighted: null,
        advantageWeighted: null,
        // simple
        checkAvgSimple: null,
        trialAvgSimple: null,
        advantageSimple: null,
        // wins / losses
        wins: 0,
        losses: 0,
        winRate: null
      },
      company: null
    };

    const els = {
      title: null,
      subtitle: null,
      heroProducts: null,
      metaLine: null,
      topStats: null,

      farmsContainer: null,
      farmsMobileContainer: null,

      emptyState: null,
      errorState: null,
      totalsCard: null,
      totFields: null,
      totTillable: null,
      totTrialAcres: null,
      totCheckAvg: null,
      totTrialAvg: null,
      totAdv: null,
      aiSummary: null,
      btnBack: null,
      btnPrint: null,
      btnPrintBottom: null,

      filterYear: null,
      filterTrial: null,
      filterClear: null,

      modalBackdrop: null,
      modalClose: null,
      modalTitle: null,
      modalSub: null,
      modalSummary: null,
      modalBlocksBody: null,
      modalBlocksCards: null,
      modalFiles: null,

      photoViewerBackdrop: null,
      photoViewerImg: null,
      photoViewerCaption: null,
      photoViewerClose: null,

      printModalBackdrop: null,
      printSummaryBtn: null,
      printDetailedBtn: null,
      printModalClose: null
    };

    /* ---------- helpers ---------- */

    function wireDom(){
      els.title         = $('#pageTitle');
      els.subtitle      = $('#pageSubtitle');
      els.heroProducts  = $('#heroProducts');
      els.metaLine      = $('#reportMeta');
      els.topStats      = $('#top-stats');

      els.farmsContainer      = $('#farms-container');
      els.farmsMobileContainer= $('#farms-mobile-container');

      els.emptyState    = $('#empty-state');
      els.errorState    = $('#error-state');
      els.totalsCard    = $('#totals-card');
      els.totFields     = $('#tot-fields');
      els.totTillable   = $('#tot-tillable');
      els.totTrialAcres = $('#tot-trial-acres');
      els.totCheckAvg   = $('#tot-check-avg');
      els.totTrialAvg   = $('#tot-trial-avg');
      els.totAdv        = $('#tot-adv');
      els.aiSummary     = $('#ai-summary');
      els.btnBack       = $('#btnBack');
      els.btnPrint      = $('#btnPrint');
      els.btnPrintBottom= $('#btnPrintBottom');

      els.filterYear    = $('#filterCropYear');
      els.filterTrial   = $('#filterTrial');
      els.filterClear   = $('#filterClear');

      els.modalBackdrop   = $('#field-modal-backdrop');
      els.modalClose      = $('#field-modal-close');
      els.modalTitle      = $('#field-modal-title');
      els.modalSub        = $('#field-modal-sub');
      els.modalSummary    = $('#field-modal-summary');
      els.modalBlocksBody = $('#field-modal-blocks-body');
      els.modalBlocksCards= $('#field-modal-blocks-cards');
      els.modalFiles      = $('#field-modal-files');

      els.photoViewerBackdrop = $('#photo-viewer-backdrop');
      els.photoViewerImg      = $('#photo-viewer-img');
      els.photoViewerCaption  = $('#photo-viewer-caption');
      els.photoViewerClose    = $('#photo-viewer-close');

      els.printModalBackdrop = $('#print-modal-backdrop');
      els.printSummaryBtn    = $('#printSummaryBtn');
      els.printDetailedBtn   = $('#printDetailedBtn');
      els.printModalClose    = $('#printModalClose');
    }

    function getTrialIdFromUrl(){
      const params = new URLSearchParams(window.location.search);
      return params.get('trialId') || params.get('id');
    }

    function formatNumber(num, opts = {}) {
      if (num === null || num === undefined || Number.isNaN(num)) return '–';
      const { decimals = 1 } = opts;
      return Number(num).toLocaleString(undefined, {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
      });
    }

    function formatInt(n){
      const num = Number(n);
      if(!Number.isFinite(num)) return '0';
      return num.toLocaleString();
    }

    function formatDecimal(n, digits=1){
      const num = Number(n);
      if(!Number.isFinite(num)) return '';
      return num.toLocaleString(undefined, { maximumFractionDigits:digits, minimumFractionDigits:digits });
    }

    function escapeHtml(str){
      return String(str || '').replace(/[&<>"']/g, m => (
        { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]
      ));
    }

    function formatDate(value){
      if (!value) return '';
      try{
        let d = value;
        if (typeof d === 'object' && typeof d.toDate === 'function') {
          d = d.toDate();
        } else if (typeof d === 'string') {
          d = new Date(d);
        }
        if (d instanceof Date && !Number.isNaN(d.getTime())) {
          return d.toLocaleDateString();
        }
      }catch(e){
        console.warn('[trial-summary] formatDate error', e);
      }
      return '';
    }

    function computeFieldStats(blocks = []) {
      let checkAc = 0, trialAc = 0, checkBu = 0, trialBu = 0;

      for (const b of blocks) {
        const c = b.check || {};
        const t = b.trial || {};
        if (typeof c.acres === 'number' && typeof c.yieldBuAc === 'number') {
          checkAc += c.acres;
          checkBu += c.yieldBuAc * c.acres;
        }
        if (typeof t.acres === 'number' && typeof t.yieldBuAc === 'number') {
          trialAc += t.acres;
          trialBu += t.yieldBuAc * t.acres;
        }
      }

      const checkAvg = checkAc > 0 ? (checkBu / checkAc) : null;
      const trialAvg = trialAc > 0 ? (trialBu / trialAc) : null;
      const advantage = (checkAvg !== null && trialAvg !== null) ? (trialAvg - checkAvg) : null;

      return { checkAc, trialAc, checkAvg, trialAvg, advantage };
    }

    // NEW: full trial-level totals including weighted, simple, and wins/losses
    function computeTotalsFromFields(fields = []) {
      let tillableAll = 0;

      let checkAcresAll = 0;
      let trialAcresAll = 0;
      let checkBuAll = 0;
      let trialBuAll = 0;

      let simpleCount = 0;
      let simpleCheckSum = 0;
      let simpleTrialSum = 0;

      let wins = 0;
      let losses = 0;

      for (const f of fields) {
        const d = f.data || {};
        const stats = f.stats || {};

        // Tillable acres from field doc
        if (typeof d.tillable === 'number') {
          tillableAll += d.tillable;
        }

        const cAc = typeof stats.checkAc === 'number' ? stats.checkAc : 0;
        const tAc = typeof stats.trialAc === 'number' ? stats.trialAc : 0;
        const cAvg = (typeof stats.checkAvg === 'number') ? stats.checkAvg : null;
        const tAvg = (typeof stats.trialAvg === 'number') ? stats.trialAvg : null;

        // Weighted pieces
        checkAcresAll += cAc;
        trialAcresAll += tAc;

        if (cAc > 0 && cAvg !== null) {
          checkBuAll += cAvg * cAc;
        }
        if (tAc > 0 && tAvg !== null) {
          trialBuAll += tAvg * tAc;
        }

        // Simple averages + wins/losses only if both sides exist
        if (cAvg !== null && tAvg !== null) {
          simpleCount += 1;
          simpleCheckSum += cAvg;
          simpleTrialSum += tAvg;

          if (tAvg > cAvg) {
            wins += 1;
          } else {
            losses += 1; // ties are losses by design
          }
        }
      }

      const checkAvgWeighted = checkAcresAll > 0 ? (checkBuAll / checkAcresAll) : null;
      const trialAvgWeighted = trialAcresAll > 0 ? (trialBuAll / trialAcresAll) : null;
      const advantageWeighted =
        (checkAvgWeighted !== null && trialAvgWeighted !== null)
          ? (trialAvgWeighted - checkAvgWeighted)
          : null;

      const checkAvgSimple = simpleCount > 0 ? (simpleCheckSum / simpleCount) : null;
      const trialAvgSimple = simpleCount > 0 ? (simpleTrialSum / simpleCount) : null;
      const advantageSimple =
        (checkAvgSimple !== null && trialAvgSimple !== null)
          ? (trialAvgSimple - checkAvgSimple)
          : null;

      const totalWL = wins + losses;
      const winRate = totalWL > 0 ? (wins / totalWL) : null;

      return {
        fieldCount: fields.length,
        tillableAll,
        checkAcresAll,
        trialAcresAll,
        // Backward-compatible weighted fields:
        checkAvgAll: checkAvgWeighted,
        trialAvgAll: trialAvgWeighted,
        advantageAll: advantageWeighted,
        // Explicit weighted:
        checkAvgWeighted,
        trialAvgWeighted,
        advantageWeighted,
        // Simple:
        checkAvgSimple,
        trialAvgSimple,
        advantageSimple,
        // Wins / losses:
        wins,
        losses,
        winRate
      };
    }

    async function loadTrialList(){
      const colRef = collection(STATE.db, 'fieldTrials');
      const snap = await getDocs(colRef);

      const trials = [];
      snap.forEach(docSnap => {
        const data = docSnap.data() || {};
        const status = (data.status || '').toString().toLowerCase();

        const seedTypeRaw = (data.seedTrialType || '').toString().toLowerCase();
        const isMultiHybrid =
          seedTypeRaw.includes('multiple hybrid') ||
          (seedTypeRaw.includes('multi') && seedTypeRaw.includes('hybrid'));

        const isGoodStatus =
          status === 'active' ||
          status === 'completed' ||
          status === 'complete';

        if (isGoodStatus && !isMultiHybrid) {
          trials.push({ id: docSnap.id, data });
        }
      });

      trials.sort((a,b) => {
        const ay = Number(a.data.cropYear || 0);
        const by = Number(b.data.cropYear || 0);
        if (ay !== by) return by - ay;
        const an = (a.data.trialName || '').toString();
        const bn = (b.data.trialName || '').toString();
        return an.localeCompare(bn);
      });

      STATE.trials = trials;
    }

    async function loadCompanyHeader(){
      if (STATE.company) return STATE.company;
      try{
        const [col,id] = CONFIG.COMPANY_DOC_PATH;
        const ref = doc(STATE.db, col, id);
        const snap = await getDoc(ref);
        const d = snap.exists() ? (snap.data() || {}) : {};
        const name = d.name || '';
        const address = [
          d.addressStreet || '',
          [d.addressCity, d.addressState].filter(Boolean).join(', '),
          d.addressZip || ''
        ].filter(Boolean).join(' · ');
        const phone = d.phone || '';
        const email = d.email || '';
        STATE.company = { name, address, phone, email };
      }catch(e){
        console.warn('[trial-summary] failed to load company header', e);
        STATE.company = { name:'', address:'', phone:'', email:'' };
      }
      return STATE.company;
    }

    function populateYearFilter(){
      if (!els.filterYear) return;

      const years = Array.from(
        new Set(
          STATE.trials
            .map(t => t.data.cropYear)
            .filter(y => y !== null && y !== undefined)
        )
      ).sort((a,b) => Number(b) - Number(a));

      els.filterYear.innerHTML = '';
      const optAll = document.createElement('option');
      optAll.value = 'all';
      optAll.textContent = 'All years';
      els.filterYear.appendChild(optAll);

      years.forEach(y => {
        const opt = document.createElement('option');
        opt.value = String(y);
        opt.textContent = String(y);
        els.filterYear.appendChild(opt);
      });
    }

    function populateTrialFilter(){
      if (!els.filterTrial) return;

      const yearFilter = STATE.selectedYear;
      const list = STATE.trials.filter(t => {
        if (yearFilter === 'all') return true;
        return String(t.data.cropYear || '') === String(yearFilter);
      });

      els.filterTrial.innerHTML = '';
      const optDefault = document.createElement('option');
      optDefault.value = '';
      optDefault.textContent = list.length ? 'Select a trial…' : 'No trials for this year';
      els.filterTrial.appendChild(optDefault);

      list.forEach(t => {
        const d = t.data;
        const opt = document.createElement('option');
        opt.value = t.id;
        const bits = [];
        bits.push(d.trialName || 'Unnamed trial');
        const sub = [];
        if (d.cropYear) sub.push(d.cropYear);
        if (d.crop)     sub.push(d.crop);
        if (d.trialType) sub.push(d.trialType);
        if (sub.length) bits.push('• ' + sub.join(' · '));
        opt.textContent = bits.join(' ');
        els.filterTrial.appendChild(opt);
      });

      if (STATE.trialId) {
        const match = list.find(t => t.id === STATE.trialId);
        if (match) {
          els.filterTrial.value = STATE.trialId;
        } else {
          STATE.trialId = null;
        }
      }
    }

    function clearTrialView(){
      STATE.trialDoc = null;
      STATE.fields = [];
      STATE.fieldInclusion = {};
      STATE.totals = {
        fieldCount: 0,
        tillableAll: 0,
        checkAcresAll: 0,
        trialAcresAll: 0,
        checkAvgAll: null,
        trialAvgAll: null,
        advantageAll: null,
        checkAvgWeighted: null,
        trialAvgWeighted: null,
        advantageWeighted: null,
        checkAvgSimple: null,
        trialAvgSimple: null,
        advantageSimple: null,
        wins: 0,
        losses: 0,
        winRate: null
      };

      if (els.title) els.title.textContent = 'Field Trial Yield Summary';
      if (els.subtitle) els.subtitle.textContent = 'Choose a crop year and trial to view yield summary.';
      if (els.heroProducts) els.heroProducts.textContent = '';

      if (els.metaLine) els.metaLine.textContent = 'No trial selected yet. Pick a trial above to load details.';
      if (els.topStats) els.topStats.innerHTML = '';

      if (els.farmsContainer) els.farmsContainer.innerHTML = '';
      if (els.farmsMobileContainer) els.farmsMobileContainer.innerHTML = '';

      if (els.emptyState) {
        els.emptyState.style.display = 'block';
        els.emptyState.textContent = 'No trial is selected. Choose a crop year and trial above.';
      }
      if (els.errorState) {
        els.errorState.style.display = 'none';
        els.errorState.textContent = '';
      }
      if (els.totalsCard) els.totalsCard.style.display = 'none';

      if (els.aiSummary) {
        els.aiSummary.innerHTML = '<div class="ai-summary-note">Once you select a trial, this section will summarize how the treatment performed across all fields.</div>';
      }
    }

    async function loadTrialData(trialId){
      if (!trialId) return;
      const trialRef = doc(STATE.db, 'fieldTrials', trialId);
      const trialSnap = await getDoc(trialRef);
      if (!trialSnap.exists()) {
        throw new Error('Trial not found');
      }

      const trialData = trialSnap.data() || {};
      STATE.trialDoc = { id: trialSnap.id, ...trialData };

      const fieldsCol = collection(trialRef, 'fields');
      const fieldsSnap = await getDocs(fieldsCol);

      const fieldRecords = [];

      for (const fieldDoc of fieldsSnap.docs) {
        const fieldData = fieldDoc.data() || {};

        const blocksCol = collection(fieldDoc.ref, 'yieldBlocks');
        const blocksSnap = await getDocs(blocksCol);
        const blocks = blocksSnap.docs.map(d => ({ id: d.id, ...d.data() }));

        const stats = computeFieldStats(blocks);

        fieldRecords.push({
          id: fieldDoc.id,
          data: fieldData,
          blocks,
          stats
        });
      }

      STATE.fields = fieldRecords;

      // Initialize inclusion — all fields included by default
      const inc = {};
      for (const f of STATE.fields) {
        inc[f.id] = true;
      }
      STATE.fieldInclusion = inc;

      // Initial totals use ALL fields (all included)
      STATE.totals = computeTotalsFromFields(STATE.fields);
    }

    /* ---------- selection helpers ---------- */

    function getActiveFields() {
      const inc = STATE.fieldInclusion || {};
      return (STATE.fields || []).filter(f => inc[f.id] !== false);
    }

    function refreshSummaryFromSelection(){
      const activeFields = getActiveFields();
      STATE.totals = computeTotalsFromFields(activeFields);
      renderTop(activeFields);
      renderFarmsAndFieldsTable();
      renderFarmsAndFieldsMobile();
      kickOffAiSummary();
    }

    /* ---------- render main page ---------- */

    function renderTop(activeFields = null) {
      const t = STATE.trialDoc;
      if (!t) return;

      const s = STATE.totals || {};
      const fieldsForMeta = Array.isArray(activeFields) ? activeFields : getActiveFields();

      if (els.title) els.title.textContent = t.trialName || 'Field Trial Yield Summary';

      const pieces = [];
      if (t.cropYear) pieces.push(t.cropYear);
      if (t.crop) pieces.push(t.crop);
      if (t.trialType) pieces.push(t.trialType);
      if (els.subtitle) els.subtitle.textContent = pieces.join(' • ') || 'Trial details';

      const checkProduct = t.checkProduct || t.check || '';
      const trialProduct = t.trialProduct || t.treatmentProduct || '';
      if (els.heroProducts) {
        if (checkProduct || trialProduct) {
          const parts = [];
          if (checkProduct) parts.push(`Check product: ${checkProduct}`);
          if (trialProduct) parts.push(`Trial product: ${trialProduct}`);
          els.heroProducts.textContent = parts.join(' • ');
        } else {
          els.heroProducts.textContent = '';
        }
      }

      if (els.metaLine) {
        const parts = [];
        const fieldCount = fieldsForMeta.length;
        if (fieldCount) parts.push(`${fieldCount} field${fieldCount === 1 ? '' : 's'}`);

        const farmSet = new Set(fieldsForMeta.map(f => f.data.farmId || f.data.farmName || ''));
        const farmCount = Array.from(farmSet).filter(Boolean).length;
        if (farmCount) parts.push(`${farmCount} farm${farmCount === 1 ? '' : 's'}`);

        if (s.trialAcresAll) {
          parts.push(`${formatNumber(s.trialAcresAll, {decimals:0})} trial acres with yield`);
        }

        els.metaLine.textContent = parts.length
          ? parts.join(' • ')
          : 'No fields included in summary. Turn fields back on using the checkboxes.';
      }

      // Format helpers
      const wCheck = s.checkAvgWeighted !== null ? formatNumber(s.checkAvgWeighted, {decimals:1}) + ' bu/ac' : '–';
      const wTrial = s.trialAvgWeighted !== null ? formatNumber(s.trialAvgWeighted, {decimals:1}) + ' bu/ac' : '–';
      const wAdv = s.advantageWeighted !== null
        ? `${s.advantageWeighted >= 0 ? '+' : ''}${formatNumber(s.advantageWeighted, {decimals:1})} bu/ac`
        : '–';

      const simpleCheck = s.checkAvgSimple !== null ? formatNumber(s.checkAvgSimple, {decimals:1}) + ' bu/ac' : '–';
      const simpleTrial = s.trialAvgSimple !== null ? formatNumber(s.trialAvgSimple, {decimals:1}) + ' bu/ac' : '–';
      const simpleAdv = s.advantageSimple !== null
        ? `${s.advantageSimple >= 0 ? '+' : ''}${formatNumber(s.advantageSimple, {decimals:1})} bu/ac`
        : '–';

      const wins = s.wins || 0;
      const losses = s.losses || 0;
      const wlTotal = wins + losses;
      const winRateStr = s.winRate !== null && wlTotal > 0
        ? `${(s.winRate * 100).toFixed(0)}%`
        : '–';

      const fieldsInSummary = s.fieldCount || 0;
      const tillableStr = s.tillableAll ? formatNumber(s.tillableAll, {decimals:0}) + ' ac' : '–';
      const trialAcresStr = s.trialAcresAll ? formatNumber(s.trialAcresAll, {decimals:0}) + ' ac' : '–';

      if (els.topStats) {
        els.topStats.innerHTML = `
          <!-- Core counts -->
          <div class="stat-pill">
            <div class="stat-label">Fields in summary</div>
            <div class="stat-value">${formatInt(fieldsInSummary)}</div>
          </div>
          <div class="stat-pill">
            <div class="stat-label">Trial acres (with yield)</div>
            <div class="stat-value">${trialAcresStr}</div>
          </div>
          <div class="stat-pill">
            <div class="stat-label">Tillable acres covered</div>
            <div class="stat-value">${tillableStr}</div>
          </div>

          <!-- Weighted averages group -->
          <div class="stat-pill stat-pill-group">
            <div class="stat-label">Weighted averages</div>
            <div class="stat-group-rows">
              <div class="stat-group-row">
                <span class="stat-group-label">Check</span>
                <span class="stat-group-value">${wCheck}</span>
              </div>
              <div class="stat-group-row">
                <span class="stat-group-label">Treatment</span>
                <span class="stat-group-value">${wTrial}</span>
              </div>
              <div class="stat-group-row">
                <span class="stat-group-label">Advantage</span>
                <span class="stat-group-value">${wAdv}</span>
              </div>
            </div>
          </div>

          <!-- Simple averages group -->
          <div class="stat-pill stat-pill-group">
            <div class="stat-label">Simple averages</div>
            <div class="stat-group-rows">
              <div class="stat-group-row">
                <span class="stat-group-label">Check</span>
                <span class="stat-group-value">${simpleCheck}</span>
              </div>
              <div class="stat-group-row">
                <span class="stat-group-label">Treatment</span>
                <span class="stat-group-value">${simpleTrial}</span>
              </div>
              <div class="stat-group-row">
                <span class="stat-group-label">Avg advantage</span>
                <span class="stat-group-value">${simpleAdv}</span>
              </div>
            </div>
          </div>

          <!-- Wins / losses group -->
          <div class="stat-pill stat-pill-group">
            <div class="stat-label">Wins / losses</div>
            <div class="stat-group-rows">
              <div class="stat-group-row">
                <span class="stat-group-label">Wins</span>
                <span class="stat-group-value">${formatInt(wins)}</span>
              </div>
              <div class="stat-group-row">
                <span class="stat-group-label">Losses</span>
                <span class="stat-group-value">${formatInt(losses)}</span>
              </div>
              <div class="stat-group-row">
                <span class="stat-group-label">Win rate</span>
                <span class="stat-group-value">${winRateStr}</span>
              </div>
            </div>
          </div>
        `;
      }

      // Totals card (keeps weighted view)
      if (els.totalsCard) els.totalsCard.style.display = 'block';
      if (els.totFields)     els.totFields.textContent = fieldsInSummary;
      if (els.totTillable)   els.totTillable.textContent   = s.tillableAll ? formatNumber(s.tillableAll, {decimals:1}) : '–';
      if (els.totTrialAcres) els.totTrialAcres.textContent = s.trialAcresAll ? formatNumber(s.trialAcresAll, {decimals:1}) : '–';
      if (els.totCheckAvg)   els.totCheckAvg.textContent   = s.checkAvgWeighted !== null ? formatNumber(s.checkAvgWeighted, {decimals:1}) : '–';
      if (els.totTrialAvg)   els.totTrialAvg.textContent   = s.trialAvgWeighted !== null ? formatNumber(s.trialAvgWeighted, {decimals:1}) : '–';
      if (els.totAdv) {
        els.totAdv.textContent = s.advantageWeighted !== null
          ? `${s.advantageWeighted >= 0 ? '+' : ''}${formatNumber(s.advantageWeighted, {decimals:1})} bu/ac`
          : '–';
      }
    }

    /* ---------- desktop: farm/field table ---------- */

    function renderFarmsAndFieldsTable() {
      const fields = STATE.fields || [];
      if (!els.farmsContainer) return;

      if (!fields.length) {
        els.farmsContainer.innerHTML = '';
        if (els.farmsMobileContainer) els.farmsMobileContainer.innerHTML = '';
        if (els.emptyState) {
          els.emptyState.style.display = 'block';
          els.emptyState.textContent = 'No fields with yield were found for this trial yet.';
        }
        return;
      }
      if (els.emptyState) els.emptyState.style.display = 'none';

      const byFarm = new Map();
      for (const f of fields) {
        const name = f.data.farmName || 'Unknown farm';
        if (!byFarm.has(name)) byFarm.set(name, []);
        byFarm.get(name).push(f);
      }

      const farmNames = Array.from(byFarm.keys()).sort((a, b) => a.localeCompare(b));
      const farmHtml = [];

      for (const farmName of farmNames) {
        const fList = byFarm.get(farmName) || [];
        fList.sort((a, b) => {
          const an = a.data.fieldName || '';
          const bn = b.data.fieldName || '';
          return an.localeCompare(bn);
        });

        let rows = '';
        for (const f of fList) {
          const d = f.data;
          const s = f.stats;
          const adv = s.advantage;

          const included = !STATE.fieldInclusion || STATE.fieldInclusion[f.id] !== false;

          let advClass = '';
          let advText = '–';
          if (adv !== null) {
            advClass = adv >= 0 ? 'adv-pos' : 'adv-neg';
            advText = `${adv.toFixed(1)} bu/ac`;
          }

          const rowClass = included ? '' : 'field-disabled';

          rows += `
            <tr data-field-id="${f.id}" class="${rowClass}">
              <td class="field-name-cell">
                ${d.fieldName || '(Unnamed field)'}
                <div class="muted-small">
                  ${formatNumber(d.trialAcres || 0, {decimals:1})} trial ac
                  • ${formatNumber(d.tillable || 0, {decimals:1})} tillable
                </div>
              </td>
              <td class="numeric">${s.checkAvg !== null ? formatNumber(s.checkAvg, {decimals:1}) : '–'}</td>
              <td class="numeric">${s.trialAvg !== null ? formatNumber(s.trialAvg, {decimals:1}) : '–'}</td>
              <td class="numeric ${advClass}">${advText}</td>
              <td class="include-cell">
                <label class="field-include-toggle">
                  <input
                    type="checkbox"
                    class="field-include-checkbox"
                    data-field-id="${f.id}"
                    ${included ? 'checked' : ''}>
                </label>
              </td>
            </tr>
          `;
        }

        farmHtml.push(`
          <div class="farm-group">
            <div class="farm-group-title">${farmName}</div>
            <div class="farm-table-wrap">
              <table class="farm-table" data-farm="${farmName}">
                <thead>
                  <tr>
                    <th style="width:40%">Field</th>
                    <th class="numeric" style="width:20%">Check bu/ac</th>
                    <th class="numeric" style="width:20%">Trial bu/ac</th>
                    <th class="numeric" style="width:20%">Advantage (bu/ac)</th>
                    <th class="include-col">Include</th>
                  </tr>
                </thead>
                <tbody>
                  ${rows}
                </tbody>
              </table>
            </div>
          </div>
        `);
      }

      els.farmsContainer.innerHTML = farmHtml.join('');

      // Row click (open modal), but ignore clicks on the checkbox itself
      els.farmsContainer.querySelectorAll('tbody tr[data-field-id]').forEach(row => {
        row.addEventListener('click', (evt) => {
          if (evt.target.closest('.field-include-toggle')) return;
          const id = row.getAttribute('data-field-id');
          const field = STATE.fields.find(f => f.id === id);
          if (field) openFieldModal(field);
        });
      });

      // Checkbox events
      els.farmsContainer.querySelectorAll('input.field-include-checkbox').forEach(input => {
        input.addEventListener('change', (evt) => {
          evt.stopPropagation();
          const id = input.getAttribute('data-field-id');
          const checked = input.checked;
          if (!STATE.fieldInclusion) STATE.fieldInclusion = {};
          STATE.fieldInclusion[id] = checked;

          // Update row class
          const row = input.closest('tr[data-field-id]');
          if (row) {
            if (checked) row.classList.remove('field-disabled');
            else row.classList.add('field-disabled');
          }

          refreshSummaryFromSelection();
        });
      });
    }

    /* ---------- mobile: stacked field cards ---------- */

    function renderFarmsAndFieldsMobile() {
      const fields = STATE.fields || [];
      if (!els.farmsMobileContainer) return;

      if (!fields.length) {
        els.farmsMobileContainer.innerHTML = '';
        return;
      }

      const byFarm = new Map();
      for (const f of fields) {
        const name = f.data.farmName || 'Unknown farm';
        if (!byFarm.has(name)) byFarm.set(name, []);
        byFarm.get(name).push(f);
      }

      const farmNames = Array.from(byFarm.keys()).sort((a, b) => a.localeCompare(b));
      const farmHtml = [];

      for (const farmName of farmNames) {
        const fList = byFarm.get(farmName) || [];
        fList.sort((a, b) => {
          const an = a.data.fieldName || '';
          const bn = b.data.fieldName || '';
          return an.localeCompare(bn);
        });

        const cards = fList.map(f => {
          const d = f.data;
          const s = f.stats || {};
          const adv = s.advantage;

          const included = !STATE.fieldInclusion || STATE.fieldInclusion[f.id] !== false;

          let advClass = '';
          let advText = '–';
          if (adv !== null) {
            advClass = adv >= 0 ? 'adv-pos' : 'adv-neg';
            advText = `${formatNumber(adv, {decimals:1})} bu/ac`;
          }

          const checkText = s.checkAvg !== null ? formatNumber(s.checkAvg, {decimals:1}) : '–';
          const trialText = s.trialAvg !== null ? formatNumber(s.trialAvg, {decimals:1}) : '–';

          const cardClass = included ? '' : 'field-disabled';

          return `
            <div class="field-card ${cardClass}" data-field-id="${f.id}">
              <div class="field-card-header">
                <div class="field-card-name">${d.fieldName || '(Unnamed field)'}</div>
                <div class="field-card-header-right">
                  <label class="field-include-toggle" title="Include in summary">
                    <input
                      type="checkbox"
                      class="field-include-checkbox"
                      data-field-id="${f.id}"
                      ${included ? 'checked' : ''}>
                  </label>
                  <div class="field-card-adv ${advClass}">${advText}</div>
                </div>
              </div>
              <div class="field-card-meta">
                <span class="field-card-chip">${formatNumber(d.trialAcres || 0, {decimals:1})} trial ac</span>
                <span class="field-card-chip">${formatNumber(d.tillable || 0, {decimals:1})} tillable</span>
                ${included ? '' : '<span class="field-card-excluded-label">Excluded from summary</span>'}
              </div>
              <div class="field-card-metrics">
                <div class="field-card-metric">
                  <span>Check bu/ac</span>
                  <strong>${checkText}</strong>
                </div>
                <div class="field-card-metric">
                  <span>Trial bu/ac</span>
                  <strong>${trialText}</strong>
                </div>
              </div>
            </div>
          `;
        }).join('');

        farmHtml.push(`
          <div class="farm-mobile-group">
            <div class="farm-mobile-title">${farmName}</div>
            ${cards}
          </div>
        `);
      }

      els.farmsMobileContainer.innerHTML = farmHtml.join('');

      // Card click (open modal), but ignore checkbox taps
      els.farmsMobileContainer.querySelectorAll('.field-card[data-field-id]').forEach(card => {
        card.addEventListener('click', (evt) => {
          if (evt.target.closest('.field-include-toggle')) return;
          const id = card.getAttribute('data-field-id');
          const field = STATE.fields.find(f => f.id === id);
          if (field) openFieldModal(field);
        });
      });

      // Checkbox events (mobile)
      els.farmsMobileContainer.querySelectorAll('input.field-include-checkbox').forEach(input => {
        input.addEventListener('change', (evt) => {
          evt.stopPropagation();
          const id = input.getAttribute('data-field-id');
          const checked = input.checked;
          if (!STATE.fieldInclusion) STATE.fieldInclusion = {};
          STATE.fieldInclusion[id] = checked;

          const card = input.closest('.field-card[data-field-id]');
          if (card) {
            if (checked) {
              card.classList.remove('field-disabled');
              const excl = card.querySelector('.field-card-excluded-label');
              if (excl) excl.remove();
            } else {
              card.classList.add('field-disabled');
              if (!card.querySelector('.field-card-excluded-label')) {
                const meta = card.querySelector('.field-card-meta');
                if (meta) {
                  const span = document.createElement('span');
                  span.className = 'field-card-excluded-label';
                  span.textContent = 'Excluded from summary';
                  meta.appendChild(span);
                }
              }
            }
          }

          refreshSummaryFromSelection();
        });
      });
    }

    /* ---------- field detail modal ---------- */

    function openFieldModal(field) {
      if (!els.modalBackdrop) return;

      const d = field.data;
      const s = field.stats || {};
      const blocks = Array.isArray(field.blocks) ? field.blocks : [];

      if (els.modalTitle) els.modalTitle.textContent = d.fieldName || 'Field details';

      const subBits = [];
      if (d.farmName) subBits.push(d.farmName);
      if (typeof d.tillable === 'number') subBits.push(`${formatNumber(d.tillable, {decimals:1})} tillable ac`);
      if (typeof d.trialAcres === 'number') subBits.push(`${formatNumber(d.trialAcres, {decimals:1})} trial ac`);
      if (els.modalSub) els.modalSub.textContent = subBits.join(' • ');

      if (els.modalSummary) {
        const sumHtml = [
          { label: 'Check weighted bu/ac', value: s.checkAvg !== null ? formatNumber(s.checkAvg, {decimals:1}) : '–' },
          { label: 'Trial weighted bu/ac', value: s.trialAvg !== null ? formatNumber(s.trialAvg, {decimals:1}) : '–' },
          { label: 'Treatment advantage', value: s.advantage !== null ? `${s.advantage >= 0 ? '+' : ''}${formatNumber(s.advantage, {decimals:1})} bu/ac` : '–' },
          { label: 'Check acres (blocks)', value: s.checkAc ? formatNumber(s.checkAc, {decimals:1}) : '–' },
          { label: 'Trial acres (blocks)', value: s.trialAc ? formatNumber(s.trialAc, {decimals:1}) : '–' }
        ].map(item => `
          <div class="modal-summary-item">
            <span>${item.label}</span><br/>
            <span>${item.value}</span>
          </div>
        `).join('');

        els.modalSummary.innerHTML = sumHtml;
      }

      if (els.modalBlocksBody) {
        if (!blocks.length) {
          els.modalBlocksBody.innerHTML = `
            <tr><td colspan="7" class="muted-small">No yield blocks recorded for this field yet.</td></tr>
          `;
          if (els.modalBlocksCards) {
            els.modalBlocksCards.innerHTML = `
              <div class="block-card muted-small">No yield blocks recorded for this field yet.</div>
            `;
          }
        } else {
          let idx = 1;
          const rows = [];
          const cards = [];

          blocks.forEach(b => {
            const c = b.check || {};
            const t = b.trial || {};

            const blockIndex = idx++;
            const blockLabel = `Block ${blockIndex}`;
            const typeLabel  = (b.blockType || 'combine').toString();

            const checkBu    = typeof c.yieldBuAc === 'number' ? formatNumber(c.yieldBuAc, {decimals:1}) : '–';
            const trialBu    = typeof t.yieldBuAc === 'number' ? formatNumber(t.yieldBuAc, {decimals:1}) : '–';
            const checkAcres = typeof c.acres === 'number' ? formatNumber(c.acres, {decimals:1}) : '–';
            const trialAcres = typeof t.acres === 'number' ? formatNumber(t.acres, {decimals:1}) : '–';

            const plantDateStr   = formatDate(b.plantDate);
            const harvestDateStr = formatDate(b.harvestDate);
            const combineCount   = (b.combineCount !== undefined && b.combineCount !== null)
              ? String(b.combineCount)
              : '';

            const checkVariety = (b.checkVarietyName || '').toString();
            const trialVariety = (b.trialVarietyName || '').toString();

            const checkLen = (c.lengthFt !== undefined && c.lengthFt !== null) ? `${c.lengthFt} ft` : '';
            const checkWid = (c.widthFt  !== undefined && c.widthFt  !== null) ? `${c.widthFt} ft` : '';
            const trialLen = (t.lengthFt !== undefined && t.lengthFt !== null) ? `${t.lengthFt} ft` : '';
            const trialWid = (t.widthFt  !== undefined && t.widthFt  !== null) ? `${t.widthFt} ft` : '';

            const checkDims = (checkLen || checkWid) ? `${checkLen}${checkLen && checkWid ? ' × ' : ''}${checkWid}` : '';
            const trialDims = (trialLen || trialWid) ? `${trialLen}${trialLen && trialWid ? ' × ' : ''}${trialWid}` : '';

            const checkMoist = (typeof c.moisture === 'number') ? `${formatNumber(c.moisture, {decimals:1})}%` : '';
            const trialMoist = (typeof t.moisture === 'number') ? `${formatNumber(t.moisture, {decimals:1})}%` : '';

            const checkLbs = (typeof c.pounds === 'number') ? `${formatNumber(c.pounds, {decimals:0})} lbs` : '';
            const trialLbs = (typeof t.pounds === 'number') ? `${formatNumber(t.pounds, {decimals:0})} lbs` : '';

            const notes = (b.notes || '').toString().trim();

            const metaLines = [];

            if (plantDateStr) {
              metaLines.push(
                `<div class="block-meta-line"><strong>Plant date:</strong> ${plantDateStr}</div>`
              );
            }
            if (harvestDateStr) {
              metaLines.push(
                `<div class="block-meta-line"><strong>Harvest date:</strong> ${harvestDateStr}</div>`
              );
            }

            if (combineCount) {
              metaLines.push(
                `<div class="block-meta-line"><strong>Combine passes:</strong> ${escapeHtml(combineCount)}</div>`
              );
            }

            if (checkVariety || trialVariety) {
              const parts = [];
              if (checkVariety) parts.push(`Check – ${escapeHtml(checkVariety)}`);
              if (trialVariety) parts.push(`Trial – ${escapeHtml(trialVariety)}`);
              metaLines.push(
                `<div class="block-meta-line"><strong>Varieties:</strong> ${parts.join('; ')}</div>`
              );
            }

            if (checkDims || trialDims) {
              const parts = [];
              if (checkDims) parts.push(`Check plots: ${escapeHtml(checkDims)}`);
              if (trialDims) parts.push(`Trial plots: ${escapeHtml(trialDims)}`);
              metaLines.push(
                `<div class="block-meta-line"><strong>Plot size:</strong> ${parts.join(' • ')}</div>`
              );
            }

            if (checkMoist || trialMoist || checkLbs || trialLbs) {
              const pieces = [];
              if (checkMoist || checkLbs) {
                pieces.push(`Check – ${[checkMoist, checkLbs].filter(Boolean).join(', ')}`);
              }
              if (trialMoist || trialLbs) {
                pieces.push(`Trial – ${[trialMoist, trialLbs].filter(Boolean).join(', ')}`);
              }
              metaLines.push(
                `<div class="block-meta-line"><strong>Moisture &amp; weight:</strong> ${pieces.join(' • ')}</div>`
              );
            }

            const notesHtml = notes
              ? `<div class="block-notes-main">${escapeHtml(notes)}</div>`
              : `<div class="block-notes-main muted-small">No notes recorded for this block.</div>`;

            const metaHtml = metaLines.length
              ? `<div class="block-meta">${metaLines.join('')}</div>`
              : '';

            rows.push(`
              <tr>
                <td>${blockLabel}</td>
                <td>${escapeHtml(typeLabel)}</td>
                <td class="numeric">${checkBu}</td>
                <td class="numeric">${trialBu}</td>
                <td class="numeric">${checkAcres}</td>
                <td class="numeric">${trialAcres}</td>
                <td>${notesHtml}${metaHtml}</td>
              </tr>
            `);

            cards.push(`
              <div class="block-card">
                <div class="block-card-header">
                  <div class="block-card-title">${blockLabel}</div>
                  <div class="block-card-type">${escapeHtml(typeLabel)}</div>
                </div>
                <div class="block-card-main">
                  <div class="block-card-metric">
                    <span>Check bu/ac</span>
                    <span>${checkBu}</span>
                  </div>
                  <div class="block-card-metric">
                    <span>Trial bu/ac</span>
                    <span>${trialBu}</span>
                  </div>
                  <div class="block-card-metric">
                    <span>Check acres</span>
                    <span>${checkAcres}</span>
                  </div>
                  <div class="block-card-metric">
                    <span>Trial acres</span>
                    <span>${trialAcres}</span>
                  </div>
                </div>
                <div class="block-card-notes">
                  ${notesHtml}${metaHtml}
                </div>
              </div>
            `);
          });

          els.modalBlocksBody.innerHTML = rows.join('');
          if (els.modalBlocksCards) {
            els.modalBlocksCards.innerHTML = cards.join('');
          }
        }
      }

      const allAttachments = [];
      blocks.forEach((b, index) => {
        if (Array.isArray(b.attachments)) {
          b.attachments.forEach(att => {
            if (att && typeof att === 'object' && att.url) {
              allAttachments.push({
                ...att,
                _blockIndex: index + 1
              });
            }
          });
        }
      });

      if (els.modalFiles) {
        if (!allAttachments.length) {
          els.modalFiles.innerHTML = `<div class="thumb-empty">No files or photos are attached to this field’s blocks yet.</div>`;
        } else {
          els.modalFiles.innerHTML = allAttachments.map(att => {
            const rawUrl = att.url || '';
            const url = escapeHtml(rawUrl);
            const nameRaw = att.name || '';
            const safeNameRaw = nameRaw || `Block ${att._blockIndex} file`;
            const name = escapeHtml(safeNameRaw);
            const title = `Block ${att._blockIndex}${nameRaw ? ' • ' + nameRaw : ''}`;

            const ct = (att.contentType || '').toString().toLowerCase();
            const isImage = ct ? ct.startsWith('image/') : true;

            if (isImage) {
              return `
                <button
                  type="button"
                  class="thumb"
                  data-url="${url}"
                  data-name="${escapeHtml(safeNameRaw)}"
                  data-block-index="${att._blockIndex}"
                  title="${escapeHtml(title)}">
                  <img src="${url}" alt="${name}">
                </button>
              `;
            }

            const extGuess = ct.includes('/') ? ct.split('/').pop().toUpperCase() : 'FILE';

            return `
              <button
                  type="button"
                  class="thumb thumb-file"
                  data-url="${url}"
                  data-name="${escapeHtml(safeNameRaw)}"
                  data-block-index="${att._blockIndex}"
                  title="${escapeHtml(title)}">
                <div class="thumb-file-inner">
                  <div class="thumb-file-ext">${escapeHtml(extGuess)}</div>
                  <div class="thumb-file-name">${name}</div>
                </div>
              </button>
            `;
          }).join('');

          const thumbs = els.modalFiles.querySelectorAll('.thumb');
          thumbs.forEach(btn => {
            btn.addEventListener('click', () => {
              const url = btn.getAttribute('data-url');
              const name = btn.getAttribute('data-name') || '';
              const blockIndex = btn.getAttribute('data-block-index') || '';
              if (url) {
                openPhotoViewer({ url, name, blockIndex });
              }
            });
          });
        }
      }

      els.modalBackdrop.classList.remove('modal-hidden');
      els.modalBackdrop.setAttribute('aria-hidden', 'false');
    }

    function closeFieldModal() {
      if (!els.modalBackdrop) return;
      els.modalBackdrop.classList.add('modal-hidden');
      els.modalBackdrop.setAttribute('aria-hidden', 'true');
    }

    /* ---------- photo viewer ---------- */

    function openPhotoViewer(info = {}) {
      if (!els.photoViewerBackdrop) return;

      const url        = info.url || '';
      const name       = info.name || '';
      const blockIndex = info.blockIndex || '';

      if (els.photoViewerImg) {
        els.photoViewerImg.src = url;
      }

      if (els.photoViewerCaption) {
        const parts = [];
        if (blockIndex) parts.push(`Block ${blockIndex}`);
        if (name) parts.push(name);
        els.photoViewerCaption.textContent = parts.join(' • ') || 'File preview';
      }

      els.photoViewerBackdrop.classList.remove('modal-hidden');
      els.photoViewerBackdrop.setAttribute('aria-hidden', 'false');
    }

    function closePhotoViewer() {
      if (!els.photoViewerBackdrop) return;
      els.photoViewerBackdrop.classList.add('modal-hidden');
      els.photoViewerBackdrop.setAttribute('aria-hidden', 'true');
      if (els.photoViewerImg) {
        els.photoViewerImg.src = '';
      }
    }

    /* ---------- print: build summary PDF ---------- */

    function buildPrintHtml({ company, runStr, runDateOnly, fields, totals }) {
      const t = STATE.trialDoc || {};
      const s = totals || STATE.totals || {};
      const fieldList = Array.isArray(fields) && fields.length ? fields : getActiveFields();

      const farmMap = new Map();
      fieldList.forEach(f => {
        const name = f.data.farmName || 'Unknown farm';
        if (!farmMap.has(name)) farmMap.set(name, []);
        farmMap.get(name).push(f);
      });
      const farmEntries = Array.from(farmMap.entries()).sort((a,b)=>a[0].localeCompare(b[0]));

      const checkProductName = (t.checkProduct || t.check || '').toString();
      const trialProductName = (t.trialProduct || t.treatmentProduct || '').toString();

      return `<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Field Trial Yield Summary</title>
  <style>
    :root{
      --fv-green:#3B7E46;
      --fv-border:#D1D5DB;
      --fv-text:#111827;
      --fv-muted:#6B7280;
      --fv-bg:#F3F4F6;
    }
    *{box-sizing:border-box;}
    html,body{
      margin:0;
      padding:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      color:var(--fv-text);
      background:var(--fv-bg);
    }
    body{
      display:flex;
      justify-content:center;
      padding:24px 12px;
    }
    .page{
      width:100%;
      max-width:900px;
      background:#fff;
      border-radius:12px;
      box-shadow:0 10px 30px rgba(15,23,42,0.15);
      padding:24px 28px 28px;
    }
    .report-header{
      display:grid;
      grid-template-columns:auto 1fr auto;
      gap:16px;
      align-items:center;
      border-bottom:2px solid var(--fv-green);
      padding-bottom:14px;
      margin-bottom:18px;
    }
    .report-logo{
      width:64px;
      height:64px;
      border-radius:16px;
      border:1px solid var(--fv-border);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:26px;
      font-weight:800;
      color:#fff;
      background:radial-gradient(circle at 30% 0%, #4CAF50, var(--fv-green));
    }
    .report-logo span{letter-spacing:0.02em;}
    .company-block{min-width:0;}
    .company-name{
      font-size:18px;
      font-weight:800;
      margin:0 0 2px;
    }
    .company-line{
      font-size:12px;
      color:var(--fv-muted);
      margin:0;
    }
    .report-meta-top{
      text-align:right;
      font-size:11px;
      color:var(--fv-muted);
    }
    .report-meta-top strong{color:var(--fv-text);}
    .report-title{
      font-size:20px;
      font-weight:800;
      margin:12px 0 4px;
      letter-spacing:0.02em;
      text-transform:uppercase;
    }
    .report-subtitle{
      font-size:13px;
      color:var(--fv-muted);
      margin:0 0 4px;
    }
    .report-products{
      font-size:12px;
      color:#374151;
      margin:0 0 10px;
    }
    .summary-strip{
      display:flex;
      flex-wrap:wrap;
      gap:6px 14px;
      margin-top:4px;
      padding:8px 10px;
      border-radius:10px;
      background:linear-gradient(90deg, rgba(59,126,70,0.08), transparent);
      border:1px solid rgba(59,126,70,0.2);
      font-size:11px;
    }
    .summary-pill{
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .summary-label{
      text-transform:uppercase;
      letter-spacing:.08em;
      font-size:10px;
      color:var(--fv-muted);
    }
    .summary-value{
      font-weight:600;
    }
    .section{
      margin-top:16px;
      page-break-inside:avoid;
    }
    .section-title{
      font-size:14px;
      font-weight:700;
      margin:0 0 4px;
    }
    .section-sub{
      font-size:11px;
      color:var(--fv-muted);
      margin:0 0 6px;
    }
    .farm-title{
      font-size:12px;
      font-weight:600;
      margin:8px 0 2px;
    }
    .table-wrap{
      border-radius:10px;
      border:1px solid var(--fv-border);
      overflow:hidden;
      margin-bottom:4px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
    }
    thead{
      background:#F9FAFB;
    }
    th,td{
      padding:6px 8px;
      border-bottom:1px solid #E5E7EB;
      text-align:left;
      vertical-align:top;
    }
    th{
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.08em;
      font-size:10px;
      color:#4B5563;
      border-bottom:1px solid #D1D5DB;
    }
    tr:nth-child(even) td{
      background:#F9FAFB;
    }
    .cell-right{text-align:right;}
    .report-footer{
      margin-top:18px;
      padding-top:8px;
      border-top:1px solid #D1D5DB;
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:10px;
      color:#6B7280;
    }
    @media print{
      html,body{background:#fff;padding:0;}
      body{box-shadow:none;}
      .page{
        max-width:none;
        border-radius:0;
        box-shadow:none;
        padding:12mm 14mm;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="report-header">
      <div class="report-logo"><span>DF</span></div>
      <div class="company-block">
        <p class="company-name">${escapeHtml(company.name || '')}</p>
        <p class="company-line">
          ${company.address ? escapeHtml(company.address) + '<br>' : ''}
          ${company.phone ? 'Phone: ' + escapeHtml(company.phone) : ''}${company.phone && company.email ? ' · ' : ''}
          ${company.email ? 'Email: ' + escapeHtml(company.email) : ''}
        </p>
      </div>
      <div class="report-meta-top">
        <div><strong>Field Trial Yield Summary</strong></div>
        <div>Generated: ${escapeHtml(runStr)}</div>
        <div>Prepared by: ${escapeHtml(company.name || 'FarmVista')}</div>
      </div>
    </header>

    <h1 class="report-title">${escapeHtml(t.trialName || 'Field Trial Yield Summary')}</h1>
    <p class="report-subtitle">
      ${escapeHtml([t.cropYear, t.crop, t.trialType].filter(Boolean).join(' • '))}
      ${t.operationTask ? ' • ' + escapeHtml(t.operationTask) : ''}
    </p>

    ${
      (checkProductName || trialProductName)
        ? `<p class="report-products">
            ${checkProductName
              ? '<strong>Check product:</strong> ' + escapeHtml(checkProductName)
              : ''}
            ${
              checkProductName && trialProductName
                ? ' &nbsp;•&nbsp; '
                : ''
            }
            ${trialProductName
              ? '<strong>Trial product:</strong> ' + escapeHtml(trialProductName)
              : ''}
          </p>`
        : ''
    }

    <div class="summary-strip">
      <div class="summary-pill">
        <span class="summary-label">Fields</span>
        <span class="summary-value">${formatInt(s.fieldCount || 0)}</span>
      </div>
      <div class="summary-pill">
        <span class="summary-label">Trial acres</span>
        <span class="summary-value">${s.trialAcresAll ? formatInt(s.trialAcresAll) + ' ac' : 'n/a'}</span>
      </div>
      <div class="summary-pill">
        <span class="summary-label">Tillable acres</span>
        <span class="summary-value">${s.tillableAll ? formatInt(s.tillableAll) + ' ac' : 'n/a'}</span>
      </div>
      <div class="summary-pill">
        <span class="summary-label">Check</span>
        <span class="summary-value">${s.checkAvgAll !== null ? formatDecimal(s.checkAvgAll,1) + ' bu/ac' : 'n/a'}</span>
      </div>
      <div class="summary-pill">
        <span class="summary-label">Treatment</span>
        <span class="summary-value">${s.trialAvgAll !== null ? formatDecimal(s.trialAvgAll,1) + ' bu/ac' : 'n/a'}</span>
      </div>
      <div class="summary-pill">
        <span class="summary-label">Advantage</span>
        <span class="summary-value">${
          s.advantageAll !== null
            ? (s.advantageAll >= 0 ? '+' : '') + formatDecimal(s.advantageAll,1) + ' bu/ac'
            : 'n/a'
        }</span>
      </div>
    </div>

    <section class="section">
      <h2 class="section-title">Detail by farm and field</h2>
      <p class="section-sub">Fields are grouped by farm, then listed alphabetically by field name. Only fields currently included in the on-screen summary are shown.</p>

      ${farmEntries.map(([farmName, fList]) => {
        const rows = fList.map(f => {
          const d = f.data;
          const st = f.stats || {};
          const adv = typeof st.advantage === 'number'
            ? (st.advantage >= 0 ? '+' : '') + formatDecimal(st.advantage,1) + ' bu/ac'
            : 'n/a';
          const acParts = [];
          if (d.trialAcres != null) acParts.push(formatDecimal(d.trialAcres,1) + ' trial ac');
          if (d.tillable != null) acParts.push(formatDecimal(d.tillable,1) + ' tillable');
          const acresText = acParts.join(' / ');

          return `
            <tr>
              <td>${escapeHtml(d.fieldName || '')}</td>
              <td>${escapeHtml(acresText || '')}</td>
              <td class="cell-right">${st.checkAvg !== null ? formatDecimal(st.checkAvg,1) : ''}</td>
              <td class="cell-right">${st.trialAvg !== null ? formatDecimal(st.trialAvg,1) : ''}</td>
              <td class="cell-right">${adv}</td>
            </tr>
          `;
        }).join('');

        return `
          <div class="farm-block">
            <div class="farm-title">${escapeHtml(farmName || 'Unknown farm')}</div>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th style="width:40%">Field</th>
                    <th style="width:28%">Acres</th>
                    <th style="width:12%">Check bu/ac</th>
                    <th style="width:12%">Trial bu/ac</th>
                    <th style="width:8%">Adv.</th>
                  </tr>
                </thead>
                <tbody>
                  ${rows}
                </tbody>
              </table>
            </div>
          </div>
        `;
      }).join('')}
    </section>

    <footer class="report-footer">
      <div>Internal use only. Yields are summarized from trial yield blocks and may change as additional data is recorded.</div>
      <div>FarmVista • Field Trial Yield Summary • ${escapeHtml(runDateOnly || '')}</div>
    </footer>
  </div>
</body>
</html>`;
    }

    // UPDATED: use Cloud PDF helper if available, fallback to iframe + print
    async function runSummaryPrint(){
      if (!STATE.trialDoc){
        alert('Select a trial first, then choose Print / Save PDF.');
        return;
      }

      const company = await loadCompanyHeader();
      const now = new Date();
      const runStr = now.toLocaleString();
      const runDateOnly = now.toLocaleDateString();

      const activeFields = getActiveFields();
      const totals = computeTotalsFromFields(activeFields);

      const html = buildPrintHtml({
        company,
        runStr,
        runDateOnly,
        fields: activeFields,
        totals
      });

      const trialName = (STATE.trialDoc.trialName || 'Field Trial').toString();
      const safeName = trialName.replace(/[^a-z0-9]+/gi,'_').replace(/^_+|_+$/g,'') || 'field_trial';
      const fileName = `${safeName}_summary_${now.toISOString().slice(0,10)}.pdf`;

      // If Cloud PDF helper exists, use it (iOS-friendly)
      if (window.FVPdf && typeof window.FVPdf.openHtml === 'function') {
        try{
          window.FVPdf.openHtml({
            html,
            fileName,
            title: trialName
          });
          return;
        }catch(err){
          console.warn('[trial-summary] FVPdf.openHtml failed, falling back to native print()', err);
        }
      }

      // Fallback: iframe + native print
      let iframe = document.getElementById('fv-print-frame');
      if (!iframe){
        iframe = document.createElement('iframe');
        iframe.id = 'fv-print-frame';
        document.body.appendChild(iframe);
      }

      const win = iframe.contentWindow || iframe.contentDocument;
      const doc = iframe.contentDocument || iframe.contentWindow.document;

      doc.open();
      doc.write(html);
      doc.close();

      setTimeout(() => {
        try{
          win.focus();
          win.print();
        }catch(err){
          console.warn('[trial-summary-report] iframe print failed, falling back to window.print()', err);
          window.print();
        }
      }, 400);
    }

    /* ---------- AI summary ---------- */

    function kickOffAiSummary() {
      if (!els.aiSummary) return;

      if (!STATE.trialDoc) {
        els.aiSummary.innerHTML = '<div class="ai-summary-note">Select a trial above to generate a written summary of how the treatment performed.</div>';
        return;
      }

      if (!window.FVAiReports || typeof window.FVAiReports.renderTrialSummary !== 'function') {
        els.aiSummary.innerHTML = '<p class="ai-summary-error">AI helper script (ai-reports.js) is not available. The numeric summary above is still accurate.</p>';
        return;
      }

      const activeFields = getActiveFields();
      const payload = {
        trial: STATE.trialDoc,
        totals: STATE.totals,
        fields: activeFields.map(f => ({
          data: f.data,
          stats: f.stats
        }))
      };

      window.FVAiReports.renderTrialSummary(els.aiSummary, payload);
    }

    /* ---------- print modal + basic events ---------- */

    function openPrintModal(){
      if (!STATE.trialDoc){
        alert('Select a trial first, then choose Print / Save PDF.');
        return;
      }
      if (!els.printModalBackdrop) return;
      els.printModalBackdrop.classList.remove('modal-hidden');
      els.printModalBackdrop.setAttribute('aria-hidden','false');
    }

    function closePrintModal(){
      if (!els.printModalBackdrop) return;
      els.printModalBackdrop.classList.add('modal-hidden');
      els.printModalBackdrop.setAttribute('aria-hidden','true');
    }

    function wireBasicEvents() {
      if (els.btnBack) {
        els.btnBack.addEventListener('click', () => {
          location.href = '/Farm-vista/pages/reports/reports-predefined.html';
        });
      }

      if (els.btnPrint) {
        els.btnPrint.addEventListener('click', openPrintModal);
      }
      if (els.btnPrintBottom) {
        els.btnPrintBottom.addEventListener('click', openPrintModal);
      }

      if (els.modalClose) els.modalClose.addEventListener('click', closeFieldModal);
      if (els.modalBackdrop) {
        els.modalBackdrop.addEventListener('click', (evt) => {
          if (evt.target === els.modalBackdrop) closeFieldModal();
        });
      }

      if (els.photoViewerClose) {
        els.photoViewerClose.addEventListener('click', closePhotoViewer);
      }
      if (els.photoViewerBackdrop) {
        els.photoViewerBackdrop.addEventListener('click', (evt) => {
          if (evt.target === els.photoViewerBackdrop) {
            closePhotoViewer();
          }
        });
      }

      if (els.printModalClose){
        els.printModalClose.addEventListener('click', closePrintModal);
      }
      if (els.printModalBackdrop){
        els.printModalBackdrop.addEventListener('click', (evt) => {
          if (evt.target === els.printModalBackdrop) closePrintModal();
        });
      }
      if (els.printSummaryBtn){
        els.printSummaryBtn.addEventListener('click', async () => {
          closePrintModal();
          await runSummaryPrint();
        });
      }
      if (els.printDetailedBtn){
        els.printDetailedBtn.addEventListener('click', () => {
          closePrintModal();

          if (!STATE.trialId) {
            alert('Select a trial first, then choose Detailed report.');
            return;
          }

          const url = `/Farm-vista/pages/reports/reports-trial-detailed.html?trialId=${encodeURIComponent(STATE.trialId)}`;
          window.location.href = url;
        });
      }

      document.addEventListener('keydown', (evt) => {
        if (evt.key === 'Escape') {
          if (els.photoViewerBackdrop && !els.photoViewerBackdrop.classList.contains('modal-hidden')) {
            closePhotoViewer();
            return;
          }
          if (els.modalBackdrop && !els.modalBackdrop.classList.contains('modal-hidden')) {
            closeFieldModal();
            return;
          }
          if (els.printModalBackdrop && !els.printModalBackdrop.classList.contains('modal-hidden')) {
            closePrintModal();
          }
        }
      });

      if (els.filterYear) {
        els.filterYear.addEventListener('change', () => {
          STATE.selectedYear = els.filterYear.value || 'all';
          populateTrialFilter();
          clearTrialView();
        });
      }

      if (els.filterTrial) {
        els.filterTrial.addEventListener('change', async () => {
          const id = els.filterTrial.value || '';
          STATE.trialId = id || null;
          if (!STATE.trialId) {
            clearTrialView();
            return;
          }
          try{
            if (els.errorState){
              els.errorState.style.display = 'none';
              els.errorState.textContent = '';
            }
            if (els.metaLine) els.metaLine.textContent = 'Loading trial summary…';
            await loadTrialData(STATE.trialId);
            refreshSummaryFromSelection();
          }catch(err){
            console.error('Error loading selected trial:', err);
            clearTrialView();
            if (els.errorState){
              els.errorState.style.display = 'block';
              els.errorState.textContent = 'Error loading the selected trial. Check console or Firestore rules.';
            }
          }
        });
      }

      if (els.filterClear) {
        els.filterClear.addEventListener('click', () => {
          STATE.selectedYear = 'all';
          STATE.trialId = null;
          if (els.filterYear) els.filterYear.value = 'all';
          populateTrialFilter();
          if (els.filterTrial) els.filterTrial.value = '';
          clearTrialView();
        });
      }
    }

    /* ---------- boot ---------- */

    async function boot(){
      await ready;
      STATE.db = getFirestore();

      const shell = document.querySelector('fv-shell');
      if (shell) shell.nav = NAV_MENU;

      wireDom();
      wireBasicEvents();
      clearTrialView();

      try{
        await loadTrialList();
        populateYearFilter();
        populateTrialFilter();

        const fromUrl = getTrialIdFromUrl();
        if (fromUrl) {
          const match = STATE.trials.find(t => t.id === fromUrl);
          if (match) {
            const yr = match.data.cropYear;
            if (yr !== undefined && yr !== null) {
              STATE.selectedYear = String(yr);
              if (els.filterYear) els.filterYear.value = STATE.selectedYear;
              populateTrialFilter();
            }
            STATE.trialId = fromUrl;
            if (els.filterTrial) els.filterTrial.value = fromUrl;
            if (els.metaLine) els.metaLine.textContent = 'Loading trial from link…';
            await loadTrialData(fromUrl);
            refreshSummaryFromSelection();
          }
        }

        if (!STATE.trialId && els.metaLine){
          els.metaLine.textContent = STATE.trials.length
            ? 'Choose a crop year and trial to view yield summary.'
            : 'No active or completed trials are available yet.';
        }
      }catch(err){
        console.error('Error loading trial list:', err);
        if (els.errorState){
          els.errorState.style.display = 'block';
          els.errorState.textContent = 'Error loading trials. Check console or Firestore rules.';
        }
        if (els.metaLine) els.metaLine.textContent = 'Error loading trial list';
      }
    }

    boot().catch(console.error);
  </script>
</head>

<body>
  <fv-shell>
    <div class="wrap">
      <section class="hero">
        <header class="hero-head">
          <div class="icon" aria-hidden="true">🧪</div>
          <div>
            <h1 id="pageTitle">Field Trial Yield Summary</h1>
            <p id="pageSubtitle" class="muted">
              Choose a crop year and trial to view yield performance by field.
            </p>
            <p id="heroProducts" class="muted hero-products"></p>
          </div>
        </header>

        <div class="body">
          <div class="toolbar">
            <div class="toolbar-left">
              <button id="btnBack" type="button" class="btn btn-quiet">
                ← Back to Reports
              </button>
              <button id="btnPrint" type="button" class="btn btn-primary">
                Print / Save PDF
              </button>
            </div>
            <div class="page-header-meta" id="reportMeta">
              Loading trial list…
            </div>
          </div>

          <div class="filters" aria-label="Trial filters">
            <div class="filters-row">
              <div class="filter-field">
                <label class="filter-label" for="filterCropYear">Crop Year</label>
                <select id="filterCropYear" class="filter-select">
                  <option value="all">All years</option>
                </select>
              </div>

              <div class="filter-field filter-field--grow">
                <label class="filter-label" for="filterTrial">Trial</label>
                <select id="filterTrial" class="filter-select">
                  <option value="">Select a trial…</option>
                </select>
              </div>

              <button id="filterClear" type="button" class="btn btn-quiet">
                Clear
              </button>
            </div>
          </div>

          <section aria-label="Trial overview stats">
            <div id="top-stats" class="stats-grid" aria-live="polite"></div>
          </section>

          <section class="ai-card" aria-label="AI summary of this trial" aria-live="polite">
            <div class="ai-card-title">
              <span>Trial Story</span>
              <span class="ai-chip">AI Summary</span>
            </div>
            <div id="ai-summary" class="ai-summary-body">
              <div class="ai-summary-note">Select a trial above to generate a written summary of how the treatment performed.</div>
            </div>
          </section>

          <section class="farm-fields-block" aria-label="Fields in this trial">
            <div class="farm-fields-title">Farms &amp; fields in this trial</div>

            <div class="desktop-only">
              <div id="farms-container"></div>
            </div>

            <div class="mobile-only">
              <div id="farms-mobile-container" class="field-card-list"></div>
            </div>

            <div id="empty-state" class="wo-empty" style="display:none;">
              No trial is selected. Choose a crop year and trial above.
            </div>
            <div id="error-state" class="error-msg" style="display:none;"></div>
          </section>

          <section id="totals-card" class="totals-card" style="display:none;" aria-label="Overall trial totals">
            <div class="totals-row">
              <div class="totals-label">Overall Trial Totals (included fields only)</div>
              <div class="totals-metrics">
                <div class="totals-metric">
                  <span>Fields in summary</span>
                  <span id="tot-fields">–</span>
                </div>
                <div class="totals-metric">
                  <span>Tillable acres (included fields)</span>
                  <span id="tot-tillable">–</span>
                </div>
                <div class="totals-metric">
                  <span>Trial acres (with yield)</span>
                  <span id="tot-trial-acres">–</span>
                </div>
                <div class="totals-metric">
                  <span>Check weighted bu/ac</span>
                  <span id="tot-check-avg">–</span>
                </div>
                <div class="totals-metric">
                  <span>Treatment weighted bu/ac</span>
                  <span id="tot-trial-avg">–</span>
                </div>
                <div class="totals-metric">
                  <span>Treatment advantage (bu/ac)</span>
                  <span id="tot-adv">–</span>
                </div>
              </div>
            </div>
          </section>

          <div class="bottom-actions">
            <button id="btnPrintBottom" type="button" class="btn btn-primary">
              Print / Save PDF
            </button>
          </div>
        </div>
      </section>
    </div>
  </fv-shell>

  <!-- Field detail modal -->
  <div id="field-modal-backdrop" class="modal-backdrop modal-hidden" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="field-modal-title">
      <div class="modal-head">
        <div class="modal-title-row">
          <div>
            <div id="field-modal-title" class="modal-title">Field details</div>
            <div id="field-modal-sub" class="modal-sub"></div>
          </div>
          <button
            type="button"
            class="modal-close-btn"
            id="field-modal-close"
            aria-label="Close">
            ×
          </button>
        </div>
      </div>

      <div class="modal-body">
        <section>
          <div class="modal-section-title">Summary</div>
          <div class="modal-summary-grid" id="field-modal-summary"></div>
        </section>

        <section>
          <div class="modal-section-title">Yield blocks</div>

          <div class="blocks-table-wrap desktop-only">
            <table class="blocks-table">
              <thead>
                <tr>
                  <th>Block</th>
                  <th>Type</th>
                  <th class="numeric">Check bu/ac</th>
                  <th class="numeric">Trial bu/ac</th>
                  <th class="numeric">Check acres</th>
                  <th class="numeric">Trial acres</th>
                  <th>Notes</th>
                </tr>
              </thead>
              <tbody id="field-modal-blocks-body">
              </tbody>
            </table>
          </div>

          <div id="field-modal-blocks-cards" class="mobile-only block-card-list">
          </div>
        </section>

        <section>
          <div class="modal-section-title">Files &amp; photos</div>
          <div id="field-modal-files" class="thumb-grid"></div>
        </section>
      </div>
    </div>
  </div>

  <!-- Photo viewer modal -->
  <div id="photo-viewer-backdrop" class="modal-backdrop modal-hidden" aria-hidden="true">
    <div class="modal photo-modal" role="dialog" aria-modal="true" aria-labelledby="photo-viewer-caption">
      <div class="modal-head">
        <div class="modal-title-row">
          <div id="photo-viewer-caption" class="modal-title">File preview</div>
          <button
            type="button"
            class="modal-close-btn"
            id="photo-viewer-close"
            aria-label="Close image viewer">
            ×
          </button>
        </div>
      </div>
      <div class="modal-body photo-modal-body">
        <img id="photo-viewer-img" src="" alt="Trial file preview" />
      </div>
    </div>
  </div>

  <!-- Print-type chooser modal -->
  <div id="print-modal-backdrop" class="modal-backdrop modal-hidden" aria-hidden="true">
    <div class="modal print-modal" role="dialog" aria-modal="true" aria-labelledby="print-modal-title">
      <div class="modal-head print-modal-head">
        <div class="modal-title-row">
          <div>
            <div id="print-modal-title" class="print-modal-title">Choose report type</div>
            <div class="print-modal-sub">
              How do you want to print this trial?
            </div>
          </div>
          <button type="button" class="modal-close-btn" id="printModalClose" aria-label="Close">
            ×
          </button>
        </div>
      </div>
      <div class="print-modal-body">
        <p class="print-modal-note">
          Summary reports match your other FarmVista PDF reports and show trial-wide stats with a farm / field table.
          Detailed reports will drill into block-level data and notes.
        </p>
        <div class="print-modal-buttons">
          <button id="printSummaryBtn" type="button" class="btn btn-primary print-modal-btn">
            Summary report
          </button>
          <button id="printDetailedBtn" type="button" class="btn btn-quiet print-modal-btn">
            Detailed report
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Hidden iframe used for printing -->
  <iframe id="fv-print-frame"></iframe>
</body>
</html>
