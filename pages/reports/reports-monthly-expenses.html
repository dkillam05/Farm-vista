<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FarmVista • Monthly Expense Report</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    /* ---------- Base + page shell ---------- */
    :root{
      --fv-green: #3B7E46;
      --fv-gold:  #D0C542;
      --fv-border: #D1D5DB;
      --fv-text: #111827;
      --fv-muted: #6B7280;
      --fv-bg: #F3F4F6;
      --page-max: 900px;
    }

    *{ box-sizing:border-box; }

    html, body{
      margin:0;
      padding:0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color:var(--fv-text);
      background:var(--fv-bg);
    }

    body{
      display:flex;
      justify-content:center;
      padding:24px 12px;
    }

    .page{
      width:100%;
      max-width:var(--page-max);
      background:#fff;
      border-radius:12px;
      box-shadow:0 10px 30px rgba(15,23,42,0.15);
      padding:24px 28px 28px;
    }

    /* ---------- Header ---------- */
    .report-header{
      display:grid;
      grid-template-columns: auto 1fr auto;
      gap:16px;
      align-items:center;
      border-bottom:2px solid var(--fv-green);
      padding-bottom:14px;
      margin-bottom:18px;
    }

    .report-logo{
      width:64px;
      height:64px;
      border-radius:16px;
      border:1px solid var(--fv-border);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:26px;
      font-weight:800;
      color:#fff;
      background:radial-gradient(circle at 30% 0%, #4CAF50, var(--fv-green));
    }
    .report-logo span{
      letter-spacing:0.02em;
    }

    .company-block{
      min-width:0;
    }
    .company-name{
      font-size:18px;
      font-weight:800;
      margin:0 0 2px;
    }
    .company-line{
      font-size:12px;
      color:var(--fv-muted);
      margin:0;
    }

    .report-meta-top{
      text-align:right;
      font-size:11px;
      color:var(--fv-muted);
    }
    .report-meta-top strong{
      color:var(--fv-text);
    }

    /* ---------- Title + summary strip ---------- */
    .report-title-block{
      margin-bottom:16px;
    }

    .report-title{
      font-size:20px;
      font-weight:800;
      margin:4px 0 4px;
      letter-spacing:0.02em;
      text-transform:uppercase;
    }

    .report-subtitle{
      font-size:13px;
      color:var(--fv-muted);
      margin:0;
    }

    .report-summary-strip{
      margin-top:12px;
      padding:8px 10px;
      border-radius:10px;
      background:linear-gradient(90deg, rgba(59,126,70,0.08), transparent);
      border:1px solid rgba(59,126,70,0.20);
      font-size:11px;
      display:flex;
      flex-wrap:wrap;
      gap:6px 16px;
    }
    .summary-pill{
      display:inline-flex;
      align-items:center;
      gap:4px;
      white-space:nowrap;
    }
    .summary-label{
      text-transform:uppercase;
      letter-spacing:0.08em;
      font-weight:600;
      font-size:10px;
      color:var(--fv-muted);
    }
    .summary-value{
      font-weight:600;
      font-size:11px;
    }

    /* ---------- Sections ---------- */
    .section{
      margin-top:18px;
    }
    .section-title{
      font-size:13px;
      text-transform:uppercase;
      letter-spacing:0.12em;
      color:var(--fv-muted);
      margin:0 0 4px;
    }
    .section-heading-row{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
      margin-bottom:6px;
    }
    .section-heading-row .section-title-main{
      font-size:15px;
      font-weight:700;
      letter-spacing:0.03em;
      text-transform:uppercase;
    }
    .section-heading-row .section-note{
      font-size:11px;
      color:var(--fv-muted);
    }

    .section-body{
      font-size:12px;
      line-height:1.5;
    }

    /* ---------- Tables ---------- */
    .table-wrap{
      margin-top:6px;
      border-radius:10px;
      border:1px solid var(--fv-border);
      overflow:hidden;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
    }

    thead{
      background:#F9FAFB;
    }

    th, td{
      padding:6px 8px;
      border-bottom:1px solid #E5E7EB;
      text-align:left;
      vertical-align:top;
    }

    th{
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.08em;
      font-size:10px;
      color:#4B5563;
      border-bottom:1px solid #D1D5DB;
    }

    tr:nth-child(even) td{
      background:#F9FAFB;
    }

    .cell-right{ text-align:right; }
    .cell-center{ text-align:center; }
    .cell-muted{ color:var(--fv-muted); }

    /* ---------- Key metrics row ---------- */
    .kpi-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:6px;
    }

    .kpi-card{
      flex:1 1 140px;
      border-radius:10px;
      border:1px solid var(--fv-border);
      padding:8px 10px;
      background:linear-gradient(135deg, rgba(59,126,70,0.06), #ffffff);
    }
    .kpi-label{
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:var(--fv-muted);
      margin-bottom:2px;
    }
    .kpi-value{
      font-size:16px;
      font-weight:800;
    }
    .kpi-footnote{
      font-size:10px;
      color:var(--fv-muted);
      margin-top:2px;
    }

    /* ---------- Receipt gallery ---------- */
    .receipt-item{
      margin:8px 0 12px;
      font-size:11px;
    }
    .receipt-caption{
      color:var(--fv-muted);
      margin-bottom:3px;
    }
    .receipt-image{
      max-width:100%;
      max-height:420px;
      border-radius:6px;
      border:1px solid #E5E7EB;
      display:block;
    }

    /* ---------- Footer ---------- */
    .report-footer{
      margin-top:18px;
      padding-top:8px;
      border-top:1px solid var(--fv-border);
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:10px;
      color:var(--fv-muted);
    }
    .footer-left{
      max-width:60%;
    }
    .footer-right{
      text-align:right;
    }

    /* ---------- Print ---------- */
    @media print{
      html, body{
        background:#fff;
        padding:0;
      }
      body{
        box-shadow:none;
      }
      .page{
        max-width:none;
        border-radius:0;
        box-shadow:none;
        padding:12mm 14mm;
      }
    }
  </style>
</head>
<body>
  <!--
    EXPECTED DATA SHAPE (you overwrite window.FV_REPORT_DATA before DOMContentLoaded):

    window.FV_REPORT_DATA = {
      company: {
        name: 'Dowson Farms',
        street: '123 Farm Lane',
        city: 'Divernon',
        state: 'IL',
        zip: '62530',
        phone: '555-555-5555',
        email: 'office@example.com'
      },
      meta: {
        reportTitleShort: 'Monthly Expenses',
        reportTitle: 'Monthly Expense Report',
        reportSubtitle: 'Summary of farm expenditures for January 2025',
        runDateTime: '2025-01-31 09:42 AM',
        preparedBy: 'Dane Killam',
        monthLabel: 'January 2025',
        dateRange: 'Jan 1, 2025 – Jan 31, 2025',
        filterSummary: 'All farms · All categories',
        footerLeftText: 'Internal management report. For farm records only.',
        footerRightText: 'Monthly Expenses',
        runDate: '2025-01-31'
      },
      kpis: {
        note: 'All figures in USD.',
        totalSpendFormatted: '$123,456.78',
        avgPerDayFormatted: '$3,982.47',
        topCategoryLabel: 'Fuel & Lubricants'
      },
      expenses: [
        {
          date: '2025-01-02',
          vendor: 'Case IH Dealer',
          category: 'Repairs & Maintenance',
          method: 'Credit Card',
          amountFormatted: '$2,345.67',
          notes: 'Hydraulic hose replacement',
          receiptUrls: ['https://.../r1.jpg']
        }
      ],
      categories: [
        {
          category: 'Fuel & Lubricants',
          totalFormatted: '$45,000.00',
          pctFormatted: '36.5%',
          notes: ''
        }
      ]
    };
  -->
  <div class="page">
    <!-- HEADER -->
    <header class="report-header">
      <!-- Logo / initials -->
      <div class="report-logo">
        <span>DF</span>
      </div>

      <!-- Company info -->
      <div class="company-block">
        <p class="company-name" id="companyName"></p>
        <p class="company-line" id="companyLine"></p>
      </div>

      <!-- Meta (top-right) -->
      <div class="report-meta-top">
        <div><strong id="reportTitleShort"></strong></div>
        <div>Generated: <span id="runDateTime"></span></div>
        <div>Prepared by: <span id="preparedBy"></span></div>
      </div>
    </header>

    <!-- TITLE + SUMMARY -->
    <section class="report-title-block">
      <h1 class="report-title" id="reportTitle"></h1>
      <p class="report-subtitle" id="reportSubtitle"></p>

      <div class="report-summary-strip">
        <div class="summary-pill">
          <span class="summary-label">Month</span>
          <span class="summary-value" id="monthLabel"></span>
        </div>
        <div class="summary-pill">
          <span class="summary-label">Date range</span>
          <span class="summary-value" id="dateRange"></span>
        </div>
        <div class="summary-pill">
          <span class="summary-label">Filters</span>
          <span class="summary-value" id="filterSummary"></span>
        </div>
        <div class="summary-pill">
          <span class="summary-label">Expenses</span>
          <span class="summary-value" id="expenseCount"></span>
        </div>
      </div>
    </section>

    <!-- KEY METRICS -->
    <section class="section">
      <div class="section-heading-row">
        <div class="section-title-main">Key Metrics</div>
        <div class="section-note" id="kpiNote"></div>
      </div>
      <div class="kpi-row">
        <div class="kpi-card">
          <div class="kpi-label">Total Spend</div>
          <div class="kpi-value" id="kpiTotalSpend"></div>
          <div class="kpi-footnote">Total expenses recorded for this month</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Average Per Day</div>
          <div class="kpi-value" id="kpiAvgPerDay"></div>
          <div class="kpi-footnote">Average daily spend across the selected date range</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Largest Category</div>
          <div class="kpi-value" id="kpiTopCategory"></div>
          <div class="kpi-footnote">Category with the highest total spend</div>
        </div>
      </div>
    </section>

    <!-- MAIN TABLE SECTION -->
    <section class="section">
      <h2 class="section-title">Detail</h2>
      <div class="section-body">
        <p id="detailIntroText"></p>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Vendor / Merchant</th>
                <th>Category</th>
                <th>Payment Method</th>
                <th class="cell-right">Amount</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody id="expenseTableBody">
              <!-- Populated by JS -->
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- CATEGORY BREAKDOWN -->
    <section class="section">
      <div class="section-heading-row">
        <div class="section-title-main">Category Breakdown</div>
        <div class="section-note" id="section2Note"></div>
      </div>
      <div class="section-body">
        <p id="section2BodyText"></p>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Category</th>
                <th class="cell-right">Total Amount</th>
                <th class="cell-center">% of Month Total</th>
                <th>Notes</th>
              </tr>
            </thead>
            <tbody id="categoryTableBody">
              <!-- Populated by JS -->
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- RECEIPT IMAGES -->
    <section class="section">
      <div class="section-heading-row">
        <div class="section-title-main">Receipt Images</div>
        <div class="section-note">Saved attachments for this month</div>
      </div>
      <div class="section-body" id="receiptGallery">
        <!-- Populated by JS -->
      </div>
    </section>

    <!-- FOOTER -->
    <footer class="report-footer">
      <div class="footer-left" id="footerLeftText"></div>
      <div class="footer-right">
        FarmVista • <span id="footerRightText"></span> • <span id="runDate"></span>
      </div>
    </footer>
  </div>

  <script>
    // If backend doesn't overwrite this, use an empty default so it still renders a "no data" report
    window.FV_REPORT_DATA = window.FV_REPORT_DATA || {
      company: {},
      meta: {},
      kpis: {},
      expenses: [],
      categories: []
    };

    function text(id, value) {
      var el = document.getElementById(id);
      if (el) el.textContent = value || '';
    }

    document.addEventListener('DOMContentLoaded', function () {
      var data = window.FV_REPORT_DATA || {};
      var company = data.company || {};
      var meta = data.meta || {};
      var kpis = data.kpis || {};
      var expenses = Array.isArray(data.expenses) ? data.expenses : [];
      var categories = Array.isArray(data.categories) ? data.categories : [];

      // Header / company
      text('companyName', company.name || '');
      text('companyLine', [
        company.street,
        company.city && company.state ? company.city + ', ' + company.state : company.city || company.state,
        company.zip
      ].filter(Boolean).join(' · ') +
      (company.phone || company.email ? '\nPhone: ' + (company.phone || '-') + ' · Email: ' + (company.email || '-') : ''));

      // Meta
      text('reportTitleShort', meta.reportTitleShort || 'Monthly Expenses');
      text('reportTitle', meta.reportTitle || 'Monthly Expense Report');
      text('reportSubtitle', meta.reportSubtitle || '');
      text('runDateTime', meta.runDateTime || '');
      text('preparedBy', meta.preparedBy || '');
      text('monthLabel', meta.monthLabel || '');
      text('dateRange', meta.dateRange || '');
      text('filterSummary', meta.filterSummary || 'No additional filters');
      text('expenseCount', String(expenses.length || 0));

      // KPIs
      text('kpiNote', kpis.note || 'All figures in USD.');
      text('kpiTotalSpend', kpis.totalSpendFormatted || (expenses.length ? '—' : '$0.00'));
      text('kpiAvgPerDay', kpis.avgPerDayFormatted || (expenses.length ? '—' : '$0.00'));
      text('kpiTopCategory', kpis.topCategoryLabel || (expenses.length ? '—' : 'None'));

      // Detail intro text
      if (expenses.length) {
        text('detailIntroText', 'Detailed list of all recorded expenditures for ' + (meta.monthLabel || 'this period') + '.');
      } else {
        text('detailIntroText', 'No expenditures were recorded for ' + (meta.monthLabel || 'this period') + '.');
      }

      // Section 2 text
      text('section2Note', expenses.length ? 'Breakdown of spending by category.' : 'No category data available (no expenditures).');
      if (expenses.length) {
        text('section2BodyText', 'Categories ranked by total dollars spent for ' + (meta.monthLabel || 'this period') + '.');
      } else {
        text('section2BodyText', 'No expenditures were recorded, so there is no category breakdown to display.');
      }

      // Footer
      text('footerLeftText', meta.footerLeftText || '');
      text('footerRightText', meta.footerRightText || 'Monthly Expenses');
      text('runDate', meta.runDate || '');

      // Build expense table
      var expenseBody = document.getElementById('expenseTableBody');
      if (expenseBody) {
        expenseBody.innerHTML = '';
        if (!expenses.length) {
          var tr = document.createElement('tr');
          var td = document.createElement('td');
          td.colSpan = 6;
          td.className = 'cell-center cell-muted';
          td.textContent = 'No expenditures recorded for ' + (meta.monthLabel || 'this period') + '.';
          tr.appendChild(td);
          expenseBody.appendChild(tr);
        } else {
          expenses.forEach(function (e) {
            var tr = document.createElement('tr');

            var tdDate = document.createElement('td');
            tdDate.textContent = e.date || '';
            tr.appendChild(tdDate);

            var tdVendor = document.createElement('td');
            tdVendor.textContent = e.vendor || '';
            tr.appendChild(tdVendor);

            var tdCat = document.createElement('td');
            tdCat.textContent = e.category || '';
            tr.appendChild(tdCat);

            var tdMethod = document.createElement('td');
            tdMethod.textContent = e.method || '';
            tr.appendChild(tdMethod);

            var tdAmt = document.createElement('td');
            tdAmt.className = 'cell-right';
            tdAmt.textContent = e.amountFormatted || '';
            tr.appendChild(tdAmt);

            var tdNotes = document.createElement('td');
            tdNotes.textContent = e.notes || '';
            tr.appendChild(tdNotes);

            expenseBody.appendChild(tr);
          });
        }
      }

      // Build category table
      var catBody = document.getElementById('categoryTableBody');
      if (catBody) {
        catBody.innerHTML = '';
        if (!categories.length) {
          var trc = document.createElement('tr');
          var tdc = document.createElement('td');
          tdc.colSpan = 4;
          tdc.className = 'cell-center cell-muted';
          tdc.textContent = expenses.length
            ? 'No category breakdown available.'
            : 'No expenditures recorded, so there is no category breakdown.';
          trc.appendChild(tdc);
          catBody.appendChild(trc);
        } else {
          categories.forEach(function (c) {
            var tr = document.createElement('tr');

            var tdCatName = document.createElement('td');
            tdCatName.textContent = c.category || '';
            tr.appendChild(tdCatName);

            var tdTotal = document.createElement('td');
            tdTotal.className = 'cell-right';
            tdTotal.textContent = c.totalFormatted || '';
            tr.appendChild(tdTotal);

            var tdPct = document.createElement('td');
            tdPct.className = 'cell-center';
            tdPct.textContent = c.pctFormatted || '';
            tr.appendChild(tdPct);

            var tdNotes = document.createElement('td');
            tdNotes.textContent = c.notes || '';
            tr.appendChild(tdNotes);

            catBody.appendChild(tr);
          });
        }
      }

      // Build receipt gallery from expenses.receiptUrls
      var gallery = document.getElementById('receiptGallery');
      if (gallery) {
        gallery.innerHTML = '';
        var anyReceipts = false;

        expenses.forEach(function (e) {
          var urls = Array.isArray(e.receiptUrls) ? e.receiptUrls : [];
          urls.forEach(function (url, idx) {
            if (!url) return;
            anyReceipts = true;
            var wrap = document.createElement('div');
            wrap.className = 'receipt-item';

            var cap = document.createElement('div');
            cap.className = 'receipt-caption';
            var captionParts = [];
            if (e.date) captionParts.push(e.date);
            if (e.vendor) captionParts.push(e.vendor);
            if (e.amountFormatted) captionParts.push(e.amountFormatted);
            cap.textContent = captionParts.join(' • ') || 'Receipt';
            wrap.appendChild(cap);

            var img = document.createElement('img');
            img.className = 'receipt-image';
            img.src = url;
            img.alt = 'Receipt image';
            wrap.appendChild(img);

            gallery.appendChild(wrap);
          });
        });

        if (!anyReceipts) {
          var p = document.createElement('p');
          p.className = 'cell-muted';
          p.style.fontSize = '11px';
          p.textContent = 'No receipt images saved for this month.';
          gallery.appendChild(p);
        }
      }

      // Auto-open print dialog once everything is rendered
      setTimeout(function () {
        window.focus();
        window.print();
      }, 300);
    });
  </script>
</body>
</html>

