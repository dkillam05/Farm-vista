<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FarmVista • Trial Detailed Packet</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#3B7E46" />

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest" />
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png" />
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png" />
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css" />
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css" />
  <!-- Shared PDF helper (Cloud Run) -->
  <script src="/Farm-vista/js/fv-pdf.js"></script>

  <style>
    :root{
      --card-max: 1200px;
      --page-bottom-gap: 56px;
      --accent: #2F6C3C;
    }

    html,
    body{
      margin:0;
      padding:0;
      max-width:100%;
      overflow-x:hidden;
      background: var(--app-bg, var(--surface));
    }

    .wrap{
      max-width: var(--card-max);
      margin: 0 auto;
      padding: clamp(12px,3vw,20px);
      padding-bottom: calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + var(--page-bottom-gap)) !important;
      box-sizing:border-box;
      overflow-x:hidden;
      display:grid;
      gap:16px;
    }

    .hero{
      border:1px solid var(--border);
      border-radius:18px;
      background:var(--surface);
      box-shadow:var(--shadow,0 12px 28px rgba(0,0,0,.12));
      overflow:visible;
    }

    .hero-head{
      display:flex;
      align-items:flex-start;
      gap:12px;
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);
    }
    .hero-head .icon{
      width:24px;
      height:24px;
      color:var(--accent);
      display:grid;
      place-items:center;
      margin-top:2px;
    }
    .hero-head h1{
      margin:0;
      font-size:clamp(20px,3.2vw,26px);
      line-height:1.2;
    }
    .muted{color:var(--muted,#67706B);}

    /* New: hero-level products line */
    .hero-products{
      margin:2px 0 0;
      font-size:0.82rem;
    }

    .body{
      padding:16px;
      display:grid;
      gap:14px;
    }

    .toolbar{
      display:flex;
      flex-wrap:wrap;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px 16px;
    }
    .toolbar-left{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:140px;
      padding:11px 16px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--card-surface,var(--surface));
      font-weight:800;
      font-size:0.95rem;
      text-decoration:none;
      cursor:pointer;
      user-select:none;
      color:var(--text)!important;
      gap:6px;
    }
    .btn-primary{
      border-color:transparent;
      background:#2F6C3C;
      color:#fff!important;
    }
    .btn-quiet{
      min-width:auto;
      padding-inline:10px;
    }

    /* Mobile-only PDF button — hidden by default on desktop */
    .btn-pdf-mobile{
      display:none;
    }

    .page-header-meta{
      font-size:0.9rem;
      opacity:0.8;
      text-align:right;
    }

    /* Field selection panel */
    .field-select-panel{
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--card-surface,var(--surface));
      padding:12px 14px;
      display:grid;
      gap:10px;
      font-size:0.86rem;
    }
    .field-select-header{
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:flex-end;
      flex-wrap:wrap;
    }
    .field-select-title{
      font-weight:600;
      font-size:0.9rem;
    }
    .field-select-note{
      font-size:0.78rem;
      opacity:0.78;
    }
    .field-select-actions{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }
    .field-select-actions button{
      min-width:auto;
      padding-inline:10px;
      font-size:0.78rem;
    }

    .field-select-table-wrap{
      max-height:360px;
      overflow:auto;
      border-radius:10px;
      border:1px solid var(--border-subtle,var(--border));
    }
    table.field-select-table{
      width:100%;
      border-collapse:collapse;
      font-size:0.8rem;
    }
    table.field-select-table th,
    table.field-select-table td{
      padding:6px 8px;
      border-bottom:1px solid var(--border-subtle,#E5E7EB);
      text-align:left;
      vertical-align:top;
    }
    table.field-select-table th{
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.06em;
      font-size:0.7rem;
      color:var(--muted,#4B5563);
      background:var(--surface-alt,#F9FAFB);
      position:sticky;
      top:0;
      z-index:1;
    }
    table.field-select-table tr:nth-child(even) td{
      background:var(--surface-subtle,#F9FAFB);
    }
    table.field-select-table td.numeric{
      text-align:right;
      white-space:nowrap;
    }
    .field-name-main{
      font-weight:600;
      font-size:0.86rem;
    }
    .field-name-sub{
      font-size:0.75rem;
      opacity:0.78;
    }

    .bottom-actions{
      margin-top:4px;
      display:flex;
      justify-content:flex-end;
      gap:8px;
      flex-wrap:wrap;
    }

    .status-line{
      font-size:0.82rem;
      opacity:0.8;
    }
    .status-error{
      color:var(--danger,#A33A3A);
      opacity:1;
    }

    @media (max-width:640px){
      .wrap{
        padding-inline:10px;
      }
      .toolbar{
        flex-direction:column;
        align-items:stretch;
        gap:8px;
      }
      .toolbar-left{
        width:100%;
        justify-content:stretch;
      }
      .toolbar-left .btn{
        flex:1 1 auto;
        width:100%;
        justify-content:center;
      }
      .page-header-meta{
        text-align:left;
      }
      .bottom-actions .btn{
        flex:1 1 auto;
        width:100%;
        justify-content:center;
      }

      /* On mobile, hide the desktop print button and show the phone PDF button */
      #btnPrint{
        display:none;
      }
      .btn-pdf-mobile{
        display:inline-flex;
      }
    }

    /* Hidden iframe for print (desktop) */
    #fv-print-frame{
      position:fixed;
      right:0;
      bottom:0;
      width:0;
      height:0;
      border:0;
      visibility:hidden;
    }

    /* ------------------------------------------------------------------
       Mobile PDF "Preparing..." overlay
       ------------------------------------------------------------------ */
    .pdf-loading{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.35);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:9999;
      padding:16px;
    }
    .pdf-loading.hidden{
      display:none;
    }
    .pdf-loading-inner{
      max-width:260px;
      width:100%;
      border-radius:16px;
      background:var(--surface,#ffffff);
      padding:16px 18px 14px;
      box-shadow:0 18px 45px rgba(0,0,0,0.26);
      text-align:center;
    }
    .pdf-loading-spinner{
      width:32px;
      height:32px;
      border-radius:999px;
      border:3px solid rgba(0,0,0,0.12);
      border-top-color:var(--accent,#2F6C3C);
      margin:0 auto 10px;
      animation:pdf-spin 0.8s linear infinite;
    }
    .pdf-loading-text{
      font-size:0.95rem;
      font-weight:600;
      color:var(--text,#111827);
      margin:0;
    }
    .pdf-loading-sub{
      font-size:0.78rem;
      margin-top:4px;
      color:var(--muted,#67706B);
    }
    @keyframes pdf-spin{
      to{
        transform:rotate(360deg);
      }
    }
  </style>

  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true;
        document.head.appendChild(s);
      }
    })();
  </script>

  <script type="module">
    import {
      ready,
      getFirestore,
      doc,
      getDoc,
      collection,
      getDocs
    } from '/Farm-vista/js/firebase-init.js';

    import { NAV_MENU } from '/Farm-vista/js/menu.js';

    const CONFIG = {
      COMPANY_DOC_PATH: ['company','main']
    };

    const $  = (sel, root=document) => root.querySelector(sel);

    const STATE = {
      db: null,
      trialId: null,
      trialDoc: null,
      fields: [],    // [{id, data, blocks, stats}]
      totals: {
        fieldCount: 0,
        tillableAll: 0,
        checkAcresAll: 0,
        trialAcresAll: 0,
        checkAvgAll: null,
        trialAvgAll: null,
        advantageAll: null
      },
      company: null
    };

    const els = {
      title: null,
      subtitle: null,
      heroProducts: null,
      metaLine: null,
      btnBack: null,
      btnPrint: null,
      btnPdfPhone: null,
      statusLine: null,
      fieldTableBody: null,
      iframe: null,
      pdfLoading: null
    };

    /* ---------- helpers ---------- */

    function getTrialIdFromUrl(){
      const params = new URLSearchParams(window.location.search);
      return params.get('trialId') || params.get('id');
    }

    function isMobileLike(){
      const ua = (navigator.userAgent || '').toLowerCase();
      return /iphone|ipad|ipod|android|mobi/.test(ua);
    }

    function isPdfPreview(){
      const params = new URLSearchParams(window.location.search);
      return params.get('pdfPreview') === '1';
    }

    function formatNumber(num, opts = {}) {
      if (num === null || num === undefined || Number.isNaN(num)) return '–';
      const { decimals = 1 } = opts;
      return Number(num).toLocaleString(undefined, {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
      });
    }

    function formatInt(n){
      const num = Number(n);
      if(!Number.isFinite(num)) return '0';
      return num.toLocaleString();
    }

    function formatDecimal(n, digits=1){
      const num = Number(n);
      if(!Number.isFinite(num)) return '';
      return num.toLocaleString(undefined, {
        maximumFractionDigits:digits,
        minimumFractionDigits:digits
      });
    }

    function escapeHtml(str){
      return String(str || '').replace(/[&<>"']/g, m => (
        { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]
      ));
    }

    function formatDate(value){
      if (!value) return '';
      try{
        let d = value;
        if (typeof d === 'object' && typeof d.toDate === 'function') {
          d = d.toDate();
        } else if (typeof d === 'string') {
          d = new Date(d);
        }
        if (d instanceof Date && !Number.isNaN(d.getTime())) {
          return d.toLocaleDateString();
        }
      }catch(e){
        console.warn('[trial-detailed] formatDate error', e);
      }
      return '';
    }

    function computeFieldStats(blocks = []) {
      let checkAc = 0, trialAc = 0, checkBu = 0, trialBu = 0;

      for (const b of blocks) {
        const c = b.check || {};
        const t = b.trial || {};
        if (typeof c.acres === 'number' && typeof c.yieldBuAc === 'number') {
          checkAc += c.acres;
          checkBu += c.yieldBuAc * c.acres;
        }
        if (typeof t.acres === 'number' && typeof t.yieldBuAc === 'number') {
          trialAc += t.acres;
          trialBu += t.yieldBuAc * t.acres;
        }
      }

      const checkAvg = checkAc > 0 ? (checkBu / checkAc) : null;
      const trialAvg = trialAc > 0 ? (trialBu / trialAc) : null;
      const advantage = (checkAvg !== null && trialAvg !== null) ? (trialAvg - checkAvg) : null;

      return { checkAc, trialAc, checkAvg, trialAvg, advantage };
    }

    async function loadCompanyHeader(){
      if (STATE.company) return STATE.company;
      try{
        const [col,id] = CONFIG.COMPANY_DOC_PATH;
        const ref = doc(STATE.db, col, id);
        const snap = await getDoc(ref);
        const d = snap.exists() ? (snap.data() || {}) : {};
        const name = d.name || '';
        const address = [
          d.addressStreet || '',
          [d.addressCity, d.addressState].filter(Boolean).join(', '),
          d.addressZip || ''
        ].filter(Boolean).join(' · ');
        const phone = d.phone || '';
        const email = d.email || '';
        STATE.company = { name, address, phone, email };
      }catch(e){
        console.warn('[trial-detailed] failed to load company header', e);
        STATE.company = { name:'', address:'', phone:'', email:'' };
      }
      return STATE.company;
    }

    function wireDom(){
      els.title          = $('#pageTitle');
      els.subtitle       = $('#pageSubtitle');
      els.heroProducts   = $('#heroProducts');
      els.metaLine       = $('#pageMeta');
      els.btnBack        = $('#btnBack');
      els.btnPrint       = $('#btnPrint');
      els.btnPdfPhone    = $('#btnPdfPhone');
      els.statusLine     = $('#statusLine');
      els.fieldTableBody = $('#fieldTableBody');
      els.iframe         = $('#fv-print-frame');
      els.pdfLoading     = $('#pdfLoading');
    }

    function setPdfLoading(active){
      if (!els.pdfLoading) return;
      if (active){
        els.pdfLoading.classList.remove('hidden');
        els.pdfLoading.setAttribute('aria-hidden','false');
      } else {
        els.pdfLoading.classList.add('hidden');
        els.pdfLoading.setAttribute('aria-hidden','true');
      }
    }

    /* ---------- data loading ---------- */

    async function loadTrialData(trialId){
      if (!trialId) throw new Error('Missing trialId');

      const trialRef = doc(STATE.db, 'fieldTrials', trialId);
      const trialSnap = await getDoc(trialRef);
      if (!trialSnap.exists()) {
        throw new Error('Trial not found');
      }

      const trialData = trialSnap.data() || {};
      STATE.trialDoc = { id: trialSnap.id, ...trialData };

      const fieldsCol = collection(trialRef, 'fields');
      const fieldsSnap = await getDocs(fieldsCol);

      const fieldRecords = [];

      for (const fieldDoc of fieldsSnap.docs) {
        const fieldData = fieldDoc.data() || {};

        const blocksCol = collection(fieldDoc.ref, 'yieldBlocks');
        const blocksSnap = await getDocs(blocksCol);
        const blocks = blocksSnap.docs.map(d => ({ id: d.id, ...d.data() }));

        const stats = computeFieldStats(blocks);

        fieldRecords.push({
          id: fieldDoc.id,
          data: fieldData,
          blocks,
          stats
        });
      }

      // sort fields by farmName, then fieldName
      fieldRecords.sort((a,b) => {
        const af = (a.data.farmName || '').toString();
        const bf = (b.data.farmName || '').toString();
        if (af !== bf) return af.localeCompare(bf);
        const an = (a.data.fieldName || '').toString();
        const bn = (b.data.fieldName || '').toString();
        return an.localeCompare(bn);
      });

      STATE.fields = fieldRecords;

      // compute trial totals (same math as summary report)
      let tillableAll = 0;
      let checkAcresAll = 0;
      let trialAcresAll = 0;
      let checkBuAll = 0;
      let trialBuAll = 0;

      for (const f of STATE.fields) {
        const d = f.data || {};
        const s = f.stats || {};
        if (typeof d.tillable === 'number') tillableAll += d.tillable;

        if (s.checkAc > 0 && s.checkAvg !== null) {
          checkAcresAll += s.checkAc;
          checkBuAll += s.checkAc * s.checkAvg;
        }
        if (s.trialAc > 0 && s.trialAvg !== null) {
          trialAcresAll += s.trialAc;
          trialBuAll += s.trialAc * s.trialAvg;
        }
      }

      const checkAvgAll = checkAcresAll > 0 ? (checkBuAll / checkAcresAll) : null;
      const trialAvgAll = trialAcresAll > 0 ? (trialBuAll / trialAcresAll) : null;
      const advantageAll = (checkAvgAll !== null && trialAvgAll !== null)
        ? (trialAvgAll - checkAvgAll)
        : null;

      STATE.totals = {
        fieldCount: STATE.fields.length,
        tillableAll,
        checkAcresAll,
        trialAcresAll,
        checkAvgAll,
        trialAvgAll,
        advantageAll
      };
    }

    /* ---------- render selection UI ---------- */

    function renderHeader(){
      const t = STATE.trialDoc || {};
      if (els.title) els.title.textContent = t.trialName || 'Trial Detailed Packet';

      const bits = [];
      if (t.cropYear) bits.push(t.cropYear);
      if (t.crop) bits.push(t.crop);
      if (t.trialType) bits.push(t.trialType);
      if (t.operationTask) bits.push(t.operationTask);
      if (els.subtitle) els.subtitle.textContent =
        bits.join(' • ') || 'Trial summary plus one page per yield block.';

      if (els.metaLine) {
        els.metaLine.textContent =
          'Check the fields you want. The packet will include a trial summary plus one page per yield block for each checked field.';
      }

      // New: Hero products line (on-screen)
      const checkProduct = t.checkProduct || t.check || '';
      const trialProduct = t.trialProduct || t.treatmentProduct || '';
      if (els.heroProducts){
        if (checkProduct || trialProduct){
          const parts = [];
          if (checkProduct) parts.push(`Check product: ${checkProduct}`);
          if (trialProduct) parts.push(`Trial product: ${trialProduct}`);
          els.heroProducts.textContent = parts.join(' • ');
        } else {
          els.heroProducts.textContent = '';
        }
      }
    }

    function renderFieldSelection(){
      if (!els.fieldTableBody) return;

      const rows = STATE.fields.map((f, idx) => {
        const d = f.data || {};
        const s = f.stats || {};
        const farmName = d.farmName || 'Unknown farm';
        const fieldName = d.fieldName || '(Unnamed field)';
        const trialAc = typeof d.trialAcres === 'number'
          ? formatNumber(d.trialAcres, {decimals:1})
          : '–';
        const tillable = typeof d.tillable === 'number'
          ? formatNumber(d.tillable, {decimals:1})
          : '–';

        const advText = s.advantage !== null
          ? `${s.advantage >= 0 ? '+' : ''}${formatNumber(s.advantage,{decimals:1})}`
          : '–';

        const includeId = `include-field-${idx}`;
        const checkedAttr = 'checked'; // default: all included

        return `
          <tr data-field-id="${f.id}">
            <td>
              <label class="field-name-main" for="${includeId}">
                <input type="checkbox" id="${includeId}" class="js-include-field" data-field-id="${f.id}" ${checkedAttr} />
                ${escapeHtml(fieldName)}
              </label>
              <div class="field-name-sub">
                ${escapeHtml(farmName)} • Trial: ${trialAc} ac • Tillable: ${tillable} ac
              </div>
            </td>
            <td class="numeric">${s.checkAvg !== null ? formatNumber(s.checkAvg,{decimals:1}) : '–'}</td>
            <td class="numeric">${s.trialAvg !== null ? formatNumber(s.trialAvg,{decimals:1}) : '–'}</td>
            <td class="numeric">${advText}</td>
          </tr>
        `;
      }).join('');

      els.fieldTableBody.innerHTML = rows || `
        <tr><td colspan="4">No fields with yield blocks were found for this trial.</td></tr>
      `;
    }

    function getSelectedFields(){
      const cbs = Array.from(document.querySelectorAll('.js-include-field'));
      const selectedIds = cbs
        .filter(cb => cb.checked)
        .map(cb => cb.getAttribute('data-field-id'));
      if (!selectedIds.length) return [];
      return STATE.fields.filter(f => selectedIds.includes(f.id));
    }

    function wireSelectionActions(){
      const btnAllFields = $('#btnAllFields');
      const btnNoFields  = $('#btnNoFields');

      if (btnAllFields){
        btnAllFields.addEventListener('click', () => {
          document.querySelectorAll('.js-include-field').forEach(cb => { cb.checked = true; });
        });
      }
      if (btnNoFields){
        btnNoFields.addEventListener('click', () => {
          document.querySelectorAll('.js-include-field').forEach(cb => { cb.checked = false; });
        });
      }
    }

    /* ---------- build MULTI-FIELD, MULTI-BLOCK print HTML ---------- */

    function buildDetailedPrintHtml({ company, runStr, runDateOnly, fields }) {
      const t = STATE.trialDoc || {};
      const allFields = Array.isArray(fields) && fields.length ? fields : [];

      // recompute totals using only selected fields
      let fieldCount = allFields.length;
      let tillableAll = 0;
      let checkAcresAll = 0;
      let trialAcresAll = 0;
      let checkBuAll = 0;
      let trialBuAll = 0;

      for (const f of allFields) {
        const d = f.data || {};
        const s = f.stats || {};
        if (typeof d.tillable === 'number') tillableAll += d.tillable;

        if (s.checkAc > 0 && s.checkAvg !== null) {
          checkAcresAll += s.checkAc;
          checkBuAll += s.checkAc * s.checkAvg;
        }
        if (s.trialAc > 0 && s.trialAvg !== null) {
          trialAcresAll += s.trialAc;
          trialBuAll += s.trialAc * s.trialAvg;
        }
      }

      const checkAvgAll = checkAcresAll > 0 ? (checkBuAll / checkAcresAll) : null;
      const trialAvgAll = trialAcresAll > 0 ? (trialBuAll / trialAcresAll) : null;
      const advantageAll = (checkAvgAll !== null && trialAvgAll !== null)
        ? (trialAvgAll - checkAvgAll)
        : null;

      const totals = {
        fieldCount,
        tillableAll,
        checkAcresAll,
        trialAcresAll,
        checkAvgAll,
        trialAvgAll,
        advantageAll
      };

      // Build field summary rows
      const fieldRowsHtml = allFields.map(f => {
        const d = f.data || {};
        const s = f.stats || {};
        const farmName = d.farmName || 'Unknown farm';
        const fieldName = d.fieldName || '(Unnamed field)';
        const trialAc = typeof d.trialAcres === 'number'
          ? formatDecimal(d.trialAcres,1)
          : '–';
        const tillable = typeof d.tillable === 'number'
          ? formatDecimal(d.tillable,1)
          : '–';
        const checkAvg = s.checkAvg !== null ? formatDecimal(s.checkAvg,1) : '–';
        const trialAvg = s.trialAvg !== null ? formatDecimal(s.trialAvg,1) : '–';
        const advText = s.advantage !== null
          ? (s.advantage >= 0 ? '+' : '') + formatDecimal(s.advantage,1)
          : '–';

        return `
          <tr>
            <td>
              ${escapeHtml(fieldName)}<br>
              <span class="muted-small">${escapeHtml(farmName)}</span>
            </td>
            <td class="cell-right">
              ${
                [
                  trialAc !== '–' ? trialAc + ' trial ac' : '',
                  tillable !== '–' ? tillable + ' tillable' : ''
                ].filter(Boolean).join(' / ') || '–'
              }
            </td>
            <td class="cell-right">${checkAvg}</td>
            <td class="cell-right">${trialAvg}</td>
            <td class="cell-right">${advText}</td>
          </tr>
        `;
      }).join('') || `
        <tr><td colspan="5">No fields selected.</td></tr>
      `;

      // New: pull product names from the trial document
      const checkProductName = (t.checkProduct || t.check || '').toString();
      const trialProductName = (t.trialProduct || t.treatmentProduct || '').toString();

      /* ---------- PAGE 1: TRIAL SUMMARY COVER ---------- */

      const coverHtml = `
<section class="page">
  <div class="page-inner">
    <header class="report-header">
      <div class="report-logo"><span>DF</span></div>
      <div class="company-block">
        <p class="company-name">${escapeHtml(company.name || '')}</p>
        <p class="company-line">
          ${company.address ? escapeHtml(company.address) + '<br>' : ''}
          ${company.phone ? 'Phone: ' + escapeHtml(company.phone) : ''}${company.phone && company.email ? ' · ' : ''}
          ${company.email ? 'Email: ' + escapeHtml(company.email) : ''}
        </p>
      </div>
      <div class="report-meta-top">
        <div><strong>Field Trial Detailed Packet</strong></div>
        <div>Generated: ${escapeHtml(runStr)}</div>
        <div>Prepared by: ${escapeHtml(company.name || 'FarmVista')}</div>
      </div>
    </header>

    <h1 class="report-title">${escapeHtml(t.trialName || 'Field Trial')}</h1>
    <p class="report-subtitle">
      ${escapeHtml([t.cropYear, t.crop, t.trialType].filter(Boolean).join(' • '))}
      ${t.operationTask ? ' • ' + escapeHtml(t.operationTask) : ''}
    </p>

    ${
      (checkProductName || trialProductName)
        ? `<p class="report-products">
            ${checkProductName
              ? '<strong>Check product:</strong> ' + escapeHtml(checkProductName)
              : ''}
            ${
              checkProductName && trialProductName
                ? ' &nbsp;•&nbsp; '
                : ''
            }
            ${trialProductName
              ? '<strong>Trial product:</strong> ' + escapeHtml(trialProductName)
              : ''}
          </p>`
        : ''
    }

    <div class="summary-strip">
      <div class="summary-pill">
        <span class="summary-label">Fields in packet</span>
        <span class="summary-value">${formatInt(totals.fieldCount || 0)}</span>
      </div>
      <div class="summary-pill">
        <span class="summary-label">Tillable acres</span>
        <span class="summary-value">${totals.tillableAll ? formatInt(totals.tillableAll) + ' ac' : 'n/a'}</span>
      </div>
      <div class="summary-pill">
        <span class="summary-label">Trial acres</span>
        <span class="summary-value">${totals.trialAcresAll ? formatInt(totals.trialAcresAll) + ' ac' : 'n/a'}</span>
      </div>
      <div class="summary-pill">
        <span class="summary-label">Check</span>
        <span class="summary-value">${totals.checkAvgAll !== null ? formatDecimal(totals.checkAvgAll,1) + ' bu/ac' : 'n/a'}</span>
      </div>
      <div class="summary-pill">
        <span class="summary-label">Treatment</span>
        <span class="summary-value">${totals.trialAvgAll !== null ? formatDecimal(totals.trialAvgAll,1) + ' bu/ac' : 'n/a'}</span>
      </div>
      <div class="summary-pill">
        <span class="summary-label">Advantage</span>
        <span class="summary-value">${
          totals.advantageAll !== null
            ? (totals.advantageAll >= 0 ? '+' : '') + formatDecimal(totals.advantageAll,1) + ' bu/ac'
            : 'n/a'
        }</span>
      </div>
    </div>

    <section class="section">
      <h2 class="section-title">Fields included in this packet</h2>
      <p class="section-sub">
        All checked fields are listed below. Each yield block from these fields has its own page in the remainder of the packet.
      </p>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width:32%">Field</th>
              <th style="width:26%">Farm / acres</th>
              <th style="width:14%">Check bu/ac</th>
              <th style="width:14%">Trial bu/ac</th>
              <th style="width:14%">Adv.</th>
            </tr>
          </thead>
          <tbody>
            ${fieldRowsHtml}
          </tbody>
        </table>
      </div>
    </section>

    <footer class="report-footer">
      <div>Internal use only. Results may change as additional yield blocks are recorded.</div>
      <div>FarmVista • Field Trial Detailed Packet • ${escapeHtml(runDateOnly || '')}</div>
    </footer>
  </div>
</section>`;

      /* ---------- BLOCK PAGES ---------- */

      const blockPages = [];

      for (const field of allFields) {
        const d = field.data || {};
        const s = field.stats || {};

        const farmName = d.farmName || 'Unknown farm';
        const fieldName = d.fieldName || '(Unnamed field)';

        const blocks = Array.isArray(field.blocks) ? field.blocks : [];
        if (!blocks.length) continue;

        blocks.forEach((block, idx) => {
          const c = block.check || {};
          const tr = block.trial || {};

          const images = [];
          if (Array.isArray(block.attachments)) {
            for (const att of block.attachments) {
              if (!att || typeof att !== 'object' || !att.url) continue;
              const ct = (att.contentType || '').toString().toLowerCase();
              const isImage = ct ? ct.startsWith('image/') : true;
              if (!isImage) continue;
              images.push(att);
              if (images.length >= 4) break;
            }
          }

          const plantDateStr   = formatDate(block.plantDate);
          const harvestDateStr = formatDate(block.harvestDate);
          const combineCount   = (block.combineCount !== undefined && block.combineCount !== null)
            ? String(block.combineCount)
            : '';

          const checkVariety = (block.checkVarietyName || '').toString();
          const trialVariety = (block.trialVarietyName || '').toString();

          const checkMoist = typeof c.moisture === 'number' ? formatDecimal(c.moisture,1) + ' %' : '';
          const trialMoist = typeof tr.moisture === 'number' ? formatDecimal(tr.moisture,1) + ' %' : '';
          const checkLbs   = typeof c.pounds === 'number' ? formatInt(c.pounds) + ' lb' : '';
          const trialLbs   = typeof tr.pounds === 'number' ? formatInt(tr.pounds) + ' lb' : '';

          const notes = (block.notes || '').toString().trim();

          const checkBu    = typeof c.yieldBuAc === 'number' ? formatDecimal(c.yieldBuAc,1) : '';
          const trialBu    = typeof tr.yieldBuAc === 'number' ? formatDecimal(tr.yieldBuAc,1) : '';
          const checkAcres = typeof c.acres === 'number' ? formatDecimal(c.acres,2) : '';
          const trialAcres = typeof tr.acres === 'number' ? formatDecimal(tr.acres,2) : '';

          let blockAdvVal = null;
          if (typeof c.yieldBuAc === 'number' && typeof tr.yieldBuAc === 'number') {
            blockAdvVal = tr.yieldBuAc - c.yieldBuAc;
          }
          const blockAdvText = blockAdvVal !== null
            ? (blockAdvVal >= 0 ? '+' : '') + formatDecimal(blockAdvVal,1)
            : '';

          const imageRows = [];
          if (images.length){
            const row1 = images.slice(0, 2);
            const row2 = images.slice(2, 4);
            if (row1.length) imageRows.push(row1);
            if (row2.length) imageRows.push(row2);
          }

          const gridHtml = imageRows.length
            ? imageRows.map(row => `
              <div class="photo-row">
                ${row.map(att => {
                  const url  = escapeHtml(att.url || '');
                  const name = escapeHtml(att.name || '');
                  return `
                    <figure class="photo-fig">
                      <img src="${url}" alt="${name || 'Block image'}" class="photo-img" />
                      ${name ? `<figcaption class="photo-caption">${name}</figcaption>` : ''}
                    </figure>
                  `;
                }).join('')}
              </div>
            `).join('')
            : '<p class="section-sub">No images are attached to this block yet.</p>';

          const blockNumber = idx + 1;
          const blockLabel = block.blockLabel || block.blockName || `Block ${blockNumber}`;
          const blockTypeLabel = block.blockType || 'combine';

          const blockPageHtml = `
<section class="page">
  <div class="page-inner page-inner-block">
    <div class="block-main">
      <header class="block-header">
        <div>
          <div class="block-title">${escapeHtml(farmName)} • ${escapeHtml(fieldName)}</div>
          <div class="block-sub">
            ${escapeHtml(t.trialName || 'Trial')} • ${escapeHtml(blockLabel)} (${escapeHtml(blockTypeLabel)})
          </div>
        </div>
        <div class="block-metrics">
          <div class="block-metric">
            <span class="label">Field check</span>
            <span class="value">${s.checkAvg !== null ? formatDecimal(s.checkAvg,1) + ' bu/ac' : 'n/a'}</span>
          </div>
          <div class="block-metric">
            <span class="label">Field trial</span>
            <span class="value">${s.trialAvg !== null ? formatDecimal(s.trialAvg,1) + ' bu/ac' : 'n/a'}</span>
          </div>
          <div class="block-metric">
            <span class="label">Field advantage</span>
            <span class="value">${
              s.advantage !== null
                ? (s.advantage >= 0 ? '+' : '') + formatDecimal(s.advantage,1) + ' bu/ac'
            : 'n/a'
            }</span>
          </div>
        </div>
      </header>

      <section class="section section-tight">
        <div class="block-meta-grid">
          <div>
            <div class="meta-label">Tillable</div>
            <div class="meta-value">${
              typeof d.tillable === 'number' ? formatDecimal(d.tillable,1) + ' ac' : 'n/a'
            }</div>
          </div>
          <div>
            <div class="meta-label">Trial acres</div>
            <div class="meta-value">${
              typeof d.trialAcres === 'number' ? formatDecimal(d.trialAcres,1) + ' ac' : 'n/a'
            }</div>
          </div>
          <div>
            <div class="meta-label">Plant date</div>
            <div class="meta-value">${plantDateStr || '—'}</div>
          </div>
          <div>
            <div class="meta-label">Harvest date</div>
            <div class="meta-value">${harvestDateStr || '—'}</div>
          </div>
        </div>
      </section>

      <section class="section section-tight">
        <div class="block-meta-grid">
          <div>
            <div class="meta-label">Combine passes</div>
            <div class="meta-value">${combineCount || '—'}</div>
          </div>
          <div>
            <div class="meta-label">Varieties</div>
            <div class="meta-value">${
              [checkVariety ? 'Check – ' + escapeHtml(checkVariety) : '',
               trialVariety ? 'Trial – ' + escapeHtml(trialVariety) : '']
                .filter(Boolean).join('<br>') || '—'
            }</div>
          </div>
          <div>
            <div class="meta-label">Block advantage</div>
            <div class="meta-value">${blockAdvText || '—'}</div>
          </div>
        </div>
      </section>

      <section class="section section-photos">
        <div class="photo-grid">
          ${gridHtml}
        </div>
      </section>
    </div>

    <div class="block-bottom">
      <section class="section">
        <h3 class="section-title">Block numbers</h3>
        <div class="table-wrap">
          <table class="numbers-table">
            <thead>
              <tr>
                <th></th>
                <th>Yield (bu/ac)</th>
                <th>Acres</th>
                <th>Moisture</th>
                <th>Wet weight</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>Check</td>
                <td class="cell-right">${checkBu || '—'}</td>
                <td class="cell-right">${checkAcres || '—'}</td>
                <td class="cell-right">${checkMoist || '—'}</td>
                <td class="cell-right">${checkLbs || '—'}</td>
              </tr>
              <tr>
                <td>Trial</td>
                <td class="cell-right">${trialBu || '—'}</td>
                <td class="cell-right">${trialAcres || '—'}</td>
                <td class="cell-right">${trialMoist || '—'}</td>
                <td class="cell-right">${trialLbs || '—'}</td>
              </tr>
            </tbody>
          </table>
        </div>
        ${
          notes
            ? `<p class="numbers-notes"><strong>Notes:</strong> ${escapeHtml(notes)}</p>`
            : ''
        }
      </section>

      <footer class="report-footer">
        <div>${escapeHtml(farmName)} • ${escapeHtml(fieldName)} • ${escapeHtml(blockLabel)}</div>
        <div>Block detail • ${escapeHtml(runDateOnly || '')}</div>
      </footer>
    </div>
  </div>
</section>`;

          blockPages.push(blockPageHtml);
        });
      }

      const allPagesHtml = [coverHtml].concat(blockPages).join('');

      return `<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Field Trial Detailed Packet</title>
  <style>
    :root{
      --fv-green:#3B7E46;
      --fv-border:#D1D5DB;
      --fv-text:#111827;
      --fv-muted:#6B7280;
      --fv-bg:#F3F4F6;
    }
    *{box-sizing:border-box;}
    html,body{
      margin:0;
      padding:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      color:var(--fv-text);
      background:#fff;
    }

    @page{
      size: landscape;
      margin:12mm;
    }

    .page{
      width:100%;
      margin:0;
      page-break-after:always;
    }
    .page-inner{
      padding:0;
    }

    .page-inner-block{
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }
    .block-main{
      flex:1 1 auto;
      display:flex;
      flex-direction:column;
      min-height:0;
    }
    .block-bottom{
      margin-top:auto;
      page-break-inside:avoid;
    }

    .report-header{
      display:grid;
      grid-template-columns:auto 1fr auto;
      gap:12px;
      align-items:center;
      border-bottom:2px solid var(--fv-green);
      padding-bottom:8px;
      margin-bottom:10px;
    }
    .report-logo{
      width:54px;
      height:54px;
      border-radius:14px;
      border:1px solid #D1D5DB;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:22px;
      font-weight:800;
      color:#fff;
      background:radial-gradient(circle at 30% 0%, #4CAF50, var(--fv-green));
    }
    .report-logo span{letter-spacing:0.02em;}
    .company-block{min-width:0;}
    .company-name{
      font-size:16px;
      font-weight:800;
      margin:0 0 2px;
    }
    .company-line{
      font-size:11px;
      color:#6B7280;
      margin:0;
    }
    .report-meta-top{
      text-align:right;
      font-size:10px;
      color:#6B7280;
    }
    .report-meta-top strong{color:#111827;}
    .report-title{
      font-size:18px;
      font-weight:800;
      margin:10px 0 4px;
      letter-spacing:0.02em;
      text-transform:uppercase;
    }
    .report-subtitle{
      font-size:12px;
      color:#6B7280;
      margin:0 0 4px;
    }

    /* New products line in PDF header */
    .report-products{
      font-size:11px;
      color:#374151;
      margin:0 0 8px;
    }

    .summary-strip{
      display:flex;
      flex-wrap:wrap;
      gap:6px 12px;
      margin-top:4px;
      padding:6px 8px;
      border-radius:9px;
      background:linear-gradient(90deg, rgba(59,126,70,0.08), transparent);
      border:1px solid rgba(59,126,70,0.2);
      font-size:10px;
    }
    .summary-pill{
      display:inline-flex;
      flex-wrap:nowrap;
      align-items:center;
      gap:4px;
    }
    .summary-label{
      text-transform:uppercase;
      letter-spacing:.08em;
      font-size:9px;
      color:#6B7280;
    }
    .summary-value{
      font-weight:600;
    }

    .section{
      margin-top:10px;
      page-break-inside:avoid;
    }
    .section-tight{
      margin-top:6px;
    }
    .section-title{
      font-size:13px;
      font-weight:700;
      margin:0 0 3px;
    }
    .section-sub{
      font-size:10px;
      color:#6B7280;
      margin:0 0 5px;
    }

    .table-wrap{
      border-radius:9px;
      border:1px solid #D1D5DB;
      overflow:hidden;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:10px;
    }
    thead{
      background:#F9FAFB;
    }
    th,td{
      padding:5px 7px;
      border-bottom:1px solid #E5E7EB;
      text-align:left;
      vertical-align:top;
    }
    th{
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.08em;
      font-size:9px;
      color:#4B5563;
      border-bottom:1px solid #D1D5DB;
    }
    tr:nth-child(even) td{
      background:#F9FAFB;
    }
    .cell-right{text-align:right; white-space:nowrap;}
    .muted-small{
      font-size:9px;
      color:#6B7280;
    }

    .report-footer{
      margin-top:8px;
      padding-top:4px;
      border-top:1px solid #D1D5DB;
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:9px;
      color:#6B7280;
    }

    .block-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      border-bottom:1px solid #D1D5DB;
      padding-bottom:6px;
      margin-bottom:6px;
    }
    .block-title{
      font-size:13px;
      font-weight:700;
    }
    .block-sub{
      font-size:10px;
      color:#6B7280;
      margin-top:2px;
    }
    .block-metrics{
      display:flex;
      flex-wrap:wrap;
      gap:4px 10px;
      font-size:9px;
    }
    .block-metric{
      display:flex;
      flex-direction:column;
      min-width:80px;
    }
    .block-metric .label{
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:#6B7280;
    }
    .block-metric .value{
      font-weight:600;
      font-size:10px;
    }

    .block-meta-grid{
      display:grid;
      grid-template-columns:repeat(4,minmax(0,1fr));
      gap:4px 10px;
      font-size:9px;
    }
    .meta-label{
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:#6B7280;
      margin-bottom:1px;
    }
    .meta-value{
      font-weight:500;
      font-size:10px;
    }

    .section-photos{
      margin-top:6px;
      flex:1 1 auto;
      min-height:0;
      display:flex;
      flex-direction:column;
    }
    .photo-grid{
      flex:1 1 auto;
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:stretch;
      justify-content:flex-start;
      min-height:0;
    }
    .photo-row{
      display:flex;
      flex:1 1 0;
      flex-wrap:nowrap;
      gap:6px;
      align-items:stretch;
      justify-content:flex-start;
      min-height:0;
    }
    .photo-fig{
      flex:1 1 0;
      max-width:50%;
      border:1px solid #E5E7EB;
      border-radius:6px;
      padding:4px;
      display:flex;
      flex-direction:column;
      align-items:center;
      page-break-inside:avoid;
      background:#FFFFFF;
      min-height:0;
    }
    .photo-img{
      width:100%;
      height:100%;
      max-height:none;
      object-fit:contain;
      border-radius:4px;
    }
    .photo-caption{
      margin-top:3px;
      font-size:8px;
      color:#4B5563;
      text-align:center;
    }

    .numbers-table th,
    .numbers-table td{
      padding:4px 6px;
      font-size:9px;
    }
    .numbers-notes{
      margin-top:4px;
      font-size:9px;
      max-height:0.8in;
      overflow:hidden;
    }

    @media print{
      html,body{
        background:#fff;
        padding:0;
      }
    }
  </style>
</head>
<body>
  ${allPagesHtml}
</body>
</html>`;
    }

    /* ---------- wait for all images before printing (desktop) ---------- */
    function waitForImages(doc){
      const imgs = Array.from(doc.images || []);
      if (!imgs.length) return Promise.resolve();

      return Promise.all(
        imgs.map(img => {
          if (img.complete) return Promise.resolve();
          return new Promise(resolve => {
            img.onload = resolve;
            img.onerror = resolve;
          });
        })
      );
    }

    /**
     * Build and output the detailed packet.
     * - Normal desktop: use hidden iframe + window.print() (same as before).
     * - Normal mobile: open a blob/data URL in a new tab (fallback).
     * - pdfPreview / inline mode (for Cloud Run): replace current document with the packet HTML.
     */
    async function runDetailedPrint(options = {}){
      const inlineMode = !!options.inline || isPdfPreview();

      try{
        if (!STATE.trialDoc){
          if (!inlineMode){
            alert('Trial is not loaded yet. Try again in a moment.');
          }
          return;
        }

        // In pdfPreview/inline mode we include ALL fields (checkbox state is a UI concept).
        const selectedFields = inlineMode ? STATE.fields : getSelectedFields();
        if (!selectedFields.length){
          if (!inlineMode){
            alert('Check at least one field before building the detailed packet.');
          }
          return;
        }

        const company = await loadCompanyHeader();
        const now = new Date();
        const runStr = now.toLocaleString();
        const runDateOnly = now.toLocaleDateString();

        const html = buildDetailedPrintHtml({
          company,
          runStr,
          runDateOnly,
          fields: selectedFields
        });

        if (inlineMode){
          document.open();
          document.write(html);
          document.close();
          return;
        }

        // Desktop print behavior
        if (isMobileLike()){
          // Mobile path is now handled by the "Download PDF" button using HTML-mode PDF.
          // This remains as a fallback.
          try{
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const win = window.open(url, '_blank');
            if (!win){
              window.location.href = url;
            }
          }catch(errMobile){
            console.warn('[trial-detailed] mobile Blob open failed, falling back to data URL', errMobile);
            const dataUrl = 'data:text/html;charset=utf-8,' + encodeURIComponent(html);
            window.location.href = dataUrl;
          }
        } else {
          let iframe = els.iframe;
          if (!iframe){
            iframe = document.createElement('iframe');
            iframe.id = 'fv-print-frame';
            document.body.appendChild(iframe);
            els.iframe = iframe;
          }

          const win = iframe.contentWindow || iframe;
          const doc = iframe.contentDocument || win.document;

          doc.open();
          doc.write(html);
          doc.close();

          try{
            await waitForImages(doc);
          }catch(e){
            console.warn('[trial-detailed] waitForImages failed, continuing to print anyway', e);
          }

          try{
            win.focus();
            win.print();
          }catch(err){
            console.warn('[trial-detailed] iframe print failed, falling back to window.print()', err);
            window.print();
          }
        }
      }catch(err){
        console.error('Error while building detailed report:', err);
        if (els.statusLine){
          els.statusLine.textContent =
            'Error while building detailed report: ' + (err && err.message ? err.message : String(err));
          els.statusLine.classList.add('status-error');
        }
      }
    }

    /* ---------- Mobile HTML-mode PDF helper ---------- */

    async function runMobilePdfDownload(){
      setPdfLoading(true);
      try{
        if (!STATE.trialDoc){
          alert('Trial is not loaded yet. Try again in a moment.');
          return;
        }

        const selectedFields = getSelectedFields();
        if (!selectedFields.length){
          alert('Check at least one field before downloading the PDF.');
          return;
        }

        const company = await loadCompanyHeader();
        const now = new Date();
        const runStr = now.toLocaleString();
        const runDateOnly = now.toLocaleDateString();

        const html = buildDetailedPrintHtml({
          company,
          runStr,
          runDateOnly,
          fields: selectedFields
        });

        if (window.FVPdf && typeof window.FVPdf.openPdfFromHtml === 'function'){
          // Cloud Run HTML → PDF flow
          await window.FVPdf.openPdfFromHtml(html, {
            filename: 'Trial-Detailed-Packet.pdf'
          });
        }else{
          console.warn('[trial-detailed] FVPdf.openPdfFromHtml missing, falling back to direct HTML open');
          try{
            const blob = new Blob([html], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const win = window.open(url, '_blank');
            if (!win){
              window.location.href = url;
            }
          }catch(errMobile){
            console.warn('[trial-detailed] mobile Blob open failed, falling back to data URL', errMobile);
            const dataUrl = 'data:text/html;charset=utf-8,' + encodeURIComponent(html);
            window.location.href = dataUrl;
          }
        }
      }catch(err){
        console.error('Error while building mobile PDF:', err);
        if (els.statusLine){
          els.statusLine.textContent =
            'Error while building mobile PDF: ' + (err && err.message ? err.message : String(err));
          els.statusLine.classList.add('status-error');
        }
      }finally{
        // Hide the loading overlay once we’re done (or errored)
        setPdfLoading(false);
      }
    }

    /* ---------- events & boot ---------- */

    function wireBasicEvents(){
      if (els.btnBack){
        els.btnBack.addEventListener('click', () => {
          if (history.length > 1){
            history.back();
          }else{
            location.href = '/Farm-vista/pages/reports/reports-predefined.html';
          }
        });
      }

      if (els.btnPrint){
        els.btnPrint.addEventListener('click', () => {
          runDetailedPrint();
        });
      }

      if (els.btnPdfPhone){
        els.btnPdfPhone.addEventListener('click', () => {
          runMobilePdfDownload();
        });
      }

      wireSelectionActions();
    }

    async function boot(){
      await ready;
      STATE.db = getFirestore();

      const shell = document.querySelector('fv-shell');
      if (shell) shell.nav = NAV_MENU;

      wireDom();

      STATE.trialId = getTrialIdFromUrl();
      if (!STATE.trialId){
        if (els.statusLine){
          els.statusLine.textContent = 'Missing trialId in URL. Open this page from the Field Trial Summary report.';
          els.statusLine.classList.add('status-error');
        }
        return;
      }

      try{
        if (els.statusLine){
          els.statusLine.textContent = 'Loading trial data…';
          els.statusLine.classList.remove('status-error');
        }

        await loadTrialData(STATE.trialId);
        renderHeader();
        renderFieldSelection();
        wireBasicEvents();

        if (els.statusLine){
          els.statusLine.textContent =
            'Check the fields you want, then click Print Detailed Report (desktop) or Download PDF (mobile).';
        }

        if (isPdfPreview()){
          await runDetailedPrint({ inline: true });
        }
      }catch(err){
        console.error('Error loading trial detailed data:', err);
        if (els.statusLine){
          els.statusLine.textContent = 'Error loading trial data. Check console or Firestore rules.';
          els.statusLine.classList.add('status-error');
        }
      }
    }

    boot().catch(console.error);
  </script>
</head>

<body>
  <fv-shell>
    <div class="wrap">
      <section class="hero">
        <header class="hero-head">
          <div class="icon" aria-hidden="true">🧪</div>
          <div>
            <h1 id="pageTitle">Trial Detailed Packet</h1>
            <p id="pageSubtitle" class="muted">
              Trial summary for checked fields, plus one page per yield block.
            </p>
            <!-- New: on-screen check/trial products line -->
            <p id="heroProducts" class="muted hero-products"></p>
          </div>
        </header>

        <div class="body">
          <div class="toolbar">
            <div class="toolbar-left">
              <button id="btnBack" type="button" class="btn btn-quiet">
                ← Back
              </button>
            </div>
            <div class="page-header-meta" id="pageMeta">
              Waiting for trial…
            </div>
          </div>

          <section class="field-select-panel">
            <div class="field-select-header">
              <div>
                <div class="field-select-title">Fields to include</div>
                <div class="field-select-note">
                  All checked fields will appear in the trial summary, with each yield block getting its own page.
                </div>
              </div>
              <div class="field-select-actions">
                <button id="btnAllFields" type="button" class="btn btn-quiet">Check all</button>
                <button id="btnNoFields" type="button" class="btn btn-quiet">Uncheck all</button>
              </div>
            </div>

            <div class="field-select-table-wrap">
              <table class="field-select-table">
                <thead>
                  <tr>
                    <th>Field</th>
                    <th class="numeric">Check bu/ac</th>
                    <th class="numeric">Trial bu/ac</th>
                    <th class="numeric">Adv.</th>
                  </tr>
                </thead>
                <tbody id="fieldTableBody">
                  <tr><td colspan="4">Loading fields…</td></tr>
                </tbody>
              </table>
            </div>
          </section>

          <div class="bottom-actions">
            <!-- Desktop / normal primary action -->
            <button id="btnPrint" type="button" class="btn btn-primary">
              Print Detailed Report
            </button>

            <!-- Mobile-only PDF action: uses HTML-mode Cloud Run PDF helper -->
            <button
              id="btnPdfPhone"
              type="button"
              class="btn btn-pdf-mobile"
            >
              Download PDF
            </button>
          </div>

          <p id="statusLine" class="status-line">
            Loading…
          </p>
        </div>
      </section>
    </div>
  </fv-shell>

  <!-- Mobile PDF loading overlay -->
  <div
    id="pdfLoading"
    class="pdf-loading hidden"
    role="alertdialog"
    aria-live="assertive"
    aria-hidden="true"
  >
    <div class="pdf-loading-inner">
      <div class="pdf-loading-spinner"></div>
      <p class="pdf-loading-text">Preparing PDF…</p>
      <p class="pdf-loading-sub">Please keep this tab open. Your phone will prompt you when the file is ready.</p>
    </div>
  </div>

  <!-- Hidden iframe used for printing on desktop -->
  <iframe id="fv-print-frame"></iframe>
</body>
</html>
