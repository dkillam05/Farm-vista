<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FarmVista ‚Ä¢ StarFire Receiver Locations</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#3B7E46" />

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest" />
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png" />
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png" />
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css" />
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css" />

  <style>
    :root{
      --card-max: 1200px;
      --page-bottom-gap: 72px;
      --accent: #2F6C3C;
    }

    body{
      background: var(--app-bg, var(--surface));
    }

    .wrap{
      max-width: var(--card-max);
      margin: 0 auto;
      padding: clamp(14px,3vw,22px);
      padding-bottom: calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + var(--page-bottom-gap)) !important;
      box-sizing:border-box;
    }

    .hero{
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));
    }
    .hero-head{
      display:grid;
      grid-template-columns:36px 1fr;
      gap:12px;
      align-items:center;
      padding:14px 16px;
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);
      border-bottom:1px solid var(--border);
    }
    .hero-head .icon{
      width:24px;
      height:24px;
      color:var(--accent);
      display:grid;
      place-items:center;
    }
    .hero-head h1{
      margin:0;
      font-size:clamp(20px,3.2vw,26px);
      line-height:1.2;
    }
    .muted{ color:var(--muted,#67706B); }

    .body{
      padding:16px;
      display:grid;
      gap:14px;
    }

    /* Toolbar + back / print buttons */
    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:flex-end;
      justify-content:space-between;
    }
    .toolbar-left{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:120px;
      padding:10px 14px;
      border-radius:12px;
      border:1px solid var(--border);
      font-weight:800;
      text-decoration:none;
      cursor:pointer;
      user-select:none;
      color:var(--text) !important;
      background:var(--card-surface,var(--surface));
      font-size:0.9rem;
      gap:6px;
    }
    .btn-quiet{
      min-width:auto;
      padding-inline:10px;
    }
    .btn-primary{
      border-color:transparent;
      background:#2F6C3C;
      color:#fff !important;
    }

    .page-header-meta{
      font-size:0.9rem;
      opacity:0.8;
    }

    /* Filters */
    .filters{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:flex-end;
      margin-top:4px;
    }
    .filter-field{
      display:flex;
      flex-direction:column;
      gap:3px;
      min-width:150px;
      flex:1 1 160px;
      font-size:0.8rem;
    }
    .filter-label{
      text-transform:uppercase;
      letter-spacing:0.08em;
      opacity:0.78;
    }
    .filter-input{
      border-radius:999px;
      border:1px solid var(--border);
      padding:6px 10px;
      font-size:0.9rem;
      background:var(--card-surface,var(--surface));
      color:var(--text);
      min-height:32px;
    }
    .filter-input::placeholder{
      color:var(--muted,#9CA3AF);
    }
    .filters-top .filter-field{
      flex:1 1 100%;
    }
    .filters-bottom{
      max-width:420px;
    }

    /* Location pill select */
    .location-pills{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      font-size:0.8rem;
    }
    .location-pill{
      border-radius:999px;
      border:1px solid var(--border);
      padding:5px 10px;
      cursor:pointer;
      background:var(--card-surface,var(--surface));
    }
    .location-pill.is-active{
      border-color:#2F6C3C;
      background:rgba(47,108,60,.12);
      font-weight:700;
    }

    /* List + cards */
    .sf-list{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:8px;
    }
    .sf-empty{
      padding:14px 16px;
      border-radius:12px;
      border:1px dashed var(--border);
      background:var(--card-surface, var(--surface));
      font-size:0.95rem;
      opacity:0.9;
    }

    .sf-card{
      border-radius:10px;
      border:1px solid var(--card-border, var(--border));
      background:var(--card-surface, var(--surface));
      box-shadow:var(--shadow-soft, var(--shadow));
      padding:12px 14px 10px;
      display:flex;
      flex-direction:column;
      gap:6px;
      transition:transform .06s, box-shadow .12s, border-color .12s, background .12s;
    }
    .sf-card:hover{
      border-color:rgba(47,108,60,.5);
      box-shadow:0 10px 24px rgba(0,0,0,.1);
    }

    .sf-title{
      font-weight:700;
      font-size:0.98rem;
      line-height:1.3;
    }

    .sf-sub{
      font-size:0.86rem;
      opacity:0.9;
      margin-top:2px;
    }

    .sf-meta{
      display:flex;
      flex-wrap:wrap;
      gap:6px 10px;
      margin-top:4px;
      font-size:0.8rem;
      opacity:0.9;
    }
    .sf-meta-pill{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 7px;
      border-radius:999px;
      background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
    }
    .sf-meta-label{
      font-weight:600;
    }

    .bottom-actions{
      margin-top:16px;
      display:flex;
      justify-content:flex-end;
    }

    /* Hidden iframe for print */
    #fv-print-frame{
      position:fixed;
      right:0;
      bottom:0;
      width:0;
      height:0;
      border:0;
      visibility:hidden;
    }
  </style>

  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true;
        document.head.appendChild(s);
      }
    })();
  </script>

  <script type="module">
    import {
      ready,
      getFirestore,
      collection, getDocs,
      doc, getDoc
    } from '/Farm-vista/js/firebase-init.js';

    import { NAV_MENU } from '/Farm-vista/js/menu.js';

    const CONFIG = {
      EQUIPMENT_COLLECTION: 'equipment',
      MOVES_COLLECTION: 'starfireMoves',
      COMPANY_DOC_PATH: ['company','main']
    };

    const $  = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    const STATE = {
      db: null,
      company: null,
      receivers: [],      // [{id,label,locName,locType,locSince,duration,lastMoveDate,lastMover}]
      filtered: null,
      filters: {
        location: 'all',  // all | mounted | storage
        search: ''
      }
    };

    function escapeHtml(str){
      return String(str || '').replace(/[&<>"']/g, m => (
        { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]
      ));
    }

    function formatNumber(n){
      const num = Number(n);
      if(!Number.isFinite(num)) return '0';
      return num.toLocaleString();
    }

    const last6 = v => String(v || '').slice(-6);

    function labelStarFire(row){
      const model = row.modelName || row.model || row.name || 'StarFire';
      const ls = last6(row.serial || row.sn || '');
      return ls ? `${model} (#${ls})` : model;
    }

    function daysSince(iso){
      if(!iso) return null;
      const d = new Date(iso);
      if(Number.isNaN(d.getTime())) return null;
      const now = new Date();
      const diffMs = now - d;
      if(diffMs < 0) return 0;
      return Math.floor(diffMs / (1000*60*60*24));
    }

    function durationLabel(iso){
      const d = daysSince(iso);
      if(d == null) return 'Unknown';
      if(d === 0) return 'Today';
      if(d === 1) return '1 day';
      return `${d} days`;
    }

    function getWorkingReceivers(){
      return (STATE.filtered && STATE.filtered.length)
        ? STATE.filtered
        : STATE.receivers;
    }

    /* ======================
       Company header / print
       ====================== */

    async function loadCompanyHeader(){
      if(STATE.company) return STATE.company;
      try{
        const [col,id] = CONFIG.COMPANY_DOC_PATH;
        const ref = doc(STATE.db, col, id);
        const snap = await getDoc(ref);
        const d = snap.exists() ? (snap.data() || {}) : {};
        const name = d.name || '';
        const address = [
          d.addressStreet || '',
          [d.addressCity, d.addressState].filter(Boolean).join(', '),
          d.addressZip || ''
        ].filter(Boolean).join(' ¬∑ ');
        const phone = d.phone || '';
        const email = d.email || '';
        STATE.company = { name, address, phone, email };
      }catch(e){
        console.warn('[starfire-report] failed to load company header', e);
        STATE.company = { name:'', address:'', phone:'', email:'' };
      }
      return STATE.company;
    }

    function summarizeFilters(){
      const { location, search } = STATE.filters;
      let locLabel = 'All locations';
      if(location === 'mounted') locLabel = 'Mounted on equipment';
      if(location === 'storage') locLabel = 'In storage only';

      const searchLabel = search
        ? `Search: "${search}"`
        : 'No text filter';

      return `${locLabel} ‚Ä¢ ${searchLabel}`;
    }

    function buildPrintHtml({ company, runStr, runDateOnly, filterSummary, totals, receivers }){
      return `<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>StarFire Receiver Locations</title>
  <style>
    :root{
      --fv-green:#3B7E46;
      --fv-border:#D1D5DB;
      --fv-text:#111827;
      --fv-muted:#6B7280;
      --fv-bg:#F3F4F6;
    }
    *{box-sizing:border-box;}
    html,body{
      margin:0;
      padding:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      color:var(--fv-text);
      background:var(--fv-bg);
    }
    body{
      display:flex;
      justify-content:center;
      padding:24px 12px;
    }
    .page{
      width:100%;
      max-width:900px;
      background:#fff;
      border-radius:12px;
      box-shadow:0 10px 30px rgba(15,23,42,0.15);
      padding:24px 28px 28px;
    }
    .report-header{
      display:grid;
      grid-template-columns:auto 1fr auto;
      gap:16px;
      align-items:center;
      border-bottom:2px solid var(--fv-green);
      padding-bottom:14px;
      margin-bottom:18px;
    }
    .report-logo{
      width:64px;
      height:64px;
      border-radius:16px;
      border:1px solid var(--fv-border);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:26px;
      font-weight:800;
      color:#fff;
      background:radial-gradient(circle at 30% 0%, #4CAF50, var(--fv-green));
    }
    .report-logo span{letter-spacing:0.02em;}
    .company-block{min-width:0;}
    .company-name{
      font-size:18px;
      font-weight:800;
      margin:0 0 2px;
    }
    .company-line{
      font-size:12px;
      color:var(--fv-muted);
      margin:0;
    }
    .report-meta-top{
      text-align:right;
      font-size:11px;
      color:var(--fv-muted);
    }
    .report-meta-top strong{color:var(--fv-text);}
    .report-title-block{margin-bottom:16px;}
    .report-title{
      font-size:20px;
      font-weight:800;
      margin:4px 0 4px;
      letter-spacing:0.02em;
      text-transform:uppercase;
    }
    .report-subtitle{
      font-size:13px;
      color:var(--fv-muted);
      margin:0;
    }
    .report-summary-strip{
      margin-top:12px;
      padding:8px 10px;
      border-radius:10px;
      background:linear-gradient(90deg, rgba(59,126,70,0.08), transparent);
      border:1px solid rgba(59,126,70,0.20);
      font-size:11px;
      display:flex;
      flex-wrap:wrap;
      gap:6px 16px;
    }
    .summary-pill{
      display:inline-flex;
      align-items:center;
      gap:4px;
      white-space:nowrap;
    }
    .summary-label{
      text-transform:uppercase;
      letter-spacing:0.08em;
      font-weight:600;
      font-size:10px;
      color:var(--fv-muted);
    }
    .summary-value{
      font-weight:600;
      font-size:11px;
    }
    .section{margin-top:18px;}
    .section-heading-row{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
      margin-bottom:6px;
    }
    .section-title-main{
      font-size:15px;
      font-weight:700;
      letter-spacing:0.03em;
      text-transform:uppercase;
    }
    .section-note{
      font-size:11px;
      color:var(--fv-muted);
    }
    .kpi-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:6px;
    }
    .kpi-card{
      flex:1 1 140px;
      border-radius:10px;
      border:1px solid var(--fv-border);
      padding:8px 10px;
      background:linear-gradient(135deg, rgba(59,126,70,0.06), #ffffff);
    }
    .kpi-label{
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:var(--fv-muted);
      margin-bottom:2px;
    }
    .kpi-value{
      font-size:16px;
      font-weight:800;
    }
    .kpi-footnote{
      font-size:10px;
      color:var(--fv-muted);
      margin-top:2px;
    }
    .section-title{
      font-size:13px;
      text-transform:uppercase;
      letter-spacing:0.12em;
      color:var(--fv-muted);
      margin:0 0 4px;
    }
    .section-body{
      font-size:12px;
      line-height:1.5;
    }
    .table-wrap{
      margin-top:6px;
      border-radius:10px;
      border:1px solid var(--fv-border);
      overflow:hidden;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
    }
    thead{
      background:#F9FAFB;
    }
    th, td{
      padding:6px 8px;
      border-bottom:1px solid #E5E7EB;
      text-align:left;
      vertical-align:top;
    }
    th{
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.08em;
      font-size:10px;
      color:#4B5563;
      border-bottom:1px solid #D1D5DB;
    }
    tr:nth-child(even) td{
      background:#F9FAFB;
    }
    .report-footer{
      margin-top:18px;
      padding-top:8px;
      border-top:1px solid #D1D5DB;
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:10px;
      color:#6B7280;
    }
    .footer-left{max-width:60%;}
    .footer-right{text-align:right;}
    @media print{
      html,body{background:#fff;padding:0;}
      body{box-shadow:none;}
      .page{
        max-width:none;
        border-radius:0;
        box-shadow:none;
        padding:12mm 14mm;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="report-header">
      <div class="report-logo">
        <span>DF</span>
      </div>
      <div class="company-block">
        <p class="company-name">${escapeHtml(company.name || '')}</p>
        <p class="company-line">
          ${company.address ? escapeHtml(company.address) + '<br>' : ''}
          ${company.phone ? 'Phone: ' + escapeHtml(company.phone) : ''}${company.phone && company.email ? ' ¬∑ ' : ''}
          ${company.email ? 'Email: ' + escapeHtml(company.email) : ''}
        </p>
      </div>
      <div class="report-meta-top">
        <div><strong>StarFire Receiver Locations</strong></div>
        <div>Generated: ${escapeHtml(runStr)}</div>
        <div>Prepared by: ${escapeHtml(company.name || 'FarmVista')}</div>
      </div>
    </header>

    <section class="report-title-block">
      <h1 class="report-title">StarFire Receiver Locations</h1>
      <p class="report-subtitle">Current location snapshot for all active StarFire receivers.</p>

      <div class="report-summary-strip">
        <div class="summary-pill">
          <span class="summary-label">Filters</span>
          <span class="summary-value">${escapeHtml(filterSummary)}</span>
        </div>
        <div class="summary-pill">
          <span class="summary-label">Receivers</span>
          <span class="summary-value">${formatNumber(totals.total)}</span>
        </div>
        <div class="summary-pill">
          <span class="summary-label">Mounted</span>
          <span class="summary-value">${formatNumber(totals.mounted)}</span>
        </div>
        <div class="summary-pill">
          <span class="summary-label">In Storage</span>
          <span class="summary-value">${formatNumber(totals.storage)}</span>
        </div>
      </div>
    </section>

    <section class="section">
      <div class="section-heading-row">
        <div class="section-title-main">Key Metrics</div>
        <div class="section-note">Snapshot at the time of report generation.</div>
      </div>
      <div class="kpi-row">
        <div class="kpi-card">
          <div class="kpi-label">StarFire Receivers</div>
          <div class="kpi-value">${formatNumber(totals.total)}</div>
          <div class="kpi-footnote">Active, non-archived receivers</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Mounted On Equipment</div>
          <div class="kpi-value">${formatNumber(totals.mounted)}</div>
          <div class="kpi-footnote">Receivers currently assigned to a machine</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">In Storage</div>
          <div class="kpi-value">${formatNumber(totals.storage)}</div>
          <div class="kpi-footnote">Receivers with no current machine assignment</div>
        </div>
      </div>
    </section>

    <section class="section">
      <h2 class="section-title">Detail by Receiver</h2>
      <div class="section-body">
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th style="width:26%">Receiver</th>
                <th style="width:28%">Current location</th>
                <th style="width:12%">Location type</th>
                <th style="width:14%">Since</th>
                <th style="width:10%">Days</th>
                <th style="width:20%">Last moved by</th>
              </tr>
            </thead>
            <tbody>
              ${receivers.map(r => `
                <tr>
                  <td>${escapeHtml(r.label)}</td>
                  <td>${escapeHtml(r.locName || 'In Storage')}</td>
                  <td>${r.locType === 'mounted' ? 'Mounted' : 'Storage'}</td>
                  <td>${escapeHtml(r.locSince || r.lastMoveDate || '')}</td>
                  <td>${r.durationDays ?? ''}</td>
                  <td>${
                    r.lastMover
                      ? escapeHtml(r.lastMover + (r.lastMoveDate ? ' (' + r.lastMoveDate + ')' : ''))
                      : ''
                  }</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <footer class="report-footer">
      <div class="footer-left">
        Internal use only. Verify locations in FarmVista before moving StarFire receivers between machines.
      </div>
      <div class="footer-right">
        FarmVista ‚Ä¢ StarFire Receiver Locations ‚Ä¢ ${escapeHtml(runDateOnly || '')}
      </div>
    </footer>
  </div>
</body>
</html>`;
    }

    async function handlePrintClick(){
      const receivers = getWorkingReceivers();
      if(!receivers.length){
        alert('No StarFire receivers match the current filters to print.');
        return;
      }

      const company = await loadCompanyHeader();
      const now = new Date();
      const runStr = now.toLocaleString();
      const runDateOnly = now.toLocaleDateString();

      const filterSummary = summarizeFilters();

      const totals = receivers.reduce((acc,r) => {
        acc.total++;
        if(r.locType === 'mounted') acc.mounted++;
        if(r.locType === 'storage') acc.storage++;
        return acc;
      }, { total:0, mounted:0, storage:0 });

      const html = buildPrintHtml({
        company,
        runStr,
        runDateOnly,
        filterSummary,
        totals,
        receivers
      });

      let iframe = document.getElementById('fv-print-frame');
      if(!iframe){
        iframe = document.createElement('iframe');
        iframe.id = 'fv-print-frame';
        document.body.appendChild(iframe);
      }

      const win = iframe.contentWindow || iframe.contentDocument;
      const doc = iframe.contentDocument || iframe.contentWindow.document;

      doc.open();
      doc.write(html);
      doc.close();

      setTimeout(() => {
        try{
          win.focus();
          win.print();
        }catch(err){
          console.warn('[starfire-report] iframe print failed, falling back to window.print()', err);
          window.print();
        }
      }, 400);
    }

    /* ======================
       Firestore load
       ====================== */

    async function loadData(){
      const db = STATE.db;

      // 1) Load all StarFire receivers from equipment
      const eqSnap = await getDocs(collection(db, CONFIG.EQUIPMENT_COLLECTION));
      const receiversRaw = [];
      eqSnap.forEach(docSnap => {
        const d = docSnap.data() || {};
        const type = String(d.type || '').toLowerCase();
        if(type !== 'starfire') return;
        if(String(d.status || 'active').toLowerCase() === 'archived') return;

        receiversRaw.push({
          id: docSnap.id,
          data: d
        });
      });

      // 2) Load all starfireMoves and keep most recent per receiverId
      const moveSnap = await getDocs(collection(db, CONFIG.MOVES_COLLECTION));
      const latestMoveByReceiver = new Map();

      moveSnap.forEach(docSnap => {
        const m = docSnap.data() || {};
        const rid = m.receiverId;
        if(!rid) return;

        let createdAt = null;
        try{
          createdAt = m.createdAt && typeof m.createdAt.toDate === 'function'
            ? m.createdAt.toDate()
            : null;
        }catch(e){ createdAt = null; }

        let moveD = null;
        if(m.moveDate){
          const dd = new Date(m.moveDate);
          if(!Number.isNaN(dd.getTime())) moveD = dd;
        }

        const effective = createdAt || moveD;
        if(!effective) return;

        const prev = latestMoveByReceiver.get(rid);
        if(prev && prev.effective && prev.effective >= effective) return;

        latestMoveByReceiver.set(rid, {
          effective,
          moveDate: m.moveDate || null,
          movedBy: m.movedBy || null,
          toLocationName: m.toLocationName || null
        });
      });

      // 3) Build final receiver records
      const receivers = receiversRaw.map(r => {
        const d = r.data;
        const label = labelStarFire(d);
        const locId   = d.starfireCurrentLocationId || null;
        const locName = d.starfireCurrentLocationName || (locId ? 'Mounted on equipment' : 'In Storage');
        const locSince = d.starfireCurrentLocationSince || null;
        const locType = locId ? 'mounted' : 'storage';

        const moveInfo = latestMoveByReceiver.get(r.id) || null;
        const lastMoveDate = moveInfo?.moveDate || null;
        const lastMover = moveInfo?.movedBy?.name || moveInfo?.movedBy?.email || null;

        const durationDays = daysSince(locSince || lastMoveDate || null);

        return {
          id: r.id,
          label,
          locId,
          locName,
          locType,
          locSince,
          durationDays,
          lastMoveDate,
          lastMover
        };
      });

      receivers.sort((a,b) => a.label.localeCompare(b.label));

      STATE.receivers = receivers;
    }

    /* ======================
       Rendering + filters
       ====================== */

    function renderSummary(){
      const metaEl = $('#sfMeta');
      const list = getWorkingReceivers();
      const total = list.length;
      let mounted = 0;
      let storage = 0;
      list.forEach(r => {
        if(r.locType === 'mounted') mounted++;
        if(r.locType === 'storage') storage++;
      });

      if(!metaEl) return;

      if(!total){
        metaEl.textContent = '0 receivers';
        return;
      }

      metaEl.textContent = `${total} receiver${total === 1 ? '' : 's'} ‚Ä¢ ${mounted} mounted ‚Ä¢ ${storage} in storage`;
    }

    function renderList(){
      const listEl  = $('.sf-list');
      const emptyEl = $('.sf-empty');

      const items = getWorkingReceivers();

      listEl.innerHTML = '';

      if(!items.length){
        emptyEl.style.display = 'block';
        emptyEl.textContent = 'No StarFire receivers found or matching the current filters.';
        renderSummary();
        return;
      }

      emptyEl.style.display = 'none';

      items.forEach(r => {
        const card = document.createElement('article');
        card.className = 'sf-card';

        const locTypeLabel = r.locType === 'mounted' ? 'Mounted on equipment' : 'In Storage';

        const sinceText = r.locSince || r.lastMoveDate || '‚Äî';
        const durText = durationLabel(r.locSince || r.lastMoveDate || null);

        const moverText = r.lastMover
          ? `${r.lastMover}${r.lastMoveDate ? ' ‚Ä¢ ' + r.lastMoveDate : ''}`
          : 'Not available';

        card.innerHTML = `
          <div class="sf-title">
            ${escapeHtml(r.label)}
          </div>
          <div class="sf-sub">
            Currently: ${escapeHtml(r.locName || 'In Storage')}
            ¬∑ ${locTypeLabel}
          </div>
          <div class="sf-meta">
            <span class="sf-meta-pill">
              <span class="sf-meta-label">Since</span> ${escapeHtml(sinceText)}
            </span>
            <span class="sf-meta-pill">
              <span class="sf-meta-label">Duration</span> ${escapeHtml(durText)}
            </span>
            <span class="sf-meta-pill">
              <span class="sf-meta-label">Last moved by</span> ${escapeHtml(moverText)}
            </span>
          </div>
        `;

        listEl.appendChild(card);
      });

      renderSummary();
    }

    function applyFilters(){
      const { location, search } = STATE.filters;
      const q = (search || '').trim().toLowerCase();

      const filtered = STATE.receivers.filter(r => {
        if(location === 'mounted' && r.locType !== 'mounted') return false;
        if(location === 'storage' && r.locType !== 'storage') return false;

        if(q){
          const hay = [
            r.label,
            r.locName,
            r.lastMover
          ].filter(Boolean).join(' ').toLowerCase();
          if(!hay.includes(q)) return false;
        }

        return true;
      });

      STATE.filtered = filtered;
      renderList();
    }

    function setLocationFilter(value){
      STATE.filters.location = value;
      // update pills
      $$('.location-pill').forEach(p => {
        p.classList.toggle('is-active', p.dataset.value === value);
      });
      applyFilters();
    }

    /* ======================
       Boot
       ====================== */

    (async function boot(){
      await ready;
      STATE.db = getFirestore();

      const shell = document.querySelector('fv-shell');
      if(shell){
        shell.nav = NAV_MENU;
      }

      const backBtn = document.getElementById('btnBack');
      if(backBtn){
        backBtn.addEventListener('click', () => {
          location.href = '/Farm-vista/pages/reports/reports-predefined.html';
        });
      }

      const searchEl = $('#filterSearch');
      if(searchEl){
        searchEl.addEventListener('input', e => {
          STATE.filters.search = e.target.value || '';
          applyFilters();
        });
      }

      // Location pills
      $$('.location-pill').forEach(p => {
        p.addEventListener('click', () => {
          setLocationFilter(p.dataset.value || 'all');
        });
      });

      $('#btnPrint')?.addEventListener('click', handlePrintClick);
      $('#btnPrintBottom')?.addEventListener('click', handlePrintClick);

      try{
        $('#sfMeta').textContent = 'Loading StarFire receivers‚Ä¶';
        await loadData();
        STATE.filtered = null;
        renderList();
      }catch(err){
        console.error('Error loading StarFire data:', err);
        const emptyEl = $('.sf-empty');
        emptyEl.style.display = 'block';
        emptyEl.textContent = 'Error loading StarFire receiver data. Check console or Firestore rules.';
        $('#sfMeta').textContent = 'Error loading receivers';
      }
    })();
  </script>
</head>

<body>
  <fv-shell>
    <div class="wrap">
      <section class="hero">
        <header class="hero-head">
          <div class="icon" aria-hidden="true">üõ∞Ô∏è</div>
          <div>
            <h1>StarFire Receiver Locations</h1>
            <p class="muted">
              Snapshot of where each StarFire globe is currently mounted, how long it has been there, and who moved it last.
            </p>
          </div>
        </header>

        <div class="body">
          <div class="toolbar">
            <div class="toolbar-left">
              <button id="btnBack" type="button" class="btn btn-quiet">
                ‚Üê Back to Reports
              </button>
              <button id="btnPrint" type="button" class="btn btn-primary">
                Print / Save PDF
              </button>
            </div>
            <div class="page-header-meta" id="sfMeta">
              Loading StarFire receivers‚Ä¶
            </div>
          </div>

          <!-- SEARCH ROW -->
          <div class="filters filters-top">
            <div class="filter-field">
              <label class="filter-label" for="filterSearch">Search</label>
              <input
                id="filterSearch"
                class="filter-input"
                type="search"
                placeholder="Search receiver, location, or employee‚Ä¶"
              />
            </div>
          </div>

          <!-- LOCATION FILTER PILLS -->
          <div class="filters filters-bottom">
            <div class="filter-field">
              <label class="filter-label">Location filter</label>
              <div class="location-pills">
                <button type="button" class="location-pill is-active" data-value="all">
                  All locations
                </button>
                <button type="button" class="location-pill" data-value="mounted">
                  Mounted on equipment
                </button>
                <button type="button" class="location-pill" data-value="storage">
                  In storage only
                </button>
              </div>
            </div>
          </div>

          <section aria-label="StarFire receivers">
            <div class="sf-empty">
              Loading StarFire receivers‚Ä¶
            </div>
            <div class="sf-list"></div>
          </section>

          <div class="bottom-actions">
            <button id="btnPrintBottom" type="button" class="btn btn-primary">
              Print / Save PDF
            </button>
          </div>
        </div>
      </section>
    </div>

    <!-- Hidden iframe used for print so we don't open a new tab -->
    <iframe id="fv-print-frame"></iframe>
  </fv-shell>
</body>
</html>

