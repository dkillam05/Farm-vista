<!doctype html>
<html>
  <body>
    <h2>OCR Receipt Test (Expense Parser)</h2>

    <p>
      1) Choose a RECEIPT or INVOICE PDF/JPG<br>
      2) Click "Scan Receipt"<br>
      3) See structured fields + plain text below
    </p>

    <input type="file" id="file" />
    <button id="btn">Scan Receipt</button>

    <p id="status" style="margin-top:10px; font-weight:bold; color:#333;">
      Status: Waiting for fileâ€¦
    </p>

    <!-- Parsed summary -->
    <h3>Parsed Receipt Summary</h3>
    <table border="1" cellpadding="6" cellspacing="0">
      <tr><th>Vendor</th><td id="sum-vendor"></td></tr>
      <tr><th>Date</th><td id="sum-date"></td></tr>
      <tr><th>Total Amount</th><td id="sum-total"></td></tr>
      <tr><th>Tax Amount</th><td id="sum-tax"></td></tr>
      <tr><th>Currency</th><td id="sum-currency"></td></tr>
    </table>

    <h3>Raw Entities (from Expense Parser)</h3>
    <pre id="entities" style="white-space:pre-wrap; border:1px solid #ccc; padding:10px;"></pre>

    <h3>Plain Text</h3>
    <pre id="text" style="white-space:pre-wrap; border:1px solid #ccc; padding:10px; min-height:150px;"></pre>

    <script>
      const btn = document.getElementById("btn");
      const statusEl = document.getElementById("status");
      const entitiesEl = document.getElementById("entities");
      const textEl = document.getElementById("text");

      const vendorEl = document.getElementById("sum-vendor");
      const dateEl = document.getElementById("sum-date");
      const totalEl = document.getElementById("sum-total");
      const taxEl = document.getElementById("sum-tax");
      const currencyEl = document.getElementById("sum-currency");

      btn.addEventListener("click", async () => {
        const input = document.getElementById("file");
        const file = input.files[0];

        if (!file) {
          statusEl.textContent = "Status: Pick a file first.";
          return;
        }

        statusEl.textContent = "Status: Reading fileâ€¦";

        const reader = new FileReader();
        reader.onload = async () => {
          try {
            const base64 = reader.result.split(",")[1];

            statusEl.textContent = "Status: Sending to OCR (receipt mode)â€¦";

            const res = await fetch(
              "https://fv-ocr-300398089669.us-central1.run.app/fvOcr",
              {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                  mode: "receipt",              // ðŸ‘ˆ tells backend to use FV-Receipts-OCR
                  content: base64,
                  mimeType: file.type || "application/pdf"
                })
              }
            );

            const json = await res.json();
            statusEl.textContent = json.ok ? "Status: OK" : "Status: ERROR";

            // show all entities
            entitiesEl.textContent = JSON.stringify(json.fields || {}, null, 2);

            // plain text
            const docText = json.document?.text || "(no text returned)";
            textEl.textContent = docText;

            // fill structured fields
            vendorEl.textContent   = json.fields["supplier_name"] || json.fields["vendor_name"] || "(not found)";
            dateEl.textContent     = json.fields["invoice_date"]  || json.fields["receipt_date"] || "(not found)";
            totalEl.textContent    = json.fields["total_amount"]  || json.fields["amount_due"]   || "(not found)";
            taxEl.textContent      = json.fields["tax_amount"]    || "(not found)";
            currencyEl.textContent = json.fields["currency_code"] || "(not found)";

          } catch (err) {
            statusEl.textContent = "Status: ERROR â€“ see console";
            console.error(err);
          }
        };

        reader.readAsDataURL(file);
      });
    </script>
  </body>
</html>

