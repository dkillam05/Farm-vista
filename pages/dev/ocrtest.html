<!doctype html>
<html>
  <body>
    <h2>OCR Test Page (JSON → Clean)</h2>

    <p>
      1) Click "Choose File" and select a RECEIPT image or PDF<br>
      2) Click "Scan Receipt"<br>
      3) See parsed output below
    </p>

    <input type="file" id="file" />
    <button id="btn">Scan Receipt</button>

    <p id="status" style="margin-top:10px; font-weight:bold; color:#333;">
      Status: Waiting for file…
    </p>

    <h3>Fields (key/value):</h3>
    <pre id="fields" style="white-space:pre-wrap; border:1px solid #ccc; padding:10px; min-height:40px;"></pre>

    <h3>Plain text from document:</h3>
    <pre id="text" style="white-space:pre-wrap; border:1px solid #ccc; padding:10px; min-height:120px;"></pre>

    <script>
      const btn = document.getElementById("btn");
      const statusEl = document.getElementById("status");
      const fieldsEl = document.getElementById("fields");
      const textEl = document.getElementById("text");

      btn.addEventListener("click", async () => {
        const input = document.getElementById("file");
        const file = input.files[0];

        if (!file) {
          statusEl.textContent = "Status: Pick a file first.";
          fieldsEl.textContent = "";
          textEl.textContent = "";
          return;
        }

        statusEl.textContent = "Status: Reading file…";
        fieldsEl.textContent = "";
        textEl.textContent = "";

        const reader = new FileReader();
        reader.onload = async () => {
          try {
            const base64 = reader.result.split(",")[1];

            statusEl.textContent = "Status: Sending to OCR…";

            const res = await fetch(
              "https://fv-ocr-300398089669.us-central1.run.app/fvOcr",
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  content: base64,
                  mimeType: file.type || "application/pdf"
                })
              }
            );

            const json = await res.json();
            statusEl.textContent = json.ok ? "Status: OK" : "Status: Error";

            // Show fields (if any)
            fieldsEl.textContent = JSON.stringify(json.fields || {}, null, 2);

            // Show plain text
            const docText = json.document && json.document.text
              ? json.document.text
              : "(no document.text returned)";
            textEl.textContent = docText;
          } catch (err) {
            statusEl.textContent = "Status: ERROR – see console";
            fieldsEl.textContent = "";
            textEl.textContent = "ERROR: " + err.message;
            console.error(err);
          }
        };

        reader.readAsDataURL(file);
      });
    </script>
  </body>
</html>
