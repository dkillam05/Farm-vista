<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FarmVista • Dev • Yield Math</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#3B7E46" />

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest" />
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png" />
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png" />
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css" />
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css" />

  <style>
    :root{
      --card-max: 900px;
      --page-bottom-gap: 80px;
    }

    .page-inner{
      max-width: var(--card-max);
      margin: 0 auto var(--page-bottom-gap);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .dev-card{
      background: var(--card-surface, var(--surface));
      border-radius: 16px;
      border: 1px solid var(--border-subtle, rgba(0,0,0,0.06));
      box-shadow: var(--shadow-soft, 0 1px 3px rgba(0,0,0,0.08));
      padding: 16px 18px 18px;
    }

    .dev-card-header{
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 8px;
    }

    .dev-title{
      font-size: 1.05rem;
      font-weight: 600;
    }

    .dev-subtitle{
      font-size: 0.85rem;
      opacity: 0.75;
    }

    .dev-form-grid{
      display: grid;
      grid-template-columns: minmax(0, 1fr) minmax(0, 1fr);
      gap: 10px 18px;
    }

    @media (max-width: 720px){
      .dev-form-grid{
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .dev-field{
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.88rem;
    }

    .dev-label{
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      opacity: 0.75;
    }

    .dev-input,
    .dev-select{
      padding: 7px 9px;
      border-radius: 10px;
      border: 1px solid var(--border, rgba(0,0,0,0.16));
      background: var(--card-surface, var(--surface));
      font-size: 0.9rem;
    }

    .dev-actions{
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 12px;
    }

    .dev-btn{
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      background: var(--accent, #3B7E46);
      color: #fff;
    }

    .dev-btn.secondary{
      background: transparent;
      color: inherit;
      border: 1px solid var(--border, rgba(0,0,0,0.18));
    }

    .dev-output{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      font-size: 0.9rem;
      line-height: 1.4;
      padding: 10px 12px;
      border-radius: 10px;
      background: var(--surface-soft, rgba(0,0,0,0.02));
      border: 1px dashed var(--border-subtle, rgba(0,0,0,0.12));
      white-space: pre-wrap;
      word-break: break-word;
      min-height: 60px;
    }

    .dev-output-heading{
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      opacity: 0.7;
      margin-bottom: 4px;
    }

    .hero-simple{
      padding: 14px 18px 16px;
      border-radius: 18px;
      background: linear-gradient(135deg, rgba(59,126,70,0.08), rgba(59,126,70,0.02));
      border: 1px solid rgba(0,0,0,0.04);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .hero-title{
      font-size: 1.1rem;
      font-weight: 600;
    }

    .hero-note{
      font-size: 0.85rem;
      opacity: 0.8;
    }

    .hero-badge{
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      opacity: 0.7;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <header class="app-header" data-fv-slot="header"></header>

    <main class="app-main">
      <div class="page">
        <div class="page-inner">

          <!-- Hero / intro -->
          <section class="hero-simple dev-card">
            <div class="hero-badge">Dev Tool</div>
            <div class="hero-title">Yield Math Tester</div>
            <div class="hero-note">
              Uses <code>fv-yield-math.js</code> so you can confirm the true-shrink math and
              standard moisture overrides. Corn defaults to 15.5%, soy to 13.0%, unless you
              supply an override.
            </div>
          </section>

          <!-- Input card -->
          <section class="dev-card">
            <div class="dev-card-header">
              <div class="dev-title">Inputs</div>
              <div class="dev-subtitle">
                Plug in a block and hit “Run calc”. If you want trials behavior, set a
                custom standard moisture (e.g. corn → 15.0).
              </div>
            </div>

            <form id="yield-form">
              <div class="dev-form-grid">
                <div class="dev-field">
                  <label class="dev-label" for="cropKind">Crop</label>
                  <select id="cropKind" class="dev-select">
                    <option value="corn">Corn</option>
                    <option value="soy">Soybeans</option>
                    <option value="other">Other</option>
                  </select>
                </div>

                <div class="dev-field">
                  <label class="dev-label" for="wetWeight">Wet weight (lb)</label>
                  <input
                    id="wetWeight"
                    class="dev-input"
                    type="number"
                    inputmode="decimal"
                    step="0.01"
                    placeholder="e.g. 52,000"
                  />
                </div>

                <div class="dev-field">
                  <label class="dev-label" for="moisture">Wet moisture (%)</label>
                  <input
                    id="moisture"
                    class="dev-input"
                    type="number"
                    inputmode="decimal"
                    step="0.01"
                    placeholder="e.g. 19.2"
                  />
                </div>

                <div class="dev-field">
                  <label class="dev-label" for="acres">Acres</label>
                  <input
                    id="acres"
                    class="dev-input"
                    type="number"
                    inputmode="decimal"
                    step="0.01"
                    placeholder="e.g. 4.37"
                  />
                </div>

                <div class="dev-field">
                  <label class="dev-label" for="stdMoistOverride">
                    Standard moisture override (%)
                  </label>
                  <input
                    id="stdMoistOverride"
                    class="dev-input"
                    type="number"
                    inputmode="decimal"
                    step="0.01"
                    placeholder="blank = crop default"
                  />
                </div>
              </div>

              <div class="dev-actions">
                <button type="submit" class="dev-btn">Run calc</button>
                <button type="button" id="btnQuickCorn15" class="dev-btn secondary">
                  Quick: Corn @ 15.0%
                </button>
                <button type="button" id="btnQuickSoy13" class="dev-btn secondary">
                  Quick: Soy @ 13.0%
                </button>
              </div>
            </form>
          </section>

          <!-- Output card -->
          <section class="dev-card">
            <div class="dev-card-header">
              <div class="dev-title">Result</div>
              <div class="dev-subtitle">
                Shows the normalized crop, test weight, moisture used, and yield. All math
                comes directly from <code>calcTrueYield()</code>.
              </div>
            </div>

            <div class="dev-output">
              <div class="dev-output-heading">Output</div>
              <div id="yield-output-body">
                Enter values above and click “Run calc”.
              </div>
            </div>
          </section>

        </div>
      </div>
    </main>
  </div>

  <script type="module">
    import { calcTrueYield, normalizeCropKind, CROP_CONFIG } from '/Farm-vista/js/fv-yield-math.js';

    const form = document.getElementById('yield-form');
    const outputBody = document.getElementById('yield-output-body');

    const cropEl = document.getElementById('cropKind');
    const wetWeightEl = document.getElementById('wetWeight');
    const moistureEl = document.getElementById('moisture');
    const acresEl = document.getElementById('acres');
    const stdOverrideEl = document.getElementById('stdMoistOverride');

    const btnQuickCorn15 = document.getElementById('btnQuickCorn15');
    const btnQuickSoy13 = document.getElementById('btnQuickSoy13');

    function toNum(val) {
      if (val == null) return NaN;
      const cleaned = String(val).replace(/,/g, '');
      return cleaned === '' ? NaN : Number(cleaned);
    }

    function formatNum(val, decimals = 2) {
      if (val == null || Number.isNaN(val)) return '—';
      const n = Number(val);
      return n.toLocaleString(undefined, {
        minimumFractionDigits: decimals,
        maximumFractionDigits: decimals
      });
    }

    function runCalc({ forceCorn15 = false, forceSoy13 = false } = {}) {
      const rawCrop = cropEl.value || 'corn';
      const cropKind = normalizeCropKind(rawCrop);

      const W = toNum(wetWeightEl.value);
      const M = toNum(moistureEl.value);
      const A = toNum(acresEl.value);

      let stdOverride = toNum(stdOverrideEl.value);
      if (Number.isNaN(stdOverride)) {
        stdOverride = undefined;
      }

      // Convenience buttons for trials behavior
      if (forceCorn15 && cropKind === 'corn') {
        stdOverride = 15.0;
        stdOverrideEl.value = '15.0';
      }
      if (forceSoy13 && cropKind === 'soy') {
        stdOverride = 13.0;
        stdOverrideEl.value = '13.0';
      }

      const res = calcTrueYield({
        cropKind,
        wetWeightLbs: W,
        wetMoisturePct: M,
        acres: A,
        stdMoistOverride: stdOverride
      });

      if (!res) {
        outputBody.textContent =
          'Result: null\n\nCheck that wet weight, moisture, and acres are all valid numbers.';
        return;
      }

      const cfg = CROP_CONFIG[res.cropKind] || CROP_CONFIG.other;

      const lines = [
        `Crop kind:        ${res.cropKind} (config TW ${cfg.testWeight} lb/bu, default stdMoist ${cfg.stdMoist}%)`,
        `Wet weight (lb):  ${formatNum(res.wetWeightLbs, 0)}`,
        `Wet moisture (%): ${formatNum(res.wetMoisturePct, 2)}`,
        `Acres:            ${formatNum(res.acres, 3)}`,
        '',
        `Std moisture used: ${formatNum(res.stdMoist, 2)} %`,
        `Test weight:       ${formatNum(res.testWeight, 0)} lb/bu`,
        '',
        `Bushels (std):    ${formatNum(res.bushels, 3)} bu`,
        `Yield (bu/ac):    ${formatNum(res.yieldBuAc, 2)} bu/ac`
      ];

      outputBody.textContent = lines.join('\n');
    }

    form.addEventListener('submit', (evt) => {
      evt.preventDefault();
      runCalc();
    });

    btnQuickCorn15.addEventListener('click', () => {
      cropEl.value = 'corn';
      runCalc({ forceCorn15: true });
    });

    btnQuickSoy13.addEventListener('click', () => {
      cropEl.value = 'soy';
      runCalc({ forceSoy13: true });
    });
  </script>
</body>
</html>
