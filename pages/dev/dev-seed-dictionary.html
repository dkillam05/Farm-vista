<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista â€¢ Dev â€¢ Seed Dictionary (Tractor Style)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <!-- Ensure fv-shell -->
  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js'; s.defer=true; document.head.appendChild(s);
      }
    })();
  </script>

  <!-- Firebase config FIRST (for firebase-init imports) -->
  <script src="/Farm-vista/js/firebase-config.js"></script>

  <style>
    .page{
      max-width:1100px;
      margin:0 auto;
      padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + 72px)!important;
    }
    .page-title{margin:0 0 8px 0;}
    .page-sub{margin:0 0 14px 0;color:var(--muted,#67706B);}

    .alert{
      display:none;margin:0 0 12px 0;border:1px solid #c62828;background:#fdecea;color:#8a1c1c;
      border-radius:12px;padding:12px 14px;font-weight:700;
    }
    .alert.show{display:block;}

    .section{
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));
    }
    .section-head{
      display:grid;grid-template-columns:36px 1fr;gap:12px;align-items:center;
      padding:14px 16px;border-bottom:1px solid var(--border);
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);
    }
    .section-head .icon{
      width:24px;height:24px;display:grid;place-items:center;color:#2F6C3C;
    }
    .section-body{padding:16px;display:grid;gap:14px;}

    .list{padding:4px 0 10px;display:grid;gap:10px;}
    .item{
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--card-surface,var(--surface));
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      cursor:pointer;
    }
    .item-main{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:6px;
    }
    .name{font-weight:800;}
    .pill{
      font-size:12px;
      border:1px solid var(--border);
      padding:3px 8px;
      border-radius:999px;
      color:var(--muted,#67706B);
      background:var(--surface);
    }
    .pill-arch{border-color:#b3261e;color:#b3261e;}

    .toast{
      position:fixed;
      left:50%;
      bottom:calc(env(safe-area-inset-bottom,0px)+72px);
      transform:translateX(-50%);
      background:#2F6C3C;
      color:#fff;
      padding:10px 14px;
      border-radius:10px;
      box-shadow:0 6px 20px rgba(0,0,0,.25);
      z-index:99999;
      display:none;
    }
    .toast.show{display:block;animation:fadeout 2.8s forwards;}
    @keyframes fadeout{
      0%{opacity:1}
      85%{opacity:1}
      100%{opacity:0}
    }

    dialog.sheet{
      width:min(760px, 92vw);
      border:1px solid var(--border);
      border-radius:14px;
      padding:0;
      background:var(--card-surface,var(--surface));
      color:var(--text);
      box-shadow:0 18px 40px rgba(0,0,0,.45);
    }
    .sheet::backdrop{ background:rgba(0,0,0,.55); }
    .sheet header{
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .sheet .body{
      padding:14px 16px;
      max-height:70vh;
      overflow-y:auto;
      overflow-x:hidden;
    }
    .sheet footer{
      padding:12px 16px;
      border-top:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }

    .grid-2{display:grid;gap:10px;grid-template-columns:1fr 1fr;}
    .grid-3{display:grid;gap:10px;grid-template-columns:1fr 1fr 1fr;}
    @media(max-width:880px){
      .grid-2,.grid-3{grid-template-columns:1fr;}
    }

    .field label{
      display:block;
      font-weight:800;
      margin:0 0 6px 0;
    }
    .input,.select,.textarea{
      width:100%;
      font:inherit;
      font-size:16px;
      color:var(--text);
      background:var(--card-surface,var(--surface));
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px 12px;
      outline:none;
    }
    .textarea{
      min-height:80px;
      resize:vertical;
    }
    .help{
      font-size:13px;
      color:var(--muted,#67706B);
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:8px 14px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--card-surface,var(--surface));
      font-weight:700;
      cursor:pointer;
      font-size:14px;
      text-decoration:none;
    }
    .btn-primary{border-color:transparent;background:#2F6C3C;color:#fff;}
    .btn-quiet{min-width:auto;padding:7px 10px;font-size:13px;}
    .btn-danger{border-color:#b3261e;background:#b3261e;color:#fff;}

    .delete-icon-btn{
      background:none;
      border:none;
      padding:6px;
      margin:0;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
    }
    .delete-icon-btn svg{
      width:22px;
      height:22px;
      display:block;
    }

    .raw-box{
      font-family:system-ui, -apple-system, BlinkMacSystemFont, "SF Mono", Menlo, Consolas, monospace;
      font-size:12px;
      background:rgba(0,0,0,.04);
      border-radius:8px;
      padding:8px;
      max-height:180px;
      overflow:auto;
    }
  </style>
</head>
<body>
  <fv-shell>
    <div class="page">
      <h1 class="page-title">Seed Dictionary (Dev â€“ Tractor Style)</h1>
      <p class="page-sub">Direct Firestore read/write from <code>productsSeed</code>. No FVData, no magic.</p>

      <div id="alert" class="alert" role="alert"></div>

      <section class="section">
        <header class="section-head">
          <div class="icon" aria-hidden="true">ðŸ“š</div>
          <div><strong>Seed Dictionary</strong></div>
        </header>
        <div class="section-body">
          <div id="list" class="list">
            <div class="muted">Loadingâ€¦</div>
          </div>
        </div>
      </section>
    </div>
  </fv-shell>

  <div id="toast" class="toast" role="status" aria-live="polite">Saved.</div>

  <!-- EDIT SHEET -->
  <dialog id="editSheet" class="sheet" aria-modal="true">
    <header>
      <strong id="mdTitle">Edit Seed Product</strong>
      <button id="mdClose" class="btn" type="button">Close</button>
    </header>
    <div class="body">
      <div class="grid-2">
        <div class="field">
          <label for="editCrop">Crop</label>
          <select id="editCrop" class="select">
            <option value="">â€”</option>
            <option value="corn">Corn</option>
            <option value="soybean">Soybean</option>
          </select>
        </div>
        <div class="field">
          <label for="editBrand">Brand</label>
          <!-- values are EXACT label strings stored in Firestore -->
          <select id="editBrand" class="select">
            <option value="">â€”</option>
            <option value="Asgrow">Asgrow</option>
            <option value="Becks">Becks</option>
            <option value="Brevant Seeds">Brevant Seeds</option>
            <option value="Burrus Seed">Burrus Seed</option>
            <option value="Channel">Channel</option>
            <option value="DeKalb">DeKalb</option>
            <option value="Generic">Generic</option>
            <option value="Hisoy">Hisoy</option>
            <option value="Merschman Seeds">Merschman Seeds</option>
            <option value="NuTech">NuTech</option>
            <option value="Pioneer">Pioneer</option>
            <option value="Wyffels Hybrids">Wyffels Hybrids</option>
          </select>
        </div>
      </div>

      <div class="grid-3">
        <div class="field">
          <label for="editVariety">Product / Variety</label>
          <input id="editVariety" class="input">
        </div>
        <div class="field">
          <label for="editMaturity">Maturity</label>
          <input id="editMaturity" class="input" inputmode="decimal">
        </div>
        <div class="field">
          <label for="editTrait">Trait System</label>
          <!-- values are trait codes as stored in Firestore -->
          <select id="editTrait" class="select">
            <option value="">â€”</option>
            <option value="CONV">Conventional (Non-GMO)</option>
            <option value="VT2P">VT Double PRO (VT2P)</option>
            <option value="TRE">Trecepta</option>
            <option value="TRERIB">Trecepta RIB</option>
            <option value="SS">SmartStax</option>
            <option value="SSPRO">SmartStax PRO</option>
            <option value="QROME">Qrome</option>
            <option value="PC">PowerCore</option>
            <option value="PCU">PowerCore Ultra</option>
            <option value="VIPTERA">Agrisure Viptera</option>
            <option value="DURACADE">Agrisure Duracade</option>
            <option value="ENLISTC">Enlist Corn (herbicide)</option>
            <option value="CLEAR">CLEARFIELD (IMI)</option>

            <option value="E3">Enlist E3</option>
            <option value="XF">XtendFlex</option>
            <option value="RR2X">Roundup Ready 2 Xtend</option>
            <option value="RR2Y">Roundup Ready 2 Yield</option>
            <option value="LL">LibertyLink</option>
            <option value="LLGT27">LibertyLink GT27</option>
            <option value="STS">STS</option>
          </select>
        </div>
      </div>

      <div class="field">
        <label for="editNotes">Notes</label>
        <textarea id="editNotes" class="textarea"></textarea>
      </div>

      <div class="field" style="align-self:end">
        <span class="pill" id="statusPill">Status</span>
      </div>

      <div class="field">
        <label>Raw document</label>
        <pre id="rawJson" class="raw-box"></pre>
      </div>
    </div>
    <footer>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <button id="mdArchive" class="btn btn-quiet" type="button">Archive</button>
        <button id="mdDelete" class="btn btn-danger" type="button">Delete</button>
      </div>
      <button id="mdSave" class="btn btn-primary" type="button">Save Changes</button>
    </footer>
  </dialog>

  <script type="module">
    import {
      ready,
      getFirestore,
      collection,
      doc,
      getDocs,
      getDoc,
      setDoc,
      deleteDoc,
      serverTimestamp
    } from "/Farm-vista/js/firebase-init.js";

    const $  = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));

    const alertBox = $("#alert");
    const listBox  = $("#list");
    const toast    = $("#toast");

    const dlg     = $("#editSheet");
    const mdClose = $("#mdClose");
    const mdSave  = $("#mdSave");
    const mdArchive = $("#mdArchive");
    const mdDelete  = $("#mdDelete");

    const editCrop     = $("#editCrop");
    const editBrand    = $("#editBrand");
    const editVariety  = $("#editVariety");
    const editMaturity = $("#editMaturity");
    const editTrait    = $("#editTrait");
    const editNotes    = $("#editNotes");
    const statusPill   = $("#statusPill");
    const rawJsonEl    = $("#rawJson");

    let SEEDS = [];
    let currentId = null;
    let currentDoc = null;

    const showToast = (msg="Saved.")=>{
      toast.textContent = msg;
      toast.classList.remove("show");
      void toast.offsetWidth;
      toast.classList.add("show");
    };
    const showError = (msg)=>{
      alertBox.textContent = msg;
      alertBox.classList.add("show");
      clearTimeout(showError._t);
      showError._t = setTimeout(()=> alertBox.classList.remove("show"), 7000);
    };

    function card(doc){
      const el = document.createElement("div");
      el.className = "item";
      const name = `${doc.brand || "(Brand)"} ${doc.variety || ""}`.trim();
      const crop = doc.crop || (doc.cropCorn ? "corn" : doc.cropSoy ? "soybean" : "");
      const trait = doc.traitLabel || doc.trait || "";
      const mat = doc.maturity || "";

      el.innerHTML = `
        <div class="item-main">
          <div class="name">${name}</div>
          ${crop ? `<span class="pill">${crop}</span>` : ""}
          ${mat ? `<span class="pill">${mat}</span>` : ""}
          ${trait ? `<span class="pill">${trait}</span>` : ""}
          ${doc.status === "archived" ? `<span class="pill pill-arch">archived</span>` : ""}
        </div>
      `;
      el.addEventListener("click", ()=> openEditor(doc.id));
      return el;
    }

    async function loadSeeds(){
      try{
        const db = getFirestore();
        const snap = await getDocs(collection(db, "productsSeed"));
        const out = [];
        snap.forEach(d=>{
          out.push({ id: d.id, ...d.data() });
        });
        SEEDS = out.sort((a,b)=>{
          const aa = (a.brand || "") + " " + (a.variety || "");
          const bb = (b.brand || "") + " " + (b.variety || "");
          return aa.localeCompare(bb, undefined, { sensitivity: "base" });
        });

        listBox.innerHTML = "";
        if(!SEEDS.length){
          listBox.innerHTML = '<div class="muted">No seed products.</div>';
          return;
        }
        SEEDS.forEach(doc => listBox.appendChild(card(doc)));
      }catch(e){
        console.error(e);
        showError(e.message || "Load failed.");
      }
    }

    function openDialog(){
      try{ dlg.showModal(); }catch{ dlg.setAttribute("open",""); }
    }
    function closeDialog(){
      try{ dlg.close(); }catch{ dlg.removeAttribute("open"); }
      currentId = null;
      currentDoc = null;
    }

    async function openEditor(id){
      try{
        const db = getFirestore();
        const snap = await getDoc(doc(db, "productsSeed", id));
        if(!snap.exists()){
          alert("Seed product not found.");
          return;
        }
        currentId = id;
        currentDoc = { id, ...snap.data() };

        const d = currentDoc;

        const cropVal = d.crop || (d.cropCorn ? "corn" : d.cropSoy ? "soybean" : "");
        editCrop.value = cropVal || "";

        editBrand.value = d.brand || "";

        editVariety.value  = d.variety || "";
        editMaturity.value = d.maturity || "";
        editTrait.value    = d.trait || "";
        editNotes.value    = d.notes || "";

        const st = d.status || "active";
        statusPill.textContent = st;
        statusPill.className = "pill" + (st === "archived" ? " pill-arch" : "");
        mdArchive.textContent = st === "archived" ? "Unarchive" : "Archive";

        rawJsonEl.textContent = JSON.stringify(d, null, 2);

        openDialog();
      }catch(e){
        console.error(e);
        showError(e.message || "Failed to load product.");
      }
    }

    async function saveEdits(){
      if(!currentId || !currentDoc) return;
      const cropV   = editCrop.value;
      const brandV  = editBrand.value.trim();
      const varV    = editVariety.value.trim();
      const matV    = editMaturity.value.trim();
      const traitV  = editTrait.value.trim();
      const notesV  = editNotes.value.trim();

      if(!cropV){ alert("Choose a crop."); return; }
      if(!brandV){ alert("Choose a brand."); return; }
      if(!varV){ alert("Enter product/variety."); return; }
      if(!matV){ alert("Enter maturity."); return; }
      if(!traitV){ alert("Select a trait system."); return; }

      try{
        const db = getFirestore();
        const payload = {
          crop: cropV,
          brand: brandV,
          variety: varV,
          maturity: matV,
          trait: traitV,
          notes: notesV,
          cropCorn: cropV === "corn",
          cropSoy: cropV === "soybean",
          status: currentDoc.status || "active",
          updatedAt: serverTimestamp()
        };
        await setDoc(doc(db, "productsSeed", currentId), payload, { merge: true });
        showToast("Saved.");
        closeDialog();
        await loadSeeds();
      }catch(e){
        console.error(e);
        showError(e.message || "Save failed.");
      }
    }

    async function toggleArchive(){
      if(!currentId || !currentDoc) return;
      try{
        const db = getFirestore();
        const next = currentDoc.status === "archived" ? "active" : "archived";
        await setDoc(doc(db, "productsSeed", currentId), {
          status: next,
          updatedAt: serverTimestamp()
        }, { merge: true });
        showToast(next === "archived" ? "Archived." : "Unarchived.");
        closeDialog();
        await loadSeeds();
      }catch(e){
        console.error(e);
        showError(e.message || "Archive failed.");
      }
    }

    async function deleteProduct(){
      if(!currentId || !currentDoc) return;
      if(!confirm(`Delete seed "${(currentDoc.brand||"") + " " + (currentDoc.variety||"")}"? This cannot be undone.`)) return;
      try{
        const db = getFirestore();
        await deleteDoc(doc(db, "productsSeed", currentId));
        showToast("Deleted.");
        closeDialog();
        await loadSeeds();
      }catch(e){
        console.error(e);
        showError(e.message || "Delete failed.");
      }
    }

    mdClose.addEventListener("click", closeDialog);
    mdSave.addEventListener("click", saveEdits);
    mdArchive.addEventListener("click", toggleArchive);
    mdDelete.addEventListener("click", deleteProduct);

    (async()=>{
      await ready;
      await loadSeeds();
    })();
  </script>
</body>
</html>
