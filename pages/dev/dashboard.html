<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FarmVista ‚Ä¢ Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
  <meta name="theme-color" content="#3B7E46" />

  <!-- IMPORTANT: make all relative URLs resolve under /Farm-vista/ -->
  <base href="/Farm-vista/">

  <!-- ‚úÖ Theme + firebase boot chain + auth guard + user context warm -->
  <script src="js/theme-boot.js"></script>

  <!-- Standard includes (relative to <base>) -->
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="apple-touch-icon" href="assets/icons/apple-touch-icon.png" />
  <link rel="icon" href="assets/icons/icon-192.png" />
  <link rel="stylesheet" href="assets/css/theme.css?v=PV1" />
  <link rel="stylesheet" href="assets/css/app.css?v=PV1" />

  <!-- Firebase config + FVData (needed to read messages from Firestore) -->
  <script src="js/firebase-config.js"></script>
  <script src="js/fv-data.js"></script>

  <!-- Shared grain capacity helpers (corn ‚Üí other crops) -->
  <script src="js/grain-capacity.js?v=PV1"></script>

  <!-- Load core first (theme + App API), then the shell -->
  <script src="js/core.js?v=PV1"></script>
  <script src="js/fv-shell.js?v=PV1" defer></script>

  <style>
    body{
      background:var(--app-bg,var(--surface));
      min-height:100vh;
    }
    .page{
      max-width:1100px;
      margin:0 auto;
      padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + 96px)!important;
    }
    .page-title{
      margin:0 0 8px 0;
    }
    .section{
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));
      overflow:hidden;
    }
    .section-head{
      display:grid;
      grid-template-columns:36px 1fr;
      gap:12px;
      align-items:center;
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);
    }
    .section-head .icon{
      width:24px;
      height:24px;
      color:#2F6C3C;
      display:grid;
      place-items:center;
    }
    .section-body{
      padding:16px;
      display:grid;
      gap:10px;
    }
    .msg{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      background:var(--card-surface,var(--surface));
    }
    .msg .title{
      font-weight:800;
      margin:0 0 4px 0;
    }
    .chips{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      margin-top:6px;
    }
    .chip{
      font-size:12px;
      border:1px solid var(--border);
      border-radius:999px;
      padding:4px 8px;
      color:var(--muted,#67706B);
      background:var(--surface);
    }
    .empty{
      color:var(--muted,#67706B);
    }

    /* =======================
       Dashboard KPI card
       ======================= */
    .dash-kpi{
      display:block;
      margin:12px 0 18px 0;
      padding:14px 16px;
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--surface);
      box-shadow:0 8px 18px rgba(0,0,0,0.06);
      text-decoration:none;
      color:inherit;
      transition:transform 0.08s ease, box-shadow 0.08s ease, border-color 0.08s ease;
    }
    .dash-kpi:hover{
      transform:translateY(-1px);
      box-shadow:0 12px 24px rgba(0,0,0,0.10);
      border-color:rgba(59,126,70,0.55);
    }
    .dash-kpi-main{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      flex-wrap:wrap;
    }
    .dash-kpi-text{
      flex:1 1 180px;
      min-width:0;
    }
    .dash-kpi-label{
      font-size:13px;
      letter-spacing:.06em;
      text-transform:uppercase;
      font-weight:600;
      color:var(--muted,#67706B);
      margin-bottom:4px;
    }
    .dash-kpi-title{
      font-size:15px;
      font-weight:600;
    }
    .dash-kpi-count{
      min-width:52px;
      min-height:52px;
      height:52px;
      line-height:1;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:22px;
      font-weight:700;
      border:1px solid rgba(59,126,70,0.4);
      background:rgba(59,126,70,0.10);
    }
    .dash-kpi-sub{
      margin-top:6px;
      font-size:12px;
      color:var(--muted,#67706B);
    }
    .dash-kpi-empty .dash-kpi-count{
      border-color:rgba(0,0,0,0.12);
      background:rgba(0,0,0,0.02);
      color:var(--muted,#67706B);
    }

    /* Permission hidden helper */
    .perm-hidden{
      display:none !important;
    }

    /* =======================
       Quick Links
       ======================= */
    #quick-links{
      margin:10px 0 14px 0;
    }
    .ql-grid{
      display:grid;
      gap:10px;
      grid-template-columns:repeat(1, minmax(0,1fr));
    }
    @media (min-width: 720px){
      .ql-grid{
        grid-template-columns:repeat(3, minmax(0,1fr));
      }
    }
    .ql-btn{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--card-surface,var(--surface));
      text-decoration:none;
      color:inherit;
      box-shadow:0 8px 18px rgba(0,0,0,0.06);
      transition:transform 0.08s ease, box-shadow 0.08s ease, border-color 0.08s ease;
      min-height:62px;
    }
    .ql-btn:hover{
      transform:translateY(-1px);
      box-shadow:0 12px 24px rgba(0,0,0,0.10);
      border-color:rgba(59,126,70,0.55);
    }
    .ql-left{
      display:flex;
      flex-direction:column;
      gap:3px;
      min-width:0;
    }
    .ql-label{
      font-size:12px;
      letter-spacing:.06em;
      text-transform:uppercase;
      font-weight:700;
      color:var(--muted,#67706B);
    }
    .ql-title{
      font-size:15px;
      font-weight:700;
      line-height:1.2;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .ql-sub{
      font-size:12px;
      color:var(--muted,#67706B);
      line-height:1.25;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .ql-right{
      flex:0 0 auto;
      width:36px;
      height:36px;
      border-radius:999px;
      display:grid;
      place-items:center;
      border:1px solid rgba(59,126,70,0.35);
      background:rgba(59,126,70,0.10);
      font-size:16px;
    }

    /* =======================
       Weather card + modal
       ======================= */
    #fv-weather{
      max-width:1100px;
      margin:6px auto 14px auto;
    }
    .fv-weather-card{
      border-radius:14px;
      border:1px solid var(--border,#d1d5db);
      background:var(--card-surface,var(--surface));
      box-shadow:0 8px 18px rgba(0,0,0,0.06);
      padding:10px 14px 12px;
      cursor:pointer;
    }
    .fv-weather-modal{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.45);
      display:flex;
      justify-content:center;
      align-items:center;
      padding-top:calc(var(--hdr-h,56px) + 16px);
      padding-bottom:calc(var(--ftr-h,42px) + env(safe-area-inset-bottom,0px) + 16px);
      padding-left:16px;
      padding-right:16px;
      overflow:hidden;
      z-index:9999;
    }
    .fv-weather-modal[hidden]{ display:none!important; }
    .fv-weather-modal-inner{
      position:relative;
      width:100%;
      max-width:900px;
      max-height:calc(100vh - var(--hdr-h,56px) - var(--ftr-h,42px) - env(safe-area-inset-bottom,0px) - 32px);
      margin:auto;
      border-radius:18px;
      border:1px solid var(--border,#d1d5db);
      background:var(--surface,#fff);
      box-shadow:0 18px 40px rgba(0,0,0,0.3);
      padding:16px 16px 18px;
      overflow:auto;
      -ms-overflow-style:none;
      scrollbar-width:none;
    }
    .fv-weather-modal-inner::-webkit-scrollbar{ width:0; height:0; }
    .fv-weather-modal-close{
      position:absolute;
      top:10px;
      right:10px;
      width:28px;
      height:28px;
      border-radius:999px;
      border:1px solid var(--border,#d1d5db);
      background:var(--surface,#fff);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      font-size:16px;
      line-height:1;
      color:inherit;
    }
    .fv-weather-modal-title{
      font-size:15px;
      font-weight:600;
      margin:0 0 10px 0;
    }

    /* =======================
       Markets (layout wrapper)
       ======================= */
    #fv-markets{
      display:grid;
      gap:10px;
    }
    .fv-mkt-grid{
      display:grid;
      gap:10px;
      grid-template-columns:1fr;
    }
    @media (min-width: 900px){
      .fv-mkt-grid{
        grid-template-columns:1fr 1fr;
      }
    }

    /* =======================
       Markets (desktop: fixed height + internal scroll, hide scrollbar)
       ======================= */
    @media (min-width: 900px){
      #markets-section #fv-markets{
        max-height:520px;          /* ~5‚Äì6 tiles visible, then scroll */
        overflow-y:auto;
        overflow-x:hidden;
        padding-right:12px;        /* keep content off hidden scrollbar area */
        -webkit-overflow-scrolling:touch;
      }
      #markets-section #fv-markets::-webkit-scrollbar{ width:0; height:0; }
      #markets-section #fv-markets{ scrollbar-width:none; -ms-overflow-style:none; }

      /* optional: keep header visible while scrolling */
      #markets-section .section-head{
        position:sticky;
        top:0;
        z-index:5;
      }
    }

    /* ============================
       FarmVista Copilot (AI box)
       ============================ */
    .ai-section .section-head strong{ display:block; }
    .ai-section .section-head .sub{
      font-size:12px;
      color:var(--muted,#67706B);
      margin-top:2px;
    }
    .ai-body{
      display:grid;
      gap:12px;
      grid-template-rows:minmax(220px, 320px) auto;
    }
    .ai-log{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
      background:var(--card-surface,var(--surface));
      display:flex;
      flex-direction:column;
      gap:8px;
      overflow:auto;
      max-height:320px;
      font-size:13px;
    }
    .ai-empty{
      color:var(--muted,#67706B);
      font-size:13px;
    }
    .ai-msg-wrap{
      display:flex;
      flex-direction:column;
      gap:3px;
      margin:2px 0 6px;
      max-width:100%;
    }
    .ai-msg{
      display:block;
      width:fit-content;
      max-width:80%;
      border-radius:14px;
      padding:6px 8px;
      line-height:1.3;
      white-space:pre-wrap;
      word-break:break-word;
      font-size:13px;
    }
    .ai-msg-user{
      align-self:flex-end;
      background:rgba(59,126,70,0.12);
      border:1px solid rgba(59,126,70,0.25);
    }
    .ai-msg-assistant{
      align-self:flex-start;
      background:var(--surface);
      border:1px solid var(--border);
    }
    .ai-msg-meta{
      font-size:11px;
      color:var(--muted,#67706B);
      opacity:0.85;
      padding:0 6px;
      line-height:1.2;
    }
    .ai-msg-meta.user{ text-align:right; }
    .ai-msg-meta.assistant{ text-align:left; }

    .ai-form{ display:grid; gap:6px; }
    .ai-input-wrap{ position:relative; display:block; }
    .ai-input{
      width:100%;
      resize:none;
      border-radius:16px;
      border:1px solid var(--border);
      padding:10px 42px 10px 12px;
      min-height:32px;
      max-height:96px;
      font:inherit;
      background:var(--surface);
      color:inherit;
      line-height:1.35;
      font-size:13px;
      overflow:hidden;
      scrollbar-width:none;
      -ms-overflow-style:none;
    }
    .ai-input::-webkit-scrollbar{ width:0; height:0; }
    .ai-input:focus{
      outline:2px solid rgba(59,126,70,0.4);
      outline-offset:1px;
    }
    .ai-mic{
      position:absolute;
      right:10px;
      top:50%;
      transform:translateY(-50%);
      width:24px;
      height:24px;
      border:none;
      background:transparent;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      outline:none;
      color:var(--muted,#67706B);
      padding:0;
    }
    .ai-mic-icon{
      width:18px;
      height:18px;
      display:block;
      stroke:currentColor;
      stroke-width:1.8;
      stroke-linecap:round;
      stroke-linejoin:round;
      fill:none;
    }
    .ai-mic:hover:not([disabled]){ transform:translateY(-50%) scale(1.05); }
    .ai-mic[disabled]{ opacity:0.5; cursor:default; }
    .ai-mic.recording{ color:#cc3030; }

    @media (min-width: 900px){
      .ai-mic{ display:none !important; }
      .ai-input{ padding-right:12px; }
    }

    .ai-actions{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      flex-wrap:wrap;
    }
    .ai-send{
      border-radius:999px;
      border:1px solid var(--border);
      background:#3B7E46;
      padding:8px 16px;
      font-size:14px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      color:#fff;
      min-height:36px;
      outline:none;
    }
    #ai-send, .ai-send{ color:#fff !important; }
    #ai-send * , .ai-send *{ color:#fff !important; }

    .ai-send[disabled]{ opacity:0.5; cursor:default; }
    .ai-hint{ font-size:12px; color:var(--muted,#67706B); }
    .ai-status{ font-size:12px; color:var(--muted,#67706B); flex:1; text-align:right; }
  </style>
</head>

<body>
  <fv-shell>
    <div class="page container">
      <h1 class="page-title">Dashboard</h1>

      <!-- ======================
           Weather (above board)
           ====================== -->
      <div id="fv-weather" aria-label="Weather"></div>

      <!-- ======================
           Markets (NEW)
           ====================== -->
      <section class="section" id="markets-section" aria-label="Markets">
        <header class="section-head">
          <div class="icon" aria-hidden="true">üìà</div>
          <div><strong>Markets</strong></div>
        </header>
        <div class="section-body" id="fv-markets">
          <div class="fv-mkt-grid">
            <div data-fv="mktCorn" aria-label="Corn markets"></div>
            <div data-fv="mktSoy" aria-label="Soybean markets"></div>
          </div>
          <div data-fv="mktMeta" aria-label="Markets meta"></div>
        </div>
      </section>

      <!-- ======================
           Quick Links
           ====================== -->
      <section class="section" id="quick-links" aria-label="Quick Links">
        <header class="section-head">
          <div class="icon" aria-hidden="true">‚ö°</div>
          <div><strong>Quick Links</strong></div>
        </header>
        <div class="section-body">
          <div class="ql-grid">
            <a href="pages/office/field-boundaries.html" class="ql-btn" id="ql-boundaries" aria-label="Field Boundaries">
              <div class="ql-left">
                <div class="ql-label">Office</div>
                <div class="ql-title">Field Boundaries</div>
                <div class="ql-sub">Request edits / manage boundaries</div>
              </div>
              <div class="ql-right" aria-hidden="true">üó∫Ô∏è</div>
            </a>

            <a href="pages/crop-production/field-maintenance/maintenance-add.html" class="ql-btn" id="ql-maint-add" aria-label="Add Field Maintenance">
              <div class="ql-left">
                <div class="ql-label">Crop Production</div>
                <div class="ql-title">Add Maintenance</div>
                <div class="ql-sub">Start a new work order</div>
              </div>
              <div class="ql-right" aria-hidden="true">üß∞</div>
            </a>

            <a href="pages/equipment/shop-equipment-bulk.html" class="ql-btn" id="ql-equip-overview" aria-label="Equipment Overview">
              <div class="ql-left">
                <div class="ql-label">Equipment</div>
                <div class="ql-title">Equipment Overview</div>
                <div class="ql-sub">Bulk view / quick scan</div>
              </div>
              <div class="ql-right" aria-hidden="true">üöú</div>
            </a>

            <a href="pages/crop-production/field-weather.html" class="ql-btn" id="ql-field-weather" aria-label="Field Weather">
              <div class="ql-left">
                <div class="ql-label">Crop Production</div>
                <div class="ql-title">Field Weather</div>
                <div class="ql-sub">Forecast + rainfall by field</div>
              </div>
              <div class="ql-right" aria-hidden="true">üå¶Ô∏è</div>
            </a>
          </div>
        </div>
      </section>

      <!-- =======================
           Message Board
           ======================= -->
      <section class="section" aria-label="Message Board">
        <header class="section-head">
          <div class="icon" aria-hidden="true">üì¢</div>
          <div><strong>Message Board</strong></div>
        </header>
        <div class="section-body" id="board">
          <div class="msg empty">No messages at this time.</div>
        </div>
      </section>

      <!-- =====================================
           KPI: Work orders needing approval
           ===================================== -->
      <a href="pages/crop-production/field-maintenance/maintenance-approve.html" class="dash-kpi dash-kpi-empty" id="wo-approve-kpi">
        <div class="dash-kpi-main">
          <div class="dash-kpi-text">
            <div class="dash-kpi-label">Field Maintenance Work Orders</div>
            <div class="dash-kpi-title">Needing approval before work can begin</div>
          </div>
          <div class="dash-kpi-count" id="wo-approve-count">‚Äì</div>
        </div>
        <div class="dash-kpi-sub" id="wo-approve-sub">Checking for pending approvals‚Ä¶</div>
      </a>

      <!-- =====================================
           KPI: Field boundary fixes needed
           ===================================== -->
      <a href="pages/reports/reports-boundary-requests.html" class="dash-kpi dash-kpi-empty" id="boundary-kpi">
        <div class="dash-kpi-main">
          <div class="dash-kpi-text">
            <div class="dash-kpi-label">Field Boundaries</div>
            <div class="dash-kpi-title">Needing map corrections</div>
          </div>
          <div class="dash-kpi-count" id="boundary-kpi-count">‚Äì</div>
        </div>
        <div class="dash-kpi-sub" id="boundary-kpi-sub">Checking for open boundary requests‚Ä¶</div>
      </a>

      <!-- =====================================
           KPI: Grain bag inventory on hand
           ===================================== -->
      <a href="pages/reports/reports-grain-bag-inventory.html" class="dash-kpi dash-kpi-empty" id="bag-kpi">
        <div class="dash-kpi-main">
          <div class="dash-kpi-text">
            <div class="dash-kpi-label">Grain Bag Inventory</div>
            <div class="dash-kpi-title">Bags remaining in sheds</div>
          </div>
          <div class="dash-kpi-count" id="bag-kpi-count">‚Äì</div>
        </div>
        <div class="dash-kpi-sub" id="bag-kpi-sub">Summing bags and bushels on hand‚Ä¶</div>
      </a>

      <!-- ============================
           FarmVista Copilot (AI Box)
           ============================ -->
      <section class="section ai-section" id="ai-section" aria-label="FarmVista Copilot">
        <header class="section-head">
          <div class="icon" aria-hidden="true">ü§ñ</div>
          <div>
            <strong>FarmVista Copilot (beta)</strong>
            <div class="sub">Ask questions about your fields, equipment, work orders, and more.</div>
          </div>
        </header>
        <div class="section-body ai-body">
          <div id="ai-chat-log" class="ai-log" aria-live="polite">
            <div class="ai-empty">
              Start by asking something like:<br>
              ‚Ä¢ "Show me pending field maintenance for today."<br>
              ‚Ä¢ "Summarize all grain bags at Farm 02."<br>
              ‚Ä¢ "Draft a report for yesterday‚Äôs combine work orders."
            </div>
          </div>

          <form id="ai-chat-form" class="ai-form" autocomplete="off">
            <div class="ai-input-wrap">
              <textarea id="ai-input" class="ai-input" rows="1" placeholder="Ask FarmVista Copilot..."></textarea>
              <button type="button" id="ai-mic" class="ai-mic" aria-label="Start voice dictation">
                <svg class="ai-mic-icon" viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M12 5a2.5 2.5 0 0 1 2.5 2.5v4a2.5 2.5 0 0 1-5 0v-4A2.5 2.5 0 0 1 12 5z" />
                  <path d="M9.75 11.5v.5a2.25 2.25 0 0 0 4.5 0v-.5" />
                  <path d="M8 11.5v.5a4 4 0 0 0 8 0v-.5" />
                  <path d="M12 15.5v3" />
                  <path d="M9.5 18.5h5" />
                </svg>
              </button>
            </div>

            <div class="ai-actions">
              <button type="submit" id="ai-send" class="ai-send" aria-label="Send question">Send</button>
              <div class="ai-status" id="ai-status" aria-live="polite"></div>
            </div>

            <div class="ai-hint">
              Connected to your FarmVista AI backend. Early beta ‚Äì answers may be generic for now.
            </div>
          </form>
        </div>
      </section>
    </div>
  </fv-shell>

  <!-- Weather detail modal -->
  <div id="fv-weather-modal" class="fv-weather-modal" role="presentation" hidden>
    <div class="fv-weather-modal-inner" role="dialog" aria-modal="true" aria-labelledby="fv-weather-modal-title">
      <button type="button" id="fv-weather-modal-close" class="fv-weather-modal-close" aria-label="Close weather details">√ó</button>
      <h2 id="fv-weather-modal-title" class="fv-weather-modal-title">Weather details</h2>
      <div id="fv-weather-modal-body"></div>
    </div>
  </div>

  <!-- ==========================
       WEATHER module (Google + Open-Meteo)
       ========================== -->
  <script src="js/fv-weather.js?v=PV1"></script>
  <script>
  (function(){
    "use strict";
    document.addEventListener("DOMContentLoaded", function(){
      if (window.FVWeather && typeof FVWeather.initWeatherModule === "function") {
        FVWeather.initWeatherModule({
          googleApiKey: "AIzaSyD5qLrXZch_rM4sVXmBrpGDH3Zp7RgfVHc",
          lat: 39.5656,
          lon: -89.6573,
          unitsSystem: "IMPERIAL",
          selector: "#fv-weather",
          showOpenMeteo: true,
          mode: "card",
          locationLabel: "Divernon, Illinois"
        });
      } else {
        console.warn("[dashboard] FVWeather module not found.");
      }
    });
  })();
  </script>

  <!-- Weather modal wiring (extracted helper) -->
  <script src="js/dash-weather-modal.js?v=PV1"></script>

  <!-- ‚úÖ FIX: ensure markets.js hits Cloud Run regardless of dev path + <base> -->
  <script>
    window.FV_MARKETS_BASE_URL = "https://farmvista-markets-300398089669.us-central1.run.app";
  </script>

<!-- Markets module -->
<script src="js/markets.js?v=PV2"></script>

<script src="js/dash-markets-style.js?v=PV2"></script>
<script src="js/dash-markets-chart.js?v=PV2"></script>
<script src="js/dash-markets-series.js?v=PV2"></script>
<script src="js/dash-markets-quotes.js?v=PV2"></script>

<script src="js/dash-markets-ui.js?v=PV2"></script>



  <script>
  (function(){
    "use strict";
    function start(){
      try{
        if (window.FVMarkets && typeof window.FVMarkets.start === "function") {
          window.FVMarkets.start();
        }
      }catch(e){
        console.warn("[dashboard] markets start failed:", e);
      }
    }
    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", start, { once:true });
    } else {
      start();
    }
  })();
  </script>

  <!-- Permissions (extracted helper) -->
  <script type="module" src="js/dash-perms.js?v=PV1"></script>

  <!-- Other dashboard helpers (extracted) -->
  <script src="js/dash-message-board.js?v=PV1"></script>
  <script src="js/dash-kpi-wo.js?v=PV1"></script>
  <script type="module" src="js/dash-kpi-boundary.js?v=PV1"></script>
  <script type="module" src="js/dash-kpi-bags.js?v=PV1"></script>

  <!-- ==========================
       Copilot UI module (keep)
       ========================== -->
  <script>
    (function(){
      const f = document.getElementById('ai-chat-form');
      if (!f) return;
      f.addEventListener('submit', function(e){
        if (!window.__FV_COPILOT_WIRED) {
          e.preventDefault();
          e.stopPropagation();
        }
      }, true);
    })();
  </script>

  <script type="module">
    import { FVCopilotUI } from '/Farm-vista/js/copilot-ui.js';

    let _copilotInited = false;

    function initCopilot(){
      if (_copilotInited) return;
      _copilotInited = true;
      try{ FVCopilotUI.init(); }
      catch(e){ console.warn("[dashboard] copilot-ui init failed:", e); }
    }

    initCopilot();
    document.addEventListener("fv:dash-perms-ready", initCopilot);
  </script>

</body>
</html>
