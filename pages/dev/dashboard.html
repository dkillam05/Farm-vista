<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FarmVista ‚Ä¢ Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
  <meta name="theme-color" content="#3B7E46" />

  <!-- IMPORTANT: make all relative URLs resolve under /Farm-vista/ -->
  <base href="/Farm-vista/">

  <!-- ‚úÖ Theme + firebase boot chain + auth guard + user context warm -->
  <script src="js/theme-boot.js"></script>

  <!-- Standard includes (relative to <base>) -->
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="apple-touch-icon" href="assets/icons/apple-touch-icon.png" />
  <link rel="icon" href="assets/icons/icon-192.png" />
  <link rel="stylesheet" href="assets/css/theme.css?v=PV1" />
  <link rel="stylesheet" href="assets/css/app.css?v=PV1" />

  <!-- Firebase config + FVData (needed to read messages from Firestore) -->
  <script src="js/firebase-config.js"></script>
  <script src="js/fv-data.js"></script>

  <!-- Shared grain capacity helpers (corn ‚Üí other crops) -->
  <script src="js/grain-capacity.js?v=PV1"></script>

  <!-- Load core first (theme + App API), then the shell -->
  <script src="js/core.js?v=PV1"></script>
  <script src="js/fv-shell.js?v=PV1" defer></script>

  <style>
    body{
      background:var(--app-bg,var(--surface));
      min-height:100vh;
    }
    .page{
      max-width:1100px;
      margin:0 auto;
      padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + 96px)!important;
    }
    .page-title{
      margin:0 0 8px 0;
    }
    .section{
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));
      overflow:hidden;
    }
    .section-head{
      display:grid;
      grid-template-columns:36px 1fr;
      gap:12px;
      align-items:center;
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);
    }
    .section-head .icon{
      width:24px;
      height:24px;
      color:#2F6C3C;
      display:grid;
      place-items:center;
    }
    .section-body{
      padding:16px;
      display:grid;
      gap:10px;
    }
    .msg{
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      background:var(--card-surface,var(--surface));
    }
    .msg .title{
      font-weight:800;
      margin:0 0 4px 0;
    }
    .chips{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      margin-top:6px;
    }
    .chip{
      font-size:12px;
      border:1px solid var(--border);
      border-radius:999px;
      padding:4px 8px;
      color:var(--muted,#67706B);
      background:var(--surface);
    }
    .empty{
      color:var(--muted,#67706B);
    }

    /* =======================
       Dashboard KPI card
       ======================= */
    .dash-kpi{
      display:block;
      margin:12px 0 18px 0;
      padding:14px 16px;
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--surface);
      box-shadow:0 8px 18px rgba(0,0,0,0.06);
      text-decoration:none;
      color:inherit;
      transition:transform 0.08s ease, box-shadow 0.08s ease, border-color 0.08s ease;
    }
    .dash-kpi:hover{
      transform:translateY(-1px);
      box-shadow:0 12px 24px rgba(0,0,0,0.10);
      border-color:rgba(59,126,70,0.55);
    }
    .dash-kpi-main{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      flex-wrap:wrap;
    }
    .dash-kpi-text{
      flex:1 1 180px;
      min-width:0;
    }
    .dash-kpi-label{
      font-size:13px;
      letter-spacing:.06em;
      text-transform:uppercase;
      font-weight:600;
      color:var(--muted,#67706B);
      margin-bottom:4px;
    }
    .dash-kpi-title{
      font-size:15px;
      font-weight:600;
    }
    .dash-kpi-count{
      min-width:52px;
      min-height:52px;
      height:52px;
      line-height:1;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:22px;
      font-weight:700;
      border:1px solid rgba(59,126,70,0.4);
      background:rgba(59,126,70,0.10);
    }
    .dash-kpi-sub{
      margin-top:6px;
      font-size:12px;
      color:var(--muted,#67706B);
    }
    .dash-kpi-empty .dash-kpi-count{
      border-color:rgba(0,0,0,0.12);
      background:rgba(0,0,0,0.02);
      color:var(--muted,#67706B);
    }

    /* Permission hidden helper */
    .perm-hidden{
      display:none !important;
    }

    /* =======================
       Quick Links
       ======================= */
    #quick-links{
      margin:10px 0 14px 0;
    }
    .ql-grid{
      display:grid;
      gap:10px;
      grid-template-columns:repeat(1, minmax(0,1fr));
    }
    @media (min-width: 720px){
      .ql-grid{
        grid-template-columns:repeat(3, minmax(0,1fr));
      }
    }
    .ql-btn{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--card-surface,var(--surface));
      text-decoration:none;
      color:inherit;
      box-shadow:0 8px 18px rgba(0,0,0,0.06);
      transition:transform 0.08s ease, box-shadow 0.08s ease, border-color 0.08s ease;
      min-height:62px;
    }
    .ql-btn:hover{
      transform:translateY(-1px);
      box-shadow:0 12px 24px rgba(0,0,0,0.10);
      border-color:rgba(59,126,70,0.55);
    }
    .ql-left{
      display:flex;
      flex-direction:column;
      gap:3px;
      min-width:0;
    }
    .ql-label{
      font-size:12px;
      letter-spacing:.06em;
      text-transform:uppercase;
      font-weight:700;
      color:var(--muted,#67706B);
    }
    .ql-title{
      font-size:15px;
      font-weight:700;
      line-height:1.2;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .ql-sub{
      font-size:12px;
      color:var(--muted,#67706B);
      line-height:1.25;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .ql-right{
      flex:0 0 auto;
      width:36px;
      height:36px;
      border-radius:999px;
      display:grid;
      place-items:center;
      border:1px solid rgba(59,126,70,0.35);
      background:rgba(59,126,70,0.10);
      font-size:16px;
    }

    /* =======================
       Weather card + modal
       ======================= */
    #fv-weather{
      max-width:1100px;
      margin:6px auto 14px auto;
    }
    .fv-weather-card{
      border-radius:14px;
      border:1px solid var(--border,#d1d5db);
      background:var(--card-surface,var(--surface));
      box-shadow:0 8px 18px rgba(0,0,0,0.06);
      padding:10px 14px 12px;
      cursor:pointer;
    }
    .fv-weather-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:6px;
    }
    .fv-weather-title{
      font-weight:600;
      font-size:13px;
      letter-spacing:.06em;
      text-transform:uppercase;
    }
    .fv-weather-meta{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      font-size:11px;
      color:var(--muted,#67706B);
    }
    .fv-weather-refresh{
      border-radius:999px;
      border:1px solid var(--border,#d1d5db);
      background:var(--surface,#fff0);
      padding:4px 8px;
      font-size:12px;
      cursor:pointer;
      color:inherit;
    }
    .fv-weather-refresh:hover{
      border-color:rgba(59,126,70,0.55);
    }
    .fv-weather-body{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .fv-weather-main{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .fv-weather-temp-block{
      display:flex;
      flex-direction:column;
      gap:2px;
      min-width:0;
    }
    .fv-weather-temp{
      font-size:1.8rem;
      font-weight:600;
    }
    .fv-weather-desc{
      font-size:0.9rem;
    }
    .fv-weather-feels,
    .fv-weather-humidity{
      font-size:0.8rem;
      color:var(--muted,#67706B);
    }
    .fv-weather-icon-block{
      flex:0 0 auto;
    }
    .fv-weather-icon{
      width:48px;
      height:48px;
      display:block;
    }
    .fv-weather-rain-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:4px;
    }
    .fv-weather-rain-pill{
      padding:4px 8px;
      border-radius:999px;
      background:var(--card-surface,var(--surface));
      border:1px solid var(--border);
      font-size:11px;
      display:flex;
      flex-wrap:wrap;
      gap:4px;
    }
    .fv-weather-label{
      font-weight:500;
    }
    .fv-weather-value{
      font-variant-numeric:tabular-nums;
    }

    /* ---------- Weather modal overlay & card ---------- */
    .fv-weather-modal{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.45);
      display:flex;
      justify-content:center;
      align-items:center;
      padding-top:calc(var(--hdr-h,56px) + 16px);
      padding-bottom:calc(var(--ftr-h,42px) + env(safe-area-inset-bottom,0px) + 16px);
      padding-left:16px;
      padding-right:16px;
      overflow:hidden;
      z-index:9999;
    }
    .fv-weather-modal[hidden]{
      display:none!important;
    }

    .fv-weather-modal-inner{
      position:relative;
      width:100%;
      max-width:900px;
      max-height:calc(
        100vh - var(--hdr-h,56px) - var(--ftr-h,42px) - env(safe-area-inset-bottom,0px) - 32px
      );
      margin:auto;
      border-radius:18px;
      border:1px solid var(--border,#d1d5db);
      background:var(--surface,#fff);
      box-shadow:0 18px 40px rgba(0,0,0,0.3);
      padding:16px 16px 18px;
      overflow:auto;
      -ms-overflow-style:none;
      scrollbar-width:none;
    }
    .fv-weather-modal-inner::-webkit-scrollbar{
      width:0;
      height:0;
    }

    .fv-weather-modal-close{
      position:absolute;
      top:10px;
      right:10px;
      width:28px;
      height:28px;
      border-radius:999px;
      border:1px solid var(--border,#d1d5db);
      background:var(--surface,#fff);
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      font-size:16px;
      line-height:1;
      color:inherit;
    }
    .fv-weather-modal-title{
      font-size:15px;
      font-weight:600;
      margin:0 0 10px 0;
    }

    /* =======================
       Markets (NEW)
       ======================= */
    #fv-markets{
      margin:10px 0 14px 0;
    }
    .mkt-grid{
      display:grid;
      gap:10px;
      grid-template-columns:repeat(1, minmax(0, 1fr));
    }
    @media (min-width: 720px){
      .mkt-grid{
        grid-template-columns:repeat(2, minmax(0, 1fr));
      }
    }

    /* Markets modal content */
    .mkt-modal-toolbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin:0 0 10px 0;
    }
    .mkt-tabs{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .mkt-tab{
      border:1px solid var(--border,#d1d5db);
      background:var(--surface,#fff);
      border-radius:999px;
      padding:6px 10px;
      font-size:12px;
      cursor:pointer;
      color:inherit;
    }
    .mkt-tab[aria-pressed="true"]{
      border-color:rgba(59,126,70,0.55);
      background:rgba(59,126,70,0.10);
      font-weight:700;
    }
    .mkt-chart-wrap{
      border:1px solid var(--border,#d1d5db);
      border-radius:14px;
      background:var(--card-surface,var(--surface));
      padding:10px;
    }
    .mkt-canvas{
      width:100%;
      height:240px;
      display:block;
    }
    @media (min-width: 720px){
      .mkt-canvas{ height:320px; }
    }
    .mkt-chart-meta{
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      font-size:12px;
      color:var(--muted,#67706B);
      margin-top:8px;
    }
    .mkt-error{
      border:1px solid rgba(204,48,48,0.35);
      background:rgba(204,48,48,0.08);
      border-radius:12px;
      padding:10px 12px;
      color:inherit;
      font-size:13px;
    }
  </style>
</head>

<body>
  <fv-shell>
    <div class="page container">
      <h1 class="page-title">Dashboard</h1>

      <!-- ======================
           Weather (above board)
           ====================== -->
      <div id="fv-weather" aria-label="Weather"></div>

      <!-- ======================
           Markets (NEW)
           ====================== -->
      <section class="section" id="fv-markets" aria-label="Markets">
        <header class="section-head">
          <div class="icon" aria-hidden="true">üìà</div>
          <div><strong>Markets</strong></div>
        </header>
        <div class="section-body">
          <div data-fv="mktMeta"></div>
          <div class="mkt-grid">
            <div data-fv="mktCorn"></div>
            <div data-fv="mktSoy"></div>
          </div>
        </div>
      </section>

      <!-- ======================
           Quick Links
           ====================== -->
      <section class="section" id="quick-links" aria-label="Quick Links">
        <header class="section-head">
          <div class="icon" aria-hidden="true">‚ö°</div>
          <div><strong>Quick Links</strong></div>
        </header>
        <div class="section-body">
          <div class="ql-grid">
            <a href="pages/office/field-boundaries.html" class="ql-btn" id="ql-boundaries" aria-label="Field Boundaries">
              <div class="ql-left">
                <div class="ql-label">Office</div>
                <div class="ql-title">Field Boundaries</div>
                <div class="ql-sub">Request edits / manage boundaries</div>
              </div>
              <div class="ql-right" aria-hidden="true">üó∫Ô∏è</div>
            </a>

            <a href="pages/crop-production/field-maintenance/maintenance-add.html" class="ql-btn" id="ql-maint-add" aria-label="Add Field Maintenance">
              <div class="ql-left">
                <div class="ql-label">Crop Production</div>
                <div class="ql-title">Add Maintenance</div>
                <div class="ql-sub">Start a new work order</div>
              </div>
              <div class="ql-right" aria-hidden="true">üß∞</div>
            </a>

            <a href="pages/equipment/shop-equipment-bulk.html" class="ql-btn" id="ql-equip-overview" aria-label="Equipment Overview">
              <div class="ql-left">
                <div class="ql-label">Equipment</div>
                <div class="ql-title">Equipment Overview</div>
                <div class="ql-sub">Bulk view / quick scan</div>
              </div>
              <div class="ql-right" aria-hidden="true">üöú</div>
            </a>

            <a href="pages/crop-production/field-weather.html" class="ql-btn" id="ql-field-weather" aria-label="Field Weather">
              <div class="ql-left">
                <div class="ql-label">Crop Production</div>
                <div class="ql-title">Field Weather</div>
                <div class="ql-sub">Forecast + rainfall by field</div>
              </div>
              <div class="ql-right" aria-hidden="true">üå¶Ô∏è</div>
            </a>
          </div>
        </div>
      </section>

      <!-- =======================
           Message Board
           ======================= -->
      <section class="section" aria-label="Message Board">
        <header class="section-head">
          <div class="icon" aria-hidden="true">üì¢</div>
          <div><strong>Message Board</strong></div>
        </header>
        <div class="section-body" id="board">
          <div class="msg empty">No messages at this time.</div>
        </div>
      </section>

      <!-- KPI: Work orders needing approval -->
      <a href="pages/crop-production/field-maintenance/maintenance-approve.html" class="dash-kpi dash-kpi-empty" id="wo-approve-kpi">
        <div class="dash-kpi-main">
          <div class="dash-kpi-text">
            <div class="dash-kpi-label">Field Maintenance Work Orders</div>
            <div class="dash-kpi-title">Needing approval before work can begin</div>
          </div>
          <div class="dash-kpi-count" id="wo-approve-count">‚Äì</div>
        </div>
        <div class="dash-kpi-sub" id="wo-approve-sub">Checking for pending approvals‚Ä¶</div>
      </a>

      <!-- KPI: Field boundary fixes needed -->
      <a href="pages/reports/reports-boundary-requests.html" class="dash-kpi dash-kpi-empty" id="boundary-kpi">
        <div class="dash-kpi-main">
          <div class="dash-kpi-text">
            <div class="dash-kpi-label">Field Boundaries</div>
            <div class="dash-kpi-title">Needing map corrections</div>
          </div>
          <div class="dash-kpi-count" id="boundary-kpi-count">‚Äì</div>
        </div>
        <div class="dash-kpi-sub" id="boundary-kpi-sub">Checking for open boundary requests‚Ä¶</div>
      </a>

      <!-- KPI: Grain bag inventory on hand -->
      <a href="pages/reports/reports-grain-bag-inventory.html" class="dash-kpi dash-kpi-empty" id="bag-kpi">
        <div class="dash-kpi-main">
          <div class="dash-kpi-text">
            <div class="dash-kpi-label">Grain Bag Inventory</div>
            <div class="dash-kpi-title">Bags remaining in sheds</div>
          </div>
          <div class="dash-kpi-count" id="bag-kpi-count">‚Äì</div>
        </div>
        <div class="dash-kpi-sub" id="bag-kpi-sub">Summing bags and bushels on hand‚Ä¶</div>
      </a>

      <!-- FarmVista Copilot (AI Box) -->
      <section class="section ai-section" id="ai-section" aria-label="FarmVista Copilot">
        <header class="section-head">
          <div class="icon" aria-hidden="true">ü§ñ</div>
          <div>
            <strong>FarmVista Copilot (beta)</strong>
            <div class="sub">Ask questions about your fields, equipment, work orders, and more.</div>
          </div>
        </header>
        <div class="section-body ai-body">
          <div id="ai-chat-log" class="ai-log" aria-live="polite">
            <div class="ai-empty">
              Start by asking something like:<br>
              ‚Ä¢ "Show me pending field maintenance for today."<br>
              ‚Ä¢ "Summarize all grain bags at Farm 02."<br>
              ‚Ä¢ "Draft a report for yesterday‚Äôs combine work orders."
            </div>
          </div>

          <form id="ai-chat-form" class="ai-form" autocomplete="off">
            <div class="ai-input-wrap">
              <textarea id="ai-input" class="ai-input" rows="1" placeholder="Ask FarmVista Copilot..."></textarea>
              <button type="button" id="ai-mic" class="ai-mic" aria-label="Start voice dictation">
                <svg class="ai-mic-icon" viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M12 5a2.5 2.5 0 0 1 2.5 2.5v4a2.5 2.5 0 0 1-5 0v-4A2.5 2.5 0 0 1 12 5z" />
                  <path d="M9.75 11.5v.5a2.25 2.25 0 0 0 4.5 0v-.5" />
                  <path d="M8 11.5v.5a4 4.0 0 0 0 8 0v-.5" />
                  <path d="M12 15.5v3" />
                  <path d="M9.5 18.5h5" />
                </svg>
              </button>
            </div>

            <div class="ai-actions">
              <button type="submit" id="ai-send" class="ai-send" aria-label="Send question">Send</button>
              <div class="ai-status" id="ai-status" aria-live="polite"></div>
            </div>

            <div class="ai-hint">
              Connected to your FarmVista AI backend. Early beta ‚Äì answers may be generic for now.
            </div>
          </form>
        </div>
      </section>
    </div>
  </fv-shell>

  <!-- Weather detail modal -->
  <div id="fv-weather-modal" class="fv-weather-modal" role="presentation" hidden>
    <div class="fv-weather-modal-inner" role="dialog" aria-modal="true" aria-labelledby="fv-weather-modal-title">
      <button type="button" id="fv-weather-modal-close" class="fv-weather-modal-close" aria-label="Close weather details">√ó</button>
      <h2 id="fv-weather-modal-title" class="fv-weather-modal-title">Weather details</h2>
      <div id="fv-weather-modal-body"></div>
    </div>
  </div>

  <!-- Markets detail modal -->
  <div id="fv-markets-modal" class="fv-weather-modal" role="presentation" hidden>
    <div class="fv-weather-modal-inner" role="dialog" aria-modal="true" aria-labelledby="fv-markets-modal-title">
      <button type="button" id="fv-markets-modal-close" class="fv-weather-modal-close" aria-label="Close market chart">√ó</button>
      <h2 id="fv-markets-modal-title" class="fv-weather-modal-title">Market chart</h2>

      <div class="mkt-modal-toolbar">
        <div class="mkt-tabs" role="tablist" aria-label="Chart range">
          <button type="button" class="mkt-tab" id="mkt-tab-intraday" aria-pressed="true">Intraday</button>
          <button type="button" class="mkt-tab" id="mkt-tab-trend" aria-pressed="false">Trend</button>
        </div>
        <div id="mkt-modal-sub" style="font-size:12px;color:var(--muted,#67706B);"></div>
      </div>

      <div class="mkt-chart-wrap">
        <canvas id="mkt-canvas" class="mkt-canvas" width="1200" height="520"></canvas>
        <div class="mkt-chart-meta">
          <div id="mkt-meta-left"></div>
          <div id="mkt-meta-right"></div>
        </div>
        <div id="mkt-error" class="mkt-error" hidden></div>
      </div>
    </div>
  </div>

  <!-- ==========================
       WEATHER module
       ========================== -->
  <script src="js/fv-weather.js?v=PV1"></script>
  <script>
  (function(){
    "use strict";

    document.addEventListener("DOMContentLoaded", function(){
      if (window.FVWeather && typeof FVWeather.initWeatherModule === "function") {
        FVWeather.initWeatherModule({
          googleApiKey: "AIzaSyD5qLrXZch_rM4sVXmBrpGDH3Zp7RgfVHc",
          lat: 39.5656,
          lon: -89.6573,
          unitsSystem: "IMPERIAL",
          selector: "#fv-weather",
          showOpenMeteo: true,
          mode: "card",
          locationLabel: "Divernon, Illinois"
        });
      } else {
        console.warn("[dashboard] FVWeather module not found.");
      }

      const shell     = document.getElementById("fv-weather");
      const modal     = document.getElementById("fv-weather-modal");
      const modalBody = document.getElementById("fv-weather-modal-body");
      const closeBtn  = document.getElementById("fv-weather-modal-close");

      if (!shell || !modal || !modalBody || !closeBtn) return;

      function openModal(){
        modal.removeAttribute("hidden");
        document.body.style.overflow = "hidden";

        if (window.FVWeather && typeof FVWeather.initWeatherModule === "function") {
          FVWeather.initWeatherModule({
            googleApiKey: "AIzaSyD5qLrXZch_rM4sVXmBrpGDH3Zp7RgfVHc",
            lat: 39.5656,
            lon: -89.6573,
            unitsSystem: "IMPERIAL",
            selector: "#fv-weather-modal-body",
            showOpenMeteo: true,
            mode: "modal",
            locationLabel: "Divernon, Illinois"
          });
        } else {
          modalBody.innerHTML = shell.innerHTML;
        }
      }

      function closeModal(){
        modal.setAttribute("hidden","hidden");
        document.body.style.overflow = "";
      }

      shell.addEventListener("click", function(evt){
        if (evt.target.closest(".fv-weather-refresh")) return;
        if (shell.querySelector(".fv-weather-card")) openModal();
      });

      closeBtn.addEventListener("click", closeModal);

      modal.addEventListener("click", function(evt){
        if (evt.target === modal) closeModal();
      });

      document.addEventListener("keydown", function(evt){
        if (evt.key === "Escape") closeModal();
      });
    });
  })();
  </script>

  <!-- ==========================
       Markets module (NEW)
       ========================== -->
  <script>
    // Cloud Run markets service URL (no trailing slash)
    window.FV_MARKETS_BASE_URL = "https://farmvista-markets-300398089669.us-central1.run.app";
  </script>
  <script src="js/markets.js?v=PV1"></script>
  <script>
  (function(){
    "use strict";

    const modal     = document.getElementById("fv-markets-modal");
    const closeBtn  = document.getElementById("fv-markets-modal-close");
    const titleEl   = document.getElementById("fv-markets-modal-title");
    const subEl     = document.getElementById("mkt-modal-sub");
    const tabIntra  = document.getElementById("mkt-tab-intraday");
    const tabTrend  = document.getElementById("mkt-tab-trend");
    const canvas    = document.getElementById("mkt-canvas");
    const metaL     = document.getElementById("mkt-meta-left");
    const metaR     = document.getElementById("mkt-meta-right");
    const errBox    = document.getElementById("mkt-error");

    let currentMarketKey = "corn";
    let currentMode = "intraday"; // intraday | trend

    function setTab(mode){
      currentMode = mode;
      tabIntra.setAttribute("aria-pressed", mode === "intraday" ? "true" : "false");
      tabTrend.setAttribute("aria-pressed", mode === "trend" ? "true" : "false");
    }

    function openModal(){
      if(!modal) return;
      modal.removeAttribute("hidden");
      document.body.style.overflow = "hidden";
    }
    function closeModal(){
      if(!modal) return;
      modal.setAttribute("hidden","hidden");
      document.body.style.overflow = "";
    }

    function showError(msg){
      if(!errBox) return;
      errBox.textContent = msg || "Failed to load chart.";
      errBox.removeAttribute("hidden");
    }
    function clearError(){
      if(!errBox) return;
      errBox.setAttribute("hidden","hidden");
      errBox.textContent = "";
    }

    function drawSeries(points){
      if(!canvas) return;
      const ctx = canvas.getContext("2d");
      if(!ctx) return;

      const w = canvas.width;
      const h = canvas.height;

      // background (transparent; rely on theme)
      ctx.clearRect(0,0,w,h);

      if(!points || !points.length){
        ctx.save();
        ctx.globalAlpha = 0.7;
        ctx.font = "28px system-ui, -apple-system, Segoe UI, Roboto, Arial";
        ctx.fillText("No chart data.", 24, 60);
        ctx.restore();
        return;
      }

      // extract closes
      const vals = points.map(p => Number(p.c)).filter(n => Number.isFinite(n));
      if(!vals.length){
        ctx.save();
        ctx.globalAlpha = 0.7;
        ctx.font = "28px system-ui, -apple-system, Segoe UI, Roboto, Arial";
        ctx.fillText("No chart data.", 24, 60);
        ctx.restore();
        return;
      }

      let min = Math.min(...vals);
      let max = Math.max(...vals);
      if(min === max){
        min = min - 1;
        max = max + 1;
      }

      const padL = 18;
      const padR = 12;
      const padT = 14;
      const padB = 18;

      // grid lines
      ctx.save();
      ctx.globalAlpha = 0.25;
      ctx.lineWidth = 1;
      for(let i=1;i<=4;i++){
        const y = padT + (h - padT - padB) * (i/5);
        ctx.beginPath();
        ctx.moveTo(padL, y);
        ctx.lineTo(w - padR, y);
        ctx.stroke();
      }
      ctx.restore();

      // line
      ctx.save();
      ctx.lineWidth = 3;
      ctx.globalAlpha = 0.95;

      const n = vals.length;
      ctx.beginPath();
      for(let i=0;i<n;i++){
        const x = padL + (w - padL - padR) * (i / (n-1 || 1));
        const y = padT + (h - padT - padB) * (1 - ((vals[i] - min) / (max - min)));
        if(i === 0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
      }
      ctx.stroke();
      ctx.restore();
    }

    function formatLocalTime(iso){
      try{
        if(!iso) return "";
        const d = new Date(iso);
        if(isNaN(d.getTime())) return "";
        return d.toLocaleString([], { month:"short", day:"numeric", hour:"numeric", minute:"2-digit" });
      }catch{ return ""; }
    }

    async function loadChart(){
      if(!window.FVMarkets || typeof FVMarkets.fetchChart !== "function") return;

      clearError();

      const label = (currentMarketKey === "soy") ? "Soybeans" : "Corn";
      const modeLabel = (currentMode === "trend") ? "Trend" : "Intraday";
      titleEl.textContent = `${label} ‚Ä¢ ${modeLabel}`;

      // Intraday: 1d / 5m
      // Trend: 6mo / 1d
      const range = (currentMode === "trend") ? "6mo" : "1d";
      const interval = (currentMode === "trend") ? "1d" : "5m";

      subEl.textContent = "Loading‚Ä¶";

      try{
        const data = await FVMarkets.fetchChart(currentMarketKey, range, interval);
        const pts = Array.isArray(data?.points) ? data.points : [];

        drawSeries(pts);

        const last = pts.length ? pts[pts.length - 1] : null;
        const first = pts.length ? pts[0] : null;

        metaL.textContent = data?.delayNote || "Delayed quotes";
        metaR.textContent = last?.tUtc
          ? `Last point: ${formatLocalTime(last.tUtc)}`
          : "";

        // remove loading
        subEl.textContent = (first && last)
          ? `${formatLocalTime(first.tUtc)} ‚Üí ${formatLocalTime(last.tUtc)}`
          : "";
      }catch(e){
        subEl.textContent = "";
        showError(e?.message || "Failed to load chart.");
        drawSeries([]);
      }
    }

    // Start polling + rendering the cards
    document.addEventListener("DOMContentLoaded", function(){
      try{
        if(window.FVMarkets && typeof FVMarkets.start === "function"){
          FVMarkets.start({ refreshMs: 30000 });
        }
      }catch(e){
        console.warn("[dashboard] FVMarkets.start failed:", e);
      }
    });

    // Tap on Corn/Soy card -> open modal and load chart
    window.addEventListener("fv:markets:contractTap", (e)=>{
      const mk = (e && e.detail && e.detail.marketKey) ? String(e.detail.marketKey) : "";
      if(mk !== "corn" && mk !== "soy") return;
      currentMarketKey = mk;
      setTab("intraday");
      openModal();
      loadChart();
    });

    // Tabs
    tabIntra.addEventListener("click", ()=>{
      if(!modal || modal.hasAttribute("hidden")) return;
      setTab("intraday");
      loadChart();
    });
    tabTrend.addEventListener("click", ()=>{
      if(!modal || modal.hasAttribute("hidden")) return;
      setTab("trend");
      loadChart();
    });

    // Close handlers
    closeBtn.addEventListener("click", closeModal);
    modal.addEventListener("click", (evt)=>{
      if(evt.target === modal) closeModal();
    });
    document.addEventListener("keydown", (evt)=>{
      if(evt.key === "Escape" && modal && !modal.hasAttribute("hidden")) closeModal();
    });
  })();
  </script>

  <!-- =========================================================
     Dashboard Capability Permissions (Role + Employee Overrides)
   ========================================================= -->
  <script type="module">
    import {
      ready,
      getAuth,
      onAuthStateChanged,
      getFirestore,
      doc,
      getDoc,
      collection,
      getDocs,
      query,
      where
    } from '/Farm-vista/js/firebase-init.js';

    (function(){
      "use strict";

      const CAP = {
        CHATBOT:   "cap-chatbot",
        KPI_FIELD: "cap-kpi-field-maint",
        KPI_GRAIN: "cap-kpi-grain",
        KPI_EQUIP: "cap-kpi-equipment",

        QL_BOUNDARIES:   "cap-quick-field-boundaries",
        QL_MAINT_ADD:    "cap-quick-maintenance-add",
        QL_FIELD_WEATHER:"cap-quick-field-weather",
        QL_EQUIP_OVERVIEW: "cap-quick-equipment-overview"
      };

      const els = {
        chatbot:        document.getElementById("ai-section"),
        kpiWO:          document.getElementById("wo-approve-kpi"),
        kpiBoundary:    document.getElementById("boundary-kpi"),
        kpiBag:         document.getElementById("bag-kpi"),

        qlSection:      document.getElementById("quick-links"),
        qlBoundaries:   document.getElementById("ql-boundaries"),
        qlMaintAdd:     document.getElementById("ql-maint-add"),
        qlFieldWeather: document.getElementById("ql-field-weather"),
        qlEquipOverview: document.getElementById("ql-equip-overview")
      };

      function hide(el){
        if (!el) return;
        el.classList.add("perm-hidden");
        el.setAttribute("aria-hidden","true");
        el.setAttribute("tabindex","-1");
      }
      function show(el){
        if (!el) return;
        el.classList.remove("perm-hidden");
        el.removeAttribute("aria-hidden");
        el.removeAttribute("tabindex");
      }

      function hasPermObj(p){
        return p && typeof p === "object" && (
          Object.prototype.hasOwnProperty.call(p,"view") ||
          Object.prototype.hasOwnProperty.call(p,"add") ||
          Object.prototype.hasOwnProperty.call(p,"edit") ||
          Object.prototype.hasOwnProperty.call(p,"delete")
        );
      }

      function canFromPermValue(val, action){
        if (val == null) return false;
        if (val === true) return true;
        if (val === false) return false;

        if (typeof val === "object"){
          if (typeof val.on === "boolean") return !!val.on;

          if (hasPermObj(val)){
            const a = (action || "view").toLowerCase();
            if (typeof val[a] === "boolean") return !!val[a];
            return !!(val.view || val.add || val.edit || val.delete);
          }
        }
        return false;
      }

      function makeCan(perms){
        return function(key, action){
          if (!key) return true;
          return canFromPermValue(perms ? perms[key] : null, action || "view");
        };
      }

      function deepClone(obj){
        try { return JSON.parse(JSON.stringify(obj || {})); } catch { return {}; }
      }

      function mergePerms(base, overrides){
        const out = deepClone(base || {});
        const ov = (overrides && typeof overrides === "object") ? overrides : {};
        for (const k of Object.keys(ov)){
          out[k] = ov[k];
        }
        return out;
      }

      function extractEmployeeGroupAndOverrides(emp){
        const e = emp || {};
        const permissionGroup = (e.permissionGroup || "").toString().trim();

        let overrides =
          (e.overrides && e.overrides.perms && typeof e.overrides.perms === "object" ? e.overrides.perms : null) ||
          (e.overrides && typeof e.overrides === "object" ? e.overrides : null) ||
          (e.perms && typeof e.perms === "object" ? e.perms : null) ||
          {};

        return { permissionGroup, overrides };
      }

      async function readEmployeeByEmail(db, user){
        const email = (user && user.email ? user.email.toString().trim().toLowerCase() : "");
        if (!email) return null;

        const ref = doc(db, "employees", email);
        const snap = await getDoc(ref);
        return snap.exists() ? (snap.data() || {}) : null;
      }

      async function readRolePermsByDocId(db, maybeId){
        if (!maybeId) return null;
        try{
          const ref = doc(db, "accountRoles", maybeId);
          const snap = await getDoc(ref);
          if (!snap.exists()) return null;
          const d = snap.data() || {};
          return (d.perms && typeof d.perms === "object") ? d.perms : {};
        }catch{
          return null;
        }
      }

      async function readRolePermsByName(db, roleName){
        if (!roleName) return null;
        try{
          const qy = query(collection(db, "accountRoles"), where("name", "==", roleName));
          const ss = await getDocs(qy);
          let first = null;
          ss.forEach(d => { if (!first) first = d; });

          if (!first) return null;
          const d = first.data() || {};
          return (d.perms && typeof d.perms === "object") ? d.perms : {};
        }catch{
          return null;
        }
      }

      function applyVisibility(perms, permsKnown){
        if (!permsKnown){
          show(els.chatbot);
          show(els.kpiWO);
          show(els.kpiBoundary);
          show(els.kpiBag);

          show(els.qlSection);
          show(els.qlBoundaries);
          show(els.qlMaintAdd);
          show(els.qlFieldWeather);

          window.FV_DASH_PERMS = null;
          window.FV_DASH_CAN = null;

          document.dispatchEvent(new CustomEvent("fv:dash-perms-ready", { detail:{ permsKnown:false } }));
          return;
        }

        const can = makeCan(perms);

        const canAny = (keys, action)=>{
          const list = Array.isArray(keys) ? keys : [keys];
          for (const k of list){
            if (can(k, action || "view")) return true;
          }
          return false;
        };

        if (els.chatbot){
          if (!can(CAP.CHATBOT, "view")) hide(els.chatbot); else show(els.chatbot);
        }

        if (els.kpiWO){
          if (!can(CAP.KPI_FIELD, "view")) hide(els.kpiWO); else show(els.kpiWO);
        }
        if (els.kpiBoundary){
          if (!can(CAP.KPI_FIELD, "view")) hide(els.kpiBoundary); else show(els.kpiBoundary);
        }
        if (els.kpiBag){
          if (!can(CAP.KPI_GRAIN, "view")) hide(els.kpiBag); else show(els.kpiBag);
        }

        if (els.qlBoundaries){
          if (!canAny([CAP.QL_BOUNDARIES, CAP.KPI_FIELD], "view")) hide(els.qlBoundaries); else show(els.qlBoundaries);
        }
        if (els.qlMaintAdd){
          if (!canAny([CAP.QL_MAINT_ADD, CAP.KPI_FIELD], "view")) hide(els.qlMaintAdd); else show(els.qlMaintAdd);
        }
        if (els.qlFieldWeather){
          if (!canAny([CAP.QL_FIELD_WEATHER, CAP.KPI_FIELD], "view")) hide(els.qlFieldWeather); else show(els.qlFieldWeather);
        }
        if (els.qlEquipOverview){
          if (!canAny([CAP.QL_EQUIP_OVERVIEW, CAP.KPI_EQUIP], "view")) hide(els.qlEquipOverview); else show(els.qlEquipOverview);
        }

        if (els.qlSection){
          const anyVisible =
            els.qlBoundaries && !els.qlBoundaries.classList.contains("perm-hidden") ||
            els.qlMaintAdd && !els.qlMaintAdd.classList.contains("perm-hidden") ||
            els.qlFieldWeather && !els.qlFieldWeather.classList.contains("perm-hidden") ||
            els.qlEquipOverview && !els.qlEquipOverview.classList.contains("perm-hidden");

          if (!anyVisible) hide(els.qlSection);
          else show(els.qlSection);
        }

        window.FV_DASH_PERMS = perms || {};
        window.FV_DASH_CAN = can;

        document.dispatchEvent(new CustomEvent("fv:dash-perms-ready", { detail:{ permsKnown:true } }));
      }

      async function init(){
        await ready;

        const auth = getAuth();
        const db = getFirestore();

        applyVisibility(null, false);

        onAuthStateChanged(auth, async (user)=>{
          try{
            if (!user){
              applyVisibility(null, false);
              return;
            }

            const emp = await readEmployeeByEmail(db, user);
            if (!emp){
              console.warn("[dashboard] employees doc not found for user:", user.email);
              applyVisibility(null, false);
              return;
            }

            const { permissionGroup, overrides } = extractEmployeeGroupAndOverrides(emp);

            let basePerms = await readRolePermsByDocId(db, permissionGroup);
            if (!basePerms) basePerms = await readRolePermsByName(db, permissionGroup);

            if (!basePerms){
              console.warn("[dashboard] accountRoles not found for permissionGroup:", permissionGroup);
              applyVisibility(null, false);
              return;
            }

            const merged = mergePerms(basePerms, overrides);
            applyVisibility(merged, true);
          }catch(err){
            console.warn("[dashboard] perms resolver failed:", err);
            applyVisibility(null, false);
          }
        });
      }

      init();
    })();
  </script>

  <!-- ==========================
       Message Board JS
       ========================== -->
  <script>
  (function(){
    "use strict";

    const COL = "messageBoard";
    const FALLBACK_KEYS = [
      "df_message_board_fallback",
      "df_message_board",
      "fv_message_board_v1"
    ];
    const box = document.getElementById("board");

    const toMs = (v)=>{
      if (v == null || v === "") return null;
      if (typeof v === "number") return v;
      const t = Date.parse(v);
      return Number.isFinite(t) ? t : null;
    };
    const tsToMs = (t)=>{
      if (t && typeof t === "object" && typeof t.seconds === "number") return t.seconds*1000;
      if (typeof t === "number") return t;
      return null;
    };
    const fmtDate = (ms)=>{
      try{
        return new Date(ms).toLocaleString(undefined, {
          month:"short", day:"numeric", hour:"numeric", minute:"2-digit"
        });
      }catch{ return ""; }
    };

    async function loadFromFirestore(){
      if (!window.FVData || typeof FVData.list !== "function") return null;
      try{
        await FVData.ready();
        const arr = await FVData.list(COL, { limit: 200, mine: false });
        return Array.isArray(arr) ? arr.map(d => ({
          id: d.id,
          title: (d.title||"").toString(),
          body: (d.body||"").toString(),
          pinned: !!d.pinned,
          authorName: (d.authorName||"").toString(),
          createdAt: tsToMs(d.createdAt) || Date.now(),
          expiresAt: toMs(d.expiresAt)
        })) : [];
      }catch(e){
        console.warn("[dashboard] Firestore read failed, falling back:", e);
        return null;
      }
    }

    function loadFromLocal(){
      for (const k of FALLBACK_KEYS){
        try{
          const raw = localStorage.getItem(k);
          if (!raw) continue;
          const arr = JSON.parse(raw);
          if (Array.isArray(arr) && arr.length){
            return arr.map(m => ({
              id: m.id || String(Math.random()),
              title: (m.title||"").toString(),
              body: (m.body || m.text || "").toString(),
              pinned: !!m.pinned,
              authorName: (m.authorName||"").toString(),
              createdAt: toMs(m.createdAt) || Date.now(),
              expiresAt: toMs(m.expiresAt)
            }));
          }
        }catch{}
      }
      return [];
    }

    function render(list){
      const now = Date.now();
      const active = (list||[]).filter(m => !m.expiresAt || m.expiresAt > now);

      active.sort((a,b)=> (b.pinned - a.pinned) || ((b.createdAt||0) - (a.createdAt||0)));

      if (!active.length){
        box.innerHTML = '<div class="msg empty">No messages at this time.</div>';
        return;
      }

      box.innerHTML = "";
      active.forEach(m=>{
        const el = document.createElement("div");
        el.className = "msg";
        el.innerHTML = `
          ${m.title ? `<div class="title">${m.title}</div>` : ``}
          <div class="body" style="white-space:pre-wrap">${m.body}</div>
          <div class="chips">
            ${m.authorName ? `<span class="chip">Post By: ${m.authorName}</span>` : ``}
            ${m.createdAt ? `<span class="chip">Date Posted: ${fmtDate(m.createdAt)}</span>` : ``}
          </div>
        `;
        box.appendChild(el);
      });
    }

    async function refresh(){
      const fs = await loadFromFirestore();
      if (fs) { render(fs); return; }
      render(loadFromLocal());
    }

    refresh();
    document.addEventListener("visibilitychange", ()=>{
      if(document.visibilityState==="visible") refresh();
    });

  })();
  </script>

  <!-- ===========================================
       Work order approval KPI JS (dashboard)
       =========================================== -->
  <script>
  (function(){
    "use strict";

    const kpiEl   = document.getElementById("wo-approve-kpi");
    const countEl = document.getElementById("wo-approve-count");
    const subEl   = document.getElementById("wo-approve-sub");

    if (!kpiEl || !countEl || !subEl) return;

    function applyState(count){
      const n = Number(count) || 0;
      countEl.textContent = n.toString();

      if (!n){
        kpiEl.classList.add("dash-kpi-empty");
        subEl.textContent = "All caught up ‚Äî no approvals needed.";
      }else{
        kpiEl.classList.remove("dash-kpi-empty");
        subEl.textContent = n === 1
          ? "work order waiting for your approval."
          : "work orders waiting for your approval.";
      }
    }

    function isHidden(){
      return kpiEl.classList.contains("perm-hidden") || kpiEl.getAttribute("aria-hidden") === "true";
    }

    async function loadPending(){
      try{
        if (isHidden()) return;

        if (!window.FVData || typeof FVData.getWhere !== "function"){
          console.warn("[dashboard] FVData.getWhere not available for KPI.");
          applyState(0);
          return;
        }

        await FVData.ready();

        const docs = await FVData.getWhere(
          "fieldMaintenance",
          "status",
          "==",
          "needs approved",
          { limit: 500 }
        ) || [];

        applyState(docs.length);
      }catch(err){
        console.warn("[dashboard] failed to load work-order approvals:", err);
        applyState(0);
      }
    }

    loadPending();
    document.addEventListener("fv:dash-perms-ready", loadPending);
    document.addEventListener("visibilitychange", ()=>{
      if (document.visibilityState === "visible") loadPending();
    });
  })();
  </script>

  <!-- ===========================================
       Field boundary requests KPI JS (dashboard)
       =========================================== -->
  <script type="module">
    import { ready, getFirestore, collection, getDocs } from '/Farm-vista/js/firebase-init.js';

    (async function(){
      "use strict";

      const kpiEl   = document.getElementById("boundary-kpi");
      const countEl = document.getElementById("boundary-kpi-count");
      const subEl   = document.getElementById("boundary-kpi-sub");

      if (!kpiEl || !countEl || !subEl) return;

      function applyState(count){
        const n = Number(count) || 0;
        countEl.textContent = n.toString();

        if (!n){
          kpiEl.classList.add("dash-kpi-empty");
          subEl.textContent = "No field boundary fixes pending.";
        }else{
          kpiEl.classList.remove("dash-kpi-empty");
          subEl.textContent = n === 1
            ? "boundary fix request awaiting review."
            : "boundary fix requests awaiting review.";
        }
      }

      function isHidden(){
        return kpiEl.classList.contains("perm-hidden") || kpiEl.getAttribute("aria-hidden") === "true";
      }

      async function loadBoundaryRequests(){
        try{
          if (isHidden()) return;

          await ready;
          const db = getFirestore();
          const colRef = collection(db, 'boundary_requests');
          const snap = await getDocs(colRef);

          let openCount = 0;

          snap.forEach(docSnap => {
            const d = docSnap.data() || {};
            const raw = (d.status || "").toString().trim();
            const normalized = raw.replace(/\.+$/,"").toLowerCase();
            if (normalized === "open") openCount += 1;
          });

          applyState(openCount);
        }catch(err){
          console.warn("[dashboard] failed to load boundary KPI:", err);
          applyState(0);
        }
      }

      await loadBoundaryRequests();
      document.addEventListener("fv:dash-perms-ready", loadBoundaryRequests);
      document.addEventListener("visibilitychange", ()=>{
        if (document.visibilityState === "visible") loadBoundaryRequests();
      });
    })();
  </script>

  <!-- ===========================================
       Grain bag inventory KPI JS (dashboard)
       =========================================== -->
  <script type="module">
    import { ready, getFirestore, collection, getDocs } from '/Farm-vista/js/firebase-init.js';

    (async function(){
      "use strict";

      const kpiEl   = document.getElementById("bag-kpi");
      const countEl = document.getElementById("bag-kpi-count");
      const subEl   = document.getElementById("bag-kpi-sub");

      if (!kpiEl || !countEl || !subEl) return;

      const fmtInt = (n) => (Number(n) || 0).toLocaleString();

      function applyState(totalBags, skuCount, totalBu){
        const bags = Number(totalBags) || 0;
        const skus = Number(skuCount) || 0;
        const bu   = Number(totalBu)   || 0;

        countEl.textContent = bags.toString();

        if (!bags){
          kpiEl.classList.add("dash-kpi-empty");
          subEl.textContent = "No grain bags on hand in inventory.";
        }else{
          kpiEl.classList.remove("dash-kpi-empty");
          const skuLabel = skus === 1 ? "SKU" : "SKUs";

          if (bu > 0){
            subEl.textContent = `‚âà ${fmtInt(bu)} bu on hand across ${fmtInt(bags)} bags and ${skus || 1} ${skuLabel}.`;
          }else{
            subEl.textContent = `Total bags on hand across ${skus || 1} ${skuLabel}.`;
          }
        }
      }

      function isHidden(){
        return kpiEl.classList.contains("perm-hidden") || kpiEl.getAttribute("aria-hidden") === "true";
      }

      async function loadBagInventory(){
        try{
          if (isHidden()) return;

          await ready;
          const db = getFirestore();
          const colRef = collection(db, 'inventoryGrainBagMovements');
          const snap = await getDocs(colRef);

          let totalBags = 0;
          let skuCount  = 0;
          let totalBu   = 0;

          snap.forEach(docSnap => {
            const d = docSnap.data() || {};

            let bags = (d.onHand != null) ? Number(d.onHand) : (d.qty != null ? Number(d.qty) : 0);
            if (!Number.isFinite(bags) || bags <= 0) return;

            totalBags += bags;
            skuCount  += 1;

            let perBagCornBu = 0;
            if (d.cornBuPerBag != null) perBagCornBu = Number(d.cornBuPerBag);
            else if (d.bagCornBu != null) perBagCornBu = Number(d.bagCornBu);
            else if (d.bushelsPerBag != null) perBagCornBu = Number(d.bushelsPerBag);
            else if (d.capacityCornBu != null) perBagCornBu = Number(d.capacityCornBu);

            if (!Number.isFinite(perBagCornBu) || perBagCornBu <= 0) return;

            const ratedCornTotal = bags * perBagCornBu;

            const crop = (d.crop || d.cropType || "corn").toString().trim().toLowerCase() || "corn";

            let effBu = ratedCornTotal;
            try{
              if (window.FVGrainCapacity && typeof FVGrainCapacity.capacityForCrop === "function") {
                effBu = FVGrainCapacity.capacityForCrop(ratedCornTotal, crop, { round:false });
              }
            }catch(e){
              console.warn("[dashboard] FVGrainCapacity error:", e);
            }

            if (Number.isFinite(effBu) && effBu > 0) totalBu += effBu;
          });

          applyState(totalBags, skuCount, totalBu);
        }catch(err){
          console.warn("[dashboard] failed to load grain-bag inventory KPI:", err);
          applyState(0, 0, 0);
        }
      }

      await loadBagInventory();
      document.addEventListener("fv:dash-perms-ready", loadBagInventory);
      document.addEventListener("visibilitychange", ()=>{
        if (document.visibilityState === "visible") loadBagInventory();
      });
    })();
  </script>

  <!-- Copilot UI module guard -->
  <script>
    (function(){
      const f = document.getElementById('ai-chat-form');
      if (!f) return;
      f.addEventListener('submit', function(e){
        if (!window.__FV_COPILOT_WIRED) {
          e.preventDefault();
          e.stopPropagation();
        }
      }, true);
    })();
  </script>

  <script type="module">
    import { FVCopilotUI } from '/Farm-vista/js/copilot-ui.js';

    let _copilotInited = false;

    function initCopilot(){
      if (_copilotInited) return;
      _copilotInited = true;
      try{ FVCopilotUI.init(); }
      catch(e){ console.warn("[dashboard] copilot-ui init failed:", e); }
    }

    initCopilot();
    document.addEventListener("fv:dash-perms-ready", initCopilot);
  </script>

  <!-- One-time SW reset for path change -->
  <script>
  (async () => {
    try {
      if ('serviceWorker' in navigator) {
        const regs = await navigator.serviceWorker.getRegistrations();
        await Promise.all(regs.map(r => r.unregister()));
        await navigator.serviceWorker.register('serviceworker.js?rev=PV1');
        if (navigator.serviceWorker.controller) {
          navigator.serviceWorker.controller.postMessage('SKIP_WAITING');
        }
      }
      if ('caches' in window) {
        const keys = await caches.keys();
        await Promise.all(keys.map(k => caches.delete(k)));
      }
    } catch (e) { console.warn(e); }
  })();
  </script>
</body>
</html>