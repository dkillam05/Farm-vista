<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>State → County Picker (Searchable + Copyable URL)</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<style>
  html,body{margin:0;padding:0;background:#fff;color:#141514;font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial}
  .wrap{max-width:760px;margin:32px auto;padding:0 16px}
  h1{margin:0 0 6px;font-size:22px}
  p{margin:0 0 16px;color:#67706B}
  .card{border:1px solid #d7dad7;border-radius:12px;padding:16px}
  .row{display:grid;gap:12px;grid-template-columns:1fr 1fr}
  @media(max-width:720px){.row{grid-template-columns:1fr}}
  label{display:block;font-weight:800;margin:0 0 6px}
  .dropdown{position:relative}
  .dropdown button{width:100%;text-align:left;padding:10px 12px;border:1px solid #d7dad7;border-radius:10px;background:#fff;font:inherit;color:#141514;cursor:pointer}
  .dropdown-list{position:absolute;z-index:20;top:calc(100% + 4px);left:0;right:0;max-height:260px;overflow:auto;border:1px solid #d7dad7;border-radius:10px;background:#fff;box-shadow:0 4px 12px rgba(0,0,0,.1);display:none}
  .dropdown.open .dropdown-list{display:block}
  .dropdown-list input{width:100%;box-sizing:border-box;padding:8px 10px;border:none;border-bottom:1px solid #d7dad7;font:inherit;outline:none}
  .dropdown-list ul{list-style:none;margin:0;padding:0;max-height:220px;overflow-y:auto}
  .dropdown-list li{padding:8px 10px;cursor:pointer}
  .dropdown-list li:hover{background:#f0f1f0}
  .btn{border:1px solid #d7dad7;border-radius:10px;background:#f7f8f7;padding:8px 12px;font-weight:800;cursor:pointer}
  .btn-primary{background:#3B7E46;border-color:#3B7E46;color:#fff}
  .pill{font-size:12px;border:1px solid #d7dad7;border-radius:999px;padding:4px 8px;color:#67706B;background:#fff}
  .help{margin-top:6px;font-size:13px;color:#67706B}
  .bar{display:flex;gap:8px;align-items:center;margin-top:12px;flex-wrap:wrap}
  .out{margin-top:12px;border:1px dashed #d7dad7;border-radius:10px;padding:10px}
  .err{color:#b3261e;font-weight:700}
  .urlbox{display:flex;gap:6px;align-items:center;margin-top:12px}
  .urlbox input{flex:1;padding:6px 8px;border:1px solid #d7dad7;border-radius:8px;font-size:13px;color:#333;background:#f9f9f9}
  .urlbox button{padding:6px 10px;border:1px solid #d7dad7;border-radius:8px;background:#3B7E46;color:#fff;font-weight:600;cursor:pointer}
</style>
</head>
<body>
<div class="wrap">
  <h1>State → County Picker (with Search + Copyable URL)</h1>
  <p>Live data from the U.S. Census (ACS5). Search inside each dropdown and copy the API URL below.</p>

  <div class="card">
    <div class="row">
      <div>
        <label>State</label>
        <div id="stateDropdown" class="dropdown">
          <button type="button" id="stateBtn">Select a state…</button>
          <div class="dropdown-list">
            <input type="text" placeholder="Search state…" id="stateSearch">
            <ul id="stateList"></ul>
          </div>
        </div>
      </div>
      <div>
        <label>County</label>
        <div id="countyDropdown" class="dropdown">
          <button type="button" id="countyBtn" disabled>Select a county…</button>
          <div class="dropdown-list">
            <input type="text" placeholder="Search county…" id="countySearch" disabled>
            <ul id="countyList"></ul>
          </div>
        </div>
        <div id="countyHelp" class="help">Pick a state to load counties.</div>
      </div>
    </div>

    <div class="urlbox">
      <input type="text" id="urlOut" readonly value="—"/>
      <button id="copyUrl">Copy URL</button>
    </div>

    <div class="bar">
      <button id="retry" class="btn" type="button">Retry</button>
      <button id="clear" class="btn" type="button">Clear</button>
      <button id="copySel" class="btn btn-primary" type="button">Copy selection</button>
      <span id="status" class="pill">Idle</span>
    </div>

    <div class="out">
      <div><strong>Selected:</strong> <span id="selOut">—</span></div>
    </div>
  </div>
</div>

<script>
(function(){
"use strict";
const $=id=>document.getElementById(id);
const CENSUS_KEY="14a8ad456efef642983bd8e830809694965b003f";

const STATES=[["AL","Alabama"],["AK","Alaska"],["AZ","Arizona"],["AR","Arkansas"],["CA","California"],["CO","Colorado"],
["CT","Connecticut"],["DE","Delaware"],["DC","District of Columbia"],["FL","Florida"],["GA","Georgia"],
["HI","Hawaii"],["ID","Idaho"],["IL","Illinois"],["IN","Indiana"],["IA","Iowa"],["KS","Kansas"],["KY","Kentucky"],
["LA","Louisiana"],["ME","Maine"],["MD","Maryland"],["MA","Massachusetts"],["MI","Michigan"],["MN","Minnesota"],
["MS","Mississippi"],["MO","Missouri"],["MT","Montana"],["NE","Nebraska"],["NV","Nevada"],["NH","New Hampshire"],
["NJ","New Jersey"],["NM","New Mexico"],["NY","New York"],["NC","North Carolina"],["ND","North Dakota"],
["OH","Ohio"],["OK","Oklahoma"],["OR","Oregon"],["PA","Pennsylvania"],["RI","Rhode Island"],["SC","South Carolina"],
["SD","South Dakota"],["TN","Tennessee"],["TX","Texas"],["UT","Utah"],["VT","Vermont"],["VA","Virginia"],
["WA","Washington"],["WV","West Virginia"],["WI","Wisconsin"],["WY","Wyoming"]];
const STATE_TO_FIPS={AL:"01",AK:"02",AZ:"04",AR:"05",CA:"06",CO:"08",CT:"09",DE:"10",DC:"11",FL:"12",GA:"13",
HI:"15",ID:"16",IL:"17",IN:"18",IA:"19",KS:"20",KY:"21",LA:"22",ME:"23",MD:"24",MA:"25",MI:"26",MN:"27",
MS:"28",MO:"29",MT:"30",NE:"31",NV:"32",NH:"33",NJ:"34",NM:"35",NY:"36",NC:"37",ND:"38",OH:"39",OK:"40",
OR:"41",PA:"42",RI:"44",SC:"45",SD:"46",TN:"47",TX:"48",UT:"49",VT:"50",VA:"51",WA:"53",WV:"54",WI:"55",WY:"56"};

let selectedState="IL", selectedCounty="";

function setStatus(t){$("status").textContent=t;}
function updateSelected(){
  const stName=STATES.find(([c])=>c===selectedState)?.[1]||"";
  $("selOut").textContent=(selectedState&&selectedCounty)?`${selectedCounty}, ${selectedState} — ${stName}`:"—";
}

function buildList(container, items, clickHandler){
  container.innerHTML="";
  items.forEach(([val,label])=>{
    const li=document.createElement("li");
    li.textContent=label;
    li.dataset.value=val;
    li.onclick=()=>clickHandler(val,label);
    container.appendChild(li);
  });
}

function acsUrl(stateCode){
  const fips=STATE_TO_FIPS[stateCode];
  return `https://api.census.gov/data/2023/acs/acs5?get=NAME&for=county:*&in=state:${fips}&key=${encodeURIComponent(CENSUS_KEY)}`;
}
async function fetchWithTimeout(url,ms){
  const ctrl=new AbortController();const t=setTimeout(()=>ctrl.abort(),ms);
  try{
    const res=await fetch(url,{signal:ctrl.signal,mode:"cors",cache:"no-store"});
    if(!res.ok)throw new Error("HTTP "+res.status);
    return await res.json();
  }finally{clearTimeout(t);}
}
function parseCountyNames(rows){
  const out=[];
  for(let i=1;i<rows.length;i++){
    const nm=String(rows[i][0]||"");
    const m=nm.match(/^(.+?)\s+(County|Parish|Borough|Census Area)/i);
    out.push((m?m[1]:nm).trim());
  }
  out.sort((a,b)=>a.localeCompare(b));
  return out;
}

async function loadCounties(stateCode){
  $("countyHelp").textContent="Requesting from Census…";
  setStatus("Loading…");
  $("countyList").innerHTML="";
  $("countySearch").value="";
  const url=acsUrl(stateCode);
  $("urlOut").value=url;
  try{
    const data=await fetchWithTimeout(url,12000);
    const list=parseCountyNames(data);
    buildList($("countyList"),list.map(c=>[c,c]),(val,label)=>{
      selectedCounty=val;
      $("countyBtn").textContent=label;
      $("countyDropdown").classList.remove("open");
      updateSelected();
    });
    $("countyBtn").disabled=false;
    $("countySearch").disabled=false;
    $("countyHelp").textContent="Live from U.S. Census (ACS5).";
    setStatus("Live");
  }catch(e){
    $("countyHelp").innerHTML=`<span class="err">Error:</span> ${e.message}`;
    setStatus("Error");
  }
}

/* ---- Dropdown search filtering ---- */
function setupSearch(inputEl,listEl){
  inputEl.addEventListener("input",()=>{
    const term=inputEl.value.toLowerCase();
    listEl.querySelectorAll("li").forEach(li=>{
      li.style.display=li.textContent.toLowerCase().includes(term)?"":"none";
    });
  });
}

/* ---- State dropdown ---- */
buildList($("stateList"),STATES,(val,label)=>{
  selectedState=val;
  $("stateBtn").textContent=label;
  $("stateDropdown").classList.remove("open");
  selectedCounty="";
  $("countyBtn").textContent="Select a county…";
  loadCounties(val);
  updateSelected();
});

/* open/close handlers */
document.querySelectorAll(".dropdown button").forEach(btn=>{
  btn.addEventListener("click",e=>{
    const dd=e.target.closest(".dropdown");
    document.querySelectorAll(".dropdown").forEach(d=>{if(d!==dd)d.classList.remove("open");});
    dd.classList.toggle("open");
    const inp=dd.querySelector("input");
    if(dd.classList.contains("open")&&inp){setTimeout(()=>inp.focus(),100);}
  });
});
document.addEventListener("click",e=>{
  if(!e.target.closest(".dropdown"))document.querySelectorAll(".dropdown").forEach(d=>d.classList.remove("open"));
});

/* searches */
setupSearch($("stateSearch"),$("stateList"));
setupSearch($("countySearch"),$("countyList"));

/* bar buttons */
$("retry").onclick=()=>loadCounties(selectedState||"IL");
$("clear").onclick=()=>{
  selectedState="IL";selectedCounty="";
  $("stateBtn").textContent="Illinois";
  $("countyBtn").textContent="Select a county…";
  $("countyList").innerHTML="";$("countySearch").value="";
  $("countyBtn").disabled=true;$("countySearch").disabled=true;
  $("countyHelp").textContent="Cleared. Pick a state to load counties.";
  $("urlOut").value="—";
  setStatus("Idle");updateSelected();
};
$("copySel").onclick=()=>navigator.clipboard.writeText($("selOut").textContent||"");
$("copyUrl").onclick=()=>navigator.clipboard.writeText($("urlOut").value||"");

/* boot */
(async()=>{
  $("stateBtn").textContent="Illinois";
  buildList($("stateList"),STATES,(val,label)=>{
    selectedState=val;
    $("stateBtn").textContent=label;
    $("stateDropdown").classList.remove("open");
    loadCounties(val);
    updateSelected();
  });
  await loadCounties("IL");
  updateSelected();
})();
})();
</script>
</body>
</html>
