<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista ‚Ä¢ Dev ‚Ä¢ Field Readiness</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- ===========================
       ABSOLUTE PATHS (REQUIRED)
       =========================== -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>

  <!-- Theme + base app styles -->
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <!-- Date range picker (your file) -->
  <script src="/Farm-vista/js/fv-date-range-picker.js"></script>

  <!-- Firebase init -->
  <script src="/Farm-vista/js/firebase-init.js"></script>

  <!-- Ensure fv-shell (global header/footer/menu) -->
  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true;
        document.head.appendChild(s);
      }
    })();
  </script>

  <style>
    :root{
      --card-max:1100px;
      --page-bottom-gap:96px;
      --accent:#2F6C3C;
    }
    body{ background:var(--app-bg,var(--surface)); }

    .wrap{
      max-width:var(--card-max);
      margin:0 auto;
      padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + var(--page-bottom-gap))!important;
    }

    .hero{
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));
      overflow:hidden;
      margin-bottom:var(--page-bottom-gap);
    }
    .hero-head{
      display:grid;grid-template-columns:36px 1fr;gap:12px;align-items:center;
      padding:14px 16px;border-bottom:1px solid var(--border);
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);
    }
    .hero-head .icon{width:24px;height:24px;color:var(--accent);display:grid;place-items:center}
    .hero-head h1{margin:0;font-size:clamp(20px,3.2vw,26px);line-height:1.2}
    .muted{color:var(--muted,#67706B)}
    .body{padding:16px;display:grid;gap:14px}

    /* Controls */
    .row{display:grid;gap:10px;grid-template-columns:1fr 1fr auto;align-items:end}
    @media (max-width:880px){.row{grid-template-columns:1fr;align-items:stretch}}
    .field label{display:block;font-weight:800;margin:0 0 6px}
    .input,.select{
      width:100%;font:inherit;font-size:16px;color:var(--text);
      background:var(--card-surface,var(--surface));border:1px solid var(--border);
      border-radius:10px;padding:12px;outline:none
    }

    /* Make the date-range input look like a classy button */
    #jobRangeInput{
      width:auto;
      min-width: 220px;
      cursor:pointer;
      white-space:nowrap;
    }
    @media (max-width:880px){
      #jobRangeInput{width:100%;min-width:0}
    }

    /* Fields list */
    .list{
      display:grid;
      gap:10px;
    }
    .tile{
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--surface);
      padding:12px;
      display:grid;
      gap:8px;
      cursor:pointer;
      user-select:none;
    }
    .tile.active{
      outline:2px solid color-mix(in srgb, var(--accent) 70%, transparent 30%);
      outline-offset:2px;
    }
    .tile-top{
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
      flex-wrap:wrap;
    }
    .titleline{
      display:flex;align-items:center;gap:8px;flex-wrap:wrap;min-width:0;
      flex:1 1 auto;
    }
    .name{
      font-weight:900;
      font-size:14px;
      line-height:1.2;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 520px;
    }
    @media (max-width:520px){
      .name{max-width: 240px;}
    }
    .tiny-btn{
      padding:6px 8px;
      border-radius:10px;
      border:1px solid var(--border);
      background:transparent;
      font-weight:900;
      font-size:12px;
      color:var(--text);
      cursor:pointer;
      line-height:1;
    }

    /* Readiness pill */
    .readiness-pill{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      font-weight:900;
      font-size:12px;
      color:#fff;
      white-space:nowrap;
      flex:0 0 auto;
    }

    .subline{
      margin:0;
      font-size:12px;
      color:var(--muted,#67706B);
      line-height:1.2;
    }

    .chips{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .chip{
      display:inline-flex;align-items:center;
      padding:6px 10px;border-radius:999px;border:1px solid var(--border);
      font-weight:900;font-size:12px;
    }
    .chip.wet{background:color-mix(in srgb, #c83b3b 18%, var(--surface) 82%)}
    .chip.readiness{background:color-mix(in srgb, #2f8f4b 18%, var(--surface) 82%)}

    .gauge-wrap{display:grid;gap:8px}
    .gauge{
      position:relative;
      height:16px;
      border-radius:999px;
      border:1px solid var(--border);
      overflow:hidden;
      background:linear-gradient(90deg, #c83b3b 0%, #d8b23b 55%, #2f8f4b 100%);
    }
    .marker{
      position:absolute;top:-10px;width:4px;height:36px;
      background:#fff;box-shadow:0 0 0 1px rgba(0,0,0,.35);
      border-radius:3px;transform:translateX(-2px);
    }
    .thr{
      position:absolute;top:-10px;width:2px;height:36px;
      background:#000;opacity:.85;transform:translateX(-1px);
    }
    .badge{
      position:absolute;top:-34px;transform:translateX(-50%);
      padding:5px 8px;border-radius:999px;border:1px solid var(--border);
      background:color-mix(in srgb, var(--surface) 92%, #ffffff 8%);
      font-size:12px;font-weight:900;white-space:nowrap;
      box-shadow:0 10px 25px rgba(0,0,0,.12);
      color:var(--text);
    }
    .ticks{display:flex;justify-content:space-between;font-size:11px;color:var(--muted,#67706B)}

    /* Collapsible details (closed by default) */
    details{
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--surface);
      overflow:hidden;
    }
    summary{
      list-style:none;
      cursor:pointer;
      padding:12px 14px;
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid var(--border);
      background:color-mix(in srgb, var(--surface) 92%, #ffffff 8%);
    }
    summary::-webkit-details-marker{display:none}
    .details-body{padding:14px;display:grid;gap:12px}

    .detail-grid{
      display:grid;
      gap:12px;
      grid-template-columns: 1.1fr .9fr;
      align-items:start;
    }
    @media (max-width:880px){
      .detail-grid{grid-template-columns:1fr}
    }

    .panel{
      border:1px solid var(--border);
      border-radius:14px;
      background:color-mix(in srgb, var(--surface) 96%, #ffffff 4%);
      padding:12px;
    }
    .panel h3{
      margin:0 0 8px;
      font-size:13px;
      font-weight:900;
    }

    .kv{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:8px 12px;
      font-size:12px;
    }
    .kv .k{color:var(--muted,#67706B);font-weight:800}
    .kv .v{font-weight:900}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;}

    /* Details controls block (what you wanted moved into Details) */
    .detail-controls{
      display:grid;
      gap:12px;
      grid-template-columns: 1fr 1fr;
      align-items:start;
    }
    @media (max-width:880px){
      .detail-controls{grid-template-columns:1fr}
    }
    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:10px;
    }
    .btn-primary{border-color:transparent;background:#2F6C3C;color:#fff!important}
    .btn-danger{border-color:transparent;background:#b02a2a;color:#fff!important}

    /* Tables: make mobile viewable (no disappearing right side) */
    .table-scroll{
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--surface);
    }
    table{
      width:100%;
      border-collapse:collapse;
      min-width: 820px; /* forces horizontal scroll instead of clipping */
    }
    th,td{
      padding:10px;
      border-bottom:1px solid var(--border);
      font-size:12px;
      text-align:left;
      vertical-align:top;
      white-space:nowrap;
    }
    th{
      background:color-mix(in srgb, var(--surface) 90%, #ffffff 10%);
      font-weight:900;
      color:var(--text);
      position:sticky;
      top:0;
      z-index:1;
    }
    tr:last-child td{border-bottom:none}
    .right{text-align:right}

    /* Calendar popover styling (IDs required by your picker) */
    #calendarPopover{
      position:absolute;
      top:calc(100% + 8px);
      left:0;
      width:min(360px, 92vw);
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:0 14px 45px rgba(0,0,0,.25);
      padding:12px;
      display:none;
      z-index:100000;
    }
    .cal-top{display:flex;gap:10px;align-items:center;margin-bottom:10px}
    #calDays{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .cal-day{
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px 0;
      text-align:center;
      font-size:12px;
      cursor:pointer;
      background:color-mix(in srgb, var(--surface) 94%, #ffffff 6%);
      user-select:none;
    }
    .cal-day.other-month{opacity:.45}
    .cal-day.in-range{background:color-mix(in srgb, var(--accent) 14%, var(--surface) 86%)}
    .cal-day.range-start,.cal-day.range-end,.cal-day.single-day,.cal-day.start-selected{
      background:var(--accent);color:#fff;border-color:transparent
    }
    .cal-footer{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-top:10px}

    .pv-hide{display:none!important}
    .modal-backdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.45);
      display:flex;align-items:center;justify-content:center;
      padding:16px;z-index:99999;
    }
    .modal{
      width:min(560px, 94vw);
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:0 18px 60px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .modal-h{padding:14px 14px 10px;border-bottom:1px solid var(--border);}
    .modal-h h3{margin:0;font-size:15px;font-weight:900}
    .modal-b{padding:14px}

    .help{font-size:13px;color:var(--muted,#67706B);margin-top:6px}
    .error{color:#b00020;font-weight:800}
  </style>
</head>

<body>
  <fv-shell>
    <div class="wrap">
      <section class="hero">
        <header class="hero-head">
          <div class="icon" aria-hidden="true">üß≠</div>
          <div>
            <h1>Field Readiness (Dev)</h1>
            <p class="muted">Readiness score 0‚Äì100. Black line = threshold. Details are tucked away below.</p>
          </div>
        </header>

        <div class="body">
          <!-- CONTROLS (stay OUTSIDE details) -->
          <div class="row opCard" style="position:relative;">
            <div class="field">
              <label for="opSel">Operation</label>
              <select id="opSel" class="select">
                <option value="spring_tillage">Spring tillage</option>
                <option value="planting">Planting</option>
                <option value="spraying" selected>Spraying</option>
                <option value="harvest">Harvest</option>
                <option value="fall_tillage">Fall tillage</option>
              </select>
            </div>

            <div class="field">
              <label for="sortSel">Sort</label>
              <select id="sortSel" class="select">
                <option value="name_az">Name (A ‚Üí Z)</option>
                <option value="name_za">Name (Z ‚Üí A)</option>
                <option value="ready_dry_wet">Readiness (Dry ‚Üí Wet)</option>
                <option value="ready_wet_dry">Readiness (Wet ‚Üí Dry)</option>
                <option value="rain_most">Most rain (range)</option>
                <option value="rain_least">Least rain (range)</option>
              </select>
            </div>

            <div class="field" style="position:relative;justify-self:end;">
              <label for="jobRangeInput">Rain range</label>
              <input id="jobRangeInput" class="input" readonly placeholder="Choose date range"/>
              <div id="calendarPopover">
                <div class="cal-top">
                  <select id="monthSelect" class="select" style="padding:10px"></select>
                  <select id="yearSelect" class="select" style="padding:10px"></select>
                  <button id="closeCalBtn" class="btn" type="button" style="min-width:auto;padding:10px 12px;">Close</button>
                </div>
                <div id="calDays"></div>
                <div class="cal-footer">
                  <span id="rangeSummary" class="muted" style="font-size:12px;">No dates selected</span>
                  <div style="display:flex;gap:8px;">
                    <button id="clearRangeBtn" class="btn" type="button" style="min-width:auto;padding:10px 12px;">Clear</button>
                    <button id="applyRangeBtn" class="btn btn-primary" type="button" style="min-width:auto;padding:10px 12px;">Apply</button>
                  </div>
                </div>
              </div>
              <div class="help">Defaults to last 30 days until you choose a range.</div>
            </div>
          </div>

          <!-- FIELDS -->
          <div class="field">
            <label>Fields</label>
            <div class="help muted" id="fieldsDebug">Loading‚Ä¶</div>
            <div id="fieldsGrid" class="list"></div>
            <div id="emptyMsg" class="help muted" style="display:none;">No active fields with GPS (lat/lng) found in <span class="mono">fields</span>.</div>
          </div>

          <div id="err" class="help error" hidden></div>

          <!-- DETAILS (THIS is where you wanted controls + ‚Äúreal looking‚Äù section) -->
          <details id="detailsPanel" open="false">
            <summary>
              <span>Details</span>
              <span class="muted" style="font-size:12px;">(soil/drain/threshold + weather + math)</span>
            </summary>

            <div class="details-body">

              <!-- Controls moved INSIDE details -->
              <div class="panel">
                <h3>Inputs</h3>

                <div class="detail-controls">
                  <div class="field">
                    <label for="soilWet">Soil Type / Holding (1‚Äì10)</label>
                    <input id="soilWet" type="range" min="1" max="10" step="1" value="6"/>
                    <div class="help">Saved per-field locally (device). Affects retention + dry-down.</div>
                  </div>

                  <div class="field">
                    <label for="drain">Drainage (1‚Äì10)</label>
                    <input id="drain" type="range" min="1" max="10" step="1" value="5"/>
                    <div class="help">Saved per-field locally (device). Tile/ditches/natural drainage.</div>
                  </div>

                  <div class="field">
                    <label for="workable">Operation Threshold (Readiness Score)</label>
                    <input id="workable" type="range" min="0" max="100" step="1" value="70"/>
                    <div class="help">Black line on the bar.</div>
                  </div>

                  <div class="field">
                    <label for="apiBase">Weather API Base URL</label>
                    <input id="apiBase" class="input" placeholder="https://YOUR-CLOUDRUN-URL (blank = mock)"/>
                    <div class="help">Endpoint: <span class="mono">GET /weather30?lat=..&lon=..</span> (uses selected field).</div>
                  </div>
                </div>

                <div class="actions">
                  <button id="btnRegen" class="btn" type="button">Regenerate Mock 30 Days</button>
                  <button id="btnFetch" class="btn btn-primary" type="button">Fetch Real 30 Days</button>
                  <button id="btnRun" class="btn" type="button">Run Model</button>
                  <button class="btn" type="button" data-fake="wo">Create Work Order</button>
                  <button class="btn" type="button" data-fake="maps">Open in Maps</button>
                  <button class="btn" type="button" data-fake="soil">Soil Survey</button>
                  <button class="btn btn-primary" type="button" data-fake="share">Share Summary</button>
                </div>

                <div class="help">Those extra buttons are placeholders to make this look ‚Äúreal‚Äù right now.</div>
              </div>

              <div class="detail-grid">
                <div class="panel">
                  <h3>Field + Settings</h3>
                  <div class="kv">
                    <div class="k">Field</div><div class="v" id="dFieldName">‚Äî</div>
                    <div class="k">Status</div><div class="v" id="dStatus">‚Äî</div>
                    <div class="k">County / State</div><div class="v" id="dCounty">‚Äî</div>
                    <div class="k">Tillable</div><div class="v" id="dAcres">‚Äî</div>
                    <div class="k">GPS</div><div class="v mono" id="dGps">‚Äî</div>

                    <div class="k">Soil type</div><div class="v" id="dSoilType">‚Äî</div>
                    <div class="k">Soil holding</div><div class="v" id="dSoilHold">‚Äî</div>
                    <div class="k">Drainage</div><div class="v" id="dDrainage">‚Äî</div>

                    <div class="k">Threshold</div><div class="v" id="dThreshold">‚Äî</div>
                    <div class="k">Operation</div><div class="v" id="dOperation">‚Äî</div>
                  </div>

                  <div class="help" id="paramExplain">‚Äî</div>
                </div>

                <div class="panel">
                  <h3>Weather API + Run</h3>
                  <div class="kv">
                    <div class="k">Mode</div><div class="v" id="dMode">‚Äî</div>
                    <div class="k">API Base</div><div class="v mono" id="dApiBase">‚Äî</div>
                    <div class="k">Endpoint</div><div class="v mono" id="dEndpoint">‚Äî</div>
                    <div class="k">Days loaded</div><div class="v" id="dDays">‚Äî</div>
                    <div class="k">Range rain</div><div class="v" id="dRangeRain">‚Äî</div>
                    <div class="k">Readiness</div><div class="v" id="dReadiness">‚Äî</div>
                    <div class="k">Wetness</div><div class="v" id="dWetness">‚Äî</div>
                    <div class="k">Storage</div><div class="v" id="dStorage">‚Äî</div>
                  </div>
                  <div class="help" id="mathSummary">‚Äî</div>
                </div>
              </div>

              <div class="panel">
                <h3>Tank Trace</h3>
                <div class="table-scroll">
                  <table aria-label="Tank Trace">
                    <thead>
                      <tr>
                        <th style="width:110px;">Date</th>
                        <th class="right">Rain</th>
                        <th class="right">infilMult</th>
                        <th class="right">Add</th>
                        <th class="right">DryPwr</th>
                        <th class="right">Loss</th>
                        <th class="right">Storage</th>
                      </tr>
                    </thead>
                    <tbody id="traceRows">
                      <tr><td colspan="7" class="muted">Run the model.</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <div class="panel">
                <h3>DryPwr Breakdown</h3>
                <div class="table-scroll">
                  <table aria-label="DryPwr Breakdown">
                    <thead>
                      <tr>
                        <th style="width:110px;">Date</th>
                        <th class="right">Temp</th>
                        <th class="right">tempN</th>
                        <th class="right">Wind</th>
                        <th class="right">windN</th>
                        <th class="right">RH</th>
                        <th class="right">rhN</th>
                        <th class="right">Solar</th>
                        <th class="right">solarN</th>
                        <th class="right">raw</th>
                        <th class="right">DryPwr</th>
                      </tr>
                    </thead>
                    <tbody id="dryRows">
                      <tr><td colspan="11" class="muted">Run the model.</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <div class="panel">
                <h3>Weather Inputs</h3>
                <div class="table-scroll">
                  <table aria-label="Weather Inputs">
                    <thead>
                      <tr>
                        <th style="width:110px;">Date</th>
                        <th class="right">Rain</th>
                        <th class="right">Temp</th>
                        <th class="right">Wind</th>
                        <th class="right">RH</th>
                        <th class="right">Solar</th>
                      </tr>
                    </thead>
                    <tbody id="wxRows">
                      <tr><td colspan="6" class="muted">Waiting for JS‚Ä¶</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>

            </div>
          </details>

        </div>
      </section>
    </div>
  </fv-shell>

  <!-- Adjust Modal -->
  <div id="adjustBackdrop" class="modal-backdrop pv-hide" role="dialog" aria-modal="true" aria-labelledby="adjustTitle">
    <div class="modal">
      <div class="modal-h">
        <h3 id="adjustTitle">Adjust</h3>
        <div class="muted" style="font-size:12px; margin-top:4px;" id="adjustSub">‚Äî</div>
      </div>
      <div class="modal-b">
        <div class="note" id="adjustRule">‚Äî</div>

        <div id="adjustStep1">
          <div class="actions">
            <button id="btnAdjWet" class="btn btn-danger" type="button">Wet</button>
            <button id="btnAdjDry" class="btn btn-primary" type="button">Dry</button>
            <button id="btnAdjCancel" class="btn" type="button">Cancel</button>
          </div>
        </div>

        <div id="adjustStepDry" class="pv-hide">
          <div class="note" style="margin-top:12px;">
            <b>How dry is it?</b> Sets current Field Readiness.
          </div>
          <div class="actions">
            <button id="btnDryBarely" class="btn" type="button">Barely ready</button>
            <button id="btnDryPerfect" class="btn btn-primary" type="button">Perfect</button>
            <button id="btnDryVery" class="btn" type="button">Very dry</button>
            <button id="btnDryBack" class="btn" type="button">Back</button>
          </div>
        </div>

        <div id="adjustStepWet" class="pv-hide">
          <div class="note" style="margin-top:12px;">
            <b>How wet is it?</b> Lowers current Field Readiness.
          </div>
          <div class="actions">
            <button id="btnWetBarely" class="btn" type="button">Barely wet</button>
            <button id="btnWetPretty" class="btn btn-danger" type="button">Pretty wet</button>
            <button id="btnWetVery" class="btn btn-danger" type="button">Very wet</button>
            <button id="btnWetBack" class="btn" type="button">Back</button>
          </div>
        </div>

        <div class="note" style="margin-top:12px;" id="adjustSoilDrain">‚Äî</div>
      </div>
    </div>
  </div>

  <script>
  (function(){
    'use strict';

    const $ = id => document.getElementById(id);
    const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
    const round = (v, d=2) => {
      const p = Math.pow(10,d);
      return Math.round(v*p)/p;
    };

    const LOSS_SCALE = 0.55;
    const LS_KEY = 'fv_dev_field_readiness_params_v1';

    const state = {
      weather30: [],
      seed: Date.now() % 1000000,
      mode: 'MOCK',
      selectedFieldId: null,
      lastRuns: new Map(),
      readyOverride: new Map(),
      adjustContext: { fieldId:null },
      fields: [],
      farmsById: new Map(),
      perFieldParams: new Map(),
      fieldsMeta: { total:0, activeGps:0, usedFallback:false }
    };

    function esc(s){
      return String(s||'')
        .replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;')
        .replaceAll('"','&quot;').replaceAll("'","&#039;");
    }

    function setErr(msg){
      const el = $('err');
      if (!el) return;
      if (!msg){ el.hidden = true; el.textContent=''; return; }
      el.hidden = false;
      el.textContent = msg;
    }

    function toast(msg){
      try{
        if (window.FV && typeof window.FV.toast === 'function') return window.FV.toast(msg);
      }catch(_){}
      setErr(msg);
      setTimeout(()=> setErr(''), 2600);
    }

    function getFirestoreAPI(){
      if (window.getFirestore && window.collection && window.getDocs && window.query && window.where) {
        return {
          kind: 'global-modular',
          getFirestore: window.getFirestore,
          collection: window.collection,
          getDocs: window.getDocs,
          query: window.query,
          where: window.where
        };
      }
      if (window.FV && window.FV.firestore && window.FV.firestore.getFirestore) {
        const api = window.FV.firestore;
        return {
          kind: 'fv-modular',
          getFirestore: api.getFirestore,
          collection: api.collection,
          getDocs: api.getDocs,
          query: api.query,
          where: api.where
        };
      }
      if (window.firebase && window.firebase.firestore) {
        return { kind:'compat' };
      }
      return null;
    }

    async function loadFarmsOptional(){
      const api = getFirestoreAPI();
      if (!api || api.kind === 'compat') return;
      try{
        const db = api.getFirestore();
        const snap = await api.getDocs(api.collection(db,'farms'));
        const map = new Map();
        snap.forEach(doc=>{
          const d = doc.data() || {};
          if (d && d.name) map.set(doc.id, String(d.name));
        });
        state.farmsById = map;
      }catch(_){}
    }

    function normalizeStatus(s){
      return String(s||'').trim().toLowerCase();
    }

    function extractFieldDoc(docId, d){
      const loc = d.location || {};
      const lat = Number(loc.lat);
      const lng = Number(loc.lng);
      return {
        id: docId,
        name: String(d.name||''),
        county: String(d.county||''),
        state: String(d.state||''),
        farmId: String(d.farmId||''),
        rtkTowerId: String(d.rtkTowerId||''),
        status: String(d.status||''),
        tillable: Number(d.tillable||0),
        location: (isFinite(lat) && isFinite(lng)) ? { lat, lng } : null,
        updatedAt: d.updatedAt || null,
        createdAt: d.createdAt || null
      };
    }

    async function loadFields(){
      const api = getFirestoreAPI();
      if (!api){
        setErr('Firebase helpers not found. Make sure /Farm-vista/js/firebase-init.js is loading and exposes Firestore helpers.');
        state.fields = [];
        updateFieldsDebug();
        renderTiles();
        return;
      }

      try{
        let rawDocs = [];
        let usedFallback = false;

        // Prefer filtered query
        if (api.kind !== 'compat'){
          const db = api.getFirestore();
          const q = api.query(api.collection(db,'fields'), api.where('status','==','active'));
          const snap = await api.getDocs(q);
          snap.forEach(doc=> rawDocs.push({ id: doc.id, data: doc.data() || {} }));

          // Fallback: if 0 results, fetch all and filter client-side (catches casing/mismatch)
          if (rawDocs.length === 0){
            usedFallback = true;
            const snap2 = await api.getDocs(api.collection(db,'fields'));
            snap2.forEach(doc=> rawDocs.push({ id: doc.id, data: doc.data() || {} }));
          }
        } else {
          // compat
          const db = window.firebase.firestore();
          let snap = await db.collection('fields').where('status','==','active').get();
          snap.forEach(doc=> rawDocs.push({ id: doc.id, data: doc.data() || {} }));
          if (rawDocs.length === 0){
            usedFallback = true;
            snap = await db.collection('fields').get();
            snap.forEach(doc=> rawDocs.push({ id: doc.id, data: doc.data() || {} }));
          }
        }

        const allCount = rawDocs.length;

        // Filter: status active (case-insensitive) AND has location lat/lng
        const arr = [];
        for (const r of rawDocs){
          const f = extractFieldDoc(r.id, r.data);
          if (normalizeStatus(f.status) !== 'active') continue;
          if (!f.location || !isFinite(f.location.lat) || !isFinite(f.location.lng)) continue;
          arr.push(f);
        }

        arr.sort((a,b)=> String(a.name).localeCompare(String(b.name), undefined, {numeric:true, sensitivity:'base'}));
        state.fields = arr;
        state.fieldsMeta = { total: allCount, activeGps: arr.length, usedFallback };

        if (!state.selectedFieldId || !state.fields.find(f=>f.id===state.selectedFieldId)){
          state.selectedFieldId = state.fields.length ? state.fields[0].id : null;
        }

        loadParamsFromLocal();
        ensureSelectedParamsToSliders();

        $('emptyMsg').style.display = state.fields.length ? 'none' : 'block';
        updateFieldsDebug();

        renderTiles();
        renderDetails();
      }catch(e){
        setErr(`Failed to load fields: ${e.message}`);
        state.fields = [];
        state.fieldsMeta = { total:0, activeGps:0, usedFallback:false };
        $('emptyMsg').style.display = 'block';
        updateFieldsDebug();
        renderTiles();
      }
    }

    function updateFieldsDebug(){
      const el = $('fieldsDebug');
      if (!el) return;
      const m = state.fieldsMeta || { total:0, activeGps:0, usedFallback:false };
      el.innerHTML = `Firestore: <span class="mono">fields</span> ‚Üí scanned <b>${m.total}</b> docs, showing <b>${m.activeGps}</b> (active + GPS).${m.usedFallback ? ' <b>(fallback used)</b>' : ''}`;
    }

    function loadParamsFromLocal(){
      state.perFieldParams = new Map();
      try{
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return;
        const obj = JSON.parse(raw);
        if (!obj || typeof obj !== 'object') return;
        for (const [k,v] of Object.entries(obj)){
          if (!v || typeof v !== 'object') continue;
          state.perFieldParams.set(k, {
            soil: clamp(Number(v.soil||6), 1, 10),
            drain: clamp(Number(v.drain||5), 1, 10),
            rainFactor: isFinite(Number(v.rainFactor)) ? Number(v.rainFactor) : 1
          });
        }
      }catch(_){}
    }

    function saveParamsToLocal(){
      try{
        const obj = {};
        for (const [k,v] of state.perFieldParams.entries()){
          obj[k] = { soil:v.soil, drain:v.drain, rainFactor:v.rainFactor };
        }
        localStorage.setItem(LS_KEY, JSON.stringify(obj));
      }catch(_){}
    }

    function getFieldParams(fieldId){
      const p = state.perFieldParams.get(fieldId);
      if (p) return p;
      const def = { soil:6, drain:5, rainFactor:1 };
      state.perFieldParams.set(fieldId, def);
      return def;
    }

    function ensureSelectedParamsToSliders(){
      if (!state.selectedFieldId) return;
      const p = getFieldParams(state.selectedFieldId);
      $('soilWet').value = String(p.soil);
      $('drain').value   = String(p.drain);
    }

    // Mock weather
    function seededRand(){
      state.seed = (state.seed * 1664525 + 1013904223) % 4294967296;
      return state.seed / 4294967296;
    }
    function genMock30(){
      const out = [];
      const today = new Date();
      today.setHours(12,0,0,0);

      for (let i=29; i>=0; i--){
        const d = new Date(today);
        d.setDate(d.getDate() - i);

        const eventRoll = seededRand();
        let rain = 0;
        if (eventRoll > 0.82) rain = 0.10 + seededRand()*1.10;
        else if (eventRoll > 0.72) rain = 0.02 + seededRand()*0.16;

        const wave = Math.sin((29-i)/6) * 6;
        const temp = 34 + wave + (seededRand()*10 - 5);
        const wind = 4 + seededRand()*18;

        let rh = 45 + seededRand()*45;
        if (rain > 0) rh = clamp(rh + 10 + seededRand()*10, 35, 98);

        let solar = 120 + seededRand()*220;
        if (rain > 0) solar = clamp(solar - 60 - seededRand()*80, 40, 360);

        out.push({
          dateISO: d.toISOString().slice(0,10),
          rainIn: round(rain, 2),
          tempF: Math.round(temp),
          windMph: Math.round(wind),
          rh: Math.round(rh),
          solarWm2: Math.round(solar),
        });
      }

      state.weather30 = out;
      state.mode = 'MOCK';
    }

    // Date range parsing
    function parseRangeFromInput(){
      const raw = String($('jobRangeInput').value || '').trim();
      if (!raw) return { start:null, end:null };

      const parts = raw.split('‚Äì').map(s=>s.trim());
      if (parts.length === 2){
        const a = new Date(parts[0]);
        const b = new Date(parts[1]);
        if (isFinite(a.getTime()) && isFinite(b.getTime())){
          a.setHours(0,0,0,0);
          b.setHours(23,59,59,999);
          return { start:a, end:b };
        }
      }

      const d = new Date(raw);
      if (isFinite(d.getTime())){
        d.setHours(0,0,0,0);
        const e = new Date(d);
        e.setHours(23,59,59,999);
        return { start:d, end:e };
      }

      return { start:null, end:null };
    }
    function isDateInRange(dateISO, range){
      if (!range || !range.start || !range.end) return true;
      const d = new Date(dateISO + 'T12:00:00');
      return d >= range.start && d <= range.end;
    }

    // Dry power parts
    function calcDryParts(r){
      const temp = Number(r.tempF||0);
      const wind = Number(r.windMph||0);
      const rh   = Number(r.rh||0);
      const solar= Number(r.solarWm2||0);

      const tempN = clamp((temp - 20) / 45, 0, 1);
      const windN = clamp((wind - 2) / 20, 0, 1);
      const solarN= clamp((solar - 60) / 300, 0, 1);
      const rhN   = clamp((rh - 35) / 65, 0, 1);

      const raw = (0.35*tempN + 0.30*solarN + 0.25*windN - 0.25*rhN);
      const dryPwr = clamp(raw, 0, 1);
      return { temp, wind, rh, solar, tempN, windN, rhN, solarN, raw, dryPwr };
    }

    // Factor mapping
    function mapFactors(soil, drain){
      const soilHold = (Number(soil) - 1) / 9;
      const drainPoor= (Number(drain) - 1) / 9;

      const infilMult = 0.60 + 0.30*soilHold + 0.35*drainPoor;
      const dryMult   = 1.20 - 0.35*soilHold - 0.40*drainPoor;
      const Smax      = 2.60 + 1.00*soilHold + 0.90*drainPoor;

      return { soilHold, drainPoor, infilMult, dryMult, Smax };
    }

    function runField(field){
      if (!state.weather30.length) return null;

      const p = getFieldParams(field.id);
      const f = mapFactors(p.soil, p.drain);
      const rf = (state.mode === 'MOCK') ? (p.rainFactor || 1) : 1;

      const rows = state.weather30.map(w=>{
        const parts = calcDryParts(w);
        const rainAdj = round(Number(w.rainIn||0) * rf, 2);
        return { ...w, rainInAdj: rainAdj, ...parts };
      });

      const first7 = rows.slice(0,7);
      const rain7 = first7.reduce((s,x)=> s + Number(x.rainInAdj||0), 0);
      const rainNudgeFrac = clamp(rain7 / 4.0, 0, 1);
      const rainNudge = rainNudgeFrac * (0.35 * f.Smax);

      let storage = clamp((0.45 * f.Smax) + rainNudge, 0, f.Smax);

      const trace = [];
      for (const d of rows){
        const rain = Number(d.rainInAdj||0);
        const add = rain * f.infilMult;
        const loss = Number(d.dryPwr||0) * LOSS_SCALE * f.dryMult;
        const before = storage;
        const after = clamp(before + add - loss, 0, f.Smax);
        storage = after;
        trace.push({ dateISO:d.dateISO, rain, infilMult:f.infilMult, add, dryPwr:d.dryPwr, loss, before, after });
      }

      const wetness = clamp((storage / f.Smax) * 100, 0, 100);
      const wetnessR = Math.round(wetness);
      const readinessR = Math.round(clamp(100 - wetness, 0, 100));

      const last7 = trace.slice(-7);
      const avgLossDay = last7.length ? (last7.reduce((s,x)=> s + x.loss, 0) / last7.length) : 0.08;

      return { field, factors:f, rows, trace, storageFinal:storage, wetnessR, readinessR, rain7, rainNudge, avgLossDay, rf };
    }

    function etaFor(run, threshold){
      if (!run) return '';
      if (run.readinessR >= threshold) return '';
      const wetTarget = clamp(100 - threshold, 0, 100);
      const storageTarget = run.factors.Smax * (wetTarget / 100);
      const delta = run.storageFinal - storageTarget;
      const dailyLoss = Math.max(0.02, run.avgLossDay);
      const hours = Math.ceil((delta / dailyLoss) * 24);
      if (hours <= 48) return `Est: ~${hours} hours`;
      return 'Estimated to be greater then 2 days';
    }

    function rainInRange(run, range){
      if (!run || !run.rows) return 0;
      let sum = 0;
      for (const r of run.rows){
        if (isDateInRange(r.dateISO, range)) sum += Number(r.rainInAdj||0);
      }
      return round(sum, 2);
    }

    function sortFields(fields, runsById){
      const mode = String($('sortSel').value || 'name_az');
      const range = parseRangeFromInput();
      const collator = new Intl.Collator(undefined, { numeric:true, sensitivity:'base' });
      const arr = fields.slice();

      arr.sort((a,b)=>{
        const ra = runsById.get(a.id);
        const rb = runsById.get(b.id);

        const nameA = `${a.name||''}`;
        const nameB = `${b.name||''}`;

        const readyA = ra ? ra.readinessR : 0;
        const readyB = rb ? rb.readinessR : 0;

        const rainA = ra ? rainInRange(ra, range) : 0;
        const rainB = rb ? rainInRange(rb, range) : 0;

        if (mode === 'name_az') return collator.compare(nameA, nameB);
        if (mode === 'name_za') return collator.compare(nameB, nameA);

        if (mode === 'ready_dry_wet'){ if (readyB !== readyA) return readyB - readyA; return collator.compare(nameA, nameB); }
        if (mode === 'ready_wet_dry'){ if (readyB !== readyA) return readyA - readyB; return collator.compare(nameA, nameB); }

        if (mode === 'rain_most'){ if (rainB !== rainA) return rainB - rainA; return collator.compare(nameA, nameB); }
        if (mode === 'rain_least'){ if (rainB !== rainA) return rainA - rainB; return collator.compare(nameA, nameB); }

        return collator.compare(nameA, nameB);
      });

      return arr;
    }

    function readinessColor(score){
      const p = clamp(score, 0, 100);
      if (p <= 55){
        const t = p / 55;
        const r = Math.round(200 + (216-200)*t);
        const g = Math.round(59  + (178-59)*t);
        const b = 59;
        return `rgb(${r},${g},${b})`;
      } else {
        const t = (p - 55) / 45;
        const r = Math.round(216 + (47-216)*t);
        const g = Math.round(178 + (143-178)*t);
        const b = Math.round(59  + (75-59)*t);
        return `rgb(${r},${g},${b})`;
      }
    }

    function markerLeftCSS(pct){
      const p = clamp(pct, 0, 100);
      if (p >= 100) return 'calc(100% - 2px)';
      if (p <= 0) return '2px';
      return p.toFixed(2) + '%';
    }

    function renderTiles(){
      const wrap = $('fieldsGrid');
      wrap.innerHTML = '';

      state.lastRuns.clear();
      for (const f of state.fields){
        state.lastRuns.set(f.id, runField(f));
      }

      const sorted = sortFields(state.fields, state.lastRuns);
      const thr = Number($('workable').value);
      const range = parseRangeFromInput();

      for (const f of sorted){
        const run0 = state.lastRuns.get(f.id);
        if (!run0) continue;

        const overrideReady = state.readyOverride.has(f.id) ? Number(state.readyOverride.get(f.id)) : null;
        const readiness = (overrideReady === null || !isFinite(overrideReady)) ? run0.readinessR : clamp(Math.round(overrideReady), 0, 100);

        const eta = etaFor(run0, thr);
        const rainRange = rainInRange(run0, range);

        const leftPos = markerLeftCSS(readiness);
        const thrPos  = markerLeftCSS(thr);
        const pillBg = readinessColor(readiness);

        const farmName = state.farmsById.get(f.farmId) || '';
        const labelLeft = farmName ? `${farmName} ‚Ä¢ ${f.name}` : f.name;

        const tile = document.createElement('div');
        tile.className = 'tile' + (f.id === state.selectedFieldId ? ' active' : '');

        tile.innerHTML = `
          <div class="tile-top">
            <div class="titleline">
              <div class="name" title="${esc(labelLeft)}">${esc(labelLeft)}</div>
              <button class="tiny-btn" data-adjust="${esc(f.id)}" type="button">Adjust</button>
            </div>
            <div class="readiness-pill" style="background:${pillBg};">Field Readiness ${readiness}</div>
          </div>

          <p class="subline">Rain (range): <span class="mono">${rainRange.toFixed(2)}</span> in</p>

          <div class="gauge-wrap">
            <div class="chips">
              <div class="chip wet">Wet</div>
              <div class="chip readiness">Readiness</div>
            </div>

            <div class="gauge">
              <div class="thr" style="left:${thrPos};"></div>
              <div class="marker" style="left:${leftPos};"></div>
              <div class="badge" style="left:${leftPos};">Field Readiness ${readiness}</div>
            </div>

            <div class="ticks"><span>0</span><span>50</span><span>100</span></div>

            ${eta ? `<div class="help"><b>${eta}</b></div>` : ``}
          </div>
        `;

        tile.addEventListener('click', (e)=>{
          const btn = e.target && e.target.closest ? e.target.closest('button') : null;
          if (btn) return;
          selectField(f.id);
        });

        tile.querySelector('button[data-adjust]').addEventListener('click', (e)=>{
          e.stopPropagation();
          openAdjust(f.id);
        });

        wrap.appendChild(tile);
      }

      $('emptyMsg').style.display = state.fields.length ? 'none' : 'block';
    }

    function selectField(id){
      const f = state.fields.find(x=>x.id === id);
      if (!f) return;
      state.selectedFieldId = id;
      ensureSelectedParamsToSliders();
      refreshAll();
    }

    function soilTypeLabel(n){
      const v = clamp(Number(n), 1, 10);
      if (v <= 2) return 'Sandy / low holding';
      if (v <= 4) return 'Sandy loam';
      if (v <= 6) return 'Loam / balanced';
      if (v <= 8) return 'Silty clay loam';
      return 'Clay / high holding';
    }
    function drainageLabel(n){
      const v = clamp(Number(n), 1, 10);
      if (v <= 2) return 'Very good drainage';
      if (v <= 4) return 'Good drainage';
      if (v <= 6) return 'Moderate drainage';
      if (v <= 8) return 'Poor drainage';
      return 'Very poor drainage';
    }

    function renderDetails(){
      const f = state.fields.find(x=>x.id === state.selectedFieldId);
      if (!f) return;

      const run = state.lastRuns.get(f.id) || runField(f);
      if (!run) return;

      const fac = run.factors;
      const overrideReady = state.readyOverride.has(f.id) ? Number(state.readyOverride.get(f.id)) : null;
      const shown = (overrideReady === null || !isFinite(overrideReady)) ? run.readinessR : clamp(Math.round(overrideReady), 0, 100);

      const p = getFieldParams(f.id);
      const thr = Number($('workable').value);
      const op  = String($('opSel').value || '');
      const range = parseRangeFromInput();
      const rainRange = rainInRange(run, range);

      const base = String($('apiBase').value || '').trim().replace(/\/+$/,'');
      const endpoint = (base && f.location && isFinite(f.location.lat) && isFinite(f.location.lng))
        ? `${base}/weather30?lat=${f.location.lat.toFixed(6)}&lon=${f.location.lng.toFixed(6)}`
        : '‚Äî';

      const farmName = state.farmsById.get(f.farmId) || '';
      $('dFieldName').textContent = farmName ? `${farmName} ‚Ä¢ ${f.name}` : (f.name || '‚Äî');
      $('dStatus').textContent = String(f.status||'‚Äî');
      $('dCounty').textContent = `${String(f.county||'‚Äî')} / ${String(f.state||'‚Äî')}`;
      $('dAcres').textContent = (isFinite(f.tillable) ? `${f.tillable.toFixed(2)} ac` : '‚Äî');
      $('dGps').textContent = (f.location ? `${f.location.lat.toFixed(6)}, ${f.location.lng.toFixed(6)}` : '‚Äî');

      $('dSoilType').textContent = `${soilTypeLabel(p.soil)} (${p.soil}/10)`;
      $('dSoilHold').textContent = `${fac.soilHold.toFixed(2)} (normalized)`;
      $('dDrainage').textContent = `${drainageLabel(p.drain)} (${p.drain}/10)`;

      $('dThreshold').textContent = `${thr}`;
      $('dOperation').textContent = op;

      $('dMode').textContent = state.mode;
      $('dApiBase').textContent = base || '(blank ‚Üí mock)';
      $('dEndpoint').textContent = endpoint;
      $('dDays').textContent = String(state.weather30.length || 0);
      $('dRangeRain').textContent = `${rainRange.toFixed(2)} in`;
      $('dReadiness').textContent = `${shown}${(overrideReady!==null?' (manual)':'')}`;
      $('dWetness').textContent = `${run.wetnessR}`;
      $('dStorage').textContent = `${run.storageFinal.toFixed(2)} / ${run.factors.Smax.toFixed(2)}`;

      $('paramExplain').innerHTML =
        `<b>Selected:</b> ${esc(f.name)}<br/>
         <b>Displayed Field Readiness:</b> <span class="mono">${shown}</span>${(overrideReady!==null?' (manual override)':'')}<br/><br/>
         soilHold=(soil‚àí1)/9=<span class="mono">${fac.soilHold.toFixed(2)}</span> ‚Ä¢ drainPoor=(drain‚àí1)/9=<span class="mono">${fac.drainPoor.toFixed(2)}</span><br/>
         Smax=<span class="mono">${fac.Smax.toFixed(2)}</span> ‚Ä¢ infilMult=<span class="mono">${fac.infilMult.toFixed(2)}</span> ‚Ä¢ dryMult=<span class="mono">${fac.dryMult.toFixed(2)}</span> ‚Ä¢ LOSS_SCALE=<span class="mono">${LOSS_SCALE.toFixed(2)}</span>`;

      $('mathSummary').innerHTML =
        `Model output: <b>Wet=${run.wetnessR}</b> ‚Ä¢ <b>Readiness=${run.readinessR}</b> ‚Ä¢ storage=<span class="mono">${run.storageFinal.toFixed(2)}</span>/<span class="mono">${run.factors.Smax.toFixed(2)}</span><br/>
         Start: storage0=0.45*Smax + rainNudge (rain7=<span class="mono">${run.rain7.toFixed(2)}</span> in, nudge=<span class="mono">${run.rainNudge.toFixed(2)}</span>)`;

      const trb = $('traceRows');
      trb.innerHTML = '';
      for (const t of run.trace){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="mono">${t.dateISO}</td>
          <td class="right mono">${t.rain.toFixed(2)}</td>
          <td class="right mono">${t.infilMult.toFixed(2)}</td>
          <td class="right mono">${t.add.toFixed(2)}</td>
          <td class="right mono">${t.dryPwr.toFixed(2)}</td>
          <td class="right mono">${t.loss.toFixed(2)}</td>
          <td class="right mono">${t.before.toFixed(2)}‚Üí${t.after.toFixed(2)}</td>
        `;
        trb.appendChild(tr);
      }

      const drb = $('dryRows');
      drb.innerHTML = '';
      for (const r of run.rows){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="mono">${r.dateISO}</td>
          <td class="right mono">${Math.round(r.temp)}</td>
          <td class="right mono">${r.tempN.toFixed(2)}</td>
          <td class="right mono">${Math.round(r.wind)}</td>
          <td class="right mono">${r.windN.toFixed(2)}</td>
          <td class="right mono">${Math.round(r.rh)}</td>
          <td class="right mono">${r.rhN.toFixed(2)}</td>
          <td class="right mono">${Math.round(r.solar)}</td>
          <td class="right mono">${r.solarN.toFixed(2)}</td>
          <td class="right mono">${r.raw.toFixed(2)}</td>
          <td class="right mono">${r.dryPwr.toFixed(2)}</td>
        `;
        drb.appendChild(tr);
      }

      const wxb = $('wxRows');
      wxb.innerHTML = '';
      for (const r of run.rows){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="mono">${r.dateISO}</td>
          <td class="right mono">${Number(r.rainInAdj||0).toFixed(2)}</td>
          <td class="right mono">${Math.round(r.temp)}</td>
          <td class="right mono">${Math.round(r.wind)}</td>
          <td class="right mono">${Math.round(r.rh)}</td>
          <td class="right mono">${Math.round(r.solar)}</td>
        `;
        wxb.appendChild(tr);
      }
    }

    // Adjust modal
    function showModal(on){ $('adjustBackdrop').classList.toggle('pv-hide', !on); }
    function showStep(which){
      $('adjustStep1').classList.toggle('pv-hide', which !== 'start');
      $('adjustStepDry').classList.toggle('pv-hide', which !== 'dry');
      $('adjustStepWet').classList.toggle('pv-hide', which !== 'wet');
    }

    function openAdjust(id){
      const f = state.fields.find(x=>x.id === id);
      const run = state.lastRuns.get(id) || runField(f);
      const thr = Number($('workable').value);
      const op  = String($('opSel').value || '');

      state.adjustContext.fieldId = id;

      const currentReady = state.readyOverride.has(id) ? Number(state.readyOverride.get(id)) : run.readinessR;
      const isReady = (currentReady >= thr);

      $('adjustTitle').textContent = 'Adjust';
      $('adjustSub').textContent = `${f.name} ‚Ä¢ Op: ${op} ‚Ä¢ Threshold: ${thr}`;

      const btnWet = $('btnAdjWet');
      const btnDry = $('btnAdjDry');

      btnWet.disabled = !isReady ? true : false;
      btnDry.disabled = isReady ? true : false;

      const eta = etaFor(run, thr);
      $('adjustRule').innerHTML =
        isReady
          ? `Model says <b>READY</b> (Field Readiness ${Math.round(currentReady)} ‚â• ${thr}). Only <b>Wet</b> is allowed.`
          : `Model says <b>WET</b> (Field Readiness ${Math.round(currentReady)} &lt; ${thr}). Only <b>Dry</b> is allowed.<br/><b>${eta || 'Estimated to be greater then 2 days'}</b>`;

      const p = getFieldParams(id);
      $('adjustSoilDrain').innerHTML =
        `<b>Field settings</b><br/>
         <b>Soil:</b> ${p.soil}/10 ‚Ä¢ <b>Drain:</b> ${p.drain}/10<br/><br/>
         <b>Definitions</b><br/>
         <b>Soil Type / Holding (1‚Äì10):</b> 1=sandier (holds less, dries faster) ‚Ä¢ 10=clay (holds more, dries slower)<br/>
         <b>Drainage (1‚Äì10):</b> 1=very good drainage ‚Ä¢ 10=very poor drainage`;

      showStep('start');
      showModal(true);
    }

    function closeAdjust(){
      showModal(false);
      state.adjustContext.fieldId = null;
      showStep('start');
    }

    function setDryLevel(level){
      const id = state.adjustContext.fieldId;
      if (!id) return;
      const thr = Number($('workable').value);

      let ready;
      if (level === 'barely') ready = clamp(thr, 0, 100);
      else if (level === 'perfect') ready = clamp(Math.max(thr + 10, 85), 0, 100);
      else if (level === 'very') ready = 100;
      else ready = clamp(thr, 0, 100);

      state.readyOverride.set(id, ready);
      closeAdjust(); refreshAll();
    }

    function setWetLevel(level){
      const id = state.adjustContext.fieldId;
      if (!id) return;
      const thr = Number($('workable').value);

      let ready;
      if (level === 'barely') ready = clamp(thr - 1, 0, 100);
      else if (level === 'pretty') ready = clamp(thr - 15, 0, 100);
      else if (level === 'very') ready = clamp(thr - 35, 0, 100);
      else ready = clamp(thr - 10, 0, 100);

      state.readyOverride.set(id, ready);
      closeAdjust(); refreshAll();
    }

    $('btnAdjCancel').addEventListener('click', closeAdjust);
    $('adjustBackdrop').addEventListener('click', (e)=>{
      if (e.target && e.target.id === 'adjustBackdrop') closeAdjust();
    });

    $('btnAdjWet').addEventListener('click', ()=> showStep('wet'));
    $('btnAdjDry').addEventListener('click', ()=> showStep('dry'));

    $('btnDryBack').addEventListener('click', ()=> showStep('start'));
    $('btnDryBarely').addEventListener('click', ()=> setDryLevel('barely'));
    $('btnDryPerfect').addEventListener('click', ()=> setDryLevel('perfect'));
    $('btnDryVery').addEventListener('click', ()=> setDryLevel('very'));

    $('btnWetBack').addEventListener('click', ()=> showStep('start'));
    $('btnWetBarely').addEventListener('click', ()=> setWetLevel('barely'));
    $('btnWetPretty').addEventListener('click', ()=> setWetLevel('pretty'));
    $('btnWetVery').addEventListener('click', ()=> setWetLevel('very'));

    // Fake buttons
    document.addEventListener('click', (e)=>{
      const btn = e.target && e.target.closest ? e.target.closest('[data-fake]') : null;
      if (!btn) return;
      const kind = btn.getAttribute('data-fake');
      const f = state.fields.find(x=>x.id===state.selectedFieldId);
      if (!f) return;

      if (kind === 'maps'){
        const lat = f.location?.lat, lng = f.location?.lng;
        if (isFinite(lat) && isFinite(lng)){
          const url = `https://www.google.com/maps?q=${lat},${lng}`;
          window.open(url, '_blank', 'noopener');
          return;
        }
      }

      if (kind === 'soil') return toast('Soil Survey: coming soon (NRCS / SSURGO hook).');
      if (kind === 'wo')   return toast('Work Order creation: coming soon.');
      if (kind === 'share')return toast('Share Summary: coming soon (PDF / message).');
      toast('Coming soon.');
    });

    function refreshAll(){
      setErr('');

      if (state.selectedFieldId){
        const p = getFieldParams(state.selectedFieldId);
        p.soil  = clamp(Number($('soilWet').value), 1, 10);
        p.drain = clamp(Number($('drain').value), 1, 10);
        state.perFieldParams.set(state.selectedFieldId, p);
        saveParamsToLocal();
      }

      renderTiles();
      renderDetails();
    }

    $('sortSel').addEventListener('change', refreshAll);
    $('opSel').addEventListener('change', refreshAll);

    $('soilWet').addEventListener('input', refreshAll);
    $('drain').addEventListener('input', refreshAll);
    $('workable').addEventListener('input', refreshAll);

    $('applyRangeBtn').addEventListener('click', ()=> setTimeout(refreshAll, 0));
    $('clearRangeBtn').addEventListener('click', ()=> setTimeout(refreshAll, 0));
    $('jobRangeInput').addEventListener('change', refreshAll);

    $('btnRegen').addEventListener('click', ()=>{
      state.seed = Date.now() % 1000000;
      genMock30();
      refreshAll();
    });

    $('btnRun').addEventListener('click', refreshAll);

    async function fetchReal30(){
      const base = String($('apiBase').value || '').trim().replace(/\/+$/,'');
      if (!base){ setErr('Add your Weather API Base URL first.'); return; }

      const f = state.fields.find(x=>x.id === state.selectedFieldId);
      if (!f || !f.location || !isFinite(f.location.lat) || !isFinite(f.location.lng)){
        setErr('Selected field has no valid GPS.'); return;
      }

      try{
        const url = `${base}/weather30?lat=${encodeURIComponent(f.location.lat)}&lon=${encodeURIComponent(f.location.lng)}`;
        const res = await fetch(url, { method:'GET' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const days = Array.isArray(data.days) ? data.days : [];
        if (days.length < 20) throw new Error('Response missing days[]');

        state.weather30 = days.map(d=>({
          dateISO: String(d.dateISO||'').slice(0,10),
          rainIn: Number(d.rainIn||0),
          tempF: Number(d.tempF||0),
          windMph: Number(d.windMph||0),
          rh: Number(d.rh||0),
          solarWm2: Number(d.solarWm2||0),
        })).filter(x=>x.dateISO);

        state.mode = 'REAL';
        refreshAll();
      }catch(e){
        setErr(`Fetch failed: ${e.message}`);
      }
    }
    $('btnFetch').addEventListener('click', fetchReal30);

    (async function init(){
      try{
        const dp = $('detailsPanel');
        if (dp) dp.open = false;
      }catch(_){}

      genMock30();

      await loadFarmsOptional();
      await loadFields();

      if (!state.selectedFieldId && state.fields.length){
        state.selectedFieldId = state.fields[0].id;
      }

      ensureSelectedParamsToSliders();
      refreshAll();
    })();

  })();
  </script>
</body>
</html>
