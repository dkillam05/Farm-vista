<!-- =====================================================================
/Farm-vista/pages/dev/weather.html  (FULL FILE)
Rev: 2025-12-20e
Dev Wetness Model (FULL FEATURE + On-page error panel)

✅ Default: Divernon, IL
✅ Sliders:
    • Soil Wetness (1–10)
    • Drainage (1–10)
    • Workable Threshold (0–100)
    • “How too wet?” (0–100) for feedback
✅ Mock 30-day daily weather generator (always available)
✅ Optional: Fetch REAL 30 days from your backend function:
    Base URL: https://YOUR-SERVICE
    Endpoint: GET {base}/weather30?lat=..&lon=..
    Response: { days:[{dateISO,rainIn,tempF,windMph,rh,solarWm2}], meta?:{...} }
✅ Model:
    storage(t) = clamp(storage(t-1) + infilMult*rain - dryingLoss(dryPwr), 0..Smax)
    WetnessIndex = storage/Smax * 100
✅ Feedback:
    “Mark TOO WET” stored to localStorage (dev)
✅ New reliability:
    On-page error panel (so you SEE JS errors even on iOS Safari)
===================================================================== -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista • Dev • Weather Model</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <script src="/Farm-vista/js/theme-boot.js"></script>

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>

  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <script src="/Farm-vista/js/core.js"></script>

  <style>
    :root{ --card-max:1180px; --page-bottom-gap:72px; --accent:#2F6C3C; }

    .page{
      max-width:var(--card-max);
      margin:0 auto;
      padding:clamp(14px,3vw,22px);
      padding-bottom:calc(var(--page-bottom-gap) + env(safe-area-inset-bottom,0px));
    }
    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:14px; }
    .topbar h1{ font-size:18px; margin:0; letter-spacing:.2px; }

    a,a:visited,a:hover,a:active{ color:var(--text); text-decoration:none; }

    .grid{ display:grid; grid-template-columns:1fr; gap:14px; }
    @media(min-width:980px){ .grid{ grid-template-columns:460px 1fr; } }

    .card{
      background:var(--card, var(--surface));
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.08);
      overflow:hidden;
    }
    .card-h{ padding:14px 14px 10px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; gap:12px; }
    .card-h .t{ margin:0; font-size:15px; font-weight:950; }
    .card-b{ padding:14px; }

    .field{ display:flex; flex-direction:column; gap:6px; margin-bottom:12px; }
    label{ font-size:12px; opacity:.9; }
    input[type="text"], input[type="number"]{
      width:100%; padding:10px 12px; border-radius:12px;
      border:1px solid var(--border);
      background:var(--surface, var(--card));
      color:var(--text);
      outline:none;
    }

    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .row > *{ flex:1 1 auto; }

    .slider-wrap{ display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center; margin:6px 0 14px; }
    input[type="range"]{ width:100%; accent-color:var(--brand,#3B7E46); }

    .pill{
      display:inline-flex; align-items:center; justify-content:center;
      min-width:58px; height:34px; padding:0 10px;
      border-radius:999px; border:1px solid var(--border);
      background:color-mix(in srgb, var(--surface) 88%, #ffffff 12%);
      font-weight:950;
    }

    .btnbar{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .btn{
      border:1px solid var(--border);
      background:var(--surface, var(--card));
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-weight:950;
      cursor:pointer;
      user-select:none;
    }
    .btn:active{ transform:translateY(1px); }
    .btn.primary{ background:var(--brand,#3B7E46); border-color:transparent; color:#fff !important; }
    .btn.danger{ background:#b02a2a; border-color:transparent; color:#fff !important; }

    .note{
      border:1px dashed var(--border);
      border-radius:14px;
      padding:10px 12px;
      background:color-mix(in srgb, var(--surface) 92%, #ffffff 8%);
      font-size:12px;
      opacity:.95;
      line-height:1.35;
    }

    .kpis{ display:grid; grid-template-columns:1fr; gap:12px; }
    @media(min-width:720px){ .kpis{ grid-template-columns:1fr 1fr; } }
    .kpi{
      border:1px solid var(--border);
      border-radius:16px;
      background:color-mix(in srgb, var(--surface) 92%, #ffffff 8%);
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .kpi .lab{ font-size:12px; opacity:.85; }
    .kpi .val{ font-size:28px; font-weight:950; line-height:1.05; }
    .kpi .sub{ font-size:12px; opacity:.88; }

    table{
      width:100%;
      border-collapse:collapse;
      border:1px solid var(--border);
      border-radius:12px;
      overflow:hidden;
      background:var(--surface, var(--card));
    }
    th,td{ padding:10px; border-bottom:1px solid var(--border); font-size:12px; text-align:left; vertical-align:top; }
    th{ opacity:.85; background:color-mix(in srgb, var(--surface) 90%, #ffffff 10%); }
    tr:last-child td{ border-bottom:none; }

    .right{ text-align:right; }
    .muted{ opacity:.75; }
    .mono{ font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }

    .statusline{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-top:10px;
      font-size:12px;
      opacity:.92;
    }

    .split{ display:grid; grid-template-columns:1fr; gap:12px; }
    @media(min-width:720px){ .split{ grid-template-columns:1fr 1fr; } }

    .log{
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
      background:var(--surface, var(--card));
    }
    .log .lh{
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      font-weight:950;
      font-size:12px;
      opacity:.9;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .log .lb{
      padding:10px 12px;
      font-size:12px;
      max-height:160px;
      overflow:auto;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border:1px solid var(--border);
      border-radius:999px;
      padding:6px 10px;
      background:color-mix(in srgb, var(--surface) 92%, #ffffff 8%);
      font-weight:950;
      font-size:12px;
    }

    /* On-page error panel */
    .errorbox{
      border:1px solid #b02a2a;
      background: color-mix(in srgb, #b02a2a 14%, var(--surface) 86%);
      border-radius:14px;
      padding:10px 12px;
      font-size:12px;
      line-height:1.35;
      display:none;
      margin-top:12px;
      overflow:auto;
    }
    .errorbox b{ display:block; margin-bottom:6px; }
  </style>
</head>

<body>
  <div class="page">
    <div class="topbar">
      <h1>Dev • Weather Model</h1>
      <button id="btnLogout" class="btn" type="button">Logout</button>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <section class="card">
        <div class="card-h">
          <div>
            <p class="t">Inputs</p>
            <div class="muted" style="font-size:12px;">Mock by default. Switch to REAL once your function is live.</div>
          </div>
        </div>

        <div class="card-b">
          <div class="field">
            <label>Location (Divernon, IL default)</label>
            <div class="row">
              <div class="field" style="margin:0;">
                <label for="lat">Latitude</label>
                <input id="lat" type="number" step="0.000001" value="39.5656"/>
              </div>
              <div class="field" style="margin:0;">
                <label for="lon">Longitude</label>
                <input id="lon" type="number" step="0.000001" value="-89.6540"/>
              </div>
            </div>
          </div>

          <div class="field">
            <label for="soilWet">Soil Wetness (1–10)</label>
            <div class="slider-wrap">
              <input id="soilWet" type="range" min="1" max="10" step="1" value="6"/>
              <div class="pill" id="soilWetVal">6</div>
            </div>
          </div>

          <div class="field">
            <label for="drain">Drainage (1–10)</label>
            <div class="slider-wrap">
              <input id="drain" type="range" min="1" max="10" step="1" value="5"/>
              <div class="pill" id="drainVal">5</div>
            </div>
          </div>

          <div class="field">
            <label for="workable">Workable Threshold (0–100)</label>
            <div class="slider-wrap">
              <input id="workable" type="range" min="0" max="100" step="1" value="55"/>
              <div class="pill" id="workableVal">55</div>
            </div>
            <div class="muted" style="font-size:12px;">Workable means Wetness Index ≤ this value.</div>
          </div>

          <div class="field">
            <label for="apiBase">Weather API Base URL (your backend function)</label>
            <input id="apiBase" type="text" placeholder="https://YOUR-CLOUDRUN-URL (leave blank = mock)"/>
            <div class="muted" style="font-size:12px; margin-top:4px;">
              Must expose <span class="mono">GET /weather30?lat=..&lon=..</span>
            </div>
          </div>

          <div class="btnbar">
            <button id="btnRegen" class="btn" type="button">Regenerate Mock 30 Days</button>
            <button id="btnFetch" class="btn primary" type="button">Fetch Real 30 Days</button>
            <button id="btnRun" class="btn" type="button">Run Model</button>
          </div>

          <div class="statusline">
            <div id="dataMode" class="mono muted">Mode: MOCK</div>
            <div id="runStamp" class="mono muted"></div>
          </div>

          <div id="errBox" class="errorbox">
            <b>Page JS Error</b>
            <div class="mono" id="errText"></div>
          </div>

          <div style="height:12px"></div>

          <div class="split">
            <div class="card" style="border-radius:14px; box-shadow:none;">
              <div class="card-h" style="padding:12px; border-bottom:1px solid var(--border);">
                <p class="t" style="font-size:13px;">Feedback</p>
              </div>
              <div class="card-b" style="padding:12px;">
                <div class="field" style="margin-bottom:8px;">
                  <label for="tooWetAmt">How “too wet” right now? (0–100)</label>
                  <div class="slider-wrap">
                    <input id="tooWetAmt" type="range" min="0" max="100" step="1" value="20"/>
                    <div class="pill" id="tooWetAmtVal">20</div>
                  </div>
                </div>

                <div class="btnbar" style="margin-top:0;">
                  <button id="btnTooWet" class="btn danger" type="button">Mark TOO WET</button>
                  <button id="btnClearLog" class="btn" type="button">Clear Log</button>
                </div>

                <div style="height:10px"></div>
                <div class="note">
                  Saves feedback to <span class="mono">localStorage</span> (dev-only).
                  Later we’ll write this to Firestore and auto-calibrate.
                </div>
              </div>
            </div>

            <div class="card" style="border-radius:14px; box-shadow:none;">
              <div class="card-h" style="padding:12px; border-bottom:1px solid var(--border);">
                <p class="t" style="font-size:13px;">How the model works</p>
              </div>
              <div class="card-b" style="padding:12px;">
                <div class="note">
                  <b>Storage</b> is the internal water “tank” (0..Smax).<br/>
                  Each day: <span class="mono">storage += infilMult*rain − loss</span><br/>
                  loss = <span class="mono">dryPwr × 0.55 × dryMult × wetSlow</span><br/>
                  <b>dryPwr</b> is a 0..1 drying proxy from temp + solar + wind − humidity.<br/>
                  <b>Wetness Index</b> = <span class="mono">storage/Smax × 100</span>.<br/><br/>
                  Soil Wetness slider biases starting storage.<br/>
                  Drainage slider changes how much rain sticks + how fast it dries.
                </div>
              </div>
            </div>
          </div>

        </div>
      </section>

      <!-- RIGHT -->
      <section class="card">
        <div class="card-h">
          <div>
            <p class="t">Model Output</p>
            <div class="muted" style="font-size:12px;">Wetness Index (0–100) from last 30 days.</div>
          </div>
        </div>

        <div class="card-b">
          <div class="kpis">
            <div class="kpi">
              <div class="lab">Wetness Index (0–100)</div>
              <div class="val" id="wetIndex">—</div>
              <div class="sub" id="wetLabel">Run the model.</div>
            </div>

            <div class="kpi">
              <div class="lab">Workability</div>
              <div class="val" id="daysDry">—</div>
              <div class="sub" id="daysDrySub">Estimated days until workable (assumes no new rain).</div>
            </div>

            <div class="kpi">
              <div class="lab">30-Day Totals</div>
              <div class="val" id="rain30">—</div>
              <div class="sub" id="dry30">Drying power: —</div>
            </div>

            <div class="kpi">
              <div class="lab">Internal State</div>
              <div class="val" id="storageLine">—</div>
              <div class="sub" id="stateLine">—</div>
            </div>
          </div>

          <div style="height:12px"></div>

          <div class="log">
            <div class="lh">
              <span>Feedback Log (local)</span>
              <span class="tag" id="logCount">0</span>
            </div>
            <div class="lb" id="logBody">
              <span class="muted">No feedback yet.</span>
            </div>
          </div>

          <div style="height:12px"></div>

          <table aria-label="Last 30 days weather">
            <thead>
              <tr>
                <th style="width:120px;">Date</th>
                <th class="right">Rain (in)</th>
                <th class="right">Temp (°F)</th>
                <th class="right">Wind (mph)</th>
                <th class="right">RH (%)</th>
                <th class="right">Solar (W/m²)</th>
                <th class="right">Dry</th>
              </tr>
            </thead>
            <tbody id="wxRows">
              <tr><td colspan="7" class="muted">Waiting for JS…</td></tr>
            </tbody>
          </table>

          <div style="height:10px"></div>
          <div class="muted" style="font-size:12px;">
            If you still see “Waiting for JS…”, your browser is serving an older cached file or the script threw an error (shown above).
          </div>
        </div>
      </section>
    </div>
  </div>

<script>
(function(){
  'use strict';

  const $ = (id)=> document.getElementById(id);
  const clamp = (v, lo, hi)=> Math.max(lo, Math.min(hi, v));
  const round = (v, d=2)=> {
    const p = Math.pow(10,d);
    return Math.round(v*p)/p;
  };

  // -------- On-page error reporting --------
  function showErr(msg){
    const box = $('errBox');
    const text = $('errText');
    if (!box || !text) return;
    text.textContent = String(msg || 'Unknown error');
    box.style.display = 'block';
  }
  window.addEventListener('error', (e)=>{
    try{
      const m = (e && e.message) ? e.message : 'Script error';
      const at = (e && e.filename) ? (' @ ' + e.filename + ':' + (e.lineno||'?')) : '';
      showErr(m + at);
    }catch(_){}
  });
  window.addEventListener('unhandledrejection', (e)=>{
    try{
      showErr('Unhandled promise rejection: ' + String(e && e.reason ? e.reason : e));
    }catch(_){}
  });

  const LS_LOG_KEY = 'FV_DEV_WETNESS_FEEDBACK_LOG_V1';

  const state = { weather30: [], seed: Date.now() % 1000000, mode: 'MOCK', lastRun: null };

  function seededRand(){
    state.seed = (state.seed * 1664525 + 1013904223) % 4294967296;
    return state.seed / 4294967296;
  }

  function genMock30(){
    const out = [];
    const today = new Date();
    today.setHours(12,0,0,0);

    for (let i=29; i>=0; i--){
      const d = new Date(today);
      d.setDate(d.getDate() - i);

      const eventRoll = seededRand();
      let rain = 0;
      if (eventRoll > 0.82) rain = 0.10 + seededRand()*1.10;
      else if (eventRoll > 0.72) rain = 0.02 + seededRand()*0.16;

      const wave = Math.sin((29-i)/6) * 6;
      const temp = 34 + wave + (seededRand()*10 - 5);
      const wind = 4 + seededRand()*18;

      let rh = 45 + seededRand()*45;
      if (rain > 0) rh = clamp(rh + 10 + seededRand()*10, 35, 98);

      let solar = 120 + seededRand()*220;
      if (rain > 0) solar = clamp(solar - 60 - seededRand()*80, 40, 360);

      out.push({
        dateISO: d.toISOString().slice(0,10),
        rainIn: round(rain, 2),
        tempF: Math.round(temp),
        windMph: Math.round(wind),
        rh: Math.round(rh),
        solarWm2: Math.round(solar),
      });
    }

    state.weather30 = out;
    state.mode = 'MOCK';
    $('dataMode').textContent = 'Mode: MOCK';
  }

  function computeDryPwr(r){
    const temp = Number(r.tempF||0);
    const wind = Number(r.windMph||0);
    const rh   = Number(r.rh||0);
    const solar= Number(r.solarWm2||0);

    const tempN = clamp((temp - 20) / 45, 0, 1);
    const windN = clamp((wind - 2) / 20, 0, 1);
    const solarN= clamp((solar - 60) / 300, 0, 1);
    const rhN   = clamp((rh - 35) / 65, 0, 1);

    return clamp((0.35*tempN + 0.30*solarN + 0.25*windN - 0.25*rhN), 0, 1);
  }

  function withDryPwr(rows){
    return (rows||[]).map(r=>{
      const dryPwr = computeDryPwr(r);
      return { ...r, dryPwr: round(dryPwr, 2) };
    });
  }

  function runModel(){
    if (!state.weather30.length) return null;

    const soilWet = Number($('soilWet').value);
    const drain   = Number($('drain').value);

    const baseWetBias = (soilWet - 1) / 9; // 0..1
    const drainage    = (drain - 1) / 9;   // 0..1

    const Smax = 4.0;

    // Start point: slider baseline + small nudge from first 7 days rain
    const rows0 = withDryPwr(state.weather30);
    const first7 = rows0.slice(0, 7);
    const first7Rain = first7.reduce((s,x)=> s + Number(x.rainIn||0), 0);
    const rainNudge = clamp(first7Rain / 4.0, 0, 1) * 0.35;

    let storage = (0.8 + baseWetBias * 2.8) + rainNudge;

    const infilMult = 1.00 - (drainage * 0.35);
    const dryMult   = 0.65 + (drainage * 0.50);
    const wetSlow   = 1.00 - baseWetBias * 0.10;

    let rainSum = 0;
    let drySum = 0;
    let last7Loss = [];

    for (const day of rows0){
      const rain = Number(day.rainIn||0);
      const dry  = Number(day.dryPwr||0);

      rainSum += rain;
      drySum  += dry;

      const add  = (rain * infilMult);
      const loss = (dry * 0.55 * dryMult * wetSlow);

      storage += add;
      storage -= loss;

      storage = clamp(storage, 0, Smax);

      last7Loss.push(loss);
      if (last7Loss.length > 7) last7Loss.shift();
    }

    const wetIdx = clamp((storage / Smax) * 100, 0, 100);
    const wetIdxR = Math.round(wetIdx);

    const avgLoss7 = last7Loss.length
      ? (last7Loss.reduce((s,x)=>s+x,0) / last7Loss.length)
      : 0.12;

    const label =
      wetIdxR >= 75 ? 'Very wet' :
      wetIdxR >= 55 ? 'Wet' :
      wetIdxR >= 35 ? 'Moderate' :
      wetIdxR >= 20 ? 'Drying' : 'Dry';

    const run = {
      rows: rows0,
      soilWet, drain,
      Smax, storage,
      infilMult, dryMult, wetSlow,
      wetIdx, wetIdxR, label,
      rainSum, drySum,
      avgLoss7,
      rainNudge
    };

    state.lastRun = run;
    return run;
  }

  function estimateDaysUntilWorkable(run){
    const thr = Number($('workable').value);
    if (!run) return { days: null, note: 'Run the model.' };

    if (run.wetIdxR <= thr){
      return { days: 0, note: 'Already workable at current threshold.' };
    }

    const targetStorage = clamp((thr / 100) * run.Smax, 0, run.Smax);
    const delta = run.storage - targetStorage;

    const dailyLoss = Math.max(0.03, run.avgLoss7);
    const days = Math.ceil(delta / dailyLoss);

    return {
      days: clamp(days, 0, 60),
      note: `Assuming no new rain. Last-7 avg drying loss ≈ ${round(dailyLoss,2)} storage/day.`
    };
  }

  function loadLog(){
    try{
      const raw = localStorage.getItem(LS_LOG_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    }catch(e){ return []; }
  }
  function saveLog(arr){
    try{ localStorage.setItem(LS_LOG_KEY, JSON.stringify(arr)); }catch(e){}
  }
  function renderLog(){
    const log = loadLog();
    $('logCount').textContent = String(log.length);
    const box = $('logBody');

    if (!log.length){
      box.innerHTML = '<span class="muted">No feedback yet.</span>';
      return;
    }

    const lines = log.slice().reverse().slice(0, 30).map(x=>{
      const when = new Date(x.ts).toLocaleString();
      return `<div style="margin-bottom:8px;">
        <span class="mono">${when}</span><br/>
        <b>${x.kind}</b> • tooWet=${x.amount} • wetIdx=${x.wetIdx} • soil=${x.soilWet} • drain=${x.drain} • mode=${x.mode}
      </div>`;
    });

    box.innerHTML = lines.join('') + (log.length > 30 ? '<div class="muted">…(showing last 30)</div>' : '');
  }

  function renderTable(rows){
    const tb = $('wxRows');
    tb.innerHTML = '';
    if (!rows || !rows.length){
      tb.innerHTML = '<tr><td colspan="7" class="muted">No data yet.</td></tr>';
      return;
    }
    for (const r of rows){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="mono">${r.dateISO}</td>
        <td class="right mono">${Number(r.rainIn||0).toFixed(2)}</td>
        <td class="right mono">${Math.round(Number(r.tempF||0))}</td>
        <td class="right mono">${Math.round(Number(r.windMph||0))}</td>
        <td class="right mono">${Math.round(Number(r.rh||0))}</td>
        <td class="right mono">${Math.round(Number(r.solarWm2||0))}</td>
        <td class="right mono">${Number(r.dryPwr||0).toFixed(2)}</td>
      `;
      tb.appendChild(tr);
    }
  }

  function refreshAll(){
    const run = runModel();
    if (!run) return;

    $('wetIndex').textContent = String(run.wetIdxR);
    $('rain30').textContent   = round(run.rainSum, 2) + ' in';
    $('dry30').textContent    = 'Drying power: ' + round(run.drySum, 1);

    $('storageLine').textContent = `${round(run.storage,2)} / ${run.Smax} storage`;
    $('stateLine').textContent = `infil=${round(run.infilMult,2)} • dry=${round(run.dryMult,2)} • wetSlow=${round(run.wetSlow,2)} • startNudge=${round(run.rainNudge,2)}`;

    $('wetLabel').textContent = `${run.label} • storage is the internal “water tank” (rain adds, drying removes).`;

    const est = estimateDaysUntilWorkable(run);
    $('daysDry').textContent = (est.days === null) ? '—' : (est.days === 0 ? '0 days' : `${est.days} days`);
    $('daysDrySub').textContent = est.note;

    $('runStamp').textContent = new Date().toLocaleString();

    renderTable(run.rows);
    renderLog();
  }

  async function fetchReal30(){
    const base = String($('apiBase').value || '').trim().replace(/\/+$/,'');
    if (!base){
      alert('Add your Weather API Base URL first (e.g. https://your-cloudrun-url).');
      return;
    }

    const lat = String($('lat').value || '').trim();
    const lon = String($('lon').value || '').trim();
    if (!lat || !lon){
      alert('Enter lat/lon first.');
      return;
    }

    $('btnFetch').disabled = true;
    $('btnFetch').textContent = 'Fetching…';

    try{
      const url = `${base}/weather30?lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}`;
      const res = await fetch(url, { method:'GET' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      const days = Array.isArray(data.days) ? data.days : [];

      if (days.length < 20) throw new Error('Response missing days[] (or too few rows).');

      state.weather30 = days.map(d=>({
        dateISO: String(d.dateISO||'').slice(0,10),
        rainIn: Number(d.rainIn||0),
        tempF: Number(d.tempF||0),
        windMph: Number(d.windMph||0),
        rh: Number(d.rh||0),
        solarWm2: Number(d.solarWm2||0),
      })).filter(x=>x.dateISO);

      state.mode = 'REAL';
      $('dataMode').textContent = 'Mode: REAL';
      refreshAll();
    }catch(err){
      console.error(err);
      alert('Fetch failed. Keeping MOCK data.\n\n' + String(err && err.message ? err.message : err));
    }finally{
      $('btnFetch').disabled = false;
      $('btnFetch').textContent = 'Fetch Real 30 Days';
    }
  }

  function addTooWetFeedback(){
    const run = state.lastRun || runModel();
    if (!run){
      alert('Run the model first.');
      return;
    }

    const amt = Number($('tooWetAmt').value);
    const lat = Number($('lat').value);
    const lon = Number($('lon').value);

    const item = {
      ts: Date.now(),
      kind: 'TOO_WET',
      amount: clamp(Math.round(amt), 0, 100),
      wetIdx: run.wetIdxR,
      soilWet: run.soilWet,
      drain: run.drain,
      lat: isFinite(lat) ? lat : null,
      lon: isFinite(lon) ? lon : null,
      mode: state.mode,
    };

    const log = loadLog();
    log.push(item);
    saveLog(log);
    renderLog();

    alert('Saved feedback (local).');
  }

  function clearLog(){
    saveLog([]);
    renderLog();
  }

  function syncSliderLabels(){
    $('soilWetVal').textContent = $('soilWet').value;
    $('drainVal').textContent   = $('drain').value;
    $('workableVal').textContent = $('workable').value;
    $('tooWetAmtVal').textContent = $('tooWetAmt').value;
  }

  // UI events
  $('soilWet').addEventListener('input', ()=>{ syncSliderLabels(); refreshAll(); });
  $('drain').addEventListener('input',   ()=>{ syncSliderLabels(); refreshAll(); });
  $('workable').addEventListener('input',()=>{ syncSliderLabels(); refreshAll(); });
  $('tooWetAmt').addEventListener('input',()=>{ syncSliderLabels(); });

  $('btnRegen').addEventListener('click', ()=>{
    state.seed = Date.now() % 1000000;
    genMock30();
    refreshAll();
  });

  $('btnFetch').addEventListener('click', fetchReal30);
  $('btnRun').addEventListener('click', refreshAll);

  $('btnTooWet').addEventListener('click', addTooWetFeedback);
  $('btnClearLog').addEventListener('click', clearLog);

  $('btnLogout').addEventListener('click', ()=>{
    try{
      if (window.FV && typeof window.FV.logout === 'function'){ window.FV.logout(); return; }
    }catch(e){}
    location.href = '/Farm-vista/auth/';
  });

  // Init (GUARANTEED mock load)
  syncSliderLabels();
  genMock30();
  refreshAll();

})();
</script>
</body>
</html>