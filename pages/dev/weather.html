<!-- =====================================================================
/Farm-vista/pages/dev/weather.html  (FULL FILE)
Rev: 2025-12-20b
Dev Wetness Model (Mock + Real API Switch)
- Default: Divernon, IL
- Two sliders: Soil Wetness (1–10) + Drainage (1–10)
- Mock 30-day daily weather generator for UI testing
- Optional: Fetch real weather from your backend function:
    Weather API Base URL = https://YOUR-SERVICE
    Endpoint required: GET {base}/weather30?lat=..&lon=..
    Response shape: { days:[{dateISO,rainIn,tempF,windMph,rh,solarWm2}], meta?:{...} }
===================================================================== -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista • Dev • Weather Model</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <script src="/Farm-vista/js/theme-boot.js"></script>

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>

  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <script src="/Farm-vista/js/core.js"></script>

  <style>
    :root{ --card-max:1100px; --page-bottom-gap:72px; --accent:#2F6C3C; }

    .page{
      max-width:var(--card-max);
      margin:0 auto;
      padding:clamp(14px,3vw,22px);
      padding-bottom:calc(var(--page-bottom-gap) + env(safe-area-inset-bottom,0px));
    }
    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:14px; }
    .topbar h1{ font-size:18px; margin:0; letter-spacing:.2px; }

    a,a:visited,a:hover,a:active{ color:var(--text); text-decoration:none; }

    .grid{ display:grid; grid-template-columns:1fr; gap:14px; }
    @media(min-width:920px){ .grid{ grid-template-columns:440px 1fr; } }

    .card{
      background:var(--card, var(--surface));
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.08);
      overflow:hidden;
    }
    .card-h{ padding:14px 14px 10px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; gap:12px; }
    .card-h .t{ margin:0; font-size:15px; font-weight:800; }
    .card-b{ padding:14px; }

    .field{ display:flex; flex-direction:column; gap:6px; margin-bottom:12px; }
    label{ font-size:12px; opacity:.9; }
    input[type="text"], input[type="number"]{
      width:100%; padding:10px 12px; border-radius:12px;
      border:1px solid var(--border);
      background:var(--surface, var(--card));
      color:var(--text);
      outline:none;
    }

    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .row > *{ flex:1 1 auto; }

    .slider-wrap{ display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center; margin:6px 0 14px; }
    input[type="range"]{ width:100%; accent-color:var(--brand,#3B7E46); }
    .pill{
      display:inline-flex; align-items:center; justify-content:center;
      min-width:58px; height:34px; padding:0 10px;
      border-radius:999px; border:1px solid var(--border);
      background:color-mix(in srgb, var(--surface) 88%, #ffffff 12%);
      font-weight:800;
    }

    .btnbar{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .btn{
      border:1px solid var(--border);
      background:var(--surface, var(--card));
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-weight:800;
      cursor:pointer;
      user-select:none;
    }
    .btn:active{ transform:translateY(1px); }
    .btn.primary{ background:var(--brand,#3B7E46); border-color:transparent; color:#fff !important; }

    .note{
      border:1px dashed var(--border);
      border-radius:14px;
      padding:10px 12px;
      background:color-mix(in srgb, var(--surface) 92%, #ffffff 8%);
      font-size:12px;
      opacity:.92;
      line-height:1.35;
    }

    .kpis{ display:grid; grid-template-columns:1fr; gap:12px; }
    @media(min-width:720px){ .kpis{ grid-template-columns:1fr 1fr; } }
    .kpi{
      border:1px solid var(--border);
      border-radius:16px;
      background:color-mix(in srgb, var(--surface) 92%, #ffffff 8%);
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .kpi .lab{ font-size:12px; opacity:.85; }
    .kpi .val{ font-size:28px; font-weight:900; line-height:1.05; }
    .kpi .sub{ font-size:12px; opacity:.85; }

    table{
      width:100%;
      border-collapse:collapse;
      border:1px solid var(--border);
      border-radius:12px;
      overflow:hidden;
      background:var(--surface, var(--card));
    }
    th,td{ padding:10px; border-bottom:1px solid var(--border); font-size:12px; text-align:left; vertical-align:top; }
    th{ opacity:.85; background:color-mix(in srgb, var(--surface) 90%, #ffffff 10%); }
    tr:last-child td{ border-bottom:none; }

    .right{ text-align:right; }
    .muted{ opacity:.75; }
    .mono{ font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }

    .statusline{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-top:10px;
      font-size:12px;
      opacity:.9;
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="topbar">
      <h1>Dev • Weather Model</h1>
      <button id="btnLogout" class="btn" type="button">Logout</button>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <section class="card">
        <div class="card-h">
          <div>
            <p class="t">Inputs</p>
            <div class="muted" style="font-size:12px;">Mock by default. Switch to real weather once your function is live.</div>
          </div>
        </div>

        <div class="card-b">
          <div class="field">
            <label>Location (Divernon, IL default)</label>
            <div class="row">
              <div class="field" style="margin:0;">
                <label for="lat">Latitude</label>
                <input id="lat" type="number" step="0.000001" value="39.5656"/>
              </div>
              <div class="field" style="margin:0;">
                <label for="lon">Longitude</label>
                <input id="lon" type="number" step="0.000001" value="-89.6540"/>
              </div>
            </div>
          </div>

          <div class="field">
            <label for="soilWet">Soil Wetness (1–10)</label>
            <div class="slider-wrap">
              <input id="soilWet" type="range" min="1" max="10" step="1" value="6"/>
              <div class="pill" id="soilWetVal">6</div>
            </div>
          </div>

          <div class="field">
            <label for="drain">Drainage (1–10)</label>
            <div class="slider-wrap">
              <input id="drain" type="range" min="1" max="10" step="1" value="5"/>
              <div class="pill" id="drainVal">5</div>
            </div>
          </div>

          <div class="field">
            <label for="apiBase">Weather API Base URL (your backend function)</label>
            <input id="apiBase" type="text" placeholder="https://YOUR-CLOUDRUN-URL (leave blank = mock)"/>
            <div class="muted" style="font-size:12px; margin-top:4px;">
              Must expose <span class="mono">GET /weather30?lat=..&lon=..</span>
            </div>
          </div>

          <div class="btnbar">
            <button id="btnRegen" class="btn" type="button">Regenerate Mock 30 Days</button>
            <button id="btnFetch" class="btn primary" type="button">Fetch Real 30 Days</button>
            <button id="btnRun" class="btn" type="button">Run Model</button>
          </div>

          <div class="statusline">
            <div id="dataMode" class="mono muted">Mode: MOCK</div>
            <div id="runStamp" class="mono muted"></div>
          </div>

          <div style="height:10px"></div>

          <div class="note">
            <b>How this dev model works:</b><br/>
            We build a daily water “storage” score from rain minus drying power (temp + wind + RH + solar).
            Your Soil Wetness & Drainage sliders bias the storage behavior.
          </div>
        </div>
      </section>

      <!-- RIGHT -->
      <section class="card">
        <div class="card-h">
          <div>
            <p class="t">Model Output</p>
            <div class="muted" style="font-size:12px;">Wetness Index (0–100) from last 30 days.</div>
          </div>
        </div>

        <div class="card-b">
          <div class="kpis">
            <div class="kpi">
              <div class="lab">Wetness Index (0–100)</div>
              <div class="val" id="wetIndex">—</div>
              <div class="sub" id="wetLabel">Run the model.</div>
            </div>

            <div class="kpi">
              <div class="lab">30-Day Totals</div>
              <div class="val" id="rain30">—</div>
              <div class="sub" id="dry30">Drying power: —</div>
            </div>
          </div>

          <div style="height:12px"></div>

          <table aria-label="Last 30 days weather">
            <thead>
              <tr>
                <th style="width:120px;">Date</th>
                <th class="right">Rain (in)</th>
                <th class="right">Temp (°F)</th>
                <th class="right">Wind (mph)</th>
                <th class="right">RH (%)</th>
                <th class="right">Solar (W/m²)</th>
                <th class="right">Dry</th>
              </tr>
            </thead>
            <tbody id="wxRows">
              <tr><td colspan="7" class="muted">No data yet.</td></tr>
            </tbody>
          </table>

          <div style="height:10px"></div>
          <div class="muted" style="font-size:12px;">
            “Dry” is a normalized 0–1 proxy (higher = dries faster). This stays the same whether data is mock or real.
          </div>
        </div>
      </section>
    </div>
  </div>

<script>
(function(){
  'use strict';

  const $ = (id)=> document.getElementById(id);
  const clamp = (v, lo, hi)=> Math.max(lo, Math.min(hi, v));
  const round = (v, d=2)=> {
    const p = Math.pow(10,d);
    return Math.round(v*p)/p;
  };

  const state = { weather30: [], seed: Date.now() % 1000000, mode: 'MOCK' };

  // ---------- Mock weather generator ----------
  function seededRand(){
    state.seed = (state.seed * 1664525 + 1013904223) % 4294967296;
    return state.seed / 4294967296;
  }

  function genMock30(){
    const out = [];
    const today = new Date();
    today.setHours(12,0,0,0);

    for (let i=29; i>=0; i--){
      const d = new Date(today);
      d.setDate(d.getDate() - i);

      const eventRoll = seededRand();
      let rain = 0;
      if (eventRoll > 0.82) rain = 0.10 + seededRand()*1.10;
      else if (eventRoll > 0.72) rain = 0.02 + seededRand()*0.16;

      const wave = Math.sin((29-i)/6) * 6;
      const temp = 34 + wave + (seededRand()*10 - 5);
      const wind = 4 + seededRand()*18;

      let rh = 45 + seededRand()*45;
      if (rain > 0) rh = clamp(rh + 10 + seededRand()*10, 35, 98);

      let solar = 120 + seededRand()*220;
      if (rain > 0) solar = clamp(solar - 60 - seededRand()*80, 40, 360);

      out.push({
        dateISO: d.toISOString().slice(0,10),
        rainIn: round(rain, 2),
        tempF: Math.round(temp),
        windMph: Math.round(wind),
        rh: Math.round(rh),
        solarWm2: Math.round(solar),
      });
    }

    state.weather30 = out;
    state.mode = 'MOCK';
    $('dataMode').textContent = 'Mode: MOCK';
  }

  // ---------- Derived: drying power ----------
  function withDryPwr(rows){
    return (rows||[]).map(r=>{
      const temp = Number(r.tempF||0);
      const wind = Number(r.windMph||0);
      const rh   = Number(r.rh||0);
      const solar= Number(r.solarWm2||0);

      const tempN = clamp((temp - 20) / 45, 0, 1);
      const windN = clamp((wind - 2) / 20, 0, 1);
      const solarN= clamp((solar - 60) / 300, 0, 1);
      const rhN   = clamp((rh - 35) / 65, 0, 1);

      const dryPwr = clamp((0.35*tempN + 0.30*solarN + 0.25*windN - 0.25*rhN), 0, 1);

      return { ...r, dryPwr: round(dryPwr, 2) };
    });
  }

  // ---------- Model ----------
  function runModel(){
    if (!state.weather30.length) return;

    const soilWet = Number($('soilWet').value);
    const drain   = Number($('drain').value);

    const baseWetBias = (soilWet - 1) / 9; // 0..1
    const drainage    = (drain - 1) / 9;   // 0..1

    const Smax = 4.0;
    let storage = 0.8 + baseWetBias * 2.8;

    const infilMult = 1.00 - (drainage * 0.35);
    const dryMult   = 0.65 + (drainage * 0.50);
    const wetSlow   = 1.00 - baseWetBias * 0.10;

    let rainSum = 0;
    let drySum = 0;

    const rows = withDryPwr(state.weather30);
    for (const day of rows){
      const rain = Number(day.rainIn||0);
      const dry  = Number(day.dryPwr||0);

      rainSum += rain;
      drySum  += dry;

      storage += (rain * infilMult);
      storage -= (dry * 0.55 * dryMult * wetSlow);

      storage = clamp(storage, 0, Smax);
    }

    const wetIdx = clamp((storage / Smax) * 100, 0, 100);
    const wetIdxR = Math.round(wetIdx);

    $('wetIndex').textContent = String(wetIdxR);
    $('rain30').textContent   = round(rainSum, 2) + ' in';
    $('dry30').textContent    = 'Drying power: ' + round(drySum, 1);

    const label =
      wetIdxR >= 75 ? 'Very wet' :
      wetIdxR >= 55 ? 'Wet' :
      wetIdxR >= 35 ? 'Moderate' :
      wetIdxR >= 20 ? 'Drying' : 'Dry';

    $('wetLabel').textContent =
      `${label} • Storage=${round(storage,2)} / ${Smax} in (infil=${round(infilMult,2)}, dry=${round(dryMult,2)})`;

    $('runStamp').textContent = new Date().toLocaleString();
    renderTable();
  }

  // ---------- Render ----------
  function renderTable(){
    const tb = $('wxRows');
    const rows = withDryPwr(state.weather30);
    tb.innerHTML = '';
    if (!rows.length){
      tb.innerHTML = '<tr><td colspan="7" class="muted">No data yet.</td></tr>';
      return;
    }
    for (const r of rows){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="mono">${r.dateISO}</td>
        <td class="right mono">${Number(r.rainIn||0).toFixed(2)}</td>
        <td class="right mono">${Math.round(Number(r.tempF||0))}</td>
        <td class="right mono">${Math.round(Number(r.windMph||0))}</td>
        <td class="right mono">${Math.round(Number(r.rh||0))}</td>
        <td class="right mono">${Math.round(Number(r.solarWm2||0))}</td>
        <td class="right mono">${Number(r.dryPwr||0).toFixed(2)}</td>
      `;
      tb.appendChild(tr);
    }
  }

  // ---------- Fetch real 30 days (your backend) ----------
  async function fetchReal30(){
    const base = String($('apiBase').value || '').trim().replace(/\/+$/,'');
    if (!base){
      alert('Add your Weather API Base URL first (e.g. https://your-cloudrun-url).');
      return;
    }

    const lat = String($('lat').value || '').trim();
    const lon = String($('lon').value || '').trim();
    if (!lat || !lon){
      alert('Enter lat/lon first.');
      return;
    }

    $('btnFetch').disabled = true;
    $('btnFetch').textContent = 'Fetching…';

    try{
      const url = `${base}/weather30?lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}`;
      const res = await fetch(url, { method:'GET' });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      const days = Array.isArray(data.days) ? data.days : [];

      if (days.length < 20) throw new Error('Response missing days[] (or too few rows).');

      // Normalize
      state.weather30 = days.map(d=>({
        dateISO: String(d.dateISO||'').slice(0,10),
        rainIn: Number(d.rainIn||0),
        tempF: Number(d.tempF||0),
        windMph: Number(d.windMph||0),
        rh: Number(d.rh||0),
        solarWm2: Number(d.solarWm2||0),
      })).filter(x=>x.dateISO);

      state.mode = 'REAL';
      $('dataMode').textContent = 'Mode: REAL';
      runModel();
    }catch(err){
      console.error(err);
      alert('Fetch failed. Keeping MOCK data.\n\n' + String(err && err.message ? err.message : err));
    }finally{
      $('btnFetch').disabled = false;
      $('btnFetch').textContent = 'Fetch Real 30 Days';
    }
  }

  function syncSliderLabels(){
    $('soilWetVal').textContent = $('soilWet').value;
    $('drainVal').textContent   = $('drain').value;
  }

  // UI
  $('soilWet').addEventListener('input', ()=>{ syncSliderLabels(); runModel(); });
  $('drain').addEventListener('input',   ()=>{ syncSliderLabels(); runModel(); });

  $('btnRegen').addEventListener('click', ()=>{
    state.seed = Date.now() % 1000000;
    genMock30();
    runModel();
  });

  $('btnFetch').addEventListener('click', fetchReal30);
  $('btnRun').addEventListener('click', runModel);

  $('btnLogout').addEventListener('click', ()=>{
    try{
      if (window.FV && typeof window.FV.logout === 'function'){ window.FV.logout(); return; }
    }catch(e){}
    location.href = '/Farm-vista/auth/';
  });

  // Init
  syncSliderLabels();
  genMock30();
  runModel();
})();
</script>
</body>
</html>