<!-- =====================================================================
/Farm-vista/pages/dev/weather.html  (FULL FILE)
Rev: 2025-12-21e

DEV PAGE (per your last request)

✅ PRIMARY WORDING/UI = READINESS
   - Readiness 0..100: 0 = WET (red) … 100 = READY (green)
   - Internally we still compute Wetness = 100 - Readiness (for math consistency)

✅ Operation dropdown is ALWAYS on top (not hidden under mock fields card)

✅ Mock Fields tiles:
   - show READINESS bar (red-left → green-right) + marker line
   - if tile is NOT READY, show:
       - "Est: ~X hours" if <= 48
       - else: "Estimated to be greater then 2 days"

✅ Adjust button per-field:
   - opens modal "Adjust" with Wet / Dry
   - uses your threshold gating:
       If model says READY (Readiness >= threshold):
          - show Wet enabled, Dry disabled
       If model says WET (Readiness < threshold):
          - show Dry enabled, Wet disabled
   (prevents users from “agree clicking” and messing up learning)

✅ Uses your CURRENT LIVE FUNCTION by default (24h lookback + 48h forecast):
   https://farmvista-weather-300398089669.us-central1.run.app?lat=..&lon=..
   Response expected:
     { days30:[...], forecast48:[...], meta:{...}, sourceMode, lookbackHoursUsed, ... }

✅ NO SOLAR
   - We compute DryPwr from temp + wind - humidity only
   - We still display the full math tables so you can inspect everything

✅ FULL MATH TRANSPARENCY:
   1) Slider → normalized → multipliers → Smax
   2) DryPwr breakdown (tempN/windN/rhN/raw/dryPwr)
   3) 30-day daily tank trace (before/add/loss/after/clamp)
   4) 48-hour forecast simulation trace (hourly) to compute ETA within 48

===================================================================== -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista • Dev • Readiness Model</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <script src="/Farm-vista/js/theme-boot.js"></script>

  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>

  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <script src="/Farm-vista/js/core.js"></script>

  <style>
    :root{
      --card-max:1200px;
      --page-bottom-gap:72px;
    }

    .page{
      max-width:var(--card-max);
      margin:0 auto;
      padding:clamp(14px,3vw,22px);
      padding-bottom:calc(var(--page-bottom-gap) + env(safe-area-inset-bottom,0px));
    }

    .topbar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin-bottom:12px;
    }
    .topbar h1{ font-size:18px; margin:0; letter-spacing:.2px; }
    a,a:visited,a:hover,a:active{ color:var(--text); text-decoration:none; }

    .card{
      background:var(--card, var(--surface));
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.08);
      overflow:hidden;
    }
    .card-h{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      gap:12px;
      align-items:flex-start;
    }
    .card-h .t{ margin:0; font-size:15px; font-weight:950; }
    .card-b{ padding:14px; }

    /* Operation card MUST overlay others */
    .opCard{ position:relative; z-index:9999; overflow:visible; }
    .opCard .card-b{ overflow:visible; }
    .opCard select{ position:relative; z-index:10000; }

    .grid{ display:grid; grid-template-columns:1fr; gap:14px; }
    @media(min-width:980px){ .grid{ grid-template-columns:480px 1fr; } }

    .field{ display:flex; flex-direction:column; gap:6px; margin-bottom:12px; }
    label{ font-size:12px; opacity:.9; }

    input[type="text"], input[type="number"], select{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--surface, var(--card));
      color:var(--text);
      outline:none;
      appearance:none;
    }

    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .row > *{ flex:1 1 auto; }

    .slider-wrap{
      display:grid;
      grid-template-columns:1fr auto;
      gap:10px;
      align-items:center;
      margin:6px 0 14px;
    }
    input[type="range"]{ width:100%; accent-color:var(--brand,#3B7E46); }

    .pill{
      display:inline-flex; align-items:center; justify-content:center;
      min-width:58px; height:34px; padding:0 10px;
      border-radius:999px; border:1px solid var(--border);
      background:color-mix(in srgb, var(--surface) 88%, #ffffff 12%);
      font-weight:950;
    }

    .btnbar{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .btn{
      border:1px solid var(--border);
      background:var(--surface, var(--card));
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      font-weight:950;
      cursor:pointer;
      user-select:none;
    }
    .btn:active{ transform:translateY(1px); }
    .btn.primary{ background:var(--brand,#3B7E46); border-color:transparent; color:#fff !important; }
    .btn.danger{ background:#b02a2a; border-color:transparent; color:#fff !important; }
    .btn[disabled]{ opacity:.55; cursor:not-allowed; }

    .statusline{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-top:10px;
      font-size:12px;
      opacity:.92;
    }
    .muted{ opacity:.75; }
    .mono{ font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }

    .kpis{ display:grid; grid-template-columns:1fr; gap:12px; }
    @media(min-width:720px){ .kpis{ grid-template-columns:1fr 1fr; } }
    .kpi{
      border:1px solid var(--border);
      border-radius:16px;
      background:color-mix(in srgb, var(--surface) 92%, #ffffff 8%);
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .kpi .lab{ font-size:12px; opacity:.85; }
    .kpi .val{ font-size:28px; font-weight:950; line-height:1.05; }
    .kpi .sub{ font-size:12px; opacity:.88; }

    table{
      width:100%;
      border-collapse:collapse;
      border:1px solid var(--border);
      border-radius:12px;
      overflow:hidden;
      background:var(--surface, var(--card));
    }
    th,td{
      padding:10px;
      border-bottom:1px solid var(--border);
      font-size:12px;
      text-align:left;
      vertical-align:top;
    }
    th{
      opacity:.85;
      background:color-mix(in srgb, var(--surface) 90%, #ffffff 10%);
      font-weight:950;
    }
    tr:last-child td{ border-bottom:none; }
    .right{ text-align:right; }

    .note{
      border:1px dashed var(--border);
      border-radius:14px;
      padding:10px 12px;
      background:color-mix(in srgb, var(--surface) 92%, #ffffff 8%);
      font-size:12px;
      opacity:.95;
      line-height:1.35;
    }

    .errorbox{
      border:1px solid #b02a2a;
      background: color-mix(in srgb, #b02a2a 14%, var(--surface) 86%);
      border-radius:14px;
      padding:10px 12px;
      font-size:12px;
      line-height:1.35;
      display:none;
      margin-top:12px;
      overflow:auto;
    }
    .errorbox b{ display:block; margin-bottom:6px; }

    /* Mock fields hero */
    .fieldsGrid{
      display:grid;
      grid-template-columns:1fr;
      gap:12px;
    }
    @media(min-width:860px){
      .fieldsGrid{ grid-template-columns:1fr 1fr 1fr; }
    }
    .fieldTile{
      border:1px solid var(--border);
      border-radius:16px;
      background:color-mix(in srgb, var(--surface) 92%, #ffffff 8%);
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .fieldTitle{ font-weight:950; font-size:13px; line-height:1.2; }
    .fieldSub{ font-size:12px; opacity:.85; margin-top:2px; }

    .gaugeWrap{ display:flex; flex-direction:column; gap:6px; }
    .gauge{
      position:relative;
      height:12px;
      border-radius:999px;
      border:1px solid var(--border);
      overflow:hidden;
      /* READINESS bar: red(left) -> green(right) */
      background: linear-gradient(90deg, #c83b3b 0%, #d8b23b 55%, #2f8f4b 100%);
    }
    .marker{
      position:absolute;
      top:-6px;
      width:2px;
      height:24px;
      background:#ffffff;
      box-shadow:0 0 0 1px rgba(0,0,0,.35);
      border-radius:2px;
      transform: translateX(-1px);
    }
    .gaugeLabels{
      display:flex;
      justify-content:space-between;
      font-size:11px;
      opacity:.85;
    }
    .gaugeRow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      font-size:12px;
      opacity:.95;
    }
    .tileBtnRow{ display:flex; gap:8px; flex-wrap:wrap; }
    .miniBtn{
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--border);
      background:transparent;
      color:var(--text);
      font-weight:950;
      cursor:pointer;
    }
    .miniBtn.active{
      background: color-mix(in srgb, var(--surface) 86%, #ffffff 14%);
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:color-mix(in srgb, var(--surface) 92%, #ffffff 8%);
      font-size:12px;
      font-weight:950;
      white-space:nowrap;
    }

    /* Modal */
    .pv-hide{ display:none !important; }
    .modal-backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.45);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:99999;
    }
    .modal{
      width:min(520px, 94vw);
      background:var(--card, var(--surface));
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow:0 18px 60px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .modal-h{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
    }
    .modal-h h3{ margin:0; font-size:15px; font-weight:950; }
    .modal-b{ padding:14px; }
    .modal-actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }

    /* Math blocks */
    .mathBlock{
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 12px;
      background:color-mix(in srgb, var(--surface) 92%, #ffffff 8%);
      font-size:12px;
      line-height:1.35;
    }
  </style>
</head>

<body>
  <div class="page">
    <div class="topbar">
      <h1>Dev • Readiness Model</h1>
      <button id="btnLogout" class="btn" type="button">Logout</button>
    </div>

    <!-- Operation dropdown -->
    <section class="card opCard" style="margin-bottom:14px;">
      <div class="card-h">
        <div>
          <p class="t">Operation</p>
          <div class="muted" style="font-size:12px;">This is for display/logging right now. Later it will tune thresholds.</div>
        </div>
        <div class="mono muted" id="modeLine">—</div>
      </div>
      <div class="card-b">
        <div class="field" style="margin:0;">
          <label for="opSel">Choose operation</label>
          <select id="opSel">
            <option value="spring_tillage">Spring tillage</option>
            <option value="planting">Planting</option>
            <option value="spraying" selected>Spraying</option>
            <option value="harvest">Harvest</option>
            <option value="fall_tillage">Fall tillage</option>
          </select>
        </div>
      </div>
    </section>

    <!-- Mock fields hero -->
    <section class="card" style="margin-bottom:14px;">
      <div class="card-h">
        <div>
          <p class="t">Mock Fields</p>
          <div class="muted" style="font-size:12px;">
            Readiness: <b>0 = WET</b> (red) … <b>100 = READY</b> (green).
          </div>
        </div>
        <div class="mono muted" id="tileStamp">—</div>
      </div>
      <div class="card-b">
        <div class="fieldsGrid" id="fieldsGrid"></div>
      </div>
    </section>

    <div class="grid">
      <!-- LEFT -->
      <section class="card">
        <div class="card-h">
          <div>
            <p class="t">Inputs</p>
            <div class="muted" style="font-size:12px;">
              Uses your live Cloud Run function (24h past + 48h forecast). Older history may be zeros until your Tomorrow.io request is approved.
            </div>
          </div>
        </div>

        <div class="card-b">
          <div class="field">
            <label>Location (Divernon, IL default)</label>
            <div class="row">
              <div class="field" style="margin:0;">
                <label for="lat">Latitude</label>
                <input id="lat" type="number" step="0.000001" value="39.5656"/>
              </div>
              <div class="field" style="margin:0;">
                <label for="lon">Longitude</label>
                <input id="lon" type="number" step="0.000001" value="-89.6540"/>
              </div>
            </div>
          </div>

          <div class="field">
            <label for="soil">Soil Type / Holding (1–10)</label>
            <div class="muted" style="font-size:12px; margin-top:-2px;">
              1=sandier (holds less, dries faster) • 10=clay (holds more, dries slower)
            </div>
            <div class="slider-wrap">
              <input id="soil" type="range" min="1" max="10" step="1" value="6"/>
              <div class="pill" id="soilVal">6</div>
            </div>
          </div>

          <div class="field">
            <label for="drain">Drainage (1–10)</label>
            <div class="muted" style="font-size:12px; margin-top:-2px;">
              1=good drainage (tile/ditches) • 10=poor drainage
            </div>
            <div class="slider-wrap">
              <input id="drain" type="range" min="1" max="10" step="1" value="5"/>
              <div class="pill" id="drainVal">5</div>
            </div>
          </div>

          <div class="field">
            <label for="thr">Readiness Threshold (0–100)</label>
            <div class="muted" style="font-size:12px; margin-top:-2px;">
              If Readiness ≥ threshold → READY (workable)
            </div>
            <div class="slider-wrap">
              <input id="thr" type="range" min="0" max="100" step="1" value="70"/>
              <div class="pill" id="thrVal">70</div>
            </div>
          </div>

          <div class="field">
            <label for="apiBase">Weather function URL</label>
            <input id="apiBase" type="text" value="https://farmvista-weather-300398089669.us-central1.run.app"/>
            <div class="muted" style="font-size:12px; margin-top:4px;">
              Called like: <span class="mono">URL?lat=..&lon=..</span>
            </div>
          </div>

          <div class="btnbar">
            <button id="btnFetch" class="btn primary" type="button">Fetch Weather Now</button>
            <button id="btnRecalc" class="btn" type="button">Recalculate Model</button>
          </div>

          <div class="statusline">
            <div id="dataMode" class="mono muted">Mode: —</div>
            <div id="runStamp" class="mono muted">—</div>
          </div>

          <div id="errBox" class="errorbox">
            <b>Page Error</b>
            <div class="mono" id="errText"></div>
          </div>

          <div style="height:12px;"></div>
          <div class="note" id="paramExplain">—</div>
        </div>
      </section>

      <!-- RIGHT -->
      <section class="card">
        <div class="card-h">
          <div>
            <p class="t">Output + Detailed Math</p>
            <div class="muted" style="font-size:12px;">This is not a black box. Everything is shown.</div>
          </div>
        </div>

        <div class="card-b">
          <div class="kpis">
            <div class="kpi">
              <div class="lab">Readiness (0–100)</div>
              <div class="val" id="readinessOut">—</div>
              <div class="sub" id="readinessLabel">—</div>
            </div>

            <div class="kpi">
              <div class="lab">Wetness (internal)</div>
              <div class="val" id="wetnessOut">—</div>
              <div class="sub">Wetness = 100 − Readiness</div>
            </div>

            <div class="kpi">
              <div class="lab">ETA if WET</div>
              <div class="val" id="etaOut">—</div>
              <div class="sub" id="etaSub">Uses 48-hour forecast simulation.</div>
            </div>

            <div class="kpi">
              <div class="lab">Tank</div>
              <div class="val" id="tankOut">—</div>
              <div class="sub" id="tankSub">—</div>
            </div>
          </div>

          <div style="height:12px;"></div>

          <div class="mathBlock" id="mathSummary">—</div>

          <div style="height:12px;"></div>

          <section class="card" style="box-shadow:none; border-radius:16px;">
            <div class="card-h" style="border-bottom:1px solid var(--border);">
              <div>
                <p class="t" style="font-size:14px;">Daily Tank Trace (30 days)</p>
                <div class="muted" style="font-size:12px;">
                  storage = clamp(storage + add − loss, 0..Smax)
                </div>
              </div>
            </div>
            <div class="card-b">
              <table aria-label="Daily trace">
                <thead>
                  <tr>
                    <th style="width:110px;">Date</th>
                    <th class="right">Rain</th>
                    <th class="right">DryPwr</th>
                    <th class="right">Add</th>
                    <th class="right">Loss</th>
                    <th class="right">Storage</th>
                    <th class="right">Clamp</th>
                    <th class="right">Readiness</th>
                  </tr>
                </thead>
                <tbody id="dailyTraceRows">
                  <tr><td colspan="8" class="muted">Fetch weather.</td></tr>
                </tbody>
              </table>
            </div>
          </section>

          <div style="height:12px;"></div>

          <section class="card" style="box-shadow:none; border-radius:16px;">
            <div class="card-h" style="border-bottom:1px solid var(--border);">
              <div>
                <p class="t" style="font-size:14px;">DryPwr Breakdown (daily)</p>
                <div class="muted" style="font-size:12px;">
                  NO SOLAR: dryPwr = clamp(0.45*tempN + 0.35*windN − 0.35*rhN, 0..1)
                </div>
              </div>
            </div>
            <div class="card-b">
              <table aria-label="DryPwr breakdown">
                <thead>
                  <tr>
                    <th style="width:110px;">Date</th>
                    <th class="right">Temp</th>
                    <th class="right">tempN</th>
                    <th class="right">Wind</th>
                    <th class="right">windN</th>
                    <th class="right">RH</th>
                    <th class="right">rhN</th>
                    <th class="right">raw</th>
                    <th class="right">DryPwr</th>
                  </tr>
                </thead>
                <tbody id="dryRows">
                  <tr><td colspan="9" class="muted">Fetch weather.</td></tr>
                </tbody>
              </table>
            </div>
          </section>

          <div style="height:12px;"></div>

          <section class="card" style="box-shadow:none; border-radius:16px;">
            <div class="card-h" style="border-bottom:1px solid var(--border);">
              <div>
                <p class="t" style="font-size:14px;">48-hour Forecast Simulation Trace (hourly)</p>
                <div class="muted" style="font-size:12px;">
                  This is what determines “Est: ~X hours” vs “Estimated to be greater then 2 days”
                </div>
              </div>
            </div>
            <div class="card-b">
              <table aria-label="Forecast trace">
                <thead>
                  <tr>
                    <th style="width:170px;">Hour</th>
                    <th class="right">Rain</th>
                    <th class="right">DryPwr</th>
                    <th class="right">Add</th>
                    <th class="right">Loss</th>
                    <th class="right">Storage</th>
                    <th class="right">Readiness</th>
                  </tr>
                </thead>
                <tbody id="fcTraceRows">
                  <tr><td colspan="7" class="muted">Fetch weather.</td></tr>
                </tbody>
              </table>

              <div style="height:10px;"></div>
              <div class="note" id="fcNote">—</div>
            </div>
          </section>

          <div style="height:12px;"></div>

          <section class="card" style="box-shadow:none; border-radius:16px;">
            <div class="card-h" style="border-bottom:1px solid var(--border);">
              <div>
                <p class="t" style="font-size:14px;">Weather Inputs (days30)</p>
                <div class="muted" style="font-size:12px;">
                  If your Tomorrow.io plan can’t provide history yet, older rows will be zeros.
                </div>
              </div>
            </div>
            <div class="card-b">
              <table aria-label="Inputs table">
                <thead>
                  <tr>
                    <th style="width:110px;">Date</th>
                    <th class="right">Rain</th>
                    <th class="right">Temp</th>
                    <th class="right">Wind</th>
                    <th class="right">RH</th>
                    <th class="right">Solar</th>
                  </tr>
                </thead>
                <tbody id="wxRows">
                  <tr><td colspan="6" class="muted">Fetch weather.</td></tr>
                </tbody>
              </table>
            </div>
          </section>

        </div>
      </section>
    </div>
  </div>

  <!-- Adjust Modal -->
  <div id="adjustBackdrop" class="modal-backdrop pv-hide" role="dialog" aria-modal="true" aria-labelledby="adjustTitle">
    <div class="modal">
      <div class="modal-h">
        <div>
          <h3 id="adjustTitle">Adjust</h3>
          <div class="muted" style="font-size:12px;" id="adjustSub">—</div>
        </div>
      </div>
      <div class="modal-b">
        <div class="note" id="adjustRule">—</div>

        <div class="modal-actions">
          <button id="btnAdjWet" class="btn danger" type="button">Wet</button>
          <button id="btnAdjDry" class="btn primary" type="button">Dry</button>
          <button id="btnAdjCancel" class="btn" type="button">Cancel</button>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  'use strict';

  const $ = (id)=> document.getElementById(id);
  const clamp = (v, lo, hi)=> Math.max(lo, Math.min(hi, v));
  const round2 = (n)=> Math.round(n*100)/100;

  function showErr(msg){
    const box = $('errBox');
    const text = $('errText');
    if (!box || !text) return;
    text.textContent = String(msg || 'Unknown error');
    box.style.display = 'block';
  }
  window.addEventListener('error', (e)=>{
    try{
      const m = (e && e.message) ? e.message : 'Script error';
      const at = (e && e.filename) ? (' @ ' + e.filename + ':' + (e.lineno||'?')) : '';
      showErr(m + at);
    }catch(_){}
  });
  window.addEventListener('unhandledrejection', (e)=>{
    try{ showErr('Unhandled promise rejection: ' + String(e && e.reason ? e.reason : e)); }catch(_){}
  });

  // Local adjust log
  const LS_LOG_KEY = 'FV_DEV_READINESS_ADJUST_LOG_V1';

  const state = {
    mode: 'LIVE',
    weather: null,      // {days30, forecast48, meta, ...}
    selectedFieldId: 'f1',
    runsByField: new Map(),  // id -> run object
  };

  // Mock fields (3)
  const FIELDS = [
    { id:'f1', farm:'Dowson Farms', field:'Home 80',      soil:6, drain:5 },
    { id:'f2', farm:'Dowson Farms', field:'River Bottom', soil:9, drain:9 },
    { id:'f3', farm:'Dowson Farms', field:'North Ridge',  soil:3, drain:2 },
  ];

  function escapeHtml(s){
    return String(s||'')
      .replaceAll('&','&amp;')
      .replaceAll('<','&lt;')
      .replaceAll('>','&gt;')
      .replaceAll('"','&quot;')
      .replaceAll("'","&#039;");
  }

  function loadLog(){
    try{
      const raw = localStorage.getItem(LS_LOG_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      return Array.isArray(arr) ? arr : [];
    }catch(e){ return []; }
  }
  function saveLog(arr){
    try{ localStorage.setItem(LS_LOG_KEY, JSON.stringify(arr)); }catch(e){}
  }

  // ========= MODEL MATH =========
  // We use a "tank" storage in inches-equivalent.
  // Wetness = storage/Smax * 100
  // Readiness = 100 - Wetness
  //
  // Slider interpretation (your definitions):
  //   soil 1..10: sand -> clay
  //   drain 1..10: good -> poor
  //
  // Normalize:
  //   soilHold = (soil-1)/9       (0 sand .. 1 clay)
  //   drainPoor= (drain-1)/9      (0 good .. 1 poor)
  //
  // Multipliers:
  //   Smax      = 2.60 + 1.00*soilHold + 0.90*drainPoor
  //   infilMult = 0.60 + 0.30*soilHold + 0.35*drainPoor     (rain sticks more w/ clay + poor drainage)
  //   dryMult   = 1.20 - 0.35*soilHold - 0.40*drainPoor     (dries slower w/ clay + poor drainage)
  //
  // Loss scale:
  //   LOSS_SCALE_DAY = 0.55 inches/day when dryPwr=1 and dryMult=1 (dev tuning constant)
  // For forecast hourly simulation:
  //   LOSS_SCALE_HR = LOSS_SCALE_DAY / 24
  //
  const LOSS_SCALE_DAY = 0.55;
  const LOSS_SCALE_HR  = LOSS_SCALE_DAY / 24;

  function mapFactors(soil, drain){
    const soilHold = (Number(soil) - 1) / 9;
    const drainPoor= (Number(drain) - 1) / 9;

    const Smax      = 2.60 + 1.00*soilHold + 0.90*drainPoor;
    const infilMult = 0.60 + 0.30*soilHold + 0.35*drainPoor;
    const dryMult   = 1.20 - 0.35*soilHold - 0.40*drainPoor;

    return { soilHold, drainPoor, Smax, infilMult, dryMult };
  }

  // NO SOLAR dryPwr:
  // tempN = clamp((temp - 20)/45, 0..1)  -> 20..65°F
  // windN = clamp((wind - 2)/20, 0..1)   -> 2..22 mph
  // rhN   = clamp((rh - 35)/65, 0..1)    -> 35..100%
  //
  // raw   = 0.45*tempN + 0.35*windN - 0.35*rhN
  // dryPwr= clamp(raw, 0..1)
  function dryParts(tempF, windMph, rh){
    const tempN = clamp((Number(tempF) - 20) / 45, 0, 1);
    const windN = clamp((Number(windMph) - 2) / 20, 0, 1);
    const rhN   = clamp((Number(rh) - 35) / 65, 0, 1);

    const raw = (0.45*tempN + 0.35*windN - 0.35*rhN);
    const dryPwr = clamp(raw, 0, 1);

    return { tempN, windN, rhN, raw, dryPwr };
  }

  // Daily run (30 days)
  function runDailyModel(days30, soil, drain){
    const f = mapFactors(soil, drain);

    // Start storage from neutral baseline + tiny nudge from recent rain memory
    // (since you said soil slider is not "starting wetness")
    const first7 = (days30 || []).slice(0,7);
    const rain7 = first7.reduce((s,x)=> s + (Number(x.rainIn||0)), 0);
    const rainNudgeFrac = clamp(rain7 / 4.0, 0, 1);
    const rainNudge = rainNudgeFrac * (0.35 * f.Smax);

    let storage = clamp((0.45 * f.Smax) + rainNudge, 0, f.Smax);

    const trace = [];
    const dryDaily = [];

    for (const d of (days30 || [])){
      const rain = Number(d.rainIn||0);
      const temp = Number(d.tempF||0);
      const wind = Number(d.windMph||0);
      const rh   = Number(d.rh||0);

      const dp = dryParts(temp, wind, rh);

      const add = rain * f.infilMult;
      const loss = dp.dryPwr * LOSS_SCALE_DAY * f.dryMult;

      const before = storage;
      const afterRaw = before + add - loss;
      const clamped = (afterRaw < 0) ? 'LOW' : (afterRaw > f.Smax ? 'HIGH' : '—');
      storage = clamp(afterRaw, 0, f.Smax);

      const wetness = clamp((storage / f.Smax) * 100, 0, 100);
      const readiness = clamp(100 - wetness, 0, 100);

      trace.push({
        dateISO: d.dateISO,
        rain,
        dryPwr: dp.dryPwr,
        add,
        loss,
        before,
        after: storage,
        clamped,
        readiness
      });

      dryDaily.push({
        dateISO: d.dateISO,
        temp, ...dp,
        wind, rh
      });
    }

    const wetnessFinal = clamp((storage / f.Smax) * 100, 0, 100);
    const readinessFinal = clamp(100 - wetnessFinal, 0, 100);

    return {
      soil, drain,
      factors: f,
      storageFinal: storage,
      wetnessFinal,
      readinessFinal,
      trace,
      dryDaily,
      rain7, rainNudgeFrac, rainNudge
    };
  }

  // 48-hour forecast simulation for ETA
  // Start from current storageFinal (end of daily run), then step forward hourly:
  // storage = clamp(storage + addHr - lossHr, 0..Smax)
  // addHr  = rainHr * infilMult
  // lossHr = dryPwrHr * LOSS_SCALE_HR * dryMult
  function simulate48h(runDaily, forecast48){
    const f = runDaily.factors;
    let storage = runDaily.storageFinal;

    const rows = [];
    let crossingHour = null;

    for (let i=0;i<(forecast48||[]).length;i++){
      const h = forecast48[i];
      const rain = Number(h.rainIn||0);
      const temp = Number(h.tempF||0);
      const wind = Number(h.windMph||0);
      const rh   = Number(h.rh||0);

      const dp = dryParts(temp, wind, rh);

      const add = rain * f.infilMult;
      const loss = dp.dryPwr * LOSS_SCALE_HR * f.dryMult;

      const before = storage;
      const afterRaw = before + add - loss;
      const clamped = (afterRaw < 0) ? 'LOW' : (afterRaw > f.Smax ? 'HIGH' : '—');
      storage = clamp(afterRaw, 0, f.Smax);

      const wetness = clamp((storage / f.Smax) * 100, 0, 100);
      const readiness = clamp(100 - wetness, 0, 100);

      rows.push({
        tsISO: h.tsISO,
        rain,
        dryPwr: dp.dryPwr,
        add,
        loss,
        before,
        after: storage,
        clamped,
        readiness
      });
    }

    return { rows, endStorage: storage };
  }

  function readinessStatus(readiness, thr){
    return (readiness >= thr) ? 'READY' : 'WET';
  }

  function etaFromForecast(fcSimRows, thr){
    // Find first hour where readiness >= thr
    for (let i=0;i<fcSimRows.length;i++){
      if (fcSimRows[i].readiness >= thr) return i+1; // hours from now (1-based)
    }
    return null; // not within 48
  }

  // ========= RENDER =========
  function renderParamExplain(runDaily){
    const f = runDaily.factors;

    $('paramExplain').innerHTML =
      `<b>How your sliders are used (exact):</b><br/><br/>
       Soil=${runDaily.soil}/10 → soilHold=(soil−1)/9=<span class="mono">${f.soilHold.toFixed(2)}</span> (0 sand → 1 clay)<br/>
       Drain=${runDaily.drain}/10 → drainPoor=(drain−1)/9=<span class="mono">${f.drainPoor.toFixed(2)}</span> (0 good → 1 poor)<br/><br/>
       Smax=<span class="mono">2.60 + 1.00*soilHold + 0.90*drainPoor</span> = <span class="mono">${f.Smax.toFixed(2)}</span><br/>
       infilMult=<span class="mono">0.60 + 0.30*soilHold + 0.35*drainPoor</span> = <span class="mono">${f.infilMult.toFixed(2)}</span><br/>
       dryMult=<span class="mono">1.20 − 0.35*soilHold − 0.40*drainPoor</span> = <span class="mono">${f.dryMult.toFixed(2)}</span><br/><br/>
       Daily add=<span class="mono">rain × infilMult</span><br/>
       Daily loss=<span class="mono">dryPwr × ${LOSS_SCALE_DAY.toFixed(2)} × dryMult</span><br/><br/>
       Start storage = <span class="mono">0.45*Smax + rainNudge</span><br/>
       rainNudge uses first-7-day rain: rain7=<span class="mono">${runDaily.rain7.toFixed(2)}</span>,
       nudgeFrac=<span class="mono">${runDaily.rainNudgeFrac.toFixed(2)}</span>,
       nudge=<span class="mono">${runDaily.rainNudge.toFixed(2)}</span>`;
  }

  function renderWxTable(days30){
    const tb = $('wxRows');
    tb.innerHTML = '';
    for (const d of (days30||[])){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="mono">${escapeHtml(d.dateISO||'')}</td>
        <td class="right mono">${Number(d.rainIn||0).toFixed(2)}</td>
        <td class="right mono">${Number(d.tempF||0).toFixed(1)}</td>
        <td class="right mono">${Number(d.windMph||0).toFixed(1)}</td>
        <td class="right mono">${Number(d.rh||0).toFixed(1)}</td>
        <td class="right mono">${Number(d.solarWm2||0).toFixed(0)}</td>
      `;
      tb.appendChild(tr);
    }
  }

  function renderDailyTrace(runDaily, thr){
    const tb = $('dailyTraceRows');
    tb.innerHTML = '';
    for (const r of runDaily.trace){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="mono">${escapeHtml(r.dateISO||'')}</td>
        <td class="right mono">${r.rain.toFixed(2)}</td>
        <td class="right mono">${r.dryPwr.toFixed(2)}</td>
        <td class="right mono">${r.add.toFixed(2)}</td>
        <td class="right mono">${r.loss.toFixed(2)}</td>
        <td class="right mono">${r.before.toFixed(2)}→${r.after.toFixed(2)}</td>
        <td class="right mono">${escapeHtml(r.clamped)}</td>
        <td class="right mono">${Math.round(r.readiness)}</td>
      `;
      tb.appendChild(tr);
    }
  }

  function renderDryRows(runDaily){
    const tb = $('dryRows');
    tb.innerHTML = '';
    for (const d of runDaily.dryDaily){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="mono">${escapeHtml(d.dateISO||'')}</td>
        <td class="right mono">${Math.round(d.temp)}</td>
        <td class="right mono">${d.tempN.toFixed(2)}</td>
        <td class="right mono">${Math.round(d.wind)}</td>
        <td class="right mono">${d.windN.toFixed(2)}</td>
        <td class="right mono">${Math.round(d.rh)}</td>
        <td class="right mono">${d.rhN.toFixed(2)}</td>
        <td class="right mono">${d.raw.toFixed(2)}</td>
        <td class="right mono">${d.dryPwr.toFixed(2)}</td>
      `;
      tb.appendChild(tr);
    }
  }

  function renderFcTrace(fcRows){
    const tb = $('fcTraceRows');
    tb.innerHTML = '';
    for (const r of (fcRows||[])){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="mono">${escapeHtml(r.tsISO||'')}</td>
        <td class="right mono">${r.rain.toFixed(2)}</td>
        <td class="right mono">${r.dryPwr.toFixed(2)}</td>
        <td class="right mono">${r.add.toFixed(3)}</td>
        <td class="right mono">${r.loss.toFixed(3)}</td>
        <td class="right mono">${r.before.toFixed(2)}→${r.after.toFixed(2)}</td>
        <td class="right mono">${Math.round(r.readiness)}</td>
      `;
      tb.appendChild(tr);
    }
  }

  function renderTiles(thr){
    const wrap = $('fieldsGrid');
    wrap.innerHTML = '';
    state.runsByField.clear();

    for (const f of FIELDS){
      const days30 = state.weather?.days30 || [];
      const fc48 = state.weather?.forecast48 || [];

      const runDaily = runDailyModel(days30, f.soil, f.drain);
      const fcSim = simulate48h(runDaily, fc48);

      const readiness = Math.round(runDaily.readinessFinal);
      const wetness = Math.round(runDaily.wetnessFinal);
      const status = readinessStatus(readiness, thr);

      const pct = clamp(readiness, 0, 100);

      let etaText = '';
      if (status === 'WET'){
        const h = etaFromForecast(fcSim.rows, thr);
        if (h !== null && h <= 48) etaText = `Est: ~${h} hours`;
        else etaText = 'Estimated to be greater then 2 days';
      }

      state.runsByField.set(f.id, { runDaily, fcSim, readiness, wetness, status, etaText });

      const tile = document.createElement('div');
      tile.className = 'fieldTile';

      const active = (f.id === state.selectedFieldId);

      tile.innerHTML = `
        <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:10px;">
          <div>
            <div class="fieldTitle">${escapeHtml(f.farm)} • ${escapeHtml(f.field)}</div>
            <div class="fieldSub">Soil=${f.soil}/10 • Drain=${f.drain}/10</div>
          </div>
          <div class="badge">${status}</div>
        </div>

        <div class="gaugeWrap">
          <div class="gaugeRow">
            <div><b>Readiness:</b> <span class="mono">${readiness}</span></div>
            <div class="muted">Wetness: <span class="mono">${wetness}</span></div>
          </div>

          <div class="gauge">
            <div class="marker" style="left:${pct}%;"></div>
          </div>
          <div class="gaugeLabels"><span>0</span><span>50</span><span>100</span></div>

          ${status === 'WET' ? `<div class="muted" style="font-size:12px;"><b>${etaText}</b></div>` : ``}
        </div>

        <div class="tileBtnRow">
          <button class="miniBtn ${active ? 'active' : ''}" data-field="${escapeHtml(f.id)}" type="button">
            ${active ? 'Selected' : 'Select'}
          </button>
          <button class="miniBtn" data-adjust="${escapeHtml(f.id)}" type="button">Adjust</button>
        </div>
      `;

      wrap.appendChild(tile);
    }

    wrap.querySelectorAll('button[data-field]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.getAttribute('data-field');
        selectField(id);
      });
    });
    wrap.querySelectorAll('button[data-adjust]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.getAttribute('data-adjust');
        openAdjust(id);
      });
    });

    $('tileStamp').textContent = new Date().toLocaleString();
  }

  function selectField(id){
    const f = FIELDS.find(x=>x.id === id);
    if (!f) return;
    state.selectedFieldId = id;

    $('soil').value = String(f.soil);
    $('drain').value = String(f.drain);
    syncLabels();
    recalc();
  }

  function recalc(){
    const thr = Number($('thr').value);

    // persist sliders to selected field
    const f = FIELDS.find(x=>x.id === state.selectedFieldId);
    if (f){
      f.soil = Number($('soil').value);
      f.drain = Number($('drain').value);
    }

    // render tiles first (so selected run exists)
    renderTiles(thr);

    const pack = state.runsByField.get(state.selectedFieldId);
    if (!pack) return;

    const runDaily = pack.runDaily;
    const fcSim = pack.fcSim;

    const readiness = Math.round(runDaily.readinessFinal);
    const wetness = Math.round(runDaily.wetnessFinal);
    const status = pack.status;

    $('readinessOut').textContent = String(readiness);
    $('wetnessOut').textContent = String(wetness);
    $('readinessLabel').textContent = `${status} • threshold=${thr}`;

    // ETA display
    if (status === 'READY'){
      $('etaOut').textContent = '—';
      $('etaSub').textContent = 'Field is READY now.';
    } else {
      const h = etaFromForecast(fcSim.rows, thr);
      if (h !== null && h <= 48){
        $('etaOut').textContent = `Est: ~${h} hours`;
        $('etaSub').textContent = 'Computed from the 48-hour forecast simulation.';
      } else {
        $('etaOut').textContent = 'Estimated to be greater then 2 days';
        $('etaSub').textContent = 'Not projected to cross threshold within 48 hours.';
      }
    }

    $('tankOut').textContent = `${runDaily.storageFinal.toFixed(2)} / ${runDaily.factors.Smax.toFixed(2)}`;
    $('tankSub').textContent = `LOSS_SCALE_DAY=${LOSS_SCALE_DAY.toFixed(2)} • LOSS_SCALE_HR=${LOSS_SCALE_HR.toFixed(4)} • infilMult=${runDaily.factors.infilMult.toFixed(2)} • dryMult=${runDaily.factors.dryMult.toFixed(2)}`;

    renderParamExplain(runDaily);
    renderWxTable(state.weather?.days30 || []);
    renderDailyTrace(runDaily, thr);
    renderDryRows(runDaily);

    renderFcTrace(fcSim.rows);

    $('fcNote').textContent =
      `Hourly loss = dryPwr * ${LOSS_SCALE_HR.toFixed(4)} * dryMult. Hourly add = rainHr * infilMult. Storage is clamped 0..Smax.`;

    $('mathSummary').innerHTML =
      `<b>Summary (selected field):</b><br/>
       Readiness = 100 − (storage/Smax*100). Wetness = storage/Smax*100.<br/>
       Final storage=${runDaily.storageFinal.toFixed(2)}, Smax=${runDaily.factors.Smax.toFixed(2)} → Wetness=${runDaily.wetnessFinal.toFixed(1)} → Readiness=${runDaily.readinessFinal.toFixed(1)}.<br/><br/>
       <b>NO SOLAR</b> dryPwr uses temp + wind − humidity only.`;

    $('runStamp').textContent = new Date().toLocaleString();
  }

  // ========= ADJUST MODAL =========
  function showModal(show){
    $('adjustBackdrop').classList.toggle('pv-hide', !show);
  }

  function openAdjust(fieldId){
    const thr = Number($('thr').value);
    const f = FIELDS.find(x=>x.id === fieldId);
    const pack = state.runsByField.get(fieldId);

    if (!f || !pack){
      alert('No model result yet. Fetch weather first.');
      return;
    }

    const op = String($('opSel').value || '');
    const readiness = pack.readiness;
    const status = pack.status;

    $('adjustTitle').textContent = 'Adjust';
    $('adjustSub').textContent = `${f.farm} • ${f.field} • Op: ${op} • Threshold: ${thr}`;

    // Your gating rule:
    // If READY -> allow WET, disable DRY
    // If WET   -> allow DRY, disable WET
    const btnWet = $('btnAdjWet');
    const btnDry = $('btnAdjDry');

    if (status === 'READY'){
      btnWet.disabled = false;
      btnDry.disabled = true;
      $('adjustRule').innerHTML =
        `Model says <b>READY</b> (Readiness ${readiness} ≥ ${thr}).<br/>
         To prevent messing up the model, only <b>Wet</b> is allowed as a correction.`;
    } else {
      btnWet.disabled = true;
      btnDry.disabled = false;
      $('adjustRule').innerHTML =
        `Model says <b>WET</b> (Readiness ${readiness} &lt; ${thr}).<br/>
         To prevent messing up the model, only <b>Dry</b> is allowed as a correction.<br/>
         <b>${escapeHtml(pack.etaText)}</b>`;
    }

    btnWet.dataset.fieldId = fieldId;
    btnDry.dataset.fieldId = fieldId;

    showModal(true);
  }

  function recordAdjust(kind, fieldId){
    const thr = Number($('thr').value);
    const op = String($('opSel').value || '');
    const f = FIELDS.find(x=>x.id === fieldId);
    const pack = state.runsByField.get(fieldId);

    const item = {
      ts: Date.now(),
      kind,
      fieldId,
      fieldName: `${f.farm} • ${f.field}`,
      op,
      thr,
      readiness: pack ? pack.readiness : null,
      wetness: pack ? pack.wetness : null,
      soil: f ? f.soil : null,
      drain: f ? f.drain : null,
      mode: $('dataMode').textContent
    };

    const log = loadLog();
    log.push(item);
    saveLog(log);

    showModal(false);
    alert('Saved (local).');
  }

  // ========= WEATHER FETCH =========
  async function fetchWeather(){
    const base = String($('apiBase').value || '').trim().replace(/\/+$/,'');
    const lat = String($('lat').value || '').trim();
    const lon = String($('lon').value || '').trim();
    if (!base || !lat || !lon){
      alert('Missing function URL or lat/lon.');
      return;
    }

    $('btnFetch').disabled = true;
    $('btnFetch').textContent = 'Fetching…';

    try{
      const url = `${base}?lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lon)}`;
      const res = await fetch(url, { method:'GET' });
      const js = await res.json().catch(()=> ({}));
      if (!res.ok){
        throw new Error(js?.error || `HTTP ${res.status}`);
      }

      // Expect the function response format
      const days30 = Array.isArray(js.days30) ? js.days30 : [];
      const forecast48 = Array.isArray(js.forecast48) ? js.forecast48 : [];

      state.weather = {
        meta: js.meta || {},
        sourceMode: js.sourceMode || 'unknown',
        lookbackHoursUsed: js.lookbackHoursUsed,
        days30,
        forecast48
      };

      $('dataMode').textContent = `Mode: LIVE (${state.weather.sourceMode})`;
      $('modeLine').textContent = 'LIVE';

      // hide any error box if previously shown
      $('errBox').style.display = 'none';

      recalc();
    }catch(err){
      showErr(String(err?.message || err));
    }finally{
      $('btnFetch').disabled = false;
      $('btnFetch').textContent = 'Fetch Weather Now';
    }
  }

  function syncLabels(){
    $('soilVal').textContent = $('soil').value;
    $('drainVal').textContent = $('drain').value;
    $('thrVal').textContent = $('thr').value;
  }

  // ========= EVENTS =========
  $('btnFetch').addEventListener('click', fetchWeather);
  $('btnRecalc').addEventListener('click', recalc);

  $('soil').addEventListener('input', ()=>{ syncLabels(); recalc(); });
  $('drain').addEventListener('input', ()=>{ syncLabels(); recalc(); });
  $('thr').addEventListener('input', ()=>{ syncLabels(); recalc(); });

  $('opSel').addEventListener('change', ()=>{ /* affects modal/log only right now */ });

  $('btnLogout').addEventListener('click', ()=>{
    try{
      if (window.FV && typeof window.FV.logout === 'function'){ window.FV.logout(); return; }
    }catch(e){}
    location.href = '/Farm-vista/auth/';
  });

  $('btnAdjCancel').addEventListener('click', ()=> showModal(false));
  $('adjustBackdrop').addEventListener('click', (e)=>{
    if (e.target && e.target.id === 'adjustBackdrop') showModal(false);
  });
  $('btnAdjWet').addEventListener('click', (e)=> recordAdjust('WET', e.currentTarget.dataset.fieldId));
  $('btnAdjDry').addEventListener('click', (e)=> recordAdjust('DRY', e.currentTarget.dataset.fieldId));

  // ========= INIT =========
  syncLabels();
  $('modeLine').textContent = 'LIVE';
  $('dataMode').textContent = 'Mode: LIVE (not fetched yet)';
  // Create an empty weather state so tiles render (but will show zeros until fetch)
  state.weather = { days30: Array.from({length:30}, (_,i)=>({ dateISO:'—', rainIn:0,tempF:0,windMph:0,rh:0,solarWm2:0 })), forecast48: [] };
  recalc(); // will render tiles with zeros
})();
</script>
</body>
</html>
