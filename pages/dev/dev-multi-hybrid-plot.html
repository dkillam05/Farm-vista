<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FarmVista • Dev • Multi-Hybrid Plot Setup</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#3B7E46" />

  <!-- ABSOLUTE PATHS (match your other pages) -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest" />
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png" />
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png" />
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css" />
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css" />

  <style>
    :root {
      --card-max: 900px;
      --page-bottom-gap: 40px;
    }

    body {
      background: var(--page-bg, #f3f3f1);
    }

    .dev-shell {
      min-height: 100vh;
      padding: 1.5rem 1rem 3rem;
      display: flex;
      align-items: flex-start;
      justify-content: center;
    }

    .dev-inner {
      width: 100%;
      max-width: 1100px;
    }

    .dev-header {
      margin-bottom: 1rem;
    }

    .dev-header h1 {
      font-size: 1.4rem;
      font-weight: 600;
      margin: 0 0 0.25rem;
    }

    .dev-header p {
      margin: 0;
      font-size: 0.9rem;
      color: #555;
    }

    .dev-page-card {
      background: var(--card-bg, #ffffff);
      border-radius: 18px;
      padding: 1rem 1.25rem 1.5rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.06);
      position: relative;
      min-height: 180px;
    }

    .muted-note {
      font-size: 0.82rem;
      color: #555;
    }

    /* === Modal shell – keep close to your app style === */

    .yield-modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 1rem;
      z-index: 30;
    }

    .yield-modal {
      background: var(--card-bg, #ffffff);
      border-radius: 18px;
      width: 100%;
      max-width: 860px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.18);
      display: flex;
      flex-direction: column;
      max-height: 100vh;
    }

    .yield-modal-header {
      padding: 0.9rem 1.5rem;
      border-bottom: 1px solid rgba(15,23,42,0.08);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .yield-modal-title {
      font-size: 0.95rem;
      font-weight: 600;
    }

    .yield-modal-close {
      border: none;
      background: transparent;
      cursor: pointer;
      padding: 0.25rem;
      line-height: 1;
    }

    .yield-modal-body {
      padding: 1.25rem 1.5rem 1rem;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      flex: 1 1 auto;
    }

    .yield-modal-footer {
      padding: 0.9rem 1.5rem 1.2rem;
      border-top: 1px solid rgba(15,23,42,0.08);
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
      flex-shrink: 0;
      background: var(--card-bg, #ffffff);
      position: sticky;
      bottom: 0;
    }

    @media (max-width: 640px) {
      .yield-modal-backdrop {
        padding: 0;
      }
      .yield-modal {
        border-radius: 0;
        max-width: 100%;
        height: 100vh;
        max-height: 100vh;
      }
    }

    /* === Content inside popup === */

    .trial-summary {
      font-size: 0.88rem;
      margin-bottom: 0.9rem;
    }

    .trial-summary-row {
      display: flex;
      flex-wrap: wrap;
      column-gap: 1.5rem;
      row-gap: 0.25rem;
    }

    .trial-summary dt {
      font-weight: 600;
      margin-right: 0.25rem;
    }

    .trial-summary dd {
      margin: 0;
    }

    .trial-summary small {
      color: #555;
    }

    .primary-full-btn {
      margin-top: 0.75rem;
      margin-bottom: 0.75rem;
      border-radius: 999px;
      padding: 0.75rem 1.25rem;
      border: none;
      width: 100%;
      font-weight: 600;
      font-size: 0.98rem;
      cursor: pointer;
      background: #2e7b35;
      color: #fff;
      box-shadow: 0 8px 18px rgba(46,123,53,0.35);
    }

    .primary-full-btn:disabled {
      opacity: 0.55;
      cursor: default;
      box-shadow: none;
    }

    .setup-panel {
      border-radius: 14px;
      background: #f6f6f4;
      padding: 0.9rem 1rem 1rem;
      margin-top: 0.25rem;
    }

    .setup-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }

    .setup-field {
      flex: 1 1 120px;
    }

    .setup-field label {
      display: block;
      font-size: 0.8rem;
      font-weight: 600;
      margin-bottom: 0.15rem;
    }

    .setup-field input,
    .setup-field select {
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(15,23,42,0.25);
      font-size: 0.88rem;
      padding: 0.45rem 0.75rem;
      outline: none;
    }

    .setup-field small {
      display: block;
      margin-top: 0.1rem;
      font-size: 0.75rem;
      color: #666;
    }

    .setup-hybrids-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 0.5rem;
      margin-bottom: 0.25rem;
    }

    .setup-hybrids-header h3 {
      font-size: 0.9rem;
      margin: 0;
    }

    .btn-link-quiet {
      border: none;
      background: none;
      font-size: 0.82rem;
      cursor: pointer;
      padding: 0.15rem 0.25rem;
      color: #134e19;
    }

    .text-pill {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: 0.15rem 0.55rem;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      background: #e5e7eb;
      color: #374151;
    }

    .setup-hybrid-row {
      display: grid;
      grid-template-columns: auto minmax(0, 2.1fr) minmax(0, 1.4fr) auto;
      gap: 0.5rem;
      align-items: center;
      padding: 0.35rem 0.7rem;
      border-radius: 999px;
      background: #ffffff;
      border: 1px solid rgba(15,23,42,0.10);
      margin-bottom: 0.4rem;
    }

    .setup-hybrid-row select {
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(15,23,42,0.25);
      font-size: 0.85rem;
      padding: 0.35rem 0.6rem;
    }

    .entry-label {
      font-size: 0.78rem;
      font-weight: 600;
      color: #374151;
      white-space: nowrap;
    }

    .check-indicator {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      font-size: 0.78rem;
      white-space: nowrap;
    }

    .check-dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      border: 2px solid #9ca3af;
      box-sizing: border-box;
    }

    .check-dot--on {
      border-color: #166534;
      background: #16a34a;
    }

    .check-indicator button {
      border: none;
      background: none;
      padding: 0;
      font-size: 0.78rem;
      cursor: pointer;
      color: #134e19;
    }

    .setup-hybrid-row button.remove-btn {
      border-radius: 999px;
      border: none;
      font-size: 0.78rem;
      padding: 0.3rem 0.5rem;
      cursor: pointer;
      background: #f97373;
      color: #fff;
    }

    .setup-errors {
      margin-top: 0.4rem;
      font-size: 0.8rem;
      color: #9b1c1c;
    }

    .blocks-panel {
      margin-top: 0.5rem;
    }

    .blocks-panel-header {
      font-size: 0.87rem;
      margin-bottom: 0.5rem;
    }

    .block-card {
      border-radius: 14px;
      background: #f6f6f4;
      padding: 0.7rem 0.9rem 0.8rem;
      margin-bottom: 0.5rem;
    }

    .block-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.4rem;
    }

    .block-title {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .block-subtitle {
      font-size: 0.78rem;
      color: #555;
    }

    .badge-check {
      border-radius: 999px;
      padding: 0.1rem 0.55rem;
      font-size: 0.72rem;
      background: #2e7b35;
      color: #fff;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-left: 0.4rem;
    }

    .badge-void {
      border-radius: 999px;
      padding: 0.1rem 0.55rem;
      font-size: 0.72rem;
      background: #b91c1c;
      color: #fff;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-left: 0.35rem;
    }

    .hidden {
      display: none;
    }

    .block-body {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      align-items: flex-end;
    }

    .block-field {
      flex: 1 1 110px;
    }

    .block-field label {
      display: block;
      font-size: 0.78rem;
      font-weight: 600;
      margin-bottom: 0.1rem;
    }

    .block-field input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(15,23,42,0.25);
      font-size: 0.85rem;
      padding: 0.35rem 0.6rem;
      outline: none;
    }

    .block-yield {
      flex: 0 0 140px;
      font-size: 0.82rem;
      font-weight: 600;
    }

    .block-yield span {
      display: block;
      font-size: 0.78rem;
      font-weight: 400;
      color: #555;
    }

    .block-out-of-range {
      color: #b91c1c;
    }

    .block-void-toggle {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      font-size: 0.78rem;
    }

    .block-void-toggle input[type="checkbox"] {
      accent-color: #b91c1c;
    }

    .btn-secondary {
      border-radius: 999px;
      padding: 0.55rem 1.1rem;
      font-size: 0.88rem;
      font-weight: 500;
      border: 1px solid rgba(15,23,42,0.2);
      background: #fff;
      cursor: pointer;
    }

    .btn-primary {
      border-radius: 999px;
      padding: 0.55rem 1.4rem;
      font-size: 0.9rem;
      font-weight: 600;
      border: none;
      background: #2e7b35;
      color: #fff;
      cursor: pointer;
      box-shadow: 0 6px 15px rgba(46,123,53,0.35);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      box-shadow: none;
      cursor: default;
    }
  </style>
</head>
<body>
  <div class="dev-shell">
    <div class="dev-inner">
      <header class="dev-header">
        <h1>Dev • Multi-Hybrid Plot Setup</h1>
        <p>This is just a sandbox for the Trial Field Yield popup. No Firestore, no real data.</p>
      </header>

      <div class="dev-page-card">
        <p class="muted-note">
          Imagine the normal Trial Field Yields screen behind this. The popup below mimics that same size and layout,
          and will later be controlled by JS helpers instead of this dev file.
        </p>
      </div>
    </div>
  </div>

  <div class="yield-modal-backdrop">
    <div class="yield-modal">
      <div class="yield-modal-header">
        <div class="yield-modal-title">
          0702-Grandmas TestPlot • Yield Entry (Dev – Multi-Hybrid)
        </div>
        <button class="yield-modal-close" type="button" id="mh-close-btn" aria-label="Close">
          <svg width="18" height="18" viewBox="0 0 20 20" aria-hidden="true">
            <path d="M5 5l10 10M15 5L5 15" fill="none" stroke="#111827" stroke-width="1.6" stroke-linecap="round"/>
          </svg>
        </button>
      </div>

      <div class="yield-modal-body">
        <section class="trial-summary">
          <dl class="trial-summary-row">
            <div>
              <dt>Trial:</dt>
              <dd>Grandmas Test Plot North</dd>
            </div>
            <div>
              <dt>Field:</dt>
              <dd>Divernon–Farmersville • 0702-Grandmas TestPlot</dd>
            </div>
          </dl>
          <dl class="trial-summary-row">
            <div>
              <dt>Trial acres:</dt>
              <dd>20.00 ac</dd>
            </div>
            <div>
              <dt>Field tillable:</dt>
              <dd>39.45 ac</dd>
            </div>
          </dl>
          <p class="muted-note">
            For Multi-Hybrid Seed trials, use <strong>Set Up Plot</strong> to define varieties in planting order, pick a
            single check variety (tied to the variety ID), and set plot length + width. Each hybrid then becomes its own
            weight-only block with moisture and total weight per strip.
          </p>
        </section>

        <div id="mh-stage-shell"></div>
      </div>

      <div class="yield-modal-footer">
        <button type="button" class="btn-secondary" id="mh-reset-btn">Reset Dev</button>
        <button type="button" class="btn-primary" id="mh-save-btn">Save &amp; Close (Dev)</button>
      </div>
    </div>
  </div>

  <script>
    const mhState = {
      cropKind: 'corn',
      stage: 'setup',     // 'setup' | 'blocks'
      passLengthFt: 600,
      passWidthFt: 20,
      checkProductId: null,
      hybrids: [],
      blocks: []
    };

    const mockHybrids = [
      { id: 'P1185Q', name: 'Pioneer P1185Q', maturity: 118 },
      { id: 'P1742Q', name: 'Pioneer P1742Q', maturity: 117 },
      { id: 'P1366Q', name: 'Pioneer P1366Q', maturity: 113 },
      { id: 'DKC6460', name: 'Dekalb DKC6460', maturity: 114 },
      { id: 'DKC6499', name: 'Dekalb DKC6499', maturity: 114 },
      { id: 'AG3640', name: 'AgriGold 3640', maturity: 112 }
    ];

    const stageShell = document.getElementById('mh-stage-shell');
    const saveBtn = document.getElementById('mh-save-btn');
    const resetBtn = document.getElementById('mh-reset-btn');
    const closeBtn = document.getElementById('mh-close-btn');

    function formatNumber(num, decimals = 1) {
      if (num === null || num === undefined || isNaN(num)) return '—';
      return Number(num).toFixed(decimals);
    }

    function formatWithCommas(num, decimals = 0) {
      if (num === null || num === undefined || isNaN(num)) return '';
      const fixed = Number(num).toFixed(decimals);
      const parts = fixed.split('.');
      parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      return parts.join(decimals ? '.' : '');
    }

    function calcDevYieldBuPerAc({ cropKind, moisturePct, wetWeightLbs, lengthFt, widthFt }) {
      if (!moisturePct || !wetWeightLbs || !lengthFt || !widthFt) return null;
      const areaAc = (lengthFt * widthFt) / 43560;
      if (areaAc <= 0) return null;

      const stdMoist = cropKind === 'soy' ? 13.0 : 15.0;
      const testWt = cropKind === 'soy' ? 60.0 : 56.0;

      const m = Number(moisturePct);
      const w = Number(wetWeightLbs);
      if (m <= 0 || m >= 80 || w <= 0) return null;

      const usedMoist = Math.max(m, stdMoist);
      const dryWeightAtStd = w * (100 - usedMoist) / (100 - stdMoist);
      const bu = dryWeightAtStd / testWt;
      return bu / areaAc;
    }

    function nextRowId() {
      return 'row_' + Math.random().toString(36).slice(2, 9);
    }

    function renderStage() {
      if (mhState.stage === 'setup') {
        renderSetup();
      } else {
        renderBlocks();
      }
    }

    function renderSetup() {
      const hybrids = mhState.hybrids;
      const lengthFt = mhState.passLengthFt;
      const widthFt = mhState.passWidthFt;

      let html = `
        <button type="button" class="primary-full-btn" id="mh-setup-btn">
          + Set Up Plot
        </button>
        <p class="muted-note">
          First entry = first planted; 10th entry = 10th planted. Pick <strong>one</strong> check variety. Any strip
          using that variety belongs to your check.
        </p>

        <div class="setup-panel">
          <div class="setup-row">
            <div class="setup-field">
              <label for="mh-length-input">Plot length (ft)</label>
              <input id="mh-length-input" type="number" min="1" step="1" value="${lengthFt}">
              <small>Same length for every strip in this plot.</small>
            </div>
            <div class="setup-field">
              <label for="mh-width-input">Pass width (ft)</label>
              <input id="mh-width-input" type="number" min="1" step="1" value="${widthFt}">
              <small>Planter/harvest width (e.g., 20 ft, 30 ft).</small>
            </div>
          </div>

          <div class="setup-hybrids-header">
            <h3>Varieties in this plot (planting order)</h3>
            <button type="button" class="btn-link-quiet" id="mh-add-row-btn">+ Add variety</button>
          </div>
      `;

      if (!hybrids.length) {
        html += `<p class="muted-note">No varieties added yet. Tap <strong>+ Add variety</strong> to start.</p>`;
      } else {
        hybrids.forEach((hyb, idx) => {
          const selectId = `mh-hybrid-select-${hyb.rowId}`;
          const isCheckRow = hyb.productId && mhState.checkProductId === hyb.productId;
          html += `
            <div class="setup-hybrid-row" data-row-id="${hyb.rowId}">
              <div class="entry-label">Entry ${idx + 1}</div>
              <div>
                <select id="${selectId}">
                  <option value="">Select variety…</option>
                  ${mockHybrids.map(opt => `
                    <option value="${opt.id}" ${opt.id === hyb.productId ? 'selected' : ''}>
                      ${opt.name} (${opt.maturity} RM)
                    </option>
                  `).join('')}
                </select>
              </div>
              <div class="check-indicator">
                <span class="check-dot ${isCheckRow ? 'check-dot--on' : ''}"></span>
                <button type="button" data-row-id="${hyb.rowId}">Set as Check</button>
              </div>
              <div style="text-align:right;">
                <button type="button" class="remove-btn" data-row-id="${hyb.rowId}">Remove</button>
              </div>
            </div>
          `;
        });
      }

      html += `
          <div class="setup-errors" id="mh-setup-errors"></div>
        </div>
      `;

      stageShell.innerHTML = html;

      document.getElementById('mh-setup-btn').addEventListener('click', () => {
        const firstInput = document.getElementById('mh-length-input');
        if (firstInput) firstInput.focus();
      });

      document.getElementById('mh-length-input').addEventListener('input', (e) => {
        mhState.passLengthFt = Number(e.target.value) || 0;
      });

      document.getElementById('mh-width-input').addEventListener('input', (e) => {
        mhState.passWidthFt = Number(e.target.value) || 0;
      });

      document.getElementById('mh-add-row-btn').addEventListener('click', () => {
        mhState.hybrids.push({
          rowId: nextRowId(),
          productId: '',
          name: '',
          maturity: null
        });
        renderStage();
      });

      // Variety dropdowns + Set-as-check + Remove
      mhState.hybrids.forEach((hyb) => {
        const selectEl = document.getElementById(`mh-hybrid-select-${hyb.rowId}`);
        if (selectEl) {
          selectEl.addEventListener('change', (e) => {
            const val = e.target.value;
            const found = mockHybrids.find(m => m.id === val);
            hyb.productId = val;
            hyb.name = found ? found.name : '';
            hyb.maturity = found ? found.maturity : null;
            // If this row now matches the current checkProductId, we want its dot on
            renderStage();
          });
        }

        const checkBtn = stageShell.querySelector(`.check-indicator button[data-row-id="${hyb.rowId}"]`);
        if (checkBtn) {
          checkBtn.addEventListener('click', () => {
            if (!hyb.productId) return;
            mhState.checkProductId = hyb.productId;
            renderStage();
          });
        }

        const removeBtn = stageShell.querySelector(`button.remove-btn[data-row-id="${hyb.rowId}"]`);
        if (removeBtn) {
          removeBtn.addEventListener('click', () => {
            const idx = mhState.hybrids.findIndex(h => h.rowId === hyb.rowId);
            if (idx !== -1) mhState.hybrids.splice(idx, 1);
            // If no remaining row uses the current check variety, clear it
            if (mhState.hybrids.every(h => h.productId !== mhState.checkProductId)) {
              mhState.checkProductId = null;
            }
            renderStage();
          });
        }
      });
    }

    function renderBlocks() {
      const blocks = mhState.blocks;
      const lengthFt = mhState.passLengthFt;
      const widthFt = mhState.passWidthFt;

      let html = `
        <button type="button" class="primary-full-btn" id="mh-edit-setup-btn">
          Edit Plot Setup (Dev only)
        </button>
        <p class="muted-note">
          Each hybrid below is a weight-only block. Enter moisture (two decimals) and whole-weight in pounds. You can
          save and close between entries; incomplete rows will just stay blank.
        </p>

        <div class="blocks-panel">
          <div class="blocks-panel-header">
            Plot length: <strong>${lengthFt} ft</strong> • Pass width: <strong>${widthFt} ft</strong> • Area per strip:
            <strong>${formatNumber((lengthFt * widthFt) / 43560, 3)} ac</strong>
          </div>
      `;

      if (!blocks.length) {
        html += `<p class="muted-note">No blocks generated. Use Reset Dev and run setup again.</p>`;
      } else {
        blocks.forEach((blk, idx) => {
          const outOfRange = blk.yieldBuPerAc != null && (blk.yieldBuPerAc < 50 || blk.yieldBuPerAc > 400);
          const isCheck = mhState.checkProductId && blk.productId === mhState.checkProductId;
          html += `
            <div class="block-card" data-row-id="${blk.rowId}">
              <div class="block-header">
                <div>
                  <div class="block-title">
                    Entry ${idx + 1} · ${blk.name || 'Variety'}
                    <span class="badge-check ${isCheck ? '' : 'hidden'}">Check</span>
                    <span class="badge-void ${blk.voided ? '' : 'hidden'}" id="mh-void-badge-${blk.rowId}">Voided</span>
                  </div>
                  <div class="block-subtitle">
                    ${blk.maturity ? `${blk.maturity} RM` : ''}
                  </div>
                </div>
              </div>
              <div class="block-body">
                <div class="block-field">
                  <label for="mh-moist-${blk.rowId}">Moisture %</label>
                  <input id="mh-moist-${blk.rowId}" type="number" step="0.01" min="5" max="40"
                         value="${blk.moisturePct ?? ''}">
                </div>
                <div class="block-field">
                  <label for="mh-weight-${blk.rowId}">Weight (lbs)</label>
                  <input id="mh-weight-${blk.rowId}" type="number" step="1" min="0"
                         value="${blk.weightLbs ?? ''}">
                </div>
                <div class="block-yield">
                  Yield (bu/ac)
                  <span id="mh-yield-${blk.rowId}" class="${outOfRange ? 'block-out-of-range' : ''}">
                    ${blk.yieldBuPerAc != null ? formatNumber(blk.yieldBuPerAc, 2) : '—'}
                  </span>
                </div>
                <div class="block-void-toggle">
                  <input id="mh-void-${blk.rowId}" type="checkbox" ${blk.voided ? 'checked' : ''}>
                  <label for="mh-void-${blk.rowId}">Void this hybrid</label>
                </div>
              </div>
            </div>
          `;
        });
      }

      html += `</div>`;
      stageShell.innerHTML = html;

      document.getElementById('mh-edit-setup-btn').addEventListener('click', () => {
        mhState.stage = 'setup';
        mhState.hybrids = mhState.blocks.map(b => ({
          rowId: b.rowId,
          productId: b.productId,
          name: b.name,
          maturity: b.maturity
        }));
        renderStage();
      });

      // Wire moisture / weight / void handlers
      mhState.blocks.forEach((blk) => {
        const moistEl = document.getElementById(`mh-moist-${blk.rowId}`);
        const weightEl = document.getElementById(`mh-weight-${blk.rowId}`);
        const voidEl = document.getElementById(`mh-void-${blk.rowId}`);
        const yieldSpan = document.getElementById(`mh-yield-${blk.rowId}`);
        const voidBadge = document.getElementById(`mh-void-badge-${blk.rowId}`);

        function recalcAndPaint() {
          blk.yieldBuPerAc = calcDevYieldBuPerAc({
            cropKind: mhState.cropKind,
            moisturePct: blk.moisturePct,
            wetWeightLbs: blk.weightLbs,
            lengthFt: mhState.passLengthFt,
            widthFt: mhState.passWidthFt
          });

          if (yieldSpan) {
            if (blk.yieldBuPerAc != null) {
              yieldSpan.textContent = formatNumber(blk.yieldBuPerAc, 2);
              const out = blk.yieldBuPerAc < 50 || blk.yieldBuPerAc > 400;
              yieldSpan.classList.toggle('block-out-of-range', out);
            } else {
              yieldSpan.textContent = '—';
              yieldSpan.classList.remove('block-out-of-range');
            }
          }
        }

        if (moistEl) {
          moistEl.addEventListener('input', (e) => {
            blk.moisturePct = e.target.value === '' ? null : Number(e.target.value);
            recalcAndPaint();
          });
        }

        if (weightEl) {
          weightEl.addEventListener('input', (e) => {
            const val = e.target.value === '' ? null : Number(e.target.value);
            blk.weightLbs = val;
            recalcAndPaint();
          });

          weightEl.addEventListener('blur', (e) => {
            if (blk.weightLbs != null) {
              e.target.value = formatWithCommas(blk.weightLbs, 0);
            }
          });
        }

        if (voidEl) {
          voidEl.addEventListener('change', (e) => {
            blk.voided = e.target.checked;
            if (voidBadge) voidBadge.classList.toggle('hidden', !blk.voided);
          });
        }
      });
    }

    function validateSetup() {
      const errors = [];
      const lengthFt = mhState.passLengthFt || 0;
      const widthFt = mhState.passWidthFt || 0;

      if (lengthFt <= 0) errors.push('Enter a positive plot length.');
      if (widthFt <= 0) errors.push('Enter a positive pass width.');

      if (!mhState.hybrids.length) {
        errors.push('Add at least one variety to this plot.');
      } else {
        mhState.hybrids.forEach((h, idx) => {
          if (!h.productId) errors.push(`Entry ${idx + 1}: select a variety.`);
        });
      }

      if (!mhState.checkProductId) {
        errors.push('Pick one check variety (tied to a variety ID).');
      }

      const errBox = document.getElementById('mh-setup-errors');
      if (!errBox) return errors.length === 0;

      if (!errors.length) {
        errBox.textContent = '';
        return true;
      }

      errBox.innerHTML = errors.map(e => '• ' + e).join('<br>');
      return false;
    }

    // Footer buttons

    saveBtn.addEventListener('click', () => {
      if (mhState.stage === 'setup') {
        if (!validateSetup()) return;

        mhState.blocks = mhState.hybrids.map(h => ({
          rowId: h.rowId,
          productId: h.productId,
          name: h.name,
          maturity: h.maturity,
          moisturePct: null,
          weightLbs: null,
          yieldBuPerAc: null,
          voided: false
        }));

        mhState.stage = 'blocks';
        renderStage();
      } else {
        console.log('Multi-Hybrid Dev Save', JSON.parse(JSON.stringify(mhState)));
        alert('Dev save only. In the real app this would close and persist to Firestore.');
      }
    });

    resetBtn.addEventListener('click', () => {
      mhState.stage = 'setup';
      mhState.passLengthFt = 600;
      mhState.passWidthFt = 20;
      mhState.checkProductId = null;
      mhState.hybrids = [];
      mhState.blocks = [];
      renderStage();
    });

    closeBtn.addEventListener('click', () => {
      alert('Dev only – this would close the popup in the real app.');
    });

    renderStage();
  </script>
</body>
</html>