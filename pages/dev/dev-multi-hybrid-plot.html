<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FarmVista â€¢ Dev â€¢ Trial Field Yields (Multi-Hybrid)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#3B7E46" />

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest" />
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png" />
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png" />
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css" />
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css" />

  <style>
    :root{
      --card-max: 900px;
      --page-bottom-gap: 72px;
      --accent: #2F6C3C;
    }

    html{-webkit-text-size-adjust:100%}
    body{
      background: var(--app-bg,var(--surface));
      overflow-x:hidden;
    }

    .wrap{
      max-width: var(--card-max);
      margin: 0 auto;
      padding: clamp(14px,3vw,22px);
      padding-bottom: calc(env(safe-area-inset-bottom,0px) + 72px + var(--page-bottom-gap)) !important;
      box-sizing:border-box;
      display:grid;
      gap:16px;
    }

    .hero{
      border:1px solid var(--border);
      border-radius:18px;
      background:var(--surface);
      box-shadow:var(--shadow,0 12px 28px rgba(0,0,0,.12));
      overflow:visible;
    }

    .hero-head{
      display:flex;
      align-items:flex-start;
      gap:12px;
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);
    }

    .hero-head .icon{
      width:24px;
      height:24px;
      color:var(--accent);
      display:grid;
      place-items:center;
      margin-top:2px;
    }

    .hero-head h1{
      margin:0;
      font-size:clamp(20px,3.2vw,26px);
      line-height:1.2;
    }

    .muted{ color:var(--muted,#67706B); }

    .body{
      padding:16px;
      display:grid;
      gap:14px;
    }

    .top-row-actions-left{
      display:flex;
      justify-content:flex-start;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:140px;
      padding:11px 16px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--card-surface,var(--surface));
      font-weight:800;
      font-size:0.95rem;
      text-decoration:none;
      cursor:pointer;
      user-select:none;
      color:var(--text)!important;
      gap:6px;
    }
    .btn-primary{
      border-color:transparent;
      background:#2F6C3C;
      color:#fff!important;
    }
    .btn-quiet{
      min-width:auto;
      padding-inline:10px;
    }
    .btn-small{
      padding:6px 10px;
      min-width:auto;
      font-size:0.8rem;
      border-radius:999px;
    }

    .fields-hero{
      border:1px solid var(--border);
      border-radius:18px;
      background:var(--surface);
      box-shadow:var(--shadow,0 10px 22px rgba(0,0,0,.08));
      overflow:hidden;
    }

    .fields-head{
      padding:12px 16px;
      border-bottom:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .fields-head h2{
      margin:0;
      font-size:1rem;
    }
    .fields-body{
      padding:14px 16px 16px;
      display:grid;
      gap:12px;
    }

    .field-card{
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--card-surface,var(--surface));
      padding:9px 10px;
      display:grid;
      gap:4px;
      font-size:0.9rem;
      cursor:pointer;
      transition:background 0.12s ease, box-shadow 0.12s ease, transform 0.08s ease;
    }
    .field-card:hover{
      background:rgba(0,0,0,.03);
      box-shadow:0 4px 10px rgba(0,0,0,.08);
      transform:translateY(-1px);
    }
    .field-card-top{
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:flex-start;
    }
    .field-card-title{
      font-weight:700;
    }
    .field-card-sub{
      font-size:0.82rem;
      color:var(--muted,#67706B);
    }
    .field-card-note{
      font-size:0.83rem;
      color:var(--muted,#67706B);
      margin-top:2px;
    }

    /* ===== Modal shell â€“ same as real page ===== */

    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.4);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:9999;
    }
    .modal-backdrop.hidden{
      display:none;
    }
    .modal{
      max-width:720px;
      width:96vw;
      background:var(--surface);
      border-radius:16px;
      box-shadow:0 18px 45px rgba(0,0,0,.28);
      border:1px solid var(--border);
      display:flex;
      flex-direction:column;
      overflow:hidden;
      max-height:100vh;
    }
    .modal-header{
      padding:12px 16px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .modal-header h3{
      margin:0;
      font-size:1rem;
    }
    .modal-close{
      border:none;
      background:transparent;
      color:var(--muted,#67706B);
      font-size:0;
      line-height:1;
      cursor:pointer;
      padding:4px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .modal-close svg{
      width:18px;
      height:18px;
      display:block;
    }

    .modal-body{
      padding:14px 16px 10px;
      font-size:0.9rem;
      display:grid;
      gap:10px;
      max-height:calc(100vh - 120px);
      overflow-y:auto;
    }
    .modal-footer{
      padding:10px 16px 12px;
      border-top:1px solid var(--border);
      display:flex;
      justify-content:flex-end;
      gap:10px;
      flex-shrink:0;
      background:var(--surface);
    }

    @media (max-width:640px){
      .modal{
        width:100vw;
        max-width:100vw;
        border-radius:0;
        max-height:100vh;
      }
      .modal-body{
        max-height:calc(100vh - 110px);
      }
    }

    .yield-summary{
      display:grid;
      gap:4px;
    }
    .yield-summary .muted{
      font-size:0.82rem;
    }

    .btn-inline{
      min-width:auto;
      font-size:0.85rem;
      padding:7px 12px;
      border-radius:999px;
    }

    .primary-full-btn{
      margin-top:4px;
      margin-bottom:4px;
      border-radius:999px;
      padding:11px 16px;
      border:none;
      width:100%;
      font-weight:800;
      font-size:0.95rem;
      cursor:pointer;
      background:#2F6C3C;
      color:#fff;
      box-shadow:0 8px 18px rgba(46,123,53,0.35);
    }

    .setup-panel{
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--card-surface,var(--surface));
      padding:10px 12px;
      display:grid;
      gap:10px;
    }
    .setup-row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }
    .setup-field{
      flex:1 1 120px;
    }
    .setup-field label{
      display:block;
      font-size:0.8rem;
      font-weight:600;
      margin-bottom:2px;
    }
    .setup-field input,
    .setup-field select{
      width:100%;
      border-radius:9px;
      border:1px solid var(--border);
      padding:8px 10px;
      font-size:0.9rem;
      background:var(--card-surface,var(--surface));
      color:var(--text);
    }
    .setup-field small{
      display:block;
      font-size:0.75rem;
      color:var(--muted,#67706B);
      margin-top:2px;
    }

    .setup-hybrids-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .setup-hybrids-header h3{
      margin:0;
      font-size:0.9rem;
    }

    .entry-label{
      font-size:0.8rem;
      font-weight:600;
      white-space:nowrap;
    }

    .setup-hybrid-row{
      display:grid;
      grid-template-columns:auto minmax(0,2.3fr) minmax(0,1.1fr) auto;
      gap:6px;
      align-items:center;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--surface-soft,var(--surface));
    }
    .setup-hybrid-row select{
      width:100%;
      border-radius:9px;
      border:1px solid var(--border);
      padding:6px 8px;
      font-size:0.85rem;
      background:var(--card-surface,var(--surface));
      color:var(--text);
    }

    .check-indicator{
      display:inline-flex;
      align-items:center;
      gap:4px;
      font-size:0.78rem;
      white-space:nowrap;
      cursor:pointer;
    }
    .check-dot{
      width:10px;
      height:10px;
      border-radius:999px;
      border:2px solid #9ca3af;
      box-sizing:border-box;
    }
    .check-dot--on{
      border-color:#166534;
      background:#16a34a;
    }

    .row-remove{
      border:none;
      background:transparent;
      color:var(--muted,#67706B);
      font-size:0;
      line-height:1;
      cursor:pointer;
      padding:4px;
      border-radius:999px;
      display:none; /* mobile: hidden */
    }
    .row-remove svg{
      width:14px;
      height:14px;
      display:block;
    }
    @media (min-width:641px){
      .row-remove{
        display:flex;
        align-items:center;
        justify-content:center;
      }
    }

    .setup-errors{
      font-size:0.8rem;
      color:#b3261e;
    }

    .blocks-panel{
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--card-surface,var(--surface));
      padding:10px 12px;
      display:grid;
      gap:8px;
    }
    .blocks-panel-header{
      font-size:0.85rem;
    }

    .yield-block-card{
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--surface-soft,var(--surface));
      padding:8px 10px;
      display:grid;
      gap:6px;
      font-size:0.88rem;
    }
    .yield-block-head{
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:flex-start;
    }
    .yield-block-title{
      font-weight:700;
    }
    .yield-block-sub{
      font-size:0.8rem;
      color:var(--muted,#67706B);
    }

    .badge-check{
      border-radius:999px;
      padding:2px 8px;
      font-size:0.72rem;
      background:#2F6C3C;
      color:#fff;
      text-transform:uppercase;
      letter-spacing:0.06em;
      align-self:flex-start;
      margin-left:4px;
    }
    .badge-void{
      border-radius:999px;
      padding:2px 8px;
      font-size:0.72rem;
      background:#b91c1c;
      color:#fff;
      text-transform:uppercase;
      letter-spacing:0.06em;
      margin-left:4px;
    }

    .field-mini{
      display:flex;
      flex-direction:column;
      gap:3px;
    }
    .field-mini span{
      font-size:0.8rem;
      font-weight:600;
    }
    .input{
      width:100%;
      font:inherit;
      font-size:0.9rem;
      color:var(--text);
      background:var(--card-surface,var(--surface));
      border:1px solid var(--border);
      border-radius:9px;
      padding:8px 10px;
      outline:none;
    }

    .yield-block-grid{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:8px;
      align-items:flex-end;
    }
    @media (max-width:640px){
      .yield-block-grid{
        grid-template-columns:1fr;
      }
    }

    .yield-value{
      font-size:0.85rem;
      font-weight:600;
      margin-top:2px;
    }
    .yield-value.bad{
      color:#b3261e;
    }

    .void-row{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:0.8rem;
    }

    .hidden{display:none;}
  </style>
</head>

<body>
  <fv-shell>
    <div class="wrap">
      <section class="hero">
        <header class="hero-head">
          <div class="icon" aria-hidden="true">ðŸ§ª</div>
          <div>
            <h1>Trial Field Yields (Dev â€“ Multi-Hybrid)</h1>
            <p class="muted">
              Sandbox for multi-hybrid seed plots. Uses the same popup shell as the real page. No Firestore writes here.
            </p>
          </div>
        </header>

        <div class="body">
          <div class="top-row-actions-left">
            <button type="button" class="btn btn-quiet" id="btnOpenModal">
              Open Yield Popup (Dev)
            </button>
          </div>
        </div>
      </section>

      <section class="fields-hero">
        <header class="fields-head">
          <h2>Dev field card</h2>
        </header>
        <div class="fields-body">
          <div class="field-card" id="devFieldCard">
            <div class="field-card-top">
              <div>
                <div class="field-card-title">Divernonâ€“Farmersville â€¢ 0702-Grandmas TestPlot</div>
                <div class="field-card-sub">
                  Trial acres: <strong>20.00 ac</strong> (Max tillable: 39.45)
                </div>
                <div class="field-card-note" id="devFieldSummary"></div>
              </div>
              <div><span class="btn btn-small">View / Add Yield</span></div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </fv-shell>

  <!-- Yield modal -->
  <div id="yieldModalBackdrop" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-labelledby="yieldModalTitle">
    <div class="modal">
      <div class="modal-header">
        <h3 id="yieldModalTitle">0702-Grandmas TestPlot â€¢ Yield Entry</h3>
        <button id="btnYieldClose" type="button" class="modal-close" aria-label="Close">
          <svg viewBox="0 0 16 16" aria-hidden="true">
            <path d="M4.22 4.22a.75.75 0 0 1 1.06 0L8 6.94l2.72-2.72a.75.75 0 1 1 1.06 1.06L9.06 8l2.72 2.72a.75.75 0 0 1-1.06 1.06L8 9.06l-2.72 2.72a.75.75 0 0 1-1.06-1.06L6.94 8 4.22 5.28a.75.75 0 0 1 0-1.06z"></path>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div id="yieldSummary" class="yield-summary"></div>

        <button type="button" class="primary-full-btn" id="btnSetUpPlot">
          + Set Up Plot
        </button>

        <div id="mhStageShell"></div>
      </div>
      <div class="modal-footer">
        <button id="btnResetDev" type="button" class="btn btn-quiet btn-inline">Reset Dev</button>
        <button id="btnYieldOk" type="button" class="btn btn-primary">Save &amp; Close (Dev)</button>
      </div>
    </div>
  </div>

  <script>
    const mhState = {
      cropKind: 'corn',
      stage: 'setup',          // 'setup' | 'blocks'
      passLengthFt: 600,
      passWidthFt: 20,
      checkProductId: null,
      hybrids: [],             // [{ rowId, productId, name, maturity }]
      blocks: []               // [{ rowId, productId, name, maturity, moisturePct, weightLbs, yieldBuPerAc, voided }]
    };

    const mockHybrids = [
      { id: 'P1185Q', name: 'Pioneer P1185Q', maturity: 118 },
      { id: 'P1742Q', name: 'Pioneer P1742Q', maturity: 117 },
      { id: 'P1366Q', name: 'Pioneer P1366Q', maturity: 113 },
      { id: 'DKC6460', name: 'Dekalb DKC6460', maturity: 114 },
      { id: 'DKC6499', name: 'Dekalb DKC6499', maturity: 114 },
      { id: 'AG3640',  name: 'AgriGold 3640',  maturity: 112 }
    ];

    const modalBackdrop = document.getElementById('yieldModalBackdrop');
    const btnOpenModal  = document.getElementById('btnOpenModal');
    const devFieldCard  = document.getElementById('devFieldCard');
    const btnClose      = document.getElementById('btnYieldClose');
    const btnOk         = document.getElementById('btnYieldOk');
    const btnReset      = document.getElementById('btnResetDev');
    const btnSetUpPlot  = document.getElementById('btnSetUpPlot');
    const summaryEl     = document.getElementById('yieldSummary');
    const stageShell    = document.getElementById('mhStageShell');
    const devFieldSummaryEl = document.getElementById('devFieldSummary');

    function nextRowId(){
      return 'row_' + Math.random().toString(36).slice(2,9);
    }

    function openModal(){
      summaryEl.innerHTML = `
        <div>
          <strong>Trial:</strong> Grandmas Test Plot North<br>
          <strong>Field:</strong> Divernon-Farmersville â€¢ 0702-Grandmas TestPlot<br>
          <strong>Trial acres:</strong> 20.00 ac<br>
          <strong>Field tillable:</strong> 39.45 ac
        </div>
        <div class="muted">
          Multi-hybrid dev mode. Set up plot length, width, entries, and check variety. Then weâ€™ll show one yield card
          per entry using weight-only data.
        </div>
      `;
      modalBackdrop.classList.remove('hidden');
      renderStage();
    }

    function closeModal(){
      modalBackdrop.classList.add('hidden');
    }

    btnOpenModal.addEventListener('click', openModal);
    devFieldCard.addEventListener('click', openModal);
    btnClose.addEventListener('click', closeModal);

    btnReset.addEventListener('click', () => {
      mhState.stage = 'setup';
      mhState.passLengthFt = 600;
      mhState.passWidthFt  = 20;
      mhState.checkProductId = null;
      mhState.hybrids = [];
      mhState.blocks  = [];
      renderStage();
      renderDevSummary();
    });

    btnSetUpPlot.addEventListener('click', () => {
      const lengthInput = document.getElementById('mh-length-input');
      if(lengthInput) lengthInput.focus();
    });

    function formatNumber(num, decimals){
      if(num === null || num === undefined || isNaN(num)) return 'â€”';
      return Number(num).toFixed(decimals);
    }

    function formatWithCommas(num){
      if(num === null || num === undefined || isNaN(num)) return '';
      const s = String(Math.round(num));
      return s.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    function calcDevYield({ cropKind, moisturePct, wetWeightLbs, lengthFt, widthFt }){
      if(!moisturePct || !wetWeightLbs || !lengthFt || !widthFt) return null;
      const areaAc = (lengthFt * widthFt) / 43560;
      if(areaAc <= 0) return null;

      const stdMoist = cropKind === 'soy' ? 13.0 : 15.0;
      const testWt   = cropKind === 'soy' ? 60.0 : 56.0;
      const m = Number(moisturePct);
      const w = Number(wetWeightLbs);
      if(m <= 0 || m >= 80 || w <= 0) return null;

      const used = Math.max(m, stdMoist);
      const dryWeightStd = w * (100 - used) / (100 - stdMoist);
      const bu = dryWeightStd / testWt;
      return bu / areaAc;
    }

    function renderDevSummary(){
      if(!devFieldSummaryEl) return;
      if(!mhState.hybrids.length){
        devFieldSummaryEl.textContent = '';
        return;
      }
      const lines = mhState.hybrids.map((h, idx) => {
        if(!h.productId) return null;
        const isCheck = mhState.checkProductId && h.productId === mhState.checkProductId;
        const parts = [];
        parts.push(`Entry ${idx+1}: ${h.name || 'Variety'}`);
        if(h.maturity != null) parts.push(`(${h.maturity} RM)`);
        if(isCheck) parts.push('â€“ CHECK');
        return parts.join(' ');
      }).filter(Boolean);
      devFieldSummaryEl.innerHTML = lines.join('<br>');
    }

    function renderStage(){
      if(mhState.stage === 'setup'){
        renderSetup();
      }else{
        renderBlocks();
      }
      renderDevSummary();
    }

    function renderSetup(){
      const hybrids = mhState.hybrids;
      const lengthFt = mhState.passLengthFt;
      const widthFt  = mhState.passWidthFt;
      let html = '';

      html += `
        <div class="setup-panel">
          <div class="setup-row">
            <div class="setup-field">
              <label for="mh-length-input">Plot length (ft)</label>
              <input id="mh-length-input" type="number" min="1" step="1" value="${lengthFt}">
              <small>Same length for every strip in this plot.</small>
            </div>
            <div class="setup-field">
              <label for="mh-width-input">Pass width (ft)</label>
              <input id="mh-width-input" type="number" min="1" step="1" value="${widthFt}">
              <small>Planter/harvest width, e.g. 20 ft, 30 ft.</small>
            </div>
          </div>

          <div class="setup-hybrids-header">
            <h3>Varieties in this plot (planting order)</h3>
            <button type="button" class="btn btn-small btn-quiet" id="mh-add-row-btn">+ Add variety</button>
          </div>
      `;

      if(!hybrids.length){
        html += `<p class="muted">No entries yet. Tap <strong>+ Add variety</strong> to start.</p>`;
      }else{
        hybrids.forEach((hyb, idx) => {
          const isCheckRow = hyb.productId && mhState.checkProductId === hyb.productId;
          html += `
            <div class="setup-hybrid-row" data-row-id="${hyb.rowId}">
              <div class="entry-label">Entry ${idx+1}</div>
              <div>
                <select id="mh-hybrid-select-${hyb.rowId}">
                  <option value="">Select varietyâ€¦</option>
                  ${mockHybrids.map(opt => `
                    <option value="${opt.id}" ${opt.id === hyb.productId ? 'selected' : ''}>
                      ${opt.name} (${opt.maturity} RM)
                    </option>
                  `).join('')}
                </select>
              </div>
              <div class="check-indicator" data-row-id="${hyb.rowId}">
                <span class="check-dot ${isCheckRow ? 'check-dot--on' : ''}"></span>
                <span>Check</span>
              </div>
              <button type="button" class="row-remove" data-row-id="${hyb.rowId}" aria-label="Remove entry">
                <svg viewBox="0 0 16 16" aria-hidden="true">
                  <path d="M4.22 4.22a.75.75 0 0 1 1.06 0L8 6.94l2.72-2.72a.75.75 0 1 1 1.06 1.06L9.06 8l2.72 2.72a.75.75 0 0 1-1.06 1.06L8 9.06l-2.72 2.72a.75.75 0 0 1-1.06-1.06L6.94 8 4.22 5.28a.75.75 0 0 1 0-1.06z"></path>
                </svg>
              </button>
            </div>
          `;
        });
      }

      html += `<div class="setup-errors" id="mh-setup-errors"></div></div>`;
      stageShell.innerHTML = html;

      document.getElementById('mh-length-input').addEventListener('input', e => {
        mhState.passLengthFt = Number(e.target.value) || 0;
      });
      document.getElementById('mh-width-input').addEventListener('input', e => {
        mhState.passWidthFt = Number(e.target.value) || 0;
      });

      document.getElementById('mh-add-row-btn').addEventListener('click', () => {
        mhState.hybrids.push({
          rowId: nextRowId(),
          productId: '',
          name: '',
          maturity: null
        });
        renderStage();
      });

      mhState.hybrids.forEach(hyb => {
        const sel = document.getElementById(`mh-hybrid-select-${hyb.rowId}`);
        if(sel){
          sel.addEventListener('change', e => {
            const val = e.target.value;
            const found = mockHybrids.find(m => m.id === val);
            hyb.productId = val;
            hyb.name = found ? found.name : '';
            hyb.maturity = found ? found.maturity : null;
            renderStage();
          });
        }

        const checkEl = stageShell.querySelector(`.check-indicator[data-row-id="${hyb.rowId}"]`);
        if(checkEl){
          checkEl.addEventListener('click', () => {
            if(!hyb.productId) return;
            mhState.checkProductId = hyb.productId;
            renderStage();
          });
        }

        const removeBtn = stageShell.querySelector(`.row-remove[data-row-id="${hyb.rowId}"]`);
        if(removeBtn){
          removeBtn.addEventListener('click', () => {
            const idx = mhState.hybrids.findIndex(h => h.rowId === hyb.rowId);
            if(idx !== -1) mhState.hybrids.splice(idx,1);
            if(mhState.hybrids.every(h => h.productId !== mhState.checkProductId)){
              mhState.checkProductId = null;
            }
            renderStage();
          });
        }
      });
    }

    function validateSetup(){
      const errors = [];
      if(!mhState.passLengthFt || mhState.passLengthFt <= 0){
        errors.push('Enter a positive plot length.');
      }
      if(!mhState.passWidthFt || mhState.passWidthFt <= 0){
        errors.push('Enter a positive pass width.');
      }
      if(!mhState.hybrids.length){
        errors.push('Add at least one entry.');
      }else{
        mhState.hybrids.forEach((h, idx) => {
          if(!h.productId){
            errors.push(`Entry ${idx+1}: select a variety.`);
          }
        });
      }
      if(!mhState.checkProductId){
        errors.push('Pick one check variety (tied to the variety).');
      }
      const box = document.getElementById('mh-setup-errors');
      if(box){
        box.innerHTML = errors.map(e => 'â€¢ ' + e).join('<br>');
      }
      return errors.length === 0;
    }

    function renderBlocks(){
      const blocks = mhState.blocks;
      const lengthFt = mhState.passLengthFt;
      const widthFt  = mhState.passWidthFt;
      let html = '';

      html += `
        <div class="blocks-panel">
          <div class="blocks-panel-header">
            Plot length: <strong>${lengthFt} ft</strong> â€¢ Pass width: <strong>${widthFt} ft</strong> â€¢ Area per strip:
            <strong>${formatNumber((lengthFt*widthFt)/43560,3)} ac</strong>
          </div>
      `;

      if(!blocks.length){
        html += `<p class="muted">No blocks generated. Hit Reset Dev and try setup again.</p>`;
      }else{
        blocks.forEach((blk, idx) => {
          const isCheck = mhState.checkProductId && blk.productId === mhState.checkProductId;
          const badYield = blk.yieldBuPerAc != null && (blk.yieldBuPerAc < 50 || blk.yieldBuPerAc > 400);
          html += `
            <div class="yield-block-card" data-row-id="${blk.rowId}">
              <div class="yield-block-head">
                <div>
                  <div class="yield-block-title">
                    Entry ${idx+1} Â· ${blk.name || 'Variety'}
                    ${isCheck ? '<span class="badge-check">Check</span>' : ''}
                    ${blk.voided ? '<span class="badge-void">Voided</span>' : ''}
                  </div>
                  <div class="yield-block-sub">
                    ${blk.maturity ? `${blk.maturity} RM` : ''}
                  </div>
                </div>
              </div>
              <div class="yield-block-grid">
                <label class="field-mini">
                  <span>Moisture %</span>
                  <input type="number" step="0.01" min="5" max="40"
                    class="input" id="mh-moist-${blk.rowId}" value="${blk.moisturePct ?? ''}">
                </label>
                <label class="field-mini">
                  <span>Weight (Lbs)</span>
                  <input type="number" step="1" min="0"
                    class="input" id="mh-weight-${blk.rowId}" value="${blk.weightLbs ?? ''}">
                </label>
                <div class="field-mini">
                  <span>Yield (bu/ac)</span>
                  <div id="mh-yield-${blk.rowId}" class="yield-value ${badYield ? 'bad' : ''}">
                    ${blk.yieldBuPerAc != null ? formatNumber(blk.yieldBuPerAc,2) : 'â€”'}
                  </div>
                </div>
              </div>
              <div class="void-row">
                <input type="checkbox" id="mh-void-${blk.rowId}" ${blk.voided ? 'checked' : ''}>
                <label for="mh-void-${blk.rowId}">Void this hybrid</label>
              </div>
            </div>
          `;
        });
      }

      html += `</div>`;
      stageShell.innerHTML = html;

      mhState.blocks.forEach(blk => {
        const moistEl = document.getElementById(`mh-moist-${blk.rowId}`);
        const weightEl = document.getElementById(`mh-weight-${blk.rowId}`);
        const yieldEl  = document.getElementById(`mh-yield-${blk.rowId}`);
        const voidEl   = document.getElementById(`mh-void-${blk.rowId}`);

        function recalc(){
          blk.yieldBuPerAc = calcDevYield({
            cropKind: mhState.cropKind,
            moisturePct: blk.moisturePct,
            wetWeightLbs: blk.weightLbs,
            lengthFt: mhState.passLengthFt,
            widthFt: mhState.passWidthFt
          });
          if(yieldEl){
            if(blk.yieldBuPerAc != null){
              yieldEl.textContent = formatNumber(blk.yieldBuPerAc,2);
              const bad = blk.yieldBuPerAc < 50 || blk.yieldBuPerAc > 400;
              yieldEl.classList.toggle('bad', bad);
            }else{
              yieldEl.textContent = 'â€”';
              yieldEl.classList.remove('bad');
            }
          }
        }

        if(moistEl){
          moistEl.addEventListener('input', e => {
            let v = e.target.value;
            v = v.replace(/[^0-9.]/g, '');
            const parts = v.split('.');
            if(parts.length > 2){
              v = parts[0] + '.' + parts.slice(1).join('');
            }
            if(v.includes('.')){
              const [intPart, fracRaw=''] = v.split('.');
              const frac = fracRaw.slice(0, 2); // max 2 decimals
              v = frac === '' ? intPart + '.' : intPart + '.' + frac;
            }
            e.target.value = v;
            blk.moisturePct = v === '' ? null : Number(v);
            recalc();
          });
        }

        if(weightEl){
          weightEl.addEventListener('input', e => {
            let v = e.target.value;
            v = v.replace(/\D/g, ''); // whole numbers only
            e.target.value = v;
            blk.weightLbs = v === '' ? null : Number(v);
            recalc();
          });
          weightEl.addEventListener('blur', e => {
            if(blk.weightLbs != null){
              e.target.value = formatWithCommas(blk.weightLbs);
            }
          });
        }

        if(voidEl){
          voidEl.addEventListener('change', e => {
            blk.voided = e.target.checked;
            renderBlocks(); // redraw to update Voided badge
          });
        }
      });
    }

    btnOk.addEventListener('click', () => {
      if(mhState.stage === 'setup'){
        if(!validateSetup()) return;
        mhState.blocks = mhState.hybrids.map(h => ({
          rowId: h.rowId,
          productId: h.productId,
          name: h.name,
          maturity: h.maturity,
          moisturePct: null,
          weightLbs: null,
          yieldBuPerAc: null,
          voided: false
        }));
        mhState.stage = 'blocks';
        renderStage();
        return;
      }

      // stage === 'blocks'
      console.log('Multi-Hybrid Dev Save', JSON.parse(JSON.stringify(mhState)));
      alert('Dev save only. In the real app this would save to Firestore and close.');
      closeModal();
    });

    // initial render
    renderStage();
  </script>
</body>
</html>
