<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FarmVista • Dev • Multi-Hybrid Plot Setup</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#3B7E46" />

  <!-- ABSOLUTE PATHS (match your other pages) -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest" />
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png" />
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png" />
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css" />
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css" />

  <style>
    :root {
      --card-max: 900px;
      --page-bottom-gap: 40px;
    }

    body {
      background: var(--page-bg, #f3f3f1);
    }

    .dev-shell {
      min-height: 100vh;
      padding: 1.5rem 1rem 3rem;
      display: flex;
      align-items: flex-start;
      justify-content: center;
    }

    .dev-inner {
      width: 100%;
      max-width: 1100px;
    }

    .dev-header {
      margin-bottom: 1rem;
    }

    .dev-header h1 {
      font-size: 1.4rem;
      font-weight: 600;
      margin: 0 0 0.25rem;
    }

    .dev-header p {
      margin: 0;
      font-size: 0.9rem;
      color: #555;
    }

    /* Fake "page behind modal" card */
    .dev-page-card {
      background: #fff;
      border-radius: 18px;
      padding: 1rem 1.25rem 1.5rem;
      box-shadow: 0 10px 30px rgba(0,0,0,0.06);
      position: relative;
      min-height: 280px;
    }

    /* Modal shell (matches screenshot feel) */
    .yield-modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.30);
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding-top: 2.5rem;
      z-index: 30;
    }

    .yield-modal {
      background: #fff;
      border-radius: 18px;
      width: 100%;
      max-width: 860px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.18);
      display: flex;
      flex-direction: column;
      max-height: calc(100vh - 4rem);
      overflow: hidden;
    }

    .yield-modal-header {
      padding: 0.9rem 1.5rem;
      border-bottom: 1px solid rgba(15,23,42,0.08);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .yield-modal-title {
      font-size: 0.95rem;
      font-weight: 600;
    }

    .yield-modal-close {
      border: none;
      background: transparent;
      cursor: pointer;
      padding: 0.25rem;
      line-height: 1;
    }

    .yield-modal-body {
      padding: 1.25rem 1.5rem 1rem;
      overflow-y: auto;
    }

    .yield-modal-footer {
      padding: 0.9rem 1.5rem 1.2rem;
      border-top: 1px solid rgba(15,23,42,0.08);
      display: flex;
      justify-content: flex-end;
      gap: 0.5rem;
    }

    /* Header summary inside modal */
    .trial-summary {
      font-size: 0.88rem;
      margin-bottom: 0.9rem;
    }

    .trial-summary-row {
      display: flex;
      flex-wrap: wrap;
      column-gap: 1.5rem;
      row-gap: 0.25rem;
    }

    .trial-summary dt {
      font-weight: 600;
      margin-right: 0.25rem;
    }

    .trial-summary dd {
      margin: 0;
    }

    .trial-summary small {
      color: #555;
    }

    /* Green full-width action button (like your Add Trial Block) */
    .primary-full-btn {
      margin-top: 0.75rem;
      margin-bottom: 0.75rem;
      border-radius: 999px;
      padding: 0.75rem 1.25rem;
      border: none;
      width: 100%;
      font-weight: 600;
      font-size: 0.98rem;
      cursor: pointer;
      background: #2e7b35;
      color: #fff;
      box-shadow: 0 8px 18px rgba(46,123,53,0.35);
    }

    .primary-full-btn:disabled {
      opacity: 0.55;
      cursor: default;
      box-shadow: none;
    }

    .muted-note {
      font-size: 0.82rem;
      color: #555;
    }

    /* Setup view */
    .setup-panel {
      border-radius: 14px;
      background: #f6f6f4;
      padding: 0.9rem 1rem 1rem;
      margin-top: 0.25rem;
    }

    .setup-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }

    .setup-field {
      flex: 1 1 120px;
    }

    .setup-field label {
      display: block;
      font-size: 0.8rem;
      font-weight: 600;
      margin-bottom: 0.15rem;
    }

    .setup-field input,
    .setup-field select {
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(15,23,42,0.25);
      font-size: 0.88rem;
      padding: 0.45rem 0.75rem;
      outline: none;
    }

    .setup-field small {
      display: block;
      margin-top: 0.1rem;
      font-size: 0.75rem;
      color: #666;
    }

    .setup-hybrids-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 0.5rem;
      margin-bottom: 0.25rem;
    }

    .setup-hybrids-header h3 {
      font-size: 0.9rem;
      margin: 0;
    }

    .text-pill {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: 0.15rem 0.55rem;
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      background: #e5e7eb;
      color: #374151;
    }

    .btn-link-quiet {
      border: none;
      background: none;
      font-size: 0.82rem;
      cursor: pointer;
      padding: 0.15rem 0.25rem;
      color: #134e19;
    }

    .setup-hybrid-row {
      display: grid;
      grid-template-columns: minmax(0, 2.1fr) minmax(0, 0.8fr) auto;
      gap: 0.5rem;
      align-items: center;
      padding: 0.35rem 0.5rem;
      border-radius: 999px;
      background: #ffffff;
      border: 1px solid rgba(15,23,42,0.10);
      margin-bottom: 0.4rem;
    }

    .setup-hybrid-row select {
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(15,23,42,0.25);
      font-size: 0.85rem;
      padding: 0.35rem 0.6rem;
    }

    .check-radio-wrap {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.78rem;
      white-space: nowrap;
    }

    .check-radio-wrap input[type="radio"] {
      accent-color: #2e7b35;
    }

    .setup-hybrid-row button {
      border-radius: 999px;
      border: none;
      font-size: 0.78rem;
      padding: 0.3rem 0.5rem;
      cursor: pointer;
      background: #f97373;
      color: #fff;
    }

    .setup-errors {
      margin-top: 0.4rem;
      font-size: 0.8rem;
      color: #9b1c1c;
    }

    /* Blocks view (after setup) */

    .blocks-panel {
      margin-top: 0.5rem;
    }

    .blocks-panel-header {
      font-size: 0.87rem;
      margin-bottom: 0.5rem;
    }

    .block-card {
      border-radius: 14px;
      background: #f6f6f4;
      padding: 0.7rem 0.9rem 0.8rem;
      margin-bottom: 0.5rem;
    }

    .block-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.4rem;
    }

    .block-title {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .block-subtitle {
      font-size: 0.78rem;
      color: #555;
    }

    .badge-check {
      border-radius: 999px;
      padding: 0.1rem 0.55rem;
      font-size: 0.72rem;
      background: #2e7b35;
      color: #fff;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .badge-void {
      border-radius: 999px;
      padding: 0.1rem 0.55rem;
      font-size: 0.72rem;
      background: #b91c1c;
      color: #fff;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      margin-left: 0.35rem;
    }

    .block-body {
      display: flex;
      flex-wrap: wrap;
      gap: 0.6rem;
      align-items: flex-end;
    }

    .block-field {
      flex: 1 1 110px;
    }

    .block-field label {
      display: block;
      font-size: 0.78rem;
      font-weight: 600;
      margin-bottom: 0.1rem;
    }

    .block-field input {
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(15,23,42,0.25);
      font-size: 0.85rem;
      padding: 0.35rem 0.6rem;
      outline: none;
    }

    .block-yield {
      flex: 0 0 130px;
      font-size: 0.82rem;
      font-weight: 600;
    }

    .block-yield span {
      display: block;
      font-size: 0.78rem;
      font-weight: 400;
      color: #555;
    }

    .block-void-toggle {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      font-size: 0.78rem;
    }

    .block-void-toggle input[type="checkbox"] {
      accent-color: #b91c1c;
    }

    .block-out-of-range {
      color: #b91c1c;
    }

    .btn-secondary {
      border-radius: 999px;
      padding: 0.55rem 1.1rem;
      font-size: 0.88rem;
      font-weight: 500;
      border: 1px solid rgba(15,23,42,0.2);
      background: #fff;
      cursor: pointer;
    }

    .btn-primary {
      border-radius: 999px;
      padding: 0.55rem 1.4rem;
      font-size: 0.9rem;
      font-weight: 600;
      border: none;
      background: #2e7b35;
      color: #fff;
      cursor: pointer;
      box-shadow: 0 6px 15px rgba(46,123,53,0.35);
    }

    .btn-primary:disabled {
      opacity: 0.6;
      box-shadow: none;
      cursor: default;
    }

    @media (max-width: 640px) {
      .yield-modal {
        max-width: 100%;
        border-radius: 0;
        max-height: 100vh;
      }

      .yield-modal-backdrop {
        padding-top: 0;
      }
    }
  </style>
</head>
<body>
  <div class="dev-shell">
    <div class="dev-inner">
      <header class="dev-header">
        <h1>Dev • Multi-Hybrid Plot Setup</h1>
        <p>This page only simulates the Trial Field Yield popup so we can design the multi-hybrid plot flow.</p>
      </header>

      <div class="dev-page-card">
        <p class="muted-note">
          Imagine the normal Trial Field Yields screen behind this. The modal below matches the size and layout of the
          yield pop-up you use today.
        </p>
      </div>
    </div>
  </div>

  <!-- Always-open modal for dev/testing -->
  <div class="yield-modal-backdrop" id="mh-backdrop">
    <div class="yield-modal" id="mh-modal">
      <div class="yield-modal-header">
        <div class="yield-modal-title" id="mh-modal-title">
          0702-Grandmas TestPlot • Yield Entry (Dev – Multi-Hybrid)
        </div>
        <button class="yield-modal-close" type="button" id="mh-close-btn" aria-label="Close">
          <!-- simple X icon -->
          <svg width="18" height="18" viewBox="0 0 20 20" aria-hidden="true">
            <path d="M5 5l10 10M15 5L5 15" fill="none" stroke="#111827" stroke-width="1.6" stroke-linecap="round"/>
          </svg>
        </button>
      </div>

      <div class="yield-modal-body">
        <!-- Trial + field summary -->
        <section class="trial-summary">
          <dl class="trial-summary-row">
            <div>
              <dt>Trial:</dt>
              <dd>Grandmas Test Plot North</dd>
            </div>
            <div>
              <dt>Field:</dt>
              <dd>Divernon–Farmersville • 0702-Grandmas TestPlot</dd>
            </div>
          </dl>
          <dl class="trial-summary-row">
            <div>
              <dt>Trial acres:</dt>
              <dd>20.00 ac</dd>
            </div>
            <div>
              <dt>Field tillable:</dt>
              <dd>39.45 ac</dd>
            </div>
          </dl>
          <p class="muted-note">
            Add one or more trial blocks for this field. For Multi-Hybrid Seed trials, use <strong>Set Up Plot</strong>
            to define varieties, pick your check, and set plot length + width. Each hybrid will then get its own block
            using weight-only data.
          </p>
        </section>

        <!-- Stage-specific content -->
        <div id="mh-stage-shell"></div>
      </div>

      <div class="yield-modal-footer">
        <button type="button" class="btn-secondary" id="mh-reset-btn">Reset Dev</button>
        <button type="button" class="btn-primary" id="mh-save-btn" disabled>Save &amp; Close (Dev)</button>
      </div>
    </div>
  </div>

  <script>
    // Simple dev state – this does NOT talk to Firestore
    const mhState = {
      cropKind: 'corn', // 'corn' or 'soy'
      stage: 'setup',   // 'setup' | 'blocks'
      passLengthFt: 600,
      passWidthFt: 20,
      hybrids: [],      // in setup: [{ rowId, productId, name, maturity, isCheck }]
      blocks: []        // in blocks: [{ rowId, productId, name, maturity, isCheck, moisture, weightLbs, yield, voided }]
    };

    // Mock "database" varieties for dev use
    const mockHybrids = [
      { id: 'P1185Q', name: 'Pioneer P1185Q', maturity: 118 },
      { id: 'P1742Q', name: 'Pioneer P1742Q', maturity: 117 },
      { id: 'P1366Q', name: 'Pioneer P1366Q', maturity: 113 },
      { id: 'DKC6460', name: 'Dekalb DKC6460', maturity: 114 },
      { id: 'DKC6499', name: 'Dekalb DKC6499', maturity: 114 },
      { id: 'AG3640', name: 'AgriGold 3640', maturity: 112 }
    ];

    const stageShell = document.getElementById('mh-stage-shell');
    const saveBtn = document.getElementById('mh-save-btn');
    const resetBtn = document.getElementById('mh-reset-btn');
    const closeBtn = document.getElementById('mh-close-btn');

    // Helpers -------------------------------------------------------------

    function formatNumber(num, decimals = 1) {
      if (num === null || num === undefined || isNaN(num)) return '—';
      return Number(num).toFixed(decimals);
    }

    function formatWithCommas(num, decimals = 0) {
      if (num === null || num === undefined || isNaN(num)) return '';
      const fixed = Number(num).toFixed(decimals);
      const parts = fixed.split('.');
      parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
      return parts.join(decimals ? '.' : '');
    }

    // Simple dev yield math – weight-only
    // For corn: dry to 15% moisture, 56 lbs/bu
    // For soy:  dry to 13% moisture, 60 lbs/bu
    function calcDevYieldBuPerAc({ cropKind, moisturePct, wetWeightLbs, lengthFt, widthFt }) {
      if (!moisturePct || !wetWeightLbs || !lengthFt || !widthFt) return null;

      const areaAc = (lengthFt * widthFt) / 43560;
      if (areaAc <= 0) return null;

      const stdMoist = cropKind === 'soy' ? 13.0 : 15.0;
      const testWt = cropKind === 'soy' ? 60.0 : 56.0;

      const m = Number(moisturePct);
      const w = Number(wetWeightLbs);

      // Protect from nonsense
      if (m <= 0 || m >= 80 || w <= 0) return null;

      // Dry-weight method: shrink to standard moisture, no over-dry credit
      const usedMoist = Math.max(m, stdMoist);
      const dryWeightAtStd = w * (100 - usedMoist) / (100 - stdMoist); // lbs at std moisture
      const bu = dryWeightAtStd / testWt;
      const buPerAc = bu / areaAc;
      return buPerAc;
    }

    function validateMoisture(m) {
      if (m === '' || m === null || m === undefined) return false;
      const val = Number(m);
      return val >= 5 && val <= 40;
    }

    function validateYieldRange(y) {
      if (y === null || y === undefined || isNaN(y)) return false;
      return y >= 50 && y <= 400;
    }

    function nextRowId() {
      return 'row_' + Math.random().toString(36).slice(2, 9);
    }

    // Rendering -----------------------------------------------------------

    function renderStage() {
      if (mhState.stage === 'setup') {
        renderSetup();
        saveBtn.textContent = 'Save Plot Setup (Dev)';
        saveBtn.disabled = false; // you can always "save" in dev to jump to blocks
      } else {
        renderBlocks();
        saveBtn.textContent = 'Save & Close (Dev)';
        updateSaveEnabled();
      }
    }

    function renderSetup() {
      const hybrids = mhState.hybrids;
      const lengthFt = mhState.passLengthFt;
      const widthFt = mhState.passWidthFt;

      let html = '';

      html += `
        <button type="button" class="primary-full-btn" id="mh-setup-btn">
          + Set Up Plot
        </button>
        <p class="muted-note">
          For multi-hybrid seed plots, <strong>Set Up Plot</strong> lets you define every variety in planting order,
          pick a single check hybrid, and set a shared plot length and pass width. After setup, each hybrid becomes its
          own weight-data block with moisture + weight only.
        </p>

        <div class="setup-panel">
          <div class="setup-row">
            <div class="setup-field">
              <label for="mh-length-input">Plot length (ft)</label>
              <input id="mh-length-input" type="number" min="1" step="1" value="${lengthFt}">
              <small>Same length used for every hybrid strip in this plot.</small>
            </div>
            <div class="setup-field">
              <label for="mh-width-input">Pass width (ft)</label>
              <input id="mh-width-input" type="number" min="1" step="1" value="${widthFt}">
              <small>Typical planter/harvest width, e.g. 20 ft, 30 ft, etc.</small>
            </div>
          </div>

          <div class="setup-hybrids-header">
            <h3>Varieties in this plot (planting order)</h3>
            <button type="button" class="btn-link-quiet" id="mh-add-row-btn">+ Add variety</button>
          </div>
          <div class="muted-note" style="margin-bottom:0.4rem;">
            First entry = first planted; 10th entry = 10th planted. Exactly one row will be marked as the <span class="text-pill">Check</span>.
          </div>
      `;

      if (!hybrids.length) {
        html += `
          <p class="muted-note" id="mh-no-rows-note">
            No varieties added yet. Click <strong>+ Add variety</strong> to start building the plot in planting order.
          </p>
        `;
      } else {
        hybrids.forEach((hyb, idx) => {
          const selectId = `mh-hybrid-select-${hyb.rowId}`;
          const radioId = `mh-check-radio-${hyb.rowId}`;
          html += `
            <div class="setup-hybrid-row" data-row-id="${hyb.rowId}">
              <div>
                <select id="${selectId}">
                  <option value="">Select variety…</option>
                  ${mockHybrids.map(opt => `
                    <option value="${opt.id}" ${opt.id === hyb.productId ? 'selected' : ''}>
                      ${opt.name} (${opt.maturity} RM)
                    </option>
                  `).join('')}
                </select>
              </div>
              <div class="check-radio-wrap">
                <input type="radio" name="mh-check" id="${radioId}" ${hyb.isCheck ? 'checked' : ''}>
                <label for="${radioId}">Check</label>
              </div>
              <div style="text-align:right;">
                <button type="button" data-row-id="${hyb.rowId}">Remove</button>
              </div>
            </div>
          `;
        });
      }

      html += `
          <div class="setup-errors" id="mh-setup-errors"></div>
        </div>
      `;

      stageShell.innerHTML = html;

      // Wire events
      document.getElementById('mh-setup-btn').addEventListener('click', () => {
        // no-op; the controls below are the real setup – button here just focuses the first input
        const firstInput = document.getElementById('mh-length-input');
        if (firstInput) firstInput.focus();
      });

      document.getElementById('mh-length-input').addEventListener('input', (e) => {
        mhState.passLengthFt = Number(e.target.value) || 0;
      });

      document.getElementById('mh-width-input').addEventListener('input', (e) => {
        mhState.passWidthFt = Number(e.target.value) || 0;
      });

      const addRowBtn = document.getElementById('mh-add-row-btn');
      addRowBtn.addEventListener('click', () => {
        mhState.hybrids.push({
          rowId: nextRowId(),
          productId: '',
          name: '',
          maturity: null,
          isCheck: mhState.hybrids.length === 0 // first row defaults to check
        });
        renderStage();
      });

      // Hybrid select + check radios + remove buttons
      mhState.hybrids.forEach((hyb) => {
        const selectEl = document.getElementById(`mh-hybrid-select-${hyb.rowId}`);
        if (selectEl) {
          selectEl.addEventListener('change', (e) => {
            const val = e.target.value;
            const found = mockHybrids.find(m => m.id === val);
            hyb.productId = val;
            hyb.name = found ? found.name : '';
            hyb.maturity = found ? found.maturity : null;
          });
        }

        const radioEl = document.getElementById(`mh-check-radio-${hyb.rowId}`);
        if (radioEl) {
          radioEl.addEventListener('change', () => {
            mhState.hybrids.forEach(h => h.isCheck = (h.rowId === hyb.rowId));
            renderStage();
          });
        }

        const removeBtn = stageShell.querySelector(`.setup-hybrid-row[data-row-id="${hyb.rowId}"] button[data-row-id="${hyb.rowId}"]`);
        if (removeBtn) {
          removeBtn.addEventListener('click', () => {
            const idx = mhState.hybrids.findIndex(h => h.rowId === hyb.rowId);
            if (idx !== -1) {
              mhState.hybrids.splice(idx, 1);
              // Ensure we still have at most one check
              if (mhState.hybrids.length && !mhState.hybrids.some(h => h.isCheck)) {
                mhState.hybrids[0].isCheck = true;
              }
              renderStage();
            }
          });
        }
      });

      // When user clicks Save (footer), we'll validate and move stage -> blocks
    }

    function renderBlocks() {
      const blocks = mhState.blocks;
      const lengthFt = mhState.passLengthFt;
      const widthFt = mhState.passWidthFt;

      let html = '';

      html += `
        <button type="button" class="primary-full-btn" id="mh-edit-setup-btn">
          Edit Plot Setup (Dev only)
        </button>
        <p class="muted-note">
          Each hybrid below is a weight-only block. Enter moisture and total weight for the strip. This dev page uses a
          simple yield formula to dry corn to 15% or beans to 13% and calculate bu/ac from the shared plot length and
          width.
        </p>

        <div class="blocks-panel">
          <div class="blocks-panel-header">
            Plot length: <strong>${lengthFt} ft</strong> • Pass width: <strong>${widthFt} ft</strong> • Area per strip:
            <strong>${formatNumber((lengthFt * widthFt) / 43560, 3)} ac</strong>
          </div>
      `;

      if (!blocks.length) {
        html += `<p class="muted-note">No blocks generated. Use the dev Reset button and run setup again.</p>`;
      } else {
        blocks.forEach((blk, idx) => {
          const outOfRange = blk.yieldBuPerAc != null && !validateYieldRange(blk.yieldBuPerAc);
          html += `
            <div class="block-card" data-row-id="${blk.rowId}">
              <div class="block-header">
                <div>
                  <div class="block-title">
                    ${blk.name || 'Variety ' + (idx + 1)}
                    ${blk.isCheck ? '<span class="badge-check">Check</span>' : ''}
                    ${blk.voided ? '<span class="badge-void">Voided</span>' : ''}
                  </div>
                  <div class="block-subtitle">
                    ${blk.maturity ? `${blk.maturity} RM` : ''}
                  </div>
                </div>
              </div>
              <div class="block-body">
                <div class="block-field">
                  <label for="mh-moist-${blk.rowId}">Moisture %</label>
                  <input id="mh-moist-${blk.rowId}" type="number" step="0.1" min="5" max="40"
                         value="${blk.moisturePct ?? ''}">
                </div>
                <div class="block-field">
                  <label for="mh-weight-${blk.rowId}">Weight (lbs)</label>
                  <input id="mh-weight-${blk.rowId}" type="text"
                         value="${blk.weightLbs ? formatWithCommas(blk.weightLbs, 0) : ''}">
                </div>
                <div class="block-yield">
                  Yield (bu/ac)
                  <span class="${outOfRange ? 'block-out-of-range' : ''}">
                    ${blk.yieldBuPerAc != null ? formatNumber(blk.yieldBuPerAc, 1) : '—'}
                  </span>
                </div>
                <div class="block-void-toggle">
                  <input id="mh-void-${blk.rowId}" type="checkbox" ${blk.voided ? 'checked' : ''}>
                  <label for="mh-void-${blk.rowId}">Void this hybrid</label>
                </div>
              </div>
            </div>
          `;
        });
      }

      html += `</div>`;

      stageShell.innerHTML = html;

      document.getElementById('mh-edit-setup-btn').addEventListener('click', () => {
        mhState.stage = 'setup';
        // Rebuild setup hybrids from blocks (dev only)
        mhState.hybrids = mhState.blocks.map(b => ({
          rowId: b.rowId,
          productId: b.productId,
          name: b.name,
          maturity: b.maturity,
          isCheck: b.isCheck
        }));
        renderStage();
      });

      // Wire inputs
      mhState.blocks.forEach((blk) => {
        const moistEl = document.getElementById(`mh-moist-${blk.rowId}`);
        const weightEl = document.getElementById(`mh-weight-${blk.rowId}`);
        const voidEl = document.getElementById(`mh-void-${blk.rowId}`);

        if (moistEl) {
          moistEl.addEventListener('input', (e) => {
            blk.moisturePct = e.target.value === '' ? null : Number(e.target.value);
            recalcBlockYield(blk);
            renderBlocks(); // simple redraw for dev
          });
        }

        if (weightEl) {
          weightEl.addEventListener('input', (e) => {
            const raw = e.target.value.replace(/,/g, '');
            const num = raw === '' ? null : Number(raw);
            blk.weightLbs = num;
            recalcBlockYield(blk);
            // keep cursor near end by re-rendering value only
            renderBlocks();
          });
        }

        if (voidEl) {
          voidEl.addEventListener('change', (e) => {
            blk.voided = e.target.checked;
            updateSaveEnabled();
          });
        }
      });

      updateSaveEnabled();
    }

    function recalcBlockYield(blk) {
      const y = calcDevYieldBuPerAc({
        cropKind: mhState.cropKind,
        moisturePct: blk.moisturePct,
        wetWeightLbs: blk.weightLbs,
        lengthFt: mhState.passLengthFt,
        widthFt: mhState.passWidthFt
      });
      blk.yieldBuPerAc = y;
    }

    function updateSaveEnabled() {
      if (mhState.stage !== 'blocks') {
        saveBtn.disabled = false;
        return;
      }

      // Rule: every non-void block must have valid moisture, weight, and yield range
      const anyBlocks = mhState.blocks.length > 0;
      if (!anyBlocks) {
        saveBtn.disabled = true;
        return;
      }

      const allOk = mhState.blocks.every(blk => {
        if (blk.voided) return true;
        if (!validateMoisture(blk.moisturePct)) return false;
        if (!blk.weightLbs || blk.weightLbs <= 0) return false;
        if (!validateYieldRange(blk.yieldBuPerAc)) return false;
        return true;
      });

      saveBtn.disabled = !allOk;
    }

    // Footer button behaviour --------------------------------------------

    saveBtn.addEventListener('click', () => {
      if (mhState.stage === 'setup') {
        const ok = validateSetup();
        if (!ok) return;
        // Build blocks from setup order
        mhState.blocks = mhState.hybrids.map(h => ({
          rowId: h.rowId,
          productId: h.productId,
          name: h.name,
          maturity: h.maturity,
          isCheck: h.isCheck,
          moisturePct: null,
          weightLbs: null,
          yieldBuPerAc: null,
          voided: false
        }));
        mhState.stage = 'blocks';
        renderStage();
      } else {
        // Dev: just log state
        console.log('Multi-Hybrid Dev Save', JSON.parse(JSON.stringify(mhState)));
        alert('Dev save only. Check console for payload.');
      }
    });

    resetBtn.addEventListener('click', () => {
      mhState.stage = 'setup';
      mhState.passLengthFt = 600;
      mhState.passWidthFt = 20;
      mhState.hybrids = [];
      mhState.blocks = [];
      renderStage();
    });

    closeBtn.addEventListener('click', () => {
      alert('In the real app this would close the popup. Dev page keeps it open so you can keep testing.');
    });

    function validateSetup() {
      const errors = [];
      const lengthFt = mhState.passLengthFt || 0;
      const widthFt = mhState.passWidthFt || 0;

      if (lengthFt <= 0) errors.push('Enter a positive plot length.');
      if (widthFt <= 0) errors.push('Enter a positive pass width.');

      if (!mhState.hybrids.length) {
        errors.push('Add at least one variety to this plot.');
      } else {
        mhState.hybrids.forEach((h, idx) => {
          if (!h.productId) errors.push(`Row ${idx + 1}: select a variety.`);
        });

        const checks = mhState.hybrids.filter(h => h.isCheck);
        if (checks.length === 0) errors.push('Pick exactly one Check variety.');
        if (checks.length > 1) errors.push('Only one Check variety is allowed per plot.');
      }

      const errBox = document.getElementById('mh-setup-errors');
      if (!errBox) return errors.length === 0;

      if (!errors.length) {
        errBox.textContent = '';
        return true;
      }

      errBox.innerHTML = errors.map(e => '• ' + e).join('<br>');
      return false;
    }

    // Init
    renderStage();
  </script>
</body>
</html>
