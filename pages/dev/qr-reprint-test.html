<!-- QR lib -->
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js" onload="window.__qrReady=true;"></script>

<!-- Firebase (absolute import) -->
<script type="module">
  import {
    ready,
    getFirestore, doc, getDoc
  } from '/Farm-vista/js/firebase-init.js';

  const $ = id => document.getElementById(id);
  const APP_ROOT = '/Farm-vista/';

  const buildHub = (id, tok) =>
    location.origin + APP_ROOT + 'pages/equipment/actions/hub.html'
    + `?id=${encodeURIComponent(id)}&t=${encodeURIComponent(tok)}`;

  const buildSmart = (absTo) => {
    const u = new URL(location.origin + APP_ROOT + 'launch.html');
    u.searchParams.set('to', absTo);
    return u.href;
  };

  function setStatus(msg, ok=true){
    const s = $('status');
    s.textContent = (ok ? '✓ ' : '⚠ ') + msg;
    s.style.color = ok ? 'var(--text)' : '#b00020';
  }

  function clearQR(){
    $('qrHolder').innerHTML = '';
    $('smartLink').textContent = '—';
  }

  function waitQRReady(cb){
    let tries=0;
    (function tick(){
      if(window.__qrReady && window.QRCode){ cb(); }
      else if(tries++<200) setTimeout(tick,50);
      else setStatus('QR library never loaded.', false);
    })();
  }

  function renderQR(id, token){
    clearQR();
    if(!id || !token){ setStatus('ID and token required.', false); return; }
    const smart = buildSmart(buildHub(id, token));
    $('smartLink').textContent = smart;

    waitQRReady(()=>{
      try{
        const holder = document.createElement('div');
        $('qrHolder').appendChild(holder);
        new window.QRCode(holder, {
          text: smart,
          width: 320, height: 320,
          correctLevel: window.QRCode.CorrectLevel.H,
          colorDark: "#000000", colorLight: "#ffffff"
        });
        setStatus('QR generated. Scan with phone.');
      }catch(err){
        setStatus('QR render failed.', false);
        console.error(err);
      }
    });
  }

  async function fetchToken(id){
    try{
      await ready;
      const db = getFirestore();
      const snap = await getDoc(doc(db, 'equipment', id));
      if(!snap.exists()){ setStatus('No equipment found for that ID.', false); return null; }
      const tok = snap.data()?.qr?.token || null;
      if(!tok){ setStatus('This unit has no QR token yet.', false); return null; }
      setStatus('Token fetched.');
      return tok;
    }catch(e){
      console.error(e); setStatus('Fetch failed.', false); return null;
    }
  }

  $('btnFetch').addEventListener('click', async ()=>{
    clearQR();
    const id = $('eqId').value.trim();
    if(!id){ setStatus('Enter an Equipment ID.', false); return; }
    const tok = await fetchToken(id);
    if(tok){ $('eqTok').value = tok; }
  });

  $('btnRender').addEventListener('click', ()=>{
    const id = $('eqId').value.trim();
    const tok = $('eqTok').value.trim();
    renderQR(id, tok);
  });
</script>
