<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Dev • Dead-Simple QR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    :root { --brand:#3B7E46; --muted:#67706B; --border:#e5e7eb; }
    body { font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; margin:0; background:#f7f8f7; color:#111; }
    .wrap { max-width:760px; margin:0 auto; padding:18px; }
    h1 { margin:0 0 10px 0; font-size:22px; }
    .card { background:#fff; border:1px solid var(--border); border-radius:14px; padding:16px; box-shadow:0 1px 0 rgba(0,0,0,.04); }
    .row { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width:700px){ .row { grid-template-columns:1fr; } }
    label { font-size:13px; font-weight:700; color:#111; display:block; margin-bottom:6px; }
    .input { width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#fff; font:inherit; }
    .btnbar { display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; }
    .btn { padding:10px 14px; border-radius:12px; border:1px solid var(--border); background:#fff; font-weight:800; cursor:pointer; }
    .btn-primary { background:var(--brand); border-color:transparent; color:#fff; }
    .status { font-size:13px; color:var(--muted); margin-left:auto; align-self:center; }
    .preview { margin-top:14px; background:#fff; border:1px dashed var(--border); border-radius:12px; min-height:360px; display:grid; place-items:center; }
    #qr canvas, #qr img { max-width:100%; height:auto; }
    code { display:block; margin-top:8px; background:#f1f3f1; border:1px solid var(--border); border-radius:8px; padding:8px; word-break:break-all; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Dev • Dead-Simple QR</h1>
    <div class="card">
      <div class="row">
        <div>
          <label for="eqId">Equipment ID (Firestore doc id)</label>
          <input id="eqId" class="input" placeholder="e.g., LHF...JofVQ">
        </div>
        <div>
          <label for="tok">QR Token</label>
          <input id="tok" class="input" placeholder="e.g., 274e9ab0...">
        </div>
      </div>

      <div class="btnbar">
        <button id="render" class="btn btn-primary">Render QR</button>
        <button id="print" class="btn">Print label</button>
        <div id="status" class="status" aria-live="polite"></div>
      </div>

      <div>
        <label style="margin-top:12px">Encoded smart link</label>
        <code id="link">—</code>
      </div>

      <div class="preview">
        <div id="qr" aria-live="polite"></div>
      </div>
    </div>
  </div>

  <!-- Only dependency: qrcodejs -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js" onload="window.__qrReady=true;"></script>
  <script>
    const $ = id => document.getElementById(id);
    const APP_ROOT = '/Farm-vista/';

    const buildHub = (id,t) =>
      location.origin + APP_ROOT + 'pages/equipment/actions/hub.html'
      + `?id=${encodeURIComponent(id)}&t=${encodeURIComponent(t)}`;

    const buildSmart = (absTo) => {
      const u = new URL(location.origin + APP_ROOT + 'launch.html');
      u.searchParams.set('to', absTo);
      return u.href;
    };

    function setStatus(msg, ok=true){
      const s = $('status');
      s.textContent = (ok ? '✓ ' : '⚠ ') + msg;
      s.style.color = ok ? '#111' : '#b00020';
    }

    function waitQRReady(cb){
      let tries=0; (function tick(){
        if (window.__qrReady && window.QRCode) cb();
        else if (tries++<200) setTimeout(tick,50);
        else setStatus('QR library failed to load.', false);
      })();
    }

    function renderNow(){
      const id = $('eqId').value.trim();
      const t  = $('tok').value.trim();
      $('qr').innerHTML = '';
      $('link').textContent = '—';
      if(!id || !t){ setStatus('Enter both ID and Token.', false); return; }

      const smart = buildSmart(buildHub(id,t));
      $('link').textContent = smart;

      waitQRReady(()=>{
        try{
          new QRCode($('qr'), { text: smart, width: 320, height: 320, correctLevel: QRCode.CorrectLevel.H });
          setStatus('QR generated. Scan with phone.');
        }catch(e){ console.error(e); setStatus('QR render failed.', false); }
      });
    }

    function printLabel(){
      const id = $('eqId').value.trim();
      const t  = $('tok').value.trim();
      const modelLast6 = prompt('Label text (e.g., "4020 - #123456")', '');
      if(!id || !t){ alert('Enter ID and Token first.'); return; }
      const smart = buildSmart(buildHub(id,t));
      const w = window.open('', '_blank', 'width=600,height=600');
      w.document.write(`
        <!doctype html><html><head><meta charset="utf-8"><title>Print QR</title>
        <style>
          @page { size: 2in 2in; margin: 4mm; }
          body{margin:0; display:flex; align-items:center; justify-content:center; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
          .wrap{text-align:center}
          #qr{width:380px;height:380px;margin:0 auto 6px}
          h1{font-size:12px;margin:0;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
          @media screen{ body{padding:16px} .wrap{max-width:420px} }
        </style></head><body>
          <div class="wrap">
            <div id="qr"></div>
            ${modelLast6 ? `<h1>${modelLast6.replace(/</g,'&lt;')}</h1>` : ``}
          </div>
          <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"><\/script>
          <script>
            (function(){
              function go(){
                new QRCode(document.getElementById('qr'), { text: ${JSON.stringify(smart)}, width: 380, height: 380, correctLevel: QRCode.CorrectLevel.H });
                setTimeout(function(){ window.print(); }, 200);
              }
              if(window.QRCode) go(); else window.addEventListener('load', go);
            })();
          <\/script>
        </body></html>
      `);
      w.document.close();
    }

    $('render').addEventListener('click', renderNow);
    $('print').addEventListener('click', printLabel);
  </script>
</body>
</html>
