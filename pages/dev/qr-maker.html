<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista ‚Ä¢ Dev ‚Üí QR Code Maker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- ===========================
       ABSOLUTE PATHS (FarmVista)
       =========================== -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <style>
    :root{ --pv:clamp(14px,2.5vw,20px); --card:#fff; --muted:#6b7280; --border:#e5e7eb }
    body{background:var(--page-bg,#f6f7f6)}
    .page{max-width:980px;margin:0 auto;padding:var(--pv)}
    .hero{display:flex;align-items:center;gap:14px;margin-bottom:18px}
    .hero .emoji{font-size:28px}
    .hero .title{font-size:20px;font-weight:700;line-height:1.2}
    .hero .sub{color:var(--muted);font-size:14px}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:clamp(14px,2.5vw,22px)}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:0 1px 0 rgba(0,0,0,.04);overflow:hidden}
    .card h3{margin:0;padding:14px 16px;border-bottom:1px solid var(--border);font-size:16px}
    .card .body{padding:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row + .row{margin-top:12px}
    .row-1{grid-template-columns:1fr}
    label{display:block;font-size:13px;font-weight:600;margin-bottom:6px}
    input[type=text], select{
      width:100%;border:1px solid var(--border);border-radius:10px;background:#fff;
      padding:12px;font-size:15px;outline:none
    }
    .help{font-size:12px;color:var(--muted);margin-top:6px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:12px 14px;border-radius:999px;border:1px solid var(--border);
      background:#3B7E46;color:#fff;font-weight:700;cursor:pointer;text-decoration:none}
    .btn.secondary{background:#fff;color:#111}
    .btnbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .previewWrap{display:flex;align-items:center;justify-content:center;min-height:420px;background:#fff;border:1px dashed var(--border);border-radius:12px}
    #qrTarget{display:flex;align-items:center;justify-content:center}
    #qrTarget canvas,#qrTarget img{max-width:100%;height:auto}
    .note{font-size:12px;color:var(--muted);margin-top:10px}
    .ok{color:#3B7E46}.bad{color:#b91c1c}
  </style>
</head>
<body>
  <div class="page">
    <div class="hero">
      <div class="emoji">üß™</div>
      <div>
        <div class="title">QR Code Maker (Dev)</div>
        <div class="sub">Builds ‚Äúsmart‚Äù QR codes via <span class="mono">launch.html</span> ‚Äî opens in the app if installed, else the web.</div>
      </div>
    </div>

    <div class="grid">
      <!-- Left: settings -->
      <div class="card">
        <h3>Settings</h3>
        <div class="body">
          <div class="row row-1">
            <div>
              <label for="qrUrl">Destination (page or URL)</label>
              <input id="qrUrl" type="text" spellcheck="false" class="mono"
                value="/Farm-vista/pages/dev/grain-bag-put-down-test.html"/>
              <div class="help">
                Enter a path inside <span class="mono">/Farm-vista/</span> <i>or</i> a full <span class="mono">https://</span> URL.
                We‚Äôll automatically wrap it with the smart launcher.
              </div>
              <div id="effectiveLink" class="help" style="margin-top:6px"></div>
            </div>
          </div>

          <div class="row">
            <div>
              <label for="qrLabel">Optional Text Label (prints under code)</label>
              <input id="qrLabel" type="text" placeholder="e.g., Tractor 8R 280 ‚Ä¢ Asset DF-TR-0280"/>
            </div>
            <div>
              <label for="qrSize">Size (pixels)</label>
              <select id="qrSize">
                <option value="256">256</option>
                <option value="384">384</option>
                <option value="512" selected>512</option>
                <option value="640">640</option>
                <option value="768">768</option>
                <option value="1024">1024</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label for="qrEcc">Error Correction</label>
              <select id="qrEcc">
                <option value="L">L (7%)</option>
                <option value="M">M (15%)</option>
                <option value="Q">Q (25%)</option>
                <option value="H" selected>H (30%) ‚Äî strongest</option>
              </select>
            </div>
            <div>
              <label for="qrMargin">Quiet-Zone Margin (modules)</label>
              <select id="qrMargin">
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4" selected>4 (recommended)</option>
                <option value="8">8</option>
              </select>
              <div class="help">Margin is baked into the exported PNG so phone cameras read it reliably.</div>
            </div>
          </div>

          <div class="btnbar">
            <button id="btnMake" class="btn">Create QR</button>
            <button id="btnDownload" class="btn secondary" disabled>Download PNG</button>
            <button id="btnPrint" class="btn secondary" disabled>Print</button>
          </div>

          <div id="status" class="note"></div>
        </div>
      </div>

      <!-- Right: preview -->
      <div class="card">
        <h3>Preview</h3>
        <div class="body">
          <div class="previewWrap">
            <div id="qrPreview">
              <div id="qrTarget" aria-live="polite"></div>
              <div id="qrCaption" style="text-align:center;margin-top:10px;font-weight:700"></div>
            </div>
          </div>
          <div class="note">Tip: For stickers, 512‚Äì768 px at ECC <b>H</b> with margin <b>4+</b> is ultra reliable.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Load QR lib after DOM; mark ready on load -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js" onload="window.__qrReady=true;"></script>

  <script>
  (function(){
    // ---------- Smart launcher helpers ----------
    const APP_ROOT = '/Farm-vista/';
    const LAUNCH_URL = () => (location.origin + APP_ROOT + 'launch.html');

    function normalizeTarget(raw){
      if (!raw) return APP_ROOT + 'index.html';
      // Absolute URL?
      try { return new URL(raw).href; } catch {}
      // Ensure leading slash for paths
      const path = raw.startsWith('/') ? raw : '/' + raw;
      return location.origin + path;
    }

    function buildSmartLink(raw){
      const targetAbs = normalizeTarget(raw);
      const url = new URL(LAUNCH_URL());
      url.searchParams.set('to', targetAbs);
      return url.href;
    }

    // ---------- QR app ----------
    function whenQRCodeReady(cb){
      let tries = 0;
      (function tick(){
        if (window.__qrReady && window.QRCode && window.QRCode.CorrectLevel) cb();
        else if (tries++ < 200) setTimeout(tick,50);
        else {
          const s = document.getElementById('status');
          s.innerHTML = '<span class="bad">‚ö†</span> QR library failed to load.';
        }
      })();
    }

    function app(){
      const el = id => document.getElementById(id);
      const qrUrl=el('qrUrl'), qrLabel=el('qrLabel'), qrSize=el('qrSize'), qrEcc=el('qrEcc'),
            qrMargin=el('qrMargin'), btnMake=el('btnMake'), btnDownload=el('btnDownload'),
            btnPrint=el('btnPrint'), status=el('status'), qrTarget=el('qrTarget'),
            qrCaption=el('qrCaption'), effectiveLink=el('effectiveLink');

      let currentCanvas=null, lastLabel='', lastEncodedLink='';

      const ECC = {
        L: QRCode.CorrectLevel.L, M: QRCode.CorrectLevel.M,
        Q: QRCode.CorrectLevel.Q, H: QRCode.CorrectLevel.H
      };

      function setStatus(msg, ok=true){ status.innerHTML=(ok?'<span class="ok">‚úì</span> ':'<span class="bad">‚ö†</span> ')+msg; }
      function clearPreview(){ qrTarget.innerHTML=''; qrCaption.textContent=''; currentCanvas=null; btnDownload.disabled=true; btnPrint.disabled=true; }

      function showEffectiveLink(){
        const smart = buildSmartLink(qrUrl.value.trim());
        lastEncodedLink = smart;
        effectiveLink.textContent = 'Encoded smart link: ' + smart;
      }

      function waitForQRCodeCanvas(holder, timeoutMs=4000){
        return new Promise((resolve,reject)=>{
          const start=Date.now();
          (function check(){
            const n = holder.querySelector('canvas') || holder.querySelector('img');
            if (n) resolve(n);
            else if (Date.now()-start>timeoutMs) reject(new Error('QR render timeout'));
            else requestAnimationFrame(check);
          })();
        });
      }

      function padCanvasWithMargin(srcCanvas, modulesMargin){
        const size=parseInt(qrSize.value,10)||512;
        const modulePx=size/40;
        const pxMargin=Math.max(1,Math.round(modulesMargin*modulePx));
        const c=document.createElement('canvas');
        c.width=srcCanvas.width+pxMargin*2; c.height=srcCanvas.height+pxMargin*2;
        const ctx=c.getContext('2d'); ctx.fillStyle='#fff'; ctx.fillRect(0,0,c.width,c.height);
        ctx.drawImage(srcCanvas,pxMargin,pxMargin);
        return c;
      }

      async function makeQR(){
        clearPreview();
        // Always wrap user input with the smart launcher
        const smartLink = buildSmartLink(qrUrl.value.trim());
        lastEncodedLink = smartLink;

        // Validate final URL (should always be absolute)
        try { new URL(smartLink); } catch { setStatus('Invalid target.', false); return; }

        const size=parseInt(qrSize.value,10)||512;
        const ecc=ECC[qrEcc.value] ?? QRCode.CorrectLevel.H;
        const marginModules=parseInt(qrMargin.value,10)||4;

        const holder=document.createElement('div'); qrTarget.appendChild(holder);
        new QRCode(holder,{text:smartLink,width:size,height:size,colorDark:"#000000",colorLight:"#ffffff",correctLevel:ecc});

        try{
          const node=await waitForQRCodeCanvas(holder);
          let rawCanvas;
          if(node.tagName==='CANVAS'){ rawCanvas=node; }
          else{
            rawCanvas=document.createElement('canvas'); rawCanvas.width=size; rawCanvas.height=size;
            const ctx=rawCanvas.getContext('2d');
            await new Promise((res,rej)=>{
              const img=new Image(); img.crossOrigin='anonymous';
              img.onload=()=>{ctx.drawImage(img,0,0,size,size); res();};
              img.onerror=rej; img.src=node.src;
            });
          }
          const padded=padCanvasWithMargin(rawCanvas,marginModules);
          currentCanvas=padded;

          const preview=new Image(); preview.alt='QR code preview'; preview.src=padded.toDataURL('image/png');
          qrTarget.innerHTML=''; qrTarget.appendChild(preview);

          lastLabel=qrLabel.value.trim(); qrCaption.textContent=lastLabel||'';
          btnDownload.disabled=false; btnPrint.disabled=false;
          setStatus('QR generated (smart link). Scan with phone.');
        }catch(e){
          setStatus('Failed to render QR.', false); console.error(e);
        }
      }

      function downloadPNG(){
        if(!currentCanvas) return;
        const a=document.createElement('a');
        const slug=(lastLabel||'farmvista-qr').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'');
        a.download=`${slug||'qr'}.png`; a.href=currentCanvas.toDataURL('image/png');
        document.body.appendChild(a); a.click(); requestAnimationFrame(()=>a.remove());
      }

      function printQR(){
        if(!currentCanvas) return;
        const data=currentCanvas.toDataURL('image/png');
        const label=lastLabel||'';
        const w=window.open('','_blank','width=900,height=900');
        w.document.write(`
          <!doctype html><html><head><meta charset="utf-8"><title>Print QR</title>
          <style>
            body{margin:0;padding:24px;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto;display:flex;align-items:center;justify-content:center}
            .wrap{text-align:center}
            img{max-width:90vw;max-height:75vh;display:block;margin:0 auto}
            h1{font-size:18px;margin:14px 0 0 0}
            .muted{color:#555;font-size:12px;margin-top:6px}
            .link{margin-top:8px;font-size:12px;color:#333;word-break:break-all}
          </style></head><body>
            <div class="wrap">
              <img src="${data}" alt="QR code">
              ${label ? `<h1>${label.replace(/</g,'&lt;')}</h1>` : ``}
              <div class="muted">${new Date().toLocaleString()}</div>
              <div class="link">${(lastEncodedLink||'').replace(/</g,'&lt;')}</div>
            </div>
            <script>window.onload=function(){setTimeout(function(){window.print();},150);}<\/script>
          </body></html>
        `);
        w.document.close();
      }

      document.getElementById('btnMake').addEventListener('click', makeQR);
      document.getElementById('btnDownload').addEventListener('click', downloadPNG);
      document.getElementById('btnPrint').addEventListener('click', printQR);

      // show the effective link as you type
      qrUrl.addEventListener('input', showEffectiveLink);

      // initial render + link preview
      showEffectiveLink();
      makeQR();
    }

    whenQRCodeReady(app);
  })();
  </script>
</body>
</html>
