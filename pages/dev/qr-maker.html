<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista â€¢ Dev â†’ QR Code Maker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <style>
    :root{ --pv:clamp(14px,2.5vw,20px); --card:#fff; --muted:#6b7280; --border:#e5e7eb }
    body{background:var(--page-bg,#f6f7f6)}
    .page{max-width:980px;margin:0 auto;padding:var(--pv)}
    .hero{display:flex;align-items:center;gap:14px;margin-bottom:18px}
    .hero .emoji{font-size:28px}
    .hero .title{font-size:20px;font-weight:700;line-height:1.2}
    .hero .sub{color:var(--muted);font-size:14px}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:clamp(14px,2.5vw,22px)}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;box-shadow:0 1px 0 rgba(0,0,0,.04);overflow:hidden}
    .card h3{margin:0;padding:14px 16px;border-bottom:1px solid var(--border);font-size:16px}
    .card .body{padding:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .row + .row{margin-top:12px}
    .row-1{grid-template-columns:1fr}
    label{display:block;font-size:13px;font-weight:600;margin-bottom:6px}
    input[type=text], select{
      width:100%;border:1px solid var(--border);border-radius:10px;background:#fff;
      padding:12px;font-size:15px;outline:none
    }
    .help{font-size:12px;color:var(--muted);margin-top:6px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:12px 14px;border-radius:999px;border:1px solid var(--border);
      background:#3B7E46;color:#fff;font-weight:700;cursor:pointer;text-decoration:none}
    .btn.secondary{background:#fff;color:#111}
    .btnbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .previewWrap{display:flex;align-items:center;justify-content:center;min-height:420px;background:#fff;border:1px dashed var(--border);border-radius:12px}
    #qrTarget{display:flex;align-items:center;justify-content:center}
    #qrTarget canvas,#qrTarget img{max-width:100%;height:auto}
    .note{font-size:12px;color:var(--muted);margin-top:10px}
    .ok{color:#3B7E46}.bad{color:#b91c1c}
  </style>
</head>
<body>
  <div class="page">
    <div class="hero">
      <div class="emoji">ðŸ§ª</div>
      <div>
        <div class="title">QR Code Maker (Dev)</div>
        <div class="sub">For testing equipment QR routing â†’ directly encodes Hub URLs</div>
      </div>
    </div>

    <div class="grid">
      <!-- Settings -->
      <div class="card">
        <h3>Settings</h3>
        <div class="body">

          <div class="row row-1">
            <div>
              <label for="qrId">Equipment ID (Firestore doc ID)</label>
              <input id="qrId" type="text" class="mono" placeholder="e.g., 22d8b41eca801394f9a69726"/>
              <div class="help">
                This will build:<br>
                <span class="mono">/Farm-vista/pages/equipment/actions/hub.html?id=ID_HERE</span>
              </div>
              <div id="effectiveLink" class="help" style="margin-top:6px"></div>
            </div>
          </div>

          <div class="row">
            <div>
              <label for="qrLabel">Optional Text Label</label>
              <input id="qrLabel" type="text" placeholder="Tractor 8R 280 â€¢ #123456"/>
            </div>
            <div>
              <label for="qrSize">Size (pixels)</label>
              <select id="qrSize">
                <option value="256">256</option>
                <option value="384">384</option>
                <option value="512" selected>512</option>
                <option value="640">640</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label for="qrEcc">Error Correction</label>
              <select id="qrEcc">
                <option value="L">L (7%)</option>
                <option value="M">M (15%)</option>
                <option value="Q">Q (25%)</option>
                <option value="H" selected>H (30%)</option>
              </select>
            </div>
            <div>
              <label for="qrMargin">Quiet Zone Margin</label>
              <select id="qrMargin">
                <option value="2">2</option>
                <option value="4" selected>4</option>
                <option value="8">8</option>
              </select>
            </div>
          </div>

          <div class="btnbar">
            <button id="btnMake" class="btn">Create QR</button>
            <button id="btnDownload" class="btn secondary" disabled>Download PNG</button>
            <button id="btnPrint" class="btn secondary" disabled>Print</button>
          </div>

          <div id="status" class="note"></div>
        </div>
      </div>

      <!-- Preview -->
      <div class="card">
        <h3>Preview</h3>
        <div class="body">
          <div class="previewWrap">
            <div id="qrPreview">
              <div id="qrTarget"></div>
              <div id="qrCaption" style="text-align:center;margin-top:10px;font-weight:700"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- QR library -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js" onload="window.__qrReady=true;"></script>

  <script>
  (function(){
    const HUB_URL = id =>
      `${location.origin}/Farm-vista/pages/equipment/actions/hub.html?id=${encodeURIComponent(id)}`;

    function whenReady(cb){
      let tries=0;
      (function check(){
        if(window.__qrReady && window.QRCode) cb();
        else if(tries++<200) setTimeout(check,50);
      })();
    }

    function app(){
      const $ = id => document.getElementById(id);
      const qrId=$('qrId'), qrLabel=$('qrLabel'), qrSize=$('qrSize'),
            qrEcc=$('qrEcc'), qrMargin=$('qrMargin'), btnMake=$('btnMake'),
            btnDownload=$('btnDownload'), btnPrint=$('btnPrint'),
            qrTarget=$('qrTarget'), qrCaption=$('qrCaption'),
            status=$('status'), effectiveLink=$('effectiveLink');

      let currentCanvas=null, lastLink='';

      function clear(){
        qrTarget.innerHTML='';
        qrCaption.textContent='';
        btnDownload.disabled=true;
        btnPrint.disabled=true;
        currentCanvas=null;
      }

      function buildLink(){
        const id = qrId.value.trim();
        if(!id){
          effectiveLink.textContent='';
          return '';
        }
        const link = HUB_URL(id);
        effectiveLink.textContent = 'Final QR URL: ' + link;
        return link;
      }

      function makeQR(){
        clear();
        const id = qrId.value.trim();
        if(!id){
          status.innerHTML='<span class="bad">âš </span> Enter an ID';
          return;
        }
        const link = buildLink();
        lastLink = link;

        const size=parseInt(qrSize.value,10);
        const ecc = {
          L: QRCode.CorrectLevel.L,
          M: QRCode.CorrectLevel.M,
          Q: QRCode.CorrectLevel.Q,
          H: QRCode.CorrectLevel.H
        }[qrEcc.value];

        const holder=document.createElement('div');
        qrTarget.appendChild(holder);

        new QRCode(holder,{
          text: link,
          width:size,
          height:size,
          colorDark:"#000",
          colorLight:"#fff",
          correctLevel:ecc
        });

        const img = holder.querySelector('img') || holder.querySelector('canvas');
        if(img){
          currentCanvas = img.tagName==='CANVAS'
            ? img
            : (()=>{const c=document.createElement('canvas'); c.width=size; c.height=size;
                    const ctx=c.getContext('2d'); const i=new Image(); i.src=img.src;
                    i.onload=()=>ctx.drawImage(i,0,0,size,size); return c;})();

          qrTarget.innerHTML='';
          const preview=new Image(); preview.src=currentCanvas.toDataURL('image/png');
          qrTarget.appendChild(preview);

          qrCaption.textContent = qrLabel.value.trim();
          btnDownload.disabled=false;
          btnPrint.disabled=false;
          status.innerHTML='<span class="ok">âœ“</span> QR generated';
        }
      }

      function downloadPNG(){
        if(!currentCanvas) return;
        const a=document.createElement('a');
        a.download='qr.png';
        a.href=currentCanvas.toDataURL('image/png');
        a.click();
      }

      function printQR(){
        if(!currentCanvas) return;
        const data=currentCanvas.toDataURL('image/png');
        const w=window.open('','_blank');
        w.document.write(`<img src="${data}" style="width:100%">`);
        w.print();
      }

      btnMake.onclick=makeQR;
      btnDownload.onclick=downloadPNG;
      btnPrint.onclick=printQR;

      qrId.oninput=()=>buildLink();
    }

    whenReady(app);
  })();
  </script>
</body>
</html>