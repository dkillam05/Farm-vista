<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista â€¢ Dev â€¢ Shop Equipment Bulk View</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <!-- Ensure fv-shell -->
  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js'; s.defer=true; document.head.appendChild(s);
      }
    })();
  </script>

  <!-- Firebase config FIRST (for firebase-init imports) -->
  <script src="/Farm-vista/js/firebase-config.js"></script>

  <style>
    .page{
      max-width:1100px;
      margin:0 auto;
      padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + 72px)!important;
    }
    .page-title{margin:0 0 8px 0;}
    .page-sub{margin:0 0 14px 0;color:var(--muted,#67706B);}

    .alert{
      display:none;margin:0 0 12px 0;border:1px solid #c62828;background:#fdecea;color:#8a1c1c;
      border-radius:12px;padding:12px 14px;font-weight:800;
    }
    .alert.show{display:block;}

    .section{
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));
      overflow:hidden;
    }

    .section-head{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);
    }
    .head-left{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
    .icon{
      width:24px;height:24px;display:grid;place-items:center;color:#2F6C3C;
      flex:0 0 auto;
    }
    .head-title{font-weight:900;}
    .head-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}

    .tabs{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .tab{
      font-size:13px;
      border:1px solid var(--border);
      padding:7px 10px;
      border-radius:999px;
      background:var(--surface);
      color:var(--text);
      font-weight:900;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      border-color:transparent;
      background:#2F6C3C;
      color:#fff; /* âœ… white on green */
    }

    .search{
      display:flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      background:var(--card-surface,var(--surface));
      min-width:min(520px, 100%);
    }
    .search input{
      width:100%;
      border:none;
      outline:none;
      background:transparent;
      font:inherit;
      font-size:16px;
      color:var(--text);
    }
    .pill{
      font-size:12px;
      border:1px solid var(--border);
      padding:3px 8px;
      border-radius:999px;
      color:var(--muted,#67706B);
      background:var(--surface);
      white-space:nowrap;
      font-weight:800;
    }
    .pill-ok{border-color:#2F6C3C;color:#2F6C3C;}
    .pill-arch{border-color:#b3261e;color:#b3261e;}

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:8px 14px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--card-surface,var(--surface));
      font-weight:800;
      cursor:pointer;
      font-size:14px;
      text-decoration:none;
      color:var(--text);
    }
    .btn-primary{border-color:transparent;background:#2F6C3C;color:#fff;} /* âœ… */
    .btn-quiet{min-width:auto;padding:7px 10px;font-size:13px;}

    .section-body{padding:16px;display:grid;gap:14px;}

    /* List rows â€“ mobile-first, readable */
    .list{padding:0;display:grid;gap:10px;}
    .item{
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--card-surface,var(--surface));
      padding:10px 12px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      cursor:pointer;
    }
    .item:hover{box-shadow:0 8px 20px rgba(0,0,0,.08);}
    .item-main{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:min(520px, 100%);
      flex:1 1 520px;
    }
    .row1{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:8px;
    }
    .name{font-weight:900;}
    .meta{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      align-items:center;
      color:var(--muted,#67706B);
      font-size:13px;
      font-weight:800;
    }

    .item-right{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:6px;
      flex:0 0 auto;
      min-width:160px;
    }
    .num{
      font-weight:950;
      font-size:16px;
    }
    .muted{color:var(--muted,#67706B);font-size:13px;}
    .hint{color:var(--muted,#67706B);font-size:12px;font-weight:800;}

    /* Horizontal specs strip (allowed sideways scroll) */
    .specbar{
      display:flex;
      gap:8px;
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
      padding-bottom:2px;
    }
    .spec{
      flex:0 0 auto;
      font-size:12px;
      border:1px solid var(--border);
      padding:3px 8px;
      border-radius:999px;
      background:var(--surface);
      color:var(--muted,#67706B);
      font-weight:800;
      white-space:nowrap;
    }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      bottom:calc(env(safe-area-inset-bottom,0px)+72px);
      transform:translateX(-50%);
      background:#2F6C3C;
      color:#fff;
      padding:10px 14px;
      border-radius:10px;
      box-shadow:0 6px 20px rgba(0,0,0,.25);
      z-index:99999;
      display:none;
      font-weight:900;
    }
    .toast.show{display:block;animation:fadeout 2.8s forwards;}
    @keyframes fadeout{
      0%{opacity:1}
      85%{opacity:1}
      100%{opacity:0}
    }

    /* Dialog (sheet) */
    dialog.sheet{
      width:min(760px, 92vw);
      border:1px solid var(--border);
      border-radius:14px;
      padding:0;
      background:var(--card-surface,var(--surface));
      color:var(--text);
      box-shadow:0 18px 40px rgba(0,0,0,.45);
    }
    .sheet::backdrop{ background:rgba(0,0,0,.55); }
    .sheet header{
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .sheet .body{
      padding:14px 16px;
      max-height:70vh;
      overflow-y:auto;
      overflow-x:hidden;
      display:grid;
      gap:12px;
    }
    .sheet footer{
      padding:12px 16px;
      border-top:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .grid-2{display:grid;gap:10px;grid-template-columns:1fr 1fr;}
    @media(max-width:880px){ .grid-2{grid-template-columns:1fr;} }

    .field label{
      display:block;
      font-weight:900;
      margin:0 0 6px 0;
    }
    .input,.select{
      width:100%;
      font:inherit;
      font-size:16px;
      color:var(--text);
      background:var(--card-surface,var(--surface));
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px 12px;
      outline:none;
    }
    .help{
      font-size:13px;
      color:var(--muted,#67706B);
      font-weight:800;
    }

    /* No blue links */
    a{ color:inherit; }
    code{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body>
  <fv-shell>
    <div class="page">
      <h1 class="page-title">Shop Equipment Bulk View (Dev)</h1>
      <p class="page-sub">
        Read-only list for now (ACTIVE ONLY). StarFire tab supports <strong>fast location updates</strong>.
        <br><span class="muted">Double-click (desktop) or long-press (phone) a StarFire row to change location.</span>
      </p>

      <div id="alert" class="alert" role="alert"></div>

      <section class="section">
        <header class="section-head">
          <div class="head-left">
            <div class="icon" aria-hidden="true">ðŸ§°</div>
            <div class="head-title">Shop Bulk</div>
            <span class="pill pill-ok">ACTIVE</span>
          </div>

          <div class="head-actions">
            <div class="tabs" id="tabs"></div>
            <div class="search" role="search" aria-label="Search equipment">
              <span class="pill">Search</span>
              <input id="q" type="search" placeholder="name, model, serial, notesâ€¦" autocomplete="off">
            </div>
            <button id="btnRefresh" class="btn btn-primary" type="button">Refresh</button>
          </div>
        </header>

        <div class="section-body">
          <div id="list" class="list">
            <div class="muted">Loadingâ€¦</div>
          </div>
        </div>
      </section>
    </div>
  </fv-shell>

  <div id="toast" class="toast" role="status" aria-live="polite">Saved.</div>

  <!-- STARFIRE LOCATION SHEET -->
  <dialog id="sfSheet" class="sheet" aria-modal="true">
    <header>
      <strong id="sfTitle">Change StarFire Location</strong>
      <button id="sfClose" class="btn" type="button">Close</button>
    </header>

    <div class="body">
      <div class="grid-2">
        <div class="field">
          <label>StarFire Serial</label>
          <input id="sfSerial" class="input" readonly>
          <div class="help">Read-only. Youâ€™re updating the current location.</div>
        </div>
        <div class="field">
          <label for="sfSince">Location Since</label>
          <input id="sfSince" class="input" inputmode="numeric" placeholder="YYYY-MM-DD">
          <div class="help">Defaults to today.</div>
        </div>
      </div>

      <div class="field">
        <label for="sfLoc">New Location</label>
        <select id="sfLoc" class="select"></select>
        <div class="help">Includes quick options + all ACTIVE equipment.</div>
      </div>

      <div class="field">
        <span class="pill" id="sfCurrentPill">Current: â€”</span>
      </div>
    </div>

    <footer>
      <button id="sfCancel" class="btn" type="button">Cancel</button>
      <button id="sfSave" class="btn btn-primary" type="button">Save Location</button>
    </footer>
  </dialog>

  <script type="module">
    import {
      ready,
      getFirestore,
      collection,
      doc,
      getDocs,
      updateDoc
    } from "/Farm-vista/js/firebase-init.js";

    const $ = s => document.querySelector(s);

    const alertBox = $("#alert");
    const listBox  = $("#list");
    const toast    = $("#toast");

    const tabsBox  = $("#tabs");
    const qInput   = $("#q");
    const btnRefresh = $("#btnRefresh");

    const sfSheet  = $("#sfSheet");
    const sfTitle  = $("#sfTitle");
    const sfClose  = $("#sfClose");
    const sfCancel = $("#sfCancel");
    const sfSave   = $("#sfSave");
    const sfSerial = $("#sfSerial");
    const sfSince  = $("#sfSince");
    const sfLoc    = $("#sfLoc");
    const sfCurrentPill = $("#sfCurrentPill");

    const QUICK_LOCS = [
      { id: null, name: "In Storage", type: "storage" },
      { id: null, name: "Shop", type: "shop" }
    ];

    const TABS = [
      { key:"planters", label:"Planters" },
      { key:"combines", label:"Combines" },
      { key:"sprayers", label:"Sprayers" },
      { key:"grain",   label:"Grain Carts / Handling" },
      { key:"tractors",label:"Tractors" },
      { key:"trucks",  label:"Trucks" },
      { key:"tillage", label:"Tillage" },
      { key:"seeders", label:"Seeders / Drills" },
      { key:"misc",    label:"Misc Implements" },
      { key:"starfire",label:"StarFire" },
      { key:"all",     label:"All" }
    ];

    const state = {
      all: [],
      equipActive: [],
      starfire: [],
      tab: "planters",
      q: "",
      sfSelected: null
    };

    const showToast = (msg="Saved.")=>{
      toast.textContent = msg;
      toast.classList.remove("show");
      void toast.offsetWidth;
      toast.classList.add("show");
    };
    const showError = (msg)=>{
      alertBox.textContent = msg;
      alertBox.classList.add("show");
      clearTimeout(showError._t);
      showError._t = setTimeout(()=> alertBox.classList.remove("show"), 8000);
    };

    const norm = v => (v||"").toString().trim().toLowerCase();
    const isActive = d => norm(d.status) === "active";
    const todayISO = ()=>{
      const d=new Date(); const y=d.getFullYear();
      const m=String(d.getMonth()+1).padStart(2,"0");
      const da=String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${da}`;
    };
    const serialLast4 = (s)=>{
      if(!s) return "";
      const t=String(s).trim();
      return t.length<=4 ? t : t.slice(-4);
    };

    function detectCategory(d){
      const t = norm(d.type);
      const it = norm(d.implementType);

      if(t === "starfire") return "starfire";
      if(t === "tractor") return "tractors";
      if(t === "truck") return "trucks";
      if(t === "sprayer") return "sprayers";
      if(t === "combine") return "combines";

      if(t === "implement"){
        if(it === "planter") return "planters";
        if(it.includes("grain") || it.includes("cart") || it.includes("auger") || it.includes("bin")) return "grain";
        if(it.includes("tillage")) return "tillage";
        if(it.includes("drill") || it.includes("seeder")) return "seeders";
        return "misc";
      }

      // fallback by text
      const name = ((d.name||"") + " " + (d.modelName||"")).toLowerCase();
      if(name.includes("planter")) return "planters";
      if(name.includes("combine")) return "combines";
      if(name.includes("sprayer")) return "sprayers";
      return "misc";
    }

    function specChips(d){
      const t = norm(d.type);
      const it = norm(d.implementType);
      const out = [];

      if(t === "implement" && it === "planter"){
        if(d.numRows) out.push(`${d.numRows}R`);
        if(d.rowSpacingIn) out.push(`${d.rowSpacingIn}"`);
        if(d.workingWidthFt) out.push(`${d.workingWidthFt}ft`);
        if(d.totalHours != null) out.push(`${d.totalHours} hrs`);
        if(d.totalAcres != null) out.push(`${d.totalAcres} ac`);
      } else if(t === "sprayer"){
        if(d.boomWidthFt) out.push(`${d.boomWidthFt}ft boom`);
        if(d.tankSizeGal) out.push(`${d.tankSizeGal} gal`);
        if(d.engineHours != null) out.push(`${d.engineHours} hrs`);
      } else if(t === "tractor"){
        if(d.engineHours != null) out.push(`${d.engineHours} hrs`);
      } else if(t === "truck"){
        if(d.odometerMiles != null) out.push(`${d.odometerMiles} mi`);
        if(d.licensePlate) out.push(`Plate ${d.licensePlate}`);
      } else if(t === "implement"){
        if(d.workingWidthFt) out.push(`${d.workingWidthFt}ft`);
      }
      return out;
    }

    function matchesSearch(d, q){
      if(!q) return true;
      const hay = [
        d.name, d.makeName, d.modelName, d.serial, d.notes,
        d.type, d.implementType, d.year, d.numRows, d.workingWidthFt
      ].map(x => (x==null?"":String(x))).join(" ").toLowerCase();
      return hay.includes(q);
    }

    function renderTabs(){
      tabsBox.innerHTML = "";
      TABS.forEach(t=>{
        const b=document.createElement("button");
        b.type="button";
        b.className="tab" + (state.tab===t.key ? " active" : "");
        b.textContent=t.label;
        b.addEventListener("click", ()=>{
          state.tab=t.key;
          renderTabs();
          renderList();
        });
        tabsBox.appendChild(b);
      });
    }

    function renderList(){
      const q = norm(state.q);

      // active only (global)
      const active = state.all.filter(isActive);

      if(state.tab === "starfire"){
        const arr = active
          .filter(d => norm(d.type) === "starfire")
          .filter(d => matchesSearch(d, q))
          .sort((a,b)=> String(a.serial||"").localeCompare(String(b.serial||"")));
        renderStarfire(arr);
        return;
      }

      let arr = active.filter(d => norm(d.type) !== "starfire");

      if(state.tab !== "all"){
        arr = arr.filter(d => detectCategory(d) === state.tab);
      }

      if(q) arr = arr.filter(d => matchesSearch(d, q));

      arr.sort((a,b)=>{
        const an=(a.name||"").toLowerCase();
        const bn=(b.name||"").toLowerCase();
        if(an<bn) return -1;
        if(an>bn) return 1;
        return Number(b.year||0)-Number(a.year||0);
      });

      if(!arr.length){
        listBox.innerHTML = `<div class="muted">No results.</div>`;
        return;
      }

      listBox.innerHTML = "";
      arr.forEach(d=>{
        const el=document.createElement("div");
        el.className="item";

        const chips = specChips(d);
        const cat = detectCategory(d);
        const catLabel = (()=>{
          const map = {
            planters:"Planter", combines:"Combine", sprayers:"Sprayer", grain:"Grain",
            tractors:"Tractor", trucks:"Truck", tillage:"Tillage", seeders:"Seeder/Drill", misc:"Implement"
          };
          return map[cat] || "Equipment";
        })();

        const hours = (d.totalHours ?? d.engineHours ?? null);
        const acres = (d.totalAcres ?? null);

        el.innerHTML = `
          <div class="item-main">
            <div class="row1">
              <div class="name">${escapeHtml(d.name || "(unnamed)")}</div>
              <span class="pill">${escapeHtml(catLabel)}</span>
              ${d.year ? `<span class="pill">${escapeHtml(String(d.year))}</span>` : ``}
              ${d.serial ? `<span class="pill">SN â€¦${escapeHtml(String(d.serial).slice(-4))}</span>` : ``}
            </div>

            <div class="meta">
              ${(d.makeName||d.modelName) ? `<span>${escapeHtml([d.makeName,d.modelName].filter(Boolean).join(" â€¢ "))}</span>` : ``}
              ${(d.notes) ? `<span>â€¢</span><span>${escapeHtml(String(d.notes))}</span>` : ``}
            </div>

            ${chips.length ? `
              <div class="specbar" aria-label="Specs">
                ${chips.map(c=>`<span class="spec">${escapeHtml(c)}</span>`).join("")}
              </div>
            ` : ``}
          </div>

          <div class="item-right">
            ${hours!=null ? `<div class="num">${escapeHtml(String(hours))} hrs</div>` : `<div class="muted">â€”</div>`}
            ${acres!=null ? `<div class="muted">${escapeHtml(String(acres))} ac</div>` : `<div class="muted"></div>`}
            <div class="hint">tap</div>
          </div>
        `;

        // For now: no edit action here (read-only), but tap stays for future drill-down
        listBox.appendChild(el);
      });
    }

    function renderStarfire(arr){
      if(!arr.length){
        listBox.innerHTML = `<div class="muted">No active StarFires found.</div>`;
        return;
      }

      listBox.innerHTML = "";
      arr.forEach(sf=>{
        const el=document.createElement("div");
        el.className="item";
        const sn4 = serialLast4(sf.serial);
        const loc = sf.starfireCurrentLocationName || "â€”";
        const since = sf.starfireCurrentLocationSince || "";

        el.innerHTML = `
          <div class="item-main">
            <div class="row1">
              <div class="name">â€¦${escapeHtml(sn4 || "")}</div>
              <span class="pill">StarFire</span>
              ${sf.serial ? `<span class="pill">${escapeHtml(String(sf.serial))}</span>` : ``}
            </div>

            <div class="meta">
              <span><strong>Location:</strong> ${escapeHtml(loc)}</span>
              ${since ? `<span>â€¢</span><span>since ${escapeHtml(String(since))}</span>` : ``}
            </div>

            <div class="hint">double-click (desktop) or long-press (phone) to change location</div>
          </div>

          <div class="item-right">
            <span class="pill pill-ok">active</span>
          </div>
        `;

        // dblclick desktop
        el.addEventListener("dblclick", (e)=>{
          e.preventDefault();
          openStarfireSheet(sf);
        });

        // long press mobile
        let pressTimer=null;
        el.addEventListener("touchstart", ()=>{
          pressTimer=setTimeout(()=> openStarfireSheet(sf), 520);
        }, {passive:true});
        el.addEventListener("touchend", ()=>{ if(pressTimer) clearTimeout(pressTimer); }, {passive:true});
        el.addEventListener("touchmove", ()=>{ if(pressTimer) clearTimeout(pressTimer); }, {passive:true});

        listBox.appendChild(el);
      });
    }

    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    // ---- StarFire Location Sheet ----
    function buildLocationOptions(){
      sfLoc.innerHTML = "";

      // quick
      QUICK_LOCS.forEach(q=>{
        const opt=document.createElement("option");
        opt.value = JSON.stringify({ kind:"quick", id:q.id, name:q.name, type:q.type });
        opt.textContent = q.name;
        sfLoc.appendChild(opt);
      });

      const sep=document.createElement("option");
      sep.disabled=true;
      sep.textContent="â”€â”€â”€â”€â”€â”€â”€â”€";
      sfLoc.appendChild(sep);

      // equipment targets (ACTIVE only, non-starfire)
      state.equipActive.forEach(e=>{
        const opt=document.createElement("option");
        const payload = {
          kind:"equip",
          id: e.id,
          name: e.name || "(unnamed)",
          type: norm(e.type) || "equipment"
        };
        opt.value = JSON.stringify(payload);
        const sn = e.serial ? ` â€¢ â€¦${String(e.serial).slice(-4)}` : "";
        opt.textContent = `${payload.name}${sn}`;
        sfLoc.appendChild(opt);
      });
    }

    function openSheet(dlg){
      try{ dlg.showModal(); }catch{ dlg.setAttribute("open",""); }
    }
    function closeSheet(dlg){
      try{ dlg.close(); }catch{ dlg.removeAttribute("open"); }
    }

    function openStarfireSheet(sf){
      state.sfSelected = sf;

      buildLocationOptions();

      sfTitle.textContent = `Change StarFire Location â€¢ â€¦${serialLast4(sf.serial||"")}`;
      sfSerial.value = sf.serial || "";
      sfSince.value = (sf.starfireCurrentLocationSince || todayISO());
      sfCurrentPill.textContent = `Current: ${sf.starfireCurrentLocationName || "â€”"}`;

      // preselect current location
      const curId = sf.starfireCurrentLocationId || null;
      const curName = sf.starfireCurrentLocationName || "";

      if(curId){
        for(const opt of sfLoc.options){
          try{
            const v = JSON.parse(opt.value);
            if(v.kind === "equip" && v.id === curId){
              sfLoc.value = opt.value;
              break;
            }
          }catch{}
        }
      } else {
        for(const opt of sfLoc.options){
          try{
            const v = JSON.parse(opt.value);
            if(v.kind === "quick" && v.name === curName){
              sfLoc.value = opt.value;
              break;
            }
          }catch{}
        }
      }

      openSheet(sfSheet);
    }

    sfClose.addEventListener("click", ()=> closeSheet(sfSheet));
    sfCancel.addEventListener("click", ()=> closeSheet(sfSheet));

    sfSave.addEventListener("click", async ()=>{
      if(!state.sfSelected) return;

      let choice=null;
      try{ choice = JSON.parse(sfLoc.value); }catch{ return; }
      const since = (sfSince.value || "").trim() || todayISO();

      const patch = {};
      if(choice.kind === "quick"){
        patch.starfireCurrentLocationId = null;
        patch.starfireCurrentLocationName = choice.name;
        patch.starfireCurrentLocationType = choice.type;
        patch.starfireCurrentLocationSince = since;
      } else if(choice.kind === "equip"){
        patch.starfireCurrentLocationId = choice.id;
        patch.starfireCurrentLocationName = choice.name;
        patch.starfireCurrentLocationType = choice.type;
        patch.starfireCurrentLocationSince = since;
      }

      try{
        const db = getFirestore();
        await updateDoc(doc(db, "equipment", state.sfSelected.id), patch);

        Object.assign(state.sfSelected, patch);
        showToast("Location saved.");
        closeSheet(sfSheet);
        renderList();
      }catch(e){
        console.error(e);
        showError(e.message || "Save failed.");
      }
    });

    // ---- Load ----
    async function loadAll(){
      try{
        const db = getFirestore();
        const snap = await getDocs(collection(db, "equipment"));

        const all = [];
        snap.forEach(d=>{
          all.push({ id: d.id, ...d.data() });
        });

        state.all = all;

        // Build active equipment list for StarFire location picker
        state.equipActive = all
          .filter(isActive)
          .filter(d => norm(d.type) !== "starfire")
          .sort((a,b)=> String(a.name||"").localeCompare(String(b.name||""), undefined, { sensitivity:"base" }));

        renderList();
      }catch(e){
        console.error(e);
        showError(e.message || "Load failed.");
        listBox.innerHTML = `<div class="muted">Load failed.</div>`;
      }
    }

    function wireSearch(){
      qInput.addEventListener("input", ()=>{
        state.q = qInput.value || "";
        renderList();
      });
    }

    btnRefresh.addEventListener("click", loadAll);

    (async()=>{
      await ready;
      renderTabs();
      wireSearch();
      await loadAll();
    })();

    // init tabs UI
    renderTabs();
  </script>
</body>
</html>
