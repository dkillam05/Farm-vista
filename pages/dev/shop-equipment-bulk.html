<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista ‚Ä¢ Dev ‚Ä¢ Shop Equipment Bulk View</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <!-- Ensure fv-shell -->
  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js'; s.defer=true; document.head.appendChild(s);
      }
    })();
  </script>

  <!-- Firebase config FIRST (for firebase-init imports) -->
  <script src="/Farm-vista/js/firebase-config.js"></script>

  <style>
    :root{
      --green:#2F6C3C;
      --danger:#b3261e;
    }

    /* Desktop / default */
    .page{
      max-width:1400px; /* ‚úÖ larger on desktop */
      margin:0 auto;
      padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + 72px)!important;
    }
    .page-title{margin:0 0 8px 0;}
    .page-sub{margin:0 0 14px 0;color:var(--muted,#67706B);font-weight:800;}

    .alert{
      display:none;margin:0 0 12px 0;border:1px solid #c62828;background:#fdecea;color:#8a1c1c;
      border-radius:12px;padding:12px 14px;font-weight:950;
    }
    .alert.show{display:block;}

    /* ‚ÄúHero card‚Äù (section) ‚Äì good on desktop, removed on mobile via media query */
    .section{
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));
      overflow:hidden;
    }

    .section-head{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);
    }

    .head-left{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
    .icon{width:24px;height:24px;display:grid;place-items:center;color:var(--green);flex:0 0 auto;}
    .head-title{font-weight:950;}
    .pill{
      font-size:12px;
      border:1px solid var(--border);
      padding:3px 8px;
      border-radius:999px;
      color:var(--muted,#67706B);
      background:var(--surface);
      white-space:nowrap;
      font-weight:950;
    }
    .pill-ok{border-color:var(--green);color:var(--green);}

    /* controls row: dropdown + search SAME ROW */
    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      width:100%;
      min-width:0;
    }
    @media(min-width: 980px){
      .controls{ width:auto; }
    }

    .filter{
      display:flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--border);
      border-radius:12px;
      padding:8px 10px;
      background:var(--card-surface,var(--surface));
      max-width: 260px;  /* ‚úÖ cannot stick out */
      min-width: 0;
      flex: 0 1 260px;   /* ‚úÖ allow shrink */
    }
    .filter label{
      font-size:12px;
      font-weight:950;
      color:var(--muted,#67706B);
      white-space:nowrap;
      flex: 0 0 auto;
    }
    .filter select{
      width: 100%;
      min-width: 0;
      border:1px solid var(--border);
      background:var(--surface);
      color:var(--text);
      border-radius:10px;
      padding:8px 10px;
      font:inherit;
      font-size:14px;
      font-weight:900;
      outline:none;
    }

    .search{
      display:flex;
      align-items:center;
      gap:8px;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      background:var(--card-surface,var(--surface));
      flex: 1 1 420px;
      min-width: 240px;
    }
    .search input{
      width:100%;
      border:none;
      outline:none;
      background:transparent;
      font:inherit;
      font-size:16px;
      color:var(--text);
      min-width:0;
    }

    .section-body{padding:16px;}

    /* ===== Spreadsheet table ===== */
    .table-wrap{
      border:1px solid var(--border);
      border-radius:12px;
      overflow:hidden;
      background:var(--surface);
    }
    .scroll-x{
      overflow-x:auto;
      -webkit-overflow-scrolling:touch;
    }
    table.grid{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width: 1040px; /* slightly less than before */
      font-size:14px;
      color:var(--text);
    }
    thead th{
      position:sticky;
      top:0;
      z-index:2;
      background:var(--surface);
      border-bottom:1px solid var(--border);
      padding:10px 10px;
      font-size:12px;
      color:var(--muted,#67706B);
      font-weight:950;
      letter-spacing:.2px;
      white-space:nowrap;
      text-align:center;
    }
    tbody td{
      border-bottom:1px solid var(--border);
      padding:10px 10px;
      vertical-align:middle;
      white-space:nowrap;
      text-align:center;
    }
    tbody tr{
      cursor:pointer;
      background:transparent;
    }
    tbody tr:hover{ background:rgba(47,108,60,.06); }
    tbody tr.activeRow{
      outline:2px solid rgba(47,108,60,.35);
      outline-offset:-2px;
      background:rgba(47,108,60,.08);
    }

    .cell-title{font-weight:950;}
    .cell-sub{font-size:12px;color:var(--muted,#67706B);font-weight:850;}
    .stack{display:flex;flex-direction:column;gap:3px;align-items:center;}
    .kpi{font-weight:950;}
    .muted{color:var(--muted,#67706B);font-size:12px;font-weight:850;}
    .hint-line{
      margin-top:10px;
      color:var(--muted,#67706B);
      font-size:13px;
      font-weight:850;
    }

    /* On wide desktop: reduce horizontal scroll by allowing wrap on some columns */
    @media(min-width: 1200px){
      table.grid{ min-width: 0; }          /* allow it to fit */
      tbody td.wrap, thead th.wrap{
        white-space: normal;               /* wrap on desktop only */
      }
    }

    /* Mobile: REMOVE hero card restriction + edge-to-edge sheet feel */
    @media(max-width: 820px){
      .page{
        max-width:none;
        margin:0;
        padding:0;
        padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + 72px)!important;
      }
      .page-title, .page-sub{
        padding: 14px 14px 0 14px;
      }
      .page-sub{ padding-bottom: 10px; }

      .section{
        border:none;
        border-radius:0;
        box-shadow:none;
        background:transparent;
      }
      .section-head{
        border-left:none;border-right:none;
        border-radius:0;
        padding:12px 14px;
      }
      .section-body{
        padding:0;
      }
      .table-wrap{
        border:none;
        border-radius:0;
      }
      table.grid{
        min-width: 920px; /* still sheet-like on phone (side-scroll allowed) */
      }
    }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      bottom:calc(env(safe-area-inset-bottom,0px)+72px);
      transform:translateX(-50%);
      background:var(--green);
      color:#fff;
      padding:10px 14px;
      border-radius:10px;
      box-shadow:0 6px 20px rgba(0,0,0,.25);
      z-index:99999;
      display:none;
      font-weight:950;
    }
    .toast.show{display:block;animation:fadeout 2.8s forwards;}
    @keyframes fadeout{0%{opacity:1}85%{opacity:1}100%{opacity:0}}

    /* Dialog (sheet) */
    dialog.sheet{
      width:min(860px, 94vw);
      border:1px solid var(--border);
      border-radius:14px;
      padding:0;
      background:var(--card-surface,var(--surface));
      color:var(--text);
      box-shadow:0 18px 40px rgba(0,0,0,.45);
    }
    .sheet::backdrop{ background:rgba(0,0,0,.55); }
    .sheet header{
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .sheet header strong{font-weight:950;}
    .sheet .body{
      padding:14px 16px;
      max-height:70vh;
      overflow-y:auto;
      overflow-x:hidden;
      display:grid;
      gap:14px;
    }
    .sheet footer{
      padding:12px 16px;
      border-top:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:8px 14px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--card-surface,var(--surface));
      font-weight:950;
      cursor:pointer;
      font-size:14px;
      text-decoration:none;
      color:var(--text);
    }
    .btn-primary{border-color:transparent;background:var(--green);color:#fff !important;}

    .grid-2{display:grid;gap:10px;grid-template-columns:1fr 1fr;}
    @media(max-width:880px){ .grid-2{grid-template-columns:1fr;} }

    .field label{
      display:block;
      font-weight:950;
      margin:0 0 6px 0;
    }
    .input,.select,.textarea{
      width:100%;
      font:inherit;
      font-size:16px;
      color:var(--text);
      background:var(--card-surface,var(--surface));
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px 12px;
      outline:none;
    }
    .textarea{min-height:120px;resize:vertical;}
    .help{font-size:13px;color:var(--muted,#67706B);font-weight:850;}

    .subcard{
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--surface);
      padding:12px;
      display:grid;
      gap:10px;
    }

    .srList{display:grid;gap:8px;}
    .srItem{
      border:1px solid var(--border);
      border-radius:10px;
      background:var(--card-surface,var(--surface));
      padding:10px 12px;
      display:grid;
      gap:4px;
    }
    .srTop{display:flex;gap:10px;justify-content:space-between;flex-wrap:wrap;align-items:flex-start;}
    .srTitle{font-weight:950;}
    .srMeta{color:var(--muted,#67706B);font-size:12px;font-weight:850;}
  </style>
</head>

<body>
  <fv-shell>
    <div class="page">
      <h1 class="page-title">Shop Equipment Bulk View (Dev)</h1>
      <p class="page-sub">
        Spreadsheet view. ACTIVE ONLY. Click any equipment row to open <strong>Work Orders</strong> + <strong>Lifetime Notes</strong>.
        StarFire: double-click / long-press to change location.
      </p>

      <div id="alert" class="alert" role="alert"></div>

      <section class="section">
        <header class="section-head">
          <div class="head-left">
            <div class="icon" aria-hidden="true">üß∞</div>
            <div class="head-title">Shop Bulk</div>
            <span class="pill pill-ok">ACTIVE</span>
          </div>

          <div class="controls">
            <div class="filter" aria-label="Category filter">
              <label for="cat">Category</label>
              <select id="cat"></select>
            </div>

            <div class="search" role="search" aria-label="Search equipment">
              <span class="pill">Search</span>
              <input id="q" type="search" placeholder="unitId, name, serial, notes‚Ä¶" autocomplete="off">
            </div>
          </div>
        </header>

        <div class="section-body">
          <div class="table-wrap">
            <div class="scroll-x">
              <table class="grid" aria-label="Equipment spreadsheet">
                <thead id="thead"></thead>
                <tbody id="tbody">
                  <tr><td class="muted" style="padding:12px;">Loading‚Ä¶</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <div class="hint-line" id="hintLine"></div>
        </div>
      </section>
    </div>
  </fv-shell>

  <div id="toast" class="toast" role="status" aria-live="polite">Saved.</div>

  <!-- WORK ORDERS + NOTES SHEET -->
  <dialog id="svcSheet" class="sheet" aria-modal="true">
    <header>
      <strong id="svcTitle">Equipment</strong>
      <button id="svcClose" class="btn" type="button">Close</button>
    </header>

    <div class="body">
      <div class="subcard">
        <div class="muted" id="svcMeta">‚Äî</div>
      </div>

      <div class="subcard">
        <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;">
          <strong>Lifetime Notes</strong>
          <span class="pill" id="notesPill">Firestore</span>
        </div>
        <textarea id="lifetimeNotes" class="textarea" placeholder="Lifetime notes for this unit‚Ä¶"></textarea>
        <div class="help">Saved to Firestore field <code>lifetimeNotes</code> on this equipment doc.</div>
        <div style="display:flex;justify-content:flex-end;">
          <button id="btnSaveNotes" class="btn btn-primary" type="button">Save Notes</button>
        </div>
      </div>

      <div class="subcard">
        <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center;">
          <strong>Work Orders</strong>
          <span class="muted" id="woCount">‚Äî</span>
        </div>

        <div class="srList" id="woList">
          <div class="muted">Loading‚Ä¶</div>
        </div>

        <div class="help">Reads from <code>equipmentWorkOrders</code> where <code>equipmentId</code> matches.</div>

        <div style="border-top:1px solid var(--border); padding-top:12px; display:grid; gap:10px;">
          <strong>Add Work Order</strong>

          <div class="grid-2">
            <div class="field">
              <label for="woDate">Date (YYYY-MM-DD)</label>
              <input id="woDate" class="input" inputmode="numeric" placeholder="2026-01-21">
            </div>
            <div class="field">
              <label for="woSummary">Summary</label>
              <input id="woSummary" class="input" placeholder="e.g., Fix hydraulic leak">
            </div>
          </div>

          <div class="field">
            <label for="woNotes">Details (optional)</label>
            <textarea id="woNotes" class="textarea" placeholder="What‚Äôs wrong / parts / notes‚Ä¶"></textarea>
          </div>

          <div style="display:flex;justify-content:flex-end;">
            <button id="btnAddWO" class="btn btn-primary" type="button">Add Work Order</button>
          </div>
        </div>
      </div>
    </div>

    <footer>
      <span class="muted">Dev: we‚Äôll tune fields + columns per category next.</span>
      <button class="btn" id="svcClose2" type="button">Close</button>
    </footer>
  </dialog>

  <!-- STARFIRE LOCATION SHEET -->
  <dialog id="sfSheet" class="sheet" aria-modal="true">
    <header>
      <strong id="sfTitle">Change StarFire Location</strong>
      <button id="sfClose" class="btn" type="button">Close</button>
    </header>

    <div class="body">
      <div class="grid-2">
        <div class="field">
          <label>StarFire Serial</label>
          <input id="sfSerial" class="input" readonly>
          <div class="help">Read-only. You‚Äôre updating the current location.</div>
        </div>
        <div class="field">
          <label for="sfSince">Location Since</label>
          <input id="sfSince" class="input" inputmode="numeric" placeholder="YYYY-MM-DD">
          <div class="help">Defaults to today.</div>
        </div>
      </div>

      <div class="field">
        <label for="sfLoc">New Location</label>
        <select id="sfLoc" class="select"></select>
        <div class="help">Includes quick options + all ACTIVE equipment.</div>
      </div>

      <div class="field">
        <span class="pill" id="sfCurrentPill">Current: ‚Äî</span>
      </div>
    </div>

    <footer>
      <button id="sfCancel" class="btn" type="button">Cancel</button>
      <button id="sfSave" class="btn btn-primary" type="button">Save Location</button>
    </footer>
  </dialog>

  <script type="module">
    import {
      ready,
      getFirestore,
      collection,
      doc,
      getDocs,
      updateDoc,
      addDoc,
      query,
      where,
      orderBy,
      limit,
      serverTimestamp
    } from "/Farm-vista/js/firebase-init.js";

    const $ = s => document.querySelector(s);

    const alertBox = $("#alert");
    const tbody = $("#tbody");
    const thead = $("#thead");
    const hintLine = $("#hintLine");
    const toast = $("#toast");

    const catSelect = $("#cat");
    const qInput = $("#q");

    // work order sheet
    const svcSheet = $("#svcSheet");
    const svcTitle = $("#svcTitle");
    const svcClose = $("#svcClose");
    const svcClose2 = $("#svcClose2");
    const svcMeta = $("#svcMeta");
    const lifetimeNotes = $("#lifetimeNotes");
    const btnSaveNotes = $("#btnSaveNotes");
    const notesPill = $("#notesPill");
    const woList = $("#woList");
    const woCount = $("#woCount");
    const woDate = $("#woDate");
    const woSummary = $("#woSummary");
    const woNotes = $("#woNotes");
    const btnAddWO = $("#btnAddWO");

    // starfire sheet
    const sfSheet  = $("#sfSheet");
    const sfTitle  = $("#sfTitle");
    const sfClose  = $("#sfClose");
    const sfCancel = $("#sfCancel");
    const sfSave   = $("#sfSave");
    const sfSerial = $("#sfSerial");
    const sfSince  = $("#sfSince");
    const sfLoc    = $("#sfLoc");
    const sfCurrentPill = $("#sfCurrentPill");

    const QUICK_LOCS = [
      { id: null, name: "In Storage", type: "storage" },
      { id: null, name: "Shop", type: "shop" }
    ];

    const FILTERS = [
      { key:"planters", label:"Planters" },
      { key:"combines", label:"Combines" },
      { key:"sprayers", label:"Sprayers" },
      { key:"grain",   label:"Grain Carts / Handling" },
      { key:"tractors",label:"Tractors" },
      { key:"trucks",  label:"Trucks" },
      { key:"tillage", label:"Tillage" },
      { key:"seeders", label:"Seeders / Drills" },
      { key:"misc",    label:"Misc Implements" },
      { key:"starfire",label:"StarFire" },
      { key:"all",     label:"All" }
    ];

    const state = {
      all: [],
      equipActive: [],
      filter: "planters",
      q: "",
      sfSelected: null,
      svcSelected: null,
      selectedRowId: null
    };

    const norm = v => (v||"").toString().trim().toLowerCase();
    const isActive = d => norm(d.status) === "active";

    const todayISO = ()=>{
      const d=new Date(); const y=d.getFullYear();
      const m=String(d.getMonth()+1).padStart(2,"0");
      const da=String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${da}`;
    };

    const serialLast4 = (s)=>{
      if(!s) return "";
      const t=String(s).trim();
      return t.length<=4 ? t : t.slice(-4);
    };

    const showToast = (msg="Saved.")=>{
      toast.textContent = msg;
      toast.classList.remove("show");
      void toast.offsetWidth;
      toast.classList.add("show");
    };

    const showError = (msg)=>{
      alertBox.textContent = msg;
      alertBox.classList.add("show");
      clearTimeout(showError._t);
      showError._t = setTimeout(()=> alertBox.classList.remove("show"), 8000);
    };

    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, c => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
      }[c]));
    }

    function detectCategory(d){
      const t = norm(d.type);
      const it = norm(d.implementType);

      if(t === "starfire") return "starfire";
      if(t === "tractor") return "tractors";
      if(t === "truck") return "trucks";
      if(t === "sprayer") return "sprayers";
      if(t === "combine") return "combines";

      if(t === "implement"){
        if(it === "planter") return "planters";
        if(it.includes("grain") || it.includes("cart") || it.includes("auger") || it.includes("bin")) return "grain";
        if(it.includes("tillage")) return "tillage";
        if(it.includes("drill") || it.includes("seeder")) return "seeders";
        return "misc";
      }

      const name = ((d.name||"") + " " + (d.modelName||"")).toLowerCase();
      if(name.includes("planter")) return "planters";
      if(name.includes("combine")) return "combines";
      if(name.includes("sprayer")) return "sprayers";
      return "misc";
    }

    function matchesSearch(d, q){
      if(!q) return true;
      const hay = [
        d.unitId, d.name, d.makeName, d.modelName, d.serial, d.notes, d.lifetimeNotes,
        d.type, d.implementType, d.year,
        d.totalAcres, d.totalHours, d.engineHours,
        d.odometerMiles, d.licensePlate,
        d.starfireCurrentLocationName, d.starfireCurrentLocationSince
      ].map(x => (x==null?"":String(x))).join(" ").toLowerCase();
      return hay.includes(q);
    }

    function fmtNum(v){
      if(v==null || v==="") return "";
      const n = Number(v);
      if(Number.isNaN(n)) return String(v);
      return (Math.round(n*10)/10).toString();
    }

    function catLabel(d){
      const c = detectCategory(d);
      const map = {
        planters:"Planter", combines:"Combine", sprayers:"Sprayer", grain:"Grain",
        tractors:"Tractor", trucks:"Truck", tillage:"Tillage", seeders:"Seeder/Drill", misc:"Implement",
        starfire:"StarFire"
      };
      return map[c] || "Equipment";
    }

    function serialShort6(s){
      if(!s) return "";
      const t = String(s);
      return t.length <= 6 ? t : ("‚Ä¶" + t.slice(-6));
    }

    function colsForFilter(filter){
      if(filter === "starfire"){
        return [
          { label:"Serial", w: 260, wrap:false },
          { label:"Last 4", w: 90, wrap:false },
          { label:"Current Location", w: 340, wrap:true },
          { label:"Since", w: 140, wrap:false }
        ];
      }
      return [
        { label:"Unit ID", w: 160, wrap:false },
        { label:"Unit", w: 340, wrap:true },
        { label:"Category", w: 140, wrap:false },
        { label:"Year", w: 80, wrap:false },
        { label:"Serial", w: 160, wrap:false },
        { label:"Hours", w: 100, wrap:false },
        { label:"Acres", w: 100, wrap:false },
        { label:"Notes", w: 360, wrap:true }
      ];
    }

    function renderHead(cols){
      thead.innerHTML = `
        <tr>
          ${cols.map(c=>`<th class="${c.wrap ? 'wrap' : ''}" style="min-width:${c.w}px">${escapeHtml(c.label)}</th>`).join("")}
        </tr>
      `;
    }

    function filteredRows(){
      const q = norm(state.q);
      const active = state.all;

      if(state.filter === "starfire"){
        let arr = active.filter(d => norm(d.type) === "starfire");
        if(q) arr = arr.filter(d => matchesSearch(d, q));
        arr.sort((a,b)=> String(a.serial||"").localeCompare(String(b.serial||"")));
        return arr;
      }

      let arr = active.filter(d => norm(d.type) !== "starfire");
      if(state.filter !== "all"){
        arr = arr.filter(d => detectCategory(d) === state.filter);
      }
      if(q) arr = arr.filter(d => matchesSearch(d, q));

      arr.sort((a,b)=>{
        const an=(a.unitId||a.name||"").toLowerCase();
        const bn=(b.unitId||b.name||"").toLowerCase();
        if(an<bn) return -1;
        if(an>bn) return 1;
        return Number(b.year||0)-Number(a.year||0);
      });

      return arr;
    }

    // dialog helpers
    function openSheet(dlg){
      try{ dlg.showModal(); }catch{ dlg.setAttribute("open",""); }
    }
    function closeSheet(dlg){
      try{ dlg.close(); }catch{ dlg.removeAttribute("open"); }
    }

    // Work Orders + Notes
    async function openServiceSheet(eq){
      state.svcSelected = eq;

      const unitId = eq.unitId ? `Unit ID ${eq.unitId}` : "Unit ID ‚Äî";
      svcTitle.textContent = eq.unitId ? `${eq.unitId} ‚Ä¢ ${eq.name || "Equipment"}` : (eq.name || "Equipment");

      svcMeta.textContent = [
        unitId,
        catLabel(eq),
        eq.year ? `Year ${eq.year}` : "",
        eq.serial ? `Serial ${eq.serial}` : "",
        eq.makeName ? eq.makeName : "",
        eq.modelName ? eq.modelName : ""
      ].filter(Boolean).join(" ‚Ä¢ ");

      lifetimeNotes.value = eq.lifetimeNotes || "";
      notesPill.textContent = "Firestore";

      woList.innerHTML = `<div class="muted">Loading‚Ä¶</div>`;
      woCount.textContent = "‚Äî";

      woDate.value = todayISO();
      woSummary.value = "";
      woNotes.value = "";

      openSheet(svcSheet);

      await loadWorkOrders(eq.id);
    }

    async function loadWorkOrders(equipmentId){
      try{
        const db = getFirestore();

        // Try indexed query first (orderBy)
        let rows = [];
        try{
          const qy = query(
            collection(db, "equipmentWorkOrders"),
            where("equipmentId", "==", equipmentId),
            orderBy("createdAt", "desc"),
            limit(50)
          );
          const snap = await getDocs(qy);
          snap.forEach(d => rows.push({ id: d.id, ...d.data() }));
        }catch(orderErr){
          // Fallback: no orderBy (works without composite indexes)
          const qy2 = query(
            collection(db, "equipmentWorkOrders"),
            where("equipmentId", "==", equipmentId),
            limit(50)
          );
          const snap2 = await getDocs(qy2);
          snap2.forEach(d => rows.push({ id: d.id, ...d.data() }));
          // sort locally best-effort
          rows.sort((a,b)=>{
            const ad = String(a.date||"");
            const bd = String(b.date||"");
            if(ad < bd) return 1;
            if(ad > bd) return -1;
            return 0;
          });
        }

        woCount.textContent = rows.length ? `${rows.length} work order(s)` : "No work orders";

        if(!rows.length){
          woList.innerHTML = `<div class="muted">No work orders yet.</div>`;
          return;
        }

        woList.innerHTML = rows.map(r=>{
          const date = r.date || "";
          const summary = r.summary || r.title || "(no summary)";
          const status = r.status ? String(r.status) : "";
          const meta = [status ? `status: ${status}` : ""].filter(Boolean).join(" ‚Ä¢ ");
          const details = r.details || r.notes || "";
          return `
            <div class="srItem">
              <div class="srTop">
                <div class="srTitle">${escapeHtml(date)} ‚Äî ${escapeHtml(summary)}</div>
                <div class="srMeta">${escapeHtml(meta)}</div>
              </div>
              ${details ? `<div class="srMeta">${escapeHtml(details)}</div>` : ``}
            </div>
          `;
        }).join("");
      }catch(e){
        console.error(e);
        woList.innerHTML = `<div class="muted">Failed to load work orders.</div>`;
        woCount.textContent = "‚Äî";
      }
    }

    btnSaveNotes.addEventListener("click", async ()=>{
      if(!state.svcSelected) return;
      try{
        const db = getFirestore();
        const txt = (lifetimeNotes.value || "").trim();
        await updateDoc(doc(db, "equipment", state.svcSelected.id), { lifetimeNotes: txt });
        state.svcSelected.lifetimeNotes = txt;
        showToast("Notes saved.");
      }catch(e){
        console.error(e);
        showError(e.message || "Save notes failed.");
      }
    });

    btnAddWO.addEventListener("click", async ()=>{
      if(!state.svcSelected) return;

      const date = (woDate.value || "").trim() || todayISO();
      const summary = (woSummary.value || "").trim();
      const details = (woNotes.value || "").trim();

      if(!summary){
        alert("Need a summary.");
        return;
      }

      const payload = {
        equipmentId: state.svcSelected.id,
        unitId: state.svcSelected.unitId || null,
        equipmentName: state.svcSelected.name || null,
        date,
        summary,
        details,
        status: "open",
        createdAt: serverTimestamp()
      };

      try{
        const db = getFirestore();
        await addDoc(collection(db, "equipmentWorkOrders"), payload);
        showToast("Work order added.");
        woSummary.value = "";
        woNotes.value = "";
        await loadWorkOrders(state.svcSelected.id);
      }catch(e){
        console.error(e);
        showError(e.message || "Add work order failed.");
      }
    });

    svcClose.addEventListener("click", ()=> closeSheet(svcSheet));
    svcClose2.addEventListener("click", ()=> closeSheet(svcSheet));

    // StarFire location
    function buildLocationOptions(){
      sfLoc.innerHTML = "";

      QUICK_LOCS.forEach(q=>{
        const opt=document.createElement("option");
        opt.value = JSON.stringify({ kind:"quick", id:q.id, name:q.name, type:q.type });
        opt.textContent = q.name;
        sfLoc.appendChild(opt);
      });

      const sep=document.createElement("option");
      sep.disabled=true;
      sep.textContent="‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ";
      sfLoc.appendChild(sep);

      state.equipActive.forEach(e=>{
        const opt=document.createElement("option");
        const payload = {
          kind:"equip",
          id: e.id,
          name: e.name || "(unnamed)",
          unitId: e.unitId || "",
          type: norm(e.type) || "equipment"
        };
        opt.value = JSON.stringify(payload);
        const left = payload.unitId ? payload.unitId : payload.name;
        const sn = e.serial ? ` ‚Ä¢ ‚Ä¶${String(e.serial).slice(-4)}` : "";
        opt.textContent = `${left}${sn}`;
        sfLoc.appendChild(opt);
      });
    }

    function openStarfireSheet(sf){
      state.sfSelected = sf;
      buildLocationOptions();

      sfTitle.textContent = `Change StarFire Location ‚Ä¢ ‚Ä¶${serialLast4(sf.serial||"")}`;
      sfSerial.value = sf.serial || "";
      sfSince.value = (sf.starfireCurrentLocationSince || todayISO());
      sfCurrentPill.textContent = `Current: ${sf.starfireCurrentLocationName || "‚Äî"}`;

      const curId = sf.starfireCurrentLocationId || null;
      const curName = sf.starfireCurrentLocationName || "";

      if(curId){
        for(const opt of sfLoc.options){
          try{
            const v = JSON.parse(opt.value);
            if(v.kind === "equip" && v.id === curId){
              sfLoc.value = opt.value;
              break;
            }
          }catch{}
        }
      } else {
        for(const opt of sfLoc.options){
          try{
            const v = JSON.parse(opt.value);
            if(v.kind === "quick" && v.name === curName){
              sfLoc.value = opt.value;
              break;
            }
          }catch{}
        }
      }

      openSheet(sfSheet);
    }

    sfClose.addEventListener("click", ()=> closeSheet(sfSheet));
    sfCancel.addEventListener("click", ()=> closeSheet(sfSheet));

    sfSave.addEventListener("click", async ()=>{
      if(!state.sfSelected) return;

      let choice=null;
      try{ choice = JSON.parse(sfLoc.value); }catch{ return; }
      const since = (sfSince.value || "").trim() || todayISO();

      const patch = {};
      if(choice.kind === "quick"){
        patch.starfireCurrentLocationId = null;
        patch.starfireCurrentLocationName = choice.name;
        patch.starfireCurrentLocationType = choice.type;
        patch.starfireCurrentLocationSince = since;
      } else if(choice.kind === "equip"){
        // Use unitId/name for display
        const display = (choice.unitId && String(choice.unitId).trim())
          ? String(choice.unitId).trim()
          : choice.name;

        patch.starfireCurrentLocationId = choice.id;
        patch.starfireCurrentLocationName = display;
        patch.starfireCurrentLocationType = choice.type;
        patch.starfireCurrentLocationSince = since;
      }

      try{
        const db = getFirestore();
        await updateDoc(doc(db, "equipment", state.sfSelected.id), patch);

        Object.assign(state.sfSelected, patch);
        showToast("Location saved.");
        closeSheet(sfSheet);
        renderTable();
      }catch(e){
        console.error(e);
        showError(e.message || "Save failed.");
      }
    });

    // Render dropdown
    function renderFilterDropdown(){
      catSelect.innerHTML = FILTERS.map(f=>(
        `<option value="${escapeHtml(f.key)}">${escapeHtml(f.label)}</option>`
      )).join("");
      catSelect.value = state.filter;
    }

    // Render table
    function renderTable(){
      const cols = colsForFilter(state.filter);
      renderHead(cols);

      const arr = filteredRows();

      hintLine.textContent =
        (state.filter === "starfire")
          ? "StarFire: double-click (desktop) or long-press (phone) a row to change location."
          : "Click any row to open work orders + lifetime notes.";

      if(!arr.length){
        tbody.innerHTML = `<tr><td class="muted" colspan="${cols.length}" style="padding:12px;">No results.</td></tr>`;
        return;
      }

      tbody.innerHTML = arr.map(d=>{
        if(state.filter === "starfire"){
          const loc = d.starfireCurrentLocationName || "‚Äî";
          const since = d.starfireCurrentLocationSince || "";
          return `
            <tr data-id="${escapeHtml(d.id)}" data-kind="starfire">
              <td class="wrap"><div class="stack"><span class="cell-title">${escapeHtml(String(d.serial||""))}</span></div></td>
              <td class="kpi">${escapeHtml(serialLast4(d.serial||""))}</td>
              <td class="wrap">${escapeHtml(loc)}</td>
              <td class="muted">${escapeHtml(String(since||""))}</td>
            </tr>
          `;
        }

        const hours = (d.totalHours ?? d.engineHours ?? "");
        const acres = (d.totalAcres ?? "");
        const unitId = d.unitId ? String(d.unitId) : "";

        return `
          <tr data-id="${escapeHtml(d.id)}" data-kind="equip">
            <td><span class="cell-title">${escapeHtml(unitId || "‚Äî")}</span></td>
            <td class="wrap">
              <div class="stack">
                <span class="cell-title">${escapeHtml(d.name || "(unnamed)")}</span>
                <span class="cell-sub">${escapeHtml([d.makeName,d.modelName].filter(Boolean).join(" ‚Ä¢ "))}</span>
              </div>
            </td>
            <td class="muted">${escapeHtml(catLabel(d))}</td>
            <td class="muted">${escapeHtml(String(d.year||""))}</td>
            <td class="muted">${escapeHtml(serialShort6(d.serial||""))}</td>
            <td class="kpi">${escapeHtml(fmtNum(hours))}</td>
            <td class="kpi">${escapeHtml(fmtNum(acres))}</td>
            <td class="muted wrap">${escapeHtml(String(d.notes||""))}</td>
          </tr>
        `;
      }).join("");

      // Row interactions
      tbody.querySelectorAll("tr[data-id]").forEach(tr=>{
        const id = tr.getAttribute("data-id");
        const kind = tr.getAttribute("data-kind");

        tr.addEventListener("click", ()=>{
          state.selectedRowId = id;
          tbody.querySelectorAll("tr").forEach(r=>r.classList.remove("activeRow"));
          tr.classList.add("activeRow");

          if(kind === "equip"){
            const eq = state.all.find(x => x.id === id);
            if(eq) openServiceSheet(eq);
          }
        });

        if(kind === "starfire"){
          const sf = state.all.find(x => x.id === id);
          if(!sf) return;

          tr.addEventListener("dblclick", (e)=>{
            e.preventDefault();
            openStarfireSheet(sf);
          });

          let pressTimer=null;
          tr.addEventListener("touchstart", ()=>{
            pressTimer=setTimeout(()=> openStarfireSheet(sf), 520);
          }, {passive:true});
          tr.addEventListener("touchend", ()=>{ if(pressTimer) clearTimeout(pressTimer); }, {passive:true});
          tr.addEventListener("touchmove", ()=>{ if(pressTimer) clearTimeout(pressTimer); }, {passive:true});
        }
      });
    }

    // Events
    catSelect.addEventListener("change", ()=>{
      state.filter = catSelect.value;
      state.selectedRowId = null;
      renderTable();
    });

    qInput.addEventListener("input", ()=>{
      state.q = qInput.value || "";
      renderTable();
    });

    // Load / auto refresh
    async function loadAll(){
      try{
        const db = getFirestore();
        const snap = await getDocs(collection(db, "equipment"));

        const all = [];
        snap.forEach(d=> all.push({ id: d.id, ...d.data() }));

        // ACTIVE only
        state.all = all.filter(isActive);

        // ACTIVE equipment for StarFire location targets (exclude StarFire)
        state.equipActive = state.all
          .filter(d => norm(d.type) !== "starfire")
          .sort((a,b)=> String(a.unitId||a.name||"").localeCompare(String(b.unitId||b.name||""), undefined, { sensitivity:"base" }));

        renderTable();
      }catch(e){
        console.error(e);
        showError(e.message || "Load failed.");
        tbody.innerHTML = `<tr><td class="muted" style="padding:12px;">Load failed.</td></tr>`;
      }
    }

    function startAutoRefresh(){
      document.addEventListener("visibilitychange", ()=>{
        if(!document.hidden) loadAll();
      });
      window.addEventListener("focus", ()=> loadAll());
      setInterval(()=>{ if(!document.hidden) loadAll(); }, 60000);
    }

    (async()=>{
      await ready;
      renderFilterDropdown();
      await loadAll();
      startAutoRefresh();
    })();
  </script>
</body>
</html>
