<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FarmVista • Dev • Shop Equipment Bulk View</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#3B7E46" />

  <script src="/Farm-vista/js/theme-boot.js"></script>

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest" />
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png" />
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png" />
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css" />
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css" />

  <style>
    :root{
      --card-max: 1200px;
      --accent: #2F6C3C;
      --muted: rgba(255,255,255,.72);
      --chip: rgba(255,255,255,.10);
      --line: rgba(255,255,255,.14);
      --shadow: 0 10px 25px rgba(0,0,0,.25);
    }

    body{ background: var(--bg, #0f1411); color: var(--text, #fff); }

    .wrap{ max-width: var(--card-max); margin: 0 auto; padding: 14px 12px 90px; }
    .topbar{
      display:flex; align-items:center; gap:10px;
      position: sticky; top: 0; z-index: 10;
      padding: 10px 0;
      backdrop-filter: blur(10px);
      background: rgba(0,0,0,.25);
    }
    .title{
      font-weight: 800; letter-spacing:.2px;
      font-size: 16px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--line);
      box-shadow: var(--shadow);
      flex: 0 0 auto;
    }
    .actions{ display:flex; gap:8px; margin-left:auto; align-items:center; }
    .btn{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: #fff; /* ✅ white text on green/primary */
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 700;
      font-size: 13px;
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
    }
    .btn.primary{
      background: var(--accent);
      border-color: rgba(0,0,0,.15);
      color: #fff; /* ✅ */
    }
    .btn.ghost{
      background: transparent;
    }

    .bar{
      display:flex; gap:10px; align-items:center; flex: 1 1 auto;
      min-width: 0;
    }
    .search{
      flex: 1 1 auto;
      display:flex; gap:8px; align-items:center;
      background: rgba(255,255,255,.06);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 10px 12px;
      box-shadow: var(--shadow);
      min-width: 0;
    }
    .search input{
      flex: 1 1 auto;
      min-width: 0;
      border: none;
      outline: none;
      background: transparent;
      color: #fff;
      font-size: 14px;
    }
    .pill{
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.25);
      color: var(--muted);
      white-space: nowrap;
    }

    .tabs{
      display:flex; gap:8px; flex-wrap: wrap;
      margin: 12px 0 10px;
    }
    .tab{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: #fff;
      border-radius: 999px;
      padding: 9px 12px;
      font-weight: 800;
      font-size: 13px;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      background: var(--accent);
      color: #fff;
      border-color: rgba(0,0,0,.15);
    }

    .card{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      border-radius: 18px;
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .tableWrap{
      overflow-x: auto; /* ✅ allowed side-scroll */
      -webkit-overflow-scrolling: touch;
    }
    table{
      width: 100%;
      border-collapse: collapse;
      min-width: 820px;
    }
    thead th{
      text-align: left;
      font-size: 12px;
      color: var(--muted);
      font-weight: 800;
      letter-spacing:.2px;
      padding: 12px 12px;
      border-bottom: 1px solid var(--line);
      position: sticky;
      top: 0;
      background: rgba(10,14,11,.88);
      backdrop-filter: blur(8px);
      z-index: 2;
    }
    tbody td{
      padding: 12px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      font-size: 14px;
      vertical-align: top;
    }
    tbody tr{
      cursor: pointer;
    }
    tbody tr:hover{
      background: rgba(255,255,255,.04);
    }
    .name{
      font-weight: 900;
      line-height: 1.2;
    }
    .sub{
      font-size: 12px;
      color: var(--muted);
      margin-top: 3px;
      line-height: 1.2;
    }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      border: 1px solid var(--line);
      font-size: 12px;
      font-weight: 800;
      white-space: nowrap;
    }
    .badge.good{ background: rgba(47,108,60,.35); border-color: rgba(47,108,60,.55); }
    .badge.warn{ background: rgba(196,140,40,.25); border-color: rgba(196,140,40,.45); }
    .muted{ color: var(--muted); font-size: 12px; }

    /* Drawer */
    .drawerBackdrop{
      position: fixed; inset: 0;
      background: rgba(0,0,0,.55);
      display:none;
      z-index: 50;
    }
    .drawer{
      position: fixed; left: 0; right: 0; bottom: 0;
      max-width: var(--card-max);
      margin: 0 auto;
      background: rgba(12,16,13,.96);
      border: 1px solid var(--line);
      border-bottom: none;
      border-radius: 18px 18px 0 0;
      box-shadow: 0 -18px 40px rgba(0,0,0,.45);
      transform: translateY(110%);
      transition: transform .22s ease;
      z-index: 60;
      max-height: 82vh;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
    }
    .drawer.open{ transform: translateY(0); }
    .drawerHead{
      display:flex; align-items:center; gap:10px;
      padding: 12px 12px;
      border-bottom: 1px solid var(--line);
      position: sticky; top: 0;
      background: rgba(12,16,13,.96);
      z-index: 2;
    }
    .drawerTitle{
      font-weight: 900;
      font-size: 15px;
      line-height: 1.2;
      flex: 1 1 auto;
      min-width: 0;
    }
    .drawerClose{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: #fff;
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 900;
      cursor: pointer;
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      padding: 12px;
    }
    @media (max-width: 520px){
      .grid{ grid-template-columns: 1fr; }
    }
    .kv{
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      border-radius: 14px;
      padding: 10px 12px;
    }
    .k{ font-size: 11px; color: var(--muted); font-weight: 800; letter-spacing:.2px; }
    .v{ margin-top: 5px; font-size: 14px; font-weight: 800; }
    .qrBox{
      padding: 0 12px 14px;
    }
    .qrImg{
      width: 100%;
      max-width: 280px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      display:block;
    }

    .notice{
      margin-top: 12px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      border-radius: 18px;
      padding: 12px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
    }
    .notice strong{ color: #fff; }

    /* No blue links */
    a{ color: #fff; text-decoration: none; }
    a:hover{ text-decoration: underline; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="title">Dev • Shop Equipment Bulk</div>

      <div class="bar">
        <div class="search" role="search">
          <span class="pill">ACTIVE</span>
          <input id="q" type="search" placeholder="Search name, model, serial, year, notes…" autocomplete="off" />
        </div>
      </div>

      <div class="actions">
        <button class="btn ghost" id="btnRefresh">Refresh</button>
        <a class="btn primary" href="/Farm-vista/pages/dev/starfire-locations.html">StarFire Locations</a>
      </div>
    </div>

    <div class="tabs" id="tabs"></div>

    <div class="card">
      <div class="tableWrap">
        <table>
          <thead>
            <tr>
              <th style="min-width:260px;">Unit</th>
              <th style="min-width:160px;">Category</th>
              <th style="min-width:120px;">Year</th>
              <th style="min-width:160px;">Serial</th>
              <th style="min-width:120px;">Hours</th>
              <th style="min-width:120px;">Acres</th>
              <th style="min-width:200px;">Key Specs</th>
              <th style="min-width:120px;">Status</th>
              <th style="min-width:160px;">Updated</th>
            </tr>
          </thead>
          <tbody id="rows">
            <tr><td colspan="9" class="muted">Loading…</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="notice" id="notice">
      <strong>Dev page</strong> — reads from Firestore if Firebase is available on this page.  
      If you see “Firestore not available”, it means this file needs to be loaded inside your normal FarmVista auth/firebase boot chain.
    </div>
  </div>

  <!-- Drawer -->
  <div class="drawerBackdrop" id="drawerBackdrop"></div>
  <div class="drawer" id="drawer">
    <div class="drawerHead">
      <div class="drawerTitle" id="drawerTitle">Details</div>
      <button class="drawerClose" id="drawerClose">Close</button>
    </div>
    <div class="grid" id="drawerGrid"></div>
    <div class="qrBox" id="drawerQrBox" style="display:none;">
      <div class="k" style="margin-bottom:6px;">QR</div>
      <img class="qrImg" id="drawerQr" alt="QR" />
    </div>
  </div>

  <script>
    (function(){
      'use strict';

      const ACTIVE_ONLY = true;

      const CATS = [
        { key:'planters', label:'Planters' },
        { key:'combines', label:'Combines' },
        { key:'sprayers', label:'Sprayers' },
        { key:'grain', label:'Grain Carts / Handling' },
        { key:'tractors', label:'Tractors' },
        { key:'trucks', label:'Trucks' },
        { key:'tillage', label:'Tillage' },
        { key:'seeders', label:'Seeders / Drills' },
        { key:'misc', label:'Misc Implements' },
        { key:'all', label:'All (Active)' }
      ];

      const state = {
        all: [],
        cat: 'planters',
        q: ''
      };

      const $ = (id) => document.getElementById(id);

      function normStatus(v){
        return (v || '').toString().trim().toLowerCase();
      }

      function isActive(doc){
        const s = normStatus(doc.status);
        return s === 'active';
      }

      function serialShort(s){
        if(!s) return '';
        const t = String(s).trim();
        if(t.length <= 6) return t;
        return '…' + t.slice(-6);
      }

      function fmtDate(v){
        try{
          if(!v) return '';
          // Firestore timestamp-like {__time__:"..."} in your dump
          if(typeof v === 'object' && v.__time__){
            const d = new Date(v.__time__);
            return d.toLocaleString();
          }
          const d = new Date(v);
          if(isNaN(d.getTime())) return '';
          return d.toLocaleString();
        }catch(e){ return ''; }
      }

      function detectCategory(d){
        const t = (d.type || '').toString().toLowerCase();
        const it = (d.implementType || '').toString().toLowerCase();

        if(t === 'starfire') return 'guidance';
        if(t === 'tractor') return 'tractors';
        if(t === 'truck') return 'trucks';
        if(t === 'sprayer') return 'sprayers';
        if(t === 'combine') return 'combines';

        if(t === 'implement'){
          if(it === 'planter') return 'planters';
          if(it.includes('grain') || it.includes('cart') || it.includes('auger') || it.includes('bin')) return 'grain';
          if(it.includes('tillage')) return 'tillage';
          if(it.includes('drill') || it.includes('seeder')) return 'seeders';
          return 'misc';
        }

        // fallback by model keywords (light heuristic)
        const name = ((d.name||'') + ' ' + (d.modelName||'')).toLowerCase();
        if(name.includes('planter')) return 'planters';
        if(name.includes('combine')) return 'combines';
        if(name.includes('sprayer')) return 'sprayers';
        return 'misc';
      }

      function keySpecs(d){
        const t = (d.type||'').toLowerCase();
        const it = (d.implementType||'').toLowerCase();
        const parts = [];

        if(t === 'implement' && it === 'planter'){
          if(d.numRows) parts.push(`${d.numRows}R`);
          if(d.rowSpacingIn) parts.push(`${d.rowSpacingIn}"`);
          if(d.workingWidthFt) parts.push(`${d.workingWidthFt}ft`);
        } else if(t === 'sprayer'){
          if(d.boomWidthFt) parts.push(`${d.boomWidthFt}ft boom`);
          if(d.tankSizeGal) parts.push(`${d.tankSizeGal}gal`);
        } else if(t === 'tractor'){
          if(d.engineHours != null) parts.push(`${d.engineHours} hrs`);
        } else if(t === 'truck'){
          if(d.odometerMiles) parts.push(`${d.odometerMiles} mi`);
          if(d.licensePlate) parts.push(`Plate ${d.licensePlate}`);
        } else if(t === 'implement'){
          if(d.workingWidthFt) parts.push(`${d.workingWidthFt}ft`);
        }

        return parts.join(' • ');
      }

      function matchesSearch(d, q){
        if(!q) return true;
        const hay = [
          d.name, d.makeName, d.modelName, d.serial, d.notes,
          d.type, d.implementType, d.year, d.numRows, d.workingWidthFt
        ].map(x => (x==null?'':String(x))).join(' ').toLowerCase();
        return hay.includes(q);
      }

      function filtered(){
        let arr = state.all.slice();

        // active-only default
        if(ACTIVE_ONLY){
          arr = arr.filter(isActive);
        }

        // exclude starfire from shop bulk view
        arr = arr.filter(d => (d.type||'').toLowerCase() !== 'starfire');

        // category filter
        if(state.cat && state.cat !== 'all'){
          arr = arr.filter(d => detectCategory(d) === state.cat);
        }

        // search
        const q = (state.q||'').trim().toLowerCase();
        if(q) arr = arr.filter(d => matchesSearch(d, q));

        // sort: name then year desc
        arr.sort((a,b)=>{
          const an = (a.name||'').toLowerCase();
          const bn = (b.name||'').toLowerCase();
          if(an < bn) return -1;
          if(an > bn) return 1;
          const ay = Number(a.year||0), by = Number(b.year||0);
          return by - ay;
        });

        return arr;
      }

      function renderTabs(){
        const el = $('tabs');
        el.innerHTML = '';
        CATS.forEach(c=>{
          const b = document.createElement('div');
          b.className = 'tab' + (state.cat === c.key ? ' active' : '');
          b.textContent = c.label;
          b.addEventListener('click', ()=>{
            state.cat = c.key;
            renderTabs();
            renderRows();
          });
          el.appendChild(b);
        });
      }

      function renderRows(){
        const rows = $('rows');
        const arr = filtered();

        if(!arr.length){
          rows.innerHTML = `<tr><td colspan="9" class="muted">No results.</td></tr>`;
          return;
        }

        rows.innerHTML = arr.map(d=>{
          const cat = detectCategory(d);
          const st = normStatus(d.status);
          const stBadge = st === 'active' ? 'good' : 'warn';
          const hrs = (d.totalHours ?? d.engineHours ?? d.totalHours ?? null);
          const acres = (d.totalAcres ?? null);
          return `
            <tr data-id="${esc(d.__id)}">
              <td>
                <div class="name">${esc(d.name || '(unnamed)')}</div>
                <div class="sub">${esc((d.makeName||'') + (d.modelName ? ' • ' + d.modelName : '') )}</div>
              </td>
              <td><span class="badge">${esc(labelForCat(cat))}</span></td>
              <td>${esc(d.year ?? '')}</td>
              <td class="muted">${esc(serialShort(d.serial || ''))}</td>
              <td>${esc(hrs ?? '')}</td>
              <td>${esc(acres ?? '')}</td>
              <td class="muted">${esc(keySpecs(d) || '')}</td>
              <td><span class="badge ${stBadge}">${esc((d.status||'').toString())}</span></td>
              <td class="muted">${esc(fmtDate(d.updatedAt || d.createdAt) || '')}</td>
            </tr>
          `;
        }).join('');

        // row click => drawer
        rows.querySelectorAll('tr[data-id]').forEach(tr=>{
          tr.addEventListener('click', ()=>{
            const id = tr.getAttribute('data-id');
            const doc = state.all.find(x => x.__id === id);
            if(doc) openDrawer(doc);
          });
        });
      }

      function labelForCat(cat){
        const map = {
          planters:'Planter',
          combines:'Combine',
          sprayers:'Sprayer',
          grain:'Grain',
          tractors:'Tractor',
          trucks:'Truck',
          tillage:'Tillage',
          seeders:'Seeder/Drill',
          misc:'Implement'
        };
        return map[cat] || 'Equipment';
      }

      function esc(s){
        return String(s ?? '').replace(/[&<>"']/g, (c)=>({
          '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
        }[c]));
      }

      // Drawer
      const drawer = $('drawer');
      const backdrop = $('drawerBackdrop');

      function openDrawer(d){
        $('drawerTitle').textContent = d.name || 'Details';

        const kvs = [
          ['Type', (d.type||'')],
          ['Implement Type', (d.implementType||'')],
          ['Year', d.year ?? ''],
          ['Make', d.makeName ?? ''],
          ['Model', d.modelName ?? ''],
          ['Serial', d.serial ?? ''],
          ['Status', d.status ?? ''],
          ['Total Hours', d.totalHours ?? d.engineHours ?? ''],
          ['Total Acres', d.totalAcres ?? ''],
          ['Working Width (ft)', d.workingWidthFt ?? ''],
          ['Rows', d.numRows ?? ''],
          ['Row Spacing (in)', d.rowSpacingIn ?? ''],
          ['Notes', d.notes ?? '']
        ];

        const grid = $('drawerGrid');
        grid.innerHTML = kvs
          .filter(([k,v]) => String(v ?? '').trim() !== '')
          .map(([k,v])=>`
            <div class="kv">
              <div class="k">${esc(k)}</div>
              <div class="v">${esc(v)}</div>
            </div>
          `).join('') || `<div class="muted" style="padding:12px;">No details.</div>`;

        // QR (data URL or url/path object)
        const qr = d.qr && d.qr.image ? d.qr.image : (d.qr && d.qr.image && d.qr.image.url ? d.qr.image.url : null);
        const qrBox = $('drawerQrBox');
        const qrImg = $('drawerQr');
        if(typeof qr === 'string' && qr.startsWith('data:image')){
          qrImg.src = qr;
          qrBox.style.display = '';
        } else if(d.qr && d.qr.image && d.qr.image.url){
          qrImg.src = d.qr.image.url;
          qrBox.style.display = '';
        } else {
          qrBox.style.display = 'none';
        }

        backdrop.style.display = 'block';
        requestAnimationFrame(()=> drawer.classList.add('open'));
      }

      function closeDrawer(){
        drawer.classList.remove('open');
        setTimeout(()=>{ backdrop.style.display = 'none'; }, 180);
      }

      $('drawerClose').addEventListener('click', closeDrawer);
      backdrop.addEventListener('click', closeDrawer);

      // Firebase / Firestore loading (robust detection)
      async function loadEquipment(){
        $('rows').innerHTML = `<tr><td colspan="9" class="muted">Loading…</td></tr>`;

        try{
          // Strategy 1: firebase compat
          if(window.firebase && window.firebase.firestore){
            const db = window.firebase.firestore();
            const snap = await db.collection('equipment').get();
            state.all = snap.docs.map(doc => ({ __id: doc.id, ...doc.data() }));
            $('notice').style.display = 'none';
            renderRows();
            return;
          }

          // Strategy 2: FV / Firestore modular exposed on window
          if(window.FV && window.FV.firestore){
            const snap = await window.FV.firestore.collection('equipment').get();
            state.all = snap.docs.map(doc => ({ __id: doc.id, ...doc.data() }));
            $('notice').style.display = 'none';
            renderRows();
            return;
          }

          // Strategy 3: If your firebase-init exposes something else, we’ll adjust later
          throw new Error('Firestore not available (no firebase/firestore found on window).');
        }catch(err){
          console.error(err);
          $('rows').innerHTML = `<tr><td colspan="9" class="muted">Firestore not available on this page. Open console for details.</td></tr>`;
          $('notice').style.display = '';
        }
      }

      $('q').addEventListener('input', (e)=>{
        state.q = e.target.value || '';
        renderRows();
      });

      $('btnRefresh').addEventListener('click', ()=>{
        loadEquipment();
      });

      // init
      renderTabs();
      loadEquipment();
      renderRows();

    })();
  </script>
</body>
</html>
