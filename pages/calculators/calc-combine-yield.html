<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>FarmVista - Combine Yield</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#3B7E46">
  <link rel="manifest" href="../../manifest.webmanifest">
  <link rel="apple-touch-icon" href="../../assets/icons/apple-touch-icon.png">
  <link rel="icon" href="../../assets/icons/icon-192.png">
  <script defer src="../../js/theme-boot.js"></script>
  <link rel="stylesheet" href="../../assets/css/theme.css">
  <link rel="stylesheet" href="../../assets/css/app.css">
  <script defer src="../../js/fv-shell.js"></script>
  <style>
    :root { --page-bottom-gap: 56px; }
    .wrap { max-width: 900px; margin: 0 auto; padding: clamp(14px,3vw,22px);
      padding-bottom: calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + var(--page-bottom-gap)); }
    h1 { margin: 8px 0 6px; font-size: clamp(22px,3.5vw,28px); }
    .form { display: grid; gap: 12px; margin: 14px 0 18px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 700px) { .row { grid-template-columns: 1fr; } }
    .out { padding: 12px; border: 1px solid var(--border); border-radius: 10px; background: var(--surface); }
    .muted { color: var(--muted, #67706B); }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    td { padding: 6px 4px; border-bottom: 1px solid var(--border); }
    .hist h2 { margin: 18px 0 8px; font-size: 18px; }
    .hist .actions { display: flex; gap: 8px; justify-content: flex-end; }
    .btn-link { background: none; border: 0; color: inherit; text-decoration: underline; cursor: pointer; padding: 0; }
  </style>
</head>
<body>
  <fv-shell>
    <div class="wrap">
      <h1>Combine Yield</h1>
      <p class="muted">Quick strip yield from weight and dimensions. Adjusts to standard moisture.</p>

      <div class="form">
        <div class="row">
          <label>Crop
            <select id="crop">
              <option value="corn">Corn (56 lb/bu at 15.5%)</option>
              <option value="soy">Soybeans (60 lb/bu at 13.0%)</option>
            </select>
          </label>
          <label>Wet Weight (lb)
            <input id="wt" type="number" inputmode="decimal" step="any" min="0" autofocus>
          </label>
        </div>
        <div class="row">
          <label>Moisture (%)
            <input id="mc" type="number" inputmode="decimal" step="any" min="0" max="100">
          </label>
          <label>Strip Width (ft)
            <input id="w" type="number" inputmode="decimal" step="any" min="0">
          </label>
        </div>
        <div class="row">
          <label>Strip Length (ft)
            <input id="l" type="number" inputmode="decimal" step="any" min="0">
          </label>
          <label>Standard Moisture (%)
            <input id="std" type="number" inputmode="decimal" step="any" min="0" max="100" value="15.5">
          </label>
        </div>
      </div>

      <div class="out" id="results" hidden>
        <div><strong>Area:</strong> <span id="areaAc">-</span> acres</div>
        <div><strong>Dry Bushels:</strong> <span id="bu">-</span> bu</div>
        <div><strong>Dry Yield:</strong> <span id="bpa">-</span> bu/ac</div>
        <div class="muted"><em>Method:</em> dryWeight = wet * (100 - mc) / (100 - std); bu = dryWeight / testWeight</div>
      </div>

      <section class="hist" id="history">
        <div style="display:flex;align-items:center;gap:10px">
          <h2 style="flex:1">Previous Calculations</h2>
          <div class="actions"><button class="btn-link" id="clear">Clear</button></div>
        </div>
        <div class="muted" id="nohist">No previous combine yield calculations.</div>
        <table id="histTable" hidden><tbody></tbody></table>
      </section>
    </div>
  </fv-shell>

  <script>
  (function(){
    "use strict";
    var LS_KEY = "fv_calc_combine_yield";
    function $(id){ return document.getElementById(id); }
    var ids = ["crop","wt","mc","w","l","std"];
    var inputs = [ $("crop"), $("wt"), $("mc"), $("w"), $("l"), $("std") ];
    var res = $("results");

    function fmt(n,d){ if(d===void 0) d=2; return Number(n).toLocaleString(undefined,{maximumFractionDigits:d}); }
    function tw(c){ return c === "corn" ? 56 : 60; }
    function defStd(c){ return c === "corn" ? 15.5 : 13.0; }
    function load(){ try{ return JSON.parse(localStorage.getItem(LS_KEY) || "[]"); }catch(e){ return []; } }
    function save(a){ localStorage.setItem(LS_KEY, JSON.stringify(a.slice(0,10))); }

    $("crop").addEventListener("change", function(e){ $("std").value = defStd(e.target.value); });

    function renderHist(){
      var h = load(), no = $("nohist"), t = $("histTable"), tb = t.querySelector("tbody");
      if(!h.length){ no.hidden = false; t.hidden = true; return; }
      no.hidden = true; t.hidden = false; tb.innerHTML = "";
      for(var i=0;i<h.length;i++){
        var it = h[i];
        var tr = document.createElement("tr");
        tr.innerHTML =
          "<td>" + new Date(it.t).toLocaleString() + "</td>" +
          "<td>" + (it.crop==="corn"?"Corn":"Soy") + " - " + fmt(it.wt,0) + " lb at " + fmt(it.mc,1) + "%</td>" +
          "<td>" + fmt(it.areaAc,4) + " ac</td>" +
          "<td>" + fmt(it.bu,2) + " bu</td>" +
          "<td>" + fmt(it.bpa,1) + " bu/ac</td>";
        tb.appendChild(tr);
      }
    }

    function computeAndShow(saveRun){
      if(saveRun===void 0) saveRun = true;
      var crop = $("crop").value;
      var wt = parseFloat($("wt").value);
      var mc = parseFloat($("mc").value);
      var w = parseFloat($("w").value);
      var l = parseFloat($("l").value);
      var std = parseFloat($("std").value || defStd(crop));
      if(!(wt>0 && w>0 && l>0 && mc>=0 && std>0)){ res.hidden = true; return; }
      var areaAc = (w*l)/43560;
      var dryWeight = wt * ((100 - mc)/(100 - std));
      var bu = dryWeight / tw(crop);
      var bpa = bu / areaAc;

      $("areaAc").textContent = fmt(areaAc,4);
      $("bu").textContent = fmt(bu,2);
      $("bpa").textContent = fmt(bpa,1);
      res.hidden = false;

      if(saveRun){
        var h = load();
        h.unshift({t:Date.now(), crop:crop, wt:wt, mc:mc, w:w, l:l, std:std, areaAc:areaAc, bu:bu, bpa:bpa});
        save(h); renderHist();
      }
    }

    var to = null;
    for(var i=0;i<inputs.length;i++){
      inputs[i].addEventListener("input", function(){
        if(to) window.clearTimeout(to);
        to = window.setTimeout(function(){ computeAndShow(true); }, 150);
      });
    }
    $("clear").addEventListener("click", function(){ localStorage.removeItem(LS_KEY); renderHist(); });

    renderHist();
  })();
  </script>
</body>
</html>