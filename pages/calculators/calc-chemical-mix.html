<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>FarmVista - Chemical Mix</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<link rel="manifest" href="../../manifest.webmanifest">
<link rel="stylesheet" href="../../assets/css/theme.css">
<link rel="stylesheet" href="../../assets/css/app.css">
<script defer src="../../js/theme-boot.js"></script>
<script defer src="../../js/fv-shell.js"></script>
<style>
:root{ --page-bottom-gap:84px; --card-max:940px; --accent:#2F6C3C; --accent-2:#0F3B82; }
html{-webkit-text-size-adjust:100%}
body{ background: var(--app-bg, var(--surface)); }
.wrap{ max-width: var(--card-max); margin:0 auto; padding:clamp(14px,3vw,22px);
  padding-bottom: calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + var(--page-bottom-gap)); }

.calc-card{ border:1px solid var(--border); border-radius:14px; background:var(--surface);
  box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08)); overflow:hidden; }
.card-head{ display:flex; align-items:center; gap:12px; padding:14px 16px;
  background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);
  border-bottom:1px solid var(--border); }
.card-head .icon{ width:28px;height:28px; color:var(--accent);}
.card-head h1{ margin:0; font-size:clamp(20px,3.2vw,26px); line-height:1.2;}
.muted{ color:var(--muted,#67706B); }

form{ padding:16px; display:grid; gap:14px;}
.grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px;}
@media (max-width:760px){ .grid{ grid-template-columns:1fr; } }
label{ display:block; font-weight:600; margin-bottom:6px; }
.ctrl{ display:flex; align-items:center; gap:8px; border:1px solid var(--border);
  background:var(--card-surface,var(--surface)); border-radius:10px; padding:10px 12px; }
input,select,button{ font-size:16px; } /* prevent iOS zoom */
.ctrl input,.ctrl select{ width:100%; border:0; outline:0; background:transparent; color:var(--text); }
.ctrl .unit-right{ margin-left:auto; display:flex; align-items:center; }
.ctrl .unit-right select{ width:auto; min-width:118px; } /* ensure full text shows (oz/ac etc.) */
.unit{ font-size:12px; color:var(--muted,#67706B); white-space:nowrap; }

.note{ font-size:13px; color:var(--muted); margin-top:-4px; }

.row{ display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; }
@media (max-width:760px){ .row{ grid-template-columns:1fr; } }

.actions{ display:flex; gap:10px; justify-content:flex-end; padding-top:4px; }
.btn{ appearance:none; border:1px solid var(--border); background:var(--surface);
  padding:10px 14px; border-radius:10px; font-weight:700; cursor:pointer; }
.btn-primary{ background:var(--accent); color:#fff; border-color:var(--accent); }
.btn-link{ background:none; border:0; padding:0; text-decoration:underline; color:inherit; cursor:pointer; }

.products{ border-top:1px dashed var(--border); padding:12px 0 0; display:grid; gap:10px; }
.pcard{ border:1px solid var(--border); border-radius:12px; padding:12px; background:var(--card-surface,var(--surface)); }
.phead{ display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
.phead h3{ margin:0; font-size:15px; }
.remove{ border:1px solid var(--border); background:var(--surface); border-radius:8px; padding:6px 10px; cursor:pointer; font-weight:700; }

.results{ padding:0 16px 16px; }
.result-grid{ display:grid; grid-template-columns:1fr; gap:12px; }
.tile{ border:1px solid var(--border); border-radius:12px; padding:12px;
  background: linear-gradient(180deg, rgba(47,108,60,.06), transparent 55%); }
.tile h3{ margin:0 0 8px; font-size:16px; }
.kv{ display:grid; grid-template-columns:1fr auto; gap:6px 12px; align-items:baseline; }
.kv .val{ font-weight:800; }

/* Simple table for per-product totals */
table.mix{ width:100%; border-collapse:collapse; border:1px solid var(--border); border-radius:10px; overflow:hidden; }
table.mix th{ background:rgba(47,108,60,.08); text-align:left; padding:10px; border-bottom:1px solid var(--border); }
table.mix td{ padding:10px; border-bottom:1px solid var(--border); }
table.mix tr:last-child td{ border-bottom:0; }

.hist{ padding:16px; border-top:1px dashed var(--border); }
.hlist{ display:grid; gap:8px; }
.hitem{ display:flex; gap:10px; align-items:center; justify-content:space-between;
  padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:var(--card-surface,var(--surface)); }
.hsummary{ font-weight:700; }
.muted-line{ font-size:12px; color:var(--muted,#67706B); }

/* Centered modal */
.modal{ position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.42); z-index:9999; transition:opacity .15s; opacity:0;}
.modal[open]{ display:grid; opacity:1; }
.dialog{ width:min(760px,92vw); max-height:85vh; display:flex; flex-direction:column; background:var(--surface); color:var(--text);
  border-radius:14px; border:1px solid var(--border); box-shadow:0 16px 36px rgba(0,0,0,.28); }
.dialog-head{ padding:12px 14px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
.dialog-body{ padding:14px; overflow:auto; flex:1 1 auto; min-height:0; -webkit-overflow-scrolling:touch; }
.closex{ border:1px solid var(--border); background:var(--surface); border-radius:8px; padding:6px 10px; cursor:pointer; font-weight:700; }
.kv2{ display:grid; grid-template-columns:1fr 1fr; gap:8px 16px; }
@media (max-width:640px){ .kv2{ grid-template-columns:1fr; } }
html.no-scroll, body.no-scroll{ overflow:hidden; }
</style>
</head>
<body>
<fv-shell>
  <div class="wrap">
    <div class="calc-card">
      <div class="card-head">
        <div class="icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="1.6">
            <path d="M5 3h14M7 3l2 4h6l2-4M7 7v11a3 3 0 003 3h4a3 3 0 003-3V7"></path>
          </svg>
        </div>
        <div>
          <h1>Chemical Mix</h1>
          <div class="muted">Enter field area or tank size (one required), carrier rate, then add products (up to 7). Calculate to see per-tank & totals.</div>
        </div>
      </div>

      <!-- FORM -->
      <form id="frm" novalidate autocomplete="off">
        <div class="grid">
          <div>
            <label for="acres">Field Area</label>
            <div class="ctrl">
              <input id="acres" type="text" inputmode="decimal" placeholder="e.g. 125">
              <span class="unit">ac</span>
            </div>
            <div class="note">Optional. Provide this or tank size.</div>
          </div>

          <div>
            <label for="tank">Tank Size</label>
            <div class="ctrl">
              <input id="tank" type="text" inputmode="decimal" placeholder="e.g. 1000">
              <span class="unit">gal</span>
            </div>
            <div class="note">Optional. If filled (and carrier set), we’ll prefill Area with acres-per-tank.</div>
          </div>

          <div>
            <label for="carrier">Carrier Rate</label>
            <div class="ctrl">
              <input id="carrier" type="text" inputmode="decimal" placeholder="e.g. 15">
              <span class="unit">gal/ac</span>
            </div>
          </div>
        </div>

        <!-- PRODUCTS -->
        <div class="products" id="products"></div>
        <div class="actions" style="margin-top:6px">
          <button type="button" class="btn" id="addProd">Add Product</button>
          <button type="button" class="btn" id="clearProds">Clear Products</button>
        </div>

        <div class="actions">
          <button type="button" class="btn" id="clearInputs">Clear Inputs</button>
          <button type="submit" class="btn btn-primary" id="doCalc">Calculate</button>
        </div>
      </form>

      <!-- RESULTS -->
      <div class="results" id="results" hidden>
        <div class="tile">
          <h3>Summary</h3>
          <div class="kv">
            <div>Area</div> <div class="val" id="resArea">- ac</div>
            <div>Carrier</div> <div class="val" id="resCarrier">- gpa</div>
            <div>Tank Size</div> <div class="val" id="resTank">- gal</div>
            <div>Acres / Tank</div> <div class="val" id="resAcPerTank">- ac</div>
            <div>Tanks Needed</div> <div class="val" id="resTanks">-</div>
            <div>Total Water</div> <div class="val" id="resWaterTot">- gal</div>
          </div>
        </div>

        <div class="tile">
          <h3>Per-Product Mix</h3>
          <table class="mix" aria-label="Per-product mix">
            <thead>
              <tr><th>Product</th><th>Rate</th><th>Per Tank</th><th>Total</th></tr>
            </thead>
            <tbody id="mixBody"></tbody>
          </table>
        </div>
      </div>

      <!-- HISTORY -->
      <section class="hist">
        <div style="display:flex;align-items:center;gap:10px">
          <h2 style="flex:1">Previous Calculations</h2>
          <button class="btn-link" id="clearHist" type="button">Clear History</button>
        </div>
        <div class="hlist" id="hlist"></div>
        <div class="muted-line" id="nohist">No previous chemical mix calculations.</div>
      </section>
    </div>
  </div>
</fv-shell>

<!-- MODAL -->
<div class="modal" id="modal" aria-hidden="true">
  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="mdTitle">
    <div class="dialog-head">
      <h3 id="mdTitle">Mix Details</h3>
      <button class="closex" id="mdClose" type="button">Back</button>
    </div>
    <div class="dialog-body" id="mdBody"></div>
  </div>
</div>

<script>
(function(){
  "use strict";
  if (window.__FV_CHEMIX_V2__) return; window.__FV_CHEMIX_V2__ = true;

  function $(id){ return document.getElementById(id); }
  function num(v){ return parseFloat(String(v).replace(/,/g,"")); }
  function fmt(n,d){ if(d===void 0) d=2; return Number(n).toLocaleString(undefined,{maximumFractionDigits:d}); }

  var acresEl=$("acres"), tankEl=$("tank"), carrierEl=$("carrier");
  [acresEl,tankEl,carrierEl].forEach(function(i){ i.addEventListener("blur", function(){ i.value=i.value.replace(/[^0-9.]/g,""); }); });

  /* ------- Products ------- */
  var productsEl=$("products"), MAX_PROD=7, prodSeq=0;

  function unitLabel(u){
    return u==="gal"?"gal/ac":u==="qt"?"qt/ac":u==="pt"?"pt/ac":u==="dryoz"?"oz (dry)/ac":"oz/ac";
  }
  function unitToGal(u){
    if(u==="gal") return 1;
    if(u==="qt") return 0.25;
    if(u==="pt") return 0.125;
    if(u==="oz") return 1/128;
    return null; // dryoz has no gallon conversion
  }

  function addProductRow(name, rate, unit){
    if(productsEl.children.length>=MAX_PROD) return;
    var id = "p"+(++prodSeq);
    var card=document.createElement("div"); card.className="pcard"; card.setAttribute("data-id", id);
    card.innerHTML =
      '<div class="phead"><h3>Product</h3><button class="remove" type="button">Remove</button></div>'
    + '<div class="row">'
    +   '<div><label>Product name</label><div class="ctrl"><input class="pname" type="text" placeholder="e.g. Roundup" value="'+(name||'')+'"></div></div>'
    +   '<div><label>Product rate</label><div class="ctrl">'
    +     '<input class="prate" type="text" inputmode="decimal" placeholder="e.g. 32" value="'+(rate||'')+'">'
    +     '<span class="unit-right"><select class="punit" aria-label="Unit">'
    +       '<option value="oz">oz/ac (fl)</option>'
    +       '<option value="pt">pt/ac</option>'
    +       '<option value="qt">qt/ac</option>'
    +       '<option value="gal">gal/ac</option>'
    +       '<option value="dryoz">oz (dry)/ac</option>'
    +     '</select></span>'
    +   '</div></div>'
    +   '<div></div>'
    + '</div>';
    card.querySelector(".remove").addEventListener("click", function(){ card.remove(); });
    // set unit if supplied
    if(unit){ card.querySelector(".punit").value=unit; }
    // sanitize on blur
    card.querySelector(".prate").addEventListener("blur", function(e){ e.target.value=e.target.value.replace(/[^0-9.]/g,""); });
    productsEl.appendChild(card);
  }

  $("addProd").addEventListener("click", function(){ addProductRow(); });
  $("clearProds").addEventListener("click", function(){ productsEl.innerHTML=""; });

  // seed one row
  addProductRow();

  /* ------- Smart prefill: Tank -> Area ------- */
  function tryPrefillArea(){
    var t=num(tankEl.value), r=num(carrierEl.value);
    if(t>0 && r>0 && !acresEl.value){ var acPerTank = t / r; acresEl.value = String(Math.round(acPerTank*100)/100); }
  }
  tankEl.addEventListener("input", tryPrefillArea);
  carrierEl.addEventListener("input", tryPrefillArea);

  /* ------- Calculation ------- */
  var results=$("results");
  var resArea=$("resArea"), resCarrier=$("resCarrier"), resTank=$("resTank"),
      resAcPerTank=$("resAcPerTank"), resTanks=$("resTanks"), resWaterTot=$("resWaterTot"),
      mixBody=$("mixBody");

  function readProducts(){
    var rows=[].slice.call(productsEl.children);
    return rows.map(function(card){
      var name=(card.querySelector(".pname").value||"Product").trim();
      var rate=num(card.querySelector(".prate").value);
      var unit=card.querySelector(".punit").value;
      return { name:name, rate:rate, unit:unit };
    }).filter(function(p){ return p.rate>0; });
  }

  function calc(){
    var ac = num(acresEl.value), t = num(tankEl.value), r = num(carrierEl.value);
    var prods = readProducts();

    if(!(r>0)) { alert("Enter carrier rate (gal/ac)."); return null; }
    if(!(ac>0) && !(t>0)) { alert("Provide Field Area or Tank Size."); return null; }
    if(prods.length===0){ alert("Add at least one product with a rate."); return null; }

    // If only tank provided, treat area as acres per tank (single load)
    var acresPerTank = r>0 && t>0 ? (t / r) : 0;
    if(!(ac>0) && t>0){ ac = acresPerTank; }

    var totalWater = ac * r;
    var tanksNeeded = (t>0 && r>0) ? Math.ceil(ac / acresPerTank) : 1;

    // per-product gal conversions and totals
    var rows = prods.map(function(p){
      var galPerAc = unitToGal(p.unit); // null for dryoz
      var perTank_native, perTank_gal = null, total_native, total_gal = null;

      if(t>0 && r>0){
        var tankAcres = acresPerTank;
        perTank_native = p.rate * tankAcres;
        total_native = p.rate * ac;
        if(galPerAc!==null){
          perTank_gal = galPerAc * p.rate * tankAcres;
          total_gal = galPerAc * p.rate * ac;
        }
      } else {
        // No tank size; only totals make sense
        perTank_native = null; perTank_gal = null;
        total_native = p.rate * ac;
        if(galPerAc!==null){ total_gal = galPerAc * p.rate * ac; }
      }
      return {
        name:p.name, unit:p.unit, rate:p.rate,
        perTank_native:perTank_native, perTank_gal:perTank_gal,
        total_native:total_native, total_gal:total_gal
      };
    });

    return {
      t: Date.now(),
      acres: ac, carrier: r, tank: t||0,
      acresPerTank: acresPerTank||0, tanksNeeded: tanksNeeded,
      totalWater: totalWater, rows: rows
    };
  }

  function show(out){
    if(!out){ results.hidden=true; return; }
    resArea.textContent = fmt(out.acres,2)+" ac";
    resCarrier.textContent = fmt(out.carrier,2)+" gpa";
    resTank.textContent = out.tank? fmt(out.tank,0)+" gal" : "—";
    resAcPerTank.textContent = out.acresPerTank? fmt(out.acresPerTank,2)+" ac" : "—";
    resTanks.textContent = fmt(out.tanksNeeded,0);
    resWaterTot.textContent = fmt(out.totalWater,0)+" gal";

    mixBody.innerHTML="";
    out.rows.forEach(function(r){
      var rateLbl = fmt(r.rate,2)+" "+unitLabel(r.unit);
      var perTankLbl = "—";
      if(r.perTank_native!=null){
        perTankLbl = fmt(r.perTank_native,2)+" "+(r.unit==="dryoz"?"oz (dry)":"unit")
          .replace("unit",""+(r.unit==="gal"?"gal":r.unit==="qt"?"qt":r.unit==="pt"?"pt":"oz"));
        if(r.perTank_gal!=null) perTankLbl += "  •  "+fmt(r.perTank_gal,2)+" gal";
      }
      var totalLbl = fmt(r.total_native,2)+" "+(r.unit==="dryoz"?"oz (dry)":"unit")
        .replace("unit",""+(r.unit==="gal"?"gal":r.unit==="qt"?"qt":r.unit==="pt"?"pt":"oz"));
      if(r.total_gal!=null) totalLbl += "  •  "+fmt(r.total_gal,2)+" gal";

      var tr=document.createElement("tr");
      tr.innerHTML = '<td>'+r.name+'</td><td>'+rateLbl+'</td><td>'+perTankLbl+'</td><td>'+totalLbl+'</td>';
      mixBody.appendChild(tr);
    });
    results.hidden=false;
  }

  /* ------- History ------- */
  var LS_KEY="fv_calc_chemix_history_v2", hlist=$("hlist"), nohist=$("nohist");
  function load(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||"[]"); }catch(e){ return []; } }
  function save(arr){ localStorage.setItem(LS_KEY, JSON.stringify(arr.slice(0,10))); }
  function summary(it){
    return fmt(it.acres,2)+' ac @ '+fmt(it.carrier,2)+' gpa, '+it.rows.length+' product'
      +(it.rows.length>1?'s':'')+(it.tank?(', tank '+fmt(it.tank,0)+' gal'):'');
  }
  function renderHist(){
    var h=load(); hlist.innerHTML=""; if(!h.length){ nohist.hidden=false; return; } nohist.hidden=true;
    h.forEach(function(it,idx){
      var row=document.createElement("div"); row.className="hitem";
      row.innerHTML='<div class="hsummary">'+summary(it)+'</div><button class="btn-link" data-idx="'+idx+'" type="button">View</button>';
      hlist.appendChild(row);
    });
    hlist.querySelectorAll("button[data-idx]").forEach(function(b){
      b.addEventListener("click", function(){ var i=parseInt(b.getAttribute("data-idx"),10); openModal(load()[i], b); });
    });
  }

  /* ------- Modal ------- */
  var modal=$("modal"), mdBody=$("mdBody"), mdClose=$("mdClose"); var lastOpener=null, trapHandler=null;
  function openModal(it, opener){
    lastOpener=opener||null;
    var html = '<div class="kv2">'
      +'<div><strong>When</strong><br>'+new Date(it.t).toLocaleString()+'</div>'
      +'<div><strong>Inputs</strong><br>'+fmt(it.acres,2)+' ac · '+fmt(it.carrier,2)+' gpa'
      + (it.tank? (' · Tank '+fmt(it.tank,0)+' gal'):'') +'</div>'
      +'<div><strong>Acres / Tank</strong><br>'+(it.acresPerTank?fmt(it.acresPerTank,2)+' ac':'—')+'</div>'
      +'<div><strong>Tanks Needed</strong><br>'+fmt(it.tanksNeeded,0)+'</div>'
      +'<div><strong>Total Water</strong><br>'+fmt(it.totalWater,0)+' gal</div>'
      +'</div>';
    html += '<hr style="margin:12px 0;border:0;border-top:1px solid var(--border)">';
    html += '<table style="width:100%;border-collapse:collapse;"><thead><tr>'
         + '<th style="text-align:left;padding:6px 0;">Product</th>'
         + '<th style="text-align:right;">Rate</th>'
         + '<th style="text-align:right;">Per Tank</th>'
         + '<th style="text-align:right;">Total</th>'
         + '</tr></thead><tbody>';
    it.rows.forEach(function(r){
      var u = r.unit==="dryoz"?"oz (dry)":(r.unit==="gal"?"gal":r.unit);
      var perT = (r.perTank_native==null?'—':fmt(r.perTank_native,2)+' '+u + (r.perTank_gal!=null? ' · '+fmt(r.perTank_gal,2)+' gal':'' ));
      var tot  = fmt(r.total_native,2)+' '+u + (r.total_gal!=null? ' · '+fmt(r.total_gal,2)+' gal':'' );
      html += '<tr><td>'+r.name+'</td><td style="text-align:right;">'+fmt(r.rate,2)+' '+unitLabel(r.unit)+'</td>'
           +  '<td style="text-align:right;">'+perT+'</td><td style="text-align:right;">'+tot+'</td></tr>';
    });
    html += '</tbody></table>';

    mdBody.innerHTML=html;
    modal.setAttribute("open",""); modal.setAttribute("aria-hidden","false");
    document.documentElement.classList.add("no-scroll"); document.body.classList.add("no-scroll"); mdClose.focus(); trapFocus(modal);
  }
  function closeModal(){ modal.removeAttribute("open"); modal.setAttribute("aria-hidden","true");
    document.documentElement.classList.remove("no-scroll"); document.body.classList.remove("no-scroll"); releaseFocus(modal);
    if(lastOpener) lastOpener.focus(); }
  mdClose.addEventListener("click", closeModal);
  modal.addEventListener("click", function(e){ if(e.target===modal) closeModal(); });
  document.addEventListener("keydown", function(e){ if(modal.hasAttribute("open") && e.key==="Escape") closeModal(); });

  function trapFocus(root){
    var focusables=[].slice.call(root.querySelectorAll('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])')).filter(function(el){return !el.disabled && el.offsetParent!==null;});
    if(!focusables.length) return; var first=focusables[0], last=focusables[focusables.length-1];
    trapHandler=function(e){ if(e.key!=="Tab")return; if(e.shiftKey && document.activeElement===first){e.preventDefault(); last.focus();} else if(!e.shiftKey && document.activeElement===last){e.preventDefault(); first.focus();}};
    root.addEventListener("keydown", trapHandler);
  }
  function releaseFocus(root){ if(trapHandler){ root.removeEventListener("keydown", trapHandler); trapHandler=null; } }

  /* ------- Submit ------- */
  $("frm").addEventListener("submit", function(ev){
    ev.preventDefault();
    var out=calc(); show(out);
    if(out){ var h=load(); h.unshift(out); save(h); renderHist(); }
  });

  $("clearInputs").addEventListener("click", function(){
    [acresEl,tankEl,carrierEl].forEach(function(i){ i.value=""; });
    productsEl.innerHTML=""; addProductRow();
    results.hidden=true;
  });
  $("clearHist").addEventListener("click", function(){ localStorage.removeItem(LS_KEY); renderHist(); });

  renderHist();
})();
</script>
</body>
</html>