<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>FarmVista â€¢ Chemical Mix</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#3B7E46">
  <link rel="manifest" href="../../manifest.webmanifest">
  <link rel="apple-touch-icon" href="../../assets/icons/apple-touch-icon.png">
  <link rel="icon" href="../../assets/icons/icon-192.png">
  <script defer src="../../js/theme-boot.js"></script>
  <link rel="stylesheet" href="../../assets/css/theme.css">
  <link rel="stylesheet" href="../../assets/css/app.css">
  <script defer src="../../js/fv-shell.js"></script>
  <style>
    :root { --page-bottom-gap: 56px; }
    .wrap { max-width: 900px; margin: 0 auto; padding: clamp(14px,3vw,22px);
      padding-bottom: calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + var(--page-bottom-gap)); }
    h1 { margin: 8px 0 6px; font-size: clamp(22px,3.5vw,28px); }
    .form { display: grid; gap: 12px; margin: 14px 0 18px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 700px) { .row { grid-template-columns: 1fr; } }
    .out { padding: 12px; border: 1px solid var(--border); border-radius: 10px; background: var(--surface); }
    .muted { color: var(--muted, #67706B); }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    td { padding: 6px 4px; border-bottom: 1px solid var(--border); }
    .hist h2 { margin: 18px 0 8px; font-size: 18px; }
    .hist .actions { display: flex; gap: 8px; justify-content: flex-end; }
    .btn-link { background: none; border: 0; color: inherit; text-decoration: underline; cursor: pointer; padding: 0; }
  </style>
</head>
<body>
  <fv-shell>
    <div class="wrap">
      <h1>Chemical Mix</h1>
      <p class="muted">Compute total product and optional per-tank product from rate, acres, GPA, and tank size.</p>

      <div class="form" id="mixForm">
        <div class="row">
          <label>Product Rate (fl oz/ac)
            <input id="rate" type="number" inputmode="decimal" step="any" min="0" autofocus>
          </label>
          <label>Acres to Treat
            <input id="acres" type="number" inputmode="decimal" step="any" min="0">
          </label>
        </div>
        <div class="row">
          <label>Carrier Rate (GPA)
            <input id="gpa" type="number" inputmode="decimal" step="any" min="0" value="15">
          </label>
          <label>Tank Size (gal)
            <input id="tank" type="number" inputmode="decimal" step="any" min="0">
          </label>
        </div>
      </div>

      <div class="out" id="results" hidden>
        <div><strong>Total Product:</strong> <span id="totOz">-</span> fl oz
          (<span id="totQt">-</span> qt, <span id="totGal">-</span> gal)</div>
        <div id="perTankRow" hidden>
          <strong>Per Tank:</strong> <span id="ptOz">-</span> fl oz (<span id="ptQt">-</span> qt)
          - <strong>Tanks Needed:</strong> <span id="tanks">-</span>
        </div>
      </div>

      <section class="hist" id="history">
        <div style="display:flex;align-items:center;gap:10px">
          <h2 style="flex:1">Previous Calculations</h2>
          <div class="actions"><button class="btn-link" id="clear">Clear</button></div>
        </div>
        <div class="muted" id="nohist">No previous chemical mix calculations.</div>
        <table id="histTable" hidden><tbody></tbody></table>
      </section>
    </div>
  </fv-shell>

  <script>
  (function(){
    "use strict";
    var LS_KEY = "fv_calc_chem_history";
    function $(id){ return document.getElementById(id); }
    var res = $("results"), per = $("perTankRow");
    var inputs = [ $("rate"), $("acres"), $("gpa"), $("tank") ];

    function fmt(n, d){ if(d===void 0) d=2; return Number(n).toLocaleString(undefined,{maximumFractionDigits:d}); }
    function load(){ try { return JSON.parse(localStorage.getItem(LS_KEY) || "[]"); } catch(e){ return []; } }
    function save(a){ localStorage.setItem(LS_KEY, JSON.stringify(a.slice(0,10))); }

    function renderHist(){
      var h = load(), no = $("nohist"), t = $("histTable"), tb = t.querySelector("tbody");
      if(!h.length){ no.hidden = false; t.hidden = true; return; }
      no.hidden = true; t.hidden = false; tb.innerHTML = "";
      for(var i=0;i<h.length;i++){
        var it = h[i];
        var tr = document.createElement("tr");
        tr.innerHTML =
          "<td>" + new Date(it.t).toLocaleString() + "</td>" +
          "<td>" + fmt(it.rate) + " oz/ac x " + fmt(it.acres) + " ac</td>" +
          "<td>Total " + fmt(it.total_oz) + " oz (" + fmt(it.total_oz/32) + " qt, " + fmt(it.total_oz/128,3) + " gal)</td>" +
          "<td>" + (it.tank_gal ? ("Per tank " + fmt(it.per_tank_oz) + " oz @ " + fmt(it.tank_gal) + " gal - " + fmt(it.tanks,3) + " tanks") : "") + "</td>";
        tb.appendChild(tr);
      }
    }

    function computeAndShow(saveRun){
      if(saveRun===void 0) saveRun = true;
      var rate = parseFloat($("rate").value);
      var acres = parseFloat($("acres").value);
      var gpa = parseFloat($("gpa").value || 0);
      var tank = parseFloat($("tank").value || 0);
      if(!(rate > 0 && acres > 0)){ res.hidden = true; return; }

      var total_oz = rate * acres;
      $("totOz").textContent = fmt(total_oz);
      $("totQt").textContent = fmt(total_oz/32);
      $("totGal").textContent = fmt(total_oz/128,3);

      if(tank > 0 && gpa > 0){
        var total_carrier = acres * gpa;
        var tanks_needed = total_carrier / tank;
        var per_tank_oz = total_oz / Math.max(1, tanks_needed);
        $("ptOz").textContent = fmt(per_tank_oz);
        $("ptQt").textContent = fmt(per_tank_oz/32);
        $("tanks").textContent = fmt(tanks_needed,3);
        per.hidden = false;
      } else {
        per.hidden = true;
      }

      res.hidden = false;

      if(saveRun){
        var h = load();
        h.unshift({
          t: Date.now(),
          rate: rate, acres: acres, gpa: gpa, tank_gal: tank || null,
          total_oz: total_oz,
          per_tank_oz: per.hidden ? null : (total_oz/((acres*gpa)/tank)),
          tanks: per.hidden ? null : ((acres*gpa)/tank)
        });
        save(h); renderHist();
      }
    }

    var to = null;
    inputs.forEach(function(i){
      i.addEventListener("input", function(){
        if(to) window.clearTimeout(to);
        to = window.setTimeout(function(){ computeAndShow(true); }, 150);
      });
    });
    $("clear").addEventListener("click", function(){
      localStorage.removeItem(LS_KEY); renderHist();
    });

    renderHist();
  })();
  </script>
</body>
</html>