<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>FarmVista - Grain Bin</title>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<link rel="manifest" href="../../manifest.webmanifest">
<link rel="stylesheet" href="../../assets/css/theme.css">
<link rel="stylesheet" href="../../assets/css/app.css">
<script defer src="../../js/theme-boot.js"></script>
<script defer src="../../js/fv-shell.js"></script>
<style>
/* reuse shell styles from above */
:root{ --page-bottom-gap:56px; --card-max:940px; --accent:#2F6C3C; --accent-2:#0F3B82; }
html{-webkit-text-size-adjust:100%} body{background:var(--app-bg,var(--surface))}
.wrap{max-width:var(--card-max);margin:0 auto;padding:clamp(14px,3vw,22px);padding-bottom:calc(env(safe-area-inset-bottom,0px)+var(--ftr-h,42px)+var(--page-bottom-gap))}
.calc-card{border:1px solid var(--border);border-radius:14px;background:var(--surface);box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));overflow:hidden}
.card-head{display:flex;align-items:center;gap:12px;padding:14px 16px;background:linear-gradient(90deg,rgba(47,108,60,.12),transparent);border-bottom:1px solid var(--border)}
.card-head .icon{width:28px;height:28px;color:var(--accent)} .card-head h1{margin:0;font-size:clamp(20px,3.2vw,26px);line-height:1.2}
.muted{color:var(--muted)} form{padding:16px;display:grid;gap:14px}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px} @media(max-width:760px){.grid{grid-template-columns:1fr}}
label{display:block;font-weight:600;margin-bottom:6px}
.ctrl{display:flex;align-items:center;gap:8px;border:1px solid var(--border);background:var(--card-surface,var(--surface));border-radius:10px;padding:10px 12px}
input,select,button{font-size:16px} .ctrl input,.ctrl select{width:100%;border:0;outline:0;background:transparent;color:var(--text)}
.unit{font-size:12px;color:var(--muted)} .actions{display:flex;gap:10px;justify-content:flex-end;padding:0 16px 16px}
.btn{appearance:none;border:1px solid var(--border);background:var(--surface);padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
.btn-primary{background:var(--accent);color:#fff;border-color:var(--accent)}
.results{padding:0 16px 16px} .result-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px} @media(max-width:760px){.result-grid{grid-template-columns:1fr}}
.tile{border:1px solid var(--border);border-radius:12px;padding:12px;background:linear-gradient(180deg,rgba(47,108,60,.06),transparent 55%)} .tile h3{margin:0 0 6px;font-size:16px}
.kv{display:grid;grid-template-columns:1fr auto;gap:6px 12px;align-items:baseline} .kv .val{font-weight:800}
.hist{padding:16px;border-top:1px dashed var(--border)} .hlist{display:grid;gap:8px} .hitem{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:var(--card-surface,var(--surface))}
.hsummary{font-weight:700} .btn-link{background:none;border:0;padding:0;text-decoration:underline;color:inherit;cursor:pointer} .muted-line{font-size:12px;color:var(--muted)}
.modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.42);z-index:9999;transition:opacity .15s;opacity:0}
.modal[open]{display:grid;opacity:1} .dialog{width:min(680px,92vw);max-height:85vh;display:flex;flex-direction:column;background:var(--surface);color:var(--text);border-radius:14px;border:1px solid var(--border);box-shadow:0 16px 36px rgba(0,0,0,.28)}
.dialog-head{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.dialog-body{padding:14px;overflow:auto;flex:1 1 auto;min-height:0;-webkit-overflow-scrolling:touch} .closex{border:1px solid var(--border);background:var(--surface);border-radius:8px;padding:6px 10px;cursor:pointer;font-weight:700}
.kv2{display:grid;grid-template-columns:1fr 1fr;gap:8px 16px} @media(max-width:640px){.kv2{grid-template-columns:1fr}} html.no-scroll, body.no-scroll{overflow:hidden}
.hidden{display:none !important;}
</style>
</head>
<body>
<fv-shell>
  <div class="wrap">
    <div class="calc-card">
      <div class="card-head">
        <div class="icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="1.6">
            <rect x="5" y="4" width="14" height="16" rx="2"></rect><path d="M5 9h14"></path>
          </svg>
        </div>
        <div>
          <h1>Grain Bin</h1>
          <div class="muted">Bushels from diameter, depth, and optional peak.</div>
        </div>
      </div>

      <form id="frm" novalidate autocomplete="off">
        <div class="grid">
          <div>
            <label for="crop">Crop</label>
            <div class="ctrl">
              <select id="crop">
                <option value="corn">Corn (56 lb/bu)</option>
                <option value="soy">Soybeans (60 lb/bu)</option>
                <option value="wheat">Wheat (60 lb/bu)</option>
              </select>
            </div>
          </div>

          <div>
            <label for="diam">Bin Diameter</label>
            <div class="ctrl">
              <input id="diam" type="text" inputmode="decimal" placeholder="e.g. 48">
              <span class="unit">ft</span>
            </div>
          </div>

          <div>
            <label for="depth">Grain Depth (level)</label>
            <div class="ctrl">
              <input id="depth" type="text" inputmode="decimal" placeholder="e.g. 20">
              <span class="unit">ft</span>
            </div>
          </div>

          <div>
            <label for="topShape">Top</label>
            <div class="ctrl">
              <select id="topShape">
                <option value="level">Level</option>
                <option value="peaked">Peaked</option>
              </select>
            </div>
          </div>

          <div data-pane="peaked" class="hidden">
            <label for="peak">Peak Height</label>
            <div class="ctrl">
              <input id="peak" type="text" inputmode="decimal" placeholder="e.g. 4.5">
              <span class="unit">ft</span>
            </div>
          </div>
          <div data-pane="peaked" class="hidden"></div>
        </div>

        <div class="actions">
          <button type="button" class="btn" id="clearInputs">Clear</button>
          <button type="submit" class="btn btn-primary" id="doCalc">Calculate</button>
        </div>
      </form>

      <div class="results" id="results" hidden>
        <div class="result-grid">
          <div class="tile">
            <h3>Capacity</h3>
            <div class="kv">
              <div>Cubic Feet</div> <div class="val" id="cuft">- ft³</div>
              <div>Bushels</div>    <div class="val" id="bushels">- bu</div>
              <div>Est. Weight</div><div class="val" id="weight">- lb</div>
            </div>
          </div>
        </div>
      </div>

      <section class="hist">
        <div style="display:flex;align-items:center;gap:10px">
          <h2 style="flex:1">Previous Calculations</h2>
          <button class="btn-link" id="clearHist" type="button">Clear History</button>
        </div>
        <div class="hlist" id="hlist"></div>
        <div class="muted-line" id="nohist">No previous bin calculations.</div>
      </section>
    </div>
  </div>
</fv-shell>

<div class="modal" id="modal" aria-hidden="true">
  <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="mdTitle">
    <div class="dialog-head">
      <h3 id="mdTitle">Bin Details</h3>
      <button class="closex" id="mdClose" type="button">Back</button>
    </div>
    <div class="dialog-body" id="mdBody"></div>
  </div>
</div>

<script>
(function(){
  "use strict";
  if(window.__FV_BIN_V1__) return; window.__FV_BIN_V1__=true;

  function $(id){ return document.getElementById(id); }
  function num(v){ return parseFloat(String(v).replace(/,/g,"")); }
  function fmt(n,d){ if(d===void 0) d=2; return Number(n).toLocaleString(undefined,{maximumFractionDigits:d}); }

  var cropEl=$("crop"), diam=$("diam"), depth=$("depth"), topShape=$("topShape"), peak=$("peak");
  [diam,depth,peak].forEach(function(i){ i && i.addEventListener("blur", function(){ i.value=i.value.replace(/[^0-9.]/g,""); }); });

  var panes=[].slice.call(document.querySelectorAll("[data-pane]"));
  function showPane(){ var v=topShape.value; panes.forEach(function(p){ p.classList.toggle("hidden", p.getAttribute("data-pane")!==v); }); }
  topShape.addEventListener("change", showPane);

  var cuftEl=$("cuft"), bushelsEl=$("bushels"), weightEl=$("weight"), results=$("results");
  var LS_KEY="fv_calc_bin_history", hlist=$("hlist"), nohist=$("nohist");

  var BU_FT3 = 1.244; // 1 bushel volume in cubic feet
  var TW = { corn:56, soy:60, wheat:60 };

  function calc(){
    var D=num(diam.value), H=num(depth.value); if(!(D>0 && H>0)) return alert("Enter diameter and depth."), null;
    var top=topShape.value; var peakH = top==="peaked" ? num(peak.value) : 0; if(top==="peaked" && !(peakH>0)) return alert("Enter peak height."), null;

    var r=D/2;
    var cyl_cuft = Math.PI * r*r * H;
    var cone_cuft = top==="peaked" ? (Math.PI * r*r * peakH / 3) : 0;
    var cuft = cyl_cuft + cone_cuft;
    var bu = cuft / BU_FT3;
    var wt = bu * TW[cropEl.value];
    return { t:Date.now(), crop:cropEl.value, D:D, H:H, top:top, peak:peakH, cuft:cuft, bu:bu, wt:wt };
  }

  function show(o){
    if(!o){ results.hidden=true; return; }
    cuftEl.textContent = fmt(o.cuft,0)+" ft³";
    bushelsEl.textContent = fmt(o.bu,0)+" bu";
    weightEl.textContent = fmt(o.wt,0)+" lb";
    results.hidden=false;
  }

  function load(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)||"[]"); }catch(e){ return []; } }
  function save(a){ localStorage.setItem(LS_KEY, JSON.stringify(a.slice(0,10))); }
  function summary(it){ return (it.crop==="corn"?"Corn":it.crop==="soy"?"Soy":"Wheat")+" D"+fmt(it.D,0)+"ft x "+fmt(it.H,1)+"ft"+(it.top==="peaked"?" +peak "+fmt(it.peak,1)+"ft":"")+" → "+fmt(it.bu,0)+" bu"; }

  function renderHist(){ var h=load(); hlist.innerHTML=""; if(!h.length){ nohist.hidden=false; return; } nohist.hidden=true;
    h.forEach(function(it,idx){ var row=document.createElement("div"); row.className="hitem";
      row.innerHTML='<div class="hsummary">'+summary(it)+'</div><button class="btn-link" data-idx="'+idx+'" type="button">View</button>'; hlist.appendChild(row); });
    hlist.querySelectorAll("button[data-idx]").forEach(function(b){ b.addEventListener("click", function(){ var i=parseInt(b.getAttribute("data-idx"),10); openModal(load()[i], b); }); });
  }

  var modal=$("modal"), mdBody=$("mdBody"), mdClose=$("mdClose"); var lastOpener=null;
  function openModal(it, opener){
    lastOpener=opener||null;
    mdBody.innerHTML = '<div class="kv2">'
      +'<div><strong>When</strong><br>'+new Date(it.t).toLocaleString()+'</div>'
      +'<div><strong>Crop</strong><br>'+ (it.crop==="corn"?"Corn":it.crop==="soy"?"Soybeans":"Wheat") +'</div>'
      +'<div><strong>Dimensions</strong><br>'+fmt(it.D,2)+' ft Ø × '+fmt(it.H,2)+' ft level'+(it.top==="peaked"?" + peak "+fmt(it.peak,2)+' ft':'')+'</div>'
      +'<div></div>'
      +'<div><strong>Cubic Feet</strong><br>'+fmt(it.cuft,0)+' ft³</div>'
      +'<div><strong>Bushels</strong><br>'+fmt(it.bu,0)+' bu</div>'
      +'<div><strong>Estimated Weight</strong><br>'+fmt(it.wt,0)+' lb</div>'
      +'</div>';
    modal.setAttribute("open",""); modal.setAttribute("aria-hidden","false");
    document.documentElement.classList.add("no-scroll"); document.body.classList.add("no-scroll"); mdClose.focus(); trapFocus(modal);
  }
  function closeModal(){ modal.removeAttribute("open"); modal.setAttribute("aria-hidden","true"); document.documentElement.classList.remove("no-scroll"); document.body.classList.remove("no-scroll"); releaseFocus(modal); if(lastOpener) lastOpener.focus(); }
  mdClose.addEventListener("click", closeModal); modal.addEventListener("click", function(e){ if(e.target===modal) closeModal(); });
  document.addEventListener("keydown", function(e){ if(modal.hasAttribute("open") && e.key==="Escape") closeModal(); });

  var trapHandler=null; function trapFocus(root){ var focusables=[].slice.call(root.querySelectorAll('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])')).filter(function(el){return !el.disabled && el.offsetParent!==null;}); if(!focusables.length) return; var first=focusables[0], last=focusables[focusables.length-1]; trapHandler=function(e){ if(e.key!=="Tab")return; if(e.shiftKey && document.activeElement===first){e.preventDefault(); last.focus();} else if(!e.shiftKey && document.activeElement===last){e.preventDefault(); first.focus();}}; root.addEventListener("keydown", trapHandler); }
  function releaseFocus(root){ if(trapHandler){ root.removeEventListener("keydown", trapHandler); trapHandler=null; } }

  $("frm").addEventListener("submit", function(ev){ ev.preventDefault(); var out=calc(); show(out); if(out){ var h=load(); h.unshift(out); save(h); renderHist(); } });
  $("clearInputs").addEventListener("click", function(){ [diam,depth,peak].forEach(function(i){ if(i) i.value=""; }); results.hidden=true; });
  $("clearHist").addEventListener("click", function(){ localStorage.removeItem(LS_KEY); renderHist(); });

  showPane(); renderHist();
})();
</script>
</body>
</html>