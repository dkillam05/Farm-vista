<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FarmVista ‚Ä¢ Equipment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#3B7E46" />

<!-- Early theme boot -->
  <script src="/Farm-vista/js/theme-boot.js"></script>
  
  <!-- PWA + icons -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest" />
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png" />
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png" />

    <!-- Global CSS -->
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css" />
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css" />
  <link rel="stylesheet" href="/Farm-vista/assets/css/dashboard.css" />

  <style>
    /* Dashboard-style KPI badge (same as Crop Production / Field Trials) */
    .dash-kpi{
      display:block;
      margin:12px 0 18px 0;
      padding:14px 16px;
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--surface);
      box-shadow:0 8px 18px rgba(0,0,0,0.06);
      text-decoration:none;
      color:inherit;
      transition:transform 0.08s ease, box-shadow 0.08s ease, border-color 0.08s ease;
    }
    .dash-kpi:hover{
      transform:translateY(-1px);
      box-shadow:0 12px 24px rgba(0,0,0,0.10);
      border-color:rgba(59,126,70,0.55);
    }
    .dash-kpi-main{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .dash-kpi-text{
      flex:1 1 auto;
      min-width:0;
    }
    .dash-kpi-label{
      font-size:13px;
      letter-spacing:.06em;
      text-transform:uppercase;
      font-weight:600;
      color:var(--muted,#67706B);
      margin-bottom:4px;
    }
    .dash-kpi-title,
    .dash-kpi-title-secondary{
      font-size:15px;
      font-weight:600;
      color:var(--text,#1d211f);
    }
    .dash-kpi-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-top:6px;
    }
    .dash-kpi-row + .dash-kpi-row{
      margin-top:10px;
    }
    .dash-kpi-count{
      min-width:52px;
      min-height:52px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:22px;
      font-weight:700;
      border:1px solid rgba(59,126,70,0.4);
      background:rgba(59,126,70,0.10);
      color:var(--text,#1d211f);
    }
    .dash-kpi-count-secondary{
      /* reuse base size */
    }
    .dash-kpi-sub{
      margin-top:6px;
      font-size:12px;
      color:var(--muted,#67706B);
    }
    .dash-kpi-empty .dash-kpi-count,
    .dash-kpi-empty .dash-kpi-count-secondary{
      border-color:rgba(0,0,0,0.12);
      background:rgba(0,0,0,0.02);
      color:var(--muted,#67706B);
    }
    .dash-kpi-count-link{
      text-decoration:none;
      display:inline-flex;
      color:inherit;
    }
    .dash-kpi-count-link:visited{
      color:inherit;
    }
    .dash-kpi-count-link:focus-visible{
      outline:2px solid var(--accent,#3B7E46);
      outline-offset:2px;
    }

    /* Permission hidden helper */
    .perm-hidden{
      display:none !important;
    }
  </style>
</head>
<body>
  <fv-shell>
    <div class="page container">
      <h1 class="page-title">Equipment Dashboard</h1>

      <!-- Overview description -->
      <p class="muted" style="margin:0 0 18px 0; color:var(--muted,#87908a);">
        The Equipment module keeps your machinery organized‚Äîfrom tractors and sprayers to trucks and trailers.
        View, track, and maintain every asset in one place with details on service history, attachments, and performance notes.
      </p>
      <p class="muted" style="margin:0 0 22px 0; color:var(--muted,#87908a);">
        Use the sidebar to navigate to <em>Tractors</em>, <em>Sprayers</em>, <em>Combines</em>, <em>Implements</em>, and other categories.
        Record maintenance, assign equipment to operators, and manage uptime across the farm season.
      </p>

      <!-- ============================
           KPI: Equipment Service + Work Orders
           Gate: cap-kpi-equipment
           ============================ -->
      <div
        class="dash-kpi dash-kpi-empty"
        id="equip-service-kpi"
      >
        <div class="dash-kpi-main">
          <div class="dash-kpi-text">
            <div class="dash-kpi-label">Equipment Service</div>

            <!-- Row 1: Service requests needing approval -->
            <div class="dash-kpi-row">
              <div class="dash-kpi-title">
                Service requests needing approval
              </div>
              <a
                href="/Farm-vista/pages/equipment/actions/service-approve.html"
                class="dash-kpi-count-link"
                aria-label="View equipment service requests needing approval"
              >
                <div class="dash-kpi-count" id="equip-count-requests">‚Äì</div>
              </a>
            </div>

            <!-- Row 2: Open work orders (pending & in progress) -->
            <div class="dash-kpi-row">
              <div class="dash-kpi-title-secondary">
                Open work orders (pending &amp; in progress)
              </div>
              <a
                href="/Farm-vista/pages/equipment/actions/service-workorders.html"
                class="dash-kpi-count-link"
                aria-label="View open equipment work orders"
              >
                <div class="dash-kpi-count dash-kpi-count-secondary" id="equip-count-workorders">‚Äì</div>
              </a>
            </div>
          </div>

          <div class="dash-kpi-sub" id="equip-service-sub">
            Checking equipment service requests and open work orders‚Ä¶
          </div>
        </div>
      </div>

      <div class="card" style="max-width:780px; margin:0 auto;">
        <h2 class="card-title">Overview</h2>
        <ul class="list">
          <li>üöú&nbsp; Maintain records for tractors, sprayers, and combines</li>
          <li>üß∞&nbsp; Log maintenance dates, hours, and service notes</li>
          <li>üìã&nbsp; Assign equipment to farms, fields, or operators</li>
          <li>‚öôÔ∏è&nbsp; Track attachments, implements, and configurations</li>
          <li>üìÖ&nbsp; Plan seasonal usage and track downtime</li>
        </ul>
      </div>
    </div>
  </fv-shell>

  <!-- =========================================================
       Equipment Capability Permissions (Role + Employee Overrides)
       Sources:
         - employees/{lowercaseEmail} (permissionGroup + overrides)
         - accountRoles (lookup by name == permissionGroup)
       Outputs:
         - window.FV_EQUIP_PERMS
         - window.FV_EQUIP_CAN(key, action)
         - dispatches "fv:equip-perms-ready" (detail: {permsKnown})
       IMPORTANT:
         - FAIL-OPEN: do NOT hide anything unless perms are successfully resolved
     ========================================================= -->
  <script type="module">
    import {
      ready,
      getAuth,
      onAuthStateChanged,
      getFirestore,
      doc,
      getDoc,
      collection,
      getDocs,
      query,
      where
    } from '/Farm-vista/js/firebase-init.js';

    (function(){
      "use strict";

      const KEY_EQUIP_KPI = "cap-kpi-equipment";

      const els = {
        kpi: document.getElementById("equip-service-kpi")
      };

      function hide(el){
        if (!el) return;
        el.classList.add("perm-hidden");
        el.setAttribute("aria-hidden","true");
        el.setAttribute("tabindex","-1");
      }
      function show(el){
        if (!el) return;
        el.classList.remove("perm-hidden");
        el.removeAttribute("aria-hidden");
        el.removeAttribute("tabindex");
      }

      function hasPermObj(p){
        return p && typeof p === "object" && (
          Object.prototype.hasOwnProperty.call(p,"view") ||
          Object.prototype.hasOwnProperty.call(p,"add") ||
          Object.prototype.hasOwnProperty.call(p,"edit") ||
          Object.prototype.hasOwnProperty.call(p,"delete")
        );
      }

      function canFromPermValue(val, action){
        if (val == null) return false;
        if (val === true) return true;
        if (val === false) return false;

        if (typeof val === "object"){
          if (typeof val.on === "boolean") return !!val.on;

          if (hasPermObj(val)){
            const a = (action || "view").toLowerCase();
            if (typeof val[a] === "boolean") return !!val[a];
            return !!(val.view || val.add || val.edit || val.delete);
          }
        }
        return false;
      }

      function makeCan(perms){
        return function(key, action){
          if (!key) return true;
          return canFromPermValue(perms ? perms[key] : null, action || "view");
        };
      }

      function deepClone(obj){
        try { return JSON.parse(JSON.stringify(obj || {})); } catch { return {}; }
      }

      function mergePerms(base, overrides){
        const out = deepClone(base || {});
        const ov = (overrides && typeof overrides === "object") ? overrides : {};
        for (const k of Object.keys(ov)){
          out[k] = ov[k];
        }
        return out;
      }

      function extractEmployeeGroupAndOverrides(emp){
        const e = emp || {};
        const permissionGroup = (e.permissionGroup || "").toString().trim();

        let overrides =
          (e.overrides && e.overrides.perms && typeof e.overrides.perms === "object" ? e.overrides.perms : null) ||
          (e.overrides && typeof e.overrides === "object" ? e.overrides : null) ||
          (e.perms && typeof e.perms === "object" ? e.perms : null) ||
          {};

        return { permissionGroup, overrides };
      }

      async function readEmployeeByEmail(db, user){
        const email = (user && user.email ? user.email.toString().trim().toLowerCase() : "");
        if (!email) return null;
        const ref = doc(db, "employees", email);
        const snap = await getDoc(ref);
        return snap.exists() ? (snap.data() || {}) : null;
      }

      async function readRolePermsByDocId(db, maybeId){
        if (!maybeId) return null;
        try{
          const ref = doc(db, "accountRoles", maybeId);
          const snap = await getDoc(ref);
          if (!snap.exists()) return null;
          const d = snap.data() || {};
          return (d.perms && typeof d.perms === "object") ? d.perms : {};
        }catch{
          return null;
        }
      }

      async function readRolePermsByName(db, roleName){
        if (!roleName) return null;
        try{
          const qy = query(collection(db, "accountRoles"), where("name", "==", roleName));
          const ss = await getDocs(qy);
          let first = null;
          ss.forEach(d => { if (!first) first = d; });
          if (!first) return null;
          const d = first.data() || {};
          return (d.perms && typeof d.perms === "object") ? d.perms : {};
        }catch{
          return null;
        }
      }

      function applyVisibility(perms, permsKnown){
        if (!permsKnown){
          // fail-open
          show(els.kpi);

          window.FV_EQUIP_PERMS = null;
          window.FV_EQUIP_CAN = null;

          document.dispatchEvent(new CustomEvent("fv:equip-perms-ready", { detail:{ permsKnown:false } }));
          return;
        }

        const can = makeCan(perms);

        if (els.kpi){
          if (!can(KEY_EQUIP_KPI, "view")) hide(els.kpi); else show(els.kpi);
        }

        window.FV_EQUIP_PERMS = perms || {};
        window.FV_EQUIP_CAN = can;

        document.dispatchEvent(new CustomEvent("fv:equip-perms-ready", { detail:{ permsKnown:true } }));
      }

      async function init(){
        await ready;

        const auth = getAuth();
        const db = getFirestore();

        applyVisibility(null, false);

        onAuthStateChanged(auth, async (user)=>{
          try{
            if (!user){
              applyVisibility(null, false);
              return;
            }

            const emp = await readEmployeeByEmail(db, user);
            if (!emp){
              console.warn("[equipment] employees doc not found for:", user.email);
              applyVisibility(null, false);
              return;
            }

            const { permissionGroup, overrides } = extractEmployeeGroupAndOverrides(emp);

            let basePerms = await readRolePermsByDocId(db, permissionGroup);
            if (!basePerms) basePerms = await readRolePermsByName(db, permissionGroup);

            if (!basePerms){
              console.warn("[equipment] accountRoles not found for permissionGroup:", permissionGroup);
              applyVisibility(null, false);
              return;
            }

            const merged = mergePerms(basePerms, overrides);
            applyVisibility(merged, true);
          }catch(err){
            console.warn("[equipment] perms resolver failed:", err);
            applyVisibility(null, false);
          }
        });
      }

      init();
    })();
  </script>

  <!-- Bootloader (same pattern as your working pages) -->
  <script>
    (function () {
      const urlRev = new URL(location.href).searchParams.get('rev');
      const REV = urlRev || String(Date.now());
      const files = [
        '/Farm-vista/js/version.js',
        '/Farm-vista/js/core.js',
        '/Farm-vista/js/fv-hero-card.js',
        '/Farm-vista/js/fv-shell.js',
        '/Farm-vista/js/fv-hero.js'
      ];
      (async function loadSeq() {
        for (const src of files) {
          await new Promise((resolve, reject) => {
            const s = document.createElement('script');
            s.src = src + '?rev=' + REV;
            s.async = false;
            s.onload = resolve;
            s.onerror = () => reject(new Error('Failed to load ' + s.src));
            document.body.appendChild(s);
          });
        }
      })().catch(err => console.error('Bootloader failed:', err));
    })();
  </script>

  <!-- ===========================================
       Equipment Service KPI JS
       - Needs approval: equipmentServiceRequests (status == "needs approved")
       - Open WOs: equipmentWorkOrders (status == "pending" OR "in_progress")
       - now skips reads if KPI is hidden
       =========================================== -->
  <script type="module">
    import {
      ready,
      getFirestore,
      collection,
      getDocs,
      query,
      where
    } from '/Farm-vista/js/firebase-init.js';

    const kpiEl = document.getElementById('equip-service-kpi');
    const reqEl = document.getElementById('equip-count-requests');
    const woEl  = document.getElementById('equip-count-workorders');
    const subEl = document.getElementById('equip-service-sub');

    function isHidden(el){
      return !el || el.classList.contains("perm-hidden") || el.getAttribute("aria-hidden") === "true";
    }

    if (kpiEl && reqEl && woEl && subEl) {
      function applyState(requestCount, workOrderCount) {
        const nReq = Number(requestCount) || 0;
        const nWo  = Number(workOrderCount) || 0;

        reqEl.textContent = nReq.toString();
        woEl.textContent  = nWo.toString();

        if (!nReq && !nWo) {
          kpiEl.classList.add('dash-kpi-empty');
          subEl.textContent = 'No service requests needing approval or open work orders.';
        } else {
          kpiEl.classList.remove('dash-kpi-empty');

          const parts = [];
          if (nReq) {
            parts.push(
              nReq === 1
                ? '1 service request needing approval'
                : nReq + ' service requests needing approval'
            );
          }
          if (nWo) {
            parts.push(
              nWo === 1
                ? '1 open work order (pending or in progress)'
                : nWo + ' open work orders (pending or in progress)'
            );
          }
          subEl.textContent = parts.join(' ‚Ä¢ ');
        }
      }

      async function loadEquipmentServiceKpi() {
        try {
          if (isHidden(kpiEl)) return;

          await ready;
          const db = getFirestore();

          const reqRef = collection(db, 'equipmentServiceRequests');
          const needsApprovalSnap = await getDocs(
            query(reqRef, where('status', '==', 'needs approved'))
          );
          const requestCount = typeof needsApprovalSnap.size === 'number'
            ? needsApprovalSnap.size
            : 0;

          const woRef = collection(db, 'equipmentWorkOrders');
          const [pendingSnap, inProgSnap] = await Promise.all([
            getDocs(query(woRef, where('status', '==', 'pending'))),
            getDocs(query(woRef, where('status', '==', 'in_progress')))
          ]);

          const pendingCount = typeof pendingSnap.size === 'number' ? pendingSnap.size : 0;
          const inProgCount  = typeof inProgSnap.size === 'number' ? inProgSnap.size  : 0;
          const workOrderCount = pendingCount + inProgCount;

          applyState(requestCount, workOrderCount);
        } catch (err) {
          console.warn('[equipment] failed to load service KPI:', err);
          applyState(0, 0);
        }
      }

      loadEquipmentServiceKpi();
      document.addEventListener('fv:equip-perms-ready', () => loadEquipmentServiceKpi());

      document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
          loadEquipmentServiceKpi();
        }
      });
    }
  </script>

  <noscript>
    <div class="container"><div class="card">JavaScript is required for Equipment.</div></div>
  </noscript>
</body>
</html>
