<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista • View Tractors</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- PWA + theme (relative from /pages/equipment/) -->
  <link rel="manifest" href="../../manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="../../assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="../../assets/icons/icon-192.png"/>
  <script defer src="../../js/theme-boot.js"></script>
  <link rel="stylesheet" href="../../assets/css/theme.css"/>
  <link rel="stylesheet" href="../../assets/css/app.css"/>

  <!-- Ensure shell -->
  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='../../js/fv-shell.js'; s.defer=true; document.head.appendChild(s);
      }
    })();
  </script>

  <!-- Firebase CONFIG FIRST (match Directory pattern) -->
  <script src="../../js/firebase-config.js"></script>

  <style>
    :root{
      --brand:#3B7E46;
      --card-max:1100px;
    }
    body{ background:var(--app-bg,var(--surface)); }

    .page{
      max-width:var(--card-max);
      margin:0 auto;
      padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + 96px)!important;
    }

    .title{margin:0 0 4px 0;font-size:clamp(22px,3.6vw,32px);line-height:1.1;}
    .sub{margin:0 0 18px 0;color:var(--muted,#6f7772);}
    .muted{color:var(--muted,#6f7772)}

    /* Search */
    .search{display:flex;align-items:center;gap:10px;border:1px solid var(--border);
      border-radius:12px;background:var(--surface);padding:10px 12px;}
    .search input{flex:1;background:transparent;border:0;outline:none;font:inherit}

    /* Toolbar */
    .filters-row{display:flex;gap:10px;align-items:center;margin:10px 0 18px}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:12px;
      background:var(--surface);color:var(--text);padding:10px 14px;font-weight:800;cursor:pointer;}
    .btn-primary{border-color:transparent;background:#2F6C3C;color:#fff;}
    select.input{padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:var(--surface);}

    /* Count */
    .count{margin:0 0 10px 0;color:var(--muted,#6f7772);font-weight:700}

    /* Card list */
    .list{display:grid;gap:10px}
    .card{border:1px solid var(--border);border-radius:16px;background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));padding:12px 14px;display:grid;gap:6px;cursor:pointer}
    .card:hover{transform:translateY(-1px);box-shadow:0 12px 28px rgba(0,0,0,.12)}
    .row{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .name{font-weight:800}
    .tags{display:flex;gap:8px;flex-wrap:wrap}
    .tag{padding:4px 10px;border-radius:999px;font-size:13px;font-weight:800}
    .tag.green{background:#e7f1ea;color:#2F6C3C}
    .tag.gray{background:#eef0ee;color:#3d4741}

    /* Modal (edit sheet) */
    dialog.sheet{width:min(740px, 92vw);border:1px solid var(--border);border-radius:16px;padding:0;background:var(--surface);
      box-shadow:0 18px 40px rgba(0,0,0,.28);}
    .sheet::backdrop{background:rgba(0,0,0,.35)}
    .sheet header{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .sheet .body{padding:14px 16px;display:grid;gap:10px}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:700px){ .grid2{grid-template-columns:1fr} }
    .sheet footer{padding:12px 16px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end}
    .input, .textarea, .select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:var(--surface);font:inherit}
    .textarea{min-height:110px}

    /* QR preview */
    .qr-box{border:1px dashed var(--border);border-radius:12px;padding:12px;display:grid;gap:10px;background:color-mix(in srgb, var(--brand) 4%, transparent);}
    .qr-img{width:196px;height:196px;background:#fff;border:1px solid var(--border);border-radius:8px;display:grid;place-items:center;overflow:hidden;padding:8px;}
    .qr-img img{max-width:180px;max-height:180px;display:block}
    .qr-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .qr-empty{font-size:13px;color:var(--muted,#67706B);}

    /* Toast */
    .local-toast{
      position: fixed; left: 50%; bottom: calc(var(--ftr-h, 14px) + env(safe-area-inset-bottom, 0px) + 16px);
      transform: translateX(-50%) translateY(8px);
      background: #111; color: #fff; padding: 12px 18px; border-radius: 12px; box-shadow: 0 12px 32px rgba(0,0,0,.35);
      z-index: 999999; font-size: 14px; opacity: 0; pointer-events: none; transition: opacity .18s ease, transform .18s ease;
      white-space: nowrap; max-width: 92vw; text-overflow: ellipsis; overflow: hidden;
    }
    .local-toast.show{ opacity:1; transform: translateX(-50%) translateY(0); }
  </style>
</head>
<body>
  <fv-shell>
    <div class="page">
      <h1 class="title">View Tractors</h1>
      <p class="sub">Active tractors only. Tap a card to edit or reprint the QR.</p>

      <!-- Search -->
      <div class="search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M21 21l-4.2-4.2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"/></svg>
        <input id="q" type="search" placeholder="Search make, model, year, serial…" autocomplete="off"/>
      </div>

      <!-- Sort + Add -->
      <div class="filters-row">
        <select id="sort" class="input" style="max-width:220px">
          <option value="name">Name (A→Z)</option>
          <option value="year">Year (new→old)</option>
          <option value="hours">Hours (high→low)</option>
          <option value="created">Recently added</option>
        </select>
        <a class="btn" href="./actions/add.html?type=tractor">Add Tractor</a>
      </div>

      <p id="count" class="count">0 entries</p>
      <div id="list" class="list"></div>
    </div>
  </fv-shell>

  <!-- Edit modal -->
  <dialog id="detail" class="sheet" aria-modal="true">
    <header>
      <strong id="dTitle">Unit</strong>
      <div style="display:flex;gap:8px">
        <button id="dClose" class="btn" type="button">Close</button>
        <button id="dSave" class="btn btn-primary" type="button">Save</button>
      </div>
    </header>
    <div class="body">
      <div class="grid2">
        <div><label>Make</label><input id="dwMake" class="input" placeholder="Make"></div>
        <div><label>Model</label><input id="dwModel" class="input" placeholder="Model"></div>
      </div>
      <div class="grid2">
        <div><label>Year</label><select id="dwYear" class="input"></select></div>
        <div><label>Serial #</label><input id="dwSerial" class="input" placeholder="Serial (optional)"></div>
      </div>
      <div class="grid2">
        <div><label>Engine Hours</label><input id="dwHours" type="number" step="0.1" class="input" placeholder="e.g., 1250.5"></div>
        <div><label>Status</label><select id="dwStatus" class="input"><option value="active">Active</option><option value="archived">Archived</option></select></div>
      </div>
      <div><label>Notes</label><textarea id="dwNotes" class="textarea" placeholder="Optional details"></textarea></div>

      <div class="qr-box">
        <div style="display:flex;gap:14px;align-items:center;flex-wrap:wrap">
          <div class="qr-img"><img id="qrSmall" alt="QR" hidden></div>
          <div class="qr-actions">
            <button id="btnReprint" class="btn" type="button" disabled>Reprint QR</button>
            <a id="btnOpenHub" class="btn btn-quiet">Open Hub</a>
          </div>
        </div>
        <div id="qrMsg" class="qr-empty" hidden>No QR yet — generate one on the Add/Edit page and save.</div>
      </div>
    </div>
    <footer>
      <button id="dClose2" class="btn" type="button">Close</button>
    </footer>
  </dialog>

  <!-- Toast -->
  <div id="toast" class="local-toast" aria-live="polite" aria-atomic="true"></div>

  <!-- QR lib -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js" onload="window.__qrReady=true;"></script>

  <script type="module">
    import {
      ready,
      getFirestore, collection, query, getDocs, doc, getDoc, updateDoc, serverTimestamp
    } from '../../js/firebase-init.js';

    const $ = sel => document.querySelector(sel);
    const list = $('#list');
    const countEl = $('#count');
    const qInput = $('#q');

    let DATA = [];        // all tractors (active-only after filter)
    let DB, currentId=null, currentSmartLink=null, currentQRImageUrl=null;

    function toast(msg, ms=1600){ const t=document.getElementById('toast'); if(!t) return; t.textContent=msg||''; t.classList.add('show'); clearTimeout(toast._tt); toast._tt=setTimeout(()=>t.classList.remove('show'),ms); }

    function normalize(d, id){
      const status = String(d.status ?? 'active').toLowerCase();
      return {
        id, ...d,
        status,
        _statusLabel: status==='archived'?'Archived':'Active',
        name: d.name || [d.makeName, d.modelName].filter(Boolean).join(' ')
      };
    }

    function buildYearOptions(sel){
      sel.innerHTML = '<option value="">—</option>';
      const now = new Date().getFullYear();
      for(let y=now;y>=1980;y--){ const o=document.createElement('option'); o.value=String(y); o.textContent=String(y); sel.appendChild(o); }
    }

    function render(){
      const q = (qInput.value || '').toLowerCase().trim();

      // Active only; treat missing status as active
      let rows = DATA.filter(r=>{
        if (r.status && r.status !== 'active') return false;
        if (!q) return true;
        const blob = [r.name,r.makeName,r.modelName,r.year,r.serial,r.engineHours].join(' ').toLowerCase();
        return blob.includes(q);
      });

      const sort = document.getElementById('sort').value;
      if(sort==='name') rows.sort((a,b)=>String(a.name||'').localeCompare(String(b.name||'')));
      else if(sort==='year') rows.sort((a,b)=>(b.year||0)-(a.year||0));
      else if(sort==='hours') rows.sort((a,b)=>(Number(b.engineHours||0)-Number(a.engineHours||0)));
      else if(sort==='created') rows.sort((a,b)=>((b.createdAt?.seconds||0)-(a.createdAt?.seconds||0)));

      countEl.textContent = `${rows.length}/${DATA.length} entries`;
      list.innerHTML = '';

      if(!rows.length){
        const p=document.createElement('p'); p.className='muted'; p.textContent='No tractors to show.'; list.appendChild(p); return;
      }

      rows.forEach(r=>{
        const card = document.createElement('div'); card.className='card'; card.setAttribute('role','button');
        const makeModel = [r.makeName, r.modelName].filter(Boolean).join(' ');
        card.innerHTML = `
          <div class="row"><div class="name">${escapeHtml(r.name || makeModel || '—')}</div></div>
          <div class="row muted">${escapeHtml(makeModel || '—')}${r.year?` • ${escapeHtml(r.year)}`:''}</div>
          <div class="tags">
            <span class="tag green">Active</span>
            ${r.serial ? `<span class="tag gray">#${escapeHtml(String(r.serial).slice(-6))}</span>` : ``}
          </div>
        `;
        card.addEventListener('click', ()=> openModal(r.id));
        list.appendChild(card);
      });
    }

    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;",'"':"&quot;","'":"&#39;"}[m])); }

    async function loadAll(){
      await ready; DB = getFirestore();
      const qref = query(collection(DB,'equipment')); // pull all, filter client-side for active+tractor
      const snap = await getDocs(qref);
      const out = [];
      snap.forEach(docSnap=>{
        const d = docSnap.data() || {};
        if (String(d.type||'').toLowerCase() !== 'tractor') return;
        // treat missing status as active
        const status = String(d.status ?? 'active').toLowerCase();
        if (status !== 'active' && d.status !== undefined) return;
        out.push(normalize(d, docSnap.id));
      });
      DATA = out.sort((a,b)=>String(a.name||'').localeCompare(String(b.name||'')));
      render();
    }

    // ===== Modal + QR =====
    const dlg = document.getElementById('detail');
    const dTitle = document.getElementById('dTitle');
    const close = ()=> { try{dlg.close();}catch{dlg.removeAttribute('open');} };
    document.getElementById('dClose').addEventListener('click', close);
    document.getElementById('dClose2').addEventListener('click', close);

    function yearOptions(sel, value){ buildYearOptions(sel); if(value) sel.value=String(value); }
    const hubUrl = (id, token) => `${location.origin}/Farm-vista/pages/equipment/actions/hub.html?id=${encodeURIComponent(id)}${token?`&t=${encodeURIComponent(token)}`:''}`;
    const smartLaunch = (absTo) => { const u = new URL(location.origin + '/Farm-vista/launch.html'); u.searchParams.set('to', absTo); return u.href; };
    function waitQRReady(cb){ let tries=0;(function tick(){ if(window.__qrReady&&window.QRCode) cb(); else if(tries++<200) setTimeout(tick,50); })(); }

    async function openModal(id){
      currentId = id; currentSmartLink = null; currentQRImageUrl = null;
      let snap; try{ snap = await getDoc(doc(DB,'equipment', id)); }catch(e){ console.error(e); return; }
      if(!snap.exists()) return;
      const d = snap.data() || {};
      const name = d.name || [d.makeName,d.modelName].filter(Boolean).join(' ');
      dTitle.textContent = name || `Unit ${id.slice(0,6)}`;
      document.getElementById('dwMake').value  = d.makeName || '';
      document.getElementById('dwModel').value = d.modelName || '';
      yearOptions(document.getElementById('dwYear'), d.year||'');
      document.getElementById('dwSerial').value = d.serial || '';
      document.getElementById('dwHours').value  = (d.engineHours!=null)? d.engineHours : '';
      document.getElementById('dwStatus').value = String(d.status ?? 'active').toLowerCase();
      document.getElementById('dwNotes').value  = d.notes || '';

      const token = d.qr?.token || null;
      const savedImg = d.qr?.image?.url || null;
      const hub = token ? hubUrl(id, token) : null;
      const openHubBtn = document.getElementById('btnOpenHub'); openHubBtn.href = hub || '#'; openHubBtn.target = "_self"; openHubBtn.rel = "";

      const img = document.getElementById('qrSmall'); const msg = document.getElementById('qrMsg');
      if (savedImg){
        currentQRImageUrl = savedImg; img.src = savedImg; img.alt = "Saved QR"; img.hidden=false; msg.hidden=true; document.getElementById('btnReprint').disabled=false;
      } else if (!token){
        img.hidden=true; msg.hidden=false; msg.textContent="No QR yet — generate one on the Add/Edit page and save."; currentSmartLink=null; document.getElementById('btnReprint').disabled=true;
      } else {
        const smart = smartLaunch(hub); currentSmartLink = smart;
        img.hidden=true; msg.hidden=false; msg.textContent="Generating…";
        waitQRReady(()=>{
          try{
            const holder=document.createElement('div');
            new window.QRCode(holder,{text:smart,width:180,height:180,correctLevel: window.QRCode.CorrectLevel.H,colorDark:"#000",colorLight:"#fff"});
            const node = holder.querySelector('canvas') || holder.querySelector('img');
            img.src = node.tagName==='CANVAS' ? node.toDataURL('image/png') : node.src;
            img.alt = "QR for Equipment Hub"; img.hidden=false; msg.hidden=true; document.getElementById('btnReprint').disabled=false;
          }catch(e){ console.error(e); img.hidden=true; msg.hidden=false; msg.textContent="QR render failed."; document.getElementById('btnReprint').disabled=true; }
        });
      }

      try{ dlg.showModal(); }catch{ dlg.setAttribute('open',''); }
    }

    document.getElementById('dSave').addEventListener('click', async ()=>{
      if(!currentId) return;
      const ref = doc(DB,'equipment', currentId);
      const patch = {
        makeName: document.getElementById('dwMake').value.trim() || null,
        modelName: document.getElementById('dwModel').value.trim() || null,
        year: document.getElementById('dwYear').value ? Number(document.getElementById('dwYear').value) : null,
        serial: document.getElementById('dwSerial').value.trim() || null,
        engineHours: document.getElementById('dwHours').value ? Number(document.getElementById('dwHours').value) : null,
        status: (document.getElementById('dwStatus').value || 'active').toLowerCase(),
        notes: document.getElementById('dwNotes').value.trim() || null,
        updatedAt: serverTimestamp()
      };
      const nm = [patch.makeName, patch.modelName].filter(Boolean).join(' ');
      patch.name = nm ? (patch.year ? `${nm} (${patch.year})` : nm) : null;

      try{
        await updateDoc(ref, patch);
        // update DATA cache
        const i = DATA.findIndex(x=>x.id===currentId);
        if(i>-1) DATA[i] = normalize({ ...DATA[i], ...patch }, currentId);
        render();
        toast('Saved'); close();
      }catch(e){ console.error(e); toast('Save failed'); }
    });

    document.getElementById('btnReprint').addEventListener('click', ()=>{
      function last6(v){ v=String(v||""); return v.slice(-6); }
      function closeAfterPrint(win){ try{ win.onafterprint=()=>{try{win.close()}catch{}}; const mq=win.matchMedia&&win.matchMedia('print'); if(mq&&mq.addEventListener){ mq.addEventListener('change',(m)=>{ if(!m.matches){ setTimeout(()=>{try{win.close()}catch{}},60); } }); } win.onfocus=()=>{ setTimeout(()=>{try{win.close()}catch{}},200); }; }catch{} }
      const model = document.getElementById('dwModel').value.trim() || "";
      const serial = document.getElementById('dwSerial').value.trim() || "";
      const caption = `${model || "Unit"} - #${last6(serial)}`;
      if (currentQRImageUrl){
        const url = currentQRImageUrl + (currentQRImageUrl.includes('?') ? '&' : '?') + 'v=' + Date.now();
        const w = window.open('', '_blank', 'width=600,height=700');
        w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>Print QR</title>
          <style>@page{size:2in 2.25in;margin:3mm}html,body{height:100%}body{margin:0;display:flex;align-items:center;justify-content:center;font-family:ui-sans-serif,system-ui}
          .wrap{text-align:center}img{display:block;width:100%;max-width:380px;height:auto;margin:0 auto 4px}
          h1{font-size:12px;margin:0;line-height:1.05;font-family:ui-monospace;font-weight:700}</style></head><body>
          <div class="wrap"><img id="qr" src="${url}" alt="QR"><h1>${caption.replace(/</g,'&lt;')}</h1></div>
          <script>(function(){var i=document.getElementById('qr');function p(){try{window.print()}catch{}} if(i.complete){setTimeout(p,60)}else{i.addEventListener('load',function(){setTimeout(p,60)})}})();<\/script>
          </body></html>`);
        w.document.close(); closeAfterPrint(w); return;
      }
      if(!currentSmartLink){ alert("No QR for this unit yet."); return; }
      const w = window.open('', '_blank', 'width=600,height=700');
      w.document.write(`<!doctype html><html><head><meta charset="utf-8"><title>Print QR</title>
        <style>@page{size:2in 2.25in;margin:3mm}html,body{height:100%}body{margin:0;display:flex;align-items:center;justify-content:center;font-family:ui-sans-serif,system-ui}
        .wrap{text-align:center}#qr{width:100%;max-width:380px;margin:0 auto 4px}
        h1{font-size:12px;margin:0;line-height:1.05;font-family:ui-monospace;font-weight:700}</style></head><body>
        <div class="wrap"><div id="qr"></div><h1>${caption.replace(/</g,'&lt;')}</h1></div>
        <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"><\/script>
        <script>(function(){function go(){new QRCode(document.getElementById('qr'),{text:${JSON.stringify(currentSmartLink)},width:380,height:380,correctLevel:QRCode.CorrectLevel.H,colorDark:'#000',colorLight:'#fff'});setTimeout(function(){window.print()},250)} if(window.QRCode)go();else window.addEventListener('load', go);})();<\/script>
        </body></html>`);
      w.document.close(); closeAfterPrint(w);
    });

    qInput.addEventListener('input', render);
    document.getElementById('sort').addEventListener('change', render);

    // Kickoff like Directory page (single pull)
    loadAll();
  </script>
</body>
</html>