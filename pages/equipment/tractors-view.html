<!-- =========================================================
/Farm-vista/pages/equipment/tractors-view.html
View Tractors — tight, rounded selects/inputs (combo-template style)
========================================================= -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista • View Tractors</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>

  <!-- Theme + base app styles -->
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <!-- Ensure fv-shell -->
  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true; document.head.appendChild(s);
      }
    })();
  </script>

  <style>
    :root{
      --brand:var(--green,#3B7E46);
      --card-max:1200px;

      /* ===== Combo-template tokens ===== */
      --combo-gap: 4px;             /* tight vertical gap */
      --combo-radius: 12px;         /* panel rounding (for any future combos) */
      --combo-btn-radius: 10px;     /* trigger/search rounding */
      --combo-shadow: 0 12px 26px rgba(0,0,0,.18);
      --combo-item-pad: 10px 8px;
      --combo-max-h: 50vh;
    }

    body{ background:var(--app-bg,var(--surface)); }
    .wrap{
      max-width:var(--card-max); margin:0 auto; padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + 80px)!important;
    }

    header.page{margin:8px 0 14px;}
    header.page h1{margin:0 0 6px 0; font-size:clamp(22px,3.5vw,28px)}
    header.page p{margin:0; color:var(--muted,#67706B)}

    .toolbar{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:10px 0 14px}

    /* ===== Inputs + Selects (tight + rounded + custom caret) ===== */
    .input, .select, .textarea{
      width:100%;
      font:inherit; font-size:16px; color:var(--text);
      background:var(--card-surface,var(--surface));
      border:1px solid var(--border);
      border-radius:var(--combo-btn-radius);
      padding:10px 12px;            /* tight padding to match template */
      outline:none; line-height:1.2;
      min-height:40px;              /* compact but tappable */
    }
    .textarea{min-height:110px; resize:vertical}

    /* Remove native select arrows; add subtle caret (no blue) */
    .select{
      -webkit-appearance:none; -moz-appearance:none; appearance:none;
      position:relative;
      background-image:
        url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="14" height="8" viewBox="0 0 14 8"><path d="M1 1l6 6 6-6" fill="none" stroke="%2367706B" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>');
      background-repeat:no-repeat;
      background-position:right 12px center;
      background-size:14px 8px;
      padding-right:40px;           /* room for caret */
      cursor:pointer;
    }
    .select::-ms-expand{ display:none; } /* IE arrow */

    /* Focus/hover to feel crisp but on-brand */
    .input:focus, .select:focus, .textarea:focus{
      border-color: color-mix(in srgb, var(--brand), #000 15%);
      box-shadow: 0 0 0 2px color-mix(in srgb, var(--brand), transparent 70%);
    }
    .input:hover, .select:hover, .textarea:hover{
      border-color: color-mix(in srgb, var(--border), #000 20%);
    }

    .toolbar .input{ min-width:240px; }
    .toolbar .select{ min-width:160px; }

    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:10px 14px; border-radius:12px; border:1px solid var(--border);
      background:var(--card-surface,var(--surface)); font-weight:800; color:var(--text)!important; cursor:pointer;
    }
    .btn-primary{ border-color:transparent; background:var(--brand); color:#fff!important }
    .btn-quiet{ background:transparent }

    .list{ border:1px solid var(--border); border-radius:14px; overflow:hidden; background:var(--surface); }
    .thead,.row{ display:grid; grid-template-columns: 0.6fr 1.2fr 0.6fr 0.6fr; gap:10px; align-items:center; }
    .thead{ padding:10px 12px; font-weight:800; background:color-mix(in srgb, var(--brand) 10%, transparent); }
    .row{ padding:12px; border-top:1px solid var(--border); cursor:pointer }
    .row:hover{ background:color-mix(in srgb, var(--brand) 6%, transparent); }
    .status{ font-size:12px; border:1px solid var(--border); border-radius:999px; padding:2px 8px; }

    @media (max-width:900px){
      .thead{ display:none }
      .row{ grid-template-columns: 1fr; gap:6px }
      .row .mobile-line{ font-size:13px; color:var(--muted) }
    }

    /* ===== Centered modal ===== */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:9000; }
    .modal-backdrop.show{ display:flex; }
    .modal-card{ width:min(720px,95vw); max-height:90vh; overflow:auto; background:var(--surface); border:1px solid var(--border); border-radius:16px; box-shadow:0 20px 60px rgba(0,0,0,.35); display:flex; flex-direction:column; }
    .md-head{ display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--border); background:color-mix(in srgb, var(--brand) 10%, transparent) }
    .md-body{ padding:16px; display:grid; gap:12px }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
    @media (max-width:640px){ .grid2{ grid-template-columns:1fr } }

    .qr-box{ border:1px dashed var(--border); border-radius:12px; padding:12px; display:grid; gap:10px; background:color-mix(in srgb, var(--brand) 4%, transparent); }
    .qr-img{ width:196px; height:196px; background:#fff; border:1px solid var(--border); border-radius:8px; display:grid; place-items:center; overflow:hidden; padding:8px; }
    .qr-img img{ max-width:180px; max-height:180px; display:block }
    .qr-actions{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px }
  </style>
</head>
<body>
  <fv-shell>
    <div class="wrap">
      <header class="page">
        <h1>View Tractors</h1>
        <p class="muted">Search and filter. Tap a row to edit or reprint the QR.</p>
      </header>

      <div class="toolbar">
        <input id="search" class="input" placeholder="Search make, model, year, serial…">
        <select id="filter" class="select">
          <option value="active">Active</option>
          <option value="archived">Archived</option>
          <option value="all">All</option>
        </select>
        <select id="sort" class="select">
          <option value="name">Name (A→Z)</option>
          <option value="year">Year (new→old)</option>
          <option value="hours">Hours (high→low)</option>
          <option value="created">Recently added</option>
        </select>
        <a class="btn" href="/Farm-vista/pages/equipment/actions/add.html?type=tractor">Add Tractor</a>
      </div>

      <div class="list">
        <div class="thead">
          <div>Name</div>
          <div>Make / Model • Year</div>
          <div>Status</div>
          <div>Added</div>
        </div>
        <div id="rows"></div>
      </div>
    </div>
  </fv-shell>

  <!-- Modal -->
  <div id="modal" class="modal-backdrop" aria-modal="true" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-labelledby="mdTitle">
      <div class="md-head">
        <strong id="mdTitle">Unit</strong>
        <div style="display:flex;gap:8px">
          <button id="btnClose" class="btn" type="button">Close</button>
          <button id="btnSave" class="btn btn-primary" type="button">Save</button>
        </div>
      </div>
      <div class="md-body">
        <div class="grid2">
          <div>
            <label>Make</label>
            <input id="dwMake" class="input" placeholder="Make">
          </div>
          <div>
            <label>Model</label>
            <input id="dwModel" class="input" placeholder="Model">
          </div>
        </div>
        <div class="grid2">
          <div>
            <label>Year</label>
            <select id="dwYear" class="select"></select>
          </div>
          <div>
            <label>Serial #</label>
            <input id="dwSerial" class="input" placeholder="Serial (optional)">
          </div>
        </div>
        <div class="grid2">
          <div>
            <label>Engine Hours</label>
            <input id="dwHours" type="number" step="0.1" class="input" placeholder="e.g., 1250.5">
          </div>
          <div>
            <label>Status</label>
            <select id="dwStatus" class="select">
              <option value="active">Active</option>
              <option value="archived">Archived</option>
            </select>
          </div>
        </div>
        <div>
          <label>Notes</label>
          <textarea id="dwNotes" class="textarea" placeholder="Optional details"></textarea>
        </div>

        <div class="qr-box">
          <div style="display:flex; gap:14px; align-items:center; flex-wrap:wrap">
            <div class="qr-img"><img id="qrSmall" alt="QR"></div>
            <div class="qr-actions">
              <button id="btnReprint" class="btn" type="button">Reprint QR</button>
              <a id="btnOpenHub" class="btn btn-quiet" target="_blank" rel="noopener">Open Hub</a>
            </div>
          </div>
          <div id="printSheet" class="print-sheet"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Minimal QR PNG generator (kept same as your add page) -->
  <script>
    if(!window.QRGen){
      (function(global){function QR8bitByte(d){this.mode=1;this.data=d}
      QR8bitByte.prototype={getLength:function(){return unescape(encodeURIComponent(this.data)).length},write:function(b){var s=unescape(encodeURIComponent(this.data));for(var i=0;i<s.length;i++)b.put(s.charCodeAt(i),8)}};function QRBitBuffer(){this.buffer=[],this.length=0}
      QRBitBuffer.prototype={get:function(i){return((this.buffer[i>>3]>>>(7-i%8))&1)==1},put:function(n,l){for(var i=0;i<l;i++)this.putBit(((n>>>(l-i-1))&1)==1)},putBit:function(bit){var bi=this.length>>3;if(this.buffer.length<=bi)this.buffer.push(0);if(bit)this.buffer[bi]|=(0x80>>>(this.length%8));this.length++}};
      var QRUtil={PATTERN_POSITION_TABLE:[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54],[6,32,58],[6,34,62]],G15:1335,G18:7973,G15_MASK:21522,
      getBCHTypeInfo:function(d){var x=d<<10;while(QRUtil.getBCHDigit(x)-QRUtil.getBCHDigit(QRUtil.G15)>=0)x^=(QRUtil.G15<<(QRUtil.getBCHDigit(x)-QRUtil.getBCHDigit(QRUtil.G15)));return(x|d<<10)^QRUtil.G15_MASK;},
      getBCHDigit:function(d){var n=0;while(d!=0){n++;d>>>=1}return n},getMask:function(m,i,j){switch(m){case 0:return(i+j)%2==0;case 1:return i%2==0;case 2:return j%3==0;case 3:return(i+j)%3==0;case 4:return((i/2|0)+(j/3|0))%2==0;case 5:return(i*j)%2+(i*j)%3==0;case 6:return((i*j)%2+(i*j)%3)%2==0;case 7:return((i*j)%3+i+j)%2==0;}};
      var QRMath={EXP_TABLE:new Array(256),LOG_TABLE:new Array(256),glog:function(n){if(n<1)throw new Error("glog("+n+")");return this.LOG_TABLE[n]},gexp:function(n){while(n<0)n+=255;while(n>=256)n-=255;return this.EXP_TABLE[n}};
      for(var i=0;i<8;i++)QRMath.EXP_TABLE[i]=1<<i;for(i=8;i<256;i++)QRMath.EXP_TABLE[i]=QRMath.EXP_TABLE[i-4]^QRMath.EXP_TABLE[i-5]^QRMath.EXP_TABLE[i-6]^QRMath.EXP_TABLE[i-8];for(i=0;i<255;i++)QRMath.LOG_TABLE[QRMath.EXP_TABLE[i]]=i;
      function QRPolynomial(num,shift){var offset=0;while(offset<num.length&&num[offset]==0)offset++;this.num=new Array(num.length-offset+shift);for(var i=0;i<num.length-offset;i++)this.num[i]=num[i+offset]}
      QRPolynomial.prototype={get:function(i){return this.num[i]},getLength:function(){return this.num.length},multiply:function(e){var n=new Array(this.getLength()+e.getLength()-1);for(var i=0;i<this.getLength();i++)for(var j=0;j<e.getLength();j++)n[i+j]^=QRMath.gexp(QRMath.glog(this.get(i))+QRMath.glog(e.get(j)));return new QRPolynomial(n,0)},mod:function(e){if(this.getLength()-e.getLength()<0)return this;var r=QRMath.glog(this.get(0))-QRMath.glog(e.get(0));var n=this.num.slice(0);for(var i=0;i<e.getLength();i++)n[i]^=QRMath.gexp(QRMath.glog(e.get(i))+r);return new QRPolynomial(n,0).mod(e)}};
      var RS_BLOCK_TABLE={1:[[26,20]],2:[[44,34]],3:[[70,55]],4:[[100,80]],5:[[134,108]],6:[[172,136]],7:[[196,156]],8:[[242,194]],9:[[292,232]],10:[[346,274]],12:[[466,356]]};
      function QRCode(t,e){this.typeNumber=t;this.errorCorrectLevel=e;this.modules=null;this.moduleCount=0;this.dataList=[]}
      QRCode.prototype={addData:function(d){this.dataList.push(new QR8bitByte(d))},isDark:function(r,c){return this.modules[r][c]},getModuleCount:function(){return this.moduleCount},
      make:function(){this.typeNumber=this.typeNumber||1;for(;;){this.makeImpl(false,this.getBestMaskPattern());if(this.getDataCapacity()>=this.getDataLength())break;this.typeNumber++;if(this.typeNumber>12)break}},
      makeImpl:function(test,mask){this.moduleCount=this.typeNumber*4+17;this.modules=new Array(this.moduleCount);for(var r=0;r<this.moduleCount;r++){this.modules[r]=new Array(this.moduleCount);for(var c=0;c<this.moduleCount;c++)this.modules[r][c]=null}
      ;for(var r2=-1;r2<=7;r2++)for(var c2=-1;c2<=7;c2++){this.modules[r2+0]&&this.modules[0][c2]!=null}
      this.setupPositionProbePattern(0,0);this.setupPositionProbePattern(this.moduleCount-7,0);this.setupPositionProbePattern(0,this.moduleCount-7);
      for(var i=8;i<this.moduleCount-8;i++){if(this.modules[i][6]===null)this.modules[i][6]=(i%2==0);if(this.modules[6][i]===null)this.modules[6][i]=(i%2==0)}
      this.setupTypeInfo(test,mask);var data=this.createData();this.mapData(data,mask)},
      setupPositionProbePattern:function(row,col){for(var r=-1;r<=7;r++){if(row+r<=-1||this.moduleCount<=row+r)continue;for(var c=-1;c<=7;c++){if(col+c<=-1||this.moduleCount<=col+c)continue;
      this.modules[row+r][col+c]=(0<=r&&r<=6&&(c==0||c==6))||(0<=c&&c<=6&&(r==0||r==6))||(2<=r&&r<=4&&2<=c&&c<=4)}}},
      setupTypeInfo:function(test,mask){var data=(1<<3)|mask;var bits=QRUtil.getBCHTypeInfo(data);for(var i=0;i<15;i++){var mod=!test&&((bits>>i)&1)==1;this.modules[i<6?i:i<8?i+1:this.moduleCount-15+i][8]=mod}
      for(i=0;i<15;i++){var mod2=!test&&((bits>>i)&1)==1;this.modules[8][i<8?this.moduleCount-1-i:i==8?15-i:this.moduleCount-15+i]=mod2}this.modules[this.moduleCount-8][8]=!test},
      getBestMaskPattern:function(){var min=0,pat=0;for(var i=0;i<8;i++){this.makeImpl(true,i);var lost=this.getLostPoint();if(i==0||min>lost){min=lost;pat=i}}return pat},
      getLostPoint:function(){return 0},
      getDataCapacity:function(){var rs=(RS_BLOCK_TABLE[this.typeNumber]||RS_BLOCK_TABLE[12])[0];return rs[1]},
      getDataLength:function(){var bb=new QRBitBuffer();for(var i=0;i<this.dataList.length;i++){bb.put(4,4);bb.put(this.dataList[i].getLength(),8);this.dataList[i].write(bb)}return bb.length/8|0},
      createData:function(){var bb=new QRBitBuffer();for(var i=0;i<this.dataList.length;i++){bb.put(4,4);bb.put(this.dataList[i].getLength(),8);this.dataList[i].write(bb)}var rs=(RS_BLOCK_TABLE[this.typeNumber]||RS_BLOCK_TABLE[12])[0];var dc=rs[1],ec=(rs[0]-dc),data=[];for(i=0;i<bb.length;i+=8)data.push((bb.get(i)?128:0)|(bb.get(i+1)?64:0)|(bb.get(i+2)?32:0)|(bb.get(i+3)?16:0)|(bb.get(i+4)?8:0)|(bb.get(i+5)?4:0)|(bb.get(i+6)?2:0)|(bb.get(i+7)?1:0));while(data.length<dc)data.push(data.length%2?0x11:0xEC);
      var rsPoly=(function(ec){var a=new QRPolynomial([1],0);for(var i=0;i<ec;i++)a=a.multiply(new QRPolynomial([1,QRMath.gexp(i)],0));return a})(ec);var raw=new QRPolynomial(data,rsPoly.getLength()-1);var mod=raw.mod(rsPoly);
      var ecBytes=new Array(ec).fill(0),m=mod.num,off=ecBytes.length-m.length;for(i=0;i<m.length;i++)ecBytes[i+off]=m[i];return data.concat(ecBytes)};
      global.QRGen=function(text){var qr=new QRCode(null,2);qr.addData(text);qr.make();return qr.toDataURL(10)};})(window);
    }
  </script>

  <script type="module">
    import {
      ready,
      getFirestore, collection, getDocs, query, where, orderBy, doc, getDoc, updateDoc, serverTimestamp
    } from '/Farm-vista/js/firebase-init.js';

    const $ = id => document.getElementById(id);
    const esc = s => String(s||"").replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;",'"':"&quot;","'":"&#39;"}[m]));
    const fmtDate = ts => ts?.toDate ? new Date(ts.toDate()).toLocaleDateString() : (ts ? new Date(ts).toLocaleDateString() : "—");
    function buildYearOptions(sel){
      sel.innerHTML = '<option value="">—</option>';
      const now = new Date().getFullYear();
      for(let y=now;y>=1980;y--){
        const o=document.createElement('option'); o.value=String(y); o.textContent=String(y); sel.appendChild(o);
      }
    }
    const ensureHttps = (u)=>{ try{ const url = new URL(u, location.origin); if(url.protocol!=='https:') url.protocol='https:'; return url.toString(); }catch{ return u; } };

    let DB, tractors = [];
    let currentId = null;

    async function loadList(){
      const rows = $("rows"); rows.innerHTML = "";
      let snap;
      try{
        const f = $("filter").value;
        const base = collection(DB,'equipment');
        let qy;
        if(f === 'active'){
          qy = query(base, where('type','==','tractor'), where('status','==','active'), orderBy('name'));
        }else if(f === 'archived'){
          qy = query(base, where('type','==','tractor'), where('status','==','archived'), orderBy('name'));
        }else{
          qy = query(base, where('type','==','tractor'), orderBy('name'));
        }
        snap = await getDocs(qy);
      }catch(_){
        const base = collection(DB,'equipment');
        const all = await getDocs(query(base, where('type','==','tractor')));
        const temp = []; all.forEach(d=> temp.push({ id:d.id, ...d.data() }) );
        temp.sort((a,b)=>String(a.name||"").localeCompare(String(b.name||"")));
        tractors = temp; renderList(); return;
      }
      const list = []; snap.forEach(d=> list.push({ id:d.id, ...d.data() })); tractors = list; renderList();
    }

    function applySearchSort(items){
      const q = $("search").value.trim().toLowerCase();
      let out = items.filter(x=>{
        if($("filter").value==='active'   && x.status!=='active') return false;
        if($("filter").value==='archived' && x.status!=='archived') return false;
        if(!q) return true;
        const hay = [x.name,x.makeName,x.modelName,x.year,x.serial,x.engineHours].map(v=>String(v||"").toLowerCase()).join(" ");
        return hay.includes(q);
      });
      const sort = $("sort").value;
      if(sort==='name') out.sort((a,b)=>String(a.name||"").localeCompare(String(b.name||"")));
      else if(sort==='year') out.sort((a,b)=>(b.year||0)-(a.year||0));
      else if(sort==='hours') out.sort((a,b)=>(Number(b.engineHours||0) - Number(a.engineHours||0)));
      else if(sort==='created') out.sort((a,b)=>((b.createdAt?.seconds||0)-(a.createdAt?.seconds||0)));
      return out;
    }

    function renderList(){
      const rows = $("rows"); rows.innerHTML = "";
      const data = applySearchSort(tractors);
      for(const x of data){
        const row = document.createElement('div');
        row.className='row'; row.tabIndex=0; row.dataset.id = x.id;

        const name = x.name || [x.makeName, x.modelName].filter(Boolean).join(' ');
        const makeModel = [x.makeName, x.modelName].filter(Boolean).join(' ');

        row.innerHTML = `
          <div><strong>${esc(name||'—')}</strong></div>
          <div>${esc(makeModel||'—')}${x.year?` • ${esc(x.year)}`:''}</div>
          <div><span class="status">${esc(x.status||'active')}</span></div>
          <div>${esc(fmtDate(x.createdAt))}</div>
          <div class="mobile-line">${esc(makeModel||'—')} ${x.year?`• ${esc(x.year)}`:''} • ${esc(x.status||'active')} • ${esc(fmtDate(x.createdAt))}</div>
        `;
        const open = ()=> openModal(x.id);
        row.addEventListener('click', open);
        row.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); open(); }});
        rows.appendChild(row);
      }
    }

    function yearOptions(sel, value){ buildYearOptions(sel); if(value) sel.value=String(value); }

    async function openModal(id){
      currentId = id;
      const ref = doc(DB,'equipment', id);
      const snap = await getDoc(ref); if(!snap.exists()) return;

      const d = snap.data() || {};
      const name = d.name || [d.makeName,d.modelName].filter(Boolean).join(' ');
      $("mdTitle").textContent = name || `Unit ${id.slice(0,6)}`;
      $("dwMake").value  = d.makeName || '';
      $("dwModel").value = d.modelName || '';
      yearOptions($("dwYear"), d.year||'');
      $("dwSerial").value = d.serial || '';
      $("dwHours").value  = (d.engineHours!=null)? d.engineHours : '';
      $("dwStatus").value = d.status || 'active';
      $("dwNotes").value  = d.notes || '';

      // deep link for QR / hub
      let deep = d.qr?.url || `${location.origin}/Farm-vista/pages/equipment/actions/hub.html?id=${encodeURIComponent(id)}`;
      deep = ensureHttps(deep);
      $("btnOpenHub").href = deep;

      // show modal then render QR PNG
      $("modal").classList.add("show");
      $("modal").setAttribute('aria-hidden','false');
      try{
        const dataUrl = window.QRGen(deep);
        $("qrSmall").src = dataUrl;
      }catch(err){ console.warn('QR render failed:', err); }
    }

    async function saveModal(){
      if(!currentId) return;
      const ref = doc(DB,'equipment', currentId);
      const patch = {
        makeName: $("dwMake").value.trim() || null,
        modelName: $("dwModel").value.trim() || null,
        year: $("dwYear").value ? Number($("dwYear").value) : null,
        serial: $("dwSerial").value.trim() || null,
        engineHours: $("dwHours").value ? Number($("dwHours").value) : null,
        status: $("dwStatus").value || 'active',
        notes: $("dwNotes").value.trim() || null,
        updatedAt: serverTimestamp()
      };
      const nm = [patch.makeName, patch.modelName].filter(Boolean).join(' ');
      patch.name = nm ? (patch.year ? `${nm} (${patch.year})` : nm) : null;

      await updateDoc(ref, patch);
      const idx = tractors.findIndex(x=>x.id===currentId);
      if(idx>-1) tractors[idx] = { ...tractors[idx], ...patch };
      renderList();
    }

    function closeModal(){
      $("modal").classList.remove("show");
      $("modal").setAttribute('aria-hidden','true');
      currentId = null;
    }

    function reprintQR(){ window.print(); }

    (async()=>{
      await ready;
      DB = getFirestore();

      buildYearOptions(document.createElement('select')); // keep function warm
      await loadList();

      $("search").addEventListener('input', renderList);
      $("filter").addEventListener('change', loadList);
      $("sort").addEventListener('change', renderList);

      $("btnClose").addEventListener('click', closeModal);
      $("btnSave").addEventListener('click', async ()=>{ await saveModal(); closeModal(); });
      $("btnReprint").addEventListener('click', reprintQR);
      $("modal").addEventListener('click', (e)=>{ if(e.target === $("modal")) closeModal(); });
      document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && $("modal").classList.contains('show')) closeModal(); });
    })();
  </script>
</body>
</html>
