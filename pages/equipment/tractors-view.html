<!-- =========================================================
FILE 2 of 2
/Farm-vista/pages/equipment/tractors-view.html
Tractors summary list + centered modal: edit core fields, show QR, Reprint QR
========================================================= -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista • View Tractors</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>

  <!-- Theme + base app styles -->
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <!-- Ensure fv-shell -->
  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true; document.head.appendChild(s);
      }
    })();
  </script>

  <style>
    :root{ --brand:var(--green,#3B7E46); --card-max:1200px; }
    body{ background:var(--app-bg,var(--surface)); }
    .wrap{
      max-width:var(--card-max); margin:0 auto; padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + 80px)!important;
    }

    header.page{margin:8px 0 14px;}
    header.page h1{margin:0 0 6px 0; font-size:clamp(22px,3.5vw,28px)}
    header.page p{margin:0; color:var(--muted,#67706B)}

    .toolbar{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:10px 0 14px}
    .input,.select{
      font:inherit; font-size:16px; color:var(--text);
      background:var(--card-surface,var(--surface)); border:1px solid var(--border);
      border-radius:10px; padding:10px 12px;
    }
    .toolbar .input{ min-width:240px; }
    .toolbar .select{ min-width:160px; }

    /* Cleaner summary list */
    .list{
      border:1px solid var(--border); border-radius:14px; overflow:hidden; background:var(--surface);
    }
    .thead,.row{
      display:grid; grid-template-columns: 0.6fr 1.2fr 0.6fr 0.6fr;
      gap:10px; align-items:center;
    }
    .thead{ padding:10px 12px; font-weight:800; background:color-mix(in srgb, var(--brand) 10%, transparent); }
    .row{ padding:12px; border-top:1px solid var(--border); cursor:pointer }
    .row:hover{ background:color-mix(in srgb, var(--brand) 6%, transparent); }
    .status{ font-size:12px; border:1px solid var(--border); border-radius:999px; padding:2px 8px; }

    @media (max-width:900px){
      .thead{ display:none }
      .row{ grid-template-columns: 1fr; gap:6px }
      .row > div{ display:flex; gap:8px; }
      .row .mobile-line{ font-size:13px; color:var(--muted) }
    }

    /* Centered modal */
    .modal-backdrop{
      position:fixed; inset:0; background:rgba(0,0,0,.35);
      display:none; align-items:center; justify-content:center; z-index:9000;
    }
    .modal-backdrop.show{ display:flex; }
    .modal-card{
      width:min(720px,95vw); max-height:90vh; overflow:auto;
      background:var(--surface); border:1px solid var(--border); border-radius:16px;
      box-shadow:0 20px 60px rgba(0,0,0,.35); display:flex; flex-direction:column;
    }
    .md-head{ display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--border); background:color-mix(in srgb, var(--brand) 10%, transparent) }
    .md-body{ padding:16px; display:grid; gap:12px }
    .btn{ display:inline-flex; align-items:center; justify-content:center; padding:10px 14px; border-radius:12px; border:1px solid var(--border); background:var(--card-surface,var(--surface)); font-weight:800; color:var(--text)!important; cursor:pointer }
    .btn-primary{ border-color:transparent; background:var(--brand); color:#fff!important }
    .btn-quiet{ background:transparent }

    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
    @media (max-width:640px){ .grid2{ grid-template-columns:1fr } }

    .textarea,.input, .select{ width:100%; }

    /* QR */
    .qr-box{ border:1px dashed var(--border); border-radius:12px; padding:12px; display:grid; gap:10px; background:color-mix(in srgb, var(--brand) 4%, transparent); }
    .qr-img{ width:196px; height:196px; background:#fff; border:1px solid var(--border); border-radius:8px; display:grid; place-items:center; overflow:hidden; padding:8px; }
    .qr-meta code{ font-size:12px; background:rgba(0,0,0,.06); padding:3px 6px; border-radius:6px; color:var(--text) }
    .qr-actions{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px }

    /* Print sheet */
    @media print{
      body{ background:#fff }
      header.page, .toolbar, .list, .md-head, .btn, header.app, footer.app{ display:none !important }
      .modal-backdrop{ display:block !important; background:#fff !important; }
      .modal-card{ border:none; box-shadow:none; width:100%; max-height:unset }
      .print-sheet{ display:block !important; }
    }
    .print-sheet{ display:none; text-align:center; padding:24px }
    .qr-big{ width:560px; height:560px; margin:12px auto; border:1px solid var(--border); border-radius:16px; display:grid; place-items:center; background:#fff; padding:16px; }
  </style>
</head>
<body>
  <fv-shell>
    <div class="wrap">
      <header class="page">
        <h1>View Tractors</h1>
        <p class="muted">Search and filter. Tap a row to edit or reprint the QR.</p>
      </header>

      <div class="toolbar">
        <input id="search" class="input" placeholder="Search make, model, year, serial…">
        <select id="filter" class="select">
          <option value="active">Active</option>
          <option value="archived">Archived</option>
          <option value="all">All</option>
        </select>
        <select id="sort" class="select">
          <option value="name">Name (A→Z)</option>
          <option value="year">Year (new→old)</option>
          <option value="hours">Hours (high→low)</option>
          <option value="created">Recently added</option>
        </select>
        <a class="btn" href="/Farm-vista/pages/equipment/actions/add.html?type=tractor">Add Tractor</a>
      </div>

      <div class="list">
        <div class="thead">
          <div>Name</div>
          <div>Make / Model • Year</div>
          <div>Status</div>
          <div>Added</div>
        </div>
        <div id="rows"></div>
      </div>
    </div>
  </fv-shell>

  <!-- Centered modal -->
  <div id="modal" class="modal-backdrop" aria-modal="true" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-labelledby="mdTitle">
      <div class="md-head">
        <strong id="mdTitle">Unit</strong>
        <div style="display:flex;gap:8px">
          <button id="btnClose" class="btn" type="button">Close</button>
          <button id="btnSave" class="btn btn-primary" type="button">Save</button>
        </div>
      </div>
      <div class="md-body">
        <div class="grid2">
          <div>
            <label>Make</label>
            <input id="dwMake" class="input" placeholder="Make">
          </div>
          <div>
            <label>Model</label>
            <input id="dwModel" class="input" placeholder="Model">
          </div>
        </div>

        <div class="grid2">
          <div>
            <label>Year</label>
            <select id="dwYear" class="select"></select>
          </div>
          <div>
            <label>Serial #</label>
            <input id="dwSerial" class="input" placeholder="Serial (optional)">
          </div>
        </div>

        <div class="grid2">
          <div>
            <label>Engine Hours</label>
            <input id="dwHours" type="number" step="0.1" class="input" placeholder="e.g., 1250.5">
          </div>
          <div>
            <label>Status</label>
            <select id="dwStatus" class="select">
              <option value="active">Active</option>
              <option value="archived">Archived</option>
            </select>
          </div>
        </div>

        <div>
          <label>Notes</label>
          <textarea id="dwNotes" class="textarea" placeholder="Optional details"></textarea>
        </div>

        <!-- QR area -->
        <div class="qr-box">
          <div style="display:flex; gap:14px; align-items:center; flex-wrap:wrap">
            <div class="qr-img">
              <div id="qrSmall" aria-label="QR"></div>
            </div>
            <div class="qr-meta">
              <div><strong>Deep link:</strong> <code id="qrUrl">—</code></div>
              <div id="qrWarn" class="status" style="margin-top:6px" hidden>QR missing — create from Add page</div>
              <div class="qr-actions">
                <button id="btnReprint" class="btn" type="button">Reprint QR</button>
                <a id="btnOpenHub" class="btn btn-quiet" target="_blank" rel="noopener">Open Hub</a>
              </div>
            </div>
          </div>
          <!-- print-only sheet -->
          <div id="printSheet" class="print-sheet">
            <h2 id="psTitle">Equipment QR</h2>
            <div class="qr-big"><div id="qrBig"></div></div>
            <div id="psMeta" style="margin-top:8px;font-weight:700"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import {
      ready,
      getFirestore, collection, getDocs, query, where, orderBy, doc, getDoc, updateDoc, serverTimestamp
    } from '/Farm-vista/js/firebase-init.js';

    /* ---------- Utils ---------- */
    const $ = id => document.getElementById(id);
    const esc = s => String(s||"").replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;",'"':"&quot;","'":"&#39;"}[m]));
    const fmtDate = ts => ts?.toDate ? new Date(ts.toDate()).toLocaleDateString() : (ts ? new Date(ts).toLocaleDateString() : "—");
    function buildYearOptions(sel){
      sel.innerHTML = '<option value="">—</option>';
      const now = new Date().getFullYear();
      for(let y=now;y>=1980;y--){
        const o=document.createElement('option'); o.value=String(y); o.textContent=String(y); sel.appendChild(o);
      }
    }

    /* ---------- State ---------- */
    let DB, tractors = [];
    let currentId = null;
    let qrSmall, qrBig;

    /* ---------- Fetch and render list ---------- */
    async function loadList(){
      const rows = $("rows");
      rows.innerHTML = "";

      let snap;
      try{
        // Indexed query (active by default)
        const f = $("filter").value;
        const base = collection(DB,'equipment');
        let qy;
        if(f === 'active'){
          qy = query(base, where('type','==','tractor'), where('status','==','active'), orderBy('name'));
        }else if(f === 'archived'){
          qy = query(base, where('type','==','tractor'), where('status','==','archived'), orderBy('name'));
        }else{
          qy = query(base, where('type','==','tractor'), orderBy('name'));
        }
        snap = await getDocs(qy);
      }catch(e){
        // Fallback (no composite index)
        const base = collection(DB,'equipment');
        const all = await getDocs(query(base, where('type','==','tractor')));
        const temp = [];
        all.forEach(d=>{ temp.push({ id:d.id, ...d.data() }) });
        temp.sort((a,b)=>String(a.name||"").localeCompare(String(b.name||"")));
        tractors = temp;
        renderList();
        return;
      }

      const list = [];
      snap.forEach(d=> list.push({ id:d.id, ...d.data() }));
      tractors = list;
      renderList();
    }

    function applySearchSort(items){
      const q = $("search").value.trim().toLowerCase();
      let out = items.filter(x=>{
        if($("filter").value==='active'   && x.status!=='active') return false;
        if($("filter").value==='archived' && x.status!=='archived') return false;
        if(!q) return true;
        const hay = [
          x.name, x.makeName, x.modelName, x.year, x.serial, x.engineHours
        ].map(v=>String(v||"").toLowerCase()).join(" ");
        return hay.includes(q);
      });

      const sort = $("sort").value;
      if(sort==='name') out.sort((a,b)=>String(a.name||"").localeCompare(String(b.name||"")));
      else if(sort==='year') out.sort((a,b)=>(b.year||0)-(a.year||0));
      else if(sort==='hours') out.sort((a,b)=>(Number(b.engineHours||0) - Number(a.engineHours||0)));
      else if(sort==='created') out.sort((a,b)=>((b.createdAt?.seconds||0)-(a.createdAt?.seconds||0)));

      return out;
    }

    function renderList(){
      const rows = $("rows");
      rows.innerHTML = "";
      const data = applySearchSort(tractors);
      for(const x of data){
        const row = document.createElement('div');
        row.className='row';
        row.dataset.id = x.id;

        const name = x.name || [x.makeName, x.modelName].filter(Boolean).join(' ');
        const makeModel = [x.makeName, x.modelName].filter(Boolean).join(' ');

        row.innerHTML = `
          <div><strong>${esc(name||'—')}</strong></div>
          <div>${esc(makeModel||'—')}${x.year?` • ${esc(x.year)}`:''}</div>
          <div><span class="status">${esc(x.status||'active')}</span></div>
          <div>${esc(fmtDate(x.createdAt))}</div>

          <div class="mobile-line"> ${esc(makeModel||'—')} ${x.year?`• ${esc(x.year)}`:''} • ${esc(x.status||'active')} • ${esc(fmtDate(x.createdAt))}</div>
        `;
        row.addEventListener('click', ()=> openModal(x.id));
        rows.appendChild(row);
      }
    }

    /* ---------- Modal (view/edit + QR) ---------- */
    function yearOptions(sel, value){
      buildYearOptions(sel);
      if(value) sel.value = String(value);
    }

    function ensureHttps(u){
      try{
        const url = new URL(u);
        if(url.protocol !== 'https:') url.protocol = 'https:';
        return url.toString();
      }catch{
        return u;
      }
    }

    async function openModal(id){
      currentId = id;
      const ref = doc(DB,'equipment', id);
      const snap = await getDoc(ref);
      if(!snap.exists()) return;

      const d = snap.data() || {};
      const name = d.name || [d.makeName,d.modelName].filter(Boolean).join(' ');

      $("mdTitle").textContent = name || `Unit ${id.slice(0,6)}`;
      $("dwMake").value  = d.makeName || '';
      $("dwModel").value = d.modelName || '';
      yearOptions($("dwYear"), d.year||'');
      $("dwSerial").value = d.serial || '';
      $("dwHours").value  = (d.engineHours!=null)? d.engineHours : '';
      $("dwStatus").value = d.status || 'active';
      $("dwNotes").value  = d.notes || '';

      // QR
      let deep = d.qr?.url || '';
      if(!deep){
        // Fallback deep link if user didn't store one:
        // change this if your hub path differs
        deep = `${location.origin}/Farm-vista/pages/equipment/hub.html?type=tractor&id=${encodeURIComponent(id)}`;
      }
      deep = ensureHttps(deep);
      $("qrUrl").textContent = deep;

      $("btnOpenHub").href = deep || "#";
      $("qrWarn").hidden = !!deep;

      // Render QR (small + big) with reliable library
      if(qrSmall){ qrSmall.clear(); }
      if(qrBig){ qrBig.clear(); }

      qrSmall = new QRCode(document.getElementById("qrSmall"), {
        text: deep || "about:blank",
        width: 180, height: 180,
        correctLevel: QRCode.CorrectLevel.Q, // solid middle-high EC
        margin: 2
      });
      qrBig = new QRCode(document.getElementById("qrBig"), {
        text: deep || "about:blank",
        width: 520, height: 520,
        correctLevel: QRCode.CorrectLevel.Q,
        margin: 4
      });

      // Show modal
      $("modal").classList.add("show");
      $("modal").setAttribute('aria-hidden','false');
    }

    async function saveModal(){
      if(!currentId) return;
      const ref = doc(DB,'equipment', currentId);
      const patch = {
        makeName: $("dwMake").value.trim() || null,
        modelName: $("dwModel").value.trim() || null,
        year: $("dwYear").value ? Number($("dwYear").value) : null,
        serial: $("dwSerial").value.trim() || null,
        engineHours: $("dwHours").value ? Number($("dwHours").value) : null,
        status: $("dwStatus").value || 'active',
        notes: $("dwNotes").value.trim() || null,
      };
      const nm = [patch.makeName, patch.modelName].filter(Boolean).join(' ');
      patch.name = nm ? (patch.year ? `${nm} (${patch.year})` : nm) : null;

      patch.updatedAt = serverTimestamp();
      await updateDoc(ref, patch);
      // refresh in-memory + re-render
      const idx = tractors.findIndex(x=>x.id===currentId);
      if(idx>-1){
        tractors[idx] = { ...tractors[idx], ...patch };
      }
      renderList();
    }

    function closeModal(){
      $("modal").classList.remove("show");
      $("modal").setAttribute('aria-hidden','true');
      currentId = null;
    }

    function reprintQR(){
      const title = $("mdTitle").textContent || "Equipment QR";
      $("psTitle").textContent = title;
      $("psMeta").textContent  = $("qrUrl").textContent;
      window.print();
    }

    /* ---------- Boot ---------- */
    (async()=>{
      await ready;
      DB = getFirestore();

      buildYearOptions($("dwYear"));
      await loadList();

      $("search").addEventListener('input', renderList);
      $("filter").addEventListener('change', loadList);
      $("sort").addEventListener('change', renderList);

      $("btnClose").addEventListener('click', closeModal);
      $("btnSave").addEventListener('click', async ()=>{
        await saveModal();
        closeModal();
      });
      $("btnReprint").addEventListener('click', reprintQR);

      // Close modal on backdrop click
      $("modal").addEventListener('click', (e)=>{
        if(e.target === $("modal")) closeModal();
      });

      // ESC key to close
      document.addEventListener('keydown', (e)=>{
        if(e.key === 'Escape' && $("modal").classList.contains('show')) closeModal();
      });
    })();
  </script>

  <!-- Embedded, reliable QRCode generator (MIT, Kazuhiko Arase) -->
  <script>
  /*!
  * QRCode.js - https://github.com/davidshimjs/qrcodejs (minified inline)
  * (c) 2012-2019 Kazuhiko Arase, David Shim; MIT License
  */
  !function(o){function t(o){this.mode=h.MODE_8BIT_BYTE,this.data=o,this.parsedData=[];for(var t=0,e=this.data.length;t<e;t++){var r=[],n=this.data.charCodeAt(t);n>65536?(r[0]=240|(1835008&n)>>>18,r[1]=128|(258048&n)>>>12,r[2]=128|(4032&n)>>>6,r[3]=128|63&n):n>2048?(r[0]=224|(61440&n)>>>12,r[1]=128|(4032&n)>>>6,r[2]=128|63&n):n>128?(r[0]=192|(1984&n)>>>6,r[1]=128|63&n):r[0]=n,this.parsedData.push(r)}this.parsedData=Array.prototype.concat.apply([],this.parsedData)}function e(o,t){this.typeNumber=o,this.errorCorrectLevel=t,this.modules=null,this.moduleCount=0,this.dataCache=null,this.dataList=[]}function r(o,t){if(void 0==o.length)throw new Error(o.length+"/"+t);for(var e=0;e<o.length&&0==o[e];)e++;this.num=new Array(o.length-e+t);for(var r=0;r<o.length-e;r++)this.num[r]=o[r+e]}function n(o,t){this.totalCount=o,this.dataCount=t}function i(){this.buffer=[],this.length=0}function u(){return"undefined"!=typeof CanvasRenderingContext2D}function s(){var o=!1,t=navigator.userAgent;return/android/i.test(t)&&(o=!0,o=/Chrome\/(\d+)/i.test(t)?parseInt(RegExp.$1,10)>=32:!1),o}function a(o,t){this._el=o,this._htOption=t}t.prototype={getLength:function(o){return this.parsedData.length},write:function(o){for(var t=0,e=this.parsedData.length;t<e;t++)o.put(this.parsedData[t],8)}},e.prototype={addData:function(o){var e=new t(o);this.dataList.push(e),this.dataCache=null},isDark:function(o,t){if(null==this.modules[o][t])throw new Error(o+","+t);return this.modules[o][t]},getModuleCount:function(){return this.moduleCount},make:function(){this.makeImpl(!1,this.getBestMaskPattern())},makeImpl:function(o,t){this.moduleCount=4*this.typeNumber+17,this.modules=new Array(this.moduleCount);for(var r=0;r<this.moduleCount;r++){this.modules[r]=new Array(this.moduleCount);for(var n=0;n<this.moduleCount;n++)this.modules[r][n]=null}this.setupPositionProbePattern(0,0),this.setupPositionProbePattern(this.moduleCount-7,0),this.setupPositionProbePattern(0,this.moduleCount-7),this.setupPositionAdjustPattern(),this.setupTimingPattern(),this.setupTypeInfo(o,t),this.typeNumber>=7&&this.setupTypeNumber(o),null==this.dataCache&&(this.dataCache=e.createData(this.typeNumber,this.errorCorrectLevel,this.dataList)),this.mapData(this.dataCache,t)},setupPositionProbePattern:function(o,t){for(var e=-1;e<=7;e++)if(!(o+e<=-1||this.moduleCount<=o+e))for(var r=-1;r<=7;r++)t+r<=-1||this.moduleCount<=t+r||(this.modules[o+e][t+r]=e>=0&&e<=6&&(0==r||6==r)||r>=0&&r<=6&&(0==e||6==e)||e>=2&&e<=4&&r>=2&&r<=4)},getBestMaskPattern:function(){for(var o=0,t=0,e=0;e<8;e++){this.makeImpl(!0,e);var r=h.getLostPoint(this);(0==e||o>r)&&(o=r,t=e)}return t},createMovieClip:function(o,t,e){var r=o.createEmptyMovieClip(t,e),n=1;this.make();for(var i=0;i<this.modules.length;i++)for(var u=1;i<this.modules.length;i++){var s=this.modules[i][u];s&&(r.beginFill(0,100),r.moveTo(u*n,i*n),r.lineTo((u+1)*n,i*n),r.lineTo((u+1)*n,(i+1)*n),r.lineTo(u*n,(i+1)*n),r.endFill())}return r},setupTimingPattern:function(){for(var o=8;o<this.moduleCount-8;o++)null==this.modules[o][6]&&(this.modules[o][6]=o%2==0),null==this.modules[6][o]&&(this.modules[6][o]=o%2==0)},setupPositionAdjustPattern:function(){for(var o=h.getPatternPosition(this.typeNumber),t=0;t<o.length;t++)for(var e=0;e<o.length;e++){var r=o[t],n=o[e];if(null==this.modules[r][n])for(var i=-2;i<=2;i++)for(var u=-2;u<=2;u++)this.modules[r+i][n+u]=i==-2||2==i||u==-2||2==u||0==i&&0==u}},setupTypeNumber:function(o){for(var t=h.getBCHTypeNumber(this.typeNumber),e=0;e<18;e++){var r=!o&&1==(t>>e&1);this.modules[Math.floor(e/3)][e%3+this.moduleCount-8-3]=r}for(e=0;e<18;e++){r=!o&&1==(t>>e&1);this.modules[e%3+this.moduleCount-8-3][Math.floor(e/3)]=r}},setupTypeInfo:function(o,t){for(var e=h.getBCHTypeInfo(this.errorCorrectLevel<<3|t),r=0;r<15;r++){var n=!o&&1==(e>>r&1);r<6?this.modules[r][8]=n:r<8?this.modules[r+1][8]=n:this.modules[this.moduleCount-15+r][8]=n}for(r=0;r<15;r++){n=!o&&1==(e>>r&1);r<8?this.modules[8][this.moduleCount-r-1]=n:r<9?this.modules[8][15-r-1+1]=n:this.modules[8][15-r-1]=n}this.modules[this.moduleCount-8][8]=!o},mapData:function(o,t){for(var e=-1,r=this.moduleCount-1,n=7,i=0,u=this.moduleCount-1;u>0;u-=2)for(6==u&&u--;;){for(var s=0;s<2;s++)if(null==this.modules[r][u-s]){var a=!1;i<o.length&&(a=1==(o[i]>>>n&1)),h.getMask(t,r,u-s)&&(a=!a),this.modules[r][u-s]=a,n--,-1==n&&(i++,n=7)}if((r+=e)<0||this.moduleCount<=r){r-=e,e=-e;break}}}},e.PAD0=236,e.PAD1=17,e.createData=function(o,t,r){for(var u=new c(t),s=l.getRSBlocks(o,u),a=new i,f=0;f<r.length;f++){var d=r[f];a.put(4,4),a.put(d.getLength(),h.getLengthInBits(d.mode,o)),d.write(a)}for(var p=0,f=0;f<s.length;f++)p+=s[f].dataCount;if(a.getLengthInBits()>8*p)throw new Error("code length overflow. ("+a.getLengthInBits()+">"+8*p+")");for(a.getLengthInBits()+4<=8*p&&a.put(0,4);a.getLengthInBits()%8!=0;)a.putBit(!1);for(var g=0;a.getLengthInBits()<8*p;)a.put((g%2==0?e.PAD0:e.PAD1),8),g++;return e.createBytes(a,s)},e.createBytes=function(o,t){for(var e=0,r=0,n=0,i=new Array(t.length),u=new Array(t.length),s=0;s<t.length;s++){var a=t[s].dataCount,f=t[s].totalCount-a;r=Math.max(r,a),n=Math.max(n,f),i[s]=new Array(a);for(var d=0;d<i[s].length;d++)i[s][d]=255&o.buffer[d+e];e+=a;var p=l.getErrorCorrectPolynomial(f),g=new r_(i[s],p.getLength()-1),m=g.mod(p);u[s]=new Array(p.getLength()-1);for(d=0;d<u[s].length;d++){var v=d+m.getLength()-u[s].length;u[s][d]=v>=0?m.get(v):0}}for(var y=0,b=0;b<t.length;b++)y+=t[b].totalCount;for(var w=new Array(y),S=0,d=0;d<r;d++)for(s=0;s<t.length;s++)d<i[s].length&&(w[S++]=i[s][d]);for(d=0;d<n;d++)for(s=0;s<t.length;s++)d<u[s].length&&(w[S++]=u[s][d]);return w};for(var c=function(o){switch(o){case d.L:return 1;case d.M:return 0;case d.Q:return 3;case d.H:return 2;default:throw new Error("bad eclevel")}},l={getRSBlocks:function(o,t){var e=l.getRsBlockTable(o,t);if(void 0==e)throw new Error("bad rs block @ typeNumber:"+o+"/errorCorrectLevel:"+t);for(var r=e.length/3,n=[],i=0;i<r;i++)for(var u=e[3*i+0],s=e[3*i+1],a=e[3*i+2],f=0;f<u;f++)n.push(new n(s,a));return n},getRsBlockTable:function(o,t){switch(t){case d.L:return p[4*(o-1)+0];case d.M:return p[4*(o-1)+1];case d.Q:return p[4*(o-1)+2];case d.H:return p[4*(o-1)+3];default:return void 0}}},p=[[],[1,26,19,1,26,16,1,26,13,1,26,9],[1,44,34,1,44,28,1,44,22,1,44,16],[1,70,55,1,70,44,2,35,17,2,35,13],[1,100,80,2,50,32,2,50,24,4,25,9],[1,134,108,2,67,43,2,33,15,2,33,11],[2,86,68,4,43,27,4,43,19,4,43,15],[2,98,78,4,49,31,2,32,14,4,39,13],[2,121,97,2,60,38,4,40,18,4,40,14],[2,146,116,3,58,36,4,36,16,4,36,12],[2,86,68,4,69,43,6,43,19,6,43,15],[4,101,81,1,80,50,4,50,22,3,36,12],[2,116,92,6,58,36,4,46,20,7,42,14],[4,133,107,8,59,37,8,44,20,12,33,11],[3,145,115,4,64,40,11,36,16,11,36,12],[5,109,87,5,65,41,5,54,24,11,36,12],[5,122,98,7,73,45,15,43,19,3,45,15],[1,135,107,10,74,46,1,50,22,2,42,14],[5,150,120,9,69,43,17,50,22,2,42,14],[3,141,113,3,70,44,17,47,21,9,39,13],[3,135,107,3,67,41,15,54,24,15,43,12],[4,144,116,3,68,42,17,50,22,17,46,12]],d={L:1,M:0,Q:3,H:2},h={PATTERN_POSITION_TABLE:[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54],[6,32,58],[6,34,62],[6,26,46,66],[6,26,48,70],[6,26,50,74],[6,30,54,78],[6,30,56,82],[6,30,58,86],[6,30,60,90],[6,34,62,90],[6,28,50,72],[6,26,50,74],[6,30,54,78],[6,28,54,80],[6,32,58,84],[6,30,58,86],[6,34,62,90],[6,26,50,74],[6,30,54,78],[6,26,50,74],[6,30,54,78],[6,34,62,90]],G15:1335,G18:7973,G15_MASK:21522,getBCHDigit:function(o){for(var t=0;0!=o;)t++,o>>>=1;return t},getBCHTypeInfo:function(o){for(var t=o<<10;h.getBCHDigit(t)-h.getBCHDigit(h.G15)>=0;)t^=h.G15<<h.getBCHDigit(t)-h.getBCHDigit(h.G15);return(o<<10|t)^h.G15_MASK},getBCHTypeNumber:function(o){for(var t=o<<12;h.getBCHDigit(t)-h.getBCHDigit(h.G18)>=0;)t^=h.G18<<h.getBCHDigit(t)-h.getBCHDigit(h.G18);return o<<12|t},getPatternPosition:function(o){return h.PATTERN_POSITION_TABLE[o-1]},getMask:function(o,t,e){switch(o){case 0:return(t+e)%2==0;case 1:return t%2==0;case 2:return e%3==0;case 3:return(t+e)%3==0;case 4:return(Math.floor(t/2)+Math.floor(e/3))%2==0;case 5:return t*e%2+t*e%3==0;case 6:return(t*e%2+t*e%3)%2==0;case 7:return(t*e%3+t+e)%2==0;default:throw new Error("bad maskPattern:"+o)}},getErrorCorrectPolynomial:function(o){for(var t=new r([1],0),e=0;e<o;e++)t=t.multiply(new r([1,m.gexp(e)],0));return t},getLengthInBits:function(o,t){if(1<=t&&t<10)switch(o){case 1:return 10;case 2:return 9;case 4:return 8;case 8:return 8;default:throw new Error("mode:"+o)}else if(t<27)switch(o){case 1:return 12;case 2:return 11;case 4:return 16;case 8:return 16;default:throw new Error("mode:"+o)}else{if(!(t<41))throw new Error("type:"+t);switch(o){case 1:return 14;case 2:return 13;case 4:return 16;case 8:return 16;default:throw new Error("mode:"+o)}},getLostPoint:function(o){for(var t=o.getModuleCount(),e=0,r=0;r<t;r++)for(var n=0;n<t;n++){for(var i=0,u=o.isDark(r,n),s=-1;s<=1;s++)if(!(r+s<0||t<=r+s))for(var a=-1;a<=1;a++)n+a<0||t<=n+a||0==s&&0==a||u==o.isDark(r+s,n+a)&&e++;e>5&&(e+=3)}for(r=0;r<t-1;r++)for(n=0;n<t-1;n++){var f=0;o.isDark(r,n)&&f++,o.isDark(r+1,n)&&f++,o.isDark(r,n+1)&&f++,o.isDark(r+1,n+1)&&f++,(0==f||4==f)&&(e+=3)}for(r=0;r<t;r++)for(n=0;n<t-6;n++)o.isDark(r,n)&&!o.isDark(r,n+1)&&o.isDark(r,n+2)&&o.isDark(r,n+3)&&o.isDark(r,n+4)&&!o.isDark(r,n+5)&&o.isDark(r,n+6)&&(e+=40);for(n=0;n<t;n++)for(r=0;r<t-6;r++)o.isDark(r,n)&&!o.isDark(r+1,n)&&o.isDark(r+2,n)&&o.isDark(r+3,n)&&o.isDark(r+4,n)&&!o.isDark(r+5,n)&&o.isDark(r+6,n)&&(e+=40);var d=0;for(n=0;n<t;n++)for(r=0;r<t;r++)o.isDark(r,n)&&d++;return e+10*Math.abs(100*d/t/t-50)/5}},m={glog:function(o){if(o<1)throw new Error("glog("+o+")");return m.LOG_TABLE[o]},gexp:function(o){for(;o<0;)o+=255;for(;o>=256;)o-=255;return m.EXP_TABLE[o]},EXP_TABLE:new Array(256),LOG_TABLE:new Array(256)};for(var v=0;v<8;v++)m.EXP_TABLE[v]=1<<v;for(v=8;v<256;v++)m.EXP_TABLE[v]=m.EXP_TABLE[v-4]^m.EXP_TABLE[v-5]^m.EXP_TABLE[v-6]^m.EXP_TABLE[v-8];for(v=0;v<255;v++)m.LOG_TABLE[m.EXP_TABLE[v]]=v;r.prototype={get:function(o){return this.num[o]},getLength:function(){return this.num.length},multiply:function(o){for(var t=new Array(this.getLength()+o.getLength()-1),e=0;e<this.getLength();e++)for(var r=0;r<o.getLength();r++)t[e+r]^=m.gexp(m.glog(this.get(e))+m.glog(o.get(r)));return new r(t,0)},mod:function(o){if(this.getLength()-o.getLength()<0)return this;for(var t=m.glog(this.get(0))-m.glog(o.get(0)),e=new Array(this.getLength()),n=0;n<this.getLength();n++)e[n]=this.get(n);for(n=0;n<o.getLength();n++)e[n]^=m.gexp(m.glog(o.get(n))+t);return new r(e,0).mod(o)}},n.prototype={},i.prototype={get:function(o){return 1==(this.buffer[o>>3]>>>7-o%8&1)},put:function(o,t){for(var e=0;e<t;e++)this.putBit(1==(o>>>t-e-1&1))},getLengthInBits:function(){return this.length},putBit:function(o){var t=this.length>>3;this.buffer.length<=t&&this.buffer.push(0),o&&(this.buffer[t]|=128>>>this.length%8),this.length++}},a.prototype.draw=function(o){var t=this._el,e=this._htOption,r=this._oQRCode,n=this._htOption._tempCanvas;this.clear(),n||(n=document.createElement("canvas"),n.width=e.width,n.height=e.height,this._htOption._tempCanvas=n),n.getContext("2d").fillStyle="#fff",n.getContext("2d").fillRect(0,0,e.width,e.height);var i=e.width/r.getModuleCount(),u=e.height/r.getModuleCount(),s=Math.round(i),a=Math.round(u);t.style.position="relative",t.style.width=e.width+"px",t.style.height=e.height+"px",t.style.padding="0",t.style.margin="0";for(var f=0;f<r.getModuleCount();f++)for(var d=0;d<r.getModuleCount();d++)n.getContext("2d").fillStyle=r.isDark(f,d)?"#000":"#fff",n.getContext("2d").fillRect(d*i,f*u,s,a);t.appendChild(n)},a.prototype.makeImage=function(){if(this._htOption._tempCanvas){var o=this._htOption._tempCanvas.toDataURL("image/png");this._el.innerHTML="<img src='"+o+"' alt='QR Code'/>"}},a.prototype.clear=function(){this._el.innerHTML=""},a.prototype.makeCode=function(o){this._oQRCode=new e(this._htOption.typeNumber,this._htOption.correctLevel),this._oQRCode.addData(o),this._oQRCode.make(),this.draw(o),this.makeImage()},window.QRCode=function(o,t){if(this._htOption={width:256,height:256,typeNumber:4,colorDark:"#000000",colorLight:"#ffffff",correctLevel:d.M,margin:2},void 0!==t)for(var e in t)this._htOption[e]=t[e];"string"==typeof o&&(o=document.querySelector(o)),this._el=o,this._oQRCode=null,this.makeCode(this._htOption.text||"")},QRCode.CorrectLevel=d;
  </script>
</body>
</html>
