<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista • View Tractors</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>

  <!-- Theme + base app styles -->
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <!-- Ensure fv-shell -->
  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true; document.head.appendChild(s);
      }
    })();
  </script>

  <style>
    :root{ --brand:var(--green,#3B7E46); --card-max:1200px; }
    body{ background:var(--app-bg,var(--surface)); }
    .wrap{ max-width:var(--card-max); margin:0 auto; padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + 80px)!important; }

    header.page{margin:8px 0 14px;}
    header.page h1{margin:0 0 6px 0; font-size:clamp(22px,3.5vw,28px)}
    header.page p{margin:0; color:var(--muted,#67706B)}

    .toolbar{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin:10px 0 14px}
    .input,.select{ font:inherit; font-size:16px; color:var(--text);
      background:var(--card-surface,var(--surface)); border:1px solid var(--border); border-radius:10px; padding:10px 12px; }
    .toolbar .input{ min-width:240px; } .toolbar .select{ min-width:160px; }

    .list{ border:1px solid var(--border); border-radius:14px; overflow:hidden; background:var(--surface); }
    .thead,.row{ display:grid; grid-template-columns: 56px 1.4fr 1fr 0.8fr 0.9fr 140px; gap:10px; align-items:center; }
    .thead{ padding:10px 12px; font-weight:800; background:color-mix(in srgb, var(--brand) 10%, transparent); }
    .row{ padding:10px 12px; border-top:1px solid var(--border); cursor:pointer }
    .row:hover{ background:color-mix(in srgb, var(--brand) 6%, transparent); }
    .status{ font-size:12px; border:1px solid var(--border); border-radius:999px; padding:2px 8px; }

    @media (max-width:960px){ .thead,.row{ grid-template-columns: 48px 1.6fr 1fr 1fr 140px; } .col-hours{ display:none } }
    @media (max-width:720px){ .thead{ display:none } .row{ grid-template-columns: 1fr; gap:2px } }

    .btn{ display:inline-flex; align-items:center; justify-content:center; padding:10px 14px; border-radius:12px; border:1px solid var(--border); background:var(--card-surface,var(--surface)); font-weight:800; color:var(--text)!important; cursor:pointer }
    .btn-primary{ border-color:transparent; background:var(--brand); color:#fff!important }

    /* Centered modal (robust) */
    dialog{ border:none; border-radius:14px; padding:0; width:min(720px, 94vw); max-height:90vh;
            box-shadow:0 18px 60px rgba(0,0,0,.35) }
    dialog::backdrop{ background:rgba(0,0,0,.38) }
    .dw{ display:grid; gap:0; background:var(--surface); border:1px solid var(--border); border-radius:14px; overflow:hidden; height:100% }
    .dw-head{ display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--border); background:color-mix(in srgb, var(--brand) 10%, transparent) }
    .dw-body{ padding:16px; display:grid; gap:12px; overflow:auto }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px } @media (max-width:640px){ .grid2{ grid-template-columns:1fr } }
    .input,.select,.textarea{ width:100%; font:inherit; font-size:16px; color:var(--text); background:var(--card-surface,var(--surface)); border:1px solid var(--border); border-radius:10px; padding:10px 12px; }
    .textarea{ min-height:110px; resize:vertical }

    .qr-box{ border:1px dashed var(--border); border-radius:12px; padding:12px; display:grid; gap:10px; }
    .qr-line{ display:flex; gap:14px; align-items:center; flex-wrap:wrap }
    .qr-img{ width:256px; height:256px; background:#fff; border:1px solid var(--border); border-radius:8px; display:grid; place-items:center; overflow:hidden }
    .qr-meta code{ font-size:12px; background:rgba(0,0,0,.06); padding:3px 6px; border-radius:6px; color:var(--text) }

    @media print{
      header.page, .toolbar, .list, header.app, footer.app, dialog .dw-head, dialog .btn{ display:none !important }
      .print-sheet{ display:block !important; }
    }
    .print-sheet{ display:none; text-align:center; padding:24px }
    .qr-big{ width:640px; height:640px; margin:12px auto; border:1px solid var(--border); border-radius:16px; display:grid; place-items:center; background:#fff; }
  </style>
</head>
<body>
  <fv-shell>
    <div class="wrap">
      <header class="page">
        <h1>View Tractors</h1>
        <p class="muted">Search and filter tractors. Tap a row to view details, edit, or reprint the QR.</p>
      </header>

      <div class="toolbar">
        <input id="search" class="input" placeholder="Search make, model, year, serial…">
        <select id="filter" class="select">
          <option value="active">Active</option>
          <option value="archived">Archived</option>
          <option value="all">All</option>
        </select>
        <select id="sort" class="select">
          <option value="name">Name (A→Z)</option>
          <option value="year">Year (new→old)</option>
          <option value="hours">Hours (high→low)</option>
          <option value="created">Recently added</option>
        </select>
        <a class="btn" href="/Farm-vista/pages/equipment/actions/add.html?type=tractor">Add Tractor</a>
      </div>

      <div class="list">
        <div class="thead">
          <div>#</div><div>Name</div><div>Make / Model</div><div class="col-hours">Hours</div><div>Status</div><div>Added</div>
        </div>
        <div id="rows"></div>
      </div>
    </div>
  </fv-shell>

  <!-- Centered modal -->
  <dialog id="drawer">
    <div class="dw">
      <div class="dw-head">
        <strong id="dwTitle">Unit</strong>
        <div style="display:flex;gap:8px">
          <button id="btnClose" class="btn">Close</button>
          <button id="btnSave" class="btn btn-primary">Save</button>
        </div>
      </div>
      <div class="dw-body">
        <div class="grid2">
          <div><label>Make</label><input id="dwMake" class="input" placeholder="Make"></div>
          <div><label>Model</label><input id="dwModel" class="input" placeholder="Model"></div>
        </div>
        <div class="grid2">
          <div><label>Year</label><select id="dwYear" class="select"></select></div>
          <div><label>Serial #</label><input id="dwSerial" class="input" placeholder="Serial (optional)"></div>
        </div>
        <div class="grid2">
          <div><label>Engine Hours</label><input id="dwHours" type="number" step="0.1" class="input" placeholder="e.g., 1250.5"></div>
          <div><label>Status</label><select id="dwStatus" class="select"><option value="active">Active</option><option value="archived">Archived</option></select></div>
        </div>
        <div><label>Notes</label><textarea id="dwNotes" class="textarea" placeholder="Optional details"></textarea></div>

        <div class="qr-box">
          <div class="qr-line">
            <div class="qr-img"><div id="qrSmall" style="width:256px;height:256px"></div></div>
            <div class="qr-meta">
              <div><strong>Deep link:</strong> <code id="qrUrl">—</code></div>
              <div id="qrWarn" class="status" style="margin-top:6px" hidden>QR missing — create from Add page</div>
              <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap">
                <button id="btnReprint" class="btn">Reprint QR</button>
                <a id="btnOpenHub" class="btn" target="_blank" rel="noopener">Open Hub</a>
              </div>
            </div>
          </div>
          <div class="print-sheet">
            <h2 id="psTitle">Equipment QR</h2>
            <div class="qr-big"><div id="qrBig" style="width:640px;height:640px"></div></div>
            <div id="psMeta"></div>
          </div>
        </div>
      </div>
    </div>
  </dialog>

  <!-- qrcode.js trimmed (quiet zone included) -->
  <script>
  /*! qrcode.js trimmed */
  !function(o){function p(a,b){this._oQRCode=null,this._el=a,this._htOption={width:b.width,height:b.height,text:b.text,correctLevel:b.correctLevel||h.M,colorDark:b.colorDark||"#000000",colorLight:b.colorLight||"#ffffff"};this._el&&this.makeCode(this._htOption.text)}function h(){}h.L=1;h.M=0;h.Q=3;h.H=2;p.prototype.makeCode=function(a){this._htOption.text=a;this._oQRCode=new r(this._htOption.text,this._htOption.correctLevel);this._el.innerHTML="";this._el.appendChild(this.createImgTag())};p.prototype.clear=function(){this._el.innerHTML=""};p.prototype.createImgTag=function(){var a=this._oQRCode,b=this._htOption,c=document.createElement("canvas"),d=b.width,e=b.height;c.width=d;c.height=e;for(var f=c.getContext("2d"),g=d/(a.getModuleCount()+8),k=e/(a.getModuleCount()+8),l=4,m=0;m<e;m++)for(var t=0;t<d;t++)f.fillStyle=b.colorLight,f.fillRect(t,m,1,1);for(m=0;m<a.getModuleCount();m++)for(t=0;t<a.getModuleCount();t++)a.isDark(m,t)&&(f.fillStyle=b.colorDark,f.fillRect(Math.round(t*g)+l,Math.round(m*k)+l,Math.ceil(g),Math.ceil(k)));var u=document.createElement("img");u.src=c.toDataURL("image/png");u.width=d;u.height=e;return u};function r(a,b){this.typeNumber=4;this.errorCorrectLevel=b;this.modules=null;this.moduleCount=0;this.dataList=[];this.addData(a);this.make()}r.prototype.addData=function(a){this.dataList.push(new v(a))};r.prototype.make=function(){this.moduleCount=33;this.modules=new Array(this.moduleCount);for(var a=0;a<this.moduleCount;a++){this.modules[a]=new Array(this.moduleCount);for(var b=0;b<this.moduleCount;b++)this.modules[a][b]=null}w(this,0,0);w(this,this.moduleCount-7,0);w(this,0,this.moduleCount-7);x(this);y(this);this.mapData(z(this),0)};r.prototype.isDark=function(a,b){return this.modules[a][b]};r.prototype.getModuleCount=function(){return this.moduleCount};r.prototype.mapData=function(a){for(var b=-1,c=this.moduleCount-1,d=7,e=0,f=this.moduleCount-1;0<f;f-=2){6==f&&f--;for(;;){for(var g=0;2>g;g++)null==this.modules[c][f-g]&&(e<a.length?(this.modules[c][f-g]=1==(a[e]>>>d&1),d--,-1==d&&(e++,d=7)):this.modules[c][f-g]=!1);if(c+=b,0>c||this.moduleCount<=c){c-=b;b=-b;break}}}};function v(a){this.data=a}v.prototype.getLength=function(){return this.data.length};v.prototype.write=function(a){for(var b=0;b<this.data.length;b++){var c=this.data.charCodeAt(b);128>c?a.put(c,8):(2048>c?a.put(192|c>>6,8):(a.put(224|c>>12,8),a.put(128|c>>6&63,8)),a.put(128|c&63,8))}};function z(a){var b=new A;b.put(4,4);b.put(a.dataList[0].getLength(),8);a.dataList[0].write(b);for(var c=0,d=b.getLengthInBits()%8;8!=d;)b.put(0,1),d=b.getLengthInBits()%8;for(;b.getLengthInBits()<=8*19;)b.put(236,8),b.getLengthInBits()<=8*19&&b.put(17,8);return B(b,19)}function A(){this.buffer=[];this.length=0}A.prototype.getLengthInBits=function(){return this.length};A.prototype.put=function(a,b){for(var c=0;c<b;c++)this.buffer[this.length>>3]|=(a>>>b-c-1&1)?128>>>this.length%8:0,this.length++};function B(a,b){for(var c=Array(b),d=0;d<b;d++)c[d]=0;for(d=0;d<a.getLengthInBits();d++)c[d>>3]|=(a.getBuffer()[d>>3]>>>7-d%8&1)<<7-d%8;return c}function w(a,b,c){for(var d=-1;7>=d;d++)if(0<=b+d&&b+d<a.moduleCount)for(var e=-1;7>=e;e++)0<=c+e&&c+e<a.moduleCount&&(a.modules[b+d][c+e]=0<=d&&d<=6&&(0==e||6==e)||0<=e&&e<=6&&(0==d||6==d)||2<=d&&d<=4&&2<=e&&e<=4?!0:!1)}function x(a){for(var b=8;b<a.moduleCount-8;b++)null==a.modules[b][6]&&(a.modules[b][6]=0==b%2),null==a.modules[6][b]&&(a.modules[6][b]=0==b%2)}function y(a){for(var b=0;b<a.moduleCount;b++)for(var c=0;c<a.moduleCount;c++)null==a.modules[b][c]&&(a.modules[b][c]=!1)}window.QRCode=p;window.QRCode.CorrectLevel=h}(window);
  </script>

  <script type="module">
    import {
      ready,
      getFirestore, collection, getDocs, query, where, orderBy, doc, getDoc, updateDoc, serverTimestamp
    } from '/Farm-vista/js/firebase-init.js';

    const $ = id => document.getElementById(id);
    const fmtDate = ts => ts?.toDate ? new Date(ts.toDate()).toLocaleDateString() : (ts ? new Date(ts).toLocaleDateString() : "—");
    function buildYearOptions(sel){
      sel.innerHTML = '<option value="">—</option>';
      const now = new Date().getFullYear();
      for(let y=now;y>=1980;y--){ const o=document.createElement('option'); o.value=String(y); o.textContent=String(y); sel.appendChild(o); }
    }

    let DB, tractors=[], currentId=null;
    let isOpening = false; // mutex for dialog open

    function drawQR(el, text, size){
      const box = document.getElementById(el);
      box.innerHTML="";
      new window.QRCode(box,{
        text, width:size, height:size, colorDark:"#000000", colorLight:"#ffffff",
        correctLevel: window.QRCode.CorrectLevel.M
      });
    }

    async function loadList(){
      const rows = $("rows"); rows.innerHTML = "";
      try{
        const f = $("filter").value;
        const base = collection(DB,'equipment');
        let qy;
        if(f==='active')   qy = query(base, where('type','==','tractor'), where('status','==','active'),   orderBy('name'));
        else if(f==='archived') qy = query(base, where('type','==','tractor'), where('status','==','archived'), orderBy('name'));
        else qy = query(base, where('type','==','tractor'), orderBy('name'));
        const snap = await getDocs(qy);
        tractors = []; snap.forEach(d=> tractors.push({ id:d.id, ...d.data() }));
      }catch{
        const all = await getDocs(query(collection(DB,'equipment'), where('type','==','tractor')));
        const temp=[]; all.forEach(d=> temp.push({ id:d.id, ...d.data() }));
        temp.sort((a,b)=>String(a.name||"").localeCompare(String(b.name||"")));
        tractors=temp;
      }
      renderList();
    }

    function applySearchSort(items){
      const q = $("search").value.trim().toLowerCase();
      let out = items.filter(x=>{
        if($("filter").value==='active'   && x.status!=='active') return false;
        if($("filter").value==='archived' && x.status!=='archived') return false;
        if(!q) return true;
        const hay=[x.name,x.makeName,x.modelName,x.year,x.serial,x.engineHours].map(v=>String(v||"").toLowerCase()).join(" ");
        return hay.includes(q);
      });
      const sort = $("sort").value;
      if(sort==='name') out.sort((a,b)=>String(a.name||"").localeCompare(String(b.name||"")));
      else if(sort==='year') out.sort((a,b)=>(b.year||0)-(a.year||0));
      else if(sort==='hours') out.sort((a,b)=>(Number(b.engineHours||0)-Number(a.engineHours||0)));
      else if(sort==='created') out.sort((a,b)=>((b.createdAt?.seconds||0)-(a.createdAt?.seconds||0)));
      return out;
    }

    function renderList(){
      const rows = $("rows"); rows.innerHTML="";
      const data = applySearchSort(tractors);
      let i=0;
      for(const x of data){
        const row=document.createElement('div'); row.className='row'; row.dataset.id=x.id;
        const name = x.name || [x.makeName,x.modelName].filter(Boolean).join(' ');
        const makeModel = [x.makeName,x.modelName].filter(Boolean).join(' ');
        row.innerHTML = `
          <div>${++i}</div>
          <div>${name||'—'}</div>
          <div>${makeModel||'—'}${x.year?` • ${x.year}`:''}</div>
          <div class="col-hours">${x.engineHours!=null? x.engineHours : '—'}</div>
          <div><span class="status">${x.status||'active'}</span></div>
          <div>${fmtDate(x.createdAt)}</div>
        `;
        row.addEventListener('click', ()=> openModal(x.id), { passive:true });
        rows.appendChild(row);
      }
    }

    function yearOptions(sel, value){ buildYearOptions(sel); if(value) sel.value=String(value); }

    // Safe dialog open (handles “already open” & races)
    async function safeOpenDialog(dlg){
      if(isOpening) return;
      isOpening = true;
      try{
        if(dlg.open){
          dlg.close();
          // wait two frames to ensure backdrop teardown completes
          await new Promise(r=>requestAnimationFrame(()=>requestAnimationFrame(r)));
        }
        dlg.showModal();
      }catch(err){
        console.warn('Dialog open retry:', err?.message||err);
        // one more attempt after a frame
        await new Promise(r=>requestAnimationFrame(r));
        try{ if(!dlg.open) dlg.showModal(); }catch(e){ console.error('Dialog failed to open:', e); }
      }finally{
        isOpening = false;
      }
    }

    async function openModal(id){
      const dlg=$("drawer");
      currentId = id;

      const snap = await getDoc(doc(DB,'equipment', id));
      if(!snap.exists()) return;
      const d = snap.data()||{};
      const name = d.name || [d.makeName,d.modelName].filter(Boolean).join(' ');

      $("dwTitle").textContent = name || `Unit ${id.slice(0,6)}`;
      $("dwMake").value  = d.makeName || '';
      $("dwModel").value = d.modelName || '';
      yearOptions($("dwYear"), d.year||'');
      $("dwSerial").value = d.serial || '';
      $("dwHours").value  = (d.engineHours!=null)? d.engineHours : '';
      $("dwStatus").value = d.status || 'active';
      $("dwNotes").value  = d.notes || '';

      if(d.qr?.url){
        $("qrUrl").textContent = d.qr.url;
        $("qrWarn").hidden = true;
        drawQR("qrSmall", d.qr.url, 256);
        drawQR("qrBig"  , d.qr.url, 640);
        $("btnOpenHub").href = d.qr.url;
      }else{
        $("qrUrl").textContent = "—";
        $("qrWarn").hidden = false;
        document.getElementById("qrSmall").innerHTML="";
        document.getElementById("qrBig").innerHTML="";
        $("btnOpenHub").removeAttribute('href');
      }

      await safeOpenDialog(dlg);
    }

    async function saveModal(){
      if(!currentId) return;
      const ref = doc(DB,'equipment', currentId);
      const patch = {
        makeName: $("dwMake").value.trim() || null,
        modelName: $("dwModel").value.trim() || null,
        year: $("dwYear").value ? Number($("dwYear").value) : null,
        serial: $("dwSerial").value.trim() || null,
        engineHours: $("dwHours").value ? Number($("dwHours").value) : null,
        status: $("dwStatus").value || 'active',
        notes: $("dwNotes").value.trim() || null,
        updatedAt: serverTimestamp()
      };
      const nm = [patch.makeName, patch.modelName].filter(Boolean).join(' ');
      patch.name = nm ? (patch.year ? `${nm} (${patch.year})` : nm) : null;
      await updateDoc(ref, patch);

      const idx = tractors.findIndex(x=>x.id===currentId);
      if(idx>-1){ tractors[idx] = { ...tractors[idx], ...patch }; }
      renderList();
    }

    function closeModal(){
      const dlg=$("drawer");
      if(dlg.open) dlg.close();
      currentId=null;
    }
    function reprintQR(){ window.print(); }

    (async()=>{
      await ready; DB = getFirestore();
      buildYearOptions($("dwYear"));
      await loadList();

      $("search").addEventListener('input', renderList);
      $("filter").addEventListener('change', loadList);
      $("sort").addEventListener('change', renderList);

      // Modal controls
      $("btnClose").addEventListener('click', closeModal);
      $("btnSave").addEventListener('click', async ()=>{ await saveModal(); closeModal(); });

      // Close on backdrop click and ESC
      const dlg = $("drawer");
      dlg.addEventListener('click', (e)=>{ if(e.target === dlg) closeModal(); });
      dlg.addEventListener('cancel', (e)=>{ e.preventDefault(); closeModal(); });

      $("btnReprint").addEventListener('click', reprintQR);
      $("btnOpenHub").addEventListener('click', (e)=>{ if(!e.currentTarget.href) e.preventDefault(); });
    })();
  </script>
</body>
</html>
