<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista • Tractors</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>
  <script defer src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <!-- Ensure fv-shell -->
  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js'; s.defer=true; document.head.appendChild(s);
      }
    })();
  </script>

  <!-- Firebase CONFIG FIRST -->
  <script src="/Farm-vista/js/firebase-config.js"></script>

  <style>
    :root{ --card-max:1100px; }
    html,body{ max-width:100vw; overflow-x:hidden; }
    body{ background:var(--app-bg, var(--bg)); color:var(--text); }

    .page{
      max-width:var(--card-max); margin:0 auto; padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + 96px)!important;
    }
    .title{ margin:0 0 4px; font-size:clamp(22px,3.6vw,32px); line-height:1.1; }
    .sub{ margin:0 0 18px; color:var(--muted,#6f7772); }

    /* Search */
    .search{
      display:flex; align-items:center; gap:10px; border:1px solid var(--border);
      border-radius:12px; background:var(--surface); padding:10px 12px;
    }
    .search input{ flex:1; background:transparent; border:0; outline:none; font:inherit; color:var(--text); }

    .count{ margin:10px 0; color:var(--muted,#6f7772); font-weight:700; }

    /* Cards (minimal: make, model, #last6 only) */
    .group{ margin:14px 0; }
    .group h3{ margin:0 0 8px; color:var(--muted); font-weight:800; letter-spacing:.02em; }
    .card{
      border:1px solid var(--border);
      border-radius:16px;
      background:var(--surface);
      color:var(--text);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));
      padding:14px 16px; display:flex; align-items:center; justify-content:space-between;
      cursor:pointer;
    }
    .card:hover{ transform:translateY(-1px); box-shadow:0 12px 28px rgba(0,0,0,.12); }
    .card-title{ font-weight:800; font-size:16px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    /* Detail modal — dark theme compliant */
    dialog.sheet{
      width:min(740px, 92vw);
      border:1px solid var(--border);
      border-radius:16px;
      padding:0;
      background:var(--card-surface, var(--surface));
      color:var(--text);
      box-shadow:0 18px 40px rgba(0,0,0,.45);
    }
    .sheet::backdrop{ background:rgba(0,0,0,.55); }
    .sheet header{
      padding:14px 16px; border-bottom:1px solid var(--border);
      display:flex; justify-content:space-between; align-items:center;
      background:var(--card-surface, var(--surface));
      color:var(--text);
    }
    .sheet .body{
      padding:14px 16px; max-height:70vh; overflow-y:auto; overflow-x:hidden; -webkit-overflow-scrolling:touch;
      background:var(--card-surface, var(--surface));
    }
    .kv{ display:grid; grid-template-columns:180px 1fr; gap:8px 12px; }
    @media(max-width:700px){ .kv{ grid-template-columns:1fr } .kv div{ padding:2px 0 } }
    .k{ font-weight:800; color:var(--brand-green,#3B7E46); }
    .v{ color:var(--text); }

    /* QR preview block (panel dark; QR stays white for scan reliability) */
    .qrbox{
      margin-top:14px; padding:14px; border:1px solid var(--border); border-radius:12px;
      display:grid; place-items:center; gap:10px; background:var(--surface);
    }
    .qrbox h4{ margin:0; font-size:16px; color:var(--text); }
    .qrbox img{
      display:block; width:min(220px, 70%); height:auto; image-rendering:crisp-edges; border-radius:8px;
      border:1px solid var(--border); background:#fff; /* keep QR white */
    }
    .qrnote{ margin:0; color:var(--muted); font-size:13px; }

    .sheet footer{
      padding:12px 16px; border-top:1px solid var(--border);
      display:flex; justify-content:flex-end; gap:8px;
      background:var(--card-surface, var(--surface)); color:var(--text);
    }
    .btn{
      display:inline-flex; align-items:center; gap:8px; border:1px solid var(--border); border-radius:12px;
      background:var(--surface); color:var(--text); padding:10px 14px; font-weight:800; cursor:pointer; text-decoration:none;
    }
    .btn[disabled]{ opacity:.55; pointer-events:none; }
    .btn-primary{ border-color:transparent; background:var(--brand-green,#3B7E46); color:#fff; }
  </style>
</head>
<body>
  <fv-shell>
    <div class="page">
      <h1 class="title">Tractors</h1>
      <p class="sub">Active tractors only. Search by make, model, serial, or year.</p>

      <!-- Search -->
      <div class="search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M21 21l-4.2-4.2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"/></svg>
        <input id="q" type="search" placeholder="Search" autocomplete="off"/>
      </div>

      <p id="count" class="count">0 entries</p>
      <div id="list"></div>
    </div>
  </fv-shell>

  <!-- Detail modal (read-only) -->
  <dialog id="detail" class="sheet" aria-modal="true">
    <header>
      <strong id="dTitle">Details</strong>
      <button id="dClose" class="btn" type="button">Close</button>
    </header>
    <div class="body">
      <div class="kv" id="dKV"></div>

      <!-- QR preview -->
      <div id="qrSection" class="qrbox" hidden>
        <h4>Equipment QR</h4>
        <img id="qrImg" alt="Equipment QR"/>
        <p id="qrLbl" class="qrnote"></p>
      </div>
    </div>
    <footer>
      <button id="btnPrintQR" class="btn" type="button" disabled>Reprint QR</button>
      <a id="openHub" class="btn btn-primary" href="#">Open Hub</a>
      <button id="dClose2" class="btn" type="button">Close</button>
    </footer>
  </dialog>

  <script type="module">
    import {
      ready,
      getFirestore, collection, query, where, onSnapshot
    } from '/Farm-vista/js/firebase-init.js';

    const $ = sel => document.querySelector(sel);
    const list = $('#list');
    const countEl = $('#count');
    const qInput = $('#q');

    let DATA = [];
    let unsub = null;

    // Helpers
    const last6 = v => String(v||'').slice(-6);
    const safe = v => (v==null ? '' : String(v));
    const normStatus = v => String(v ?? 'active').toLowerCase();
    const isActive = d => {
      const s = normStatus(d.status);
      return s === 'active' || (d.active === true) || (d.status == null);
    };
    const mmText = d => [safe(d.makeName), safe(d.modelName)].filter(Boolean).join(' ').trim();
    const displayLine = d => {
      const mm = mmText(d);
      const ls = last6(d.serial);
      return mm ? (ls ? `${mm} — #${ls}` : mm) : (ls ? `#${ls}` : '(tractor)');
    };
    const titleFor = d => {
      const mm = mmText(d);
      const ls = last6(d.serial);
      return mm ? (ls ? `${mm} (#${ls})` : mm) : (d.name || '(tractor)');
    };
    const hubUrl = (id, token) => {
      const base = `${location.origin}/Farm-vista/pages/equipment/actions/hub.html`;
      const u = new URL(base);
      u.searchParams.set('id', id);
      if (token) u.searchParams.set('t', token);
      return u.href;
    };

    function attach(){
      if (unsub) return;
      const db = getFirestore();
      const qref = query(collection(db,'equipment'), where('type','==','tractor'));
      unsub = onSnapshot(qref, (snap)=>{
        const out = [];
        snap.forEach(docSnap=>{
          const d = docSnap.data() || {};
          if (!isActive(d)) return;
          out.push({ id: docSnap.id, ...d });
        });
        out.sort((a,b)=> displayLine(a).localeCompare(displayLine(b)));
        DATA = out;
        render();
      }, (err)=> console.error('Tractors listener error:', err));
    }
    function detach(){ if (unsub){ try{ unsub(); }catch{}; unsub = null; } }

    function render(){
      const q = (qInput.value || '').toLowerCase().trim();
      const rows = DATA.filter(d=>{
        if (!q) return true;
        const blob = [
          displayLine(d), d.makeName, d.modelName, d.serial, d.year, d.notes
        ].map(x=>String(x||'').toLowerCase()).join(' ');
        return blob.includes(q);
      });

      countEl.textContent = `${rows.length}/${DATA.length} entries`;
      list.innerHTML = '';

      if(!rows.length){
        const p = document.createElement('p');
        p.className='sub'; p.textContent='No matches.';
        list.appendChild(p);
        return;
      }

      // Group A-Z by first letter of display line
      const by = {};
      rows.forEach(d=>{
        const name = displayLine(d);
        const k = (name || '?').charAt(0).toUpperCase();
        (by[k] ||= []).push(d);
      });

      Object.keys(by).sort().forEach(letter=>{
        const wrap = document.createElement('div'); wrap.className='group';
        const h = document.createElement('h3'); h.textContent = letter; wrap.appendChild(h);
        by[letter].forEach(d=>{
          const card = document.createElement('div'); card.className='card'; card.setAttribute('role','button');
          const title = document.createElement('div'); title.className='card-title'; title.textContent = displayLine(d);
          card.append(title);
          card.addEventListener('click', ()=> openDetail(d));
          wrap.appendChild(card);
        });
        list.appendChild(wrap);
      });
    }

    // Detail modal (read-only)
    const dlg = document.getElementById('detail');
    const dTitle = document.getElementById('dTitle');
    const dKV = document.getElementById('dKV');
    const btnHub = document.getElementById('openHub');

    // QR elements
    const btnPrintQR = document.getElementById('btnPrintQR');
    const qrSection = document.getElementById('qrSection');
    const qrImg = document.getElementById('qrImg');
    const qrLbl = document.getElementById('qrLbl');

    const close = ()=> { try{ dlg.close(); }catch{ dlg.removeAttribute('open'); } };
    document.getElementById('dClose').addEventListener('click', close);
    document.getElementById('dClose2').addEventListener('click', close);

    const has = v => !(v===undefined || v===null || v==='');
    function addRow(k, v){
      if(!has(v)) return;
      const K = document.createElement('div'); K.className='k'; K.textContent = k;
      const V = document.createElement('div'); V.className='v'; V.textContent = String(v);
      dKV.append(K,V);
    }

    // Resolve qr.image as string OR {url}
    function getQrUrl(d){
      try{
        if (!d || !d.qr) return '';
        const img = d.qr.image;
        if (!img) return '';
        if (typeof img === 'string') return img;
        if (typeof img.url === 'string') return img.url;
        return '';
      }catch{ return ''; }
    }

    function openDetail(d){
      dTitle.textContent = titleFor(d);
      dKV.innerHTML = '';
      addRow('Type','Tractor');
      addRow('Make', d.makeName);
      addRow('Model', d.modelName);
      addRow('Year', d.year);
      const ls = last6(d.serial); if(ls) addRow('Serial (last 6)', ls);
      addRow('Engine Hours', has(d.engineHours) ? d.engineHours : '');
      addRow('Notes', d.notes);

      const tok = d.qr && d.qr.token ? d.qr.token : '';
      btnHub.href = hubUrl(d.id, tok);

      // QR preview
      const url = getQrUrl(d);
      const labelText = [safe(d.modelName)].filter(Boolean).join(' ') + (ls ? ` - #${ls}` : '');
      if (url){
        const bust = (url.includes('?') ? '&' : '?') + '_=' + Date.now();
        qrImg.src = url + bust;
        qrImg.alt = `QR for ${labelText}`;
        qrLbl.textContent = labelText;
        qrSection.hidden = false;
        btnPrintQR.disabled = false;
        btnPrintQR.onclick = ()=> printQR(url, labelText);
      } else {
        qrImg.removeAttribute('src');
        qrLbl.textContent = 'No QR image saved for this equipment.';
        qrSection.hidden = false;
        btnPrintQR.disabled = true;
        btnPrintQR.onclick = null;
      }

      try{ dlg.showModal(); }catch{ dlg.setAttribute('open',''); }
    }

    /* ==================== Robust QR Print (new-tab, iOS friendly) ==================== */
    function printQR(url, labelText){
      // Always open a fresh user-initiated tab; avoids iOS “blocked from automatically printing”.
      const w = window.open('', '_blank');
      if (!w) return;

      const html = `<!doctype html><html><head><meta charset="utf-8"/>
<title>QR Label</title><meta name="viewport" content="width=device-width, initial-scale=1"/>
<style>
  /* If the printer supports custom size, this is exact 2in×1in. Otherwise we center on Letter. */
  @page { size: 2in 1in; margin: 0; }
  html, body { margin:0; padding:0; background:#fff; }
  /* Letter fallback centering */
  body:before{ content:""; display:block; height:0; }
  #wrap{
    width:2in; height:1in; margin:0 auto;
    display:flex; align-items:center; justify-content:center;
    transform:translateZ(0); /* ensure rasterization on iOS */
  }
  #card { width:2in; height:1in; display:flex; flex-direction:column; align-items:center; justify-content:center; }
  #qri { max-width: 1.25in; max-height: 0.72in; display:block; image-rendering: pixelated; background:#fff; }
  #lbl { font:700 10px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; line-height:1; white-space:nowrap; margin-top:2px; }
  @media print {
    html, body { -webkit-print-color-adjust:exact; print-color-adjust:exact; }
    *, *:before, *:after { box-shadow:none !important; }
    #wrap, #card { break-inside:avoid; page-break-inside:avoid; }
  }
</style>
</head><body>
  <div id="wrap">
    <div id="card">
      <img id="qri" src="${url}" alt="QR"/>
      <div id="lbl">${labelText}</div>
    </div>
  </div>
<script>
  const img = document.getElementById('qri');
  function doPrint(){ try{ window.focus(); window.print(); }catch(e){} }
  if (img.complete) { setTimeout(doPrint, 0); }
  else { img.addEventListener('load', ()=> setTimeout(doPrint, 0), {once:true}); }
  window.addEventListener('afterprint', ()=> { try{ window.close(); }catch(e){} });
  // Safety close (e.g., if afterprint doesn't fire on some mobile stacks)
  setTimeout(()=>{ try{ window.close(); }catch(e){} }, 4000);
<\/script>
</body></html>`;

      w.document.open(); w.document.write(html); w.document.close();
    }
    /* ================================================================================ */

    // Resume hooks
    function resume(){ if (!unsub) attach(); }

    (async()=>{
      await ready;
      attach();
      qInput.addEventListener('input', render);
      window.addEventListener('pageshow', resume);
      document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') resume(); });
      window.addEventListener('focus', resume);
      window.addEventListener('pagehide', ()=>{ detach(); });
    })();
  </script>
</body>
</html>