<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FarmVista • Equipment Maintenance — Work Orders</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#3B7E46" />

  <script src="/Farm-vista/js/theme-boot.js"></script>

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest" />
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png" />
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png" />
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css" />
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css" />

  <style>
  :root{
    --card-max: 1200px;
    --page-bottom-gap: 72px;
    --accent: #2F6C3C;
  }

  /* ===============================
     HARD CLAMP — stop post-load width expansion
     (fv-shell / app.css / 100vw issues)
     =============================== */
  html, body{
    width:100%;
    max-width:100%;
    overflow-x:hidden !important;
  }

  fv-shell{
    display:block;
    width:100%;
    max-width:100%;
    overflow-x:hidden !important;
  }

  fv-shell > *{
    max-width:100%;
  }

  /* ===============================
     VW SANITIZER — prevents 100vw overflow on mobile
     =============================== */
  @supports (width: 100dvw){
    html, body{
      width:100dvw;
    }
  }

  body{ background: var(--app-bg, var(--surface)); }

  .wrap{
    width:100%;
    max-width: var(--card-max);
    margin: 0 auto;
    padding: clamp(14px,3vw,22px);
    padding-bottom: calc(
      env(safe-area-inset-bottom,0px)
      + var(--ftr-h,56px)
      + var(--page-bottom-gap)
      + 16px
    ) !important;
    box-sizing:border-box;

    /* Prevent horizontal overflow while still allowing dropdowns */
    overflow-x:hidden;
    overflow-y:visible;
  }

  .btn{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    min-width:120px;
    padding:10px 14px;
    border-radius:12px;
    border:1px solid var(--border);
    font-weight:800;
    text-decoration:none;
    cursor:pointer;
    user-select:none;
    color:var(--text) !important;
    background:var(--card-surface,var(--surface));
    font-size:0.9rem;
    gap:6px;
    white-space:nowrap;
    max-width:100%;
    box-sizing:border-box;
  }
  .btn-quiet{ min-width:auto; padding-inline:10px; }
  .btn-primary{
    border-color:transparent;
    background:#2F6C3C;
    color:#fff !important;
  }

  /* Hero */
  .hero{
    width:100%;
    max-width:100%;
    border:1px solid var(--border);
    border-radius:14px;
    background:var(--surface);
    box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));
    overflow: visible;
    position: relative;
    z-index: 1;
    box-sizing:border-box;
  }
  .hero-head{
    display:grid;
    grid-template-columns:36px 1fr;
    gap:12px;
    align-items:center;
    padding:14px 16px;
    background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);
    border-bottom:1px solid var(--border);
    border-top-left-radius:14px;
    border-top-right-radius:14px;
    box-sizing:border-box;
  }
  .hero-head .icon{
    width:24px;
    height:24px;
    color:var(--accent);
    display:grid;
    place-items:center;
  }
  .hero-head h1{
    margin:0;
    font-size:clamp(20px,3.2vw,26px);
    line-height:1.2;
  }
  .muted{ color:var(--muted,#67706B); }

  .body{
    padding:16px;
    display:grid;
    gap:14px;
    overflow: visible;
    box-sizing:border-box;
    max-width:100%;
  }

  .toolbar{
    display:flex;
    flex-wrap:wrap; /* ✅ allow wrap instead of overflow */
    gap:10px;
    align-items:flex-end;
    justify-content:space-between;
    max-width:100%;
  }
  .toolbar-left{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    align-items:center;
    min-width:0;
    max-width:100%;
  }
  .page-header-meta{
    font-size:0.9rem;
    opacity:0.8;
    min-width:0;
    max-width:100%;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  /* Filters */
  .filters{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    align-items:flex-end;
    margin-top:4px;
    position: relative;
    z-index: 50;
    max-width:100%;
    box-sizing:border-box;
  }
  .filter-field{
    display:flex;
    flex-direction:column;
    gap:3px;
    min-width:160px;
    flex:1 1 180px;
    font-size:0.8rem;
    min-width: 0;
    max-width:100%;
    box-sizing:border-box;
  }
  .filter-label{
    text-transform:uppercase;
    letter-spacing:0.08em;
    opacity:0.78;
  }

  .filter-select{
    width:100%;
    max-width:100%;
    height:34px;
    line-height:34px;
    border-radius:999px;
    border:1px solid var(--border);
    padding:0 10px;
    background:var(--card-surface,var(--surface));
    color:var(--text);
    font-size:0.9rem;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    box-sizing:border-box;
    position:relative;
    z-index:60;
    display:block;
  }
  .filter-select option{ white-space: nowrap; }

  .filters-row{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    align-items:flex-end;
    width:100%;
    max-width:100%;
    min-width:0;
    box-sizing:border-box;
  }
  .filters-row-secondary{ margin-top:6px; }

  .type-wide{ flex:1.25 1 240px; }
  .equip-wide{ flex:2 1 360px; }

  /* Search bar (Option A style) */
  .bar{ display:flex; align-items:center; gap:10px; width:100%; max-width:100%; box-sizing:border-box; }
  .search{
    display:flex;
    align-items:center;
    gap:10px;
    border:1px solid var(--border);
    border-radius:12px;
    background:var(--surface);
    padding:10px 12px;
    flex:1 1 auto;
    min-height:34px;
    width:100%;
    max-width:100%;
    box-sizing:border-box;
    min-width:0;
  }
  .search svg{ opacity:0.6; flex-shrink:0; }
  .search input{
    flex:1;
    background:transparent;
    border:0;
    outline:none;
    font:inherit;
    color:var(--text);
    min-width:0;
  }

  /* List */
  .wo-list{ display:flex; flex-direction:column; gap:10px; margin-top:8px; }

  .wo-empty{
    padding:14px 16px;
    border-radius:12px;
    border:1px dashed var(--border);
    background:var(--card-surface, var(--surface));
    font-size:0.95rem;
    opacity:0.9;
  }

  .group{
    margin-top:12px;
    border-top:1px solid color-mix(in srgb, var(--border) 70%, transparent);
    padding-top:12px;
  }
  .group-head{
    display:flex;
    align-items:baseline;
    justify-content:space-between;
    gap:10px;
    margin:0 0 8px;
    padding:0 2px;
    min-width:0;
    max-width:100%;
  }
  .group-title{
    margin:0;
    font-weight:950;
    letter-spacing:0.06em;
    text-transform:uppercase;
    font-size:0.86rem;
    opacity:0.88;
  }
  .group-sub{
    font-size:0.82rem;
    opacity:0.72;
    white-space:nowrap;
  }
  .group-note{
    margin-top:2px;
    font-size:0.82rem;
    opacity:0.75;
    line-height:1.25;
  }

  .wo-card{
    position:relative;
    border-radius:10px;
    border:1px solid var(--card-border, var(--border));
    background:var(--card-surface, var(--surface));
    box-shadow:var(--shadow-soft, var(--shadow));
    padding:12px 14px 10px;
    display:flex;
    flex-direction:column;
    gap:6px;
    cursor:pointer;
    transition:transform .06s, box-shadow .12s, border-color .12s, background .12s;
    z-index: 1;
    max-width:100%;
    box-sizing:border-box;
  }
  .wo-card:active{
    transform:scale(.995);
    box-shadow:var(--shadow);
  }

  .wo-row-top{
    display:flex;
    align-items:flex-start;
    gap:10px;
    justify-content:space-between;
    min-width:0;
    max-width:100%;
  }
  .wo-main{ flex:1 1 auto; min-width:0; }

  .wo-right{
    flex:0 0 auto;
    display:flex;
    align-items:flex-start;
    justify-content:flex-end;
    padding-top:1px;
    min-width: 0;
  }

  /* helper text shown ONLY for pre-season / pre-inspection WOs */
  .wo-helper{
    font-size:0.74rem;
    font-weight:950;
    letter-spacing:0.08em;
    text-transform:uppercase;
    padding:4px 8px;
    border-radius:999px;
    border:1px solid rgba(59,126,70,0.28);
    background:rgba(59,126,70,0.08);
    color:color-mix(in srgb, var(--text) 85%, #0a4c29);
    white-space:nowrap;
    user-select:none;
    max-width:100%;
    box-sizing:border-box;
  }

  .wo-title{
    font-weight:800;
    font-size:0.98rem;
    line-height:1.3;
  }

  .wo-sub{
    font-size:0.86rem;
    opacity:0.9;
    margin-top:2px;
  }

  .wo-meta{
    display:flex;
    flex-wrap:wrap;
    gap:6px 10px;
    margin-top:4px;
    font-size:0.8rem;
    opacity:0.92;
    max-width:100%;
  }

  .wo-meta span{
    display:inline-flex;
    align-items:flex-start;
    gap:6px;
    padding:2px 7px;
    border-radius:999px;
    background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
    max-width:100%;
  }
  .wo-meta span > span.wo-meta-label{
    font-weight:900;
    text-transform:uppercase;
    letter-spacing:0.08em;
    font-size:0.72rem;
    opacity:0.85;
    margin-top:1px;
  }
  .wo-meta .wo-meta-val{
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    max-width:56ch;
  }
  @media (max-width:520px){
    .wo-meta .wo-meta-val{ max-width:30ch; }
  }

  @media (max-width:520px){
    .filters-row-secondary .filter-field{
      flex: 1 1 100%;
      width: 100%;
    }
    .filters-row-secondary #filterClear{
      flex: 1 1 100%;
      width: 100%;
      margin-top: 0;
    }
  }

  /* ✅ Mobile layout guardrails (prevents right-side overflow) */
  @media (max-width:560px){
    .toolbar{ flex-direction:column; align-items:stretch; }
    .toolbar-left{ width:100%; }
    .toolbar-left .btn{ flex:1 1 160px; }
    .page-header-meta{ width:100%; text-align:left; white-space:normal; overflow:visible; text-overflow:clip; }
    .filter-field{ min-width:0; }
    .group-sub{ white-space:normal; text-align:right; }

    /* ==========================================
       MOBILE REFACTOR — move .wo-right UNDER the title (no truncation)
       ========================================== */
    .wo-row-top{
      flex-direction:column;
      align-items:stretch;
      gap:8px;
      min-width:0;
    }
    .wo-main{
      min-width:0;
    }
    .wo-right{
      flex: 0 0 auto;
      width:100%;
      max-width:100%;
      justify-content:flex-start;
      padding-top:0;
      min-width:0;
    }
    .wo-helper{
      display:inline-flex;
      max-width:100%;
      white-space:normal;
      overflow-wrap:anywhere;
      word-break:break-word;
    }
  }

  /* Detail panel */
  .wo-detail-panel{
    margin-top:10px;
    border-radius:10px;
    border:1px solid var(--card-border, var(--border));
    background:var(--card-surface, var(--surface));
    box-shadow:var(--shadow-soft, var(--shadow));
    padding:14px 16px 12px;
    display:none;
    flex-direction:column;
    gap:8px;
    max-width:100%;
    box-sizing:border-box;
  }
  .wo-detail-header{
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:10px;
    min-width:0;
  }
  .wo-detail-title{ font-weight:900; font-size:1rem; min-width:0; }
  .wo-detail-close{
    border:none;
    outline:none;
    border-radius:999px;
    padding:4px 9px;
    font-size:0.8rem;
    background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
    cursor:pointer;
    flex:0 0 auto;
  }
  .wo-detail-grid{
    display:grid;
    grid-template-columns:minmax(0,1fr);
    gap:8px 16px;
    font-size:0.9rem;
    margin-top:4px;
  }
  @media (min-width:700px){
    .wo-detail-grid{ grid-template-columns:repeat(2, minmax(0,1fr)); }
  }
  .wo-detail-item-label{
    font-size:0.78rem;
    text-transform:uppercase;
    letter-spacing:0.06em;
    opacity:0.7;
    margin-bottom:1px;
  }
  .wo-detail-item-value{ font-size:0.94rem; }

  .wo-detail-notes{
    margin-top:8px;
    padding-top:8px;
    border-top:1px solid var(--border);
    font-size:1.02rem;
    white-space:pre-wrap;
    line-height:1.35;
  }
  .wo-detail-notes-label{
    font-size:0.8rem;
    text-transform:uppercase;
    letter-spacing:0.06em;
    opacity:0.7;
    margin-bottom:2px;
  }

  .wo-detail-footer{
    margin-top:10px;
    font-size:0.82rem;
    opacity:0.85;
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    align-items:center;
    max-width:100%;
  }

  .wo-detail-pill{
    display:inline-flex;
    align-items:center;
    gap:4px;
    padding:2px 8px;
    border-radius:999px;
    background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
    font-size:0.8rem;
    box-sizing:border-box;

    /* ✅ safe on mobile + desktop */
    min-width:0;
    max-width:100%;
  }

  .wo-detail-pill.preseason{
    border:1px solid rgba(59,126,70,0.26);
    background:rgba(59,126,70,0.08);
    font-weight:950;
    letter-spacing:0.06em;
    text-transform:uppercase;
  }

  /* Make footer pills safe on small screens (does NOT change desktop look) */
  @media (max-width:560px){
    .wo-detail-footer{
      min-width:0;
      max-width:100%;
      overflow:hidden;
    }
    .wo-detail-footer > *{
      min-width:0;
      max-width:100%;
    }
    .wo-detail-pill{
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .wo-detail-pill.preseason{
      max-width:42vw;
    }
  }

  /* Line items in detail panel */
  .li-list{ margin-top:8px; display:flex; flex-direction:column; gap:8px; }
  .li{
    border:1px solid var(--border);
    border-radius:12px;
    padding:10px 10px 9px;
    background:linear-gradient(135deg, rgba(59,126,70,0.05), var(--surface));
    max-width:100%;
    box-sizing:border-box;
  }
  .li-top{
    display:flex;
    justify-content:space-between;
    gap:10px;
    align-items:flex-start;
    padding-bottom:7px;
    border-bottom:1px solid color-mix(in srgb, var(--border) 60%, transparent);
    margin-bottom:8px;
    min-width:0;
  }
  .li-title{ font-weight:950; font-size:0.95rem; line-height:1.25; min-width:0; }
  .li-badge{
    font-size:0.72rem;
    font-weight:950;
    letter-spacing:0.08em;
    text-transform:uppercase;
    padding:4px 8px;
    border-radius:999px;
    border:1px solid rgba(59,126,70,0.28);
    background:rgba(59,126,70,0.07);
    color:#0F172A;
    white-space:nowrap;
    flex:0 0 auto;
  }
  .li-badge.open{
    border-color: rgba(234,179,8,0.35);
    background: rgba(234,179,8,0.10);
  }
  .li-meta{
    display:grid;
    grid-template-columns:repeat(2, minmax(0,1fr));
    gap:8px 10px;
    font-size:0.86rem;
    opacity:0.96;
    max-width:100%;
  }
  .pair .kk{
    font-size:0.72rem;
    text-transform:uppercase;
    letter-spacing:0.10em;
    opacity:0.75;
    font-weight:900;
    margin-bottom:2px;
  }
  .pair .vv{ font-weight:650; line-height:1.25; word-break:break-word; }
  .pair.notes{ grid-column:1/-1; padding-top:8px; border-top:1px dashed color-mix(in srgb, var(--border) 65%, transparent); }
  .pair.notes .vv{ white-space:pre-wrap; }

  /* Bottom actions */
  .bottom-actions{ margin-top:16px; display:flex; justify-content:flex-end; }
  @media (max-width:640px){
    .bottom-actions{ justify-content:stretch; }
    .bottom-actions .btn{ width:100%; justify-content:center; }
  }

  /* Print iframe */
  #fv-print-frame{
    position:fixed;
    right:0;
    bottom:0;
    width:0;
    height:0;
    border:0;
    visibility:hidden;
  }

  /* Print chooser modal (same pattern as trials) */
  .modal-backdrop{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.42);
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:1400;
  }
  .modal-hidden{ display:none !important; }
  .modal{
    width:min(560px, 94vw);
    max-height:calc(100vh - 80px);
    background:var(--surface);
    border-radius:14px;
    box-shadow:0 18px 40px rgba(0,0,0,.3);
    border:1px solid var(--border);
    display:flex;
    flex-direction:column;
    overflow:hidden;
  }
  .modal-head{
    padding:12px 14px;
    border-bottom:1px solid var(--border);
    display:flex;
    flex-direction:column;
    gap:4px;
    background:linear-gradient(135deg, rgba(47,108,60,0.12), transparent);
  }
  .modal-title-row{
    display:flex;
    justify-content:space-between;
    gap:10px;
    align-items:flex-start;
  }
  .modal-title{
    font-size:1rem;
    font-weight:700;
  }
  .modal-sub{
    font-size:0.86rem;
    opacity:0.9;
    margin-top:4px;
  }
  .modal-close-btn{
    border:none;
    background:transparent;
    font-size:1.3rem;
    line-height:1;
    cursor:pointer;
    padding:2px 4px;
    border-radius:999px;
  }
  .modal-body{
    padding:14px 16px 16px;
    display:grid;
    gap:10px;
    font-size:0.88rem;
  }
  .modal-note{
    font-size:0.82rem;
    opacity:0.85;
    line-height:1.35;
  }
  .modal-buttons{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    justify-content:flex-end;
    margin-top:6px;
  }
  .modal-btn{ flex:1 1 160px; }
</style>


  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true;
        document.head.appendChild(s);
      }
    })();
  </script>

  <!-- Cloud PDF helper (if present) -->
  <script src="/Farm-vista/js/fv-pdf.js"></script>

  <script type="module">
    import {
      ready,
      getFirestore,
      collection, getDocs,
      doc, getDoc
    } from '/Farm-vista/js/firebase-init.js';

    import { NAV_MENU } from '/Farm-vista/js/menu.js';

    const CONFIG = {
      WORKORDERS: 'equipmentWorkOrders',
      EQUIPMENT: 'equipment',
      COMPANY_DOC_PATH: ['company','main']
    };

    const $ = (sel, root=document) => root.querySelector(sel);

    const STATE = {
      db: null,
      company: null,
      equipmentById: new Map(),  // active only
      workOrders: [],            // active-equipment only
      filtered: [],
      selectedId: null,

      // ✅ cache template items so older precheck WOs can display label/notesHint
      precheckTplCache: new Map() // tplId -> [{id,label,notesHint,order}]
    };

    function escapeHtml(str){
      return String(str || '').replace(/[&<>"']/g, m => (
        { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]
      ));
    }

    function toDateMaybe(ts){
      if(!ts) return null;
      try{
        if(ts.toDate) return ts.toDate();
        if(ts && typeof ts === 'object' && ts.__time__){
          const d = new Date(ts.__time__);
          return Number.isFinite(d.getTime()) ? d : null;
        }
        if(ts && typeof ts === 'object' && typeof ts.seconds === 'number'){
          const d = new Date(ts.seconds * 1000);
          return Number.isFinite(d.getTime()) ? d : null;
        }
        if(typeof ts === 'string' || typeof ts === 'number'){
          const d = new Date(ts);
          return Number.isFinite(d.getTime()) ? d : null;
        }
      }catch(_){}
      return null;
    }

    function formatDate(d){
      if(!d) return '';
      try{ return d.toLocaleDateString(undefined,{month:'short',day:'numeric',year:'numeric'}); }
      catch{ return ''; }
    }
    function formatDateTime(d){
      if(!d) return '';
      try{ return d.toLocaleString(); }
      catch{ return ''; }
    }

    function titleCaseType(s){
      const v = String(s||'').trim().toLowerCase();
      if(!v) return '';
      const map = { 'in_progress':'In progress', 'pending':'Pending', 'completed':'Completed' };
      if(map[v]) return map[v];
      return v.replace(/_/g,' ').replace(/\b\w/g, c => c.toUpperCase());
    }

    function normalizeStatus(s){
      const v = String(s||'').trim().toLowerCase();
      if(v === 'in progress') return 'in_progress';
      if(v === 'in_progress') return 'in_progress';
      if(v === 'pending') return 'pending';
      if(v === 'completed') return 'completed';
      return v;
    }

    function statusLabel(st){
      const n = normalizeStatus(st);
      if(n === 'pending') return 'Pending';
      if(n === 'in_progress') return 'In progress';
      if(n === 'completed') return 'Completed';
      return st || '—';
    }

    function equipDisplay(e){
      if(!e) return '';

      const mk = (e.makeName || e.equipmentMake || '').trim();
      const md = (e.modelName || e.equipmentModel || '').trim();

      // Prefer full serial/VIN, show last 6 only
      const rawSerial = (e.serial || '').trim();
      let last6 = '';
      if (rawSerial) {
        last6 = rawSerial.length > 6
          ? rawSerial.slice(-6)
          : rawSerial;
      }

      const base = [mk, md].filter(Boolean).join(' ');
      return base + (last6 ? ` (#${last6})` : '');
    }

    function woEquipInfo(wo){
      const d = wo.data || {};
      const eq = STATE.equipmentById.get(d.equipmentId) || null;
      return {
        eq,
        equipId: d.equipmentId || '',
        type: (eq?.type || d.equipmentType || '').trim(),
        name: eq ? equipDisplay(eq) : (d.equipmentName || '').trim(),
        make: (eq?.makeName || d.equipmentMake || '').trim(),
        model: (eq?.modelName || d.equipmentModel || '').trim(),
        serial: (eq?.serial || '').trim(),
        serialLast6: (d.equipmentSerialLast6 || '').trim()
      };
    }

    function getSortDateForWO(d){
      const done = toDateMaybe(d.completedAt);
      const upd  = toDateMaybe(d.updatedAt);
      const crt  = toDateMaybe(d.createdAt);
      return done || upd || crt || null;
    }

    function computeCounts(items){
      const pending = items.filter(x => normalizeStatus(x.data.status) === 'pending').length;
      const ip = items.filter(x => normalizeStatus(x.data.status) === 'in_progress').length;
      const done = items.filter(x => normalizeStatus(x.data.status) === 'completed').length;
      return { pending, ip, done, total: items.length };
    }

    function setSelectOptions(selectEl, optionsHtml, currentValue){
      if(!selectEl) return;
      selectEl.innerHTML = optionsHtml;
      if(currentValue != null){
        const exists = Array.from(selectEl.options).some(o => o.value === currentValue);
        selectEl.value = exists ? currentValue : (selectEl.options[0]?.value || '');
      }
    }

    function hydrateTypeDropdown(){
      const typeSel = $('#filterType');
      const cur = typeSel?.value || 'all';

      const types = Array.from(new Set(
        Array.from(STATE.equipmentById.values())
          .filter(e => String(e.status||'').toLowerCase() === 'active')
          .map(e => String(e.type||'').trim().toLowerCase())
          .filter(Boolean)
      )).sort((a,b)=> a.localeCompare(b));

      const opts = [
        `<option value="all">All types</option>`,
        ...types.map(t => `<option value="${escapeHtml(t)}">${escapeHtml(titleCaseType(t))}</option>`)
      ].join('');

      setSelectOptions(typeSel, opts, cur);
    }

    function hydrateEquipmentDropdown(){
      const eqSel = $('#filterEquip');
      const typeSel = $('#filterType');

      const typeVal = (typeSel?.value || 'all').toLowerCase();
      const cur = eqSel?.value || 'all';

      const list = Array.from(STATE.equipmentById.entries())
        .map(([id, e]) => ({ id, e }))
        .filter(({e}) => String(e.status||'').toLowerCase() === 'active')
        .filter(({e}) => typeVal === 'all' ? true : String(e.type||'').toLowerCase() === typeVal)
        .sort((a,b)=> equipDisplay(a.e).localeCompare(equipDisplay(b.e)));

      const opts = [
        `<option value="all">All equipment</option>`,
        ...list.map(({id, e}) => {
          const full = equipDisplay(e);
          const label = full.length > 60 ? full.slice(0,59) + '…' : full;
          return `<option value="${escapeHtml(id)}" title="${escapeHtml(full)}">${escapeHtml(label)}</option>`;
        })
      ].join('');

      const curExists = list.some(x => x.id === cur);
      setSelectOptions(eqSel, opts, curExists ? cur : 'all');
    }

    function getFilters(){
      return {
        status: ($('#filterStatus')?.value || 'all').toLowerCase(),
        type: ($('#filterType')?.value || 'all').toLowerCase(),
        equip: ($('#filterEquip')?.value || 'all'),
        q: (($('#filterSearch')?.value || '').trim().toLowerCase())
      };
    }

    /* ==========================
       PRE-SEASON / PRE-INSPECTION DETECTOR
       ========================== */
    function isPreSeasonWO(d){
      if(!d) return false;

      const directKeys = [
        d.precheckTemplateId,
        d.preCheckTemplateId,
        d.preInspectionTemplateId,
        d.preInspectionId,
        d.templateId
      ].map(x => String(x || '').trim()).filter(Boolean);
      if(directKeys.length) return true;

      const kind = String(d.workOrderType || d.type || d.kind || '').trim().toLowerCase();
      if(kind){
        if(kind.includes('precheck') || kind.includes('pre-check') || kind.includes('preseason') || kind.includes('pre-season') || kind.includes('preinspection') || kind.includes('pre-inspection')) return true;
      }

      const tag = String(d.tag || d.category || '').trim().toLowerCase();
      if(tag){
        if(tag.includes('precheck') || tag.includes('preseason') || tag.includes('preinspection')) return true;
      }

      const li = Array.isArray(d.lineItems) ? d.lineItems : [];
      if(li.some(x => String(x?.origin || '').toLowerCase() === 'precheck_template')) return true;

      return false;
    }

    /* ==========================
       TEMPLATE ITEMS LOADER (same pattern as Service WO page)
       ========================== */
    async function getPrecheckTemplateItems(tplId){
      const id = String(tplId || '').trim();
      if(!id) return [];
      if(STATE.precheckTplCache.has(id)) return STATE.precheckTplCache.get(id);

      try{
        const snap = await getDocs(collection(STATE.db, 'seasonal_precheck_templates', id, 'items'));
        const out = [];
        snap.forEach(d=>{
          const v = d.data() || {};
          if(v.archived === true) return;
          out.push({
            id: d.id,
            label: String(v.label || '').trim(),
            notesHint: String(v.notesHint || '').trim(),
            order: Number(v.order || 0)
          });
        });
        out.sort((a,b)=> (a.order||0) - (b.order||0));
        STATE.precheckTplCache.set(id, out);
        return out;
      }catch(e){
        console.warn('[maintenance] precheck template items load failed:', e);
        STATE.precheckTplCache.set(id, []);
        return [];
      }
    }

    function applyFilters(){
      const { status, type, equip, q } = getFilters();

      const filtered = STATE.workOrders.filter(wo => {
        const d = wo.data || {};
        const st = normalizeStatus(d.status);

        const eq = STATE.equipmentById.get(d.equipmentId) || null;
        if(!eq || String(eq.status||'').toLowerCase() !== 'active') return false;

        if(status !== 'all' && st !== status) return false;

        const eqType = String(eq.type || d.equipmentType || '').trim().toLowerCase();
        if(type !== 'all' && eqType !== type) return false;

        if(equip !== 'all' && String(d.equipmentId || '') !== String(equip)) return false;

        if(q){
          const eqName = equipDisplay(eq);
          const li = Array.isArray(d.lineItems) ? d.lineItems : [];
          const liText = li.map(x => [
            x.serviceTopic, x.serviceTopicOther,
            x.label, x.notesHint,
            x.notes, x.partsNeeded,
            x.submittedByName,
            x.completedByEmployeeName, x.completedByEmployeeId
          ].filter(Boolean).join(' ')).join('  •  ');

          const hay = [
            eqName,
            eq?.makeName, eq?.modelName, eq?.serial,
            d.equipmentName, d.equipmentMake, d.equipmentModel, d.equipmentSerialLast6,
            d.status,
            d.meterLabel, d.meterType,
            d.summaryNotes,
            d.precheckTemplateId, d.preCheckTemplateId, d.preInspectionTemplateId,
            d.workOrderType, d.type, d.kind, d.tag, d.category,
            liText
          ].filter(Boolean).join(' ').toLowerCase();

          if(!hay.includes(q)) return false;
        }

        return true;
      });

      filtered.sort((a,b) => {
        const da = a.data?._sortDate ? a.data._sortDate.getTime() : 0;
        const db = b.data?._sortDate ? b.data._sortDate.getTime() : 0;
        return db - da;
      });

      STATE.filtered = filtered;
      renderList();
      if(STATE.selectedId) void renderDetails();
    }

    function renderList(){
      const host = $('.wo-list');
      const emptyEl = $('.wo-empty');
      const countEl = $('#woCount');

      host.innerHTML = '';
      const items = STATE.filtered || [];

      if(!items.length){
        emptyEl.style.display = 'block';
        emptyEl.textContent = 'No work orders match the current filters.';
        if(countEl) countEl.textContent = '0 work orders';
        return;
      }
      emptyEl.style.display = 'none';

      const counts = computeCounts(items);
      if(countEl){
        countEl.textContent =
          `${counts.total} work order${counts.total===1?'':'s'} • ` +
          `${counts.pending} pending • ${counts.ip} in progress • ${counts.done} completed`;
      }

      const pre = [];
      const normal = [];
      for(const wo of items){
        const d = wo.data || {};
        (isPreSeasonWO(d) ? pre : normal).push(wo);
      }

      if(pre.length){
        const g = document.createElement('div');
        g.className = 'group';

        g.innerHTML = `
          <div class="group-head">
            <div>
              <h3 class="group-title">Pre-Season Pre-Inspection</h3>
              <div class="group-note">Work orders created from pre-check / pre-inspection templates.</div>
            </div>
            <div class="group-sub">${pre.length} work order${pre.length===1?'':'s'}</div>
          </div>
        `;

        for(const wo of pre){
          const d = wo.data || {};
          const info = woEquipInfo(wo);

          const st = statusLabel(d.status);
          const created = toDateMaybe(d.createdAt);
          const completed = toDateMaybe(d.completedAt);
          const showDate = completed || created || d._sortDate || null;

          const li = Array.isArray(d.lineItems) ? d.lineItems : [];
          const openCount = li.filter(x => !x?.completed).length;

          const meter = (d.meterLabel && (d.completionMeter != null))
            ? `${d.meterLabel}: ${d.completionMeter}`
            : (d.meterLabel ? String(d.meterLabel) : '');

          const eqTypeLabel = info.type ? titleCaseType(info.type) : '—';

          const card = document.createElement('article');
          card.className = 'wo-card';
          card.dataset.id = wo.id;

          card.innerHTML = `
            <div class="wo-row-top">
              <div class="wo-main">
                <div class="wo-title">${escapeHtml(info.name || 'Equipment')}</div>
                <div class="wo-sub">
                  ${escapeHtml(info.make || '')}${info.model ? ` · <span>${escapeHtml(info.model)}</span>` : ''}
                </div>
                <div class="wo-meta">
                  <span><span class="wo-meta-label">Status</span> <span class="wo-meta-val">${escapeHtml(st || '—')}</span></span>
                  <span><span class="wo-meta-label">Items</span> <span class="wo-meta-val">${escapeHtml(String(li.length))} (${escapeHtml(String(openCount))} open)</span></span>
                  <span><span class="wo-meta-label">Type</span> <span class="wo-meta-val">${escapeHtml(eqTypeLabel)}</span></span>
                  ${meter ? `<span><span class="wo-meta-label">Meter</span> <span class="wo-meta-val">${escapeHtml(meter)}</span></span>` : ''}
                  ${showDate ? `<span><span class="wo-meta-label">${completed ? 'Completed' : 'Created'}</span> <span class="wo-meta-val">${escapeHtml(formatDate(showDate))}</span></span>` : ''}
                </div>
              </div>

              <div class="wo-right">
                <div class="wo-helper" title="Work order created from a pre-check template">Pre-Season Check List</div>
              </div>
            </div>
          `;

          card.addEventListener('click', () => {
            STATE.selectedId = wo.id;
            void renderDetails();
          });

          g.appendChild(card);
        }

        host.appendChild(g);
      }

      const groups = new Map();
      for(const wo of normal){
        const info = woEquipInfo(wo);
        const key = (info.type || 'unknown').toLowerCase();
        if(!groups.has(key)) groups.set(key, []);
        groups.get(key).push(wo);
      }

      const orderedKeys = Array.from(groups.keys()).sort((a,b)=> a.localeCompare(b));

      for(const key of orderedKeys){
        const arr = groups.get(key) || [];
        const label = key === 'unknown' ? 'Unknown type' : titleCaseType(key);

        const g = document.createElement('div');
        g.className = 'group';
        g.innerHTML = `
          <div class="group-head">
            <h3 class="group-title">${escapeHtml(label)}</h3>
            <div class="group-sub">${arr.length} work order${arr.length===1?'':'s'}</div>
          </div>
        `;

        for(const wo of arr){
          const d = wo.data || {};
          const info = woEquipInfo(wo);

          const st = statusLabel(d.status);
          const created = toDateMaybe(d.createdAt);
          const completed = toDateMaybe(d.completedAt);
          const showDate = completed || created || d._sortDate || null;

          const li = Array.isArray(d.lineItems) ? d.lineItems : [];
          const openCount = li.filter(x => !x?.completed).length;

          const meter = (d.meterLabel && (d.completionMeter != null))
            ? `${d.meterLabel}: ${d.completionMeter}`
            : (d.meterLabel ? String(d.meterLabel) : '');

          const card = document.createElement('article');
          card.className = 'wo-card';
          card.dataset.id = wo.id;

          card.innerHTML = `
            <div class="wo-row-top">
              <div class="wo-main">
                <div class="wo-title">${escapeHtml(info.name || 'Equipment')}</div>
                <div class="wo-sub">
                  ${escapeHtml(info.make || '')}${info.model ? ` · <span>${escapeHtml(info.model)}</span>` : ''}
                </div>
                <div class="wo-meta">
                  <span><span class="wo-meta-label">Status</span> <span class="wo-meta-val">${escapeHtml(st || '—')}</span></span>
                  <span><span class="wo-meta-label">Items</span> <span class="wo-meta-val">${escapeHtml(String(li.length))} (${escapeHtml(String(openCount))} open)</span></span>
                  ${meter ? `<span><span class="wo-meta-label">Meter</span> <span class="wo-meta-val">${escapeHtml(meter)}</span></span>` : ''}
                  ${showDate ? `<span><span class="wo-meta-label">${completed ? 'Completed' : 'Created'}</span> <span class="wo-meta-val">${escapeHtml(formatDate(showDate))}</span></span>` : ''}
                </div>
              </div>
            </div>
          `;

          card.addEventListener('click', () => {
            STATE.selectedId = wo.id;
            void renderDetails();
          });

          g.appendChild(card);
        }

        host.appendChild(g);
      }
    }

    function clearDetails(){
      const panel = $('.wo-detail-panel');
      panel.style.display = 'none';
      panel.dataset.id = '';
      $('.wo-detail-title', panel).textContent = 'Work Order Details';
      $('.wo-detail-grid', panel).innerHTML = '';
      $('.wo-detail-notes-body', panel).textContent = '';
      $('.wo-detail-footer', panel).innerHTML = '';
      const liHost = $('#lineItemsHost', panel);
      if(liHost) liHost.innerHTML = '';
    }

    async function renderDetails(){
      const panel = $('.wo-detail-panel');
      const wo = (STATE.filtered || STATE.workOrders).find(x => x.id === STATE.selectedId) || STATE.workOrders.find(x => x.id === STATE.selectedId);
      if(!wo){ clearDetails(); return; }

      const d = wo.data || {};
      const info = woEquipInfo(wo);
      const isPre = isPreSeasonWO(d);

      // ✅ If pre-season, load template items so we can display label/notesHint even for older WOs
      const tplId = String(d.precheckTemplateId || d.preCheckTemplateId || '').trim();
      let tplItems = null;
      if(isPre && tplId){
        tplItems = await getPrecheckTemplateItems(tplId);
      }

      panel.dataset.id = wo.id;
      $('.wo-detail-title', panel).textContent = info.name || 'Work Order Details';

      const created = toDateMaybe(d.createdAt);
      const updated = toDateMaybe(d.updatedAt);
      const completed = toDateMaybe(d.completedAt);

      const st = statusLabel(d.status);
      const typeLabel = info.type ? titleCaseType(info.type) : '—';

      const meterLine = d.meterLabel
        ? (String(d.meterLabel) + ((d.completionMeter != null) ? (': ' + String(d.completionMeter)) : ''))
        : '—';

      const grid = $('.wo-detail-grid', panel);
      grid.innerHTML = `
        <div>
          <div class="wo-detail-item-label">Equipment Type</div>
          <div class="wo-detail-item-value">${escapeHtml(typeLabel)}</div>
        </div>

        <div>
          <div class="wo-detail-item-label">Status</div>
          <div class="wo-detail-item-value">${escapeHtml(st || '—')}</div>
        </div>

        <div>
          <div class="wo-detail-item-label">Make / Model</div>
          <div class="wo-detail-item-value">${escapeHtml([info.make, info.model].filter(Boolean).join(' ') || '—')}</div>
        </div>

        <div>
          <div class="wo-detail-item-label">Serial</div>
          <div class="wo-detail-item-value">${escapeHtml(info.serial || (info.serialLast6 ? `…${info.serialLast6}` : '—'))}</div>
        </div>

        <div>
          <div class="wo-detail-item-label">Meter</div>
          <div class="wo-detail-item-value">${escapeHtml(meterLine)}</div>
        </div>

        <div>
          <div class="wo-detail-item-label">Created</div>
          <div class="wo-detail-item-value">${escapeHtml(created ? formatDateTime(created) : '—')}</div>
        </div>

        <div>
          <div class="wo-detail-item-label">Updated</div>
          <div class="wo-detail-item-value">${escapeHtml(updated ? formatDateTime(updated) : '—')}</div>
        </div>

        <div>
          <div class="wo-detail-item-label">Completed</div>
          <div class="wo-detail-item-value">${escapeHtml(completed ? formatDateTime(completed) : '—')}</div>
        </div>
      `;

      $('.wo-detail-notes-body', panel).textContent = (d.summaryNotes || '').trim() || 'No summary notes recorded for this work order.';

      const liHost = $('#lineItemsHost', panel);
      const li = Array.isArray(d.lineItems) ? d.lineItems : [];
      liHost.innerHTML = '';

      if(!li.length){
        const box = document.createElement('div');
        box.className = 'wo-empty';
        box.textContent = 'No line items on this work order.';
        liHost.appendChild(box);
      }else{
        li.forEach((x, idx) => {
          const origin = String(x.origin || '').toLowerCase();
          const isPreSeasonItem = (origin === 'precheck_template');

          // ✅ Resolve template hit (id match first, else index) for older WOs
          let tplHit = null;
          if(isPreSeasonItem && tplItems && tplItems.length){
            const tplItemId = String(x.precheckTemplateItemId || '').trim();
            if(tplItemId){
              tplHit = tplItems.find(t => t.id === tplItemId) || null;
            }
            if(!tplHit && tplItems[idx]) tplHit = tplItems[idx];
          }

          const resolvedLabel =
            String(x.label || '').trim() ||
            String(tplHit?.label || '').trim() ||
            String(x.checkItem || x.item || x.title || '').trim();

          const resolvedNotesHint =
            String(x.notesHint || '').trim() ||
            String(tplHit?.notesHint || '').trim();

          const topic = isPreSeasonItem
            ? (resolvedLabel || `Pre-Inspection Item #${idx+1}`)
            : (x.serviceTopicOther ? String(x.serviceTopicOther) : titleCaseType(x.serviceTopic || 'Service'));

          const notes = isPreSeasonItem
            ? (resolvedNotesHint || '—')
            : ((x.notes || '').trim() || '—');

          const parts = isPreSeasonItem ? '' : ((x.partsNeeded || '').trim() || '—');

          const done = !!x.completed;
          const badge = done ? 'Completed' : 'Open';

          const submittedBy = (x.submittedByName || '').trim() || '—';
          const completedBy = (x.completedByEmployeeName || x.completedByEmployeeId || '').trim() || '—';

          const completedAt = toDateMaybe(x.completedAt);
          const completedAtStr = completedAt ? formatDateTime(completedAt) : '—';

          const el = document.createElement('div');
          el.className = 'li';
          el.innerHTML = `
            <div class="li-top">
              <div class="li-title">
                ${escapeHtml(topic)}
                ${isPreSeasonItem ? '' : ` <span style="opacity:.65;font-weight:800">#${idx+1}</span>`}
              </div>
              <div class="li-badge ${done ? '' : 'open'}">${escapeHtml(badge)}</div>
            </div>

            <div class="li-meta">
              <div class="pair"><div class="kk">Submitted By</div><div class="vv">${escapeHtml(submittedBy)}</div></div>
              <div class="pair"><div class="kk">Completed By</div><div class="vv">${escapeHtml(completedBy)}</div></div>
              ${isPreSeasonItem ? '' : `<div class="pair"><div class="kk">Parts Needed</div><div class="vv">${escapeHtml(parts)}</div></div>`}
              <div class="pair"><div class="kk">Completed At</div><div class="vv">${escapeHtml(completedAtStr)}</div></div>
              <div class="pair notes">
                <div class="kk">${isPreSeasonItem ? 'Guidance' : 'Notes'}</div>
                <div class="vv">${escapeHtml(notes || '—')}</div>
              </div>
            </div>
          `;
          liHost.appendChild(el);
        });
      }

      const openCount = li.filter(x => !x?.completed).length;
      const doneCount = li.filter(x => !!x?.completed).length;

      const footer = $('.wo-detail-footer', panel);
      footer.innerHTML = `
        <span>Current status:</span>
        ${isPre ? `<span class="wo-detail-pill preseason">Pre-Season WO</span>` : ''}
        <span class="wo-detail-pill">${escapeHtml(st || '—')}</span>
        <span class="wo-detail-pill">${escapeHtml(String(li.length))} items</span>
        <span class="wo-detail-pill">${escapeHtml(String(openCount))} open</span>
        <span class="wo-detail-pill">${escapeHtml(String(doneCount))} completed</span>
      `;

      panel.style.display = 'flex';
    }

    async function loadCompanyHeader(){
      if (STATE.company) return STATE.company;
      try{
        const [col,id] = CONFIG.COMPANY_DOC_PATH;
        const ref = doc(STATE.db, col, id);
        const snap = await getDoc(ref);
        const d = snap.exists() ? (snap.data() || {}) : {};
        const name = d.name || '';
        const address = [
          d.addressStreet || '',
          [d.addressCity, d.addressState].filter(Boolean).join(', '),
          d.addressZip || ''
        ].filter(Boolean).join(' · ');
        const phone = d.phone || '';
        const email = d.email || '';
        STATE.company = { name, address, phone, email };
      }catch(e){
        console.warn('[maintenance-records] failed to load company header', e);
        STATE.company = { name:'', address:'', phone:'', email:'' };
      }
      return STATE.company;
    }

    async function loadActiveEquipment(){
      const ref = collection(STATE.db, CONFIG.EQUIPMENT);
      const snap = await getDocs(ref);

      const byId = new Map();
      snap.docs.forEach(ds => {
        const d = ds.data() || {};
        const st = String(d.status || '').trim().toLowerCase();
        if(st !== 'active') return; // active only
        byId.set(ds.id, { id: ds.id, ...d });
      });

      STATE.equipmentById = byId;
    }

    async function loadWorkOrders(){
      const ref = collection(STATE.db, CONFIG.WORKORDERS);
      const snap = await getDocs(ref);

      const items = snap.docs.map(ds => {
        const data = ds.data() || {};
        const sortDate = getSortDateForWO(data);
        return { id: ds.id, data: { ...data, _sortDate: sortDate } };
      });

      STATE.workOrders = items.filter(x => {
        const eqId = x.data?.equipmentId || '';
        return !!(eqId && STATE.equipmentById.has(eqId));
      });

      STATE.workOrders.sort((a,b) => {
        const ta = a.data._sortDate ? a.data._sortDate.getTime() : 0;
        const tb = b.data._sortDate ? b.data._sortDate.getTime() : 0;
        return tb - ta;
      });
    }

    function wireFilterEvents(){
      const statusSel = $('#filterStatus');
      const typeSel   = $('#filterType');
      const equipSel  = $('#filterEquip');
      const searchEl  = $('#filterSearch');
      const clearBtn  = $('#filterClear');

      if(statusSel) statusSel.addEventListener('change', applyFilters);

      if(typeSel){
        typeSel.addEventListener('change', () => {
          hydrateEquipmentDropdown();
          applyFilters();
        });
      }

      if(equipSel) equipSel.addEventListener('change', applyFilters);
      if(searchEl) searchEl.addEventListener('input', applyFilters);

      if(clearBtn){
        clearBtn.addEventListener('click', () => location.reload());
      }
    }

    /* ===========================
       PRINT MODAL + REPORTS
       =========================== */

    let __fvPrintModalLastFocus = null;

    function __fvFocusFirstIn(el){
      if(!el) return;
      const first = el.querySelector(
        'button:not([disabled]), [href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])'
      );
      (first || el).focus?.();
    }

    function __fvRestoreFocus(){
      const t = __fvPrintModalLastFocus;
      __fvPrintModalLastFocus = null;
      if(t && typeof t.focus === 'function'){
        try{ t.focus(); return; }catch(_){}
      }
      const fb = document.getElementById('btnPrint') || document.getElementById('btnPrintBottom');
      fb?.focus?.();
    }

    function openPrintModal(){
      const items = STATE.filtered || [];
      if(!items.length){
        alert('No work orders match the current filters to print.');
        return;
      }

      const b = $('#print-modal-backdrop');
      if(!b) return;

      __fvPrintModalLastFocus = document.activeElement;

      b.classList.remove('modal-hidden');
      b.setAttribute('aria-hidden','false');

      const modal = b.querySelector('.modal');
      if(modal) modal.removeAttribute('inert');

      __fvFocusFirstIn(modal || b);
    }

    function closePrintModal(){
      const b = $('#print-modal-backdrop');
      if(!b) return;

      const modal = b.querySelector('.modal');

      __fvRestoreFocus();

      if(modal) modal.setAttribute('inert','');

      b.classList.add('modal-hidden');
      b.setAttribute('aria-hidden','true');
    }

    function groupForPrint(items){
      const typeMap = new Map();

      for(const wo of items){
        const info = woEquipInfo(wo);
        const typeKey = (info.type || 'unknown').toLowerCase();
        const equipKey = info.equipId || (info.name || 'unknown');

        if(!typeMap.has(typeKey)) typeMap.set(typeKey, new Map());
        const eqMap = typeMap.get(typeKey);

        if(!eqMap.has(equipKey)){
          eqMap.set(equipKey, {
            equipId: info.equipId,
            name: info.name || 'Equipment',
            make: info.make || '',
            model: info.model || '',
            serial: info.serial || (info.serialLast6 ? `…${info.serialLast6}` : ''),
            workOrders: []
          });
        }

        eqMap.get(equipKey).workOrders.push(wo);
      }

      const typeEntries = Array.from(typeMap.entries()).sort((a,b)=>a[0].localeCompare(b[0]));
      return typeEntries.map(([typeKey, eqMap]) => {
        const eqEntries = Array.from(eqMap.values()).sort((a,b)=> (a.name||'').localeCompare(b.name||''));
        eqEntries.forEach(e => {
          e.workOrders.sort((a,b)=>{
            const ta = a.data._sortDate ? a.data._sortDate.getTime() : 0;
            const tb = b.data._sortDate ? b.data._sortDate.getTime() : 0;
            return tb - ta;
          });
        });
        return [typeKey, eqEntries];
      });
    }

    function summarizeFilters(){
      const { status, type, equip, q } = getFilters();
      const parts = [];

      parts.push(status === 'all' ? 'All statuses' : `Status: ${statusLabel(status)}`);
      parts.push(type === 'all' ? 'All types' : `Type: ${titleCaseType(type)}`);

      if(equip === 'all') parts.push('All equipment');
      else{
        const eq = STATE.equipmentById.get(equip) || null;
        parts.push(eq ? `Equipment: ${equipDisplay(eq)}` : 'Equipment: selected');
      }

      parts.push(q ? `Search: "${q}"` : 'No search');
      return parts.join(' • ');
    }

    function computeDateRange(items){
      if(!items.length) return '';
      let min = Infinity, max = -Infinity;
      items.forEach(wo=>{
        const d = wo.data?._sortDate || null;
        if(!d) return;
        const t = d.getTime();
        if(t < min) min = t;
        if(t > max) max = t;
      });
      if(!Number.isFinite(min) || !Number.isFinite(max)) return '';
      const a = new Date(min);
      const b = new Date(max);
      if(a.toDateString() === b.toDateString()) return formatDate(a);
      return `${formatDate(a)} – ${formatDate(b)}`;
    }

    function buildSummaryPrintHtml({ company, runStr, runDateOnly, filterSummary, dateRange, counts, grouped, preseasonCount }){
  return `<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Equipment Maintenance — Summary</title>
  <style>
    :root{
      --fv-green:#3B7E46;
      --fv-border:#D1D5DB;
      --fv-text:#111827;
      --fv-muted:#6B7280;
      --fv-bg:#F3F4F6;
    }
    *{box-sizing:border-box;}
    html,body{ margin:0; padding:0; font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; color:var(--fv-text); background:var(--fv-bg); }
    body{ display:flex; justify-content:center; padding:22px 12px; }
    .page{ width:100%; max-width:920px; background:#fff; border-radius:14px; box-shadow:0 10px 30px rgba(15,23,42,0.12); padding:20px 22px 22px; }
    .hdr{ display:grid; grid-template-columns:auto 1fr auto; gap:14px; align-items:center; border-bottom:2px solid var(--fv-green); padding-bottom:12px; margin-bottom:14px; }
    .logo{ width:60px;height:60px;border-radius:16px; border:1px solid var(--fv-border); display:flex;align-items:center;justify-content:center; font-size:24px;font-weight:900;color:#fff; background:radial-gradient(circle at 30% 0%, #4CAF50, var(--fv-green)); }
    .co-name{font-size:16px;font-weight:900;margin:0 0 2px;}
    .co-line{font-size:11px;color:var(--fv-muted);margin:0;line-height:1.35;}
    .meta{ text-align:right; font-size:11px; color:var(--fv-muted); line-height:1.35; white-space:nowrap; }
    .meta strong{color:var(--fv-text);}
    .title{ margin:0; font-size:18px; font-weight:950; letter-spacing:0.06em; text-transform:uppercase; }
    .subtitle{ margin:4px 0 0; font-size:12px; color:var(--fv-muted); line-height:1.35; }

    .summary{
      margin-top:10px;
      padding:8px 10px;
      border-radius:12px;
      background:linear-gradient(90deg, rgba(59,126,70,0.10), transparent);
      border:1px solid rgba(59,126,70,0.22);
      display:flex;
      flex-wrap:wrap;
      gap:6px 14px;
      font-size:11px;
    }
    .pill{display:inline-flex; gap:6px; align-items:baseline; white-space:nowrap;}
    .k{font-size:10px; text-transform:uppercase; letter-spacing:0.10em; color:var(--fv-muted); font-weight:700;}
    .v{font-weight:800; color:var(--fv-text);}

    .kpis{ margin-top:12px; display:grid; grid-template-columns:repeat(5, minmax(0,1fr)); gap:10px; }
    .kpi{ border:1px solid var(--fv-border); border-radius:12px; padding:9px 10px; background:linear-gradient(135deg, rgba(59,126,70,0.06), #fff); }
    .kpi .lab{font-size:10px;text-transform:uppercase;letter-spacing:0.10em;color:var(--fv-muted);font-weight:900;}
    .kpi .val{font-size:18px;font-weight:950;margin-top:2px;}
    .kpi .note{font-size:10px;color:var(--fv-muted);margin-top:2px;line-height:1.25;}

    .section{ margin-top:16px; border-top:1px solid #EEF2F7; padding-top:14px; }
    .type-title{ font-size:12px; font-weight:950; letter-spacing:0.10em; text-transform:uppercase; color:#1F2937; margin:0 0 8px; display:flex; justify-content:space-between; gap:10px; align-items:baseline; }
    .equip-card{ border:1px solid var(--fv-border); border-radius:12px; padding:10px 10px 9px; margin-bottom:10px; break-inside:avoid; }
    .equip-name{ font-weight:950; font-size:13px; line-height:1.25; }
    .equip-sub{ margin-top:2px; font-size:11px; color:var(--fv-muted); }

    /* ✅ NEW: per-equipment origin tags */
    .wo-tags{ margin-top:8px; display:flex; flex-wrap:wrap; gap:6px; }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid #E5E7EB;
      background:#F9FAFB;
      font-size:10px;
      font-weight:950;
      letter-spacing:0.08em;
      text-transform:uppercase;
      color:#111827;
      white-space:nowrap;
    }
    .tag .n{
      font-size:10px;
      font-weight:950;
      letter-spacing:0.02em;
      text-transform:none;
      color:var(--fv-muted);
    }
    .tag.pre{
      border-color: rgba(59,126,70,0.28);
      background: rgba(59,126,70,0.08);
    }
    .tag.req{
      border-color: rgba(17,24,39,0.18);
      background: rgba(17,24,39,0.04);
    }

    .footer{ margin-top:16px; padding-top:10px; border-top:1px solid var(--fv-border); display:flex; justify-content:space-between; gap:12px; font-size:10px; color:var(--fv-muted); line-height:1.3; }
    .footer .l{max-width:65%;}
    .footer .r{text-align:right;}
    @media (max-width:860px){
      .kpis{grid-template-columns:repeat(2, minmax(0,1fr));}
      .meta{white-space:normal;}
    }
    @media print{
      html,body{background:#fff;padding:0;}
      .page{ max-width:none; border-radius:0; box-shadow:none; padding:12mm 13mm; }
      .equip-card{break-inside:avoid; page-break-inside:avoid;}
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="hdr">
      <div class="logo"><span>DF</span></div>
      <div>
        <p class="co-name">${escapeHtml(company.name || '')}</p>
        <p class="co-line">
          ${company.address ? escapeHtml(company.address) + '<br>' : ''}
          ${company.phone ? 'Phone: ' + escapeHtml(company.phone) : ''}${company.phone && company.email ? ' · ' : ''}
          ${company.email ? 'Email: ' + escapeHtml(company.email) : ''}
        </p>
      </div>
      <div class="meta">
        <div><strong>Equipment Maintenance</strong></div>
        <div>Generated: ${escapeHtml(runStr)}</div>
        <div>Prepared by: ${escapeHtml(company.name || 'FarmVista')}</div>
      </div>
    </header>

    <h1 class="title">Equipment Maintenance — Summary</h1>
    <p class="subtitle">Summary of work orders for active equipment, grouped by type and equipment. Matches current filters.</p>

    <div class="summary">
      <div class="pill"><span class="k">Date range</span><span class="v">${escapeHtml(dateRange || 'All dates')}</span></div>
      <div class="pill"><span class="k">Filters</span><span class="v">${escapeHtml(filterSummary)}</span></div>
    </div>

    <div class="kpis">
      <div class="kpi">
        <div class="lab">Work orders</div>
        <div class="val">${counts.total}</div>
        <div class="note">Matching current filters</div>
      </div>

      <div class="kpi">
        <div class="lab">Pending</div>
        <div class="val">${counts.pending}</div>
      </div>

      <div class="kpi">
        <div class="lab">In progress</div>
        <div class="val">${counts.ip}</div>
      </div>

      <div class="kpi">
        <div class="lab">Completed</div>
        <div class="val">${counts.done}</div>
      </div>

      <div class="kpi">
        <div class="lab">Pre-Season Checks</div>
        <div class="val">${Number(preseasonCount || 0)}</div>
        <div class="note">From pre-check templates</div>
      </div>
    </div>

    ${grouped.map(([typeKey, equipmentArr]) => {
      const typeLabel = typeKey === 'unknown' ? 'Unknown type' : titleCaseType(typeKey);
      const typeTotal = equipmentArr.reduce((sum, e) => sum + (e.workOrders?.length || 0), 0);

      return `
      <section class="section">
        <div class="type-title">
          <span>${escapeHtml(typeLabel)}</span>
          <span style="font-size:11px;color:var(--fv-muted);letter-spacing:0.06em;text-transform:none;font-weight:900;">${typeTotal} total</span>
        </div>

        ${equipmentArr.map(e => {
          const wos = Array.isArray(e.workOrders) ? e.workOrders : [];
          const preCount = wos.filter(wo => isPreSeasonWO(wo && wo.data)).length;
          const reqCount = Math.max(0, wos.length - preCount);

          return `
            <div class="equip-card">
              <div class="equip-name">${escapeHtml(e.name || 'Equipment')}</div>
              <div class="equip-sub">${escapeHtml([e.make, e.model].filter(Boolean).join(' ') || '')}${e.serial ? ` · Serial: ${escapeHtml(e.serial)}` : ''}</div>

              <div class="wo-tags" aria-label="Work order origin">
                ${reqCount ? `<span class="tag req">Service Request</span>` : ''}
                ${preCount ? `<span class="tag pre">Pre-Season Check List</span>` : ''}
                ${(!reqCount && !preCount) ? `<span class="tag req">No work orders <span class="n">(0)</span></span>` : ''}
              </div>
            </div>
          `;
        }).join('')}
      </section>
      `;
    }).join('')}

    <footer class="footer">
      <div class="l">Summary report. Line-item details are available in the detailed report.</div>
      <div class="r">FarmVista • Equipment Maintenance • ${escapeHtml(runDateOnly || '')}</div>
    </footer>
  </div>
</body>
</html>`;
}

function buildDetailedPrintHtml({ company, runStr, runDateOnly, filterSummary, dateRange, counts, grouped }){
  return `<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Equipment Maintenance — Detailed</title>
  <style>
    :root{
      --fv-green:#3B7E46;
      --fv-border:#D1D5DB;
      --fv-text:#111827;
      --fv-muted:#6B7280;
      --fv-bg:#F3F4F6;
    }
    *{box-sizing:border-box;}
    html,body{
      margin:0;
      padding:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      color:var(--fv-text);
      background:var(--fv-bg);
    }

    body{
      display:flex;
      justify-content:center;
      padding:12px 10px;
    }

    .page{
      width:100%;
      max-width:1020px;
      background:#fff;
      border-radius:12px;
      box-shadow:0 10px 26px rgba(15,23,42,0.10);
      padding:14px 16px 16px;
    }

    .hdr{
      display:grid;
      grid-template-columns:auto 1fr auto;
      gap:10px;
      align-items:center;
      border-bottom:2px solid var(--fv-green);
      padding-bottom:8px;
      margin-bottom:10px;
    }
    .logo{
      width:46px;height:46px;
      border-radius:12px;
      border:1px solid var(--fv-border);
      display:flex;align-items:center;justify-content:center;
      font-size:18px;font-weight:900;color:#fff;
      background:radial-gradient(circle at 30% 0%, #4CAF50, var(--fv-green));
      flex:0 0 auto;
    }
    .co-name{font-size:13px;font-weight:900;margin:0 0 1px;}
    .co-line{font-size:10px;color:var(--fv-muted);margin:0;line-height:1.25;}
    .meta{
      text-align:right;
      font-size:10px;
      color:var(--fv-muted);
      line-height:1.25;
      white-space:nowrap;
    }
    .meta strong{color:var(--fv-text);}

    .title{
      margin:0;
      font-size:15px;
      font-weight:950;
      letter-spacing:0.06em;
      text-transform:uppercase;
    }
    .subtitle{
      margin:3px 0 0;
      font-size:11px;
      color:var(--fv-muted);
      line-height:1.25;
    }

    .summary{
      margin-top:8px;
      padding:6px 8px;
      border-radius:10px;
      background:linear-gradient(90deg, rgba(59,126,70,0.08), transparent);
      border:1px solid rgba(59,126,70,0.20);
      display:flex;
      flex-wrap:wrap;
      gap:4px 10px;
      font-size:10px;
    }
    .pill{display:inline-flex; gap:6px; align-items:baseline; white-space:nowrap;}
    .k{
      font-size:9px;
      text-transform:uppercase;
      letter-spacing:0.10em;
      color:var(--fv-muted);
      font-weight:800;
      white-space:nowrap;
    }
    .v{font-weight:900; color:var(--fv-text); white-space:nowrap;}

    .kpis{
      margin-top:8px;
      display:grid;
      grid-template-columns:repeat(4, minmax(0,1fr));
      gap:8px;
    }
    .kpi{
      border:1px solid var(--fv-border);
      border-radius:10px;
      padding:7px 8px;
      background:linear-gradient(135deg, rgba(59,126,70,0.05), #fff);
    }
    .kpi .lab{
      font-size:9px;
      text-transform:uppercase;
      letter-spacing:0.10em;
      color:var(--fv-muted);
      font-weight:900;
      line-height:1.1;
      white-space:nowrap;
    }
    .kpi .val{
      font-size:15px;
      font-weight:950;
      margin-top:1px;
      line-height:1.05;
      white-space:nowrap;
    }

    .section{ margin-top:12px; border-top:1px solid #EEF2F7; padding-top:10px; }
    .type-title{
      font-size:11px;
      font-weight:950;
      letter-spacing:0.10em;
      text-transform:uppercase;
      color:#1F2937;
      margin:0 0 8px;
      white-space:nowrap;
    }
    .equip-title{
      margin:10px 0 4px;
      font-size:11px;
      font-weight:950;
      color:#111827;
      line-height:1.2;
    }
    .equip-sub{
      margin:0 0 6px;
      font-size:10px;
      color:var(--fv-muted);
      line-height:1.2;
    }

    .wo{
      border:1px solid var(--fv-border);
      border-radius:10px;
      padding:8px 8px 7px;
      margin-bottom:8px;
      break-inside:auto;
      page-break-inside:auto;
    }

    .wo-head{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      padding-bottom:6px;
      border-bottom:1px solid #EEF2F7;
      margin-bottom:6px;
    }
    .wo-title{
      font-weight:950;
      font-size:12px;
      line-height:1.2;
    }

    .badge{
      font-size:9px;
      font-weight:950;
      letter-spacing:0.08em;
      text-transform:uppercase;
      padding:3px 7px;
      border-radius:999px;
      border:1px solid rgba(59,126,70,0.26);
      background:rgba(59,126,70,0.06);
      color:#0F172A;
      white-space:nowrap;
      word-break:keep-all;
      overflow-wrap:normal;
      flex:0 0 auto;
    }
    .badge.open{ border-color: rgba(234,179,8,0.35); background: rgba(234,179,8,0.10); }

    .wo-meta{
      display:grid;
      grid-template-columns:repeat(4, minmax(0,1fr));
      gap:6px 8px;
      font-size:10px;
    }
    .pair .kk{
      font-size:9px;
      text-transform:uppercase;
      letter-spacing:0.10em;
      color:var(--fv-muted);
      font-weight:900;
      margin-bottom:1px;
      line-height:1.1;
      white-space:nowrap;
    }
    .pair .vv{
      font-weight:650;
      color:#111827;
      line-height:1.15;
      word-break:break-word;
    }

    .lines{ margin-top:6px; padding-top:6px; border-top:1px dashed #E5E7EB; }

    .line{
      border:1px solid #E5E7EB;
      border-radius:9px;
      padding:7px 7px 6px;
      margin-top:7px;
      break-inside:avoid;
      page-break-inside:avoid;
    }
    .line-top{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      margin-bottom:6px;
    }
    .line-title{
      font-weight:900;
      font-size:11px;
      line-height:1.2;
    }
    .line-badge{
      font-size:9px;
      font-weight:950;
      letter-spacing:0.08em;
      text-transform:uppercase;
      padding:3px 7px;
      border-radius:999px;
      border:1px solid rgba(59,126,70,0.26);
      background:rgba(59,126,70,0.06);
      white-space:nowrap;
      word-break:keep-all;
      overflow-wrap:normal;
      flex:0 0 auto;
    }
    .line-badge.open{ border-color: rgba(234,179,8,0.35); background: rgba(234,179,8,0.10); }

    .line-grid{
      display:grid;
      grid-template-columns:repeat(4, minmax(0,1fr));
      gap:6px 8px;
      font-size:10px;
    }
    .line-notes{
      grid-column:1/-1;
      margin-top:5px;
      padding-top:5px;
      border-top:1px dashed #E5E7EB;
      white-space:pre-wrap;
      line-height:1.2;
      font-size:10px;
    }

    .footer{
      margin-top:12px;
      padding-top:8px;
      border-top:1px solid var(--fv-border);
      display:flex;
      justify-content:space-between;
      gap:12px;
      font-size:9px;
      color:var(--fv-muted);
      line-height:1.25;
    }
    .footer .l{max-width:65%;}
    .footer .r{text-align:right;}

    @media (max-width:860px){
      .kpis{grid-template-columns:repeat(2, minmax(0,1fr));}
      .meta{white-space:normal;}
      .wo-meta{grid-template-columns:repeat(2, minmax(0,1fr));}
      .line-grid{grid-template-columns:repeat(2, minmax(0,1fr));}
    }

    @media print{
      html,body{background:#fff;padding:0;}
      body{padding:0;}
      .page{
        max-width:none;
        border-radius:0;
        box-shadow:none;
        padding:9mm 10mm;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="hdr">
      <div class="logo"><span>DF</span></div>
      <div>
        <p class="co-name">${escapeHtml(company.name || '')}</p>
        <p class="co-line">
          ${company.address ? escapeHtml(company.address) + '<br>' : ''}
          ${company.phone ? 'Phone: ' + escapeHtml(company.phone) : ''}${company.phone && company.email ? ' · ' : ''}
          ${company.email ? 'Email: ' + escapeHtml(company.email) : ''}
        </p>
      </div>
      <div class="meta">
        <div><strong>Equipment Maintenance</strong></div>
        <div>Generated: ${escapeHtml(runStr)}</div>
        <div>Prepared by: ${escapeHtml(company.name || 'FarmVista')}</div>
      </div>
    </header>

    <h1 class="title">Equipment Maintenance — Detailed</h1>
    <p class="subtitle">Detailed work orders and line items for active equipment. Matches current filters. Layout optimized to reduce page breaks; long work orders may continue on the next page.</p>

    <div class="summary">
      <div class="pill"><span class="k">Date range</span><span class="v">${escapeHtml(dateRange || 'All dates')}</span></div>
      <div class="pill"><span class="k">Filters</span><span class="v">${escapeHtml(filterSummary)}</span></div>
    </div>

    <div class="kpis">
      <div class="kpi"><div class="lab">Work orders</div><div class="val">${counts.total}</div></div>
      <div class="kpi"><div class="lab">Pending</div><div class="val">${counts.pending}</div></div>
      <div class="kpi"><div class="lab">In progress</div><div class="val">${counts.ip}</div></div>
      <div class="kpi"><div class="lab">Completed</div><div class="val">${counts.done}</div></div>
    </div>

    ${grouped.map(([typeKey, equipmentArr]) => {
      const typeLabel = typeKey === 'unknown' ? 'Unknown type' : titleCaseType(typeKey);
      return `
      <section class="section">
        <div class="type-title">${escapeHtml(typeLabel)}</div>

        ${equipmentArr.map(e => {
          const wos = e.workOrders || [];
          return `
            <div class="equip-title">${escapeHtml(e.name || 'Equipment')}</div>
            <div class="equip-sub">${escapeHtml([e.make, e.model].filter(Boolean).join(' ') || '')}${e.serial ? ` · Serial: ${escapeHtml(e.serial)}` : ''}</div>

            ${wos.map(wo => {
              const d = wo.data || {};
              const stNorm = normalizeStatus(d.status);
              const st = statusLabel(d.status);
              const created = d.createdAt ? formatDateTime(toDateMaybe(d.createdAt)) : '—';
              const updated = d.updatedAt ? formatDateTime(toDateMaybe(d.updatedAt)) : '—';
              const completedAt = d.completedAt ? formatDateTime(toDateMaybe(d.completedAt)) : '—';

              const meterLine = d.meterLabel
                ? (String(d.meterLabel) + ((d.completionMeter != null) ? (': ' + String(d.completionMeter)) : ''))
                : '—';

              const lineItems = Array.isArray(d.lineItems) ? d.lineItems : [];
              const openCount = lineItems.filter(x=>!x?.completed).length;

              return `
                <article class="wo">
                  <div class="wo-head">
                    <div class="wo-title">Work Order (${lineItems.length} items, ${openCount} open)</div>
                    <div class="badge ${stNorm==='completed' ? '' : 'open'}">${escapeHtml(st)}</div>
                  </div>

                  <div class="wo-meta">
                    <div class="pair"><div class="kk">Meter</div><div class="vv">${escapeHtml(meterLine)}</div></div>
                    <div class="pair"><div class="kk">Created</div><div class="vv">${escapeHtml(created || '—')}</div></div>
                    <div class="pair"><div class="kk">Updated</div><div class="vv">${escapeHtml(updated || '—')}</div></div>
                    <div class="pair"><div class="kk">Completed</div><div class="vv">${escapeHtml(completedAt || '—')}</div></div>
                  </div>

                  ${d.summaryNotes ? `<div class="lines"><div class="pair"><div class="kk">Summary notes</div><div class="vv">${escapeHtml(String(d.summaryNotes))}</div></div></div>` : ''}

                  <div class="lines">
                    ${lineItems.map((li, idx) => {
                      const origin = String(li.origin || '').toLowerCase();
                      const isPreSeasonItem = (origin === 'precheck_template');

                      const topic = isPreSeasonItem
                        ? (String(li.label || li.checkItem || li.item || li.title || '').trim() || `Pre-Inspection Item #${idx+1}`)
                        : (li.serviceTopicOther ? String(li.serviceTopicOther) : titleCaseType(li.serviceTopic || 'Service'));

                      const parts = isPreSeasonItem ? '' : ((li.partsNeeded || '').trim() || '—');

                      const notes = isPreSeasonItem
                        ? (String(li.notesHint || '').trim() || '—')
                        : ((li.notes || '').trim() || '—');

                      const isDone = !!li.completed;
                      const badge = isDone ? 'Completed' : 'Open';
                      const submittedBy = (li.submittedByName || '').trim() || '—';
                      const completedBy = (li.completedByEmployeeName || li.completedByEmployeeId || '').trim() || '—';
                      const doneAt = li.completedAt ? formatDateTime(toDateMaybe(li.completedAt)) : '—';

                      return `
                        <div class="line">
                          <div class="line-top">
                            <div class="line-title">
                              ${escapeHtml(topic)}
                              ${isPreSeasonItem ? '' : ` <span style="opacity:.65;font-weight:800">#${idx+1}</span>`}
                            </div>
                            <div class="line-badge ${isDone ? '' : 'open'}">${escapeHtml(badge)}</div>
                          </div>
                          <div class="line-grid">
                            <div class="pair"><div class="kk">Submitted by</div><div class="vv">${escapeHtml(submittedBy)}</div></div>
                            <div class="pair"><div class="kk">Completed by</div><div class="vv">${escapeHtml(completedBy)}</div></div>
                            ${isPreSeasonItem ? '' : `<div class="pair"><div class="kk">Parts</div><div class="vv">${escapeHtml(parts)}</div></div>`}
                            <div class="pair"><div class="kk">Completed at</div><div class="vv">${escapeHtml(doneAt)}</div></div>
                            <div class="line-notes"><span class="kk" style="display:block;margin-bottom:2px;">${isPreSeasonItem ? 'Guidance' : 'Notes'}</span>${escapeHtml(notes)}</div>
                          </div>
                        </div>
                      `;
                    }).join('')}
                  </div>
                </article>
              `;
            }).join('')}
          `;
        }).join('')}
      </section>
      `;
    }).join('')}

    <footer class="footer">
      <div class="l">Detailed report includes work orders and line items. Data reflects what is stored in FarmVista.</div>
      <div class="r">FarmVista • Equipment Maintenance • ${escapeHtml(runDateOnly || '')}</div>
    </footer>
  </div>
</body>
</html>`;
}


    async function printHtml(html, fileName, title){
      if (window.FVPdf && typeof window.FVPdf.openHtml === 'function') {
        try{
          window.FVPdf.openHtml({ html, fileName, title });
          return;
        }catch(err){
          console.warn('[maintenance-records] FVPdf.openHtml failed, falling back to native print()', err);
        }
      }

      let iframe = document.getElementById('fv-print-frame');
      if(!iframe){
        iframe = document.createElement('iframe');
        iframe.id = 'fv-print-frame';
        document.body.appendChild(iframe);
      }

      const win = iframe.contentWindow || iframe.contentDocument;
      const docu = iframe.contentDocument || iframe.contentWindow.document;

      docu.open();
      docu.write(html);
      docu.close();

      setTimeout(() => {
        try{ win.focus(); win.print(); }
        catch(err){
          console.warn('[maintenance-records] iframe print failed, falling back to window.print()', err);
          window.print();
        }
      }, 400);
    }

    async function runSummaryPrint(){
      const items = STATE.filtered || [];
      if(!items.length) return;

      const company = await loadCompanyHeader();
      const now = new Date();
      const runStr = formatDateTime(now);
      const runDateOnly = formatDate(now);

      const counts = computeCounts(items);
      const grouped = groupForPrint(items);
      const filterSummary = summarizeFilters();
      const dateRange = computeDateRange(items);

      const preseasonCount = items.filter(wo => isPreSeasonWO(wo.data)).length;

      const html = buildSummaryPrintHtml({
        company,
        runStr,
        runDateOnly,
        filterSummary,
        dateRange,
        counts,
        grouped,
        preseasonCount
      });

      const fileName = `equipment_maintenance_summary_${now.toISOString().slice(0,10)}.pdf`;

      await printHtml(html, fileName, 'Equipment Maintenance — Summary');
    }

    async function runDetailedPrint(){
      const items = STATE.filtered || [];
      if(!items.length) return;

      const company = await loadCompanyHeader();
      const now = new Date();
      const runStr = formatDateTime(now);
      const runDateOnly = formatDate(now);

      const counts = computeCounts(items);
      const grouped = groupForPrint(items);
      const filterSummary = summarizeFilters();
      const dateRange = computeDateRange(items);

      const html = buildDetailedPrintHtml({ company, runStr, runDateOnly, filterSummary, dateRange, counts, grouped });
      const fileName = `equipment_maintenance_detailed_${now.toISOString().slice(0,10)}.pdf`;

      await printHtml(html, fileName, 'Equipment Maintenance — Detailed');
    }

    function wirePrintModal(){
      const topBtn = $('#btnPrint');
      const bottomBtn = $('#btnPrintBottom');
      const closeBtn = $('#printModalClose');
      const sumBtn = $('#printSummaryBtn');
      const detBtn = $('#printDetailedBtn');
      const backdrop = $('#print-modal-backdrop');

      if(topBtn) topBtn.addEventListener('click', openPrintModal);
      if(bottomBtn) bottomBtn.addEventListener('click', openPrintModal);

      if(closeBtn) closeBtn.addEventListener('click', closePrintModal);

      if(backdrop){
        const modal = backdrop.querySelector('.modal');
        if(modal){
          modal.addEventListener('click', (e) => e.stopPropagation());
        }

        backdrop.addEventListener('click', (evt) => {
          if(evt.target === backdrop) closePrintModal();
        });
      }

      if(sumBtn){
        sumBtn.addEventListener('click', async () => {
          closePrintModal();
          await runSummaryPrint();
        });
      }

      if(detBtn){
        detBtn.addEventListener('click', async () => {
          closePrintModal();
          await runDetailedPrint();
        });
      }

      document.addEventListener('keydown', (evt) => {
        if(evt.key === 'Escape'){
          if(backdrop && !backdrop.classList.contains('modal-hidden')) closePrintModal();
        }
      });
    }

    (async function boot(){
      await ready;
      STATE.db = getFirestore();

      const shell = document.querySelector('fv-shell');
      if(shell) shell.nav = NAV_MENU;

      const backBtn = document.getElementById('btnBack');
      if(backBtn){
        backBtn.addEventListener('click', () => {
          if(history.length > 1) history.back();
          else location.href = '/Farm-vista/pages/equipment/index.html';
        });
      }

      $('#woDetailClose').addEventListener('click', () => {
        STATE.selectedId = null;
        clearDetails();
      });

      wirePrintModal();

      try{
        await loadActiveEquipment();
        await loadWorkOrders();

        const statusSel = $('#filterStatus');
        if(statusSel) statusSel.value = 'all';

        hydrateTypeDropdown();
        hydrateEquipmentDropdown();
        wireFilterEvents();
        applyFilters();

        const emptyEl = $('.wo-empty');
        if(emptyEl && (STATE.workOrders?.length || 0) === 0){
          emptyEl.style.display = 'block';
          emptyEl.textContent = 'No work orders found for active equipment.';
        }
      }catch(err){
        console.error('[maintenance-records] load failed:', err);
        const emptyEl = $('.wo-empty');
        emptyEl.style.display = 'block';
        emptyEl.textContent = 'Error loading maintenance records. Check console or Firestore rules / collection names.';
        const countEl = $('#woCount');
        if(countEl) countEl.textContent = 'Error loading records';
      }
    })();
  </script>
</head>

<body>
  <fv-shell>
    <div class="wrap">
      <section class="hero">
        <header class="hero-head">
          <div class="icon" aria-hidden="true">🛠️</div>
          <div>
            <h1>Equipment Maintenance — Work Orders</h1>
            <p class="muted">
              View service work orders for active equipment. Filter by status, type, and equipment, or use search.
              Defaults to grouping by equipment type.
            </p>
          </div>
        </header>

        <div class="body">
          <div class="toolbar">
            <div class="toolbar-left">
              <button id="btnBack" type="button" class="btn btn-quiet">← Back</button>
              <button id="btnPrint" type="button" class="btn btn-primary">Print / Save PDF</button>
            </div>
            <div class="page-header-meta" id="woCount">0 work orders</div>
          </div>

          <div class="filters" aria-label="Equipment maintenance filters">
            <!-- ROW 1: Core filters -->
            <div class="filters-row">
              <div class="filter-field">
                <label class="filter-label" for="filterStatus">Status</label>
                <select id="filterStatus" class="filter-select">
                  <option value="all">All statuses</option>
                  <option value="pending">Pending</option>
                  <option value="in_progress">In progress</option>
                  <option value="completed">Completed</option>
                </select>
              </div>

              <div class="filter-field type-wide">
                <label class="filter-label" for="filterType">Equipment Type</label>
                <select id="filterType" class="filter-select">
                  <option value="all">All types</option>
                </select>
              </div>

              <div class="filter-field equip-wide">
                <label class="filter-label" for="filterEquip">Equipment</label>
                <select id="filterEquip" class="filter-select">
                  <option value="all">All equipment</option>
                </select>
              </div>
            </div>

            <!-- ROW 2: Search + clear -->
            <div class="filters-row filters-row-secondary">
              <div class="filter-field">
                <label class="filter-label">Search</label>
                <div class="bar">
                  <div class="search">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
                      <path d="M21 21l-4.2-4.2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                      <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    <input id="filterSearch" type="search" placeholder="Search" autocomplete="off"/>
                  </div>
                </div>
              </div>

              <button id="filterClear" type="button" class="btn btn-quiet">Clear filters</button>
            </div>
          </div>

          <section aria-label="Maintenance work order list">
            <div class="wo-empty">Loading work orders…</div>
            <div class="wo-list"></div>
          </section>

          <section class="wo-detail-panel" aria-label="Work order details">
            <div class="wo-detail-header">
              <div class="wo-detail-title">Work Order Details</div>
              <button type="button" id="woDetailClose" class="wo-detail-close">Close</button>
            </div>

            <div class="wo-detail-grid"></div>

            <div class="wo-detail-notes">
              <div class="wo-detail-notes-label">Summary Notes</div>
              <div class="wo-detail-notes-body"></div>
            </div>

            <div style="margin-top:8px;">
              <div class="wo-detail-notes-label">Line Items</div>
              <div id="lineItemsHost" class="li-list"></div>
            </div>

            <div class="wo-detail-footer"></div>
          </section>

          <div class="bottom-actions">
            <button id="btnPrintBottom" type="button" class="btn btn-primary">Print / Save PDF</button>
          </div>
        </div>
      </section>

      <iframe id="fv-print-frame"></iframe>
    </div>
  </fv-shell>

  <!-- Print-type chooser modal -->
  <div id="print-modal-backdrop" class="modal-backdrop modal-hidden" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="print-modal-title">
      <div class="modal-head">
        <div class="modal-title-row">
          <div>
            <div id="print-modal-title" class="modal-title">Choose report type</div>
            <div class="modal-sub">How do you want to print these maintenance records?</div>
          </div>
          <button type="button" class="modal-close-btn" id="printModalClose" aria-label="Close">×</button>
        </div>
      </div>
      <div class="modal-body">
        <p class="modal-note">
          <strong>Summary report</strong> = grouped totals by type &amp; equipment.<br>
          <strong>Detailed report</strong> = work orders + line items (notes, parts, who completed).
          Both reports match your current filters.
        </p>
        <div class="modal-buttons">
          <button id="printSummaryBtn" type="button" class="btn btn-primary modal-btn">Summary report</button>
          <button id="printDetailedBtn" type="button" class="btn btn-quiet modal-btn">Detailed report</button>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
