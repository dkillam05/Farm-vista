<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FarmVista ‚Ä¢ Approve Equipment Service Requests</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#3B7E46" />

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest" />
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png" />
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png" />
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css" />
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css" />

  <style>
    :root{
      --card-max: 1200px;
      --page-bottom-gap: 72px;
      --accent: #2F6C3C;
    }

    body{ background: var(--app-bg, var(--surface)); }

    .wrap{
      max-width: var(--card-max);
      margin: 0 auto;
      padding: clamp(14px,3vw,22px);
      padding-bottom: calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + var(--page-bottom-gap)) !important;
      box-sizing:border-box;
    }

    .hero{
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));
      overflow:hidden;
    }
    .hero-head{
      display:grid;
      grid-template-columns:36px 1fr;
      gap:12px;
      align-items:center;
      padding:14px 16px;
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);
      border-bottom:1px solid var(--border);
    }
    .hero-head .icon{
      width:24px;
      height:24px;
      color:var(--accent);
      display:grid;
      place-items:center;
    }
    .hero-head h1{
      margin:0;
      font-size:clamp(20px,3.2vw,26px);
      line-height:1.2;
    }
    .muted{ color:var(--muted,#67706B); }

    .body{ padding:16px; display:grid; gap:14px; }

    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:flex-end;
      justify-content:space-between;
    }
    .toolbar-left{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:120px;
      padding:10px 14px;
      border-radius:12px;
      border:1px solid var(--border);
      font-weight:800;
      text-decoration:none;
      cursor:pointer;
      user-select:none;
      color:var(--text);
      background:var(--card-surface,var(--surface));
      font-size:0.9rem;
      gap:6px;
    }
    .btn-quiet{ min-width:auto; padding-inline:10px; }

    .page-header-meta{ font-size:0.9rem; opacity:0.8; }

    .req-list{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:8px;
    }

    .req-empty{
      padding:14px 16px;
      border-radius:12px;
      border:1px dashed var(--border);
      background:var(--card-surface, var(--surface));
      font-size:0.95rem;
      opacity:0.9;
    }

    .req-card{
      position:relative;
      border-radius:10px;
      border:1px solid var(--card-border, var(--border));
      background:var(--card-surface, var(--surface));
      box-shadow:var(--shadow-soft, var(--shadow));
      padding:12px 14px 10px;
      display:flex;
      flex-direction:column;
      gap:6px;
      cursor:pointer;
      transition:transform .06s, box-shadow .12s, border-color .12s, background .12s;
    }
    .req-card:active{
      transform:scale(.995);
      box-shadow:var(--shadow);
    }

    .req-row-top{
      display:flex;
      align-items:flex-start;
      gap:10px;
    }

    .req-main{ flex:1 1 auto; min-width:0; }

    .req-title{
      font-weight:700;
      font-size:0.98rem;
      line-height:1.3;
    }

    .req-sub{
      font-size:0.86rem;
      opacity:0.9;
      margin-top:2px;
    }

    .req-meta{
      display:flex;
      flex-wrap:wrap;
      gap:6px 10px;
      margin-top:4px;
      font-size:0.8rem;
      opacity:0.85;
    }

    .req-meta span{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 7px;
      border-radius:999px;
      background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
    }

    .req-meta-label{ font-weight:600; }

    .req-toggle-wrap{
      flex:0 0 auto;
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:4px;
      padding-left:4px;
    }

    .pill-label{
      font-size:0.76rem;
      text-transform:uppercase;
      letter-spacing:0.06em;
      opacity:0.8;
    }

    .pill-toggle{
      position:relative;
      width:46px;
      height:26px;
      border-radius:999px;
      background:color-mix(in srgb, var(--border) 70%, var(--surface) 30%);
      border:1px solid var(--border);
      display:inline-flex;
      align-items:center;
      padding:2px;
      box-sizing:border-box;
      transition:background .16s, border-color .16s;
    }

    .pill-toggle-thumb{
      position:relative;
      width:20px;
      height:20px;
      border-radius:10px;
      background:var(--card-surface, #fff);
      box-shadow:0 1px 2px rgba(0,0,0,.35);
      transform:translateX(0);
      transition:transform .16s;
    }

    .pill-toggle[data-on="true"]{
      background:var(--accent, var(--green, #3B7E46));
      border-color:var(--accent, var(--green, #3B7E46));
    }
    .pill-toggle[data-on="true"] .pill-toggle-thumb{ transform:translateX(18px); }

    .pill-toggle-input{
      position:absolute;
      inset:0;
      opacity:0;
      cursor:pointer;
    }

    .req-detail-panel{
      margin-top:10px;
      border-radius:10px;
      border:1px solid var(--card-border, var(--border));
      background:var(--card-surface, var(--surface));
      box-shadow:var(--shadow-soft, var(--shadow));
      padding:14px 16px 12px;
      display:none;
      flex-direction:column;
      gap:8px;
    }

    .req-detail-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }

    .req-detail-title{
      font-weight:700;
      font-size:1rem;
    }

    .req-detail-close{
      border:none;
      border-radius:999px;
      padding:4px 9px;
      font-size:0.8rem;
      background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
      cursor:pointer;
      color:var(--text);
    }

    .req-detail-grid{
      display:grid;
      grid-template-columns:minmax(0,1fr);
      gap:6px 16px;
      font-size:0.9rem;
      margin-top:4px;
    }

    @media (min-width:700px){
      .req-detail-grid{ grid-template-columns:repeat(2, minmax(0,1fr)); }
    }

    .req-detail-item-label{
      font-size:0.8rem;
      text-transform:uppercase;
      letter-spacing:0.06em;
      opacity:0.7;
      margin-bottom:1px;
    }

    .req-detail-item-value{ font-size:0.92rem; }

    .req-detail-notes{
      margin-top:8px;
      padding-top:8px;
      border-top:1px solid var(--border);
      font-size:0.92rem;
      white-space:pre-wrap;
    }

    .req-detail-notes-label{
      font-size:0.8rem;
      text-transform:uppercase;
      letter-spacing:0.06em;
      opacity:0.7;
      margin-bottom:2px;
    }

    .req-detail-footer{
      margin-top:8px;
      font-size:0.8rem;
      opacity:0.85;
    }

    .req-detail-pill{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 8px;
      border-radius:999px;
      background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
      font-size:0.8rem;
      margin-left:6px;
    }

    [hidden]{ display:none !important; }

    /* kill Safari blue */
    button, input, select, textarea{ color:var(--text) !important; }
    a, a:visited{ color:var(--text) !important; text-decoration:none; }
    button:focus, input:focus, select:focus, textarea:focus{
      outline:none !important;
      border-color:var(--border) !important;
      box-shadow:none !important;
    }
  </style>

  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true;
        document.head.appendChild(s);
      }
    })();
  </script>

  <script type="module">
    import {
      ready,
      getFirestore,
      collection, query, where, getDocs,
      doc, updateDoc,
      serverTimestamp
    } from '/Farm-vista/js/firebase-init.js';

    import { NAV_MENU } from '/Farm-vista/js/menu.js';

    // Option B:
    // - Client ONLY updates the request status to "pending"
    // - A Cloud Function should listen for that status transition and create/update equipmentWorkOrders

    const CONFIG_REQUESTS = {
      COLLECTION_PATH: 'equipmentServiceRequests',
      STATUS_FIELD:    'status',
      NEEDS_APPROVAL_STATUS: 'needs approved',
      PENDING_STATUS:       'pending'
    };

    const STATE = {
      db: null,
      items: [],   // [{id,data}]
      selectedId: null
    };

    const $  = (sel, root=document) => root.querySelector(sel);

    function getTime(ts){
      if(!ts) return 0;
      try{
        if(ts.toMillis) return ts.toMillis();
        if(ts.toDate)   return ts.toDate().getTime();
        if(ts instanceof Date) return ts.getTime();
        return new Date(ts).getTime() || 0;
      }catch{ return 0; }
    }

    function formatDate(ts){
      try{
        if(!ts) return '';
        const d = ts.toDate ? ts.toDate() : new Date(ts);
        if(Number.isNaN(d.getTime())) return '';
        return d.toLocaleDateString([], { year:'numeric', month:'short', day:'2-digit' });
      }catch{ return ''; }
    }

    function mapTopic(code, other){
      if(code === 'other' && other) return other;
      switch(code){
        case 'engine': return 'Engine / Powertrain';
        case 'hydraulics': return 'Hydraulics';
        case 'electrical': return 'Electrical / Wiring';
        case 'driveline': return 'Driveline / Transmission';
        case 'tires_tracks': return 'Tires / Tracks / Undercarriage';
        case 'precision': return 'Precision / GPS / StarFire';
        case 'cab_controls': return 'Cab Controls / Displays';
        case 'leaks': return 'Leaks / Fluids';
        case 'scheduled_service': return 'Scheduled Service / Oil Change';
        case 'inspection': return 'Pre-Season Inspection';
        default: return code || 'Service Request';
      }
    }

    async function loadRequests(){
      const db  = STATE.db;
      const ref = collection(db, CONFIG_REQUESTS.COLLECTION_PATH);

      try{
        const qRef = query(ref, where(CONFIG_REQUESTS.STATUS_FIELD, '==', CONFIG_REQUESTS.NEEDS_APPROVAL_STATUS));
        const snap = await getDocs(qRef);

        const items = snap.docs.map(d => ({ id: d.id, data: d.data() }));

        items.sort((a,b)=> getTime(b.data.createdAt) - getTime(a.data.createdAt));

        STATE.items = items;
        renderList();
      }catch(err){
        console.error('Error loading service requests needing approval:', err);
        const emptyEl = $('.req-empty');
        if(emptyEl){
          emptyEl.textContent = 'Error loading service requests. Check console or Firestore indexes.';
          emptyEl.style.display = 'block';
        }
        const countEl = $('#reqCount');
        if(countEl) countEl.textContent = 'Error';
      }
    }

    function renderList(){
      const listEl  = $('.req-list');
      const emptyEl = $('.req-empty');
      const countEl = $('#reqCount');

      listEl.innerHTML = '';

      if(!STATE.items.length){
        if(emptyEl){
          emptyEl.style.display = 'block';
          emptyEl.textContent = 'No service requests currently have status ‚Äúneeds approved‚Äù. New requests that require your approval will appear here automatically.';
        }
        if(countEl) countEl.textContent = '0 needing approval';
        clearDetails();
        return;
      }

      if(emptyEl) emptyEl.style.display = 'block';
      emptyEl.textContent = 'Slide the toggle to approve each request (status will become Pending). Work Orders will be created/updated automatically by the server.';

      STATE.items.forEach(item=>{
        const d  = item.data;
        const id = item.id;

        const equipName = d.equipmentName || 'Equipment (unknown)';
        const typeLabel = d.equipmentType ? String(d.equipmentType).charAt(0).toUpperCase() + String(d.equipmentType).slice(1) : '';
        const serial6   = d.equipmentSerialLast6 ? `SN ‚Ä¶${d.equipmentSerialLast6}` : '';

        const topic       = mapTopic(d.serviceTopic, d.serviceTopicOther);
        const requested   = d.requestedDate || formatDate(d.createdAt);
        const submittedBy = (d.submittedBy && d.submittedBy.name) || '';

        const card = document.createElement('article');
        card.className = 'req-card';
        card.dataset.id = id;

        card.innerHTML = `
          <div class="req-row-top">
            <div class="req-main">
              <div class="req-title">${equipName}</div>
              <div class="req-sub">${typeLabel} ${serial6 ? `‚Ä¢ ${serial6}` : ''}</div>
              <div class="req-meta">
                <span><span class="req-meta-label">Topic</span> ${topic}</span>
                ${requested ? `<span><span class="req-meta-label">Requested</span> ${requested}</span>` : ''}
                ${submittedBy ? `<span><span class="req-meta-label">By</span> ${submittedBy}</span>` : ''}
              </div>
            </div>
            <div class="req-toggle-wrap">
              <div class="pill-label">Approve</div>
              <div class="pill-toggle" data-on="false">
                <div class="pill-toggle-thumb"></div>
                <input class="pill-toggle-input" type="checkbox" aria-label="Approve request (set to pending)" />
              </div>
            </div>
          </div>
        `;

        // card click ‚Üí show detail
        card.addEventListener('click', (ev)=>{
          if(ev.target.closest('.pill-toggle')) return;
          STATE.selectedId = id;
          renderDetails();
        });

        const input  = card.querySelector('.pill-toggle-input');
        const toggle = card.querySelector('.pill-toggle');

        input.addEventListener('click', ev => ev.stopPropagation());
        input.addEventListener('change', async (ev)=>{
          ev.stopPropagation();
          const checked = input.checked;

          if(!checked){
            toggle.dataset.on = 'false';
            return;
          }

          toggle.dataset.on = 'true';
          input.disabled = true;

          try{
            await approveRequestClientOnly(item);

            // Remove from list after success
            STATE.items = STATE.items.filter(x => x.id !== id);
            if(STATE.selectedId === id){
              STATE.selectedId = null;
              clearDetails();
            }
            renderList();
          }catch(err){
            console.error('Error approving request (client-only update):', err);
            alert('Failed to approve service request. Check console / Firestore rules for equipmentServiceRequests update.');
            input.checked = false;
            toggle.dataset.on = 'false';
          }finally{
            input.disabled = false;
          }
        });

        listEl.appendChild(card);
      });

      if(countEl) countEl.textContent = `${STATE.items.length} needing approval`;
    }

    function clearDetails(){
      const panel = $('.req-detail-panel');
      if(!panel) return;
      panel.style.display = 'none';
      panel.dataset.id = '';
      const grid = $('.req-detail-grid', panel);
      if(grid) grid.innerHTML = '';
      const notesBody = $('.req-detail-notes-body', panel);
      if(notesBody) notesBody.textContent = '';
      const footer = $('.req-detail-footer', panel);
      if(footer) footer.innerHTML = '';
    }

    function renderDetails(){
      const panel = $('.req-detail-panel');
      if(!panel) return;

      const item = STATE.items.find(x => x.id === STATE.selectedId);
      if(!item){
        clearDetails();
        return;
      }

      const d = item.data;
      panel.dataset.id = item.id;

      const titleEl = $('.req-detail-title', panel);
      if(titleEl) titleEl.textContent = d.equipmentName || 'Service Request Details';

      const grid = $('.req-detail-grid', panel);
      if(grid){
        const topic       = mapTopic(d.serviceTopic, d.serviceTopicOther);
        const requested   = d.requestedDate || formatDate(d.createdAt);
        const submittedBy = (d.submittedBy && d.submittedBy.name) || '';
        grid.innerHTML = `
          <div>
            <div class="req-detail-item-label">Equipment</div>
            <div class="req-detail-item-value">${d.equipmentName || ''}</div>
          </div>
          <div>
            <div class="req-detail-item-label">Topic</div>
            <div class="req-detail-item-value">${topic}</div>
          </div>
          <div>
            <div class="req-detail-item-label">Requested</div>
            <div class="req-detail-item-value">${requested || ''}</div>
          </div>
          <div>
            <div class="req-detail-item-label">Submitted By</div>
            <div class="req-detail-item-value">${submittedBy || ''}</div>
          </div>
        `;
      }

      const notesBody = $('.req-detail-notes-body', panel);
      if(notesBody) notesBody.textContent = d.notes || 'No additional notes recorded.';

      const footer = $('.req-detail-footer', panel);
      if(footer){
        footer.innerHTML = `
          Current status:
          <span class="req-detail-pill">${d[CONFIG_REQUESTS.STATUS_FIELD] || CONFIG_REQUESTS.NEEDS_APPROVAL_STATUS}</span>
        `;
      }

      panel.style.display = 'flex';
    }

    // OPTION B: client only updates the request status
    async function approveRequestClientOnly(item){
      const db = STATE.db;
      const id = item.id;

      const reqRef = doc(db, CONFIG_REQUESTS.COLLECTION_PATH, id);

      // Server-side automation should watch for:
      // status: "needs approved" -> "pending"
      // and then create/update equipmentWorkOrders accordingly.
      await updateDoc(reqRef, {
        [CONFIG_REQUESTS.STATUS_FIELD]: CONFIG_REQUESTS.PENDING_STATUS,
        approvedAt: serverTimestamp(),   // optional but useful for triggers/audit
        updatedAt: serverTimestamp()
      });
    }

    (async function boot(){
      await ready;
      STATE.db = getFirestore();

      const shell = document.querySelector('fv-shell');
      if(shell) shell.nav = NAV_MENU;

      const backBtn = document.getElementById('btnBack');
      if(backBtn){
        backBtn.addEventListener('click', () => {
          location.href = '/Farm-vista/pages/equipment/maintenance-index.html';
        });
      }

      const closeDetailBtn = $('#reqDetailClose');
      if(closeDetailBtn){
        closeDetailBtn.addEventListener('click', ()=>{
          STATE.selectedId = null;
          clearDetails();
        });
      }

      await loadRequests();
    })();
  </script>
</head>

<body>
  <fv-shell>
    <div class="wrap">
      <section class="hero">
        <header class="hero-head">
          <div class="icon" aria-hidden="true">üß∞</div>
          <div>
            <h1>Approve Equipment Service Requests</h1>
            <p class="muted">
              Review service requests saved with status ‚Äúneeds approved‚Äù. Slide the toggle to mark each as
              <strong>Pending</strong>. Work Orders are created/updated automatically by the server after approval.
            </p>
          </div>
        </header>

        <div class="body">
          <div class="toolbar">
            <div class="toolbar-left">
              <button id="btnBack" type="button" class="btn btn-quiet">
                ‚Üê Back to Equipment Maintenance
              </button>
            </div>
            <div class="page-header-meta" id="reqCount">0 needing approval</div>
          </div>

          <section aria-label="Service requests needing approval">
            <div class="req-empty">
              No service requests currently have status ‚Äúneeds approved‚Äù.
              New requests that require your approval will appear here automatically.
            </div>
            <div class="req-list"></div>
          </section>

          <section class="req-detail-panel" aria-label="Service request details">
            <div class="req-detail-header">
              <div class="req-detail-title">Service Request Details</div>
              <button type="button" id="reqDetailClose" class="req-detail-close">Close</button>
            </div>

            <div class="req-detail-grid"></div>

            <div class="req-detail-notes">
              <div class="req-detail-notes-label">Notes</div>
              <div class="req-detail-notes-body"></div>
            </div>

            <div class="req-detail-footer"></div>
          </section>
        </div>
      </section>
    </div>
  </fv-shell>
</body>
</html>
