<!-- =====================================================================
/Farm-vista/pages/equipment/actions/starfire-location.html
StarFire location moves (wired to Firestore)
===================================================================== -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista • StarFire Location Update</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- PWA + icons -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>

  <!-- Theme + app CSS -->
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <!-- Shell (header/footer/drawer) -->
  <script src="/Farm-vista/js/fv-shell.js"></script>

  <!-- Firebase init (assumes this sets up global `firebase`) -->
  <script src="/Farm-vista/js/firebase-init.js"></script>

  <style>
    :root{ --page-bottom-gap:56px; }

    body{
      background:var(--app-bg,var(--surface));
      min-height:100vh;
    }
    .wrap{
      max-width:1100px;
      margin:0 auto;
      padding:clamp(14px,3vw,22px);
      padding-bottom:calc(
        env(safe-area-inset-bottom,0px)
        + var(--ftr-h,42px)
        + var(--page-bottom-gap)
      );
    }
    header.page{
      margin:8px 0 20px 0;
    }
    header.page h1{
      margin:0 0 6px 0;
      font-size:clamp(22px,3.5vw,28px);
      line-height:1.2;
    }
    header.page p{
      margin:0;
      color:var(--muted,#67706B);
      font-size:clamp(14px,2.4vw,16px);
    }

    .card{
      background:var(--card-surface,var(--surface));
      border-radius:16px;
      box-shadow:0 0 0 1px var(--border,#D5D8D2);
      padding:clamp(12px,2.4vw,18px);
      margin-bottom:clamp(14px,3vw,20px);
    }
    .card h2{
      margin:0 0 10px 0;
      font-size:clamp(16px,2.8vw,20px);
    }
    .card p.sub{
      margin:0 0 10px 0;
      font-size:13px;
      color:var(--muted,#6B726C);
    }

    .field-row{
      display:flex;
      flex-direction:column;
      gap:4px;
      margin-bottom:10px;
    }
    .field-row label{
      font-size:13px;
      font-weight:500;
      color:var(--muted,#5E655F);
    }
    .field-row select,
    .field-row input[type="text"],
    .field-row textarea{
      border-radius:10px;
      border:1px solid var(--border,#D5D8D2);
      padding:8px 10px;
      font-size:14px;
      background:var(--input-bg,var(--surface));
      color:inherit;
    }
    .field-row textarea{
      min-height:70px;
      resize:vertical;
    }
    .field-row .readonly{
      border-radius:10px;
      padding:8px 10px;
      font-size:14px;
      background:var(--surface-soft,#F4F5F1);
      border:1px dashed var(--border,#D5D8D2);
      color:var(--muted,#5E655F);
    }

    .two-col{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:10px;
    }
    @media(max-width:640px){
      .two-col{ grid-template-columns:1fr; }
    }

    .actions{
      display:flex;
      gap:10px;
      margin-top:12px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .btn{
      appearance:none;
      border:none;
      border-radius:999px;
      padding:9px 16px;
      font-size:14px;
      font-weight:500;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      text-decoration:none;
    }
    .btn-primary{
      background:var(--accent,#3B7E46);
      color:#fff;
    }
    .btn-outline{
      background:transparent;
      color:var(--accent,#3B7E46);
      box-shadow:0 0 0 1px var(--accent,#3B7E46);
    }

    .small-note{
      font-size:12px;
      color:var(--muted,#747C74);
      margin-top:6px;
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      border-radius:999px;
      padding:4px 10px;
      font-size:11px;
      background:var(--surface-soft,#F4F5F1);
      color:var(--muted,#6B726C);
    }
  </style>
</head>
<body>
  <fv-shell>
    <div class="wrap">
      <header class="page">
        <h1>StarFire Location Update</h1>
        <p>Track where each StarFire globe is mounted, when it was moved, and who moved it.</p>
      </header>

      <!-- Select which StarFire receiver we’re working with -->
      <section class="card">
        <h2>Select StarFire Receiver</h2>
        <p class="sub">Choose a globe to view its current location and log a move.</p>

        <div class="field-row">
          <label for="starfireSelect">StarFire Receiver</label>
          <select id="starfireSelect">
            <option value="">Select a receiver…</option>
            <!-- Populated from Firestore: equipment where type="starfire" -->
          </select>
          <div class="small-note">
            Loaded from <span class="pill">equipment (type = "starfire")</span>.
          </div>
        </div>

        <div class="two-col">
          <div class="field-row">
            <label>Receiver ID / Name</label>
            <div id="sfName" class="readonly">—</div>
          </div>
          <div class="field-row">
            <label>Serial / JD Number</label>
            <div id="sfSerial" class="readonly">—</div>
          </div>
        </div>
      </section>

      <!-- Current / last-known location -->
      <section class="card">
        <h2>Current Location</h2>
        <p class="sub">
          Pulled from the last logged move for this receiver (or the StarFire document’s
          <code>starfireMountedOn</code> field if present).
        </p>

        <div class="two-col">
          <div class="field-row">
            <label>Mounted On</label>
            <div id="currentEquipment" class="readonly">Not assigned</div>
          </div>
          <div class="field-row">
            <label>Last Moved</label>
            <div id="lastMovedAt" class="readonly">—</div>
          </div>
        </div>

        <div class="two-col">
          <div class="field-row">
            <label>Moved By</label>
            <div id="lastMovedBy" class="readonly">—</div>
          </div>
          <div class="field-row">
            <label>Last Notes</label>
            <div id="lastNotes" class="readonly">—</div>
          </div>
        </div>
      </section>

      <!-- Log a new move -->
      <section class="card">
        <h2>Log New Location</h2>
        <p class="sub">Record where this globe is going, who is moving it, and any notes.</p>

        <form id="moveForm">
          <div class="field-row">
            <label for="equipmentSelect">New Equipment Location</label>
            <select id="equipmentSelect" required>
              <option value="">Select equipment…</option>
              <!-- Populated from equipment where gpsCapable == true -->
            </select>
            <div class="small-note">
              Loaded from <span class="pill">equipment (gpsCapable = true)</span> and not archived.
            </div>
          </div>

          <div class="two-col">
            <div class="field-row">
              <label for="movedBy">Moved By</label>
              <input id="movedBy" type="text" autocomplete="off" placeholder="Auto-fill from logged-in user" />
              <div class="small-note">
                Defaults to the current FV user (if available).
              </div>
            </div>

            <div class="field-row">
              <label for="movedAt">Move Date &amp; Time</label>
              <input id="movedAt" type="datetime-local"/>
              <div class="small-note">
                If left blank, will default to “now” when saving.
              </div>
            </div>
          </div>

          <div class="field-row">
            <label for="notes">Notes (optional)</label>
            <textarea id="notes" placeholder="Example: moved from 8R tractor to S780 combine for fall strip-till."></textarea>
          </div>

          <div class="actions">
            <a class="btn btn-outline" href="/Farm-vista/pages/equipment/equipment-starfire.html">
              Cancel
            </a>
            <button type="submit" class="btn btn-primary">
              Save Move
            </button>
          </div>
        </form>
      </section>
    </div>
  </fv-shell>

  <script>
    // ==============================
    // Helpers
    // ==============================
    function fmtDateTime(dt) {
      if (!dt) return '—';
      try {
        if (dt.toDate) dt = dt.toDate(); // Firestore Timestamp
        const pad = n => String(n).padStart(2,'0');
        const y = dt.getFullYear();
        const m = pad(dt.getMonth()+1);
        const d = pad(dt.getDate());
        const hh = pad(dt.getHours());
        const mm = pad(dt.getMinutes());
        return y + '-' + m + '-' + d + ' ' + hh + ':' + mm;
      } catch(e){
        return '—';
      }
    }

    function toDateTimeLocalValue(date){
      const pad = n => String(n).padStart(2,'0');
      const y = date.getFullYear();
      const m = pad(date.getMonth()+1);
      const d = pad(date.getDate());
      const hh = pad(date.getHours());
      const mm = pad(date.getMinutes());
      return y + '-' + m + '-' + d + 'T' + hh + ':' + mm;
    }

    function showToast(msg, type){
      // Try to use your existing toast system if present
      if (window.FVToast && typeof FVToast.show === 'function') {
        FVToast.show(msg, type || 'info');
      } else {
        alert(msg);
      }
    }

    // ==============================
    // Main wiring
    // ==============================
    document.addEventListener('DOMContentLoaded', async () => {
      if (!window.firebase || !firebase.firestore) {
        console.error('Firebase / Firestore not available. Check firebase-init.js.');
        showToast('Could not connect to database (Firebase not loaded).', 'error');
        return;
      }

      const db = firebase.firestore();

      const starfireSelect   = document.getElementById('starfireSelect');
      const equipmentSelect  = document.getElementById('equipmentSelect');
      const moveForm         = document.getElementById('moveForm');

      const sfName           = document.getElementById('sfName');
      const sfSerial         = document.getElementById('sfSerial');
      const currentEquipment = document.getElementById('currentEquipment');
      const lastMovedAt      = document.getElementById('lastMovedAt');
      const lastMovedBy      = document.getElementById('lastMovedBy');
      const lastNotes        = document.getElementById('lastNotes');

      const movedByInput     = document.getElementById('movedBy');
      const movedAtInput     = document.getElementById('movedAt');
      const notesInput       = document.getElementById('notes');

      // Maps so we can get doc data by id later
      const starfireMap  = new Map(); // id -> { id, data }
      const equipmentMap = new Map(); // id -> { id, data }

      // Prefill "Moved By" from FVUserContext if available
      try {
        if (window.FVUserContext && window.FVUserContext.displayName) {
          movedByInput.value = window.FVUserContext.displayName;
        } else if (firebase.auth && firebase.auth().currentUser) {
          const u = firebase.auth().currentUser;
          movedByInput.value = u.displayName || u.email || '';
        }
      } catch(e){
        console.warn('Could not prefill movedBy from context:', e);
      }

      // Prefill move time with "now"
      movedAtInput.value = toDateTimeLocalValue(new Date());

      // ------------------------------
      // Load StarFire receivers
      // ------------------------------
      async function loadStarfireReceivers(){
        starfireSelect.innerHTML = '<option value="">Select a receiver…</option>';
        starfireMap.clear();

        try {
          const snap = await db.collection('equipment')
            .where('type','==','starfire')
            .get();

          snap.forEach(doc => {
            const data = doc.data() || {};
            // Skip archived if you use that flag
            if (data.archived === true || data.isArchived === true) return;

            const id = doc.id;
            starfireMap.set(id, { id, data });

            const name = data.nickname || data.displayName || data.name || data.equipName || ('StarFire ' + id.slice(0,6));
            const opt  = document.createElement('option');
            opt.value = id;
            opt.textContent = name;
            starfireSelect.appendChild(opt);
          });
        } catch(err){
          console.error('Error loading StarFire receivers:', err);
          showToast('Error loading StarFire receivers.', 'error');
        }
      }

      // ------------------------------
      // Load GPS-capable equipment
      // ------------------------------
      async function loadGpsEquipment(){
        equipmentSelect.innerHTML = '<option value="">Select equipment…</option>';
        equipmentMap.clear();

        try {
          const snap = await db.collection('equipment')
            .where('gpsCapable','==', true)
            .get();

          snap.forEach(doc => {
            const data = doc.data() || {};
            if (data.archived === true || data.isArchived === true) return;

            const id = doc.id;
            equipmentMap.set(id, { id, data });

            const labelParts = [];
            // Try to build a decent label regardless of field naming
            if (data.nickname) labelParts.push(data.nickname);
            if (data.make)     labelParts.push(data.make);
            if (data.model)    labelParts.push(data.model);
            if (!labelParts.length && data.displayName) labelParts.push(data.displayName);
            if (!labelParts.length && data.name)        labelParts.push(data.name);
            const label = labelParts.join(' – ') || ('Equipment ' + id.slice(0,6));

            const opt = document.createElement('option');
            opt.value = id;
            opt.textContent = label;
            equipmentSelect.appendChild(opt);
          });
        } catch(err){
          console.error('Error loading GPS-capable equipment:', err);
          showToast('Error loading equipment.', 'error');
        }
      }

      // ------------------------------
      // Fill "current location" block
      // ------------------------------
      function clearCurrentLocation(){
        currentEquipment.textContent = 'Not assigned';
        lastMovedAt.textContent      = '—';
        lastMovedBy.textContent      = '—';
        lastNotes.textContent        = '—';
      }

      async function loadCurrentLocation(starfireId){
        clearCurrentLocation();
        const sf = starfireMap.get(starfireId);
        if (!sf) return;

        const data = sf.data || {};

        // Try document-level "starfireMountedOn" first
        if (data.starfireMountedOn) {
          const m = data.starfireMountedOn;
          currentEquipment.textContent = m.equipmentLabel || 'Unknown equipment';
          lastMovedAt.textContent      = fmtDateTime(m.movedAt ? (m.movedAt.toDate ? m.movedAt : m.movedAt) : null);
          lastMovedBy.textContent      = m.movedBy || '—';
          lastNotes.textContent        = m.notes || '—';
          return;
        }

        // Otherwise, look at starfireMoves collection, most recent
        try {
          const snap = await db.collection('starfireMoves')
            .where('receiverId','==', starfireId)
            .orderBy('movedAt','desc')
            .limit(1)
            .get();

          if (snap.empty) {
            clearCurrentLocation();
            return;
          }

          const doc  = snap.docs[0];
          const move = doc.data() || {};

          currentEquipment.textContent = move.equipmentLabel || 'Unknown equipment';
          lastMovedAt.textContent      = fmtDateTime(move.movedAt);
          lastMovedBy.textContent      = move.movedBy || '—';
          lastNotes.textContent        = move.notes || '—';
        } catch(err){
          console.error('Error loading last move:', err);
          showToast('Error loading last move for this receiver.', 'error');
        }
      }

      // ------------------------------
      // StarFire selection change
      // ------------------------------
      starfireSelect.addEventListener('change', () => {
        const id = starfireSelect.value;
        if (!id) {
          sfName.textContent   = '—';
          sfSerial.textContent = '—';
          clearCurrentLocation();
          return;
        }

        const sf = starfireMap.get(id);
        if (!sf) {
          sfName.textContent   = '—';
          sfSerial.textContent = '—';
          clearCurrentLocation();
          return;
        }

        const data = sf.data || {};
        const name = data.nickname || data.displayName || data.name || data.equipName || ('StarFire ' + id.slice(0,6));
        const serial = data.serial || data.serialNumber || data.vin || data.sn || '—';

        sfName.textContent   = name;
        sfSerial.textContent = serial;

        loadCurrentLocation(id);
      });

      // ------------------------------
      // Save move
      // ------------------------------
      moveForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        const receiverId = starfireSelect.value;
        const equipmentId = equipmentSelect.value;

        if (!receiverId) {
          showToast('Please select a StarFire receiver first.', 'error');
          return;
        }
        if (!equipmentId) {
          showToast('Please select the new equipment location.', 'error');
          return;
        }

        const sf = starfireMap.get(receiverId);
        const eq = equipmentMap.get(equipmentId);

        const sfData = sf ? (sf.data || {}) : {};
        const eqData = eq ? (eq.data || {}) : {};

        const receiverName = sfName.textContent || sfData.nickname || sfData.displayName || sfData.name || '';
        const receiverSerial = sfSerial.textContent || sfData.serial || sfData.serialNumber || sfData.vin || '';

        const labelParts = [];
        if (eqData.nickname) labelParts.push(eqData.nickname);
        if (eqData.make)     labelParts.push(eqData.make);
        if (eqData.model)    labelParts.push(eqData.model);
        if (!labelParts.length && eqData.displayName) labelParts.push(eqData.displayName);
        if (!labelParts.length && eqData.name)        labelParts.push(eqData.name);
        const equipmentLabel = labelParts.join(' – ') || ('Equipment ' + equipmentId.slice(0,6));

        let movedBy = movedByInput.value.trim();
        if (!movedBy) {
          if (window.FVUserContext && window.FVUserContext.displayName) {
            movedBy = window.FVUserContext.displayName;
          } else if (firebase.auth && firebase.auth().currentUser) {
            const u = firebase.auth().currentUser;
            movedBy = u.displayName || u.email || '';
          }
        }

        let movedAtStr = movedAtInput.value;
        let movedAtDate;
        if (movedAtStr) {
          movedAtDate = new Date(movedAtStr);
        } else {
          movedAtDate = new Date();
        }

        const notes = notesInput.value.trim();

        const payload = {
          receiverId,
          receiverName,
          receiverSerial,
          equipmentId,
          equipmentLabel,
          movedBy: movedBy || null,
          movedAt: firebase.firestore.Timestamp.fromDate(movedAtDate),
          notes: notes || null,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        // Add account context if you’ve got it
        if (window.FVUserContext && window.FVUserContext.accountId) {
          payload.accountId = window.FVUserContext.accountId;
        }

        try {
          // 1) Save move history
          await db.collection('starfireMoves').add(payload);

          // 2) Update StarFire equipment doc with latest mount info
          await db.collection('equipment').doc(receiverId).set({
            starfireMountedOn: {
              equipmentId,
              equipmentLabel,
              movedBy: payload.movedBy,
              movedAt: payload.movedAt,
              notes: payload.notes || null
            }
          }, { merge: true });

          showToast('StarFire move saved.', 'success');

          // Optional: refresh current location to show updated values
          await loadCurrentLocation(receiverId);

          // Optional redirect back to hub if you want
          window.location.href = '/Farm-vista/pages/equipment/equipment-starfire.html';
        } catch(err){
          console.error('Error saving StarFire move:', err);
          showToast('Error saving move. Please try again.', 'error');
        }
      });

      // Initial load
      await Promise.all([
        loadStarfireReceivers(),
        loadGpsEquipment()
      ]);
    });
  </script>
</body>
</html>
