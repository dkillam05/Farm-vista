<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista ‚Ä¢ StarFire Location Update</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- Absolute paths (required) -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>

  <!-- Theme + app CSS -->
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <!-- Ensure fv-shell -->
  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true;
        document.head.appendChild(s);
      }
    })();
  </script>

  <style>
    :root{
      --combo-gap: 4px;
      --combo-radius: 12px;
      --combo-btn-radius: 10px;
      --combo-shadow: 0 12px 26px rgba(0,0,0,.18);
      --combo-item-pad: 10px 8px;
      --combo-max-h: 50vh;

      --card-max:1100px;
      --page-bottom-gap:96px;
      --accent:#2F6C3C;
    }

    body{ background:var(--app-bg,var(--surface)); }

    .wrap{
      max-width:var(--card-max);
      margin:0 auto;
      padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + var(--page-bottom-gap))!important;
    }

    .hero{
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));
      overflow:visible;
      margin-bottom:18px;
    }
    .hero-head{
      display:grid; grid-template-columns:36px 1fr; gap:12px; align-items:center;
      padding:14px 16px; border-bottom:1px solid var(--border);
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);
    }
    .hero-head .icon{ width:24px; height:24px; color:var(--accent); display:grid; place-items:center }
    .hero-head h1,
    .hero-head h2{ margin:0; font-size:clamp(20px,3.0vw,24px); line-height:1.2 }
    .muted{ color:var(--muted,#67706B) }

    .body{ padding:16px; display:grid; gap:14px }
    .row{ display:grid; gap:10px; grid-template-columns:1fr 1fr }
    @media (max-width:880px){ .row{ grid-template-columns:1fr } }

    .field{ position:relative }
    .field label{ display:block; font-weight:800; margin:0 0 6px }

    .input,.buttonish{
      width:100%; font:inherit; font-size:16px; color:var(--text);
      background:var(--card-surface,var(--surface)); border:1px solid var(--border);
      border-radius:var(--combo-btn-radius); padding:12px; outline:none;
    }
    .buttonish{ cursor:pointer; text-align:left; position:relative; padding-right:42px }
    .buttonish.has-caret::after{
      content:""; position:absolute; right:14px; top:50%; width:0; height:0;
      border-left:6px solid transparent; border-right:6px solid transparent;
      border-top:7px solid var(--muted,#67706B); transform:translateY(-50%); pointer-events:none;
    }

    .help{ font-size:13px; color:var(--muted,#67706B); margin-top:6px }
    .error{ color:#b00020; font-weight:700 }

    .actions{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-top:10px }
    .btn{
      display:inline-flex; align-items:center; justify-content:center; min-width:140px;
      padding:12px 16px; border-radius:12px; border:1px solid var(--border);
      background:var(--card-surface,var(--surface)); font-weight:800; color:var(--text)!important; cursor:pointer;
    }
    .btn[disabled]{ opacity:.6; cursor:not-allowed }
    .btn-primary{ border-color:transparent; background:#2F6C3C; color:#fff!important }

    /* combo dropdowns (same behavior as bag page) */
    .combo{ position:relative }
    .combo .combo-anchor{
      position:relative; display:inline-block; width:100%;
    }
    .combo-panel{
      position:absolute; left:0; right:0; top:calc(100% + var(--combo-gap));
      background:var(--surface); border:1px solid var(--border); border-radius:var(--combo-radius);
      box-shadow:var(--combo-shadow); z-index:9999; padding:8px; display:none;
    }
    .combo-panel.show{ display:block }
    .combo-panel .search{ padding:4px 2px 8px }
    .combo-panel .search input{
      width:100%; padding:10px; border:1px solid var(--border); border-radius:var(--combo-btn-radius)
    }
    .combo-panel .list{ max-height:var(--combo-max-h); overflow:auto; border-top:1px solid var(--border) }
    .combo-item{ padding:var(--combo-item-pad); border-bottom:1px solid var(--border); cursor:pointer }
    .combo-item:hover{ background:rgba(0,0,0,.04) }
    .combo-item:last-child{ border-bottom:none }
    .combo-empty{ padding:var(--combo-item-pad); color:#67706B }

    .kvs{ display:flex; flex-wrap:wrap; gap:8px }
    .kv{
      background:var(--card-surface,var(--surface));
      border:1px dashed var(--border);
      border-radius:10px;
      padding:6px 10px;
      font-size:14px;
    }

    .toast{
      position:fixed; left:50%; bottom:calc(env(safe-area-inset-bottom,0px) + 72px);
      transform:translateX(-50%);
      background:#2F6C3C; color:#fff; padding:10px 14px; border-radius:10px;
      box-shadow:0 6px 20px rgba(0,0,0,.25); z-index:99999; display:none
    }
    .toast.show{ display:block; animation:fadeout 5s forwards }
    @keyframes fadeout{0%{opacity:1}85%{opacity:1}100%{opacity:0}}
  </style>
</head>

<body>
  <fv-shell>
    <div class="wrap">

      <!-- HERO 1: choose StarFire -->
      <section class="hero">
        <header class="hero-head">
          <div class="icon" aria-hidden="true">üì°</div>
          <div>
            <h1>Select StarFire</h1>
            <p class="muted">Pick a globe and see its model and serial.</p>
          </div>
        </header>
        <div class="body">
          <div class="field combo">
            <label for="sfBtn">StarFire Receiver</label>
            <div class="combo-anchor">
              <button id="sfBtn" class="buttonish has-caret" type="button">‚Äî Select receiver ‚Äî</button>
              <div class="combo-panel" id="sfPanel" role="listbox" aria-label="StarFire list">
                <div class="search"><input id="sfSearch" type="search" placeholder="Search receivers‚Ä¶"/></div>
                <div class="list" id="sfList"></div>
              </div>
            </div>
            <div id="sfHelp" class="help">Loading‚Ä¶</div>
          </div>

          <div class="field">
            <label>Receiver Details</label>
            <div class="kvs">
              <span class="kv"><b>Model:</b> <span id="sfModel">‚Äî</span></span>
              <span class="kv"><b>Serial (last 6):</b> <span id="sfSerial">‚Äî</span></span>
            </div>
          </div>
        </div>
      </section>

      <!-- HERO 2: current location -->
      <section class="hero">
        <header class="hero-head">
          <div class="icon" aria-hidden="true">üìç</div>
          <div>
            <h2>Current Location</h2>
            <p class="muted">Where this globe is right now.</p>
          </div>
        </header>
        <div class="body">
          <div class="field">
            <label>Location</label>
            <div class="kvs">
              <span class="kv"><b>Mounted On:</b> <span id="curEquip">‚Äî</span></span>
              <span class="kv"><b>Since:</b> <span id="curSince">‚Äî</span></span>
              <span class="kv"><b>Duration:</b> <span id="curDuration">‚Äî</span></span>
            </div>
            <div class="help" id="curHelp">Select a StarFire receiver above to see its location.</div>
          </div>
        </div>
      </section>

      <!-- HERO 3: assign new location -->
      <section class="hero">
        <header class="hero-head">
          <div class="icon" aria-hidden="true">üîÅ</div>
          <div>
            <h2>Assign New Location</h2>
            <p class="muted">Send this globe to a machine or back to storage.</p>
          </div>
        </header>
        <div class="body">
          <div class="field combo">
            <label for="equipBtn">New Location</label>
            <div class="combo-anchor">
              <button id="equipBtn" class="buttonish has-caret" type="button">‚Äî Select equipment or ‚ÄúIn Storage‚Äù ‚Äî</button>
              <div class="combo-panel" id="equipPanel" role="listbox" aria-label="Equipment list">
                <div class="search"><input id="equipSearch" type="search" placeholder="Search equipment‚Ä¶"/></div>
                <div class="list" id="equipList"></div>
              </div>
            </div>
            <div id="equipHelp" class="help">First option is <b>In Storage</b>, then GPS-capable equipment (make ‚Ä¢ model ‚Ä¢ last 6 of serial).</div>
          </div>

          <div class="row">
            <div class="field combo">
              <label for="moverBtn">Who is moving it?</label>
              <div class="combo-anchor">
                <button id="moverBtn" class="buttonish has-caret" type="button">‚Äî Select employee ‚Äî</button>
                <div class="combo-panel" id="moverPanel" role="listbox" aria-label="Employee list">
                  <div class="list" id="moverList"></div>
                </div>
              </div>
              <div id="moverHelp" class="help">Defaults to the logged-in user if found in employees.</div>
            </div>

            <div class="field">
              <label for="moveDate">Move Date</label>
              <input id="moveDate" class="input" type="date"/>
              <div class="help">Defaults to today.</div>
            </div>
          </div>

          <div id="pageErr" class="help error" hidden></div>

          <div class="actions">
            <button id="saveMove" class="btn btn-primary" type="button">Save Move</button>
            <button id="cancelPage" class="btn" type="button">Cancel</button>
          </div>
        </div>
      </section>
    </div>
  </fv-shell>

  <div id="toast" class="toast" role="status" aria-live="polite">Saved.</div>

  <!-- Firebase (modular) -->
  <script type="module">
    import {
      ready,
      getFirestore,
      getAuth,
      collection,
      getDocs,
      addDoc,
      doc,
      getDoc,
      updateDoc,
      serverTimestamp
    } from '/Farm-vista/js/firebase-init.js';

    /* ---------------- utils ---------------- */
    const $ = id => document.getElementById(id);
    const esc = s => String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;",
      "<":"&lt;",
      ">":"&gt;",
      '"':"&quot;",
      "'":"&#39;"
    }[m]));
    const toast = (msg="Saved.", ms=4200)=>{
      const t=$("toast");
      t.textContent=msg;
      t.classList.remove("show");
      void t.offsetWidth;
      t.classList.add("show");
      setTimeout(()=>t.classList.remove('show'),ms);
    };
    const todayISO = ()=>{
      const d=new Date();
      const y=d.getFullYear();
      const m=String(d.getMonth()+1).padStart(2,'0');
      const da=String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${da}`;
    };
    const last6 = s=>{
      const str = String(s || "").trim();
      if(!str) return "‚Äî";
      return str.length>6 ? str.slice(-6) : str;
    };
    const daysBetween = (isoDate)=>{
      if(!isoDate) return "‚Äî";
      const d = new Date(isoDate);
      if(Number.isNaN(d.getTime())) return "‚Äî";
      const now = new Date();
      const diff = Math.floor((now - d)/(1000*60*60*24));
      if(diff < 0) return "‚Äî";
      if(diff === 0) return "Today";
      if(diff === 1) return "1 day";
      return `${diff} days`;
    };

    /* -------- combo plumbing (same pattern as bag page) -------- */
    function closeAllCombos(except=null){
      document.querySelectorAll('.combo-panel.show').forEach(p=>{
        if(p!==except) p.classList.remove('show');
      });
    }
    document.addEventListener('click', ()=> closeAllCombos());
    document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeAllCombos(); });

    function makeCombo({ btn, panel, list, items=[], searchable=false, formatter=x=>String(x?.label ?? x), onPick }){
      panel.addEventListener('click', e=> e.stopPropagation());
      panel.addEventListener('mousedown', e=> e.stopPropagation());

      let _items = Array.isArray(items)?items:[];
      function render(q=""){
        const qq = (q||"").toLowerCase();
        const vis = _items.filter(x=>{
          const txt = formatter(x).toLowerCase();
          return !qq || txt.includes(qq);
        });
        list.innerHTML = vis.length
          ? vis.map(x=>`<div class="combo-item" data-id="${String(x.id)}">${esc(formatter(x))}</div>`).join('')
          : `<div class="combo-empty">(no matches)</div>`;
      }

      function open(){
        closeAllCombos(panel);
        panel.classList.add('show');
        render("");
        if(searchable){
          const inp = panel.querySelector('input');
          if(inp){ inp.value=""; inp.focus(); }
        }
      }
      function close(){ panel.classList.remove('show'); }

      btn.addEventListener('click', e=>{
        e.stopPropagation();
        panel.classList.contains('show') ? close() : open();
      });

      list.addEventListener('mousedown', e=>{
        const row = e.target.closest('.combo-item'); if(!row) return;
        const id = row.dataset.id;
        const it = _items.find(x=>String(x.id)===id);
        if(!it) return;
        onPick?.(it);
        close();
      });

      if(searchable){
        const s = panel.querySelector('input');
        if(s){ s.addEventListener('input', e=> render(e.target.value)); }
      }

      return {
        setItems(arr){
          _items = Array.isArray(arr)?arr:[];
          render("");
        },
        open, close
      };
    }

    /* -------- state -------- */
    let db, auth;

    let STARFIRES = [];   // {id, name, model, serial, data}
    let EQUIPMENT = [];   // {id, label, data} + special storage row
    let EMPLOYEES = [];   // {id, name, email}

    let selectedSF = null;
    let selectedNewLoc = null;
    let selectedMover = null;
    let currentMount = null;  // {locationLabel, sinceDate, mode}

    /* -------- combos -------- */
    const sfCombo = makeCombo({
      btn: $("sfBtn"),
      panel: $("sfPanel"),
      list: $("sfList"),
      items: [],
      searchable: true,
      formatter: x => x.name,
      onPick: it => {
        selectedSF = it;
        $("sfBtn").textContent = it.name;
        $("sfModel").textContent  = it.model || "‚Äî";
        $("sfSerial").textContent = last6(it.serial);
        loadCurrentLocation(it.id);
      }
    });

    const equipCombo = makeCombo({
      btn: $("equipBtn"),
      panel: $("equipPanel"),
      list: $("equipList"),
      items: [],
      searchable: true,
      formatter: x => x.label,
      onPick: it => {
        selectedNewLoc = it;        // it.id can be 'storage'
        $("equipBtn").textContent = it.label;
      }
    });

    const moverCombo = makeCombo({
      btn: $("moverBtn"),
      panel: $("moverPanel"),
      list: $("moverList"),
      items: [],
      searchable: false,
      formatter: x => x.name,
      onPick: it => {
        selectedMover = it;
        $("moverBtn").textContent = it.name;
      }
    });

    /* -------- data loaders -------- */
    async function loadStarfires(){
      STARFIRES = [];
      $("sfHelp").textContent = "Loading StarFire receivers‚Ä¶";

      try{
        const snap = await getDocs(collection(db,'equipment'));
        snap.forEach(d=>{
          const x = d.data() || {};
          if(x.type !== 'starfire') return;
          if(x.archived === true || x.isArchived === true) return;

          const name =
            x.nickname ||
            x.displayName ||
            x.name ||
            x.equipName ||
            ('StarFire ' + String(d.id).slice(0,6));

          const model = x.model || x.sfModel || x.displayName || "";
          const serial = x.serial || x.serialNumber || x.vin || x.sn || "";

          STARFIRES.push({ id:d.id, name, model, serial, data:x });
        });

        STARFIRES.sort((a,b)=>(a.name||"").localeCompare(b.name||""));
        sfCombo.setItems(STARFIRES);
        $("sfHelp").textContent = `${STARFIRES.length} receiver(s) loaded.`;
      }catch(err){
        console.error('loadStarfires error:', err);
        $("sfHelp").textContent = "Error loading receivers.";
      }
    }

    async function loadEquipment(){
      EQUIPMENT = [];
      $("equipHelp").textContent = "Loading equipment‚Ä¶";

      try{
        const snap = await getDocs(collection(db,'equipment'));
        snap.forEach(d=>{
          const x = d.data() || {};
          if(x.gpsCapable !== true) return;
          if(x.archived === true || x.isArchived === true) return;

          const make  = x.make || "";
          const model = x.model || "";
          const serial = x.serial || x.serialNumber || x.vin || x.sn || "";
          const label = `${make} ${model}`.trim() + (serial ? ` ‚Ä¢ ${last6(serial)}` : "");

          EQUIPMENT.push({
            id: d.id,
            label: label || ('Equipment ' + String(d.id).slice(0,6)),
            data: x
          });
        });

        EQUIPMENT.sort((a,b)=>(a.label||"").localeCompare(b.label||""));

        // first hardcoded option: In Storage
        const STORAGE_ROW = { id:'storage', label:'In Storage', storage:true };
        equipCombo.setItems([STORAGE_ROW, ...EQUIPMENT]);

        $("equipHelp").textContent = `${EQUIPMENT.length} GPS-capable unit(s) plus ‚ÄúIn Storage‚Äù.`;
      }catch(err){
        console.error('loadEquipment error:', err);
        $("equipHelp").textContent = "Error loading equipment.";
      }
    }

    async function loadEmployees(){
      EMPLOYEES = [];
      try{
        const snap = await getDocs(collection(db,'employees'));
        snap.forEach(d=>{
          const x = d.data() || {};
          EMPLOYEES.push({
            id: d.id,
            name: x.name || x.displayName || x.fullName || x.email || d.id,
            email: x.email || d.id
          });
        });
      }catch(err){
        console.warn('employees load error:', err);
      }

      EMPLOYEES.sort((a,b)=>(a.name||"").localeCompare(b.name||""));
      moverCombo.setItems(EMPLOYEES);

      // default to logged-in user, if found
      if(auth.currentUser){
        const meEmail = (auth.currentUser.email || "").toLowerCase();
        const mine = EMPLOYEES.find(e => (e.email||"").toLowerCase() === meEmail);
        if(mine){
          selectedMover = mine;
          $("moverBtn").textContent = mine.name;
        }
      }

      if(!selectedMover && EMPLOYEES[0]){
        selectedMover = EMPLOYEES[0];
        $("moverBtn").textContent = EMPLOYEES[0].name;
      }
    }

    async function loadCurrentLocation(sfId){
      currentMount = null;
      $("curEquip").textContent   = "‚Äî";
      $("curSince").textContent   = "‚Äî";
      $("curDuration").textContent = "‚Äî";
      $("curHelp").textContent    = "Looking up current location‚Ä¶";

      if(!sfId){
        $("curHelp").textContent = "Select a StarFire receiver above to see its location.";
        return;
      }

      try{
        const snap = await getDoc(doc(db,'equipment', sfId));
        if(!snap.exists()){
          $("curHelp").textContent = "No record found for this receiver.";
          return;
        }
        const data = snap.data() || {};
        const m = data.starfireMountedOn || null;

        if(!m){
          currentMount = { locationLabel:"In Storage", sinceDate:null, mode:'storage' };
          $("curEquip").textContent   = "In Storage";
          $("curSince").textContent   = "‚Äî";
          $("curDuration").textContent = "‚Äî";
          $("curHelp").textContent    = "No install history yet.";
          return;
        }

        const eqId   = m.equipmentId || null;
        const label  = m.equipmentLabel || (eqId ? ("Equipment " + eqId.slice(0,6)) : "In Storage");
        const movedDate = m.movedDate || m.movedAt || null;   // movedDate is what we‚Äôll store

        currentMount = {
          locationLabel: label,
          sinceDate: movedDate,
          mode: eqId ? 'equipment' : 'storage'
        };

        $("curEquip").textContent   = label;
        $("curSince").textContent   = movedDate || "Unknown";
        $("curDuration").textContent = movedDate ? daysBetween(movedDate) : "‚Äî";
        $("curHelp").textContent    = eqId ? "Currently mounted on this machine." : "Currently in storage.";
      }catch(err){
        console.error('loadCurrentLocation error:', err);
        $("curHelp").textContent = "Error loading current location.";
      }
    }

    /* -------- save move -------- */
    async function saveMove(){
      const errEl = $("pageErr");
      errEl.hidden = true;
      errEl.textContent = "";

      if(!selectedSF){
        errEl.textContent = "Pick a StarFire receiver first.";
        errEl.hidden = false;
        return;
      }
      if(!selectedNewLoc){
        errEl.textContent = "Pick where this globe is going (equipment or In Storage).";
        errEl.hidden = false;
        return;
      }
      if(!selectedMover){
        errEl.textContent = "Pick who is moving it.";
        errEl.hidden = false;
        return;
      }

      const dateStr = $("moveDate").value || todayISO();

      const from = currentMount || {
        locationLabel:"Unknown",
        sinceDate:null,
        mode:'unknown'
      };

      const toIsStorage = !!selectedNewLoc.storage;
      const toEquipmentId    = toIsStorage ? null : selectedNewLoc.id;
      const toEquipmentLabel = toIsStorage ? "In Storage" : selectedNewLoc.label;

      const mover = selectedMover;
      const moverName  = mover.name || "";
      const moverEmail = mover.email || null;

      const payload = {
        receiverId: selectedSF.id,
        receiverName: selectedSF.name,
        receiverModel: selectedSF.model || null,
        receiverSerial: selectedSF.serial || null,

        fromLocationLabel: from.locationLabel,
        fromSinceDate: from.sinceDate || null,
        fromMode: from.mode || null,

        toEquipmentId,
        toEquipmentLabel,
        toMode: toIsStorage ? 'storage' : 'equipment',

        movedById: mover.id,
        movedByName: moverName,
        movedByEmail: moverEmail,
        movedDate: dateStr,

        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      };

      const btn = $("saveMove");
      btn.disabled = true;

      try{
        // history
        await addDoc(collection(db,'starfireMoves'), payload);

        // latest location on StarFire doc
        await updateDoc(doc(db,'equipment', selectedSF.id), {
          starfireMountedOn: {
            equipmentId: toEquipmentId,
            equipmentLabel: toEquipmentLabel,
            movedBy: moverName || null,
            movedDate: dateStr
          },
          updatedAt: serverTimestamp()
        });

        toast("StarFire location saved.");
        await loadCurrentLocation(selectedSF.id);

        // back to hub
        window.location.href = "/Farm-vista/pages/equipment/equipment-starfire.html";
      }catch(err){
        console.error('saveMove error:', err);
        errEl.textContent = err.message || String(err);
        errEl.hidden = false;
      }finally{
        btn.disabled = false;
      }
    }

    /* -------- boot -------- */
    (async()=>{
      await ready;
      db = getFirestore();
      auth = getAuth();

      $("moveDate").value = todayISO();

      await Promise.all([
        loadStarfires(),
        loadEquipment(),
        loadEmployees()
      ]);

      $("saveMove").addEventListener('click', saveMove);
      $("cancelPage").addEventListener('click', ()=> {
        window.location.href = "/Farm-vista/pages/equipment/equipment-starfire.html";
      });

      // If we came in with ?id=<starfireId>, preselect it
      try{
        const params = new URLSearchParams(location.search);
        const preId = params.get('id');
        if(preId){
          const found = STARFIRES.find(s => s.id === preId);
          if(found){
            selectedSF = found;
            $("sfBtn").textContent = found.name;
            $("sfModel").textContent  = found.model || "‚Äî";
            $("sfSerial").textContent = last6(found.serial);
            await loadCurrentLocation(found.id);
          }
        }
      }catch(e){}
    })();
  </script>
</body>
</html>