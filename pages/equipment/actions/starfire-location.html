<!-- =====================================================================
/Farm-vista/pages/equipment/actions/starfire-location.html  (FULL FILE)
Rev: 2025-11-18c
 ‚Ä¢ Three hero sections:
    1) Select StarFire Receiver
    2) Current Location summary
    3) Assign New Location
 ‚Ä¢ StarFire dropdown:
    - Lists equipment.type === 'starfire'
    - Label: modelName/model only + last 6 of serial ‚Üí "SF6000 (#456789)"
 ‚Ä¢ New Location dropdown:
    - First option: "In Storage"
    - Then all equipment with starfireCapable === true and status != "archived"
    - Label: "Make Model (#last6)"
 ‚Ä¢ Who is moving + Move Date, defaults same as bag flow
 ‚Ä¢ Accepts optional ?id=<starfireId> to preselect from Hub
===================================================================== -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista ‚Ä¢ StarFire Location</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- Absolute paths -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>

  <!-- Theme + app CSS -->
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <!-- FV shell + combo upgrader -->
  <script>
    (function () {
      if (!customElements.get('fv-shell')) {
        const s = document.createElement('script');
        s.src = '/Farm-vista/js/fv-shell.js';
        s.defer = true;
        document.head.appendChild(s);
      }
    })();
  </script>
  <script src="/Farm-vista/js/fv-combo.js" defer></script>

  <style>
    :root{
      --card-max: 1100px;
      --page-bottom-gap: 96px;
      --accent:#2F6C3C;
    }
    body{ background:var(--app-bg,var(--surface)); }

    .wrap{
      max-width:var(--card-max);
      margin:0 auto;
      padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + var(--page-bottom-gap))!important;
    }

    .hero{
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));
      overflow:visible;
      margin-bottom:18px;
    }
    .hero-head{
      display:grid;
      grid-template-columns:36px 1fr;
      gap:12px;
      align-items:center;
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);
    }
    .hero-head .icon{
      width:24px; height:24px;
      display:grid; place-items:center;
      color:var(--accent);
    }
    .hero-head h1{
      margin:0;
      font-size:clamp(20px,3.2vw,26px);
      line-height:1.2;
    }
    .hero-head p{
      margin:0;
      color:var(--muted,#67706B);
      font-size:14px;
    }
    .body{
      padding:16px;
      display:grid;
      gap:14px;
    }

    .row{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    @media (max-width:880px){
      .row{ grid-template-columns:1fr; }
    }

    .field{ position:relative; }
    .field label{
      display:block;
      font-weight:800;
      margin:0 0 6px;
    }
    .help{
      font-size:13px;
      color:var(--muted,#67706B);
      margin-top:6px;
    }
    .error{
      color:#b00020;
      font-weight:700;
      margin-top:6px;
    }

    select.input{
      width:100%;
      font:inherit;
      font-size:16px;
      color:var(--text);
      background:var(--card-surface,var(--surface));
      border:1px solid var(--border);
      border-radius:10px;
      padding:12px;
      outline:none;
    }

    .input{
      width:100%;
      font:inherit;
      font-size:16px;
      color:var(--text);
      background:var(--card-surface,var(--surface));
      border:1px solid var(--border);
      border-radius:10px;
      padding:12px;
      outline:none;
    }

    .meta-chips{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:4px;
    }
    .chip{
      font-size:13px;
      border-radius:999px;
      border:1px solid var(--border);
      padding:6px 10px;
      background:var(--card-surface,var(--surface));
    }

    .actions{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:center;
      margin-top:10px;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:160px;
      min-height:48px;
      padding:12px 16px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--card-surface,var(--surface));
      font-weight:800;
      cursor:pointer;
      color:var(--text);
    }
    .btn[disabled]{ opacity:.6; cursor:not-allowed; }
    .btn-primary{
      border-color:transparent;
      background:#2F6C3C;
      color:#fff;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:calc(env(safe-area-inset-bottom,0px) + 72px);
      transform:translateX(-50%);
      background:#2F6C3C;
      color:#fff;
      padding:10px 14px;
      border-radius:10px;
      box-shadow:0 6px 20px rgba(0,0,0,.25);
      z-index:99999;
      display:none;
    }
    .toast.show{
      display:block;
      animation:fadeout 4.4s forwards;
    }
    @keyframes fadeout{
      0%{opacity:1}
      80%{opacity:1}
      100%{opacity:0}
    }

    [hidden]{ display:none !important; }
  </style>
</head>

<body>
  <fv-shell>
    <div class="wrap">
      <!-- Hero 1: Select StarFire Receiver -->
      <section class="hero">
        <header class="hero-head">
          <div class="icon" aria-hidden="true">üõ∞Ô∏è</div>
          <div>
            <h1>Select StarFire Receiver</h1>
            <p>Pick which globe you‚Äôre updating. Shows model and last six of the serial number only.</p>
          </div>
        </header>
        <div class="body">
          <div class="field">
            <label for="sfSelect">StarFire Receiver</label>
            <select id="sfSelect" class="input" data-fv-combo data-fv-search="true">
              <option value="">‚Äî Select StarFire ‚Äî</option>
            </select>
            <div id="sfHelp" class="help">Loading StarFire receivers‚Ä¶</div>
          </div>
        </div>
      </section>

      <!-- Hero 2: Current Location -->
      <section class="hero">
        <header class="hero-head">
          <div class="icon" aria-hidden="true">üìç</div>
          <div>
            <h1>Location</h1>
            <p>Where this globe is currently mounted.</p>
          </div>
        </header>
        <div class="body">
          <div class="field">
            <div><strong>Mounted On:</strong></div>
            <div class="meta-chips">
              <span id="locMounted" class="chip">In Storage</span>
              <span id="locSince" class="chip">Since: ‚Äî</span>
              <span id="locDuration" class="chip">Duration: ‚Äî</span>
            </div>
            <div id="locHistory" class="help">No install history yet.</div>
          </div>
        </div>
      </section>

      <!-- Hero 3: Assign New Location -->
      <section class="hero">
        <header class="hero-head">
          <div class="icon" aria-hidden="true">üîÑ</div>
          <div>
            <h1>Assign New Location</h1>
            <p>Send this globe to a machine or back to storage.</p>
          </div>
        </header>
        <div class="body">
          <div class="field">
            <label for="locSelect">New Location</label>
            <select id="locSelect" class="input" data-fv-combo data-fv-search="true">
              <option value="">‚Äî Select equipment or ‚ÄúIn Storage‚Äù ‚Äî</option>
              <!-- "In Storage" and GPS-capable units are added via JS -->
            </select>
            <div id="locHelp" class="help">Loading GPS-capable equipment‚Ä¶</div>
          </div>

          <div class="row">
            <div class="field">
              <label for="whoSelect">Who is moving it?</label>
              <select id="whoSelect" class="input" data-fv-combo>
                <option value="">‚Äî Select employee ‚Äî</option>
              </select>
              <div id="whoHelp" class="help">Defaults to the logged-in user if found in employees.</div>
            </div>
            <div class="field">
              <label for="moveDate">Move Date</label>
              <input id="moveDate" class="input" type="date"/>
              <div class="help">Defaults to today.</div>
            </div>
          </div>

          <div id="pageErr" class="error" hidden></div>

          <div class="actions">
            <button id="btnSave" class="btn btn-primary" type="button">Save Move</button>
            <button id="btnCancel" class="btn" type="button">Cancel</button>
          </div>
        </div>
      </section>
    </div>
  </fv-shell>

  <div id="toast" class="toast" role="status" aria-live="polite">Saved.</div>

  <!-- Firebase (modular) -->
  <script type="module">
    import {
      ready,
      getFirestore, getAuth,
      collection, getDocs,
      doc, getDoc, updateDoc,
      addDoc,
      serverTimestamp
    } from '/Farm-vista/js/firebase-init.js';

    const $ = id => document.getElementById(id);
    const qs = new URLSearchParams(location.search);
    const initialId = qs.get('id') || '';

    const last6 = v => String(v || '').slice(-6);
    const esc = s => String(s ?? '').replace(/[&<>"]/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'
    }[m] || m));

    const todayISO = () => {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,'0');
      const da = String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${da}`;
    };

    const fmtDatePretty = iso => {
      if (!iso || !/^\d{4}-\d{2}-\d{2}$/.test(iso)) return '‚Äî';
      const d = new Date(iso + 'T00:00:00');
      return d.toLocaleDateString(undefined, { year:'numeric', month:'short', day:'numeric' });
    };

    const diffDays = iso => {
      if (!iso || !/^\d{4}-\d{2}-\d{2}$/.test(iso)) return null;
      const start = new Date(iso + 'T00:00:00');
      const now = new Date();
      const ms = now - start;
      if (!Number.isFinite(ms) || ms < 0) return null;
      return Math.floor(ms / (1000*60*60*24));
    };

    const toast = (msg = 'Saved.', ms = 4200) => {
      const t = $('toast');
      t.textContent = msg;
      t.classList.remove('show');
      void t.offsetWidth;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), ms);
    };

    let db, auth;
    let STARFIRES = [];
    let EQUIP = [];
    let EQUIP_MAP = {};
    let EMPLOYEES = [];
    let currentSF = null;

    function labelStarfire(row){
      const model = row.modelName || row.model || row.name || 'StarFire';
      const s6 = last6(row.serial);
      return s6 ? `${model} (#${s6})` : model;
    }
    function labelEquip(row){
      const make = row.makeName || row.make || '';
      const model = row.modelName || row.model || '';
      const mm = [make, model].filter(Boolean).join(' ').trim() || 'Equipment';
      const s6 = last6(row.serial);
      return s6 ? `${mm} (#${s6})` : mm;
    }

    function renderLocationSummary(sfDoc){
      if (!sfDoc) {
        $('locMounted').textContent = 'In Storage';
        $('locSince').textContent = 'Since: ‚Äî';
        $('locDuration').textContent = 'Duration: ‚Äî';
        $('locHistory').textContent = 'No install history yet.';
        return;
      }

      const loc = sfDoc.starfireLocation || {};
      let mountedLabel = 'In Storage';
      if (loc.kind === 'equipment' && loc.label) mountedLabel = loc.label;
      else if (loc.kind === 'storage') mountedLabel = 'In Storage';

      const sinceISO = loc.since || '';
      const pretty = fmtDatePretty(sinceISO);
      const days = diffDays(sinceISO);

      $('locMounted').textContent = mountedLabel;
      $('locSince').textContent   = `Since: ${pretty}`;
      $('locDuration').textContent = days == null ? 'Duration: ‚Äî' : `Duration: ${days} day${days === 1 ? '' : 's'}`;
      $('locHistory').textContent = 'No install history yet.'; // placeholder for future history UI
    }

    function showError(msg){
      const el = $('pageErr');
      el.textContent = msg || '';
      el.hidden = !msg;
    }

    async function loadEquipment(){
      $('sfHelp').textContent = 'Loading StarFire receivers‚Ä¶';
      $('locHelp').textContent = 'Loading GPS-capable equipment‚Ä¶';

      const snap = await getDocs(collection(db, 'equipment'));
      STARFIRES = [];
      EQUIP = [];
      EQUIP_MAP = {};

      snap.forEach(d => {
        const x = d.data() || {};
        const type = String(x.type || '').toLowerCase();
        const status = String(x.status || 'active').toLowerCase();

        if (type === 'starfire') {
          STARFIRES.push({ id:d.id, ...x });
        }
        if (x.starfireCapable === true && status !== 'archived') {
          const row = { id:d.id, ...x };
          EQUIP.push(row);
          EQUIP_MAP[d.id] = row;
        }
      });

      STARFIRES.sort((a,b) => labelStarfire(a).localeCompare(labelStarfire(b)));
      EQUIP.sort((a,b) => labelEquip(a).localeCompare(labelEquip(b)));

      // Hydrate StarFire select
      const sfSel = $('sfSelect');
      sfSel.innerHTML = '<option value="">‚Äî Select StarFire ‚Äî</option>' +
        STARFIRES.map(sf => `<option value="${sf.id}">${esc(labelStarfire(sf))}</option>`).join('');

      $('sfHelp').textContent = STARFIRES.length
        ? `${STARFIRES.length} StarFire receiver(s) found.`
        : 'No StarFire receivers found.';

      // Hydrate location select
      const locSel = $('locSelect');
      locSel.innerHTML = `
        <option value="">‚Äî Select equipment or ‚ÄúIn Storage‚Äù ‚Äî</option>
        <option value="__storage__">In Storage</option>
        ${EQUIP.map(eq => `<option value="${eq.id}">${esc(labelEquip(eq))}</option>`).join('')}
      `;
      const count = EQUIP.length;
      $('locHelp').textContent = `${count} GPS-capable unit${count===1?'':'s'} plus "In Storage".`;
    }

    async function loadEmployees(){
      const list = [];
      try{
        const snap = await getDocs(collection(db,'employees'));
        snap.forEach(d => {
          const x = d.data() || {};
          list.push({
            id: d.id,
            name: x.name || x.displayName || x.fullName || x.email || d.id,
            email: x.email || d.id
          });
        });
      }catch(e){
        console.warn('[starfire-location] employees load error', e);
      }
      list.sort((a,b) => (a.name||'').localeCompare(b.name||''));
      EMPLOYEES = list;

      const sel = $('whoSelect');
      sel.innerHTML = '<option value="">‚Äî Select employee ‚Äî</option>' +
        list.map(e => `<option value="${e.id}">${esc(e.name)}</option>`).join('');

      const me = (auth.currentUser?.email || '').toLowerCase();
      const mine = list.find(e => (e.email || '').toLowerCase() === me);
      if (mine) sel.value = mine.id;
    }

    function onStarfireChange(){
      const id = $('sfSelect').value;
      currentSF = STARFIRES.find(s => s.id === id) || null;
      if (!currentSF) {
        renderLocationSummary(null);
        return;
      }
      renderLocationSummary(currentSF);
    }

    async function refreshCurrentStarfire(){
      if (!currentSF) return;
      try{
        const snap = await getDoc(doc(db,'equipment', currentSF.id));
        if (snap.exists()) {
          currentSF = { id: snap.id, ...(snap.data() || {}) };
          renderLocationSummary(currentSF);
        }
      }catch(e){
        console.warn('[starfire-location] refresh error', e);
      }
    }

    async function saveMove(){
      showError('');
      if (!currentSF) {
        showError('Please select a StarFire receiver first.');
        return;
      }

      const locVal = $('locSelect').value;
      if (!locVal) {
        showError('Please choose a new location (equipment or "In Storage").');
        return;
      }

      const whoId = $('whoSelect').value;
      if (!whoId) {
        showError('Please choose who is moving it.');
        return;
      }
      const emp = EMPLOYEES.find(e => e.id === whoId) || {};
      const who = {
        employeeId: whoId,
        name: emp.name || auth.currentUser?.displayName || auth.currentUser?.email || 'Unknown',
        email: emp.email || auth.currentUser?.email || null
      };

      const iso = $('moveDate').value || todayISO();
      if (!/^\d{4}-\d{2}-\d{2}$/.test(iso)) {
        showError('Move date is invalid.');
        return;
      }

      let loc;
      if (locVal === '__storage__') {
        loc = {
          kind:'storage',
          label:'In Storage',
          since: iso
        };
      } else {
        const eq = EQUIP_MAP[locVal];
        if (!eq) {
          showError('Selected equipment could not be found. Try reloading the page.');
          return;
        }
        loc = {
          kind:'equipment',
          equipmentId:eq.id,
          equipmentType:eq.type || null,
          label: labelEquip(eq),
          since: iso
        };
      }

      const btn = $('btnSave');
      btn.disabled = true;
      try{
        const move = {
          starfireId: currentSF.id,
          starfireLabel: labelStarfire(currentSF),
          to: loc,
          movedBy: who,
          moveDate: iso,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        };
        // History collection (simple flat list)
        await addDoc(collection(db,'starfire_moves'), move);

        await updateDoc(doc(db,'equipment', currentSF.id), {
          starfireLocation: { ...loc, movedBy: who },
          updatedAt: serverTimestamp()
        });

        await refreshCurrentStarfire();
        toast('StarFire location updated.');
      }catch(e){
        console.error('[starfire-location] save error', e);
        showError(e.message || 'Could not save move.');
      }finally{
        btn.disabled = false;
      }
    }

    (async () => {
      await ready;
      db = getFirestore();
      auth = getAuth();

      $('moveDate').value = todayISO();

      await Promise.all([
        loadEquipment(),
        loadEmployees()
      ]);

      // Preselect from ?id= if present
      if (initialId) {
        const sfSel = $('sfSelect');
        if ([...sfSel.options].some(o => o.value === initialId)) {
          sfSel.value = initialId;
        }
      }
      onStarfireChange();

      $('sfSelect').addEventListener('change', onStarfireChange);
      $('btnSave').addEventListener('click', saveMove);
      $('btnCancel').addEventListener('click', () => {
        if (history.length > 1) history.back();
        else window.location.href = '/Farm-vista/pages/equipment/equipment-starfire.html';
      });

      window.addEventListener('online', () => toast('Back online ‚Äî syncing‚Ä¶', 3000));
      window.addEventListener('offline', () => toast('Currently offline ‚Äî some actions may fail.', 3000));
    })().catch(e => {
      console.error('[starfire-location] init fatal', e);
      showError('Could not connect to database (Firebase not loaded).');
    });
  </script>
</body>
</html>