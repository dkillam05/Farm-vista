<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista • Add Equipment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>

  <!-- Theme + base app styles -->
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <!-- Ensure fv-shell -->
  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true; document.head.appendChild(s);
      }
    })();
  </script>

  <style>
    :root{ --brand:var(--green,#3B7E46); --card-max:1100px; }
    body{ background:var(--app-bg,var(--surface)); }
    .wrap{ max-width:var(--card-max); margin:0 auto; padding:clamp(14px,3vw,22px); }
    header.page{margin:8px 0 14px;}
    header.page h1{margin:0 0 6px 0; font-size:clamp(22px,3.5vw,28px)}
    header.page p{margin:0; color:var(--muted,#67706B)}

    .hero{ border:1px solid var(--border); border-radius:16px; background:var(--surface);
      padding:16px; display:grid; gap:12px; }
    .hero-actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
    .btn{ display:inline-flex; align-items:center; justify-content:center; padding:10px 14px; border-radius:12px; border:1px solid var(--border); background:var(--card-surface,var(--surface)); font-weight:800; color:var(--text)!important; cursor:pointer }
    .btn-primary{ border-color:transparent; background:var(--brand); color:#fff!important }
    .btn-quiet{ background:transparent }
    .btn-mini{ padding:6px 10px; border-radius:999px; font-weight:700; font-size:13px }
    .muted{ color:var(--muted,#67706B); font-size:14px }

    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
    @media (max-width:720px){ .grid2{ grid-template-columns:1fr } }

    .field-row{ display:grid; grid-template-columns:1fr auto auto; gap:8px; align-items:center }
    @media (max-width:520px){ .field-row{ grid-template-columns:1fr auto } .field-row .manage{ grid-column:1 / -1; justify-self:start } }

    .input,.select,.textarea{
      width:100%; font:inherit; font-size:16px; color:var(--text);
      background:var(--card-surface,var(--surface)); border:1px solid var(--border);
      border-radius:10px; padding:10px 12px;
    }
    .textarea{ min-height:90px }

    .qr-preview{
      display:grid; grid-template-columns:196px 1fr; gap:16px; align-items:center;
      border:1px dashed var(--border); border-radius:12px; padding:12px; background:color-mix(in srgb, var(--brand) 4%, transparent);
    }
    .qr-img{ width:196px; height:196px; display:grid; place-items:center; background:#fff; border:1px solid var(--border); border-radius:8px; padding:8px; overflow:hidden }
    #qrImg{ max-width:180px; max-height:180px; display:block }

    /* Centered Manage Modal */
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:9000; }
    .modal.show{ display:flex; }
    .modal-card{ width:min(620px,95vw); max-height:90vh; overflow:auto; background:var(--surface); border:1px solid var(--border); border-radius:16px; box-shadow:0 20px 60px rgba(0,0,0,.35); display:flex; flex-direction:column; }
    .md-head{ display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--border); background:color-mix(in srgb, var(--brand) 10%, transparent) }
    .md-body{ padding:16px; display:grid; gap:12px }
    .list{ border:1px solid var(--border); border-radius:12px; overflow:hidden }
    .row{ display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center; padding:10px 12px; border-top:1px solid var(--border) }
    .row:first-child{ border-top:none }
    .pill{ font-size:12px; border:1px solid var(--border); border-radius:999px; padding:2px 8px; }
  </style>
</head>
<body>
  <fv-shell>
    <div class="wrap">
      <header class="page">
        <h1>Add Equipment</h1>
        <p class="muted">Fill the basics, create the QR to preview, then save.</p>
      </header>

      <!-- HERO / ACTIONS -->
      <section class="hero">
        <div class="hero-actions">
          <button id="btnCreateQR" class="btn" type="button">Create QR Code</button>
          <button id="btnSave" class="btn btn-primary" type="button">Save</button>
          <a id="btnCancel" class="btn btn-quiet" href="/Farm-vista/pages/equipment/tractors-view.html">Cancel</a>
        </div>

        <!-- QR shows here immediately after "Create QR Code" -->
        <div id="qrPreview" class="qr-preview" hidden>
          <div class="qr-img"><img id="qrImg" alt="QR preview"/></div>
          <div>
            <div class="muted">
              QR preview. This code deep-links to the equipment hub for this unit.
              You can print labels after saving from the view screen.
            </div>
            <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap">
              <a id="openHub" class="btn btn-quiet" target="_blank" rel="noopener">Open Hub</a>
              <a id="downloadPng" class="btn" download="equipment-qr.png">Download PNG</a>
            </div>
          </div>
        </div>
      </section>

      <!-- FORM -->
      <section style="margin-top:16px; border:1px solid var(--border); border-radius:16px; background:var(--surface); padding:16px; display:grid; gap:12px">
        <div class="grid2">
          <div>
            <label>Make</label>
            <div class="field-row">
              <input id="make" class="input" placeholder="John Deere" list="makeList" autocomplete="off">
              <button id="addMake" class="btn btn-mini" type="button">+ Add</button>
              <button id="manageMake" class="btn btn-mini manage" type="button">Manage</button>
              <datalist id="makeList"></datalist>
            </div>
          </div>
          <div>
            <label>Model</label>
            <div class="field-row">
              <input id="model" class="input" placeholder="8R370" list="modelList" autocomplete="off">
              <button id="addModel" class="btn btn-mini" type="button">+ Add</button>
              <button id="manageModel" class="btn btn-mini manage" type="button">Manage</button>
              <datalist id="modelList"></datalist>
            </div>
          </div>
        </div>

        <div class="grid2">
          <div>
            <label>Year</label>
            <select id="year" class="select"></select>
          </div>
          <div>
            <label>Serial #</label>
            <input id="serial" class="input" placeholder="Optional">
          </div>
        </div>

        <div class="grid2">
          <div>
            <label>Engine Hours</label>
            <input id="hours" type="number" step="0.1" class="input" placeholder="e.g., 1250.5">
          </div>
          <div>
            <label>Status</label>
            <select id="status" class="select">
              <option value="active" selected>Active</option>
              <option value="archived">Archived</option>
            </select>
          </div>
        </div>

        <div>
          <label>Notes</label>
          <textarea id="notes" class="textarea" placeholder="Optional details"></textarea>
        </div>
      </section>
    </div>
  </fv-shell>

  <!-- ===== QR ENGINE (PNG with quiet zone) ===== -->
  <script>
  /*! qrcode-generator mini → returns PNG dataURL with quiet zone */
  (function(global){function QR8bitByte(data){this.mode=1;this.data=data}
  QR8bitByte.prototype={getLength:function(){return unescape(encodeURIComponent(this.data)).length},write:function(buffer){var s=unescape(encodeURIComponent(this.data));for(var i=0;i<s.length;i++)buffer.put(s.charCodeAt(i),8)}};
  function QRBitBuffer(){this.buffer=[],this.length=0}
  QRBitBuffer.prototype={get:function(i){return((this.buffer[i>>3]>>>(7-i%8))&1)==1},put:function(num,len){for(var i=0;i<len;i++)this.putBit(((num>>>(len-i-1))&1)==1)},putBit:function(bit){var b=this.length>>3;if(this.buffer.length<=b)this.buffer.push(0);if(bit)this.buffer[b]|=(0x80>>>(this.length%8));this.length++}};
  var QRUtil={PATTERN_POSITION_TABLE:[[],[6,18],[6,22],[6,26],[6,30],[6,34],[6,22,38],[6,24,42],[6,26,46],[6,28,50],[6,30,54],[6,32,58],[6,34,62]],
  G15:1335,G18:7973,G15_MASK:21522,getBCHTypeInfo:function(d){var x=d<<10;while(QRUtil.getBCHDigit(x)-QRUtil.getBCHDigit(QRUtil.G15)>=0)x^=(QRUtil.G15<<(QRUtil.getBCHDigit(x)-QRUtil.getBCHDigit(QRUtil.G15)));return(x|d<<10)^QRUtil.G15_MASK;},
  getBCHDigit:function(d){var n=0;while(d!=0){n++;d>>>=1}return n},getMask:function(m,i,j){switch(m){case 0:return(i+j)%2==0;case 1:return i%2==0;case 2:return j%3==0;case 3:return(i+j)%3==0;case 4:return((i/2|0)+(j/3|0))%2==0;case 5:return(i*j)%2+(i*j)%3==0;case 6:return((i*j)%2+(i*j)%3)%2==0;case 7:return((i*j)%3+i+j)%2==0;default:throw new Error("bad mask")}}};
  var QRMath={EXP_TABLE:new Array(256),LOG_TABLE:new Array(256),glog:function(n){if(n<1)throw new Error("glog("+n+")");return this.LOG_TABLE[n]},gexp:function(n){while(n<0)n+=255;while(n>=256)n-=255;return this.EXP_TABLE[n]}};
  for(var i=0;i<8;i++)QRMath.EXP_TABLE[i]=1<<i;for(i=8;i<256;i++)QRMath.EXP_TABLE[i]=QRMath.EXP_TABLE[i-4]^QRMath.EXP_TABLE[i-5]^QRMath.EXP_TABLE[i-6]^QRMath.EXP_TABLE[i-8];for(i=0;i<255;i++)QRMath.LOG_TABLE[QRMath.EXP_TABLE[i]]=i;
  function QRPolynomial(num,shift){var o=0;while(o<num.length&&num[o]==0)o++;this.num=new Array(num.length-o+shift);for(var i=0;i<num.length-o;i++)this.num[i]=num[i+o]}
  QRPolynomial.prototype={get:function(i){return this.num[i]},getLength:function(){return this.num.length},multiply:function(e){var n=new Array(this.getLength()+e.getLength()-1);for(var i=0;i<this.getLength();i++)for(var j=0;j<e.getLength();j++)n[i+j]^=QRMath.gexp(QRMath.glog(this.get(i))+QRMath.glog(e.get(j)));return new QRPolynomial(n,0)},mod:function(e){if(this.getLength()-e.getLength()<0)return this;var r=QRMath.glog(this.get(0))-QRMath.glog(e.get(0));var n=this.num.slice(0);for(var i=0;i<e.getLength();i++)n[i]^=QRMath.gexp(QRMath.glog(e.get(i))+r);return new QRPolynomial(n,0).mod(e)}};
  var RS_BLOCK_TABLE={1:[[26,20]],2:[[44,34]],3:[[70,55]],4:[[100,80]],5:[[134,108]],6:[[172,136]],7:[[196,156]],8:[[242,194]],9:[[292,232]],10:[[346,274]],12:[[466,356]]};
  function QRCode(typeNumber,ec){this.typeNumber=typeNumber;this.errorCorrectLevel=ec;this.modules=null;this.moduleCount=0;this.dataList=[]}
  QRCode.prototype={addData:function(d){this.dataList.push(new QR8bitByte(d))},isDark:function(r,c){return this.modules[r][c]},getModuleCount:function(){return this.moduleCount},
  make:function(){this.typeNumber=this.typeNumber||1;for(;;){this.makeImpl(false,this.getBestMaskPattern());if(this.getCapacity()>=this.dataLength())break;this.typeNumber++;if(this.typeNumber>12)break}},
  makeImpl:function(test,mask){this.moduleCount=this.typeNumber*4+17;this.modules=new Array(this.moduleCount);for(var r=0;r<this.moduleCount;r++){this.modules[r]=new Array(this.moduleCount);for(var c=0;c<this.moduleCount;c++)this.modules[r][c]=null}
  this.pp(0,0);this.pp(this.moduleCount-7,0);this.pp(0,this.moduleCount-7);this.timing();this.typeInfo(test,mask);var data=this.dataBytes();this.map(data,mask)},
  pp:function(row,col){for(var r=-1;r<=7;r++){if(row+r<=-1||this.moduleCount<=row+r)continue;for(var c=-1;c<=7;c++){if(col+c<=-1||this.moduleCount<=col+c)continue;this.modules[row+r][col+c]=(0<=r&&r<=6&&(c==0||c==6))||(0<=c&&c<=6&&(r==0||r==6))||(2<=r&&r<=4&&2<=c&&c<=4)}}},
  timing:function(){for(var i=8;i<this.moduleCount-8;i++){if(this.modules[i][6]===null)this.modules[i][6]=(i%2==0);if(this.modules[6][i]===null)this.modules[6][i]=(i%2==0)}},
  typeInfo:function(test,mask){var data=(1<<3)|mask;var bits=QRUtil.getBCHTypeInfo(data);for(var i=0;i<15;i++){var v=!test&&((bits>>i)&1)==1;this.modules[i<6?i:i<8?i+1:this.moduleCount-15+i][8]=v}
  for(i=0;i<15;i++){var v2=!test&&((bits>>i)&1)==1;this.modules[8][i<8?this.moduleCount-1-i:i==8?15-i:this.moduleCount-15+i]=v2}this.modules[this.moduleCount-8][8]=!test},
  map:function(data,mask){var inc=-1,row=this.moduleCount-1,bit=0,byte=0;for(var col=this.moduleCount-1;col>0;col-=2){if(col==6)col--;for(;;){for(var c=0;c<2;c++){if(this.modules[row][col-c]===null){var dark=false;if(byte<data.length)dark=((data[byte]>>>(7-bit))&1)==1;if(QRUtil.getMask(mask,row,col-c))dark=!dark;this.modules[row][col-c]=dark;bit++;if(bit==8){bit=0;byte++}}}row+=inc;if(row<0||this.moduleCount<=row){row-=inc;inc=-inc;break}}}},
  getBestMaskPattern:function(){var min=0,pat=0;for(var i=0;i<8;i++){this.makeImpl(true,i);var lost=0;if(i==0||min>lost){min=lost;pat=i}}return pat},
  getCapacity:function(){var rs=(RS_BLOCK_TABLE[this.typeNumber]||RS_BLOCK_TABLE[12])[0];return rs[1]},
  dataLength:function(){var bb=new QRBitBuffer();for(var i=0;i<this.dataList.length;i++){bb.put(4,4);bb.put(this.dataList[i].getLength(),8);this.dataList[i].write(bb)}return bb.length/8|0},
  dataBytes:function(){var bb=new QRBitBuffer();for(var i=0;i<this.dataList.length;i++){bb.put(4,4);bb.put(this.dataList[i].getLength(),8);this.dataList[i].write(bb)}var rs=(RS_BLOCK_TABLE[this.typeNumber]||RS_BLOCK_TABLE[12])[0];var dc=rs[1],ec=(rs[0]-dc),data=[];for(i=0;i<bb.length;i+=8)data.push((bb.get(i)?128:0)|(bb.get(i+1)?64:0)|(bb.get(i+2)?32:0)|(bb.get(i+3)?16:0)|(bb.get(i+4)?8:0)|(bb.get(i+5)?4:0)|(bb.get(i+6)?2:0)|(bb.get(i+7)?1:0));while(data.length<dc)data.push(data.length%2?0x11:0xEC);
  var rsPoly=(function(ec){var a=new QRPolynomial([1],0);for(var i=0;i<ec;i++)a=a.multiply(new QRPolynomial([1,QRMath.gexp(i)],0));return a})(ec);var raw=new QRPolynomial(data,rsPoly.getLength()-1);var mod=raw.mod(rsPoly);
  var ecBytes=new Array(ec).fill(0),m=mod.num,off=ecBytes.length-m.length;for(i=0;i<m.length;i++)ecBytes[i+off]=m[i];return data.concat(ecBytes)},
  toDataURL:function(scale){scale=scale||8;var m=this.getModuleCount(),q=4;var size=(m+q*2)*scale;var c=document.createElement('canvas');c.width=c.height=size;var x=c.getContext('2d');
  x.fillStyle='#fff';x.fillRect(0,0,size,size);x.fillStyle='#000';for(var r=0;r<m;r++)for(var col=0;col<m;col++)if(this.isDark(r,col))x.fillRect((col+q)*scale,(r+q)*scale,scale,scale);return c.toDataURL('image/png')}};
  global.QRGen=function(text){var qr=new QRCode(null,2);qr.addData(text);qr.make();return qr.toDataURL(10)};})(window);
  </script>

  <script type="module">
    import {
      ready,
      getFirestore,
      collection, doc, setDoc, addDoc, getDocs, query, where, orderBy, updateDoc,
      serverTimestamp
    } from '/Farm-vista/js/firebase-init.js';

    /* ---------- helpers ---------- */
    const $ = id => document.getElementById(id);
    function yearOptions(sel){
      sel.innerHTML = '<option value="">—</option>';
      const now = new Date().getFullYear();
      for(let y=now;y>=1980;y--){
        const o=document.createElement('option'); o.value=String(y); o.textContent=String(y); sel.appendChild(o);
      }
    }
    function ensureHttps(u){
      try{ const url = new URL(u, location.origin); if(url.protocol!=='https:') url.protocol='https:'; return url.toString(); }
      catch{ return u; }
    }
    function computeName(make, model, year){
      const nm = [make, model].filter(Boolean).join(' ');
      return nm ? (year ? `${nm} (${year})` : nm) : null;
    }

    const TYPE = (new URLSearchParams(location.search).get('type') || 'tractor').toLowerCase();

    let DB;
    let pendingRef = null;  // client-reserved doc ref
    let deepLink = null;

    /* ---------- Catalog (Make/Model) ---------- */
    const COLLS = {
      make:  'equipment-makes',
      model: 'equipment-models'
    };

    async function loadCatalog(kind){
      const listEl  = kind==='make' ? $("makeList")  : $("modelList");
      listEl.innerHTML = "";
      try{
        const snap = await getDocs(query(collection(DB, COLLS[kind]), where('status','==','active'), orderBy('name')));
        const opts = [];
        snap.forEach(doc => { const x=doc.data(); if(x?.name) opts.push(x.name); });
        opts.sort().forEach(v=>{ const o=document.createElement('option'); o.value=v; listEl.appendChild(o); });
      }catch(_){ /* ignore */ }
    }

    async function addToCatalog(kind, name){
      name = (name||"").trim();
      if(!name) return;
      // Does a doc with same lowercase name exist?
      const base = collection(DB, COLLS[kind]);
      const existing = await getDocs(query(base, where('nameLower','==', name.toLowerCase())));
      if(existing.size>0){
        // If archived, flip to active
        const docRef = existing.docs[0].ref;
        const data = existing.docs[0].data();
        if(data.status === 'archived'){
          await updateDoc(docRef, { status:'active', updatedAt:serverTimestamp() });
        }
      }else{
        const ref = doc(base);
        await setDoc(ref, {
          name, nameLower:name.toLowerCase(),
          status:'active',
          createdAt:serverTimestamp(), updatedAt:serverTimestamp()
        });
      }
      await loadCatalog(kind);
    }

    /* Manage modal */
    function openManage(kind){
      $("manageTitle").textContent = kind==='make' ? "Manage Makes" : "Manage Models";
      $("modalKind").value = kind;
      $("manageList").innerHTML = "";
      $("manageModal").classList.add("show");
      renderManage(kind);
    }
    function closeManage(){ $("manageModal").classList.remove("show"); }

    async function renderManage(kind){
      const list = $("manageList");
      list.innerHTML = "";
      const snap = await getDocs(query(collection(DB, COLLS[kind]), orderBy('name')));
      snap.forEach(d=>{
        const x=d.data();
        const row = document.createElement('div');
        row.className='row';
        row.innerHTML = `
          <div><strong>${x.name||'—'}</strong> <span class="pill">${x.status||'active'}</span></div>
          <div style="display:flex;gap:8px">
            <button class="btn btn-mini" data-act="toggle">${x.status==='archived'?'Activate':'Archive'}</button>
          </div>
        `;
        row.querySelector('[data-act="toggle"]').addEventListener('click', async()=>{
          await updateDoc(d.ref, {
            status: (x.status==='archived'?'active':'archived'),
            updatedAt: serverTimestamp()
          });
          renderManage(kind);
          await loadCatalog(kind);
        });
        list.appendChild(row);
      });
    }

    $("manageCloseBtn")?.addEventListener?.('click', closeManage);

    /* ---------- QR creation flow ---------- */
    function buildDeepLink(id){
      return ensureHttps(`${location.origin}/Farm-vista/pages/equipment/actions/hub.html?id=${encodeURIComponent(id)}`);
    }
    async function createQrFlow(){
      if(!pendingRef){
        pendingRef = doc(collection(DB, 'equipment')); // local ID only
      }
      const id = pendingRef.id;
      deepLink = buildDeepLink(id);

      // Make PNG with robust generator + quiet zone; show preview + download
      const dataUrl = window.QRGen(deepLink);
      $("qrImg").src = dataUrl;
      $("openHub").href = deepLink;
      $("downloadPng").href = dataUrl;
      $("qrPreview").hidden = false;
    }

    /* ---------- Save ---------- */
    async function saveEquipment(){
      if(!pendingRef){
        pendingRef = doc(collection(DB,'equipment'));
        deepLink = buildDeepLink(pendingRef.id);
      }
      const make = $("make").value.trim();
      const model = $("model").value.trim();
      const year  = $("year").value ? Number($("year").value) : null;
      const serial= $("serial").value.trim() || null;
      const hours = $("hours").value ? Number($("hours").value) : null;
      const status= $("status").value || 'active';
      const notes = $("notes").value.trim() || null;

      const payload = {
        type: TYPE,
        name: computeName(make, model, year),
        makeName: make || null,
        modelName: model || null,
        year, serial, engineHours: hours,
        status, notes,
        qr: deepLink ? { url: deepLink } : null,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      };
      await setDoc(pendingRef, payload);

      // keep catalogs fresh with what was typed
      await addToCatalog('make', make);
      await addToCatalog('model', model);

      location.href = `/Farm-vista/pages/equipment/${TYPE}s-view.html`;
    }

    /* ---------- boot ---------- */
    (async()=>{
      await ready;
      DB = getFirestore();
      yearOptions($("year"));

      await loadCatalog('make');
      await loadCatalog('model');

      $("btnCreateQR").addEventListener('click', createQrFlow);
      $("btnSave").addEventListener('click', saveEquipment);

      $("addMake").addEventListener('click', ()=> addToCatalog('make', $("make").value));
      $("addModel").addEventListener('click', ()=> addToCatalog('model', $("model").value));
      $("manageMake").addEventListener('click', ()=> openManage('make'));
      $("manageModel").addEventListener('click', ()=> openManage('model'));
    })();
  </script>

  <!-- ===== Manage Modal (Make/Model) ===== -->
  <div id="manageModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-card">
      <div class="md-head">
        <strong id="manageTitle">Manage</strong>
        <button id="manageCloseBtn" class="btn">Close</button>
      </div>
      <div class="md-body">
        <input type="hidden" id="modalKind" value="make"/>
        <div class="list" id="manageList"></div>
      </div>
    </div>
  </div>
</body>
</html>