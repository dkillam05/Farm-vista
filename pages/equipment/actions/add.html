<!-- =====================================================================
/Farm-vista/pages/equipment/actions/add.html  (FULL FILE)
Rev: 2025-12-20b
Updates (MINIMAL, based on your working 2025-12-20a file):
 âœ… Fix â€œdouble previewâ€ in print modal by NOT relying on `hidden`
    - Adds .pv-hide { display:none !important; }
    - StarFire preview starts with class pv-hide
    - setPrintPreview() toggles pv-hide on the two preview blocks
 âœ… Everything else left as-is (no trimming)
===================================================================== -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista â€¢ Add Tractor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>

  <!-- Theme + base app styles -->
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <!-- Shared equipment form layouts (extras per category) -->
  <script src="/Farm-vista/js/equipment-forms.js"></script>

  <!-- Ensure fv-shell -->
  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true;
        document.head.appendChild(s);
      }
    })();
  </script>

  <style>
    :root{
      --card-max:1100px;
      --page-bottom-gap:96px;
      --brand: var(--green,#3B7E46);
      --danger:#b00020;

      --ctl-h:48px;
      --ctl-pad-x:12px;
      --ctl-pad-y:12px;
      --ctl-radius:10px;

      /* ===== Brother QL-820NWB / DK-2205 (62mm wide continuous) ===== */
      --ql-tape-mm: 62mm;    /* fixed tape width = label HEIGHT */

      /* Long strip (non-starfire) */
      --ql-qr-mm: 48mm;      /* QR square */
      --ql-pad-mm: 2.2mm;    /* inner padding */
      --ql-gap-mm: 2mm;      /* column gap */

      /* âœ… BIGGER label fonts */
      --ql-font: 18pt;         /* Make + VIN/Serial value */
      --ql-font-small: 16pt;   /* Model */
      --ql-font-lab: 12pt;     /* VIN/Serial label */

      /* StarFire compact (matches lookup) */
      --sf-cut-mm: 62mm;       /* fixed short cut length */
      --sf-qr-mm: 46mm;        /* big QR */
      --sf-serial-font: 16pt;
      --sf-serial-font-sm: 13pt;
    }

    html, body { min-height:100%; }
    body { scrollbar-gutter:stable; }

    .wrap{
      max-width:var(--card-max);
      margin:0 auto;
      padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + var(--page-bottom-gap))!important;
    }

    /* Card */
    .hero{
      width:min(720px, calc(100% - 24px));
      margin:0 auto var(--page-bottom-gap);
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));
      overflow:hidden;
      contain:layout paint;
    }

    .hero-head{
      display:grid; grid-template-columns:36px 1fr; gap:12px; align-items:center;
      padding:14px 16px; border-bottom:1px solid var(--border); background:var(--surface);
    }
    .hero-head .icon{ width:24px; height:24px; display:grid; place-items:center; color:var(--brand); }
    .hero-head h1{ margin:0; font-size:clamp(20px,3.2vw,26px); line-height:1.2; }
    .muted{ color:var(--muted,#67706B) }

    .body{ padding:16px; display:grid; gap:14px; }
    .row{ display:grid; gap:10px; grid-template-columns:1fr 1fr }
    @media (max-width:880px){ .row{ grid-template-columns:1fr } }

    .field label{ display:flex; align-items:center; gap:10px; font-weight:800; margin:0 0 6px }
    .req::after{ content:" *"; color:var(--brand); }

    /* Tappable labels (inline editors) */
    .as-label{
      display:inline-flex; align-items:center; gap:8px;
      font:inherit; font-weight:800; background:transparent; border:none; padding:0;
      color:var(--text); cursor:pointer;
    }
    .as-label:hover{ text-decoration:underline; }
    .as-label.req::after{ content:" *"; color:var(--brand); }

    /* Base controls */
    .input,.select,.textarea{
      width:100%; font:inherit; font-size:16px; color:var(--text);
      background:var(--card-surface,var(--surface));
      border:1px solid var(--border); border-radius:var(--ctl-radius);
      padding:var(--ctl-pad-y) var(--ctl-pad-x); box-sizing:border-box; outline:none;
    }
    .input,.select{ height:var(--ctl-h); line-height:calc(var(--ctl-h) - 2px); }
    .textarea{ min-height:110px; resize:vertical; line-height:1.35; }

    /* Buttons */
    .btn{
      display:inline-flex; align-items:center; justify-content:center; min-width:148px;
      padding:10px 14px; border-radius:12px; border:1px solid var(--border);
      background:var(--card-surface,var(--surface)); font-weight:800; cursor:pointer;
      -webkit-appearance:none; appearance:none; color:var(--text)!important;
      text-decoration:none;
    }
    .btn-primary{ border-color:transparent; background:var(--brand); color:#fff!important }
    .btn-quiet{ background:transparent; color:var(--text)!important }
    .btn[disabled]{ opacity:.6; cursor:not-allowed }

    .error{ color:var(--danger); font-weight:700 }

    .toast{
      position:fixed; left:50%; bottom:calc(env(safe-area-inset-bottom,0px) + 72px);
      transform:translateX(-50%);
      background:var(--brand); color:#fff; padding:10px 14px; border-radius:10px;
      box-shadow:0 6px 20px rgba(0,0,0,.25); z-index:99999; display:none;
    }
    .toast.show{ display:block; animation:fadeout 5s forwards }
    @keyframes fadeout{ 0%{opacity:1} 85%{opacity:1} 100%{opacity:0} }

    /* Year popover */
    .combo{ position:relative; }
    .combo-trigger{ width:100%; text-align:left; }
    .combo-trigger.select{ position:relative; display:flex; align-items:center; }
    .combo-trigger.select::after{
      content:""; position:absolute; right:12px; top:50%; width:8px; height:8px; transform:translateY(-50%) rotate(45deg);
      border-right:2px solid currentColor; border-bottom:2px solid currentColor; opacity:.75; pointer-events:none;
    }
    .combo-panel{
      position:absolute; left:0; right:0; z-index:1000; margin-top:6px; padding:6px;
      background:var(--surface); border:1px solid var(--border); border-radius:12px; box-shadow:0 12px 26px rgba(0,0,0,.18);
      --row-h: 36px; max-height: calc(var(--row-h) * 5 + 12px); overflow:auto;
    }
    .combo-item{
      display:block; width:100%; text-align:left; font:inherit; color:var(--text);
      background:transparent; border:none; border-radius:10px;
      padding:10px 12px; height:var(--row-h); line-height:16px; cursor:pointer; font-weight:400;
    }
    .combo-item:hover, .combo-item:focus{ background:var(--hover, rgba(0,0,0,.06)); outline:none; }
    .combo-hidden{ display:none !important; }

    /* Custom dropdowns */
    .dd{position:relative}
    .dd-btn{
      width:100%;text-align:left;padding:12px;padding-right:40px;
      border:1px solid var(--border);border-radius:10px;background:var(--card-surface,var(--surface));
      font:inherit;color:var(--text);cursor:pointer;appearance:none;position:relative;height:var(--ctl-h);
      line-height:calc(var(--ctl-h) - 2px);
      display:flex; align-items:center;
    }
    .dd-btn::after{
      content:""; position:absolute; right:12px; top:50%; transform:translateY(-50%);
      width:18px; height:18px; pointer-events:none; opacity:.7;
      background:no-repeat center/18px 18px url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='%2367706B' d='M7.41 8.58L12 13.17l4.59-4.59L18 10l-6 6-6-6z'/></svg>");
    }
    .dd-list{position:absolute;z-index:40;top:calc(100% + 4px);left:0;right:0;max-height:260px;overflow:auto;border:1px solid var(--border);border-radius:10px;background:var(--surface);box-shadow:0 4px 12px rgba(0,0,0,.1);display:none}
    .dd.open .dd-list{display:block}
    .dd-list input{width:100%;box-sizing:border-box;padding:10px 12px;border:none;border-bottom:1px solid var(--border);font:inherit;outline:none;background:var(--surface)}
    .dd-list ul{list-style:none;margin:0;padding:0;max-height:220px;overflow-y:auto}
    .dd-list li{padding:10px 12px;cursor:pointer}
    .dd-list li:hover{background:#f0f1f0}
    .dd-btn[disabled]{opacity:.6;cursor:not-allowed}

    /* QR Preview + row */
    .qr-area{
      border:1px solid var(--border); border-radius:12px; background:var(--surface);
      display:flex; align-items:center; justify-content:center; padding:10px;
      width:112px; height:112px;
    }
    #qrThumb{ display:none; max-width:100%; max-height:100%; border-radius:6px; }
    .qr-row{ display:flex; align-items:center; gap:12px; }
    .qr-row .btn{ min-width:160px; }

    /* File input */
    input[type="file"].input{
      height:auto;
      line-height:normal;
      padding:8px 12px;
      color:var(--text) !important;
      -webkit-text-fill-color:var(--text) !important;
    }
    input[type="file"].input::-webkit-file-upload-button{
      color:#111111 !important;
      -webkit-text-fill-color:#111111 !important;
      background-color:#ffffff;
    }

    /* Modal */
    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:100000; }
    .modal.show{ display:flex; }
    .backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.45); }
    .sheet{
      position:relative; width:min(100vw, 760px); max-width:90vw; background:var(--surface);
      border:1px solid var(--border); border-radius:14px; box-shadow:0 20px 40px rgba(0,0,0,.35);
      display:flex; flex-direction:column; overflow:hidden; max-height:90vh;
    }
    .sheet header{
      padding:12px 14px; border-bottom:1px solid var(--border); font-weight:800;
      display:flex; align-items:center; justify-content:space-between; color:var(--text);
      flex:0 0 auto;
    }
    .sheet header .close{
      border:none; background:transparent; font:inherit; font-weight:800; cursor:pointer;
      padding:6px 10px; border-radius:10px; color:var(--text);
    }
    .sheet header .close:hover{ background:var(--hover,rgba(0,0,0,.06)); }

    /* ===== Print modal: hug the label ===== */
    #printModal .sheet.sheet-print{
      width: fit-content;
      max-width: calc(100vw - 24px);
    }

    /* âœ… NEW: Force-hide helper (so we do not depend on [hidden]) */
    .pv-hide{ display:none !important; }

    /* Print content wrapper */
    .print-wrap{
      padding:12px;
      display:grid;
      gap:10px;
      overflow-x:auto;
      overflow-y:hidden;
      -webkit-overflow-scrolling:touch;
      justify-items:start;
    }
    .print-help{ color:var(--muted,#67706B); font-size:14px; line-height:1.35; }

    /* ===== Long strip preview (non-starfire) ===== */
    .label-preview{
      width:140mm; /* JS overrides */
      height:var(--ql-tape-mm);
      border:1px dashed var(--border);
      border-radius:10px;
      background:#fff;
      color:#000;

      display:grid;
      grid-template-columns: max-content var(--ql-qr-mm) max-content;

      align-items:center;
      gap:var(--ql-gap-mm);
      padding:var(--ql-pad-mm);
      box-sizing:border-box;

      margin:0;
      max-width:none !important;
      white-space:nowrap;
      flex:0 0 auto;

      overflow:visible;
    }
    .lp-left, .lp-right{ display:flex; flex-direction:column; justify-content:center; min-width:max-content; }
    .lp-left .make{ font-weight:900; font-size:var(--ql-font); line-height:1.05; white-space:nowrap; }
    .lp-left .model{ font-weight:800; font-size:var(--ql-font-small); line-height:1.05; white-space:nowrap; margin-top:1mm; }
    .lp-mid{ width:var(--ql-qr-mm); height:var(--ql-qr-mm); display:flex; align-items:center; justify-content:center; background:#fff; }
    .lp-mid img{ width:100%; height:100%; image-rendering:pixelated; display:block; }
    .lp-right{ align-items:flex-end; text-align:right; }
    .lp-right .serial-lab{ font-weight:800; font-size:var(--ql-font-lab); line-height:1.05; opacity:.85; white-space:nowrap; }
    .lp-right .serial-val{ font-weight:900; font-size:var(--ql-font); line-height:1.05; letter-spacing:.6px; margin-top:1mm; white-space:nowrap; }

    /* ===== StarFire compact preview (matches lookup) ===== */
    .label-preview-starfire{
      width:var(--sf-cut-mm);
      height:var(--ql-tape-mm);
      border:1px dashed var(--border);
      border-radius:10px;
      background:#fff;
      color:#000;

      display:grid;
      grid-template-rows: var(--sf-qr-mm) 1fr;
      align-content:center;
      justify-items:center;
      gap: 2mm;
      padding: 2.2mm;
      box-sizing:border-box;

      overflow:hidden;
    }
    .sf-qr{
      width:var(--sf-qr-mm);
      height:var(--sf-qr-mm);
      display:flex;
      align-items:center;
      justify-content:center;
      background:#fff;
    }
    .sf-qr img{ width:100%; height:100%; display:block; image-rendering:pixelated; }
    .sf-serial{
      width:100%;
      text-align:center;
      font-weight:900;
      letter-spacing:.6px;
      line-height:1.05;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      font-size: var(--sf-serial-font);
    }
    .sf-serial.small{ font-size: var(--sf-serial-font-sm); }

    .print-actions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
      padding:0 12px 12px;
    }

    /* Bottom buttons layout */
    .actions{
      display:grid;
      grid-template-columns: minmax(140px, 220px) minmax(140px, 220px);
      grid-template-areas:
        "cancel save"
        "print  print";
      gap:12px;
      justify-content:center;
      align-items:center;
      margin-top:6px;
    }
    #btnClear{ grid-area: cancel; }
    #btnSave{ grid-area: save; }
    #btnSavePrint{
      grid-area: print;
      justify-self:center;
      width:min(320px, 100%);
    }
    .actions .btn,
    .actions a.btn{ width:100%; min-width:0; }
    @media (max-width:420px){
      .actions{ grid-template-columns: 1fr 1fr; width:100%; }
      #btnSavePrint{ width:100%; }
    }

    /* âœ… Hidden print iframe (same as your working reports) */
    #fv-print-frame{
      position:fixed;
      right:0;
      bottom:0;
      width:0;
      height:0;
      border:0;
      visibility:hidden;
    }
    /* =========================================
   Dark-mode fix: toggle visibility (OFF state)
   Works for StarFire GPS Capable? switch
   ========================================= */

/* Default/off track: give it contrast in dark mode */
@media (prefers-color-scheme: dark){
  .toggle{
    background: color-mix(in srgb, var(--surface) 30%, #ffffff 10%) !important;
    border-color: color-mix(in srgb, var(--border) 45%, #ffffff 10%) !important;
  }

  /* The knob: make it clearly visible */
  .toggle::after{
    background: #ffffff !important;
    box-shadow: 0 2px 8px rgba(0,0,0,.45) !important;
  }

  /* ON state stays your brand green + white knob */
  .toggle:checked{
    background: var(--brand, var(--green, #3B7E46)) !important;
    border-color: transparent !important;
  }
}
  </style>
</head>

<body>
  <fv-shell>
    <div class="wrap" data-equipment-type="">
      <section class="hero">
        <header class="hero-head">
          <div class="icon" aria-hidden="true">ðŸšœ</div>
          <div>
            <h1>Add Tractor</h1>
            <p class="muted">Pick Make/Model, set year, add serial (required), optional notes/photos.</p>
          </div>
        </header>

        <div class="body">
          <div class="row">
            <div class="field">
              <button id="openMakes" type="button" class="as-label req" aria-haspopup="dialog" aria-controls="editModal">Make</button>
              <input type="hidden" id="makeId" value=""/>
              <div id="ddMake" class="dd">
                <button type="button" id="ddMakeBtn" class="dd-btn">â€” Loadingâ€¦ â€”</button>
                <div class="dd-list">
                  <input type="text" id="ddMakeSearch" placeholder="Search makeâ€¦">
                  <ul id="ddMakeList"></ul>
                </div>
              </div>
            </div>

            <div class="field">
              <button id="openModels" type="button" class="as-label req" aria-haspopup="dialog" aria-controls="editModal">Model</button>
              <input type="hidden" id="modelId" value=""/>
              <div id="ddModel" class="dd">
                <button type="button" id="ddModelBtn" class="dd-btn" disabled>â€” Select a Make first â€”</button>
                <div class="dd-list">
                  <input type="text" id="ddModelSearch" placeholder="Search modelâ€¦" disabled>
                  <ul id="ddModelList"></ul>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="year">Year</label>
              <div class="combo" id="yearCombo">
                <button type="button" id="yearTrigger" class="select combo-trigger" aria-haspopup="listbox" aria-expanded="false">â€” Select â€”</button>
                <div id="yearPanel" class="combo-panel combo-hidden" role="listbox" aria-label="Year"></div>
                <select id="year" class="select" aria-hidden="true" style="display:none"></select>
              </div>
            </div>

            <div class="field">
              <label for="serial" class="req">Serial #</label>
              <input id="serial" class="input" placeholder="Required">
            </div>
          </div>

          <div id="equipExtras"></div>

          <div class="field">
            <label for="notes">Notes</label>
            <textarea id="notes" class="textarea" placeholder="Optional details (tires, guidance, attachments, etc.)"></textarea>
          </div>

          <div class="field">
            <label for="photos">Photos (optional)</label>
            <input id="photos" class="input" type="file" accept="image/*,.jpg,.jpeg,.png,.heic,.pdf" multiple>
          </div>

          <div class="field qr-row">
            <div id="qrArea" class="qr-area" hidden>
              <img id="qrThumb" alt="QR code">
            </div>
            <button id="btnQR" class="btn" type="button">Create QR Code</button>
          </div>

          <div id="err" class="error" hidden></div>

          <div class="actions">
            <a id="btnClear" class="btn btn-quiet" role="button">Cancel</a>
            <button id="btnSave" class="btn btn-primary" type="button" disabled>Save</button>
            <button id="btnSavePrint" class="btn btn-primary" type="button" disabled>Save and Print</button>
          </div>
        </div>
      </section>
    </div>
  </fv-shell>

  <!-- âœ… Hidden print iframe (report-style printing) -->
  <iframe id="fv-print-frame"></iframe>

  <!-- Edit modal -->
  <div id="editModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="editTitle">
    <div class="backdrop" data-close></div>
    <div class="sheet">
      <header>
        <div id="editTitle">Edit</div>
        <button class="close" type="button" data-close>Close</button>
      </header>

      <div class="ed-wrap">
        <div id="edModelsBar" style="display:none; gap:8px; align-items:center;">
          <label for="edMakeSelect" style="font-weight:800;margin-right:6px;">Make</label>
          <select id="edMakeSelect" class="select" style="max-width:260px;"></select>
        </div>

        <div id="edList" class="ed-list" role="list"></div>

        <div class="ed-bottom">
          <button id="edToggleArchived" class="btn btn-quiet" type="button">Show Archived Makes</button>
          <div class="grow"></div>
          <button id="edSaveAll" class="btn btn-primary" type="button" disabled>Save All Changes</button>
        </div>

        <div id="edArchivedPanel" class="archived-panel"></div>
      </div>
    </div>
  </div>

  <!-- New Make modal -->
  <div id="newMakeModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="nmTitle">
    <div class="backdrop" data-close></div>
    <div class="sheet">
      <header>
        <div id="nmTitle">New Make</div>
        <button class="close" type="button" data-close>Close</button>
      </header>
      <div class="nm-body">
        <div>
          <label for="nmName" class="req">Make name</label>
          <input id="nmName" class="input" placeholder="e.g., John Deere"/>
        </div>
        <div>
          <div style="font-weight:800;margin-bottom:6px;">Available on</div>
          <div id="nmSwitches" class="switch-list"></div>
        </div>
        <div class="ed-footer">
          <button id="nmCreate" class="btn btn-primary" type="button">Create</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Print modal -->
  <div id="printModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="printTitle">
    <div class="backdrop" data-close-print></div>
    <div class="sheet sheet-print">
      <header>
        <div id="printTitle">Print QR Label</div>
        <button class="close" type="button" data-close-print>Close</button>
      </header>

      <div class="print-wrap">
        <div class="print-help" id="printHelp">
          Printer: <b>Brother QL-820NWB</b> â€¢ Tape: <b>DK-2205 (62mm / 2.4&quot; continuous)</b><br>
          âœ… Label length flexes to your text (up to <b>6&quot;</b>). On phones, swipe left/right to see the whole label.
        </div>

        <!-- Long strip preview -->
        <div id="labelPreviewLong" class="label-preview" aria-label="Label preview">
          <div class="lp-left">
            <div id="lpMake" class="make">â€”</div>
            <div id="lpModel" class="model">â€”</div>
          </div>
          <div class="lp-mid">
            <img id="lpQR" alt="QR">
          </div>
          <div class="lp-right">
            <div class="serial-lab" id="lpSerialLab">VIN/Serial</div>
            <div class="serial-val" id="lpSerialVal">â€”</div>
          </div>
        </div>

        <!-- StarFire compact preview -->
        <!-- âœ… CHANGED: remove reliance on hidden; start force-hidden with pv-hide -->
        <div id="labelPreviewSF" class="label-preview-starfire pv-hide" aria-label="StarFire label preview">
          <div class="sf-qr">
            <img id="sfQR" alt="QR">
          </div>
          <div id="sfSerial" class="sf-serial">â€”</div>
        </div>
      </div>

      <div class="print-actions">
        <button id="btnPrintNow" class="btn btn-primary" type="button">Print</button>
        <button id="btnPrintClose" class="btn btn-quiet" type="button">Cancel</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite">Saved.</div>

  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js" onload="window.__qrReady=true;"></script>

  <script type="module">
    import {
      ready,
      getFirestore,
      collection, setDoc, doc, updateDoc, getDocs, getDoc,
      query, orderBy, where,
      serverTimestamp
    } from '/Farm-vista/js/firebase-init.js';

    import { NAV_MENU } from '/Farm-vista/js/menu.js';

    const $ = id => document.getElementById(id);
    const qs = new URLSearchParams(location.search);
    const TYPE = (qs.get('type') || 'tractor').toLowerCase();
    const IS_STARFIRE = TYPE === 'starfire';

    let EXTRAS_API = null;

    const state = { pendingChanges:0 };
    const bumpPending = (delta)=>{
      state.pendingChanges = Math.max(0, state.pendingChanges + delta);
      $("edSaveAll").disabled = state.pendingChanges===0;
    };

    function normType(label){
      const s = String(label||'').toLowerCase();
      if(s.includes('tractor')) return 'tractor';
      if(s.includes('combine')) return 'combine';
      if(s.includes('implement')) return 'implement';
      if(s.includes('sprayer')) return 'sprayer';
      if(s.includes('fertilizer')) return 'fertilizer';
      if(s.includes('construction')) return 'construction';
      if(s.includes('truck')) return 'truck';
      if(s.includes('trailer')) return 'trailer';
      if(s.includes('starfire') || s.includes('technology')) return 'starfire';
      return s.replace(/[^a-z0-9]+/g,'-').replace(/-+/g,'-').replace(/^-|-$/g,'');
    }
    function getEquipmentTypesFromMenu(){
      const group = NAV_MENU.items?.find(x => x.type==='group' && x.id==='equipment');
      const children = group?.children || [];
      return children.map(c => ({ label: c.label, slug: normType(c.label) }));
    }
    const EQUIP_TYPES = getEquipmentTypesFromMenu();
    const EQUIP_SLUGS = EQUIP_TYPES.map(t=>t.slug);

    function lookupEquipIcon(typeSlug){
      try{
        const group = NAV_MENU.items?.find(x => x.type === 'group' && x.id === 'equipment');
        const children = group?.children || [];
        const target = normType(typeSlug);
        const hit = children.find(c => normType(c.label) === target);
        const iconVal = (hit && typeof hit.icon === 'string') ? hit.icon.trim() : null;
        return iconVal || 'ðŸšœ';
      }catch(_){
        return 'ðŸšœ';
      }
    }

    function showToast(msg="Saved.", ms=3500){
      const t=$("toast");
      t.textContent=msg;
      t.classList.remove("show");
      t.style.display='block';
      void t.offsetWidth;
      t.classList.add("show");
      setTimeout(()=>{ t.classList.remove("show"); t.style.display='none'; }, ms);
    }

    function buildYearOptions(){
      const sel=$("year"); const now=new Date().getFullYear();
      sel.innerHTML='<option value="">â€” Select â€”</option>';
      for(let y=now; y>=1980; y--){
        const o=document.createElement('option');
        o.value=String(y);
        o.textContent=String(y);
        sel.appendChild(o);
      }
      const panel=$("yearPanel"), trigger=$("yearTrigger");
      panel.innerHTML="";
      [...sel.options].forEach(opt=>{
        const btn=document.createElement('button');
        btn.type='button';
        btn.className='combo-item';
        btn.role='option';
        btn.dataset.val=opt.value;
        btn.textContent=opt.textContent;
        btn.addEventListener('click', ()=>{
          sel.value = opt.value;
          trigger.textContent = opt.value ? opt.textContent : "â€” Select â€”";
          closeYearPanel();
          validateForm();
        });
        panel.appendChild(btn);
      });
    }
    function openYearPanel(){
      $("yearPanel").classList.remove('combo-hidden');
      $("yearTrigger").setAttribute('aria-expanded','true');
      document.addEventListener('click', onDocClickClose, { once:true });
      document.addEventListener('keydown', onEscClose);
    }
    function closeYearPanel(){
      $("yearPanel").classList.add('combo-hidden');
      $("yearTrigger").setAttribute('aria-expanded','false');
      document.removeEventListener('keydown', onEscClose);
    }
    function onDocClickClose(e){
      if(!$("yearCombo").contains(e.target)) closeYearPanel();
      else document.addEventListener('click', onDocClickClose, { once:true });
    }
    function onEscClose(e){ if(e.key==='Escape') closeYearPanel(); }

    function wireDropdownOpenClose(root){
      const btn = root.querySelector(".dd-btn");
      btn.addEventListener("click",()=>{
        document.querySelectorAll(".dd").forEach(d=>{ if(d!==root) d.classList.remove("open"); });
        if(btn.disabled) return;
        root.classList.toggle("open");
        const inp = root.querySelector(".dd-list input");
        if(root.classList.contains("open") && inp){ setTimeout(()=>inp.focus(), 60); }
      });
    }
    document.addEventListener("click",(e)=>{
      if(!e.target.closest(".dd")){
        document.querySelectorAll(".dd").forEach(d=>d.classList.remove("open"));
      }
    });
    function setupSearch(inputEl, listEl){
      inputEl.addEventListener("input", ()=>{
        const term=inputEl.value.toLowerCase();
        listEl.querySelectorAll("li").forEach(li=>{
          li.style.display = li.textContent.toLowerCase().includes(term) ? "" : "none";
        });
      });
    }
    function buildList(listEl, items, onPick){
      listEl.innerHTML="";
      items.forEach(([val,label,meta])=>{
        const li=document.createElement("li");
        li.textContent=label;
        li.dataset.value=val;
        li.onclick=()=>onPick(val,label,meta);
        listEl.appendChild(li);
      });
    }

    function normalizeSerial(s){ return String(s||'').trim().toUpperCase(); }
    function serialLast6(serial){
      const s = normalizeSerial(serial || '');
      if(!s) return '';
      return s.length <= 6 ? s : s.slice(-6);
    }

    function uniqKey(makeId, modelId, serial){
      return [String(makeId||''), String(modelId||''), normalizeSerial(serial)].join('_');
    }

    function readForm(){
      const makeId = $("makeId").value || null;
      const modelId = $("modelId").value || null;
      const makeName = $("ddMakeBtn").textContent.replace(/^â€”\s*|\s*â€”$/g,'').trim() || null;
      const modelName = $("ddModelBtn").textContent.replace(/^â€”\s*|\s*â€”$/g,'').trim() || null;
      const yr = $("year").value ? Number($("year").value) : null;
      const serialNorm = normalizeSerial($("serial").value);
      const name = [makeName, modelName].filter(Boolean).join(" ") + (yr?` (${yr})`:"");

      const base = {
        makeId, modelId, makeName, modelName,
        year: yr,
        serial: serialNorm,
        notes: $("notes").value.trim() || null,
        type: TYPE,
        name: name.trim()
      };

      let extras = {};
      if(EXTRAS_API && typeof EXTRAS_API.read === 'function'){
        try{ extras = EXTRAS_API.read() || {}; }catch{ extras = {}; }
      }else{
        const engEl = $("engineHours");
        if(engEl && engEl.value){
          extras.engineHours = Number(engEl.value);
        }
      }

      return { ...base, ...extras };
    }

    function validateForm(){
      const makeOk = Boolean($("makeId").value);
      const modelOk= Boolean($("modelId").value);
      const serialOk= Boolean(normalizeSerial($("serial").value));
      const ok = (makeOk && modelOk && serialOk);
      $("btnSave").disabled = !ok;
      $("btnSavePrint").disabled = !ok;
    }

    let pendingToken = null;
    let pendingQRBlob = null;
    let pendingEquipId = null;

    async function waitQRReady(){
      let tries=0;
      while(!(window.__qrReady && window.QRCode && window.QRCode.CorrectLevel) && tries++<200){
        await new Promise(r=>setTimeout(r,50));
      }
      if(!(window.QRCode && window.QRCode.CorrectLevel)) throw new Error('qr-lib');
    }

    function randTokenHex(len=24){
      const bytes=new Uint8Array(len/2);
      crypto.getRandomValues(bytes);
      return Array.from(bytes,b=>b.toString(16).padStart(2,'0')).join('');
    }

    async function canvasToBlob(canvas){
      return await new Promise((res,rej)=>canvas.toBlob(b=>b?res(b):rej(new Error('toBlob failed')),'image/png'));
    }

    async function makeQRForUrl(absUrl){
      await waitQRReady();
      const size=512, ecc=window.QRCode.CorrectLevel.H;
      const holder=document.createElement('div');
      new QRCode(holder,{
        text:absUrl,
        width:size,
        height:size,
        colorDark:"#000000",
        colorLight:"#ffffff",
        correctLevel:ecc
      });
      const node = await new Promise((res,rej)=>{
        const start=Date.now();
        (function check(){
          const n = holder.querySelector('canvas') || holder.querySelector('img');
          if(n) res(n);
          else if(Date.now()-start>4000) rej(new Error('qr-timeout'));
          else requestAnimationFrame(check);
        })();
      });

      let canvas;
      if(node.tagName==='CANVAS'){
        canvas=node;
      }else{
        canvas=document.createElement('canvas'); canvas.width=size; canvas.height=size;
        const ctx=canvas.getContext('2d');
        await new Promise((res,rej)=>{
          const img=new Image(); img.crossOrigin='anonymous';
          img.onload=()=>{ ctx.drawImage(img,0,0,size,size); res(); };
          img.onerror=rej; img.src=node.src;
        });
      }

      const blob = await canvasToBlob(canvas);
      const dataURL = canvas.toDataURL('image/png');
      const img=$("qrThumb");
      img.src=dataURL;
      img.onload=()=>{ $("qrArea").hidden=false; img.style.display='block'; };
      pendingQRBlob = blob;
      return { dataURL, blob };
    }

    const PrintUI = {
      el: $("printModal"),
      open(){ this.el.classList.add('show'); document.body.style.overflow='hidden'; },
      close(){ this.el.classList.remove('show'); document.body.style.overflow=''; }
    };
    document.querySelectorAll('#printModal [data-close-print]').forEach(el=>el.addEventListener('click', ()=>PrintUI.close()));
    $("btnPrintClose").addEventListener('click', ()=>PrintUI.close());

    /* ===== Dynamic label length (continuous tape) â€” Long labels only ===== */
    const LABEL = {
      tapeWmm: 62,
      qrMm: 48,
      padMm: 2.2,
      gapMm: 2.0,
      minLenMm: 90,
      maxLenMm: 152.4  /* âœ… 6 inches EXACT */
    };

    function pxPerMm(){ return 96 / 25.4; }
    function clampLenMm(mm){
      let len = Math.max(LABEL.minLenMm, Math.min(LABEL.maxLenMm, mm));
      len = Math.round(len * 2) / 2;
      return len;
    }

    function measureTextPxWithStyle(text, styleRefEl){
      const cs = getComputedStyle(styleRefEl);
      const span = document.createElement('span');
      span.textContent = String(text ?? '');
      span.style.position = 'fixed';
      span.style.left = '-99999px';
      span.style.top = '-99999px';
      span.style.visibility = 'hidden';
      span.style.whiteSpace = 'nowrap';
      span.style.fontFamily = cs.fontFamily;
      span.style.fontSize = cs.fontSize;
      span.style.fontWeight = cs.fontWeight;
      span.style.letterSpacing = cs.letterSpacing;
      span.style.textTransform = cs.textTransform;
      document.body.appendChild(span);
      const w = span.getBoundingClientRect().width;
      span.remove();
      return w;
    }

    function computeLabelLenMmFromDOM({ makeName, modelName, serial6 }){
      const pmm = pxPerMm();
      const makeEl = $("lpMake");
      const modelEl = $("lpModel");
      const labEl = $("lpSerialLab");
      const valEl = $("lpSerialVal");

      const makeWpx  = measureTextPxWithStyle(makeName || '', makeEl);
      const modelWpx = measureTextPxWithStyle(modelName || '', modelEl);
      const leftWpx  = Math.max(makeWpx, modelWpx);

      const labText = 'VIN/Serial';
      const valText = serial6 || '';
      const labWpx = measureTextPxWithStyle(labText, labEl);
      const valWpx = measureTextPxWithStyle(valText, valEl);
      const rightWpx = Math.max(labWpx, valWpx);

      const leftMm  = leftWpx / pmm;
      const rightMm = rightWpx / pmm;

      const safetyMm = 6.0;
      const raw =
        (LABEL.padMm * 2) +
        (LABEL.gapMm * 2) +
        leftMm +
        LABEL.qrMm +
        rightMm +
        safetyMm;

      return clampLenMm(raw);
    }

    let __labelLenMm = LABEL.minLenMm;

    /* ===== Print iframe (report-style) ===== */
    const PRINT_FRAME = $("fv-print-frame");

    function escHtml(s){
      return String(s||'').replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]));
    }
    function writePrintFrame(html){
      const win = PRINT_FRAME.contentWindow;
      const docu = PRINT_FRAME.contentDocument || win.document;
      docu.open();
      docu.write(html);
      docu.close();
    }
    function printFrameSync(){
      try{
        const win = PRINT_FRAME.contentWindow;
        win.focus();
        win.print();
      }catch(e){
        console.warn('[add] iframe print failed', e);
      }
    }

    function buildPrintHtmlLong({ makeName, modelName, serial, qrDataUrl, cutLenMm }){
      const serial6 = serialLast6(serial) || '';
      const W = `${cutLenMm}mm`;
      const H = `${LABEL.tapeWmm}mm`;
      const Q = `${LABEL.qrMm}mm`;
      return `<!doctype html>
<html><head><meta charset="utf-8">
<title>Print Label</title>
<style>
  @page{ size: ${W} ${H}; margin: 0; }
  html, body{ margin:0; padding:0; width:${W}; height:${H}; background:#fff; }
  .label{
    width:${W}; height:${H};
    box-sizing:border-box;
    padding:2.2mm;
    display:grid;
    grid-template-columns:max-content ${Q} max-content;
    gap:2mm;
    align-items:center;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    color:#000;
    overflow:hidden;
  }
  .left,.right{ display:flex; flex-direction:column; justify-content:center; min-width:max-content; }
  .make{ font-weight:900; font-size:18pt; line-height:1.05; white-space:nowrap; }
  .model{ font-weight:800; font-size:16pt; line-height:1.05; white-space:nowrap; margin-top:1mm; }
  .mid{ width:${Q}; height:${Q}; display:flex; align-items:center; justify-content:center; }
  .mid img{ width:100%; height:100%; display:block; image-rendering:pixelated; }
  .right{ align-items:flex-end; text-align:right; }
  .lab{ font-weight:800; font-size:12pt; line-height:1.05; opacity:.85; white-space:nowrap; }
  .val{ font-weight:900; font-size:18pt; line-height:1.05; letter-spacing:.6px; margin-top:1mm; white-space:nowrap; }
</style></head>
<body>
  <div class="label">
    <div class="left">
      <div class="make">${escHtml(makeName) || 'â€”'}</div>
      <div class="model">${escHtml(modelName) || 'â€”'}</div>
    </div>
    <div class="mid"><img alt="QR" src="${qrDataUrl || ''}"></div>
    <div class="right">
      <div class="lab">VIN/Serial</div>
      <div class="val">${escHtml(serial6) || 'â€”'}</div>
    </div>
  </div>
</body></html>`;
    }

    function buildPrintHtmlStarfire({ serial, qrDataUrl }){
      const serialTxt = String(serial || '').trim() || 'â€”';
      const font = serialTxt.length > 12 ? '13pt' : '16pt';
      return `<!doctype html>
<html><head><meta charset="utf-8">
<title>Print StarFire Label</title>
<style>
  @page{ size: 62mm 62mm; margin: 0; }
  html, body{ margin:0; padding:0; width:62mm; height:62mm; background:#fff; }
  .label{
    width:62mm; height:62mm;
    box-sizing:border-box;
    padding:2.2mm;
    display:grid;
    grid-template-rows:46mm 1fr;
    align-content:center;
    justify-items:center;
    gap:2mm;
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    color:#000;
    overflow:hidden;
  }
  .qr{ width:46mm; height:46mm; display:flex; align-items:center; justify-content:center; }
  .qr img{ width:100%; height:100%; display:block; image-rendering:pixelated; }
  .serial{
    width:100%;
    text-align:center;
    font-weight:900;
    letter-spacing:.6px;
    line-height:1.05;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    font-size:${font};
  }
</style></head>
<body>
  <div class="label">
    <div class="qr"><img alt="QR" src="${qrDataUrl || ''}"></div>
    <div class="serial">${escHtml(serialTxt)}</div>
  </div>
</body></html>`;
    }

    async function setPrintPreview({ makeName, modelName, serial, qrDataUrl }){
      /* âœ… CHANGED: use pv-hide class toggling (instead of hidden attribute) */
      const longEl = $("labelPreviewLong");
      const sfEl   = $("labelPreviewSF");
      if (longEl) longEl.classList.toggle('pv-hide', IS_STARFIRE);
      if (sfEl)   sfEl.classList.toggle('pv-hide', !IS_STARFIRE);

      // Update helper text
      const help = $("printHelp");
      if (help){
        help.innerHTML = IS_STARFIRE
          ? `Printer: <b>Brother QL-820NWB</b> â€¢ Tape: <b>DK-2205 (62mm)</b><br>âœ… StarFire compact label: QR + serial under it.`
          : `Printer: <b>Brother QL-820NWB</b> â€¢ Tape: <b>DK-2205 (62mm)</b><br>âœ… Label length flexes to your text (up to <b>6&quot;</b>).`;
      }

      if (IS_STARFIRE){
        // StarFire preview
        const serialTxt = String(serial || '').trim() || 'â€”';
        $("sfQR").src = qrDataUrl || '';
        $("sfSerial").textContent = serialTxt;
        $("sfSerial").classList.toggle('small', serialTxt.length > 12);

        // Preload print iframe (StarFire)
        writePrintFrame(buildPrintHtmlStarfire({ serial: serialTxt, qrDataUrl }));
        return;
      }

      // Long strip preview
      const serial6 = serialLast6(serial) || 'â€”';
      $("lpMake").textContent = (makeName || 'â€”');
      $("lpModel").textContent = (modelName || 'â€”');
      $("lpSerialLab").textContent = 'VIN/Serial';
      $("lpSerialVal").textContent = serial6;
      $("lpQR").src = qrDataUrl || '';

      const preview = document.getElementById('labelPreviewLong');
      if(preview){
        preview.style.width  = `${LABEL.minLenMm}mm`;
        preview.style.height = `${LABEL.tapeWmm}mm`;
      }

      await new Promise(r=>requestAnimationFrame(()=>requestAnimationFrame(r)));
      __labelLenMm = computeLabelLenMmFromDOM({ makeName, modelName, serial6 });

      if(preview){
        preview.style.width  = `${__labelLenMm}mm`;
        preview.style.height = `${LABEL.tapeWmm}mm`;
      }

      // Preload print iframe (Long)
      writePrintFrame(buildPrintHtmlLong({
        makeName, modelName, serial,
        qrDataUrl,
        cutLenMm: __labelLenMm || LABEL.minLenMm
      }));
    }

    function docCats(v){ return Array.isArray(v?.categories) ? v.categories.map(String) : undefined; }

    async function getMakes(db){
      const items=[];
      try{
        const snap=await getDocs(query(collection(db,'equipment-makes'), where('archived','!=',true), orderBy('archived'), orderBy('name')));
        snap.forEach(d=>{
          const v=d.data()||{}; const name=String(v.name||'').trim();
          if(name) items.push({id:d.id,name, categories:docCats(v)});
        });
      }catch{
        const snap=await getDocs(collection(db,'equipment-makes'));
        snap.forEach(d=>{
          const v=d.data()||{};
          if(!v.archived){
            const name=String(v.name||'').trim();
            if(name) items.push({id:d.id,name, categories:docCats(v)});
          }
        });
        items.sort((a,b)=>a.name.localeCompare(b.name));
      }
      return items;
    }

    async function getModels(db, makeId){
      if(!makeId) return [];
      const items=[];
      try{
        const snap=await getDocs(query(collection(db,'equipment-models'), where('makeId','==',makeId), where('archived','!=',true), orderBy('archived'), orderBy('name')));
        snap.forEach(d=>{
          const v=d.data()||{}; const name=String(v.name||'').trim();
          if(name) items.push({id:d.id,name, categories:docCats(v)});
        });
      }catch{
        const snap=await getDocs(query(collection(db,'equipment-models'), where('makeId','==',makeId)));
        snap.forEach(d=>{
          const v=d.data()||{};
          if(!v.archived){
            const name=String(v.name||'').trim();
            if(name) items.push({id:d.id,name, categories:docCats(v)});
          }
        });
        items.sort((a,b)=>a.name.localeCompare(b.name));
      }
      return items;
    }

    function visibleForType(doc){
      const cats = Array.isArray(doc.categories) ? doc.categories.map(s=>String(s).toLowerCase()) : null;
      if(!cats || cats.length===0) return true;
      return cats.includes(TYPE);
    }

    /* New Make modal */
    const NewMake = {
      el: $("newMakeModal"),
      name: $("nmName"),
      list: $("nmSwitches"),
      createBtn: $("nmCreate"),
      open(){
        this.name.value="";
        this.list.innerHTML="";
        EQUIP_TYPES.forEach(t=>{
          const row=document.createElement('div'); row.className='switch';
          const lab=document.createElement('label'); lab.textContent=t.label;
          const tog=document.createElement('input'); tog.type='checkbox'; tog.className='toggle'; tog.dataset.slug=t.slug;
          if(t.slug===TYPE) tog.checked=true;
          row.append(lab, tog);
          this.list.appendChild(row);
        });
        this.el.classList.add('show'); document.body.style.overflow='hidden';
      },
      close(){ this.el.classList.remove('show'); document.body.style.overflow=''; }
    };
    document.querySelectorAll('#newMakeModal [data-close]').forEach(el=>el.addEventListener('click', ()=>NewMake.close()));

    async function createMakeFromModal(db){
      const name = (NewMake.name.value||"").trim();
      if(!name){ alert("Enter a make name."); return null; }
      const chosen = [...NewMake.list.querySelectorAll('.toggle:checked')].map(i=>i.dataset.slug).filter(x=>EQUIP_SLUGS.includes(x));
      const cats = chosen.length ? chosen : [TYPE];
      const docRef = doc(collection(db,'equipment-makes'));
      await setDoc(docRef,{
        name, nameLower:name.toLowerCase(),
        status:'active', archived:false,
        categories: cats,
        createdAt: serverTimestamp(), updatedAt: serverTimestamp()
      });
      return { id: docRef.id, name, categories: cats };
    }

    async function addModel(db, makeId){
      if(!makeId){ alert("Pick a Make before adding a Model."); return null; }
      const name = (prompt("New Model name:")||"").trim();
      if(!name) return null;
      let makeCats = [TYPE];
      try{
        const mSnap = await getDoc(doc(db,'equipment-makes', makeId));
        const mv = mSnap.data()||{};
        if(Array.isArray(mv.categories) && mv.categories.length) makeCats = mv.categories;
      }catch{}
      const docRef = doc(collection(db,'equipment-models'));
      await setDoc(docRef,{
        name, nameLower:name.toLowerCase(),
        status:'active', archived:false,
        makeId, categories: makeCats,
        createdAt: serverTimestamp(), updatedAt: serverTimestamp()
      });
      return { id: docRef.id, name, categories: makeCats };
    }

    let ddMake, ddModel;
    function buildDdObjects(){
      ddMake = { root: $("ddMake"), btn: $("ddMakeBtn"), search: $("ddMakeSearch"), list: $("ddMakeList"), hidden: $("makeId") };
      ddModel = { root: $("ddModel"), btn: $("ddModelBtn"), search: $("ddModelSearch"), list: $("ddModelList"), hidden: $("modelId") };
      wireDropdownOpenClose(ddMake.root);
      wireDropdownOpenClose(ddModel.root);
      setupSearch(ddMake.search, ddMake.list);
      setupSearch(ddModel.search, ddModel.list);
    }

    async function populateMakes(db, preselectId){
      const allMakes = await getMakes(db);
      const makes = allMakes.filter(visibleForType);
      const items = [
        ["__add__", "Add Newâ€¦", {isAdd:true}],
        ...makes.map(m=>[m.id, m.name, {categories:m.categories}])
      ];
      buildList(ddMake.list, items, async (val,label,meta)=>{
        if(meta && meta.isAdd){
          NewMake.open();
          const onCreate = async ()=>{
            const created = await createMakeFromModal(db);
            if(created){
              NewMake.close();
              await populateMakes(db, created.id);
              setMake(created.id, created.name);
            }
          };
          NewMake.createBtn.onclick = onCreate;
          return;
        }
        setMake(val, label);
      });
      if(preselectId && makes.find(m=>m.id===preselectId)){
        const name = makes.find(m=>m.id===preselectId).name;
        setMake(preselectId, name);
      }else{
        ddMake.hidden.value = "";
        ddMake.btn.textContent = "â€” Select â€”";
      }
    }

    async function populateModels(db, makeId, preselectId){
      const allModels = await getModels(db, makeId);
      const models = allModels.filter(visibleForType);
      const items = [
        ["__add__", "Add Newâ€¦", {isAdd:true} ],
        ...models.map(m=>[m.id, m.name, {categories:m.categories}])
      ];
      buildList(ddModel.list, items, async (val,label,meta)=>{
        if(meta && meta.isAdd){
          const created = await addModel(db, ddMake.hidden.value);
          await populateModels(db, ddMake.hidden.value, created ? created.id : "");
          if(created){ setModel(created.id, created.name); }
          return;
        }
        setModel(val, label);
      });
      ddModel.btn.disabled = false;
      ddModel.search.disabled = false;

      if(preselectId && models.find(m=>m.id===preselectId)){
        const name = models.find(m=>m.id===preselectId).name;
        setModel(preselectId, name);
      }else{
        ddModel.hidden.value = "";
        ddModel.btn.textContent = "â€” Select â€”";
      }
    }

    function setMake(id, label){
      ddMake.hidden.value = id || "";
      ddMake.btn.textContent = id ? label : "â€” Select â€”";
      ddMake.root.classList.remove("open");

      ddModel.hidden.value = "";
      ddModel.btn.textContent = "â€” Select a Make first â€”";
      ddModel.btn.disabled = !id;
      ddModel.search.disabled = !id;
      ddModel.list.innerHTML = "";
      validateForm();

      if(id){ populateModels(window.__db, id); }
    }

    function setModel(id, label){
      ddModel.hidden.value = id || "";
      ddModel.btn.textContent = id ? label : "â€” Select â€”";
      ddModel.root.classList.remove("open");
      validateForm();
    }

    /* ===== Save equipment (same as your file, unchanged behavior) ===== */
    let saving = false;

    async function ensureQrReservedAndBuilt(db){
      if(!pendingEquipId){
        const tmpRef = doc(collection(db, 'equipment'));
        pendingEquipId = tmpRef.id;
      }
      if(!pendingQRBlob){
        const hubAbs = location.origin + `/Farm-vista/pages/equipment/actions/hub.html?id=${encodeURIComponent(pendingEquipId)}`;
        await makeQRForUrl(hubAbs);
      }
      return pendingEquipId;
    }

    async function saveAll(db, opts = { post:'reset' }){
      if(saving) return { ok:false };
      const form = readForm();
      if(!form.makeId){ alert("Please choose a Make."); return { ok:false }; }
      if(!form.modelId){ alert("Please choose a Model."); return { ok:false }; }
      if(!form.serial){ alert("Serial/VIN is required."); return { ok:false }; }

      if(EXTRAS_API && typeof EXTRAS_API.validate === 'function'){
        const v = EXTRAS_API.validate(form);
        if(v && v.ok === false){
          alert(v.message || "Please check the extra fields.");
          return { ok:false };
        }
      }

      saving = true; $("btnSave").disabled = true; $("btnSavePrint").disabled = true;

      const uniqDocId = uniqKey(form.makeId, form.modelId, form.serial);
      const eqRef = pendingEquipId ? doc(db, 'equipment', pendingEquipId) : doc(collection(db,'equipment'));
      if(!pendingEquipId){ pendingEquipId = eqRef.id; }

      const token = pendingToken || randTokenHex(24);
      const uniqRef = doc(db, 'equipment-uniq', uniqDocId);
      const tokenRef = doc(db, 'qr-tokens', token);

      let runTransaction;
      try{
        const m = await import('/Farm-vista/js/firebase-init.js');
        runTransaction = m.runTransaction;
      }catch{}

      try{
        if (typeof runTransaction === 'function'){
          await runTransaction(db, async (tx)=>{
            const uSnap = await tx.get(uniqRef);
            if(uSnap.exists()){
              const existingEq = uSnap.data()?.equipmentId;
              if(existingEq && existingEq !== eqRef.id) throw new Error("DUP_UNIQ");
            }
            const tSnap = await tx.get(tokenRef);
            if(tSnap.exists()){
              const boundEq = tSnap.data()?.equipmentId;
              if(boundEq && boundEq !== eqRef.id) throw new Error("DUP_TOKEN");
            }
            tx.set(eqRef, {
              ...form,
              status:"active",
              qr: { token, createdAt: serverTimestamp(), updatedAt: serverTimestamp() },
              createdAt: serverTimestamp(), updatedAt: serverTimestamp()
            });
            tx.set(uniqRef, { equipmentId: eqRef.id, makeId: form.makeId, modelId: form.modelId, serial: form.serial, updatedAt: serverTimestamp() });
            tx.set(tokenRef, { equipmentId: eqRef.id, updatedAt: serverTimestamp() });
          });
        } else {
          const [uSnap, tSnap] = await Promise.all([getDoc(uniqRef), getDoc(tokenRef)]);
          if(uSnap.exists() && uSnap.data()?.equipmentId !== eqRef.id) throw new Error("DUP_UNIQ");
          if(tSnap.exists() && tSnap.data()?.equipmentId !== eqRef.id) throw new Error("DUP_TOKEN");

          await setDoc(eqRef, {
            ...form,
            status:"active",
            qr: { token, createdAt: serverTimestamp(), updatedAt: serverTimestamp() },
            createdAt: serverTimestamp(), updatedAt: serverTimestamp()
          });
          await setDoc(uniqRef, { equipmentId: eqRef.id, makeId: form.makeId, modelId: form.modelId, serial: form.serial, updatedAt: serverTimestamp() });
          await setDoc(tokenRef, { equipmentId: eqRef.id, updatedAt: serverTimestamp() });
        }

        if(pendingQRBlob){
          try{
            const m = await import('/Farm-vista/js/firebase-init.js');
            const st = m.getStorage();
            const qrPath = `equipment/${eqRef.id}/qr.png`;
            const r = m.ref(st, qrPath);
            await m.uploadBytes(r, pendingQRBlob, { contentType: 'image/png' });
            const url = await m.getDownloadURL(r);
            await updateDoc(eqRef, {
              qr: { token, image: { path: qrPath, url }, createdAt: serverTimestamp(), updatedAt: serverTimestamp() },
              updatedAt: serverTimestamp()
            });
          }catch(qe){
            console.warn('QR upload failed:', qe);
            $("err").hidden=false; $("err").textContent = `Saved but QR image upload failed: ${qe.message}`;
          }
        }

        showToast("Saved");

        if(opts && opts.post === 'reset'){
          resetForm();
          window.scrollTo({ top:0, behavior:'smooth' });
        }

        return { ok:true, id:eqRef.id, form };

      }catch(err){
        if(err && err.message === "DUP_UNIQ"){
          alert("This Make + Model + Serial/VIN already exists. Duplicate not allowed.");
        }else if(err && err.message === "DUP_TOKEN"){
          alert("This QR token is already bound to another unit. Generate a new QR and try again.");
        }else{
          console.error(err);
          alert("Save failed.");
        }
        return { ok:false };
      }finally{
        saving = false;
        validateForm();
      }
    }

    function resetForm(){
      ["serial","notes"].forEach(id=>$(id).value="");
      $("photos").value="";
      $("year").value="";
      $("yearTrigger").textContent="â€” Select â€”";

      if(EXTRAS_API && typeof EXTRAS_API.reset === 'function'){
        try{ EXTRAS_API.reset(); }catch{}
      }else{
        const eng = $("engineHours");
        if(eng) eng.value="";
      }

      ddMake.hidden.value="";
      ddMake.btn.textContent="â€” Select â€”";
      ddModel.hidden.value="";
      ddModel.btn.textContent="â€” Select a Make first â€”";
      ddModel.btn.disabled = true;
      ddModel.search.disabled = true;
      ddModel.list.innerHTML = "";

      $("qrThumb").src="";
      $("qrThumb").style.display='none';
      $("qrArea").hidden=true;

      pendingToken=null;
      pendingQRBlob=null;
      pendingEquipId=null;

      validateForm();
    }

    function initExtras(){
      const host = $("equipExtras");
      if(!host) return;

      if(window.FVEquipForms && typeof window.FVEquipForms.initExtras === 'function'){
        try{
          EXTRAS_API = window.FVEquipForms.initExtras({
            equipType: TYPE,
            container: host,
            document
          }) || null;
        }catch(e){
          console.warn("extras init failed, falling back:", e);
          EXTRAS_API = null;
        }
      }

      if(!EXTRAS_API && TYPE === 'tractor'){
        host.innerHTML = "";
        const fld = document.createElement('div');
        fld.className = 'field';
        fld.innerHTML = `
          <label for="engineHours">Engine Hours</label>
          <input id="engineHours" type="number" class="input"
                 inputmode="decimal" step="0.1" placeholder="e.g., 1250.5">
        `;
        host.appendChild(fld);
      }
    }

    // âœ… Print button: now uses iframe print (native chooser like reports)
    $("btnPrintNow").addEventListener('click', ()=>{
      printFrameSync();
      setTimeout(()=>PrintUI.close(), 80);
    });

    (async()=>{
      await ready;
      const db  = getFirestore();
      window.__db = db;

      const niceType = TYPE[0].toUpperCase()+TYPE.slice(1);
      document.title = `FarmVista â€¢ Add ${niceType}`;
      document.querySelector('.hero-head h1').textContent = `Add ${niceType}`;
      const wrap = document.querySelector('.wrap');
      if(wrap) wrap.dataset.equipmentType = TYPE;

      const heroIconEl = document.querySelector('.hero-head .icon');
      if(heroIconEl){ heroIconEl.textContent = lookupEquipIcon(TYPE); }

      const serialLabel = document.querySelector('label[for="serial"]');
      const serialInput = $("serial");
      if(serialLabel && (TYPE === 'truck' || TYPE === 'trailer')){
        serialLabel.textContent = 'VIN #';
        serialLabel.classList.add('req');
        if(serialInput){ serialInput.placeholder = 'VIN (required)'; }
      }

      buildYearOptions();
      $("yearTrigger").addEventListener('click', ()=>{
        const open = $("yearTrigger").getAttribute('aria-expanded') === 'true';
        if(open) closeYearPanel(); else openYearPanel();
      });

      buildDdObjects();
      initExtras();

      await populateMakes(db);

      $("serial").addEventListener("input", validateForm);

      $("btnQR").addEventListener("click", async ()=>{
        if(!pendingEquipId){
          const tmpRef = doc(collection(db, 'equipment'));
          pendingEquipId = tmpRef.id;
        }
        const hubAbs = location.origin + `/Farm-vista/pages/equipment/actions/hub.html?id=${encodeURIComponent(pendingEquipId)}`;
        try{ await makeQRForUrl(hubAbs); }
        catch(e){ console.error(e); alert("Could not create QR code."); }
      });

      $("btnSave").addEventListener("click", ()=> saveAll(db, { post:'reset' }));

      $("btnSavePrint").addEventListener("click", async ()=>{
        try{
          await ensureQrReservedAndBuilt(db);
          const result = await saveAll(db, { post:'none' });
          if(!result || !result.ok) return;

          const form = result.form || readForm();
          const qrDataUrl = $("qrThumb")?.src || "";

          // Build preview + preload iframe print HTML
          await setPrintPreview({
            makeName: form.makeName,
            modelName: form.modelName,
            serial: form.serial,
            qrDataUrl
          });

          PrintUI.open();
        }catch(e){
          console.error(e);
          alert("Save & Print failed.");
        }
      });

      $("btnClear").addEventListener("click", () => {
        if (document.referrer) history.back();
        else window.location.assign('/Farm-vista/index.html');
      });

      validateForm();
    })();
  </script>
</body>
</html>