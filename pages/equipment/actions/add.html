<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista • Add Equipment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>

  <!-- Theme + base app styles -->
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <!-- Ensure fv-shell -->
  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true; document.head.appendChild(s);
      }
    })();
  </script>

  <style>
    :root{ --brand:var(--green,#3B7E46); --accent:#2F6C3C; --card-max:1100px; }
    body{ background:var(--app-bg,var(--surface)); }
    .wrap{ max-width:var(--card-max); margin:0 auto; padding:clamp(14px,3vw,22px); }

    header.page{margin:8px 0 14px;}
    header.page h1{margin:0 0 6px 0; font-size:clamp(22px,3.5vw,28px)}
    header.page p{margin:0; color:var(--muted,#67706B)}

    .card{ border:1px solid var(--border); border-radius:16px; background:var(--surface); padding:16px; display:grid; gap:14px }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
    @media (max-width:720px){ .grid2{ grid-template-columns:1fr } }

    .field label{ display:block; font-weight:800; margin:0 0 6px }
    .input,.select,.textarea{
      width:100%; font:inherit; font-size:16px; color:var(--text);
      background:var(--card-surface,var(--surface)); border:1px solid var(--border);
      border-radius:10px; padding:10px 12px;
    }
    .textarea{ min-height:90px }

    .row-inline{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .btn{ display:inline-flex; align-items:center; justify-content:center; padding:10px 14px; border-radius:12px; border:1px solid var(--border); background:var(--card-surface,var(--surface)); font-weight:800; color:var(--text)!important; cursor:pointer }
    .btn-primary{ border-color:transparent; background:var(--accent); color:#fff!important }
    .btn-blue{ border-color:transparent; background:#2B6CB0; color:#fff!important } /* blue add buttons */
    .btn-quiet{ background:transparent }

    /* QR preview */
    .qr-wrap{
      display:grid; grid-template-columns:196px 1fr; gap:16px; align-items:center;
      border:1px dashed var(--border); border-radius:12px; padding:12px; background:color-mix(in srgb, var(--brand) 4%, transparent);
    }
    .qr-img{ width:196px; height:196px; display:grid; place-items:center; background:#fff; border:1px solid var(--border); border-radius:8px; padding:8px; overflow:hidden }
    #qrImg{ max-width:180px; max-height:180px; display:block }
    .muted{ color:var(--muted,#67706B) }

    /* Centered modal (for Manage lists + Add dialog) */
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:9000 }
    .modal.show{ display:flex }
    .modal-card{ width:min(620px,95vw); max-height:90vh; overflow:auto; background:var(--surface); border:1px solid var(--border); border-radius:16px; box-shadow:0 20px 60px rgba(0,0,0,.35); display:flex; flex-direction:column; }
    .md-head{ display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--border); background:color-mix(in srgb, var(--brand) 10%, transparent) }
    .md-body{ padding:16px; display:grid; gap:12px }
    .list{ border:1px solid var(--border); border-radius:12px; overflow:hidden }
    .row{ display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center; padding:10px 12px; border-top:1px solid var(--border) }
    .row:first-child{ border-top:none }
    .pill{ font-size:12px; border:1px solid var(--border); border-radius:999px; padding:2px 8px; }
  </style>
</head>
<body>
  <fv-shell>
    <div class="wrap">
      <header class="page">
        <h1>Add Equipment</h1>
        <p class="muted">Pick a Make/Model (or add new), generate the QR, and save.</p>
      </header>

      <!-- Actions + QR -->
      <section class="card">
        <div class="row-inline">
          <button id="btnCreateQR" class="btn" type="button">Create QR Code</button>
          <button id="btnSave" class="btn btn-primary" type="button">Save</button>
          <a class="btn btn-quiet" href="/Farm-vista/pages/equipment/tractors-view.html">Cancel</a>
        </div>

        <div id="qrBox" class="qr-wrap" hidden>
          <div class="qr-img"><img id="qrImg" alt="QR preview"/></div>
          <div>
            <div class="muted">Scannable QR for the unit hub. Print labels from the View screen after saving.</div>
            <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap">
              <a id="openHub" class="btn btn-quiet" target="_blank" rel="noopener">Open Hub</a>
              <a id="downloadPng" class="btn" download="equipment-qr.png">Download PNG</a>
            </div>
          </div>
        </div>
      </section>

      <!-- Form -->
      <section class="card">
        <div class="grid2">
          <div class="field">
            <label>Make</label>
            <div class="row-inline">
              <select id="make" class="select" style="min-width:240px">
                <option value="">— Loading makes… —</option>
              </select>
              <button id="btnAddMake" class="btn btn-blue" type="button">+ Add Make</button>
              <button id="btnManageMake" class="btn" type="button">Manage</button>
            </div>
          </div>

          <div class="field">
            <label>Model</label>
            <div class="row-inline">
              <select id="model" class="select" style="min-width:240px">
                <option value="">— Loading models… —</option>
              </select>
              <button id="btnAddModel" class="btn btn-blue" type="button">+ Add Model</button>
              <button id="btnManageModel" class="btn" type="button">Manage</button>
            </div>
          </div>
        </div>

        <div class="grid2">
          <div class="field">
            <label>Year</label>
            <select id="year" class="select"></select>
          </div>
          <div class="field">
            <label>Serial #</label>
            <input id="serial" class="input" placeholder="Optional">
          </div>
        </div>

        <div class="grid2">
          <div class="field">
            <label>Engine Hours</label>
            <input id="hours" type="number" step="0.1" class="input" placeholder="e.g., 1250.5">
          </div>
          <div class="field">
            <label>Status</label>
            <select id="status" class="select">
              <option value="active" selected>Active</option>
              <option value="archived">Archived</option>
            </select>
          </div>
        </div>

        <div class="field">
          <label>Notes</label>
          <textarea id="notes" class="textarea" placeholder="Optional details"></textarea>
        </div>
      </section>
    </div>
  </fv-shell>

  <!-- Manage Modal (centered) -->
  <div id="manageModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-card">
      <div class="md-head">
        <strong id="manageTitle">Manage</strong>
        <button id="manageClose" class="btn">Close</button>
      </div>
      <div class="md-body">
        <div class="row-inline">
          <input id="manageNewName" class="input" placeholder="New name">
          <button id="manageAddBtn" class="btn btn-blue" type="button">+ Add</button>
        </div>
        <div class="list" id="manageList"></div>
      </div>
    </div>
  </div>

  <script type="module">
    import {
      ready,
      getFirestore,
      collection, doc, setDoc, getDocs, query, where, orderBy, updateDoc, serverTimestamp
    } from '/Farm-vista/js/firebase-init.js';

    /* -------------------- utils -------------------- */
    const $ = id => document.getElementById(id);
    const esc = s => String(s||"").replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;",'"':"&quot;","'":"&#39;"}[m]));
    function fillYears(sel){
      sel.innerHTML = '<option value="">—</option>';
      const now = new Date().getFullYear();
      for(let y=now;y>=1980;y--){ const o=document.createElement('option'); o.value=y; o.textContent=y; sel.appendChild(o); }
    }
    const ensureHttps = (u) => { try{ const url = new URL(u, location.origin); url.protocol='https:'; return url.toString(); }catch{ return u; } };
    const nameFrom = (mk,md,yr)=>{ const nm=[mk,md].filter(Boolean).join(' '); return nm ? (yr?`${nm} (${yr})`:nm) : null; };

    const COLLS = { make:'equipment-makes', model:'equipment-models' };
    let DB, MAKES=[], MODELS=[];
    let pendingRef=null, deepLink=null;
    let manageKind='make'; // current modal context

    /* -------------------- Firestore: read/write catalog -------------------- */
    async function loadCatalog(kind){
      const list=[];
      const snap = await getDocs(query(collection(DB, COLLS[kind]), where('status','==','active'), orderBy('name')));
      snap.forEach(d=>{ const x=d.data(); if(x?.name) list.push(x.name); });
      list.sort((a,b)=>a.localeCompare(b));
      if(kind==='make') MAKES=list; else MODELS=list;
    }
    async function upsertCatalog(kind, name){
      name=(name||'').trim(); if(!name) return false;
      const base = collection(DB, COLLS[kind]);
      let existing=null;
      try{
        const snap = await getDocs(query(base, where('nameLower','==', name.toLowerCase())));
        if(snap.size>0) existing = snap.docs[0];
      }catch(_){}
      if(existing){
        const data=existing.data();
        if(data.status==='archived'){
          await updateDoc(existing.ref, { status:'active', updatedAt:serverTimestamp() });
        }
      }else{
        await setDoc(doc(base), {
          name, nameLower:name.toLowerCase(), status:'active',
          createdAt:serverTimestamp(), updatedAt:serverTimestamp()
        });
      }
      await loadCatalog(kind);
      return true;
    }
    async function setArchived(kind, id, toStatus){
      await updateDoc(doc(DB, COLLS[kind], id), { status:toStatus, updatedAt:serverTimestamp() });
    }

    /* -------------------- UI binders -------------------- */
    function renderSelect(sel, items, label){
      sel.innerHTML = `<option value="">— Select ${label} —</option>` +
        items.map(v=>`<option value="${esc(v)}">${esc(v)}</option>`).join('');
    }

    function openManage(kind){
      manageKind = kind;
      $("#manageTitle").textContent = kind==='make' ? "Manage Makes" : "Manage Models";
      $("#manageNewName").value = "";
      $("#manageModal").classList.add("show");
      renderManageList(kind);
    }
    function closeManage(){ $("#manageModal").classList.remove("show"); }

    async function renderManageList(kind){
      const box = $("#manageList");
      box.innerHTML = "";
      const snap = await getDocs(query(collection(DB, COLLS[kind]), orderBy('name')));
      snap.forEach(d=>{
        const x=d.data(); const row=document.createElement('div'); row.className='row';
        row.innerHTML = `<div><strong>${esc(x.name||'—')}</strong> <span class="pill">${esc(x.status||'active')}</span></div>
                         <div>
                           <button class="btn" data-id="${d.id}" data-next="${x.status==='archived'?'active':'archived'}">
                             ${x.status==='archived'?'Activate':'Archive'}
                           </button>
                         </div>`;
        row.querySelector('button').addEventListener('click', async (e)=>{
          await setArchived(kind, e.currentTarget.dataset.id, e.currentTarget.dataset.next);
          await loadCatalog(kind);
          renderManageList(kind);
          // refresh dropdowns after manage changes
          if(kind==='make') renderSelect($("#make"), MAKES, 'Make');
          else renderSelect($("#model"), MODELS, 'Model');
        });
        box.appendChild(row);
      });
    }

    /* -------------------- QR helpers (reliable PNG) -------------------- */
    const buildLink = (id)=>{
      const url = new URL('/Farm-vista/pages/equipment/actions/hub.html', location.origin);
      url.searchParams.set('id', id);
      return ensureHttps(url.toString());
    };
    function showQr(link){
      // External encoder for bulletproof scannability (quiet zone + PNG)
      const src = `https://api.qrserver.com/v1/create-qr-code/?size=520x520&margin=10&data=${encodeURIComponent(link)}`;
      $("#qrImg").src = src;
      $("#openHub").href = link;
      $("#downloadPng").href = src;
      $("#qrBox").hidden = false;
    }

    /* -------------------- Save flow -------------------- */
    async function createQr(){
      if(!pendingRef) pendingRef = doc(collection(DB,'equipment'));
      deepLink = buildLink(pendingRef.id);
      showQr(deepLink);
    }
    async function saveEquipment(){
      if(!pendingRef) pendingRef = doc(collection(DB,'equipment'));
      if(!deepLink) deepLink = buildLink(pendingRef.id);

      const mk = $("#make").value.trim() || null;
      const md = $("#model").value.trim() || null;
      const yr = $("#year").value ? Number($("#year").value) : null;

      const payload = {
        type: (new URLSearchParams(location.search).get('type') || 'tractor').toLowerCase(),
        name: nameFrom(mk, md, yr),
        makeName: mk, modelName: md, year: yr,
        serial: $("#serial").value.trim() || null,
        engineHours: $("#hours").value ? Number($("#hours").value) : null,
        status: $("#status").value || 'active',
        notes: $("#notes").value.trim() || null,
        qr: deepLink ? { url: deepLink } : null,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      };
      await setDoc(pendingRef, payload);
      if(mk) await upsertCatalog('make', mk);
      if(md) await upsertCatalog('model', md);
      location.href = `/Farm-vista/pages/equipment/${payload.type}s-view.html`;
    }

    /* -------------------- boot -------------------- */
    (async()=>{
      await ready; DB = getFirestore();
      fillYears($("#year"));

      await loadCatalog('make');  renderSelect($("#make"), MAKES, 'Make');
      await loadCatalog('model'); renderSelect($("#model"), MODELS, 'Model');

      // blue add buttons
      $("#btnAddMake").addEventListener('click', ()=> openManage('make'));
      $("#btnAddModel").addEventListener('click', ()=> openManage('model'));

      // manage buttons
      $("#btnManageMake").addEventListener('click', ()=> openManage('make'));
      $("#btnManageModel").addEventListener('click', ()=> openManage('model'));
      $("#manageClose").addEventListener('click', closeManage);

      // modal add
      $("#manageAddBtn").addEventListener('click', async ()=>{
        const name = $("#manageNewName").value.trim();
        if(!name) return;
        const ok = await upsertCatalog(manageKind, name);
        if(ok){
          $("#manageNewName").value="";
          await renderManageList(manageKind);
          // refresh dropdowns immediately and select the newly added value
          if(manageKind==='make'){
            renderSelect($("#make"), MAKES, 'Make');
            $("#make").value = name;
          }else{
            renderSelect($("#model"), MODELS, 'Model');
            $("#model").value = name;
          }
        }
      });

      // actions
      $("#btnCreateQR").addEventListener('click', createQr);
      $("#btnSave").addEventListener('click', saveEquipment);
    })();
  </script>
</body>
</html>