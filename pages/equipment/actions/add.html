<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista â€¢ Add Tractor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>

  <!-- Theme + base app styles -->
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <!-- Ensure fv-shell -->
  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true;
        document.head.appendChild(s);
      }
    })();
  </script>

  <style>
    :root{ --card-max:1100px; --page-bottom-gap:96px; --brand: var(--green, #3B7E46); }
    .wrap{ max-width:var(--card-max); margin:0 auto; padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + var(--page-bottom-gap))!important; }

    .hero{ border:1px solid var(--border); border-radius:14px; background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08)); overflow:hidden; margin-bottom:var(--page-bottom-gap); }
    .hero-head{ display:grid; grid-template-columns:36px 1fr; gap:12px; align-items:center;
      padding:14px 16px; border-bottom:1px solid var(--border); background:var(--surface); }
    .hero-head .icon{ width:24px; height:24px; display:grid; place-items:center; color:var(--brand); }
    .hero-head h1{ margin:0; font-size:clamp(20px,3.2vw,26px); line-height:1.2; }
    .muted{ color:var(--muted,#67706B) }

    .body{ padding:16px; display:grid; gap:14px }
    .row{ display:grid; gap:10px; grid-template-columns:1fr 1fr }
    @media (max-width:880px){ .row{ grid-template-columns:1fr } }

    .field label{ display:flex; align-items:center; gap:10px; font-weight:800; margin:0 0 6px }
    .view-link{ font-weight:800; font-size:12px; text-decoration:underline; cursor:pointer; color:var(--text)!important; }

    .input,.select,.textarea{
      width:100%; font:inherit; font-size:16px; color:var(--text);
      background:var(--card-surface,var(--surface)); border:1px solid var(--border);
      border-radius:10px; padding:12px; outline:none
    }
    .textarea{ min-height:110px; resize:vertical }

    .actions{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-top:6px }
    .btn{
      display:inline-flex; align-items:center; justify-content:center; min-width:148px;
      padding:10px 14px; border-radius:12px; border:1px solid var(--border);
      background:var(--card-surface,var(--surface)); font-weight:800; cursor:pointer;
      -webkit-appearance:none; appearance:none; color:var(--text)!important;
    }
    .btn-primary{ border-color:transparent; background:var(--brand); color:#fff!important }
    .btn-quiet{ background:transparent; color:var(--text)!important }
    .btn[disabled]{ opacity:.6; cursor:not-allowed }

    .error{ color:#b00020; font-weight:700 }

    .toast{
      position:fixed; left:50%; bottom:calc(env(safe-area-inset-bottom,0px) + 72px);
      transform:translateX(-50%);
      background:var(--brand); color:#fff; padding:10px 14px; border-radius:10px;
      box-shadow:0 6px 20px rgba(0,0,0,.25); z-index:99999; display:none;
    }
    .toast.show{ display:block; animation:fadeout 5s forwards }
    @keyframes fadeout{ 0%{opacity:1} 85%{opacity:1} 100%{opacity:0} }

    /* ===== Modals (View lists) ===== */
    dialog{ border:none; border-radius:14px; padding:0; max-width:min(600px, 92vw);
            box-shadow:0 18px 60px rgba(0,0,0,.35); }
    dialog::backdrop{ background:rgba(0,0,0,.35) }
    .modal{ padding:16px; background:var(--surface); color:var(--text);
            border:1px solid var(--border); border-radius:14px; display:grid; gap:12px }
    .list{ max-height:52vh; overflow:auto; border:1px solid var(--border); border-radius:10px; background:var(--surface); }
    .rowlist{ display:grid; grid-template-columns:1fr auto; align-items:center; gap:10px; padding:8px 10px; border-bottom:1px solid var(--border); color:var(--text); }
    .rowlist:last-child{ border-bottom:none }
    .btn-mini{ padding:6px 10px; min-width:auto; border-radius:999px; font-weight:800;
               border:1px solid var(--border); background:var(--surface); color:var(--text)!important; }

    /* ===== Compact Year â€” looks exactly like .select ===== */
    .combo{ position:relative; }
    .combo-trigger{ position:relative; display:block; width:100%;
      /* reuse .select visuals via class chaining (no hard-coded theme) */
    }
    .combo-trigger.select{ font:inherit; font-size:16px; padding:12px; border-radius:10px; border:1px solid var(--border);
      background:var(--card-surface,var(--surface)); color:var(--text); cursor:pointer; }
    /* add the same chevron affordance as selects */
    .combo-trigger.select::after{
      content:""; position:absolute; right:12px; top:50%; width:8px; height:8px; transform:translateY(-50%) rotate(45deg);
      border-right:2px solid currentColor; border-bottom:2px solid currentColor; opacity:.75; pointer-events:none;
    }

    .combo-panel{
      position:absolute; left:0; right:0; z-index:1000; margin-top:6px; padding:6px;
      background:var(--surface); border:1px solid var(--border); border-radius:12px;
      box-shadow:0 12px 26px rgba(0,0,0,.18);
      --row-h: 36px; max-height: calc(var(--row-h) * 5 + 12px); overflow:auto;
    }
    .combo-item{
      display:block; width:100%; text-align:left; font:inherit; color:var(--text);
      background:transparent; border:none; border-radius:10px;
      padding:10px 12px; height:var(--row-h); line-height:16px; cursor:pointer;
      /* no bold selection */
      font-weight:400;
    }
    .combo-item:hover, .combo-item:focus{ background:var(--hover, rgba(0,0,0,.06)); outline: none; }
    .combo-hidden{ display:none !important; }

    /* ===== QR Preview (tiny square) ===== */
    .qr-area{ border:1px solid var(--border); border-radius:12px; background:var(--surface);
      display:flex; align-items:center; justify-content:center; padding:10px; width:112px; height:112px; }
    #qrThumb{ display:none; max-width:100%; max-height:100%; border-radius:6px; }
  </style>
</head>

<body>
  <fv-shell>
    <div class="wrap">
      <section class="hero">
        <header class="hero-head">
          <div class="icon" aria-hidden="true">ðŸšœ</div>
          <div>
            <h1>Add Tractor</h1>
            <p class="muted">Pick Make/Model, set year, optionally add photos.</p>
          </div>
        </header>

        <div class="body">
          <div class="row">
            <div class="field">
              <label for="make">Make * <span id="viewMakes" class="view-link">View</span></label>
              <select id="make" class="select"><option value="">â€” Loadingâ€¦ â€”</option></select>
            </div>
            <div class="field">
              <label for="model">Model * <span id="viewModels" class="view-link">View</span></label>
              <select id="model" class="select" disabled><option value="">â€” Select a Make first â€”</option></select>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="year">Year</label>
              <!-- Compact custom (5 rows), visually identical to .select; native <select> kept hidden for compatibility -->
              <div class="combo" id="yearCombo">
                <button type="button" id="yearTrigger" class="select combo-trigger" aria-haspopup="listbox" aria-expanded="false">
                  â€” Select â€”
                </button>
                <div id="yearPanel" class="combo-panel combo-hidden" role="listbox" aria-label="Year"></div>
                <select id="year" class="select" aria-hidden="true" style="display:none"></select>
              </div>
            </div>

            <div class="field">
              <label for="serial">Serial #</label>
              <input id="serial" class="input" placeholder="Optional">
            </div>
          </div>

          <div class="field">
            <label for="engineHours">Engine Hours</label>
            <input id="engineHours" type="number" class="input" inputmode="decimal" step="0.1" placeholder="e.g., 1250.5">
          </div>

          <div class="field">
            <label for="notes">Notes</label>
            <textarea id="notes" class="textarea" placeholder="Optional details (tires, guidance, attachments, etc.)"></textarea>
          </div>

          <div class="field">
            <label for="photos">Photos (optional)</label>
            <input id="photos" class="input" type="file" accept="image/*,.jpg,.jpeg,.png,.heic,.pdf" multiple>
          </div>

          <!-- Tiny QR preview (hidden until generated) -->
          <div id="qrArea" class="qr-area" hidden>
            <img id="qrThumb" alt="QR code">
          </div>

          <div id="err" class="error" hidden></div>

          <!-- Button order: Save â€¢ Create QR Code â€¢ Cancel -->
          <div class="actions">
            <button id="btnSave" class="btn btn-primary" type="button">Save</button>
            <button id="btnQR" class="btn" type="button">Create QR Code</button>
            <button id="btnClear" class="btn btn-quiet" type="button">Cancel</button>
          </div>
        </div>
      </section>
    </div>
  </fv-shell>

  <div id="toast" class="toast" role="status" aria-live="polite">Saved.</div>

  <!-- QR library -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js" onload="window.__qrReady=true;"></script>

  <script type="module">
    import {
      ready,
      getFirestore,
      collection, setDoc, doc, updateDoc, deleteDoc, getDocs, getDoc,
      query, orderBy, where,
      serverTimestamp
    } from '/Farm-vista/js/firebase-init.js';

    const $ = id => document.getElementById(id);

    function showToast(msg="Saved.", ms=3500){
      const t=$("toast"); t.textContent=msg; t.classList.remove("show"); t.style.display='block';
      void t.offsetWidth; t.classList.add("show");
      setTimeout(()=>{ t.classList.remove("show"); t.style.display='none'; }, ms);
    }

    /* ===== Year options + compact combo (no bold, same look) ===== */
    function buildYearOptions(){
      const sel=$("year"); const now=new Date().getFullYear();
      sel.innerHTML='<option value="">â€” Select â€”</option>';
      for(let y=now; y>=1980; y--){ const o=document.createElement('option'); o.value=String(y); o.textContent=String(y); sel.appendChild(o); }
      const panel=$("yearPanel"), trigger=$("yearTrigger");
      panel.innerHTML="";
      [...sel.options].forEach((opt, idx)=>{
        const btn=document.createElement('button');
        btn.type='button'; btn.className='combo-item'; btn.role='option';
        btn.dataset.val=opt.value; btn.textContent=opt.textContent;
        btn.addEventListener('click', ()=>{
          sel.value = opt.value;
          trigger.textContent = opt.value ? opt.textContent : "â€” Select â€”";
          closeYearPanel();
        });
        panel.appendChild(btn);
      });
    }
    function openYearPanel(){
      const trigger=$("yearTrigger"), panel=$("yearPanel");
      panel.classList.remove('combo-hidden');
      trigger.setAttribute('aria-expanded','true');
      document.addEventListener('click', onDocClickClose, { once:true });
      document.addEventListener('keydown', onEscClose);
    }
    function closeYearPanel(){
      const trigger=$("yearTrigger"), panel=$("yearPanel");
      panel.classList.add('combo-hidden');
      trigger.setAttribute('aria-expanded','false');
      document.removeEventListener('keydown', onEscClose);
    }
    function onDocClickClose(e){
      if(!$("yearCombo").contains(e.target)) closeYearPanel();
      else document.addEventListener('click', onDocClickClose, { once:true });
    }
    function onEscClose(e){ if(e.key==='Escape') closeYearPanel(); }

    /* ===== Data helpers ===== */
    function currentType(){ const p=new URLSearchParams(location.search); return (p.get('type')||'tractor').toLowerCase(); }
    function readForm(){
      const makeSel=$("make"), modelSel=$("model");
      const makeId=makeSel.value||null, modelId=modelSel.value||null;
      const makeName=makeId? makeSel.options[makeSel.selectedIndex].textContent.trim():null;
      const modelName=modelId? modelSel.options[modelSel.selectedIndex].textContent.trim():null;
      const yr = $("year").value ? Number($("year").value) : null;
      const name = [makeName, modelName].filter(Boolean).join(" ") + (yr?` (${yr})`:"");
      return {
        makeId, modelId, makeName, modelName,
        year: yr,
        serial: $("serial").value.trim() || null,
        engineHours: $("engineHours").value ? Number($("engineHours").value) : null,
        notes: $("notes").value.trim() || null,
        type: currentType(),
        name: name.trim()
      };
    }

    async function ensureSaved(db, existingId){
      if(existingId){ return existingId; }
      const makeId = $("make").value, modelId=$("model").value;
      if(!makeId){ alert("Please choose a Make."); throw new Error("no-make"); }
      if(!modelId){ alert("Please choose a Model."); throw new Error("no-model"); }

      const ref = doc(collection(db,'equipment'));
      const base = readForm();
      await setDoc(ref, {
        ...base,
        status:"active",
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });

      // optional photos
      const files = Array.from(($("photos").files||[]));
      if(files.length){
        try{
          const m = await import('/Farm-vista/js/firebase-init.js');
          const st = m.getStorage(); const out=[];
          for(const f of files){
            const safe = (Date.now()+'-'+f.name).replace(/[^\w.\-]+/g,'_');
            const r = m.ref(st, `equipment/${ref.id}/${safe}`);
            await m.uploadBytes(r, f, { contentType: f.type || 'application/octet-stream' });
            const url = await m.getDownloadURL(r);
            out.push({name:f.name, url, path:`equipment/${ref.id}/${safe}`});
          }
          await updateDoc(ref, { photos: out, updatedAt: serverTimestamp() });
        }catch(stErr){
          $("err").hidden=false; $("err").textContent = `Saved but photo upload failed: ${stErr.message}`;
        }
      }

      showToast("Saved");
      return ref.id;
    }

    function randTokenHex(len=24){
      const bytes=new Uint8Array(len/2); crypto.getRandomValues(bytes);
      return Array.from(bytes,b=>b.toString(16).padStart(2,'0')).join('');
    }

    function equipmentHubUrlAbs(id, token){
      const hub = `/Farm-vista/pages/equipment/equipment-hub.html?id=${encodeURIComponent(id)}&t=${encodeURIComponent(token)}`;
      const launch = location.origin + '/Farm-vista/launch.html';
      const url = new URL(launch);
      url.searchParams.set('to', location.origin + hub);
      return url.href;
    }

    async function generateAndStoreQR(db, id){
      // confirm doc exists
      const ref = doc(db,'equipment', id);
      const snap = await getDoc(ref);
      if(!snap.exists()) throw new Error('not-found');

      // write token
      const token = randTokenHex(24);
      await updateDoc(ref, { qr:{ token, createdAt: serverTimestamp(), updatedAt: serverTimestamp() }, updatedAt: serverTimestamp() });

      // ensure QR lib is present
      let tries=0; while(!(window.__qrReady && window.QRCode && window.QRCode.CorrectLevel) && tries++<200){
        await new Promise(r=>setTimeout(r,50));
      }
      if(!(window.QRCode && window.QRCode.CorrectLevel)) throw new Error('qr-lib');

      const smartLink = equipmentHubUrlAbs(id, token);
      const size = 256, ecc = window.QRCode.CorrectLevel.H;

      const holder=document.createElement('div');
      new QRCode(holder,{ text:smartLink, width:size, height:size, colorDark:"#000000", colorLight:"#ffffff", correctLevel:ecc });

      const node = await new Promise((res,rej)=>{
        const start=Date.now();
        (function check(){
          const n = holder.querySelector('canvas') || holder.querySelector('img');
          if(n) res(n);
          else if(Date.now()-start>4000) rej(new Error('qr-timeout'));
          else requestAnimationFrame(check);
        })();
      });

      let canvas;
      if(node.tagName==='CANVAS'){ canvas=node; }
      else{
        canvas=document.createElement('canvas'); canvas.width=size; canvas.height=size;
        const ctx=canvas.getContext('2d');
        await new Promise((res,rej)=>{
          const img=new Image(); img.crossOrigin='anonymous';
          img.onload=()=>{ ctx.drawImage(img,0,0,size,size); res(); };
          img.onerror=rej; img.src=node.src;
        });
      }

      const dataURL = canvas.toDataURL('image/png');
      const thumb = $("qrThumb");
      thumb.src = dataURL;
      thumb.onload = ()=>{ $("qrArea").hidden=false; thumb.style.display='block'; };

      return { smartLink, token, dataURL };
    }

    (async()=>{
      await ready;
      const db  = getFirestore();

      const params = new URLSearchParams(location.search);
      const type = (params.get('type') || 'tractor').toLowerCase();
      document.title = `FarmVista â€¢ Add ${type[0].toUpperCase()+type.slice(1)}`;
      document.querySelector('.hero-head h1').textContent = `Add ${type[0].toUpperCase()+type.slice(1)}`;

      // year
      buildYearOptions();
      $("yearTrigger").addEventListener('click', ()=>{
        const open = $("yearTrigger").getAttribute('aria-expanded') === 'true';
        if(open) closeYearPanel(); else openYearPanel();
      });

      // ===== Makes / Models =====
      async function getMakes(db){
        const items=[];
        try{
          const snap=await getDocs(query(collection(db,'equipment-makes'), where('archived','!=',true), orderBy('archived'), orderBy('name')));
          snap.forEach(d=>{ const v=d.data()||{}; const name=String(v.name||'').trim(); if(name) items.push({id:d.id,name}); });
        }catch{
          const snap=await getDocs(collection(db,'equipment-makes'));
          snap.forEach(d=>{ const v=d.data()||{}; if(!v.archived){ const name=String(v.name||'').trim(); if(name) items.push({id:d.id,name}); } });
          items.sort((a,b)=>a.name.localeCompare(b.name));
        }
        return items;
      }
      async function getModels(db, makeId){
        if(!makeId) return [];
        const items=[];
        try{
          const snap=await getDocs(query(collection(db,'equipment-models'), where('makeId','==',makeId), where('archived','!=',true), orderBy('archived'), orderBy('name')));
          snap.forEach(d=>{ const v=d.data()||{}; const name=String(v.name||'').trim(); if(name) items.push({id:d.id,name}); });
        }catch{
          const snap=await getDocs(query(collection(db,'equipment-models'), where('makeId','==',makeId)));
          snap.forEach(d=>{ const v=d.data()||{}; if(!v.archived){ const name=String(v.name||'').trim(); if(name) items.push({id:d.id,name}); } });
          items.sort((a,b)=>a.name.localeCompare(b.name));
        }
        return items;
      }
      function renderMakeOptions(list){
        const addOpt = `<option value="__add_make__">Add Newâ€¦</option>`;
        return '<option value="">â€” Select â€”</option>' + addOpt +
               list.map(x=>`<option value="${x.id}">${x.name}</option>`).join('');
      }
      function renderModelOptions(list){
        const addOpt = `<option value="__add_model__">Add Newâ€¦</option>`;
        return '<option value="">â€” Select â€”</option>' + addOpt +
               list.map(x=>`<option value="${x.id}">${x.name}</option>`).join('');
      }

      let makes = await getMakes(db);
      $("make").innerHTML = renderMakeOptions(makes);

      $("make").addEventListener("change", async (e)=>{
        const val = e.target.value;
        if(val==="__add_make__"){
          const name = prompt("Add Make");
          if(name){
            const ref = doc(collection(db,'equipment-makes'));
            await setDoc(ref, { name, archived:false, createdAt:serverTimestamp(), updatedAt:serverTimestamp() });
            makes = await getMakes(db);
            $("make").innerHTML = renderMakeOptions(makes);
            $("make").value = ref.id;
            $("model").disabled=false;
            $("model").innerHTML = renderModelOptions([]);
          }else{
            $("make").selectedIndex = 0;
            $("model").disabled=true;
            $("model").innerHTML = '<option value="">â€” Select a Make first â€”</option>';
          }
          return;
        }
        if(!val){
          $("model").disabled=true;
          $("model").innerHTML = '<option value="">â€” Select a Make first â€”</option>';
          return;
        }
        const models = await getModels(db, val);
        $("model").disabled=false;
        $("model").innerHTML = renderModelOptions(models);
      });

      $("model").addEventListener("change", async (e)=>{
        const makeId = $("make").value;
        const val = e.target.value;
        if(val==="__add_model__"){
          if(!makeId){ alert("Choose a Make first."); $("model").selectedIndex=0; return; }
          const name = prompt("Add Model");
          if(name){
            const ref = doc(collection(db,'equipment-models'));
            await setDoc(ref, { name, makeId, archived:false, createdAt:serverTimestamp(), updatedAt:serverTimestamp() });
            const models = await getModels(db, makeId);
            $("model").innerHTML = renderModelOptions(models);
            const opt = Array.from($("model").options).find(o=>o.textContent.trim()===name);
            if(opt) $("model").value = opt.value;
          }else{
            $("model").selectedIndex = 0;
          }
        }
      });

      // ===== Save / QR / Cancel =====
      let currentId = null;

      async function handleSave(){
        try{ currentId = await ensureSaved(db, currentId); showToast("Saved"); }
        catch(e){ /* alerts already shown for missing fields */ }
      }

      async function handleCreateQR(){
        try{
          // If not saved yet, save first (quietly). User can press any time.
          currentId = await ensureSaved(db, currentId);
          await generateAndStoreQR(db, currentId);
          showToast("QR code ready");
        }catch(err){
          console.error(err);
          alert("Could not create QR code.");
        }
      }

      function handleClear(){
        ["serial","engineHours","notes"].forEach(id=>$(id).value="");
        $("photos").value="";
        $("year").value="";
        $("yearTrigger").textContent="â€” Select â€”";
        $("model").disabled=true; $("model").innerHTML='<option value="">â€” Select a Make first â€”</option>';
        $("make").selectedIndex=0;
        $("qrThumb").src=""; $("qrThumb").style.display='none'; $("qrArea").hidden=true;
        currentId=null;
        window.scrollTo({ top:0, behavior:'smooth' }); $("make").focus();
      }

      $("btnSave").addEventListener("click", handleSave);
      $("btnQR").addEventListener("click", handleCreateQR);
      $("btnClear").addEventListener("click", handleClear);

      // wire year trigger
      $("yearTrigger").addEventListener('click', ()=>{
        const isOpen = $("yearTrigger").getAttribute('aria-expanded') === 'true';
        if(isOpen) closeYearPanel(); else openYearPanel();
      });

      $("make").focus();
    })();
  </script>
</body>
</html>
