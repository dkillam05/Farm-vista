<!-- =========================================================
FULL REPLACEMENT
/Farm-vista/pages/equipment/actions/add.html
(Add Tractor â€” instant QR, improved quiet zone & sharp render)
========================================================= -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista â€¢ Add Tractor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>

  <!-- Theme + base app styles -->
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <!-- Ensure fv-shell -->
  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true;
        document.head.appendChild(s);
      }
    })();
  </script>

  <style>
    :root{ --card-max:1100px; --page-bottom-gap:96px; --brand: var(--green, #3B7E46); }
    body{ background:var(--app-bg,var(--surface)); }
    .wrap{ max-width:var(--card-max); margin:0 auto; padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + var(--page-bottom-gap))!important; }

    .hero{ border:1px solid var(--border); border-radius:14px; background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08)); overflow:hidden; margin-bottom:var(--page-bottom-gap); }
    .hero-head{ display:grid; grid-template-columns:36px 1fr; gap:12px; align-items:center;
      padding:14px 16px; border-bottom:1px solid var(--border);
      background: color-mix(in srgb, var(--brand) 12%, transparent); }
    .hero-head .icon{ width:24px; height:24px; display:grid; place-items:center; color:var(--brand); }
    .hero-head h1{ margin:0; font-size:clamp(20px,3.2vw,26px); line-height:1.2; }
    .muted{ color:var(--muted,#67706B) }

    .body{ padding:16px; display:grid; gap:14px }
    .row{ display:grid; gap:10px; grid-template-columns:1fr 1fr }
    @media (max-width:880px){ .row{ grid-template-columns:1fr } }

    .field label{ display:flex; align-items:center; gap:10px; font-weight:800; margin:0 0 6px }
    .view-link{ font-weight:800; font-size:12px; text-decoration:underline; cursor:pointer }

    .input,.select,.textarea{ width:100%; font:inherit; font-size:16px; color:var(--text);
      background:var(--card-surface,var(--surface)); border:1px solid var(--border);
      border-radius:10px; padding:12px; outline:none }
    .textarea{ min-height:110px; resize:vertical }

    .actions{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-top:6px }
    .btn{ display:inline-flex; align-items:center; justify-content:center; min-width:148px;
      padding:10px 14px; border-radius:12px; border:1px solid var(--border);
      background:var(--card-surface,var(--surface)); font-weight:800; color:var(--text)!important; cursor:pointer }
    .btn-primary{ border-color:transparent; background:var(--brand); color:#fff!important }
    .btn-quiet{ background:transparent }

    .error{ color:#b00020; font-weight:700 }

    /* Toast */
    .toast{
      position:fixed; left:50%; bottom:calc(env(safe-area-inset-bottom,0px) + 72px);
      transform:translateX(-50%);
      background:var(--brand); color:#fff; padding:10px 14px; border-radius:10px;
      box-shadow:0 6px 20px rgba(0,0,0,.25); z-index:99999; display:none;
    }
    .toast.show{ display:block; animation:fadeout 5s forwards }
    @keyframes fadeout{ 0%{opacity:1} 85%{opacity:1} 100%{opacity:0} }

    /* QR */
    .qr-wrap{ display:none; padding:18px; border:1px dashed var(--border); border-radius:12px; background:var(--surface-2,var(--surface)); }
    .qr-wrap.show{ display:block }
    .qr-grid{ display:grid; grid-template-columns:256px 1fr; gap:16px; align-items:center }
    @media (max-width:560px){ .qr-grid{ grid-template-columns:1fr } }
    .qr-img{ width:256px; height:256px; background:#fff; border:1px solid var(--border); border-radius:8px; display:grid; place-items:center; overflow:hidden }
    .qr-img canvas{ image-rendering: pixelated; }
    .qr-meta code{ font-size:13px; background:rgba(0,0,0,.06); padding:3px 6px; border-radius:6px; color:var(--text) }
    .qr-banner{ margin-top:8px; font-size:12px; padding:6px 8px; border:1px solid var(--border); border-radius:8px; display:inline-block;
      background:color-mix(in srgb, var(--brand) 10%, transparent) }

    /* Print */
    @media print{
      body{ background:#fff }
      .hero-head, header.app, footer.app, .actions { display:none !important }
      .qr-sheet{ display:block !important }
    }
    .qr-sheet{ display:none; text-align:center; padding:24px }
    .qr-big{ width:640px; height:640px; margin:12px auto; border:1px solid var(--border); border-radius:16px; display:grid; place-items:center; background:#fff; }
    @media (max-width:560px){ .qr-big{ width:82vw; height:82vw } }
    .qr-big canvas{ image-rendering: pixelated; }
    .qr-note{ font-size:14px; color:#555 }

    /* Modal (compact) */
    dialog{ border:none; border-radius:14px; padding:0; max-width:min(600px, 92vw); box-shadow:0 18px 60px rgba(0,0,0,.35) }
    dialog::backdrop{ background:rgba(0,0,0,.35) }
    .modal{ padding:16px; background:var(--surface); border:1px solid var(--border); border-radius:14px; display:grid; gap:12px }
    .list{ max-height:52vh; overflow:auto; border:1px solid var(--border); border-radius:10px }
    .rowlist{ display:grid; grid-template-columns:1fr auto; align-items:center; gap:10px; padding:8px 10px; border-bottom:1px solid var(--border) }
    .rowlist:last-child{ border-bottom:none }
    .btn-mini{ padding:6px 10px; min-width:auto; border-radius:999px; font-weight:800; border:1px solid var(--border); background:var(--surface); }
  </style>
</head>

<body>
  <fv-shell>
    <div class="wrap">
      <section class="hero">
        <header class="hero-head">
          <div class="icon" aria-hidden="true">ðŸšœ</div>
          <div>
            <h1>Add Tractor</h1>
            <p class="muted">Pick Make/Model, set year, attach photos, then generate a QR for the equipment hub.</p>
          </div>
        </header>

        <div class="body">
          <div class="row">
            <div class="field">
              <label for="make">Make * <span id="viewMakes" class="view-link">View</span></label>
              <select id="make" class="select"><option value="">â€” Loadingâ€¦ â€”</option></select>
            </div>
            <div class="field">
              <label for="model">Model * <span id="viewModels" class="view-link">View</span></label>
              <select id="model" class="select" disabled><option value="">â€” Select a Make first â€”</option></select>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="year">Year</label>
              <select id="year" class="select"></select>
            </div>
            <div class="field">
              <label for="serial">Serial #</label>
              <input id="serial" class="input" placeholder="Optional">
            </div>
          </div>

          <div class="field">
            <label for="engineHours">Engine Hours</label>
            <input id="engineHours" type="number" class="input" inputmode="decimal" step="0.1" placeholder="e.g., 1250.5">
          </div>

          <div class="field">
            <label for="notes">Notes</label>
            <textarea id="notes" class="textarea" placeholder="Optional details (tires, guidance, attachments, etc.)"></textarea>
          </div>

          <div class="field">
            <label for="photos">Photos (optional)</label>
            <input id="photos" class="input" type="file" accept="image/*,.jpg,.jpeg,.png,.heic,.pdf" multiple>
          </div>

          <div id="err" class="error" hidden></div>

          <div class="actions">
            <button id="btnClear" class="btn" type="button">Clear</button>
            <button id="btnSave" class="btn btn-primary" type="button">Save</button>
            <button id="btnQr" class="btn" type="button">Create QR Code</button>
            <button id="btnPrint" class="btn btn-quiet" type="button" disabled>Print QR</button>
          </div>

          <!-- QR inline -->
          <div id="qrWrap" class="qr-wrap" aria-live="polite">
            <div class="qr-grid">
              <div class="qr-img"><canvas id="qrCanvas" width="256" height="256" aria-label="QR code"></canvas></div>
              <div class="qr-meta">
                <div><strong>Equipment:</strong> <span id="qrEquipLabel">â€”</span></div>
                <div><strong>Deep link:</strong> <code id="qrUrl">â€”</code></div>
                <div id="qrBanner" class="qr-banner" hidden>QR created but <strong>not saved</strong> yet. Hit <strong>Save</strong> to activate.</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Print-only sheet -->
      <section id="qrSheet" class="qr-sheet">
        <h2>Equipment QR</h2>
        <div id="qrBig" class="qr-big"><canvas id="qrCanvasBig" width="640" height="640" aria-label="QR code (large)"></canvas></div>
        <p class="qr-note" id="qrMetaLine"></p>
      </section>
    </div>
  </fv-shell>

  <div id="toast" class="toast" role="status" aria-live="polite">Saved.</div>

  <script type="module">
    import {
      ready,
      getFirestore, getAuth,
      collection, setDoc, doc, updateDoc, deleteDoc, getDocs,
      query, orderBy, where,
      serverTimestamp
    } from '/Farm-vista/js/firebase-init.js';

    /* ---------- Utils ---------- */
    const $ = id => document.getElementById(id);
    function showToast(msg="Saved.", ms=3500){
      const t=$("toast"); t.textContent=msg; t.classList.remove("show"); t.style.display='block';
      void t.offsetWidth; t.classList.add("show");
      setTimeout(()=>{ t.classList.remove("show"); t.style.display='none'; }, ms);
    }
    const randTokenHex = (len=24) => {
      const a=new Uint8Array(len); crypto.getRandomValues(a);
      return Array.from(a, b => ('0'+b.toString(16)).slice(-2)).join('');
    };
    const makeUUID = () => (crypto.randomUUID ? crypto.randomUUID() : (Date.now().toString(36)+Math.random().toString(36).slice(2)));
    function buildQrUrl(equipId, token){
      return `${location.origin}/Farm-vista/pages/equipment/actions/hub.html?id=${encodeURIComponent(equipId)}&t=${encodeURIComponent(token)}`;
    }

    /* ---------- CRISP QR with 4-module quiet zone ---------- */
    function drawQr(canvas, text){
      const qr = new QRCodeImpl(text);
      const n = qr.size;
      const quietModules = 4;                       // standard quiet zone
      const moduleSize = Math.floor(canvas.width / (n + quietModules*2));
      const totalSize = moduleSize*(n + quietModules*2);
      const padX = Math.floor((canvas.width  - totalSize)/2) + moduleSize*quietModules;
      const padY = Math.floor((canvas.height - totalSize)/2) + moduleSize*quietModules;
      const ctx = canvas.getContext('2d');
      ctx.imageSmoothingEnabled = false;
      ctx.fillStyle = '#fff';
      ctx.fillRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = '#000';
      for(let y=0;y<n;y++){
        for(let x=0;x<n;x++){
          if(qr.isDark(y,x)){
            ctx.fillRect(padX + x*moduleSize, padY + y*moduleSize, moduleSize, moduleSize);
          }
        }
      }
    }

    /* ---------- Year list ---------- */
    function buildYearOptions(){
      const sel=$("year"); const now=new Date().getFullYear();
      sel.innerHTML='<option value="">â€” Select â€”</option>';
      for(let y=now; y>=1980; y--){ const o=document.createElement('option'); o.value=String(y); o.textContent=String(y); sel.appendChild(o); }
    }

    /* ---------- Make/Model helpers (unchanged behavior) ---------- */
    async function getMakes(db){
      const items=[];
      try{
        const snap=await getDocs(query(collection(db,'equipment-makes'), where('archived','!=',true), orderBy('archived'), orderBy('name')));
        snap.forEach(d=>{ const v=d.data()||{}; const name=String(v.name||'').trim(); if(name) items.push({id:d.id,name}); });
      }catch{
        const snap=await getDocs(collection(db,'equipment-makes'));
        snap.forEach(d=>{ const v=d.data()||{}; if(!v.archived){ const name=String(v.name||'').trim(); if(name) items.push({id:d.id,name}); } });
        items.sort((a,b)=>a.name.localeCompare(b.name));
      }
      return items;
    }
    async function getModels(db, makeId){
      if(!makeId) return [];
      const items=[];
      try{
        const snap=await getDocs(query(collection(db,'equipment-models'), where('makeId','==',makeId), where('archived','!=',true), orderBy('archived'), orderBy('name')));
        snap.forEach(d=>{ const v=d.data()||{}; const name=String(v.name||'').trim(); if(name) items.push({id:d.id,name}); });
      }catch{
        const snap=await getDocs(query(collection(db,'equipment-models'), where('makeId','==',makeId)));
        snap.forEach(d=>{ const v=d.data()||{}; if(!v.archived){ const name=String(v.name||'').trim(); if(name) items.push({id:d.id,name}); } });
        items.sort((a,b)=>a.name.localeCompare(b.name));
      }
      return items;
    }
    function renderMakeOptions(list){
      const addOpt = `<option value="__add_make__">âž• Add new makeâ€¦</option>`;
      return '<option value="">â€” Select â€”</option>' + addOpt +
             list.map(x=>`<option value="${x.id}">${x.name}</option>`).join('');
    }
    function renderModelOptions(list){
      const addOpt = `<option value="__add_model__">âž• Add new modelâ€¦</option>`;
      return '<option value="">â€” Select â€”</option>' + addOpt +
             list.map(x=>`<option value="${x.id}">${x.name}</option>`).join('');
    }

    /* ---------- Small modal helpers (compact) ---------- */
    function openListModal({title, rows}){
      const dlg=document.createElement('dialog');
      dlg.innerHTML=`
        <form method="dialog" class="modal">
          <h3>${title}</h3>
          <div class="list">${rows.map(r=>`
            <div class="rowlist" data-id="${r.id}">
              <div><strong>${r.name}</strong></div>
              <div>
                <button class="btn-mini" data-act="edit"  type="button">Edit</button>
                <button class="btn-mini" data-act="archive" type="button">Archive</button>
                <button class="btn-mini" data-act="delete" type="button">Delete</button>
              </div>
            </div>`).join('')}
          </div>
          <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px">
            <button class="btn" value="cancel">Close</button>
          </div>
        </form>`;
      document.body.appendChild(dlg);
      dlg.addEventListener('close', ()=> dlg.remove());
      dlg.showModal();
      return dlg;
    }
    async function promptText(label, value=""){
      return new Promise(res=>{
        const dlg=document.createElement('dialog');
        dlg.innerHTML=`
          <form method="dialog" class="modal">
            <h3>${label}</h3>
            <input id="txt" class="input" value="${value||''}" autofocus>
            <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px">
              <button class="btn" value="cancel">Cancel</button>
              <button class="btn btn-primary" value="ok">Save</button>
            </div>
          </form>`;
        document.body.appendChild(dlg);
        dlg.addEventListener('close', ()=>{ const v=dlg.returnValue==='ok' ? dlg.querySelector('#txt').value.trim() : null; dlg.remove(); res(v); });
        dlg.showModal();
      });
    }
    async function confirmBox(msg){
      return new Promise(res=>{
        const dlg=document.createElement('dialog');
        dlg.innerHTML=`
          <form method="dialog" class="modal">
            <h3>Confirm</h3>
            <div>${msg}</div>
            <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px">
              <button class="btn" value="no">No</button>
              <button class="btn btn-primary" value="yes">Yes</button>
            </div>
          </form>`;
        document.body.appendChild(dlg);
        dlg.addEventListener('close', ()=>{ res(dlg.returnValue==='yes'); dlg.remove(); });
        dlg.showModal();
      });
    }

    /* ---------- State for instant-QR ---------- */
    let pending = { equipId:null, token:null, url:null };

    /* ---------- Boot ---------- */
    (async()=>{
      await ready;
      const db  = getFirestore();

      const params = new URLSearchParams(location.search);
      const type = (params.get('type') || 'tractor').toLowerCase();
      document.title = `FarmVista â€¢ Add ${type[0].toUpperCase()+type.slice(1)}`;
      document.querySelector('.hero-head h1').textContent = `Add ${type[0].toUpperCase()+type.slice(1)}`;

      buildYearOptions();

      // Load makes
      let makes = await getMakes(db);
      $("make").innerHTML = renderMakeOptions(makes);

      $("make").addEventListener("change", async (e)=>{
        const val = e.target.value;
        if(val==="__add_make__"){
          const name = await promptText("Add Make");
          if(name){
            const ref = doc(collection(db,'equipment-makes'));
            await setDoc(ref, { name, archived:false, createdAt:serverTimestamp(), updatedAt:serverTimestamp() });
            makes = await getMakes(db);
            $("make").innerHTML = renderMakeOptions(makes);
            $("make").value = ref.id;
            $("model").disabled=false;
            $("model").innerHTML = renderModelOptions([]);
          }else{
            $("make").selectedIndex = 0;
            $("model").disabled=true;
            $("model").innerHTML = '<option value="">â€” Select a Make first â€”</option>';
          }
          return;
        }
        if(!val){
          $("model").disabled=true;
          $("model").innerHTML = '<option value="">â€” Select a Make first â€”</option>';
          return;
        }
        const models = await getModels(db, val);
        $("model").disabled=false;
        $("model").innerHTML = renderModelOptions(models);
      });

      $("model").addEventListener("change", async (e)=>{
        const makeId = $("make").value;
        const val = e.target.value;
        if(val==="__add_model__"){
          if(!makeId){ alert("Choose a Make first."); $("model").selectedIndex=0; return; }
          const name = await promptText("Add Model");
          if(name){
            const ref = doc(collection(db,'equipment-models'));
            await setDoc(ref, { name, makeId, archived:false, createdAt:serverTimestamp(), updatedAt:serverTimestamp() });
            const models = await getModels(db, makeId);
            $("model").innerHTML = renderModelOptions(models);
            const opt = Array.from($("model").options).find(o=>o.textContent.trim()===name);
            if(opt) $("model").value = opt.value;
          }else{
            $("model").selectedIndex = 0;
          }
        }
      });

      // View lists
      $("viewMakes").addEventListener("click", async ()=>{
        const rows = (await getMakes(db)).map(x=>({id:x.id, name:x.name}));
        const dlg = openListModal({ title:"Makes", rows });
        dlg.querySelector('.list').addEventListener('click', async (ev)=>{
          const btn = ev.target.closest('button'); if(!btn) return;
          const row = ev.target.closest('.rowlist'); const id=row.dataset.id;
          if(btn.dataset.act==="edit"){
            const current = rows.find(r=>r.id===id)?.name || "";
            const name = await promptText("Edit Make", current);
            if(name){ await updateDoc(doc(db,'equipment-makes',id), { name, updatedAt:serverTimestamp() }); makes = await getMakes(db); $("make").innerHTML = renderMakeOptions(makes); }
          }else if(btn.dataset.act==="archive"){
            const ok = await confirmBox("Archive this make?");
            if(ok){ await updateDoc(doc(db,'equipment-makes',id), { archived:true, updatedAt:serverTimestamp() }); makes = await getMakes(db); $("make").innerHTML = renderMakeOptions(makes); }
          }else if(btn.dataset.act==="delete"){
            const ok = await confirmBox("Delete this make? (only if not in use)");
            if(ok){ await deleteDoc(doc(db,'equipment-makes',id)); makes = await getMakes(db); $("make").innerHTML = renderMakeOptions(makes); }
          }
        }, { once:false });
      });

      $("viewModels").addEventListener("click", async ()=>{
        const makeId = $("make").value;
        if(!makeId){ alert("Choose a Make first."); return; }
        const rows = (await getModels(db, makeId)).map(x=>({id:x.id, name:x.name}));
        const dlg = openListModal({ title:"Models", rows });
        dlg.querySelector('.list').addEventListener('click', async (ev)=>{
          const btn = ev.target.closest('button'); if(!btn) return;
          const row = ev.target.closest('.rowlist'); const id=row.dataset.id;
          if(btn.dataset.act==="edit"){
            const current = rows.find(r=>r.id===id)?.name || "";
            const name = await promptText("Edit Model", current);
            if(name){ await updateDoc(doc(db,'equipment-models',id), { name, updatedAt:serverTimestamp() }); const models=await getModels(db, makeId); $("model").innerHTML = renderModelOptions(models); }
          }else if(btn.dataset.act==="archive"){
            const ok = await confirmBox("Archive this model?");
            if(ok){ await updateDoc(doc(db,'equipment-models',id), { archived:true, updatedAt:serverTimestamp() }); const models=await getModels(db, makeId); $("model").innerHTML = renderModelOptions(models); }
          }else if(btn.dataset.act==="delete"){
            const ok = await confirmBox("Delete this model? (only if not in use)");
            if(ok){ await deleteDoc(doc(db,'equipment-models',id)); const models=await getModels(db, makeId); $("model").innerHTML = renderModelOptions(models); }
          }
        }, { once:false });
      });

      // Create QR instantly (no write yet)
      $("btnQr").addEventListener("click", ()=>{
        if(!pending.equipId){ pending.equipId = makeUUID(); }
        if(!pending.token){ pending.token = randTokenHex(24); }
        pending.url = buildQrUrl(pending.equipId, pending.token);

        drawQr($("qrCanvas"), pending.url);
        drawQr($("qrCanvasBig"), pending.url);

        const makeName  = $("make").options[$("make").selectedIndex]?.textContent || '';
        const modelName = $("model").options[$("model").selectedIndex]?.textContent || '';
        const yr = $("year").value;
        const label = `${makeName} ${modelName}${yr?` (${yr})`:''}`.trim() || 'Equipment';

        $("qrEquipLabel").textContent = label;
        $("qrUrl").textContent = pending.url;

        $("qrBanner").hidden = false;
        $("qrWrap").classList.add("show");
        $("btnPrint").disabled = false;
        $("qrWrap").scrollIntoView({ behavior:'smooth', block:'start' });
        showToast("QR created â€” not saved yet");
      });

      $("btnPrint").addEventListener("click", ()=>{
        $("qrSheet").style.display='block';
        $("qrMetaLine").textContent = `${$("qrEquipLabel").textContent} â€” ${pending.url || ''}`;
        window.print();
      });

      // Save
      $("btnSave").addEventListener("click", async ()=>{
        $("err").hidden=true;

        const makeId = $("make").value, modelId=$("model").value;
        if(!makeId){ alert("Please choose a Make."); return; }
        if(!modelId){ alert("Please choose a Model."); return; }

        const db = getFirestore();
        const type = (new URLSearchParams(location.search).get('type') || 'tractor').toLowerCase();
        const makeName  = $("make").options[$("make").selectedIndex].textContent.trim();
        const modelName = $("model").options[$("model").selectedIndex].textContent.trim();
        const yr = $("year").value ? Number($("year").value) : null;
        const name = `${makeName} ${modelName}${yr?` (${yr})`:''}`;

        if(!pending.equipId){ pending.equipId = makeUUID(); }
        if(!pending.token){ pending.token = randTokenHex(24); }
        pending.url = buildQrUrl(pending.equipId, pending.token);

        const ref = doc(db,'equipment', pending.equipId);
        const base = {
          type, name, makeId, modelId, makeName, modelName,
          year: yr,
          serial: $("serial").value.trim() || null,
          engineHours: $("engineHours").value ? Number($("engineHours").value) : null,
          notes: $("notes").value.trim() || null,
          status: "active",
          qr: { token: pending.token, url: pending.url, createdAt: serverTimestamp() },
          createdAt: serverTimestamp(), updatedAt: serverTimestamp()
        };
        await setDoc(ref, base, { merge:true });

        // optional photos
        const files = Array.from(($("photos").files||[]));
        if(files.length){
          try{
            const m = await import('/Farm-vista/js/firebase-init.js');
            const st = m.getStorage(); const out=[];
            for(const f of files){
              const safe = (Date.now()+'-'+f.name).replace(/[^\w.\-]+/g,'_');
              const r = m.ref(st, `equipment/${pending.equipId}/${safe}`);
              await m.uploadBytes(r, f, { contentType: f.type || 'application/octet-stream' });
              const url = await m.getDownloadURL(r);
              out.push({name:f.name, url, path:`equipment/${pending.equipId}/${safe}`});
            }
            await updateDoc(ref, { photos: out, updatedAt: serverTimestamp() });
          }catch(stErr){
            $("err").hidden=false; $("err").textContent = `Saved but photo upload failed: ${stErr.message}`;
          }
        }

        $("qrBanner").hidden = true;
        showToast("Saved â€” Ready for next unit");
        ["serial","engineHours","notes"].forEach(id=>$(id).value="");
        $("photos").value=""; $("year").selectedIndex=0;
        $("model").disabled=true; $("model").innerHTML='<option value="">â€” Select a Make first â€”</option>';
        $("make").selectedIndex=0; window.scrollTo({ top:0, behavior:'smooth' }); $("make").focus();

        pending = { equipId:null, token:null, url:null };
      });

      $("btnClear").addEventListener("click", ()=>{
        ["serial","engineHours","notes"].forEach(id=>$(id).value="");
        $("photos").value=""; $("year").selectedIndex=0;
        $("model").disabled=true; $("model").innerHTML='<option value="">â€” Select a Make first â€”</option>';
        $("make").selectedIndex=0;
        $("qrWrap").classList.remove("show");
        $("btnPrint").disabled=true;
        pending = { equipId:null, token:null, url:null };
        window.scrollTo({ top:0, behavior:'smooth' }); $("make").focus();
      });

      $("make").focus();
    })();

    /* ---------- Tiny QR encoder ---------- */
    class QRBitBuffer{ constructor(){ this.buffer=[]; this.length=0 } get(i){ return ((this.buffer[i>>3] >>> (7 - i%8)) & 1) == 1 } put(num,len){ for(let i=0;i<len;i++) this.putBit(((num >>> (len-i-1))&1)==1) } putBit(bit){ const b=this.length>>3; if(this.buffer.length<=b) this.buffer.push(0); if(bit) this.buffer[b]|=(0x80 >>> (this.length%8)); this.length++ } }
    class QRPolynomial{
      constructor(num, shift){ let o=0; while(o<num.length && num[o]==0) o++; this.num=new Array(num.length-o+shift); for(let i=0;i<num.length-o;i++) this.num[i]=num[i+o]; }
      get length(){ return this.num.length }
      multiply(e){ const num=new Array(this.length+e.length-1).fill(0); for(let i=0;i<this.length;i++) for(let j=0;j<e.length;j++) num[i+j]^=QRMath.gexp(QRMath.glog(this.num[i])+QRMath.glog(e.num[j])); return new QRPolynomial(num,0) }
      mod(e){ if(this.length-e.length<0) return this; const ratio=QRMath.glog(this.num[0]) - QRMath.glog(e.num[0]); const num=this.num.slice(0); for(let i=0;i<e.length;i++) num[i]^=QRMath.gexp(QRMath.glog(e.num[i])+ratio); return new QRPolynomial(num,0).mod(e) }
    }
    class QRMath{ static glog(n){ if(n<1) throw new Error("glog"); return this.LOG_TABLE[n] } static gexp(n){ while(n<0) n+=255; while(n>=256) n-=255; return this.EXP_TABLE[n] } }
    QRMath.EXP_TABLE = new Array(256); QRMath.LOG_TABLE = new Array(256);
    for(let i=0;i<8;i++) QRMath.EXP_TABLE[i]=1<<i;
    for(let i=8;i<256;i++) QRMath.EXP_TABLE[i]=QRMath.EXP_TABLE[i-4]^QRMath.EXP_TABLE[i-5]^QRMath.EXP_TABLE[i-6]^QRMath.EXP_TABLE[i-8];
    for(let i=0;i<256;i++) QRMath.LOG_TABLE[QRMath.EXP_TABLE[i]]=i;
    const QR_RS_BLOCK_TABLE={1:[[26,20]],2:[[44,34]],3:[[70,55]],4:[[100,80]],5:[[134,108]],6:[[172,136]],7:[[196,156]],8:[[242,194]],9:[[292,232]],10:[[346,274]],12:[[466,356]],14:[[614,458]],16:[[782,574]],18:[[976,700]],20:[[1196,842]],21:[[1316,902]]};
    class QRCodeImpl{
      constructor(text){ this.text=text; this.make() }
      get size(){ return this.moduleCount }
      isDark(r,c){ return this.modules[r][c] }
      make(){
        const bytes = new TextEncoder().encode(this.text);
        let ver=1; while(ver<21){ const rs=QR_RS_BLOCK_TABLE[ver]||QR_RS_BLOCK_TABLE[21]; const cap=rs[0][1]; if(bytes.length+6<cap) break; ver++; }
        this.moduleCount=4*ver+17; this.modules=new Array(this.moduleCount); for(let r=0;r<this.moduleCount;r++) this.modules[r]=new Array(this.moduleCount).fill(null);
        this.pp(0,0); this.pp(this.moduleCount-7,0); this.pp(0,this.moduleCount-7); this.tp();
        const data=this.data(ver,bytes); this.map(data);
      }
      pp(row,col){
        for(let r=-1;r<=7;r++){ if(row+r<=-1||this.moduleCount<=row+r) continue;
          for(let c=-1;c<=7;c++){ if(col+c<=-1||this.moduleCount<=col+c) continue;
            if((0<=r&&r<=6&&(c==0||c==6))||(0<=c&&c<=6&&(r==0||r==6))||(2<=r&&r<=4&&2<=c&&c<=4)) this.modules[row+r][col+c]=true;
            else this.modules[row+r][col+c]=false;
          }
        }
      }
      tp(){ for(let i=8;i<this.moduleCount-8;i++){ const v=(i%2)==0; if(this.modules[i][6]===null) this.modules[i][6]=v; if(this.modules[6][i]===null) this.modules[6][i]=v; } }
      data(ver, bytes){
        const buf=new QRBitBuffer(); buf.put(4,4); if(ver<10) buf.put(bytes.length,8); else buf.put(bytes.length,16); for(const b of bytes) buf.put(b,8);
        const dataCount=(QR_RS_BLOCK_TABLE[ver]||QR_RS_BLOCK_TABLE[21])[0][1];
        const out=[]; for(let i=0;i<buf.length;i+=8) out.push((buf.get(i)?128:0)|(buf.get(i+1)?64:0)|(buf.get(i+2)?32:0)|(buf.get(i+3)?16:0)|(buf.get(i+4)?8:0)|(buf.get(i+5)?4:0)|(buf.get(i+6)?2:0)|(buf.get(i+7)?1:0));
        while(out.length<dataCount) out.push((out.length%2)?0x11:0xEC);
        const total=(QR_RS_BLOCK_TABLE[ver]||QR_RS_BLOCK_TABLE[21])[0][0];
        const ec=total-dataCount; const rs=QRUtil.getErrorCorrectPolynomial(ec); const raw=new QRPolynomial(out, rs.length-1); const mod=raw.mod(rs);
        const ecBytes=new Array(ec).fill(0); const m=mod.num; const off=ecBytes.length-m.length; for(let i=0;i<m.length;i++) ecBytes[i+off]=m[i];
        return out.concat(ecBytes);
      }
      map(data){
        let inc=-1,row=this.moduleCount-1,bit=0,byte=0;
        for(let col=this.moduleCount-1; col>0; col-=2){
          if(col==6) col--;
          while(true){
            for(let c=0;c<2;c++){
              if(this.modules[row][col-c]===null){
                let dark=false; if(byte<data.length) dark = (((data[byte] >>> (7-bit)) & 1) == 1);
                this.modules[row][col-c]=dark; bit++; if(bit==8){ bit=0; byte++; }
              }
            }
            row+=inc; if(row<0||this.moduleCount<=row){ row-=inc; inc=-inc; break; }
          }
        }
      }
    }
    const QRUtil={ getErrorCorrectPolynomial(ec){ let a=new QRPolynomial([1],0); for(let i=0;i<ec;i++) a=a.multiply(new QRPolynomial([1, QRMath.gexp(i)],0)); return a; } };
  </script>
</body>
</html>
