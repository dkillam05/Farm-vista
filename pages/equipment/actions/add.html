<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista • Add Equipment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>

  <!-- Theme + base app styles -->
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <!-- Ensure fv-shell -->
  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true; document.head.appendChild(s);
      }
    })();
  </script>

  <style>
    :root{ --brand:var(--green,#3B7E46); --card-max:1100px; }
    body{ background:var(--app-bg,var(--surface)); }
    .wrap{ max-width:var(--card-max); margin:0 auto; padding:clamp(14px,3vw,22px); }
    header.page{margin:8px 0 14px;}
    header.page h1{margin:0 0 6px 0; font-size:clamp(22px,3.5vw,28px)}
    header.page p{margin:0; color:var(--muted,#67706B)}

    .hero{ border:1px solid var(--border); border-radius:16px; background:var(--surface);
      padding:16px; display:grid; gap:12px; }
    .hero-actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
    .btn{ display:inline-flex; align-items:center; justify-content:center; padding:10px 14px; border-radius:12px; border:1px solid var(--border); background:var(--card-surface,var(--surface)); font-weight:800; color:var(--text)!important; cursor:pointer }
    .btn-primary{ border-color:transparent; background:var(--brand); color:#fff!important }
    .btn-quiet{ background:transparent }
    .muted{ color:var(--muted,#67706B); font-size:14px }

    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
    @media (max-width:720px){ .grid2{ grid-template-columns:1fr } }

    .input,.select,.textarea{
      width:100%; font:inherit; font-size:16px; color:var(--text);
      background:var(--card-surface,var(--surface)); border:1px solid var(--border);
      border-radius:10px; padding:10px 12px;
    }
    .textarea{ min-height:90px }

    /* Combobox (custom dropdown) */
    .combo{ position:relative; }
    .combo .display{
      width:100%; text-align:left; cursor:pointer;
      display:flex; align-items:center; justify-content:space-between;
    }
    .combo .display span.value{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .combo .display .caret{ margin-left:10px; font-weight:900 }
    .combo .panel{
      position:absolute; left:0; right:0; top:calc(100% + 6px);
      background:var(--surface); border:1px solid var(--border); border-radius:12px;
      box-shadow:0 16px 50px rgba(0,0,0,.35);
      display:none; z-index:9100;
    }
    .combo.open .panel{ display:block }
    .panel .search{ border:none; border-bottom:1px solid var(--border); border-radius:12px 12px 0 0; padding:10px 12px; width:100%; }
    .panel .list{ max-height:280px; overflow:auto; }
    .panel .opt{
      padding:10px 12px; border-top:1px solid var(--border); cursor:pointer;
      display:flex; align-items:center; justify-content:space-between;
    }
    .panel .opt:first-child{ border-top:none }
    .panel .opt:hover{ background:color-mix(in srgb, var(--brand) 8%, transparent); }
    .panel .add { font-weight:800; }
    .opt.sel { background:color-mix(in srgb, var(--brand) 14%, transparent); }
    .hint{ font-size:12px; color:var(--muted); margin-top:4px }

    /* QR preview */
    .qr-preview{
      display:grid; grid-template-columns:196px 1fr; gap:16px; align-items:center;
      border:1px dashed var(--border); border-radius:12px; padding:12px; background:color-mix(in srgb, var(--brand) 4%, transparent);
    }
    .qr-img{ width:196px; height:196px; display:grid; place-items:center; background:#fff; border:1px solid var(--border); border-radius:8px; padding:8px; overflow:hidden }
    #qrImg{ max-width:180px; max-height:180px; display:block }

    /* Manage Modal (archive/unarchive) */
    .modal{ position:fixed; inset:0; background:rgba(0,0,0,.35); display:none; align-items:center; justify-content:center; z-index:9000; }
    .modal.show{ display:flex; }
    .modal-card{ width:min(620px,95vw); max-height:90vh; overflow:auto; background:var(--surface); border:1px solid var(--border); border-radius:16px; box-shadow:0 20px 60px rgba(0,0,0,.35); display:flex; flex-direction:column; }
    .md-head{ display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--border); background:color-mix(in srgb, var(--brand) 10%, transparent) }
    .md-body{ padding:16px; display:grid; gap:12px }
    .list{ border:1px solid var(--border); border-radius:12px; overflow:hidden }
    .row{ display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center; padding:10px 12px; border-top:1px solid var(--border) }
    .row:first-child{ border-top:none }
    .pill{ font-size:12px; border:1px solid var(--border); border-radius:999px; padding:2px 8px; }
    label.clickable{ cursor:pointer; text-decoration:underline; text-decoration-thickness:1px; text-underline-offset:3px; }
  </style>
</head>
<body>
  <fv-shell>
    <div class="wrap">
      <header class="page">
        <h1>Add Equipment</h1>
        <p class="muted">Fill the basics, create the QR to preview, then save.</p>
      </header>

      <section class="hero">
        <div class="hero-actions">
          <button id="btnCreateQR" class="btn" type="button">Create QR Code</button>
          <button id="btnSave" class="btn btn-primary" type="button">Save</button>
          <a class="btn btn-quiet" href="/Farm-vista/pages/equipment/tractors-view.html">Cancel</a>
        </div>

        <div id="qrPreview" class="qr-preview" hidden>
          <div class="qr-img"><img id="qrImg" alt="QR preview"/></div>
          <div>
            <div class="muted">QR preview. This code deep-links to the equipment hub for this unit. Print labels from the view screen after saving.</div>
            <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap">
              <a id="openHub" class="btn btn-quiet" target="_blank" rel="noopener">Open Hub</a>
              <a id="downloadPng" class="btn" download="equipment-qr.png">Download PNG</a>
            </div>
          </div>
        </div>
      </section>

      <!-- FORM -->
      <section style="margin-top:16px; border:1px solid var(--border); border-radius:16px; background:var(--surface); padding:16px; display:grid; gap:12px">
        <div class="grid2">
          <div>
            <label id="lblMake" class="clickable" title="Tap to manage Makes">Make</label>
            <div class="combo" id="combo-make">
              <button class="input display" type="button" aria-haspopup="listbox">
                <span class="value" id="makeValue">Select…</span>
                <span class="caret">▾</span>
              </button>
              <div class="panel" role="listbox" aria-label="Select Make">
                <input class="search" id="makeSearch" placeholder="Search makes…">
                <div class="list" id="makeListBox"></div>
                <div class="opt add" id="makeAddRow" style="display:none">+ Add “<span id="makeAddText"></span>”</div>
              </div>
            </div>
            <div class="hint">Tip: tap “Make” to archive/activate items.</div>
          </div>

          <div>
            <label id="lblModel" class="clickable" title="Tap to manage Models">Model</label>
            <div class="combo" id="combo-model">
              <button class="input display" type="button" aria-haspopup="listbox">
                <span class="value" id="modelValue">Select…</span>
                <span class="caret">▾</span>
              </button>
              <div class="panel" role="listbox" aria-label="Select Model">
                <input class="search" id="modelSearch" placeholder="Search models…">
                <div class="list" id="modelListBox"></div>
                <div class="opt add" id="modelAddRow" style="display:none">+ Add “<span id="modelAddText"></span>”</div>
              </div>
            </div>
            <div class="hint">Add row appears inside the dropdown.</div>
          </div>
        </div>

        <div class="grid2">
          <div>
            <label>Year</label>
            <select id="year" class="select"></select>
          </div>
          <div>
            <label>Serial #</label>
            <input id="serial" class="input" placeholder="Optional">
          </div>
        </div>

        <div class="grid2">
          <div>
            <label>Engine Hours</label>
            <input id="hours" type="number" step="0.1" class="input" placeholder="e.g., 1250.5">
          </div>
          <div>
            <label>Status</label>
            <select id="status" class="select">
              <option value="active" selected>Active</option>
              <option value="archived">Archived</option>
            </select>
          </div>
        </div>

        <div>
          <label>Notes</label>
          <textarea id="notes" class="textarea" placeholder="Optional details"></textarea>
        </div>
      </section>
    </div>
  </fv-shell>

  <script type="module">
    import {
      ready,
      getFirestore,
      collection, doc, setDoc, getDocs, query, where, orderBy, updateDoc,
      serverTimestamp
    } from '/Farm-vista/js/firebase-init.js';

    /* ---------- helpers ---------- */
    const $ = id => document.getElementById(id);
    function yearOptions(sel){
      sel.innerHTML = '<option value="">—</option>';
      const now = new Date().getFullYear();
      for(let y=now;y>=1980;y--){
        const o=document.createElement('option'); o.value=String(y); o.textContent=String(y); sel.appendChild(o);
      }
    }
    const ensureHttps = (u)=>{ try{ const url = new URL(u, location.origin); if(url.protocol!=='https:') url.protocol='https:'; return url.toString(); }catch{ return u; } };
    const computeName = (make,model,year)=>{ const nm=[make,model].filter(Boolean).join(' '); return nm ? (year?`${nm} (${year})`:nm) : null; };

    const TYPE = (new URLSearchParams(location.search).get('type') || 'tractor').toLowerCase();
    const COLLS = { make:'equipment-makes', model:'equipment-models' };

    let DB, pendingRef=null, deepLink=null;
    let MAKES=[], MODELS=[];

    /* ---------- catalog ops ---------- */
    async function loadCatalog(kind){
      const snap = await getDocs(query(collection(DB, COLLS[kind]), where('status','==','active'), orderBy('name')));
      const items = []; snap.forEach(d=>{ const x=d.data(); if(x?.name) items.push(x.name) });
      items.sort((a,b)=>a.localeCompare(b));
      if(kind==='make') MAKES = items; else MODELS = items;
    }
    async function upsertCatalog(kind, name){
      name=(name||'').trim(); if(!name) return false;
      const base = collection(DB, COLLS[kind]);
      let existing=null;
      try{
        const snap = await getDocs(query(base, where('nameLower','==', name.toLowerCase())));
        if(snap.size>0) existing = snap.docs[0];
      }catch(_){}
      if(existing){
        const data=existing.data();
        if(data.status==='archived'){
          await updateDoc(existing.ref, { status:'active', updatedAt:serverTimestamp() });
        }
      }else{
        await setDoc(doc(base), {
          name, nameLower:name.toLowerCase(), status:'active',
          createdAt:serverTimestamp(), updatedAt:serverTimestamp()
        });
      }
      await loadCatalog(kind); // refresh in-memory list
      return true;
    }

    /* ---------- custom combobox ---------- */
    function setupCombo(kind){
      const root = $("#combo-"+kind);
      const valueEl = $("#"+kind+"Value");
      const searchEl = $("#"+kind+"Search");
      const listBox  = $("#"+kind+"ListBox");
      const addRow   = $("#"+kind+"AddRow");
      const addText  = $("#"+kind+"AddText");

      function items(){ return (kind==='make'?MAKES:MODELS); }
      function open(){ root.classList.add('open'); searchEl.value=''; render(''); setTimeout(()=>searchEl.focus(), 10); }
      function close(){ root.classList.remove('open'); }
      root.querySelector('.display').addEventListener('click', ()=> (root.classList.contains('open')?close():open()));
      document.addEventListener('click', (e)=>{ if(!root.contains(e.target)) close(); });

      function render(term, highlight){
        const t = term.trim().toLowerCase();
        listBox.innerHTML='';
        const pool = items().filter(v => v.toLowerCase().includes(t));
        let selectedEl=null;
        for(const v of pool){
          const row=document.createElement('div');
          row.className='opt';
          if(v===highlight) row.classList.add('sel');
          row.textContent=v;
          row.addEventListener('click', ()=>{ valueEl.textContent=v; valueEl.dataset.val=v; close(); });
          listBox.appendChild(row);
          if(v===highlight) selectedEl=row;
        }
        if(term && !items().some(v=>v.toLowerCase()===t)){
          addText.textContent = term; addRow.style.display='';
        }else{
          addRow.style.display='none';
        }
        if(selectedEl){ selectedEl.scrollIntoView({block:'nearest'}); }
      }

      searchEl.addEventListener('input', (e)=> render(e.target.value));

      addRow.addEventListener('click', async ()=>{
        const term = searchEl.value.trim();
        if(!term) return;
        const ok = await upsertCatalog(kind, term);
        if(ok){
          render('', term);               // re-render list with new item highlighted
          valueEl.textContent = term;     // set as current selection
          valueEl.dataset.val = term;
        }
      });

      return ()=> (valueEl.dataset.val||'').trim();
    }

    /* ---------- Manage modal ---------- */
    function openManage(kind){
      $("#manageTitle").textContent = kind==='make' ? "Manage Makes" : "Manage Models";
      $("#manageModal").classList.add("show");
      renderManage(kind);
    }
    function closeManage(){ $("#manageModal").classList.remove("show"); }
    async function renderManage(kind){
      const list = $("#manageList");
      list.innerHTML = "";
      const snap = await getDocs(query(collection(DB, COLLS[kind]), orderBy('name')));
      snap.forEach(d=>{
        const x=d.data();
        const row=document.createElement('div');
        row.className='row';
        row.innerHTML = `<div><strong>${x.name||'—'}</strong> <span class="pill">${x.status||'active'}</span></div>
                         <div><button class="btn" data-id="${d.id}" data-status="${x.status||'active'}">${x.status==='archived'?'Activate':'Archive'}</button></div>`;
        row.querySelector('button').addEventListener('click', async (e)=>{
          const id=e.currentTarget.dataset.id;
          const status=e.currentTarget.dataset.status==='archived'?'active':'archived';
          await updateDoc(doc(DB, COLLS[kind], id), { status, updatedAt:serverTimestamp() });
          await loadCatalog(kind);
          renderManage(kind);
        });
        list.appendChild(row);
      });
    }

    /* ---------- QR + Save ---------- */
    const buildDeepLink = (id)=> {
      const url = new URL('/Farm-vista/pages/equipment/actions/hub.html', location.origin);
      url.searchParams.set('id', id);
      return url.toString().replace('http:', 'https:');
    };
    function setQrPreview(link){
      // Use a stable external encoder for 100% scannable PNGs
      const src = `https://api.qrserver.com/v1/create-qr-code/?size=520x520&margin=10&data=${encodeURIComponent(link)}`;
      $("#qrImg").src = src;
      $("#openHub").href = link;
      $("#downloadPng").href = src;
      $("#qrPreview").hidden = false;
    }
    async function createQrFlow(){
      if(!pendingRef) pendingRef = doc(collection(DB,'equipment'));
      deepLink = buildDeepLink(pendingRef.id);
      setQrPreview(deepLink);
    }
    async function saveEquipment(getMake, getModel){
      if(!pendingRef){ pendingRef = doc(collection(DB,'equipment')); deepLink = buildDeepLink(pendingRef.id); }
      const make  = getMake();
      const model = getModel();
      const year  = $("#year").value ? Number($("#year").value) : null;
      const serial= $("#serial").value.trim() || null;
      const hours = $("#hours").value ? Number($("#hours").value) : null;
      const status= $("#status").value || 'active';
      const notes = $("#notes").value.trim() || null;

      const payload = {
        type: TYPE,
        name: computeName(make, model, year),
        makeName: make || null,
        modelName: model || null,
        year, serial, engineHours: hours,
        status, notes,
        qr: deepLink ? { url: deepLink } : null,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      };
      await setDoc(pendingRef, payload);
      if(make)  await upsertCatalog('make', make);
      if(model) await upsertCatalog('model', model);
      location.href = `/Farm-vista/pages/equipment/${TYPE}s-view.html`;
    }

    /* ---------- boot ---------- */
    (async()=>{
      await ready; DB = getFirestore();
      yearOptions($("#year"));

      await loadCatalog('make');
      await loadCatalog('model');

      const getMake  = setupCombo('make');
      const getModel = setupCombo('model');

      $("#lblMake").addEventListener('click', ()=> openManage('make'));
      $("#lblModel").addEventListener('click', ()=> openManage('model'));
      $("#manageCloseBtn").addEventListener('click', closeManage);
      $("#manageModal").addEventListener('click', (e)=>{ if(e.target.id==='manageModal') closeManage(); });

      $("#btnCreateQR").addEventListener('click', createQrFlow);
      $("#btnSave").addEventListener('click', ()=> saveEquipment(getMake,getModel));
    })();
  </script>

  <!-- Manage Modal -->
  <div id="manageModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-card">
      <div class="md-head">
        <strong id="manageTitle">Manage</strong>
        <button id="manageCloseBtn" class="btn">Close</button>
      </div>
      <div class="md-body">
        <div class="list" id="manageList"></div>
      </div>
    </div>
  </div>
</body>
</html>