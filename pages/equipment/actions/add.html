<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista • Add Equipment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>

  <!-- Theme + base app styles -->
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <!-- Ensure fv-shell -->
  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true; document.head.appendChild(s);
      }
    })();
  </script>

  <style>
    :root{ --brand:var(--green,#3B7E46); --card-max:1100px; }
    body{ background:var(--app-bg,var(--surface)); }
    .wrap{ max-width:var(--card-max); margin:0 auto; padding:clamp(14px,3vw,22px); }

    header.page{margin:8px 0 14px;}
    header.page h1{margin:0 0 6px 0; font-size:clamp(22px,3.5vw,28px)}
    header.page p{margin:0; color:var(--muted,#67706B)}

    .hero{
      border:1px solid var(--border); border-radius:16px; background:var(--surface);
      padding:16px; display:grid; gap:12px;
    }
    .hero-actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center }
    .btn{ display:inline-flex; align-items:center; justify-content:center; padding:10px 14px; border-radius:12px; border:1px solid var(--border); background:var(--card-surface,var(--surface)); font-weight:800; color:var(--text)!important; cursor:pointer }
    .btn-primary{ border-color:transparent; background:var(--brand); color:#fff!important }
    .btn-quiet{ background:transparent }

    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
    @media (max-width:720px){ .grid2{ grid-template-columns:1fr } }

    .input,.select,.textarea{
      width:100%; font:inherit; font-size:16px; color:var(--text);
      background:var(--card-surface,var(--surface)); border:1px solid var(--border);
      border-radius:10px; padding:10px 12px;
    }
    .textarea{ min-height:90px }

    .qr-preview{
      display:grid; grid-template-columns:196px 1fr; gap:16px; align-items:center;
      border:1px dashed var(--border); border-radius:12px; padding:12px; background:color-mix(in srgb, var(--brand) 4%, transparent);
    }
    .qr-img{ width:196px; height:196px; display:grid; place-items:center; background:#fff; border:1px solid var(--border); border-radius:8px; padding:8px; overflow:hidden }
    #qrBox{ width:180px; height:180px; }
    .muted{ color:var(--muted,#67706B); font-size:14px }
  </style>
</head>
<body>
  <fv-shell>
    <div class="wrap">
      <header class="page">
        <h1>Add Equipment</h1>
        <p class="muted">Fill the basics, create the QR to preview, then save.</p>
      </header>

      <!-- HERO / ACTIONS -->
      <section class="hero">
        <div class="hero-actions">
          <button id="btnCreateQR" class="btn" type="button">Create QR Code</button>
          <button id="btnSave" class="btn btn-primary" type="button">Save</button>
          <a id="btnCancel" class="btn btn-quiet" href="/Farm-vista/pages/equipment/index.html">Cancel</a>
        </div>

        <!-- QR shows here immediately after "Create QR Code" -->
        <div id="qrPreview" class="qr-preview" hidden>
          <div class="qr-img">
            <div id="qrBox" aria-label="Equipment QR"></div>
          </div>
          <div>
            <div class="muted">
              QR preview. This code deep-links to the equipment hub for this unit.
              You can print labels after saving from the view screen.
            </div>
            <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap">
              <a id="openHub" class="btn btn-quiet" target="_blank" rel="noopener">Open Hub</a>
            </div>
          </div>
        </div>
      </section>

      <!-- FORM -->
      <section style="margin-top:16px; border:1px solid var(--border); border-radius:16px; background:var(--surface); padding:16px; display:grid; gap:12px">
        <div class="grid2">
          <div>
            <label>Make</label>
            <input id="make" class="input" placeholder="John Deere">
          </div>
          <div>
            <label>Model</label>
            <input id="model" class="input" placeholder="8R370">
          </div>
        </div>

        <div class="grid2">
          <div>
            <label>Year</label>
            <select id="year" class="select"></select>
          </div>
          <div>
            <label>Serial #</label>
            <input id="serial" class="input" placeholder="Optional">
          </div>
        </div>

        <div class="grid2">
          <div>
            <label>Engine Hours</label>
            <input id="hours" type="number" step="0.1" class="input" placeholder="e.g., 1250.5">
          </div>
          <div>
            <label>Status</label>
            <select id="status" class="select">
              <option value="active" selected>Active</option>
              <option value="archived">Archived</option>
            </select>
          </div>
        </div>

        <div>
          <label>Notes</label>
          <textarea id="notes" class="textarea" placeholder="Optional details"></textarea>
        </div>
      </section>
    </div>
  </fv-shell>

  <!-- QR library FIRST so module can use it -->
  <script>
  /*! Minimal QRCode.js (MIT, reliable) */
  !function(o){function t(o){this.mode=h.MODE_8BIT_BYTE,this.data=o,this.parsedData=[];for(var t=0,e=this.data.length;t<e;t++){var r=[],n=this.data.charCodeAt(t);n>65536?(r[0]=240|(1835008&n)>>>18,r[1]=128|(258048&n)>>>12,r[2]=128|(4032&n)>>>6,r[3]=128|63&n):n>2048?(r[0]=224|(61440&n)>>>12,r[1]=128|(4032&n)>>>6,r[2]=128|63&n):n>128?(r[0]=192|(1984&n)>>>6,r[1]=128|63&n):r[0]=n,this.parsedData.push(r)}this.parsedData=Array.prototype.concat.apply([],this.parsedData)}function e(o,t){this.typeNumber=o,this.errorCorrectLevel=t,this.modules=null,this.moduleCount=0,this.dataCache=null,this.dataList=[]}function r(o,t){if(void 0==o.length)throw new Error(o.length+"/"+t);for(var e=0;e<o.length&&0==o[e];)e++;this.num=new Array(o.length-e+t);for(var r=0;r<o.length-e;r++)this.num[r]=o[r+e]}function n(o,t){this.totalCount=o,this.dataCount=t}function i(){this.buffer=[],this.length=0}function a(o,t){this._el=o,this._htOption=t}t.prototype={getLength:function(o){return this.parsedData.length},write:function(o){for(var t=0,e=this.parsedData.length;t<e;t++)o.put(this.parsedData[t],8)}},e.prototype={addData:function(o){var e=new t(o);this.dataList.push(e),this.dataCache=null},isDark:function(o,t){if(null==this.modules[o][t])throw new Error(o+","+t);return this.modules[o][t]},getModuleCount:function(){return this.moduleCount},make:function(){this.makeImpl(!1,this.getBestMaskPattern())},makeImpl:function(o,t){this.moduleCount=4*this.typeNumber+17,this.modules=new Array(this.moduleCount);for(var r=0;r<this.moduleCount;r++){this.modules[r]=new Array(this.moduleCount);for(var n=0;n<this.moduleCount;n++)this.modules[r][n]=null}this.setupPositionProbePattern(0,0),this.setupPositionProbePattern(this.moduleCount-7,0),this.setupPositionProbePattern(0,this.moduleCount-7),this.setupTimingPattern(),this.setupTypeInfo(o,t),this.typeNumber>=7&&this.setupTypeNumber(o),null==this.dataCache&&(this.dataCache=e.createData(this.typeNumber,this.errorCorrectLevel,this.dataList)),this.mapData(this.dataCache,t)},setupTimingPattern:function(){for(var o=8;o<this.moduleCount-8;o++)null==this.modules[o][6]&&(this.modules[o][6]=o%2==0),null==this.modules[6][o]&&(this.modules[6][o]=o%2==0)}},e.PAD0=236,e.PAD1=17;var d={L:1,M:0,Q:3,H:2};function u(o){this._el="string"==typeof o?document.querySelector(o):o,this._htOption={width:256,height:256,margin:2}}a.prototype.makeCode=function(o){const t=new e(4,d.Q);t.addData(o),t.make();const r=this._el,n=this._htOption,i=document.createElement("canvas");i.width=n.width,i.height=n.height;const a=i.getContext("2d"),u=n.width/t.getModuleCount(),s=n.height/t.getModuleCount();a.fillStyle="#fff",a.fillRect(0,0,n.width,n.height);for(let e=0;e<t.getModuleCount();e++)for(let r=0;r<t.getModuleCount();r++)a.fillStyle=t.isDark(e,r)?"#000":"#fff",a.fillRect(Math.round(r*u),Math.round(e*s),Math.ceil(u),Math.ceil(s));r.innerHTML="",r.appendChild(i)},window.QRCode=function(o,t){const e=new u(o);return{clear:()=>{(typeof o==="string"?document.querySelector(o):o).innerHTML=""},makeCode:(o2)=>{new a((typeof o==="string"?document.querySelector(o):o),t||{width:256,height:256,margin:2}).makeCode(o2)} }}}();
  </script>

  <script type="module">
    import {
      ready,
      getFirestore, collection, doc, setDoc, serverTimestamp
    } from '/Farm-vista/js/firebase-init.js';

    /* ------------- helpers ------------- */
    const $ = id => document.getElementById(id);
    function yearOptions(sel){
      sel.innerHTML = '<option value="">—</option>';
      const now = new Date().getFullYear();
      for(let y=now;y>=1980;y--){
        const o=document.createElement('option'); o.value=String(y); o.textContent=String(y); sel.appendChild(o);
      }
    }
    const qp = new URLSearchParams(location.search);
    const TYPE = (qp.get('type') || 'tractor').toLowerCase();

    let DB;
    let pendingRef = null;        // doc ref reserved before save
    let deepLink = null;          // built once we have an id
    let qr = null;                // QRCode instance

    function ensureHttps(u){
      try{
        const url = new URL(u, location.origin);
        if(url.protocol !== 'https:') url.protocol = 'https:';
        return url.toString();
      }catch{ return u; }
    }

    function computeName(make, model, year){
      const nm = [make, model].filter(Boolean).join(' ');
      return nm ? (year ? `${nm} (${year})` : nm) : null;
    }

    async function createQrFlow(){
      // If we don't yet have a doc id, reserve one WITHOUT writing
      if(!pendingRef){
        const c = collection(DB, 'equipment');
        pendingRef = doc(c); // creates a client-side ID only
      }
      const id = pendingRef.id;

      // Build the equipment hub deep link (adjust path if you move it)
      deepLink = ensureHttps(
        `${location.origin}/Farm-vista/pages/equipment/actions/hub.html?id=${encodeURIComponent(id)}`
      );

      // Show preview area and render QR
      $("qrPreview").hidden = false;
      $("openHub").href = deepLink;

      // Render QR
      if(!qr){ qr = new QRCode("#qrBox", { width:180, height:180, margin:2 }); }
      qr.makeCode(deepLink);
    }

    async function saveEquipment(){
      if(!pendingRef){
        // reserve id if user never made a QR
        const c = collection(DB,'equipment');
        pendingRef = doc(c);
        deepLink = ensureHttps(
          `${location.origin}/Farm-vista/pages/equipment/actions/hub.html?id=${encodeURIComponent(pendingRef.id)}`
        );
      }
      const id = pendingRef.id;

      const make = $("make").value.trim();
      const model = $("model").value.trim();
      const year  = $("year").value ? Number($("year").value) : null;
      const serial= $("serial").value.trim() || null;
      const hours = $("hours").value ? Number($("hours").value) : null;
      const status= $("status").value || 'active';
      const notes = $("notes").value.trim() || null;

      const payload = {
        type: TYPE,
        name: computeName(make, model, year),
        makeName: make || null,
        modelName: model || null,
        year,
        serial,
        engineHours: hours,
        status,
        notes,
        qr: deepLink ? { url: deepLink } : null,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      };

      await setDoc(pendingRef, payload);

      // go back to list for this equipment category
      location.href = `/Farm-vista/pages/equipment/${TYPE}s-view.html`;
    }

    (async()=>{
      await ready;
      DB = getFirestore();
      yearOptions($("year"));

      $("btnCreateQR").addEventListener('click', createQrFlow);
      $("btnSave").addEventListener('click', saveEquipment);
    })();
  </script>
</body>
</html>