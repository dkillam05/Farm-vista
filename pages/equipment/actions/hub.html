<!-- /Farm-vista/pages/equipment/actions/hub.html â€” INFO-ONLY HUB (simple, with Return to Tractors + Return to Home) -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista â€¢ Equipment Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>

  <!-- Theme + app CSS -->
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <!-- Ensure fv-shell -->
  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true; document.head.appendChild(s);
      }
    })();
  </script>

  <style>
    :root{ --card-max:900px; --brand:var(--green,#3B7E46); }
    body{ background:var(--app-bg,var(--surface)); }

    .wrap{ max-width:var(--card-max); margin:0 auto; padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px)+var(--ftr-h,42px)+64px)!important; }

    .hero{ border:1px solid var(--border); border-radius:14px; background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08)); overflow:hidden; margin:8px 0 18px; }
    .hero-head{ display:grid; grid-template-columns:36px 1fr; gap:12px; align-items:center;
      padding:14px 16px; border-bottom:1px solid var(--border);
      background:color-mix(in srgb,var(--brand) 12%, transparent); }
    .hero-head h1{ margin:0; font-size:clamp(20px,3.2vw,26px); }
    .muted{ color:var(--muted,#67706B) }

    .body{ padding:16px; display:grid; gap:18px }
    .card{ border:1px solid var(--border); border-radius:12px; background:var(--surface);
      padding:14px; display:grid; gap:6px }
    .meta{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .chip{ font-size:12px; border:1px solid var(--border); border-radius:999px; padding:4px 8px; background:var(--surface) }

    .actions{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px }
    @media (max-width:560px){ .actions{ grid-template-columns:1fr } }

    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:12px 14px; border-radius:12px; border:1px solid var(--border);
      background:var(--card-surface,var(--surface)); font-weight:800; color:var(--text)!important;
      cursor:pointer; text-decoration:none;
    }
    .btn-primary{ border-color:transparent; background:var(--brand); color:#fff!important }
  </style>
</head>

<body>
  <fv-shell>
    <div class="wrap">
      <section class="hero">
        <header class="hero-head">
          <div aria-hidden="true">ðŸ”—</div>
          <div>
            <h1>Equipment Hub</h1>
            <p class="muted" id="subtitle">Loadingâ€¦</p>
          </div>
        </header>

        <div class="body">
          <!-- Equipment summary -->
          <div class="card" id="eqCard" hidden>
            <h2 id="eqName" style="margin:0"></h2>
            <div class="meta">
              <span id="eqType" class="chip"></span>
              <span id="eqMakeModel" class="chip"></span>
              <span id="eqSerial" class="chip" hidden></span>
              <span id="eqHours" class="chip" hidden></span>
            </div>
            <p id="eqNotes" class="muted" hidden></p>
          </div>

          <!-- Simple, explicit navigation -->
          <div class="actions">
            <a class="btn" href="/Farm-vista/pages/equipment/tractors-view.html">Return to Tractors</a>
            <a class="btn" href="/Farm-vista/index.html">Return to Home</a>
          </div>

          <!-- Functional links (keep id/token) -->
          <div class="actions" id="fnLinks" hidden>
            <a id="linkHours" class="btn btn-primary" href="#">Track Engine Hours</a>
            <a id="linkMaint" class="btn" href="#">Service Records</a>
            <a id="linkReq"   class="btn" href="#">Submit Service Request</a>
            <a id="linkPre"   class="btn" href="#">Pre-Season Checklist</a>
          </div>
        </div>
      </section>
    </div>
  </fv-shell>

  <script type="module">
    import * as FB from '/Farm-vista/js/firebase-init.js';
    const { ready, getFirestore, doc, getDoc, getAuth } = FB;
    const $ = (id)=>document.getElementById(id);
    const qs = new URLSearchParams(location.search);

    let eqId = qs.get('id') || '';
    let token = qs.get('t') || '';

    // Safety-net from session (set by tractors-view "Open Hub")
    if (!eqId)  { const s = sessionStorage.getItem('fv.ctx.eqId');  if (s) eqId = s; }
    if (!token) { const t = sessionStorage.getItem('fv.ctx.eqTok'); if (t) token = t; }

    const setText = (id, val, opts={})=>{
      const el=$(id); if(!el) return;
      if(val==null || val===''){ if(opts.hideIfEmpty) el.hidden=true; else el.textContent=''; return; }
      el.textContent = String(val);
      if(opts.unhide) el.hidden=false;
    };
    const last6 = v => String(v||'').slice(-6);

    // ---------- SELF-GUARD: ensure auth + org context (bounce to Launch if not ready) ----------
    function currentUrl(){
      // Preserve full path + query; keep hash too if present
      return location.pathname + location.search + location.hash;
    }
    function goLaunch(){
      const to = currentUrl();
      const u = new URL('/Farm-vista/launch.html', location.origin);
      u.searchParams.set('to', to.startsWith('/') ? to : '/'+to);
      location.replace(u.href);
    }
    function hasOrg(){
      try{
        const ctx = window.FVUserContext && typeof window.FVUserContext.get==='function'
          ? window.FVUserContext.get() : null;
        return !!(ctx && (ctx.orgId || ctx.org || ctx.tenantId));
      }catch{ return false; }
    }

    async function guardAuthAndContext(){
      await ready;
      const auth = getAuth();
      const user = auth && auth.currentUser;

      // Not signed in â†’ Launch (it will send to /auth then back here)
      if (!user) { goLaunch(); return false; }

      // Give context a brief chance; if it doesn't appear, Launch will soft-proceed
      const start = Date.now();
      while (!hasOrg() && Date.now() - start < 600){
        await new Promise(r=>setTimeout(r,120));
      }
      if (!hasOrg()){
        goLaunch(); return false;
      }
      return true;
    }
    // -------------------------------------------------------------------------------------------

    async function init(){
      $('subtitle').textContent = 'Resolving equipmentâ€¦';

      const ok = await guardAuthAndContext();
      if (!ok) return; // Launch will handle and bring us back

      if (!eqId){ $('subtitle').textContent = 'Ready'; return; } // still show the static buttons

      const db = getFirestore();
      const ref = doc(db,'equipment', eqId);
      const snap = await getDoc(ref);

      if (!snap.exists()){ $('subtitle').textContent = 'Not found'; return; }

      const d = snap.data() || {};
      // Render summary
      const mm = [d.makeName, d.modelName].filter(Boolean).join(' ');
      const ls = last6(d.serial);
      const title = mm ? `${mm}${ls ? ` (#${ls})` : ''}` : (d.name || `Unit ${String(eqId).slice(0,6)}`);
      setText('eqName', title);
      setText('eqType', d.type || 'equipment');
      setText('eqMakeModel', mm);
      if (ls) setText('eqSerial', `SN #${ls}`, {unhide:true});
      if (d.engineHours != null) setText('eqHours', `${d.engineHours} hrs`, {unhide:true});
      if (d.notes) setText('eqNotes', d.notes, {unhide:true});
      $('eqCard').hidden = false;

      // Wire functional links (preserve id/token)
      const base = "/Farm-vista/pages/equipment/actions";
      const tok  = d.qr?.token || token || '';
      const q    = `?id=${encodeURIComponent(eqId)}${tok ? `&t=${encodeURIComponent(tok)}`:''}&from=hub`;
      $("linkHours").href = `${base}/engine-hours.html${q}`;
      $("linkMaint").href = `${base}/maintenance.html${q}`;
      $("linkReq").href   = `${base}/service-request.html${q}`;
      $("linkPre").href   = `${base}/pre-check.html${q}`;
      $('fnLinks').hidden = false;

      $('subtitle').textContent = 'Linked';

      // Clear one-shot context
      sessionStorage.removeItem('fv.ctx.eqId');
      sessionStorage.removeItem('fv.ctx.eqTok');
    }

    init().catch(err=>{
      console.error(err);
      $('subtitle').textContent = 'Error';
    });
  </script>
</body>
</html>
