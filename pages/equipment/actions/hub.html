<!-- /Farm-vista/pages/equipment/equipment-hub.html (FULL FILE) -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista â€¢ Equipment Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>

  <!-- Theme + base app styles -->
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <!-- fv-shell -->
  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true; document.head.appendChild(s);
      }
    })();
  </script>

  <style>
    :root{ --card-max:900px; --brand: var(--green,#3B7E46); }
    body{ background:var(--app-bg,var(--surface)); }
    .wrap{ max-width:var(--card-max); margin:0 auto; padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + 64px)!important; }

    .hero{ border:1px solid var(--border); border-radius:14px; background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08)); overflow:hidden; margin:8px 0 18px; }
    .hero-head{ display:grid; grid-template-columns:36px 1fr; gap:12px; align-items:center;
      padding:14px 16px; border-bottom:1px solid var(--border);
      background: color-mix(in srgb, var(--brand) 12%, transparent); }
    .hero-head h1{ margin:0; font-size:clamp(20px,3.2vw,26px); }
    .body{ padding:16px; display:grid; gap:14px }

    .muted{ color:var(--muted,#67706B) }
    .error{ color:#b00020; font-weight:700 }

    .card{ border:1px solid var(--border); border-radius:12px; background:var(--surface); padding:14px; display:grid; gap:6px }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
    @media (max-width:820px){ .row{ grid-template-columns:1fr } }

    .actions{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px }
    @media (max-width:560px){ .actions{ grid-template-columns:1fr } }
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:12px 14px; border-radius:12px; border:1px solid var(--border);
      background:var(--card-surface,var(--surface)); font-weight:800; color:var(--text)!important; cursor:pointer
    }
    .btn-primary{ border-color:transparent; background:var(--brand); color:#fff!important }

    .state{ padding:12px; border:1px solid var(--border); border-radius:10px; background:var(--surface); }
    .state.warn{ background: color-mix(in srgb, var(--brand) 10%, transparent); }
    .tiny{ font-size:12px; opacity:.9 }

    .meta{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .chip{ font-size:12px; border:1px solid var(--border); border-radius:999px; padding:4px 8px; background:var(--surface) }
    code{ font-size:13px; background:rgba(0,0,0,.06); padding:3px 6px; border-radius:6px; color:var(--text) }

    /* QR card */
    .qr-card{ border:1px dashed var(--border); border-radius:12px; background:color-mix(in srgb, var(--brand) 6%, transparent);
      padding:12px; display:grid; gap:10px }
    .qr-row{ display:flex; gap:14px; align-items:center; flex-wrap:wrap }
    .qr-img{ width:220px; height:220px; background:#fff; border:1px solid var(--border); border-radius:10px;
      display:grid; place-items:center; overflow:hidden; padding:10px }
    .qr-img img{ max-width:100%; max-height:100%; display:block }
    .qr-msg{ font-size:13px; color:var(--muted) }
  </style>
</head>

<body>
  <fv-shell>
    <div class="wrap">
      <section class="hero">
        <header class="hero-head">
          <div aria-hidden="true">ðŸ”—</div>
          <div>
            <h1>Equipment Hub</h1>
            <p class="muted" id="subtitle">Loadingâ€¦</p>
          </div>
        </header>

        <div class="body" id="content" hidden>
          <div class="card">
            <h2 id="eqName" style="margin:0"></h2>
            <div class="meta">
              <span id="eqType" class="chip"></span>
              <span id="eqMakeModel" class="chip"></span>
              <span id="eqYear" class="chip" hidden></span>
              <span id="eqSerial" class="chip" hidden></span>
              <span id="eqHours" class="chip" hidden></span>
            </div>
            <p id="eqNotes" class="muted" hidden></p>
          </div>

          <div class="actions">
            <a id="linkHours" class="btn btn-primary" href="#">Track Engine Hours</a>
            <a id="linkMaint" class="btn" href="#">Service Records</a>
            <a id="linkReq" class="btn" href="#">Submit Service Request</a>
            <a id="linkPre" class="btn" href="#">Pre-Season Checklist</a>
          </div>

          <!-- QR block: saved image preferred; fallback to generated -->
          <div class="qr-card">
            <div class="qr-row">
              <div class="qr-img"><img id="qrImg" alt="QR" hidden></div>
              <div style="display:flex; gap:10px; flex-wrap:wrap">
                <button id="btnReprint" class="btn">Reprint QR</button>
                <a id="btnOpenList" class="btn" href="/Farm-vista/pages/equipment/tractors-view.html">Open Tractors</a>
              </div>
            </div>
            <div id="qrMsg" class="qr-msg">Finding QRâ€¦</div>
          </div>

          <div class="tiny">
            <div>Link: <code id="deepLink">â€”</code></div>
            <div>QR token verified: <span id="tokenOK">â€”</span></div>
          </div>
        </div>

        <div class="body" id="stateBox">
          <div class="state" id="stateMsg">Checking linkâ€¦</div>
          <div style="display:flex; gap:8px; margin-top:10px">
            <button id="btnRetry" class="btn">Retry</button>
            <a href="/Farm-vista/index.html" class="btn">Home</a>
          </div>
        </div>
      </section>
    </div>
  </fv-shell>

  <!-- QR lib only needed if we must generate a fallback image -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js" onload="window.__qrReady=true;"></script>

  <script type="module">
    import {
      ready,
      getFirestore, doc, getDoc
    } from '/Farm-vista/js/firebase-init.js';

    const $ = id => document.getElementById(id);
    const qs = new URLSearchParams(location.search);
    const id = qs.get('id') || '';
    const t  = qs.get('t')  || '';

    const setText = (id, val, opts={})=>{
      const el=$(id); if(!el) return;
      if(val==null || val===''){ if(opts.hideIfEmpty) el.hidden=true; else el.textContent=''; return; }
      el.textContent = String(val);
      if(opts.unhide) el.hidden=false;
    };

    function last6(v){ v=String(v||''); return v.slice(-6); }

    function smartLaunch(absTo){
      const u = new URL(location.origin + '/Farm-vista/launch.html');
      u.searchParams.set('to', absTo);
      return u.href;
    }
    const hubLinkFor = (id, tok) =>
      `${location.origin}/Farm-vista/pages/equipment/equipment-hub.html?id=${encodeURIComponent(id)}${tok?`&t=${encodeURIComponent(tok)}`:''}`;

    async function resolveIdByToken(db, token){
      // token doc is qr-tokens/{token} => { equipmentId }
      const ref = doc(db, 'qr-tokens', token);
      const snap = await getDoc(ref);
      if(!snap.exists()) return null;
      return snap.data()?.equipmentId || null;
    }

    function printLabelWithImage(imageURL, caption){
      const w = window.open('', '_blank', 'width=620,height=720');
      w.document.write(`
        <!doctype html><html><head><meta charset="utf-8"><title>Print QR</title>
        <style>
          @page { size: 2in 2.25in; margin: 3mm; } /* 2" label, slightly taller for text */
          html,body{height:100%}
          body{margin:0; display:flex; align-items:center; justify-content:center; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
          .wrap{text-align:center}
          img{display:block; width:100%; max-width:380px; height:auto; margin:0 auto 4px}
          h1{font-size:12px; margin:0; line-height:1.05; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-weight:700}
          @media screen{ body{padding:16px} .wrap{max-width:420px} }
        </style></head><body>
          <div class="wrap">
            <img src="${imageURL}" alt="QR">
            <h1>${caption.replace(/</g,'&lt;')}</h1>
          </div>
          <script>setTimeout(function(){ window.print(); }, 200);<\/script>
        </body></html>
      `);
      w.document.close();
    }

    function printLabelGenerated(text, caption){
      const w = window.open('', '_blank', 'width=620,height=720');
      w.document.write(`
        <!doctype html><html><head><meta charset="utf-8"><title>Print QR</title>
        <style>
          @page { size: 2in 2.25in; margin: 3mm; }
          html,body{height:100%}
          body{margin:0; display:flex; align-items:center; justify-content:center; font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
          .wrap{text-align:center}
          #qr{width:100%; max-width:380px; margin:0 auto 4px}
          h1{font-size:12px; margin:0; line-height:1.05; font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-weight:700}
          @media screen{ body{padding:16px} .wrap{max-width:420px} }
        </style></head><body>
          <div class="wrap">
            <div id="qr"></div>
            <h1>${caption.replace(/</g,'&lt;')}</h1>
          </div>
          <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"><\/script>
          <script>
            (function(){
              function go(){
                new QRCode(document.getElementById('qr'), { text: ${JSON.stringify(text)}, width: 380, height: 380, correctLevel: QRCode.CorrectLevel.H, colorDark:'#000000', colorLight:'#ffffff' });
                setTimeout(function(){ window.print(); }, 250);
              }
              if(window.QRCode) go(); else window.addEventListener('load', go);
            })();
          <\/script>
        </body></html>
      `);
      w.document.close();
    }

    async function check(){
      $("subtitle").textContent = "Resolving equipmentâ€¦";
      await ready;
      const db  = getFirestore();

      let eqId = id;
      if(!eqId && t){
        // Support token-only scans
        eqId = await resolveIdByToken(db, t);
      }

      if(!eqId){
        $("stateMsg").innerHTML = "<strong>Not linked yet.</strong> This QR was created before the equipment was saved.";
        $("stateBox").classList.add("warn");
        $("content").hidden = true;
        $("subtitle").textContent = "Not linked yet";
        return;
      }

      try{
        const ref = doc(db,'equipment', eqId);
        const snap = await getDoc(ref);

        if(!snap.exists()){
          $("stateMsg").innerHTML = "<strong>Not found.</strong> Equipment record doesnâ€™t exist.";
          $("content").hidden = true;
          $("subtitle").textContent = "Not found";
          return;
        }

        const data = snap.data() || {};
        const ok = !!t ? (data.qr && data.qr.token === t) : true;

        if(!ok){
          $("stateMsg").innerHTML = "<strong>Invalid link.</strong> Token mismatch.";
          $("stateBox").classList.remove("warn");
          $("content").hidden = true;
          $("subtitle").textContent = "Token mismatch";
          return;
        }

        // Render identity / meta
        $("deepLink").textContent = location.href;
        $("tokenOK").textContent = ok ? "yes" : "no";

        const type = data.type || "equipment";
        const makeModel = [data.makeName, data.modelName].filter(Boolean).join(" ");
        const name = data.name || makeModel || `Unit ${eqId.slice(0,6)}`;

        setText("eqName", name);
        setText("eqType", type);
        setText("eqMakeModel", makeModel);
        if(data.year)  setText("eqYear",  `Year ${data.year}`, {unhide:true});
        if(data.serial) setText("eqSerial", `SN ${data.serial}`, {unhide:true});
        if(data.engineHours!=null) setText("eqHours", `${data.engineHours} hrs`, {unhide:true});
        if(data.notes) { setText("eqNotes", data.notes, {unhide:true}); }

        // Quick links (keep context)
        const base = "/Farm-vista/pages/equipment/actions";
        const tok  = data.qr?.token || '';
        $("linkHours").href = `${base}/engine-hours.html?id=${encodeURIComponent(eqId)}&t=${encodeURIComponent(tok)}&from=qr`;
        $("linkMaint").href = `${base}/maintenance.html?id=${encodeURIComponent(eqId)}&t=${encodeURIComponent(tok)}&from=qr`;
        $("linkReq").href   = `${base}/service-request.html?id=${encodeURIComponent(eqId)}&t=${encodeURIComponent(tok)}&from=qr`;
        $("linkPre").href   = `${base}/pre-check.html?id=${encodeURIComponent(eqId)}&t=${encodeURIComponent(tok)}&from=qr`;

        $("stateBox").classList.remove("warn");
        $("stateMsg").textContent = "Linked.";
        $("content").hidden = false;
        $("subtitle").textContent = "Linked";

        // ===== QR image handling =====
        const img = $("qrImg");
        const msg = $("qrMsg");
        const saved = data.qr?.image?.url || null;
        const smart = smartLaunch(hubLinkFor(eqId, tok));
        const caption = `${data.modelName || 'Unit'} - #${last6(data.serial)}`;

        if(saved){
          img.src = saved; img.hidden = false; msg.textContent = "";
          $("btnReprint").onclick = ()=> printLabelWithImage(saved, caption);
        }else if(tok){
          msg.textContent = "Generating QRâ€¦";
          // Generate QR on the fly (fallback view)
          const holder = document.createElement('div');
          new window.QRCode(holder, {
            text: smart,
            width: 220, height: 220,
            correctLevel: window.QRCode.CorrectLevel.H,
            colorDark:"#000000", colorLight:"#ffffff"
          });
          const node = holder.querySelector('canvas') || holder.querySelector('img');
          if(node){
            img.src = node.tagName === 'CANVAS' ? node.toDataURL('image/png') : node.src;
            img.hidden = false; msg.textContent = "";
            $("btnReprint").onclick = ()=> printLabelGenerated(smart, caption);
          }else{
            msg.textContent = "QR render failed.";
          }
        }else{
          msg.textContent = "No QR bound to this unit yet.";
        }

      }catch(err){
        $("stateMsg").innerHTML = "Error loading record.";
        console.error(err);
      }
    }

    $("btnRetry").addEventListener("click", check);
    check();
  </script>
</body>
</html>
