<!-- =====================================================================
/Farm-vista/pages/equipment/actions/hub.html â€” INFO-ONLY HUB (FULL FILE)
Purpose:
- Show Equipment Hub with equipment context when provided.
- Accept context via URL (?id,&t) OR sessionStorage('fv.ctx.eqId','fv.ctx.eqTok').
- Show a neutral Hub (return buttons) if no context AND not a scan failure.
- Show "Invalid QR" modal ONLY after a failed scan (flag via ?qrError=1 or
  sessionStorage 'fv.qrError' === '1'); modal has a single Close button.

Notes:
- Title uses Make + Model + (#last6 of serial). Year intentionally removed.
- Action links preserve id (& token, if present) for downstream pages.
- After successful load, clears ss context so it doesnâ€™t â€œstickâ€.
- Absolutely pathed assets (per FarmVista conventions).
===================================================================== -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista â€¢ Equipment Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- ===== Manifest + Icons (ABSOLUTE PATHS) ===== -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>

  <!-- ===== Theme + App CSS (kept explicit) ===== -->
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <!-- ===== Ensure fv-shell is available on this page ===== -->
  <script>
    (function(){
      try{
        if(!customElements.get('fv-shell')){
          const s = document.createElement('script');
          s.src = '/Farm-vista/js/fv-shell.js';
          s.defer = true;
          document.head.appendChild(s);
        }
      }catch(e){ console.error('fv-shell loader failed', e); }
    })();
  </script>

  <!-- ===== Page-local styles (full, not minimized) ===== -->
  <style>
    :root{
      --card-max: 900px;
      --brand: var(--green, #3B7E46);
    }
    html, body { height: 100%; }
    body{
      background: var(--app-bg, var(--surface));
      color: var(--text);
    }

    .wrap{
      max-width: var(--card-max);
      margin: 0 auto;
      padding: clamp(14px, 3vw, 22px);
      /* Leave space for camera safe zone/footer on mobile (matches shell vars) */
      padding-bottom: calc(env(safe-area-inset-bottom, 0px) + var(--ftr-h, 42px) + 64px) !important;
    }

    .hero{
      border: 1px solid var(--border);
      border-radius: 14px;
      background: var(--surface);
      box-shadow: var(--shadow, 0 8px 20px rgba(0,0,0,.08));
      overflow: hidden;
      margin: 8px 0 18px;
    }
    .hero-head{
      display: grid;
      grid-template-columns: 36px 1fr;
      gap: 12px;
      align-items: center;
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      background: color-mix(in srgb, var(--brand) 12%, transparent);
    }
    .hero-head h1{
      margin: 0;
      font-size: clamp(20px, 3.2vw, 26px);
      line-height: 1.2;
    }
    .muted{ color: var(--muted, #67706B); }

    .body{ padding: 16px; display: grid; gap: 18px; }

    .card{
      border: 1px solid var(--border);
      border-radius: 12px;
      background: var(--surface);
      padding: 14px;
      display: grid;
      gap: 6px;
    }
    .meta{
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    .chip{
      font-size: 12px;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 4px 8px;
      background: var(--surface);
    }

    .actions{
      display: grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 10px;
    }
    @media (max-width: 560px){
      .actions{ grid-template-columns: 1fr; }
    }
    .btn{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      height: 48px;
      padding: 0 14px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--card-surface, var(--surface));
      font-weight: 800;
      color: var(--text) !important;
      text-decoration: none;
      cursor: pointer;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    .btn-primary{
      border-color: transparent;
      background: var(--brand);
      color: #fff !important;
    }

    /* ===== Modal (Bad QR) â€” Single Close button, gated usage ===== */
    .modal-backdrop{
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 99999;
      background: rgba(0,0,0,.45);
      -webkit-backdrop-filter: blur(1px);
      backdrop-filter: blur(1px);
    }
    .modal-backdrop.show{ display: flex; }
    .modal-card{
      width: min(480px, 92vw);
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 18px 60px rgba(0,0,0,.35);
      overflow: hidden;
    }
    .md-head{
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      font-weight: 800;
      font-size: 18px;
    }
    .md-body{
      padding: 14px 16px;
      color: var(--muted, #67706B);
    }
    .md-foot{
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    /* Basic focus ring for a11y */
    .btn:focus-visible, button:focus-visible{
      outline: 2px solid var(--brand);
      outline-offset: 2px;
    }
  </style>
</head>

<body>
  <!-- ===== Shell wrapper for header/drawer/footer ===== -->
  <fv-shell app-title="FarmVista">
    <div class="wrap">
      <section class="hero" aria-labelledby="hubTitle">
        <header class="hero-head">
          <div aria-hidden="true">ðŸ”—</div>
          <div>
            <h1 id="hubTitle">Equipment Hub</h1>
            <p class="muted" id="subtitle">Loadingâ€¦</p>
          </div>
        </header>

        <!-- ===== Equipment block (only when equipment is resolved) ===== -->
        <div class="body" id="eqBlock" hidden>
          <div class="card" aria-labelledby="eqName">
            <h2 id="eqName" style="margin:0"></h2>
            <div class="meta" aria-label="Equipment attributes">
              <span id="eqType" class="chip" aria-live="polite"></span>
              <span id="eqMakeModel" class="chip"></span>
              <!-- Year intentionally removed -->
              <span id="eqSerial" class="chip" hidden></span>
              <span id="eqHours" class="chip" hidden></span>
            </div>
            <p id="eqNotes" class="muted" hidden></p>
          </div>

          <div class="actions" aria-label="Equipment actions">
            <a id="linkHours" class="btn btn-primary" href="#">Track Engine Hours</a>
            <a id="linkMaint" class="btn" href="#">Service Records</a>
            <a id="linkReq"   class="btn" href="#">Submit Service Request</a>
            <a id="linkPre"   class="btn" href="#">Pre-Season Checklist</a>
          </div>
        </div>

        <!-- ===== Neutral block (when opened without equipment context) ===== -->
        <div class="body" id="neutralBlock" hidden>
          <div class="actions">
            <a class="btn" href="/Farm-vista/index.html">Return to Home</a>
            <a class="btn" href="/Farm-vista/pages/equipment/tractors-view.html">Return to Tractors</a>
          </div>
        </div>
      </section>
    </div>
  </fv-shell>

  <!-- ===== Invalid QR modal (gated; Close only) ===== -->
  <div id="badQR" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-card" role="document" aria-labelledby="badQRTitle" aria-describedby="badQRDesc">
      <div class="md-head" id="badQRTitle">Invalid QR for FarmVista</div>
      <div class="md-body" id="badQRDesc">
        We couldnâ€™t open this code. It isnâ€™t linked to a piece of equipment. Please try scanning again.
      </div>
      <div class="md-foot">
        <button id="badQRClose" class="btn btn-primary" type="button">Close</button>
      </div>
    </div>
  </div>

  <!-- ===== Script (FULL, explicit, no trimming) ===== -->
  <script type="module">
    import { ready, getFirestore, doc, getDoc } from '/Farm-vista/js/firebase-init.js';

    // ---------- Helpers ----------
    const $ = id => document.getElementById(id);
    const qs = new URLSearchParams(location.search);

    const setText = (id, val, opts={})=>{
      const el = $(id); if(!el) return;
      if(val == null || val === ''){
        if(opts.hideIfEmpty) el.hidden = true;
        else el.textContent = '';
        return;
      }
      el.textContent = String(val);
      if(opts.unhide) el.hidden = false;
    };

    const last6 = v => String(v || '').slice(-6);

    async function resolveIdByToken(db, t){
      // Lookup table: /qr-tokens/{token} -> { equipmentId }
      try{
        const ref = doc(db, 'qr-tokens', t);
        const snap = await getDoc(ref);
        return snap.exists() ? (snap.data()?.equipmentId || null) : null;
      }catch(err){
        console.error('resolveIdByToken error', err);
        return null;
      }
    }

    function showInvalidModal(){
      const m = $('badQR');
      if (!m) return;
      m.classList.add('show');
      m.setAttribute('aria-hidden', 'false');

      const closeBtn = $('badQRClose');
      if (closeBtn){
        closeBtn.onclick = hideInvalidModal;
      }
      // backdrop click to close
      m.addEventListener('click', (e)=>{ if(e.target === m) hideInvalidModal(); }, { once: true });
      // ESC to close
      window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') hideInvalidModal(); }, { once: true });
    }
    function hideInvalidModal(){
      const m = $('badQR');
      if (!m) return;
      m.classList.remove('show');
      m.setAttribute('aria-hidden', 'true');
      // Clear one-shot flags so it doesn't pop again later
      try{
        sessionStorage.removeItem('fv.qrError');
      }catch{}
      if (qs.get('qrError') === '1') {
        const clean = new URL(location.href);
        clean.searchParams.delete('qrError');
        history.replaceState({}, '', clean.pathname + clean.search + clean.hash);
      }
    }

    function showNeutral(){
      $('neutralBlock').hidden = false;
      $('eqBlock').hidden = true;
      setText('subtitle', 'Ready');
    }

    // ---------- Inputs ----------
    // Primary: URL params
    let eqIdFromUrl = qs.get('id') || '';
    let tokFromUrl  = qs.get('t')  || '';

    // Safety-net: sessionStorage (set by tractors-view "Open Hub" button)
    // Example for tractors-view:
    // sessionStorage.setItem('fv.ctx.eqId', equipmentId);
    // sessionStorage.setItem('fv.ctx.eqTok', qrToken || '');
    // location.href = '/Farm-vista/pages/equipment/actions/hub.html';
    let eqId = eqIdFromUrl || (sessionStorage.getItem('fv.ctx.eqId') || '');
    let token = tokFromUrl || (sessionStorage.getItem('fv.ctx.eqTok') || '');

    // Gate: only show modal after a failed scan (not on neutral opens)
    const fromScanFail =
      qs.get('qrError') === '1' ||
      (sessionStorage.getItem('fv.qrError') === '1');

    // ---------- Main ----------
    async function load(){
      setText('subtitle', 'Resolving equipmentâ€¦');
      await ready;
      const db = getFirestore();

      // If we have only a token, resolve to equipment id
      if (!eqId && token){
        eqId = await resolveIdByToken(db, token);
      }

      if (!eqId){
        // No context => Neutral Hub; modal only if came from a failed scan
        if (fromScanFail) showInvalidModal();
        showNeutral();
        return;
      }

      // Fetch equipment doc
      const ref = doc(db, 'equipment', eqId);
      const snap = await getDoc(ref);
      if (!snap.exists()){
        if (fromScanFail) showInvalidModal();
        showNeutral();
        return;
      }

      const data = snap.data() || {};
      // If URL carried token, verify it matches equipment doc (defensive)
      const tokenOK = token ? (data.qr && data.qr.token === token) : true;
      if (!tokenOK){
        if (fromScanFail) showInvalidModal();
        showNeutral();
        return;
      }

      // ----- Render equipment block -----
      const type = data.type || 'equipment';
      const makeModel = [data.makeName, data.modelName].filter(Boolean).join(' ');
      const sn6 = last6(data.serial);

      const title = makeModel
        ? `${makeModel}${sn6 ? ` (#${sn6})` : ''}`
        : (data.name || `Unit ${String(eqId).slice(0,6)}`);

      setText('eqName', title);
      setText('eqType', type);
      setText('eqMakeModel', makeModel);
      if (sn6) setText('eqSerial', `SN #${sn6}`, { unhide: true });
      if (data.engineHours != null) setText('eqHours', `${data.engineHours} hrs`, { unhide: true });
      if (data.notes) setText('eqNotes', data.notes, { unhide: true });

      // Action links â€” preserve id (& token if available) so downstream pages are contextual
      const base = '/Farm-vista/pages/equipment/actions';
      const tok  = data.qr?.token || token || '';
      const q    = `?id=${encodeURIComponent(eqId)}${tok ? `&t=${encodeURIComponent(tok)}` : ''}&from=hub`;

      $('linkHours').href = `${base}/engine-hours.html${q}`;
      $('linkMaint').href = `${base}/maintenance.html${q}`;
      $('linkReq').href   = `${base}/service-request.html${q}`;
      $('linkPre').href   = `${base}/pre-check.html${q}`;

      $('eqBlock').hidden = false;
      $('neutralBlock').hidden = true;
      setText('subtitle', 'Linked');

      // One-shot context cleanup so a later menu-open doesnâ€™t stick to last unit
      try{
        sessionStorage.removeItem('fv.ctx.eqId');
        sessionStorage.removeItem('fv.ctx.eqTok');
      }catch{}
    }

    load().catch(err=>{
      console.error('Hub load error', err);
      if (fromScanFail) showInvalidModal();
      showNeutral();
    });
  </script>

  <!-- Optional: noscript fallback -->
  <noscript>
    <div style="max-width:900px;margin:1rem auto;padding:1rem;border:1px solid #ccc;border-radius:12px;background:#fff;color:#000">
      JavaScript is required for the Equipment Hub.
    </div>
  </noscript>
</body>
</html>