<!-- /Farm-vista/pages/equipment/actions/hub.html ‚Äî Mobile-safe + Rescan-stable
     ‚Ä¢ Fullscreen loader until outcome
     ‚Ä¢ Archived state blocks new entries
     ‚Ä¢ 12s timeout ‚Üí Timed Out card
     ‚Ä¢ Robust Rescan (clears state, avoids iOS PWA lockups)
-->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista ‚Ä¢ Equipment Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>

  <!-- Theme + app CSS -->
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <!-- Ensure fv-shell -->
  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true; document.head.appendChild(s);
      }
    })();
  </script>

  <style>
    :root{ --card-max:900px; --brand:var(--green,#3B7E46); }
    body{ background:var(--app-bg,var(--surface)); margin:0; }

    .wrap{ max-width:var(--card-max); margin:0 auto; padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px)+72px)!important; }

    .hero{ border:1px solid var(--border); border-radius:14px; background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08)); overflow:hidden; margin:8px 0 18px; }

    .hero-head{ padding:14px 16px; border-bottom:1px solid var(--border);
      background:color-mix(in srgb,var(--brand) 12%, transparent); }
    .hero-head h1{ margin:0; font-size:clamp(20px,3.2vw,26px); }
    .muted{ color:var(--muted,#67706B) }

    .body{ padding:16px; display:grid; gap:18px }
    .card{ border:1px solid var(--border); border-radius:12px; background:var(--surface);
      padding:14px; display:grid; gap:8px }
    .meta{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .chip{ font-size:12px; border:1px solid var(--border); border-radius:999px; padding:6px 10px; background:var(--surface) }

    .actions{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
    @media (max-width:640px){ .actions{ grid-template-columns:1fr } }

    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding:14px 16px; border-radius:14px; border:1px solid var(--border);
      background:var(--card-surface,var(--surface)); font-weight:800; color:var(--text)!important;
      text-decoration:none; min-height:52px;
      -webkit-tap-highlight-color: transparent;
    }
    .btn-primary{ border-color:transparent; background:var(--brand); color:#fff!important }

    /* Fullscreen loader (mobile-friendly) */
    .fs-load{
      position:fixed; inset:0; z-index:60;
      display:flex; align-items:center; justify-content:center;
      background:var(--page-bg,#F6F7F6);
      padding:calc(env(safe-area-inset-top,0px)+24px) 16px calc(env(safe-area-inset-bottom,0px)+24px);
    }
    .fs-card{
      width:min(92vw,520px); background:var(--surface,#fff); border-radius:18px; padding:22px 18px;
      box-shadow:0 14px 36px rgba(0,0,0,.12); text-align:center; border:1px solid var(--border);
    }
    .spin{ width:64px; height:64px; border-radius:50%;
      border:6px solid rgba(0,0,0,.08); border-top-color:var(--brand); margin:12px auto;
      animation:spin 1s linear infinite; }
    @keyframes spin{ to{ transform:rotate(360deg) } }
    .fs-card h3{ margin:0 0 4px; font-size:22px; font-weight:900; color:var(--ink-1,#0f1a13);}
    .fs-card p{ margin:0; color:var(--muted,#67706B); }

    /* State cards */
    .state{ border:1px solid var(--border); border-radius:12px; background:var(--surface);
      padding:22px; display:grid; gap:12px; justify-items:center; text-align:center; }
    .state .emo{ font-size:44px; line-height:1; filter:grayscale(.05); }
    .state h2{ margin:0; font-size:20px; font-weight:900; }
    .state p{ margin:0; color:var(--muted,#67706B); max-width:520px; }

    [hidden]{ display:none !important; }
  </style>
</head>

<body>
  <fv-shell>
    <div class="wrap" id="content" hidden>
      <section class="hero">
        <header class="hero-head">
          <h1 id="pageTitle">Equipment Hub</h1>
          <p class="muted" id="status" hidden></p>
        </header>

        <div class="body">
          <!-- Summary -->
          <div class="card" id="eqCard" hidden>
            <h2 id="eqName" style="margin:0"></h2>
            <div class="meta">
              <span id="eqType" class="chip"></span>
              <span id="eqMakeModel" class="chip"></span>
              <span id="eqSerial" class="chip" hidden></span>
              <span id="eqHours" class="chip" hidden></span>
            </div>
            <p id="eqNotes" class="muted" hidden></p>
          </div>

          <!-- ACTIVE actions -->
          <div class="actions" id="fnLinks" hidden>
            <a id="linkHours" class="btn btn-primary" href="#">Track Engine Hours</a>
            <a id="linkMaint" class="btn" href="#">Service Records</a>
            <a id="linkReq"   class="btn" href="#">Submit Service Request</a>
            <a id="linkPre"   class="btn" href="#">Pre-Season Checklist</a>
          </div>

          <!-- ARCHIVED -->
          <div id="archivedCard" class="state" hidden>
            <div class="emo">üì¶</div>
            <h2>This equipment is archived</h2>
            <p id="archivedMsg">This item isn‚Äôt available for new entries at this time.</p>
            <div class="actions">
              <button id="rescanBtnA" class="btn btn-primary" type="button">Rescan</button>
              <a class="btn" href="/Farm-vista/index.html">Return to Home</a>
            </div>
          </div>

          <!-- TIMEOUT -->
          <div id="timeoutCard" class="state" hidden>
            <div class="emo">‚è±Ô∏è</div>
            <h2>Timed out</h2>
            <p>It‚Äôs taking longer than expected to load this equipment.</p>
            <div class="actions">
              <button id="rescanBtnT" class="btn btn-primary" type="button">Rescan</button>
              <a class="btn" href="/Farm-vista/index.html">Return to Home</a>
            </div>
          </div>

          <!-- Always-present returns -->
          <div class="actions">
            <a class="btn" href="/Farm-vista/pages/equipment/tractors-view.html">Return to Tractors</a>
            <a class="btn" href="/Farm-vista/index.html">Return to Home</a>
          </div>
        </div>
      </section>
    </div>
  </fv-shell>

  <!-- Fullscreen loader (only disappears after outcome) -->
  <div class="fs-load" id="fsLoad">
    <div class="fs-card">
      <h3>Connecting‚Ä¶</h3>
      <div class="spin" aria-hidden="true"></div>
      <p>Loading data for your farm</p>
    </div>
  </div>

  <script type="module">
    import {
      ready, getFirestore, doc, getDoc,
      collection, query, where, getDocs, limit
    } from '/Farm-vista/js/firebase-init.js';

    // --------- helpers ----------
    const $  = id => document.getElementById(id);
    const qs = new URLSearchParams(location.search);

    let eqId  = qs.get('id') || '';
    let token = qs.get('t')  || '';

    // pick up context saved by tractors-view ‚ÄúOpen Hub‚Äù
    if (!eqId)  { const s = sessionStorage.getItem('fv.ctx.eqId');  if (s) eqId = s; }
    if (!token) { const t = sessionStorage.getItem('fv.ctx.eqTok'); if (t) token = t; }

    const last6 = v => String(v||'').slice(-6);
    const capWords = s => String(s||'').replace(/\b\w/g, c=>c.toUpperCase());
    const setText = (id, val, opts={})=>{
      const el=$(id); if(!el) return;
      if(val==null || val===''){ if(opts.hideIfEmpty) el.hidden=true; else el.textContent=''; return; }
      el.textContent = String(val);
      if(opts.unhide) el.hidden=false;
    };

    // fullscreen loader
    function showContent(){ $('fsLoad').hidden = true; $('content').hidden = false; }

    // robust rescan (clears state + avoids iOS bfcache weirdness)
    function cameFromScanner(){
      const r = document.referrer || '';
      return /qr|scan/i.test(r);
    }
    function purgeScanContext(){
      sessionStorage.removeItem('fv.ctx.eqId');
      sessionStorage.removeItem('fv.ctx.eqTok');
    }
    function rescan(){
      purgeScanContext();
      // try to go back to scanner if we came from it
      if (cameFromScanner() && history.length > 1){
        history.back();
        // safety: if iOS keeps the page frozen in bfcache, force a forward nav
        setTimeout(()=>location.href='/Farm-vista/pages/equipment/actions/qr-scanner.html', 500);
      }else{
        // direct open fallback
        location.href = '/Farm-vista/pages/equipment/actions/qr-scanner.html';
      }
    }
    $('rescanBtnA')?.addEventListener('click', rescan);
    $('rescanBtnT')?.addEventListener('click', rescan);

    // prevent stuck states when app is backgrounded/returned
    window.addEventListener('pagehide', () => { clearTimeout(timeoutHandle); });
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'hidden') { clearTimeout(timeoutHandle); }
    });

    // 12s timeout watchdog (doesn‚Äôt block late success; we flip views)
    const TIMEOUT_MS = 12000;
    let finished = false;
    const timeoutHandle = setTimeout(()=>{
      if (finished) return;
      showContent();
      $('eqCard').hidden = true;
      $('fnLinks').hidden = true;
      $('archivedCard').hidden = true;
      $('timeoutCard').hidden = false;
      const s = $('status'); s.textContent = 'Timed out waiting for data.'; s.hidden = false;
    }, TIMEOUT_MS);

    async function resolveIdByToken(db, t){
      if (!t) return '';
      try{
        const qy = query(collection(db,'equipment'), where('qr.token','==', t), limit(1));
        const snap = await getDocs(qy);
        if (!snap.empty) return snap.docs[0].id || '';
      }catch(e){ console.error('Token reverse-lookup failed:', e); }
      return '';
    }

    async function init(){
      await ready;
      const db = getFirestore();

      // reverse-lookup if we only have token
      if (!eqId && token){ eqId = await resolveIdByToken(db, token); }

      if (!eqId){
        clearTimeout(timeoutHandle);
        finished = true;
        showContent();
        $('status').textContent = 'No equipment found for this code.'; $('status').hidden = false;
        return;
      }

      let snap;
      try{
        snap = await getDoc(doc(db,'equipment', eqId));
      }catch(err){
        console.error(err);
        clearTimeout(timeoutHandle);
        finished = true;
        showContent();
        $('status').textContent = 'Error loading hub.'; $('status').hidden = false;
        return;
      }

      clearTimeout(timeoutHandle);
      finished = true;
      showContent();

      if (!snap.exists()){
        $('status').textContent = 'Not found.'; $('status').hidden = false;
        return;
      }

      const d = snap.data() || {}; d.id = eqId;

      // Dynamic header: {Type} Hub
      const typeRaw = d.type || 'equipment';
      const hubTitle = `${capWords(typeRaw)} Hub`;
      setText('pageTitle', hubTitle);
      document.title = `FarmVista ‚Ä¢ ${hubTitle}`;

      // summary
      const mm = [d.makeName, d.modelName].filter(Boolean).join(' ');
      const ls = last6(d.serial);
      const title = mm ? `${mm}${ls ? ` (#${ls})` : ''}` : (d.name || `Unit ${String(eqId).slice(0,6)}`);
      setText('eqName', title);
      setText('eqType', typeRaw || 'equipment');
      setText('eqMakeModel', mm);
      if (ls) setText('eqSerial', `SN #${ls}`, {unhide:true});
      if (d.engineHours != null) setText('eqHours', `${d.engineHours} hrs`, {unhide:true});
      if (d.notes) setText('eqNotes', d.notes, {unhide:true});
      $('eqCard').hidden = false;

      // archived vs active
      const isArchived = (String(d.status||'').toLowerCase()==='archived') || (d.archived===true);
      if (isArchived){
        const name = mm || 'This unit';
        $('archivedMsg').textContent = `‚Äú${name}${ls ? ' ‚Ä¢ SN ‚Ä¶'+ls : ''}‚Äù is archived and not available for new entries.`;
        $('archivedCard').hidden = false;  // no fnLinks
      }else{
        const base = "/Farm-vista/pages/equipment/actions";
        const tok  = d.qr?.token || token || '';
        const qstr = `?id=${encodeURIComponent(eqId)}${tok ? `&t=${encodeURIComponent(tok)}`:''}&from=hub`;
        $("linkHours").href = `${base}/engine-hours.html${qstr}`;
        $("linkMaint").href = `${base}/maintenance.html${qstr}`;
        $("linkReq").href   = `${base}/service-request.html${qstr}`;
        $("linkPre").href   = `${base}/pre-check.html${qstr}`;
        $('fnLinks').hidden = false;
      }

      // clear one-shot context so scanner‚Üíhub‚Üírescan works cleanly
      purgeScanContext();
    }

    init().catch(err=>{
      console.error(err);
      clearTimeout(timeoutHandle);
      finished = true;
      showContent();
      $('status').textContent = 'Error loading hub.'; $('status').hidden = false;
    });
  </script>
</body>
</html>
