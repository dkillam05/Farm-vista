<!-- =====================================================================
/Farm-vista/pages/equipment/equipment-hub.html  (FULL FILE REPLACEMENT)
Rev: 2025-12-18c
Fixes:
 ‚Ä¢ Service Records opens modal and loads ONLY this equipment's records (newest first)
 ‚Ä¢ No auto-print. Print only when user clicks buttons at bottom of modal.
 ‚Ä¢ Fixes "</script>" inside template literal breaking the module script.
===================================================================== -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista ‚Ä¢ Equipment Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>

  <!-- Connection warmups -->
  <link rel="preconnect" href="https://firestore.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://www.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>

  <!-- Theme + app CSS -->
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <!-- IMPORTANT: match tractors ‚Äî load Firebase CONFIG first -->
  <script src="/Farm-vista/js/firebase-config.js"></script>

  <!-- Ensure fv-shell -->
  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true; document.head.appendChild(s);
      }
    })();
  </script>

  <style>
    :root{ --card-max:900px; --brand:var(--green,#3B7E46); }
    body{ background:var(--app-bg,var(--surface)); margin:0; }

    /* kill blue links in dark mode */
    .wrap, .wrap * { -webkit-tap-highlight-color: transparent; }
    .wrap a, .wrap a:visited, .wrap a:active, .wrap a:hover { color:inherit; text-decoration:none; }
    .btn { color:var(--ink-1,#0f1a13); }
    :root[data-theme="dark"] .btn { color:var(--ink-1,#eaece9); }
    .btn-primary { color:#fff; }

    .wrap{
      max-width:var(--card-max);
      margin:0 auto;
      padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px)+72px)!important;
    }
    .hero{
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));
      overflow:hidden;
      margin:8px 0 18px;
    }
    .hero-head{
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      background:color-mix(in srgb,var(--brand) 12%, transparent);
    }
    .hero-head h1{ margin:0; font-size:clamp(20px,3.2vw,26px); }
    .muted{ color:var(--muted,#67706B) }
    .body{ padding:16px; display:grid; gap:18px }
    .card{
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--surface);
      padding:14px;
      display:grid;
      gap:8px
    }
    .meta{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .chip{
      font-size:12px;
      border:1px solid var(--border);
      border-radius:999px;
      padding:6px 10px;
      background:var(--surface)
    }
    .actions{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px
    }
    @media (max-width:640px){
      .actions{ grid-template-columns:1fr }
    }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-height:52px;
      font-weight:800;
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--card-surface,var(--surface));
      text-decoration:none
    }
    .btn-primary{
      background:var(--brand);
      border-color:transparent
    }

    .actions-return{ margin-top:26px; }

    .state{
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--surface);
      padding:22px;
      display:grid;
      gap:12px;
      justify-items:center;
      text-align:center;
    }
    .state .emo{ font-size:44px; line-height:1; filter:grayscale(.05); }
    .state h2{ margin:0; font-size:20px; font-weight:900; }
    .state p{ margin:0; color:var(--muted,#67706B); max-width:520px; }
    [hidden]{ display:none !important; }

    /* ===== Modal shared ===== */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + 14px);
      z-index:9999;
    }
    .modal-backdrop[data-open="1"]{ display:flex; }

    .modal{
      width:min(680px, 100%);
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:0 22px 60px rgba(0,0,0,.22);
      overflow:hidden;
    }
    .modal-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:14px 14px;
      border-bottom:1px solid var(--border);
      background:color-mix(in srgb,var(--brand) 10%, transparent);
    }
    .modal-head h3{
      margin:0;
      font-size:16px;
      font-weight:950;
      letter-spacing:.2px;
    }
    .icon-btn{
      appearance:none;
      border:1px solid var(--border);
      background:var(--surface);
      border-radius:12px;
      height:40px;
      width:40px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
    }
    .icon-btn svg{ width:18px; height:18px; }

    .modal-body{
      padding:14px;
      display:grid;
      gap:12px;
    }
    .modal-actions{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      padding:14px;
      border-top:1px solid var(--border);
      background:color-mix(in srgb, var(--surface) 70%, transparent);
    }
    @media (max-width:560px){ .modal-actions{ grid-template-columns:1fr; } }

    .banner{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      background:color-mix(in srgb, #b51f1f 10%, transparent);
      color:var(--ink-1,#0f1a13);
      font-size:13px;
      line-height:1.3;
      display:none;
      white-space:pre-line;
    }
    :root[data-theme="dark"] .banner{ color:var(--ink-1,#eaece9); }
    .banner[data-show="1"]{ display:block; }

    .btn-danger{
      background:color-mix(in srgb, #b51f1f 14%, var(--surface));
      border-color:color-mix(in srgb, #b51f1f 30%, var(--border));
    }
    .small-note{ font-size:12px; color:var(--muted,#67706B); line-height:1.25; }

    /* ===== Metric Modal (existing) ===== */
    .form-grid{ display:grid; gap:10px; }
    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width:560px){ .row{ grid-template-columns:1fr; } }
    .field{ display:grid; gap:6px; }
    .label{
      font-size:12px;
      font-weight:850;
      color:var(--ink-2, #2a332d);
    }
    :root[data-theme="dark"] .label{ color:var(--ink-2, #d7dbd8); }
    .help{ font-size:12px; color:var(--muted,#67706B); line-height:1.25; }
    .input{
      width:100%;
      min-height:46px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--card-surface,var(--surface));
      padding:10px 12px;
      font-size:16px;
      font-weight:800;
      color:var(--ink-1,#0f1a13);
      outline:none;
    }
    :root[data-theme="dark"] .input{ color:var(--ink-1,#eaece9); }

    .textarea{
      width:100%;
      min-height:88px;
      resize:vertical;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--card-surface,var(--surface));
      padding:10px 12px;
      font-size:14px;
      color:var(--ink-1,#0f1a13);
      outline:none;
    }
    :root[data-theme="dark"] .textarea{ color:var(--ink-1,#eaece9); }

    .input-error{
      border-color:#b51f1f !important;
      box-shadow:0 0 0 2px rgba(181,31,31,.18);
    }
    .hint{ font-size:12px; line-height:1.25; color:var(--muted,#67706B); margin-top:2px; }
    .hint.error{ color:#b51f1f; font-weight:850; }

    /* ===== Service Records Modal ===== */
    #srModalBody{
      max-height: min(62vh, 560px);
      overflow:auto;
      -webkit-overflow-scrolling:touch;
    }
    .sr-list{ display:grid; gap:10px; }
    .sr-item{
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--surface);
      padding:12px;
      display:grid;
      gap:8px;
    }
    .sr-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .sr-title{
      font-weight:950;
      font-size:14px;
      line-height:1.15;
      margin:0;
    }
    .sr-sub{
      font-size:12px;
      color:var(--muted,#67706B);
      margin:0;
      line-height:1.25;
    }
    .sr-tags{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .sr-tag{
      font-size:12px;
      border:1px solid var(--border);
      border-radius:999px;
      padding:5px 10px;
      background:var(--surface);
      white-space:nowrap;
    }
    .sr-notes{
      font-size:13px;
      color:var(--ink-1,#0f1a13);
      line-height:1.35;
      white-space:pre-wrap;
      margin:0;
    }
    :root[data-theme="dark"] .sr-notes{ color:var(--ink-1,#eaece9); }
    .sr-empty{
      border:1px dashed var(--border);
      border-radius:12px;
      padding:14px;
      text-align:center;
      color:var(--muted,#67706B);
      background:color-mix(in srgb, var(--surface) 70%, transparent);
    }
  </style>
</head>

<body>
  <fv-shell>
    <div class="wrap" id="content" hidden>
      <section class="hero">
        <header class="hero-head">
          <h1 id="pageTitle">Equipment Hub</h1>
          <p class="muted" id="status" hidden></p>
        </header>

        <div class="body">
          <div class="card" id="eqCard" hidden>
            <h2 id="eqName" style="margin:0"></h2>
            <div class="meta">
              <span id="eqSerial" class="chip" hidden></span>
              <span id="eqMetric" class="chip" hidden></span>
            </div>
          </div>

          <div class="actions" id="fnLinks" hidden>
            <a id="linkReq"    class="btn" href="#">Submit Service Request</a>
            <a id="linkMetric" class="btn" href="#">Update Usage</a>
            <a id="linkMaint"  class="btn" href="#">Service Records</a>
            <a id="linkPre"    class="btn" href="#">Pre-Season Checklist</a>
          </div>

          <div class="card" id="combineCalcs" hidden>
            <div>
              <h3 style="margin:0 0 4px;font-size:16px;font-weight:800;">Calculators</h3>
              <p class="muted" style="margin:0 0 8px;font-size:13px;">
                Quick access to grain loss, yield checks, and yield calibration for this combine.
              </p>
            </div>
            <div class="actions">
              <a id="linkCalcLoss"        class="btn" href="#">Combine Grain Loss</a>
              <a id="linkCalcYieldCheck"  class="btn" href="#">Combine Yield Check</a>
              <a id="linkCalcYieldCal"    class="btn" href="#">Combine Yield Calibration</a>
            </div>
          </div>

          <div id="archivedCard" class="state" hidden>
            <div class="emo">üì¶</div>
            <h2>This equipment is archived</h2>
            <p id="archivedMsg">This item isn‚Äôt available for new entries at this time.</p>
            <div class="actions">
              <a class="btn btn-primary" href="/Farm-vista/pages/qr-scan.html">Rescan</a>
            </div>
          </div>

          <div id="timeoutCard" class="state" hidden>
            <div class="emo">‚è±Ô∏è</div>
            <h2>Timed out</h2>
            <p>It‚Äôs taking longer than expected to load this equipment.</p>
            <div class="actions">
              <a class="btn btn-primary" href="/Farm-vista/pages/qr-scan.html">Rescan</a>
              <a class="btn" href="/Farm-vista/index.html">Return to Home</a>
            </div>
          </div>

          <div class="actions actions-return" id="returnActions">
            <a id="btnReturnOrigin" class="btn" href="#">Return</a>
            <a id="btnReturnHome"   class="btn" href="/Farm-vista/index.html">Return to Home</a>
          </div>
        </div>
      </section>
    </div>

    <!-- ===== Metric Modal ===== -->
    <div class="modal-backdrop" id="metricModal" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="metricModalTitle">
        <div class="modal-head">
          <h3 id="metricModalTitle">Update Usage</h3>
          <button class="icon-btn" id="metricModalClose" type="button" aria-label="Close">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
              <path d="M18 6L6 18"></path><path d="M6 6l12 12"></path>
            </svg>
          </button>
        </div>

        <div class="modal-body">
          <div class="banner" id="metricBanner"></div>
          <div class="form-grid" id="metricForm"></div>

          <div id="adjustBlock" hidden>
            <div class="card" style="padding:12px; gap:10px">
              <div style="display:grid; gap:6px">
                <div style="font-weight:950;">Request permissioned adjustment</div>
                <div class="small-note">
                  If a number needs to go DOWN (or was entered wrong), you must request an adjustment.
                  This sends a request to the office/admin queue.
                </div>
              </div>
              <div class="field">
                <div class="label">Reason / note to office</div>
                <textarea class="textarea" id="adjustReason" placeholder="Explain what happened (typo, meter replaced, etc.)"></textarea>
              </div>
              <div class="actions" style="grid-template-columns:1fr 1fr; gap:10px">
                <button class="btn btn-danger" id="btnRequestAdjust" type="button">Send Adjustment Request</button>
                <button class="btn" id="btnAdjustCancel" type="button">Cancel Request</button>
              </div>
            </div>
          </div>

          <div class="help" id="metricHelp"></div>
        </div>

        <div class="modal-actions">
          <button class="btn" id="metricCancel" type="button">Cancel</button>
          <button class="btn btn-primary" id="metricSave" type="button">Save</button>
        </div>
      </div>
    </div>

    <!-- ===== Service Records Modal ===== -->
    <div class="modal-backdrop" id="srModal" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="srTitle">
        <div class="modal-head">
          <h3 id="srTitle">Service Records</h3>
          <button class="icon-btn" id="srClose" type="button" aria-label="Close">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
              <path d="M18 6L6 18"></path><path d="M6 6l12 12"></path>
            </svg>
          </button>
        </div>

        <div class="modal-body" id="srModalBody">
          <div class="banner" id="srBanner"></div>
          <div class="sr-list" id="srList"></div>
        </div>

        <div class="modal-actions">
          <button class="btn" id="srPrintSummary" type="button">Print Summary</button>
          <button class="btn btn-primary" id="srPrintDetailed" type="button">Print Detailed</button>
        </div>
      </div>
    </div>

  </fv-shell>

  <script type="module">
    import {
      ready,
      getFirestore, doc, getDoc, updateDoc,
      getAuth, onAuthStateChanged,
      collection, addDoc, serverTimestamp,
      getDocs, query, where, limit
    } from '/Farm-vista/js/firebase-init.js';

    const $ = id => document.getElementById(id);

    const qs  = new URLSearchParams(location.search);
    const id  = qs.get('id')   || '';
    const from = (qs.get('from') || '').toLowerCase();
    console.info('[hub] start; id=', id, 'from=', from);

    const HUB_CONFIG = {
      tractor: {
        display: 'Tractor',
        metricFields: [{ key:'engineHours', label:'Engine Hours', suffix:'hrs', step:'0.1' }],
        updateLabel: 'Update Engine Hours',
        hasPreSeason: true
      },
      combine: {
        display: 'Combine',
        metricFields: [
          { key:'engineHours',    label:'Engine Hours',    suffix:'hrs', step:'0.1' },
          { key:'separatorHours', label:'Separator Hours', suffix:'hrs', step:'0.1' }
        ],
        updateLabel: 'Update Hours',
        hasPreSeason: true
      },
      sprayer: {
        display: 'Sprayer',
        metricFields: [{ key:'engineHours', label:'Engine Hours', suffix:'hrs', step:'0.1' }],
        updateLabel: 'Update Engine Hours',
        hasPreSeason: true
      },
      fertilizer: {
        display: 'Fertilizer Equipment',
        metricFields: [{ key:'engineHours', label:'Engine Hours', suffix:'hrs', step:'0.1' }],
        updateLabel: 'Update Engine Hours',
        hasPreSeason: true
      },
      construction: {
        display: 'Construction',
        metricFields: [{ key:'engineHours', label:'Engine Hours', suffix:'hrs', step:'0.1' }],
        updateLabel: 'Update Engine Hours',
        hasPreSeason: false
      },
      truck: {
        display: 'Truck',
        metricFields: [
          { key:'odometerMiles', label:'Odometer (miles)', suffix:'mi', step:'1' },
          { key:'engineHours',   label:'Engine Hours',     suffix:'hrs', step:'0.1' }
        ],
        updateLabel: 'Update Mileage / Hours',
        hasPreSeason: false
      },
      trailer: { display: 'Trailer', metricFields: [], updateLabel: '', hasPreSeason: false },
      implement: { display: 'Implement', metricFields: [], updateLabel: 'Update Planter Usage', hasPreSeason: false },
      starfire: { display: 'StarFire', metricFields: [], updateLabel: 'Update Location', hasPreSeason: false },
      technology: { display: 'Technology', metricFields: [], updateLabel: '', hasPreSeason: false },
      equipment: { display: 'Equipment', metricFields: [], updateLabel: '', hasPreSeason: false }
    };

    const FROM_MAP = {
      tractors: { label: 'Return to Tractors', href: '/Farm-vista/pages/equipment/equipment-tractors.html' },
      combines: { label: 'Return to Combines', href: '/Farm-vista/pages/equipment/equipment-combines.html' },
      trucks:   { label: 'Return to Trucks', href: '/Farm-vista/pages/equipment/equipment-trucks.html' },
      trailers: { label: 'Return to Trailers', href: '/Farm-vista/pages/equipment/equipment-trailers.html' },
      implements:{ label:'Return to Implements', href:'/Farm-vista/pages/equipment/equipment-implements.html' },
      sprayers: { label: 'Return to Sprayers', href: '/Farm-vista/pages/equipment/equipment-sprayers.html' },
      construction:{ label:'Return to Construction Equipment', href:'/Farm-vista/pages/equipment/equipment-construction.html' },
      starfire: { label: 'Return to StarFire', href: '/Farm-vista/pages/equipment/equipment-starfire.html' },
      lookup:   { label: 'Return to Equipment', href: '/Farm-vista/pages/equipment/actions/lookup.html' },
      scanner:  { label: 'Return to Scanner', href: '/Farm-vista/pages/qr-scan.html' }
    };

    const last6 = v => String(v || '').slice(-6);
    const setText = (id, val, opts = {}) => {
      const el = $(id); if(!el) return;
      if(!val){
        if(opts.hideIfEmpty) el.hidden = true;
        else el.textContent = '';
        return;
      }
      el.textContent = val;
      if(opts.unhide) el.hidden = false;
    };

    function showContent(){ $('content').hidden = false; }

    function setupReturnButtons(typeKey){
      const btnOrigin = $('btnReturnOrigin');
      const btnHome   = $('btnReturnHome');
      const wrap      = $('returnActions');
      if(!btnOrigin || !btnHome || !wrap) return;

      let cfg = null;

      if(from && FROM_MAP[from]) cfg = FROM_MAP[from];
      else{
        switch(typeKey){
          case 'tractor':   cfg = FROM_MAP.tractors; break;
          case 'combine':   cfg = FROM_MAP.combines; break;
          case 'truck':     cfg = FROM_MAP.trucks; break;
          case 'trailer':   cfg = FROM_MAP.trailers; break;
          case 'implement': cfg = FROM_MAP.implements; break;
          case 'sprayer':   cfg = FROM_MAP.sprayers; break;
          case 'construction': cfg = FROM_MAP.construction; break;
          case 'starfire':  cfg = FROM_MAP.starfire; break;
          default: cfg = FROM_MAP.lookup; break;
        }
      }

      if(cfg){
        btnOrigin.textContent = cfg.label;
        btnOrigin.href        = cfg.href;
        btnOrigin.hidden      = false;
      }else{
        btnOrigin.hidden = true;
      }

      btnHome.href   = '/Farm-vista/index.html';
      btnHome.hidden = false;
      wrap.hidden    = false;
    }

    /* ======================
       Metric modal (unchanged)
       ====================== */
    const MODAL = {
      open: false,
      doc: null,
      cfg: null,
      typeKey: null,
      db: null,
      snapRef: null,
      fields: [],
      lastInputs: null,
      combineInvalid: false,
      _combineUnwire: null
    };

    function showBanner(msg){
      const b = $('metricBanner');
      if(!b) return;
      if(!msg){ b.textContent=''; b.dataset.show='0'; return; }
      b.textContent = msg;
      b.dataset.show='1';
    }

    function openModal(){
      const back = $('metricModal');
      if(!back) return;
      back.dataset.open = '1';
      back.setAttribute('aria-hidden','false');
      MODAL.open = true;
      showBanner('');
      $('adjustBlock').hidden = true;
      $('adjustReason').value = '';
      document.body.style.overflow = 'hidden';
    }

    function closeModal(){
      const back = $('metricModal');
      if(!back) return;
      back.dataset.open = '0';
      back.setAttribute('aria-hidden','true');
      MODAL.open = false;
      document.body.style.overflow = '';
      showBanner('');
      $('adjustBlock').hidden = true;
      $('adjustReason').value = '';
      MODAL.combineInvalid = false;
      if (typeof MODAL._combineUnwire === 'function'){
        try{ MODAL._combineUnwire(); }catch{}
      }
      MODAL._combineUnwire = null;
    }

    function fmtNum(v){
      if(v == null || v === '') return '';
      const n = Number(v);
      if(Number.isNaN(n)) return '';
      if(Math.abs(n - Math.round(n)) < 1e-9) return String(Math.round(n));
      return String(n);
    }

    function buildMetricForm(docData, cfg){
      const form = $('metricForm');
      const help = $('metricHelp');
      if(!form || !help) return;

      form.innerHTML = '';
      const fields = Array.isArray(cfg.metricFields) ? cfg.metricFields : [];
      MODAL.fields = fields;

      const rows = [];
      for (const f of fields){
        const current = docData?.[f.key];
        const label = f.label || f.key;
        const suffix = f.suffix || '';
        const step = f.step || '1';

        const el = document.createElement('div');
        el.className = 'field';
        el.innerHTML = `
          <div class="label">${label}</div>
          <input
            class="input"
            inputmode="decimal"
            autocomplete="off"
            spellcheck="false"
            id="metric_${f.key}"
            type="number"
            step="${String(step).replace(/"/g,'')}"
            placeholder="Enter new ${label.toLowerCase()}"
          />
          <div class="hint" id="hint_metric_${f.key}" hidden></div>
          <div class="help">Current: <b>${fmtNum(current) || '‚Äî'}</b>${suffix ? ` ${suffix}` : ''}. New value cannot be less than current.</div>
        `;
        rows.push(el);
      }

      for(let i=0;i<rows.length;i+=2){
        const row = document.createElement('div');
        row.className = 'row';
        row.appendChild(rows[i]);
        if(rows[i+1]) row.appendChild(rows[i+1]);
        form.appendChild(row);
      }

      if(fields.length === 0){
        const empty = document.createElement('div');
        empty.className = 'card';
        empty.style.padding = '12px';
        empty.innerHTML = `
          <div style="font-weight:950;">No usage metric configured</div>
          <div class="small-note">This equipment doesn‚Äôt have hours/mileage/acres tracking enabled.</div>
        `;
        form.appendChild(empty);
      }

      const overrideKey = 'equipment-metrics:override';
      help.innerHTML = `
        <div class="small-note">
          Rules:
          <b>No reductions allowed</b> (prevents rollback).
          If something truly needs to go down (meter replaced, typo), use the <b>Adjustment Request</b>.
          ${ (window.FV && typeof window.FV.can === 'function')
              ? `If you have special permission (<code>${overrideKey}</code>), an office user can override decreases with a reason.`
              : ``
          }
        </div>
      `;

      for (const f of fields){
        const inp = $(`metric_${f.key}`);
        if(inp) inp.value = '';
        const hint = $(`hint_metric_${f.key}`);
        if (hint){ hint.hidden = true; hint.textContent = ''; hint.classList.remove('error'); }
      }
    }

    function toNum(v){
      const n = Number(String(v ?? '').trim());
      return Number.isFinite(n) ? n : null;
    }

    function wireCombineModalRule(){
      const eng = $('metric_engineHours');
      const sep = $('metric_separatorHours');
      const hint = $('hint_metric_separatorHours');
      if (!eng || !sep || !hint) { MODAL.combineInvalid = false; return; }

      function clearErr(){
        sep.classList.remove('input-error');
        hint.hidden = true;
        hint.textContent = '';
        hint.classList.remove('error');
        MODAL.combineInvalid = false;
      }
      function setErr(){
        sep.classList.add('input-error');
        hint.hidden = false;
        hint.textContent = 'Separator Hours cannot be greater than Engine Hours. (You may have typed into the wrong box.)';
        hint.classList.add('error');
        MODAL.combineInvalid = true;
      }
      function validate(){
        const e = toNum(eng.value);
        const s = toNum(sep.value);
        if (e == null || s == null){ clearErr(); return; }
        if (s > e) setErr(); else clearErr();
      }

      const onAny = ()=>validate();
      eng.addEventListener('input', onAny);
      sep.addEventListener('input', onAny);
      eng.addEventListener('change', onAny);
      sep.addEventListener('change', onAny);
      validate();

      MODAL._combineUnwire = ()=>{
        eng.removeEventListener('input', onAny);
        sep.removeEventListener('input', onAny);
        eng.removeEventListener('change', onAny);
        sep.removeEventListener('change', onAny);
      };
    }

    function getCurrentValue(docData, key){
      const v = docData?.[key];
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    }

    function readInputs(){
      const out = {};
      for(const f of (MODAL.fields||[])){
        const el = $(`metric_${f.key}`);
        const raw = el ? String(el.value ?? '').trim() : '';
        if(raw === '') continue;
        const n = Number(raw);
        out[f.key] = Number.isFinite(n) ? n : NaN;
      }
      return out;
    }

    function hasAnyInput(inputs){
      return inputs && Object.keys(inputs).length > 0;
    }

    function computeValidation(docData, inputs){
      const results = { ok:true, anyDecrease:false, badNumbers:[], decreases:[], updates:{} };
      for(const [k,v] of Object.entries(inputs)){
        if(!Number.isFinite(v)){ results.ok=false; results.badNumbers.push(k); continue; }
        const cur = getCurrentValue(docData, k);
        if(cur == null){ results.updates[k]=v; continue; }
        if(v < cur){ results.anyDecrease=true; results.decreases.push({ key:k, current:cur, next:v }); continue; }
        if(v === cur) continue;
        results.updates[k]=v;
      }
      if(results.badNumbers.length) results.ok=false;
      return results;
    }

    function updateMetricChip(docData, cfg, typeKey){
      const chip = $('eqMetric');
      if(!chip) return;

      const fields = Array.isArray(cfg.metricFields) ? cfg.metricFields : [];
      if(fields.length === 0){ chip.hidden = true; return; }

      if(String(typeKey||'') === 'combine'){
        const e = docData?.engineHours;
        const s = docData?.separatorHours;
        const parts = [];
        if(e != null && e !== '') parts.push(`${fmtNum(e)} hrs eng`);
        if(s != null && s !== '') parts.push(`${fmtNum(s)} hrs sep`);
        if(parts.length){ chip.textContent = parts.join(' ‚Ä¢ '); chip.hidden=false; return; }
      }

      const f0 = fields[0];
      const v0 = docData?.[f0.key];
      if(v0 != null){ chip.textContent = `${fmtNum(v0)}${f0.suffix ? ` ${f0.suffix}` : ''}`; chip.hidden=false; }
      else chip.hidden=true;
    }

    async function saveMetrics(){
      if(!MODAL.db || !MODAL.snapRef || !MODAL.doc) return;

      const btnSave = $('metricSave');
      const btnCancel = $('metricCancel');
      if(btnSave) btnSave.disabled = true;
      if(btnCancel) btnCancel.disabled = true;
      showBanner('');

      try{
        const inputs = readInputs();
        MODAL.lastInputs = inputs;

        if(!hasAnyInput(inputs)){ showBanner('Enter at least one new reading to save.'); return; }

        if (String(MODAL.typeKey||'') === 'combine'){
          const e = toNum($('metric_engineHours')?.value);
          const s = toNum($('metric_separatorHours')?.value);
          if (e != null && s != null && s > e){ showBanner('Fix required: Separator Hours cannot be greater than Engine Hours.'); return; }
        }

        const v = computeValidation(MODAL.doc, inputs);
        if(v.badNumbers.length){ showBanner('One or more values are not valid numbers.'); return; }

        const overrideKey = 'equipment-metrics:override';
        const canOverride = !!(window.FV && typeof window.FV.can === 'function' && window.FV.can(overrideKey));

        if(v.anyDecrease && !canOverride){
          const lines = v.decreases.map(x=>{
            const label = (MODAL.fields.find(f=>f.key===x.key)?.label) || x.key;
            return `‚Ä¢ ${label}: current ${fmtNum(x.current)} ‚Üí attempted ${fmtNum(x.next)}`;
          }).join('\n');

          showBanner(
            `Not allowed: readings cannot be reduced.\n` +
            `Use Adjustment Request (below) so an office/admin can review.\n\n` +
            `${lines}`
          );
          $('adjustBlock').hidden = false;
          return;
        }

        if(v.anyDecrease && canOverride){
          const reason = String($('adjustReason')?.value || '').trim();
          if(!reason){
            showBanner('Override requires a reason. Enter a note in the "Reason / note to office" box.');
            $('adjustBlock').hidden = false;
            return;
          }
          for(const dec of v.decreases){ v.updates[dec.key] = dec.next; }
        }

        if(Object.keys(v.updates).length === 0){ showBanner('No changes to save (new values match current).'); return; }

        const auth = getAuth();
        const user = auth.currentUser || null;

        const patch = {
          ...v.updates,
          metricUpdatedAt: serverTimestamp(),
          metricUpdatedBy: user?.email || null
        };

        await updateDoc(MODAL.snapRef, patch);

        await addDoc(collection(MODAL.db, 'equipment_metric_entries'), {
          equipmentId: id,
          equipmentType: MODAL.typeKey || null,
          updatedAt: serverTimestamp(),
          updatedBy: user?.email || null,
          updates: v.updates,
          previous: Object.fromEntries(Object.keys(v.updates).map(k => [k, getCurrentValue(MODAL.doc, k)])),
          from: from || null,
          mode: (v.anyDecrease ? 'override' : 'normal')
        });

        for(const [k,val] of Object.entries(v.updates)){ MODAL.doc[k] = val; }

        updateMetricChip(MODAL.doc, MODAL.cfg, MODAL.typeKey);
        showBanner('Saved.');
        setTimeout(()=>closeModal(), 220);
      }catch(e){
        console.error('[hub] saveMetrics error', e);
        showBanner('Save failed. Try again (or check connection).');
      }finally{
        if(btnSave) btnSave.disabled = false;
        if(btnCancel) btnCancel.disabled = false;
      }
    }

    async function sendAdjustmentRequest(){
      try{
        if(!MODAL.db || !MODAL.doc) return;
        const reason = String($('adjustReason')?.value || '').trim();
        if(!reason){ showBanner('Please enter a reason so the office knows what to fix.'); return; }

        const inputs = MODAL.lastInputs || readInputs();
        if(!hasAnyInput(inputs)){ showBanner('Enter the value(s) you attempted, then send the request.'); return; }

        const v = computeValidation(MODAL.doc, inputs);
        if(!v.anyDecrease){ showBanner('This request is only needed when a value would be reduced.'); $('adjustBlock').hidden = true; return; }

        const auth = getAuth();
        const user = auth.currentUser || null;

        await addDoc(collection(MODAL.db, 'equipment_metric_adjust_requests'), {
          equipmentId: id,
          equipmentType: MODAL.typeKey || null,
          createdAt: serverTimestamp(),
          createdBy: user?.email || null,
          status: 'open',
          reason,
          attempted: Object.fromEntries(v.decreases.map(d => [d.key, d.next])),
          current: Object.fromEntries(v.decreases.map(d => [d.key, d.current])),
          from: from || null
        });

        showBanner('Adjustment request sent. Office/admin will review.');
        setTimeout(()=>closeModal(), 380);
      }catch(e){
        console.error('[hub] sendAdjustmentRequest error', e);
        showBanner('Could not send request. Try again.');
      }
    }

    function wireMetricModalButtons(){
      const back = $('metricModal');
      const closeBtn = $('metricModalClose');
      const cancelBtn = $('metricCancel');
      const saveBtn = $('metricSave');
      const reqBtn = $('btnRequestAdjust');
      const adjCancel = $('btnAdjustCancel');

      if(closeBtn) closeBtn.addEventListener('click', closeModal);
      if(cancelBtn) cancelBtn.addEventListener('click', closeModal);
      if(saveBtn) saveBtn.addEventListener('click', saveMetrics);

      if(reqBtn) reqBtn.addEventListener('click', sendAdjustmentRequest);
      if(adjCancel) adjCancel.addEventListener('click', ()=>{
        $('adjustBlock').hidden = true;
        showBanner('');
      });

      if(back){
        back.addEventListener('click', (e)=>{
          if(e.target === back) closeModal();
        });
      }

      window.addEventListener('keydown', (e)=>{
        if(e.key === 'Escape' && MODAL.open) closeModal();
      });
    }

    function openMetricModal(docData, cfg, typeKey, db, snapRef){
      MODAL.doc = docData;
      MODAL.cfg = cfg;
      MODAL.typeKey = typeKey;
      MODAL.db = db;
      MODAL.snapRef = snapRef;

      $('metricModalTitle').textContent = cfg.updateLabel || 'Update Usage';
      buildMetricForm(docData, cfg);

      if(!Array.isArray(cfg.metricFields) || cfg.metricFields.length === 0){
        showBanner('No usage metric configured for this equipment.');
        return;
      }

      if (String(typeKey||'') === 'combine'){ wireCombineModalRule(); }
      openModal();
    }

    /* ======================
       Service Records Modal
       ====================== */
    const SR = {
      open:false,
      rows:[],
      db:null
    };

    function srShowBanner(msg){
      const b = $('srBanner');
      if(!b) return;
      if(!msg){ b.textContent=''; b.dataset.show='0'; return; }
      b.textContent = msg;
      b.dataset.show='1';
    }

    function srOpen(){
      const back = $('srModal');
      if(!back) return;
      back.dataset.open='1';
      back.setAttribute('aria-hidden','false');
      SR.open=true;
      document.body.style.overflow='hidden';
    }

    function srClose(){
      const back = $('srModal');
      if(!back) return;
      back.dataset.open='0';
      back.setAttribute('aria-hidden','true');
      SR.open=false;
      document.body.style.overflow='';
    }

    function toDateMaybe(v){
      try{
        if(!v) return null;
        if(typeof v.toDate === 'function') return v.toDate();
        if(typeof v.seconds === 'number') return new Date(v.seconds*1000);
        if(typeof v === 'string'){
          const d = new Date(v);
          if(!Number.isNaN(d.getTime())) return d;
        }
        if(typeof v === 'number'){
          const d = new Date(v);
          if(!Number.isNaN(d.getTime())) return d;
        }
        return null;
      }catch{ return null; }
    }

    function pad2(n){ return String(n).padStart(2,'0'); }
    function fmtDateTime(d){
      if(!d) return '‚Äî';
      const mm = pad2(d.getMonth()+1);
      const dd = pad2(d.getDate());
      const yy = d.getFullYear();
      let hh = d.getHours();
      const ap = hh >= 12 ? 'PM' : 'AM';
      hh = hh % 12; if(hh===0) hh=12;
      const mi = pad2(d.getMinutes());
      return `${mm}/${dd}/${yy} ${hh}:${mi} ${ap}`;
    }

    function bestRecordDate(r){
      return (
        toDateMaybe(r?.completedAt) ||
        toDateMaybe(r?.updatedAt) ||
        toDateMaybe(r?.createdAt) ||
        toDateMaybe(r?.date) ||
        null
      );
    }

    function normStatus(s){
      const v = String(s||'').trim().toLowerCase();
      if(!v) return '‚Äî';
      if(v === 'in-progress' || v === 'in progress') return 'In Progress';
      if(v === 'completed' || v === 'complete') return 'Completed';
      if(v === 'open') return 'Open';
      if(v === 'pending') return 'Pending';
      return v.replace(/\b\w/g, m=>m.toUpperCase());
    }

    function safeText(v){ return String(v ?? '').trim(); }

    function pickTitle(r){
      return (
        safeText(r?.title) ||
        safeText(r?.summary) ||
        safeText(r?.problem) ||
        safeText(r?.issue) ||
        safeText(r?.subject) ||
        'Service Record'
      );
    }

    function pickNotes(r){
      return (
        safeText(r?.notes) ||
        safeText(r?.description) ||
        safeText(r?.details) ||
        safeText(r?.workDone) ||
        ''
      );
    }

    function money(v){
      const n = Number(v);
      if(!Number.isFinite(n)) return '';
      return `$${n.toFixed(2)}`;
    }

    function buildSrItemHtml(row){
      const r = row.data || {};
      const when = fmtDateTime(bestRecordDate(r));
      const status = normStatus(r.status);
      const title = pickTitle(r);
      const notes = pickNotes(r);

      const tags = [];
      if(status && status !== '‚Äî') tags.push(status);
      if(r.vendorName) tags.push(safeText(r.vendorName));
      if(r.category) tags.push(safeText(r.category));
      if(r.cost != null){
        const c = money(r.cost);
        if(c) tags.push(c);
      }
      if(r.meterLabel && r.meterValue != null){
        tags.push(`${safeText(r.meterLabel)}: ${safeText(r.meterValue)}`);
      }

      return `
        <div class="sr-item">
          <div class="sr-top">
            <div style="min-width:0">
              <p class="sr-title">${title}</p>
              <p class="sr-sub">${when}</p>
            </div>
            <div class="sr-tags" aria-hidden="true" style="justify-content:flex-end">
              ${tags.slice(0,3).map(t=>`<span class="sr-tag">${t}</span>`).join('')}
            </div>
          </div>

          ${tags.length > 3 ? `
            <div class="sr-tags">
              ${tags.slice(3).map(t=>`<span class="sr-tag">${t}</span>`).join('')}
            </div>
          ` : ''}

          ${notes ? `<p class="sr-notes">${notes}</p>` : ''}
        </div>
      `;
    }

    function renderSrList(){
      const list = $('srList');
      if(!list) return;

      if(!SR.rows.length){
        list.innerHTML = `<div class="sr-empty">No service records found for this equipment.</div>`;
        return;
      }

      list.innerHTML = SR.rows.map(buildSrItemHtml).join('');
    }

    async function loadServiceRecordsForEquipment(db, equipmentId){
      // Try common names so it works even if your collection differs.
      const candidates = ['equipmentWorkOrders','equipment_work_orders','equipment_service_records'];

      for(const colName of candidates){
        try{
          const base = collection(db, colName);
          // Keep query simple (where + limit) then sort client-side
          const q = query(base, where('equipmentId','==', equipmentId), limit(250));
          const snap = await getDocs(q);
          const rows = snap.docs.map(d=>({ id:d.id, data:d.data(), _col:colName }));
          if(rows.length){
            console.info('[hub][sr] loaded', rows.length, 'from', colName);
            return rows;
          }
        }catch(e){
          console.warn('[hub][sr] query failed for', colName, e?.code||e);
        }
      }
      return [];
    }

    async function openServiceRecords(){
      try{
        if(!SR.db) SR.db = getFirestore();
        srShowBanner('');
        $('srList').innerHTML = `<div class="sr-empty">Loading‚Ä¶</div>`;
        $('srTitle').textContent = `Service Records ‚Äî ${$('eqName')?.textContent || 'Equipment'}`;
        srOpen();

        const rows = await loadServiceRecordsForEquipment(SR.db, id);

        rows.sort((a,b)=>{
          const da = bestRecordDate(a.data);
          const dbb = bestRecordDate(b.data);
          const ta = da ? da.getTime() : 0;
          const tb = dbb ? dbb.getTime() : 0;
          return tb - ta; // newest first
        });

        SR.rows = rows;
        renderSrList();
      }catch(e){
        console.error('[hub][sr] openServiceRecords error', e);
        srShowBanner('Could not load service records. Check connection.');
        $('srList').innerHTML = `<div class="sr-empty">Error loading records.</div>`;
      }
    }

    function openPrintWindow(html){
      const w = window.open('', '_blank', 'noopener,noreferrer');
      if(!w){ srShowBanner('Popup blocked. Allow popups to print.'); return; }
      w.document.open();
      w.document.write(html);
      w.document.close();
    }

    function buildPrintShell({ title, subtitle, bodyHtml }){
      // IMPORTANT: no </script> inside template strings. (We use a button, no auto-print.)
      return `<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>${title}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body{ font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; margin:20px; color:#111; }
    h1{ margin:0 0 6px; font-size:20px; }
    .muted{ color:#666; margin:0 0 14px; }
    .bar{ display:flex; gap:10px; align-items:center; justify-content:space-between; margin:0 0 14px; }
    .btn{
      border:1px solid #ddd; border-radius:10px; padding:10px 12px;
      font-weight:800; background:#f7f7f7; cursor:pointer;
    }
    @media print{ .bar{ display:none; } body{ margin:0.5in; } }
    table{ width:100%; border-collapse:collapse; }
    th{ text-align:left; font-size:12px; color:#444; padding:8px 10px; border-bottom:2px solid #111; }
    td{ font-size:13px; padding:8px 10px; border-bottom:1px solid #ddd; vertical-align:top; }
  </style>
</head>
<body>
  <div class="bar">
    <div>
      <h1>${title}</h1>
      <div class="muted">${subtitle || ''}</div>
    </div>
    <button class="btn" onclick="window.print()">Print</button>
  </div>

  ${bodyHtml || ''}

</body>
</html>`;
    }

    function buildSummaryPrintHtml(){
      const eqLabel = $('eqName')?.textContent || 'Equipment';
      const items = (SR.rows||[]).map(r=>{
        const d = r.data || {};
        const when = fmtDateTime(bestRecordDate(d));
        return `<tr>
          <td style="width:190px">${when}</td>
          <td>${pickTitle(d)}</td>
          <td style="width:130px">${normStatus(d.status)}</td>
        </tr>`;
      }).join('');

      const body = `
        <table>
          <thead>
            <tr><th style="width:190px">Date</th><th>Record</th><th style="width:130px">Status</th></tr>
          </thead>
          <tbody>
            ${items || `<tr><td colspan="3">No records.</td></tr>`}
          </tbody>
        </table>
      `;
      return buildPrintShell({
        title: 'Service Records ‚Äî Summary',
        subtitle: eqLabel,
        bodyHtml: body
      });
    }

    function buildDetailedPrintHtml(){
      const eqLabel = $('eqName')?.textContent || 'Equipment';
      const blocks = (SR.rows||[]).map(r=>{
        const d = r.data || {};
        const when = fmtDateTime(bestRecordDate(d));
        const title = pickTitle(d);
        const notes = pickNotes(d);
        return `
          <div style="border:1px solid #ddd;border-radius:10px;padding:12px;margin:0 0 12px;">
            <div style="font-weight:900;margin:0 0 4px;">${title}</div>
            <div style="color:#666;font-size:12px;margin:0 0 8px;">${when} ‚Ä¢ ${normStatus(d.status)}</div>
            ${notes ? `<div style="white-space:pre-wrap;line-height:1.35;font-size:13px;">${notes}</div>` : `<div style="color:#777;font-size:13px;">(No details)</div>`}
          </div>
        `;
      }).join('');

      return buildPrintShell({
        title: 'Service Records ‚Äî Detailed',
        subtitle: eqLabel,
        bodyHtml: blocks || `<div>No records.</div>`
      });
    }

    function wireServiceRecordsModalButtons(){
      const back = $('srModal');
      const closeBtn = $('srClose');

      if(closeBtn) closeBtn.addEventListener('click', srClose);
      if(back){
        back.addEventListener('click', (e)=>{ if(e.target === back) srClose(); });
      }

      window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && SR.open) srClose(); });

      $('srPrintSummary')?.addEventListener('click', ()=>{
        openPrintWindow(buildSummaryPrintHtml());
      });

      $('srPrintDetailed')?.addEventListener('click', ()=>{
        openPrintWindow(buildDetailedPrintHtml());
      });
    }

    /* ======================
       Init
       ====================== */
    const TIMEOUT_MS = 22000;
    let finished=false;
    const watchdog=setTimeout(()=>{
      if(finished) return;
      showContent();
      $('timeoutCard').hidden=false;
      $('status').textContent='Timed out waiting for data.'; $('status').hidden=false;
      console.warn('[hub] watchdog fired');
    },TIMEOUT_MS);

    async function userReady(maxMs=3000){
      const auth = getAuth();
      if (auth.currentUser) return;
      const first = new Promise(res=>{
        const off = onAuthStateChanged(auth, (u)=>{ try{off();}catch{} res(u); }, { onlyOnce:true });
      });
      let u = await first;
      if (u) return;
      const t0 = Date.now();
      while(!auth.currentUser && (Date.now()-t0) < maxMs){
        await new Promise(r=>setTimeout(r,120));
      }
    }

    async function getDocWithRetry(ref){
      try { return await getDoc(ref); }
      catch(e){ await new Promise(r=>setTimeout(r, 600)); return await getDoc(ref); }
    }

    function cloneCfg(base){
      return {
        display: base.display,
        updateLabel: base.updateLabel,
        hasPreSeason: !!base.hasPreSeason,
        metricFields: Array.isArray(base.metricFields) ? base.metricFields.slice() : []
      };
    }

    function resolveEffectiveCfg(typeKey, d){
      const base = HUB_CONFIG[typeKey] || HUB_CONFIG.equipment;
      const cfg = cloneCfg(base);

      if(typeKey === 'implement'){
        const it = String(d.implementType || '').toLowerCase();
        if(it === 'planter'){
          cfg.display = 'Planter';
          cfg.updateLabel = 'Update Planter Acres / Hours';
          cfg.metricFields = [
            { key:'totalAcres', label:'Total Acres', suffix:'ac', step:'1' },
            { key:'totalHours', label:'Total Hours', suffix:'hrs', step:'0.1' }
          ];
        }else{
          cfg.metricFields = [];
          cfg.updateLabel = '';
        }
      }

      if(typeKey === 'construction'){
        const ct = String(d.constructionType || '').toLowerCase();
        if(ct && ct !== 'machine'){
          cfg.metricFields = [];
          cfg.updateLabel = '';
        }
      }

      if(!cfg.metricFields || cfg.metricFields.length === 0){
        cfg.updateLabel = '';
      }

      return cfg;
    }

    let runId = 0;
    async function init(){
      const my = ++runId;
      await ready;
      await userReady();
      if (my !== runId) return;

      if(!id){
        clearTimeout(watchdog); finished=true; showContent();
        $('status').textContent='No equipment id provided.'; $('status').hidden=false;
        return;
      }

      const db=getFirestore();
      let snap;
      let ref;

      try{
        ref = doc(db,'equipment',id);
        snap = await getDocWithRetry(ref);
      }catch(e){
        console.error('[hub] getDoc error', e);
        clearTimeout(watchdog); finished=true; showContent();
        $('status').textContent='Error loading hub.'; $('status').hidden=false;
        return;
      }
      if (my !== runId) return;

      clearTimeout(watchdog); finished=true; showContent();

      if(!snap.exists()){
        $('status').textContent='Not found.'; $('status').hidden=false;
        return;
      }

      const d = snap.data() || {}; d.id = id;
      const typeKey = String(d.type || 'equipment').toLowerCase();
      const cfg = resolveEffectiveCfg(typeKey, d);

      const hubTitle = `${cfg.display} Hub`;
      setText('pageTitle', hubTitle);
      document.title = `FarmVista ‚Ä¢ ${hubTitle}`;

      const mm = [d.makeName, d.modelName].filter(Boolean).join(' ');
      const ls = last6(d.serial);
      const title = mm ? `${mm}${ls ? ` (#${ls})` : ''}` : (d.name || `Unit ${id.slice(0,6)}`);
      setText('eqName', title);
      if(ls) setText('eqSerial', `SN #${ls}`, { unhide:true });

      updateMetricChip(d, cfg, typeKey);
      $('eqCard').hidden = false;

      const calcCard = $('combineCalcs');

      const isArchived = (String(d.status||'').toLowerCase() === 'archived') || (d.archived === true);
      if(isArchived){
        const name = mm || 'This unit';
        $('archivedMsg').textContent = `‚Äú${name}${ls ? ' ‚Ä¢ SN ‚Ä¶'+ls : ''}‚Äù is archived and not available for new entries.`;
        $('archivedCard').hidden = false;
        if (calcCard) calcCard.hidden = true;
      }else{
        setText('linkReq', 'Submit Service Request');
        $('linkReq').hidden = false;

        if(Array.isArray(cfg.metricFields) && cfg.metricFields.length > 0 && cfg.updateLabel){
          setText('linkMetric', cfg.updateLabel);
          $('linkMetric').hidden = false;
        }else{
          $('linkMetric').hidden = true;
        }

        $('linkMaint').hidden = false;
        $('linkPre').hidden   = !cfg.hasPreSeason;

        $('linkReq').href =
          `/Farm-vista/pages/equipment/actions/service-request.html?id=${encodeURIComponent(id)}${from ? `&from=${encodeURIComponent(from)}` : ''}`;

        // Service Records opens popup
        $('linkMaint').href = '#';
        $('linkMaint').onclick = (e)=>{ e.preventDefault(); openServiceRecords(); };

        $('linkPre').href = '#';

        if(!$('linkMetric').hidden){
          $('linkMetric').href = '#';
          $('linkMetric').onclick = (e)=>{
            e.preventDefault();
            openMetricModal(d, cfg, typeKey, db, ref);
          };
        }else{
          $('linkMetric').onclick = null;
        }

        if(typeKey === 'starfire'){
          setText('linkMetric', 'Update Location');
          $('linkMetric').hidden = false;
          $('linkMetric').href = `/Farm-vista/pages/equipment/actions/starfire-location.html?id=${encodeURIComponent(id)}`;
          $('linkMetric').onclick = null;
          $('linkMaint').hidden = true;
          $('linkPre').hidden   = true;
          if (calcCard) calcCard.hidden = true;
        } else {
          if (typeKey === 'combine' && calcCard) {
            const basePath   = '/Farm-vista/pages/calculators';
            $('linkCalcLoss').href  = `${basePath}/calc-combine-grain-loss.html?equipmentId=${encodeURIComponent(id)}`;
            $('linkCalcYieldCheck').href = `${basePath}/calc-combine-yield.html?equipmentId=${encodeURIComponent(id)}`;
            $('linkCalcYieldCal').href = `${basePath}/calc-combine-yield-calibration.html?equipmentId=${encodeURIComponent(id)}`;
            calcCard.hidden = false;
          } else if (calcCard) {
            calcCard.hidden = true;
          }
        }

        $('fnLinks').hidden = false;
      }

      setupReturnButtons(typeKey);
    }

    wireMetricModalButtons();
    wireServiceRecordsModalButtons();

    init().catch(e=>{
      console.error('[hub] init fatal', e);
      clearTimeout(watchdog); finished=true; showContent();
      $('status').textContent='Error loading hub.'; $('status').hidden=false;
    });

    window.addEventListener('pageshow', (e)=>{ if(e.persisted) init(); });
    document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') init(); });
  </script>
</body>
</html>
