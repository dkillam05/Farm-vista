<!-- =====================================================================
/Farm-vista/pages/equipment/actions/hub.html  (FULL FILE)
Rev: 2025-11-12b
Changes in this build (timing-hardening, ID-only):
 ‚Ä¢ Still requires ?id={documentId}; no token/code lookup.
 ‚Ä¢ Canonicalize URL: if t/code are present, strip them from the address bar.
 ‚Ä¢ Wait for Firebase Auth to emit the first state before Firestore call.
 ‚Ä¢ Add single-run guard so late/duplicate inits don‚Äôt override the latest.
 ‚Ä¢ Add gentle retry (1x) for getDoc with small backoff.
 ‚Ä¢ Extend watchdog timeout for cold starts.
 ‚Ä¢ Add preconnect hints and resume listeners (pageshow/visibility).
===================================================================== -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista ‚Ä¢ Equipment Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>

  <!-- Connection warmups -->
  <link rel="preconnect" href="https://firestore.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://www.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>

  <!-- Theme + app CSS -->
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <!-- Ensure fv-shell -->
  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true; document.head.appendChild(s);
      }
    })();
  </script>

  <style>
    :root{ --card-max:900px; --brand:var(--green,#3B7E46); }
    body{ background:var(--app-bg,var(--surface)); margin:0; }

    /* Remove blue link font in dark mode */
    .wrap, .wrap * { -webkit-tap-highlight-color: transparent; }
    .wrap a,
    .wrap a:visited,
    .wrap a:active,
    .wrap a:hover { color:inherit; text-decoration:none; }
    .btn { color:var(--ink-1,#0f1a13); }
    :root[data-theme="dark"] .btn { color:var(--ink-1,#eaece9); }
    .btn-primary { color:#fff; }

    .wrap{ max-width:var(--card-max); margin:0 auto; padding:clamp(14px,3vw,22px);
           padding-bottom:calc(env(safe-area-inset-bottom,0px)+72px)!important; }
    .hero{ border:1px solid var(--border); border-radius:14px; background:var(--surface);
           box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08)); overflow:hidden; margin:8px 0 18px; }
    .hero-head{ padding:14px 16px; border-bottom:1px solid var(--border);
                background:color-mix(in srgb,var(--brand) 12%, transparent); }
    .hero-head h1{ margin:0; font-size:clamp(20px,3.2vw,26px); }
    .muted{ color:var(--muted,#67706B) }
    .body{ padding:16px; display:grid; gap:18px }
    .card{ border:1px solid var(--border); border-radius:12px; background:var(--surface);
           padding:14px; display:grid; gap:8px }
    .meta{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .chip{ font-size:12px; border:1px solid var(--border); border-radius:999px; padding:6px 10px; background:var(--surface) }
    .actions{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
    @media (max-width:640px){ .actions{ grid-template-columns:1fr } }
    .btn{ display:inline-flex; align-items:center; justify-content:center; min-height:52px;
          font-weight:800; border-radius:14px; border:1px solid var(--border);
          background:var(--card-surface,var(--surface)); text-decoration:none }
    .btn-primary{ background:var(--brand); border-color:transparent }

    .fs-load{ position:fixed; inset:0; z-index:60; display:flex; align-items:center; justify-content:center;
              backdrop-filter:blur(6px);
              background:color-mix(in srgb, var(--page-bg,#F6F7F6) 75%, transparent);
              padding:calc(env(safe-area-inset-top,0px)+24px) 16px calc(env(safe-area-inset-bottom,0px)+24px); }
    .fs-card{ width:min(92vw,520px); background:var(--surface,#fff); border-radius:18px; padding:22px 18px;
              box-shadow:0 14px 36px rgba(0,0,0,.12); text-align:center; border:1px solid var(--border); }
    .spin{ width:64px; height:64px; border-radius:50%; border:6px solid rgba(0,0,0,.08);
           border-top-color:var(--brand); margin:12px auto; animation:spin 1s linear infinite; }
    @keyframes spin{ to{ transform:rotate(360deg) } }
    .fs-card h3{ margin:0 0 4px; font-size:22px; font-weight:900; color:var(--ink-1,#0f1a13);}
    .fs-card p{ margin:0; color:var(--muted,#67706B); }
    .state{ border:1px solid var(--border); border-radius:12px; background:var(--surface);
            padding:22px; display:grid; gap:12px; justify-items:center; text-align:center; }
    .state .emo{ font-size:44px; line-height:1; filter:grayscale(.05); }
    .state h2{ margin:0; font-size:20px; font-weight:900; }
    .state p{ margin:0; color:var(--muted,#67706B); max-width:520px; }
    [hidden]{ display:none !important; }
  </style>
</head>

<body>
  <fv-shell>
    <div class="wrap" id="content" hidden>
      <section class="hero">
        <header class="hero-head">
          <h1 id="pageTitle">Equipment Hub</h1>
          <p class="muted" id="status" hidden></p>
        </header>

        <div class="body">
          <div class="card" id="eqCard" hidden>
            <h2 id="eqName" style="margin:0"></h2>
            <div class="meta">
              <span id="eqType" class="chip"></span>
              <span id="eqMakeModel" class="chip"></span>
              <span id="eqSerial" class="chip" hidden></span>
              <span id="eqHours" class="chip" hidden></span>
            </div>
            <p id="eqNotes" class="muted" hidden></p>
          </div>

          <div class="actions" id="fnLinks" hidden>
            <a id="linkHours" class="btn btn-primary" href="#">Track Engine Hours</a>
            <a id="linkMaint" class="btn" href="#">Service Records</a>
            <a id="linkReq"   class="btn" href="#">Submit Service Request</a>
            <a id="linkPre"   class="btn" href="#">Pre-Season Checklist</a>
          </div>

          <div id="archivedCard" class="state" hidden>
            <div class="emo">üì¶</div>
            <h2>This equipment is archived</h2>
            <p id="archivedMsg">This item isn‚Äôt available for new entries at this time.</p>
            <div class="actions">
              <a class="btn btn-primary" href="/Farm-vista/pages/qr-scan.html">Rescan</a>
              <a class="btn" href="/Farm-vista/index.html">Return to Home</a>
            </div>
          </div>

          <div id="timeoutCard" class="state" hidden>
            <div class="emo">‚è±Ô∏è</div>
            <h2>Timed out</h2>
            <p>It‚Äôs taking longer than expected to load this equipment.</p>
            <div class="actions">
              <a class="btn btn-primary" href="/Farm-vista/pages/qr-scan.html">Rescan</a>
              <a class="btn" href="/Farm-vista/index.html">Return to Home</a>
            </div>
          </div>

          <div class="actions">
            <a class="btn" href="/Farm-vista/pages/equipment/tractors-view.html">Return to Tractors</a>
            <a class="btn" href="/Farm-vista/index.html">Return to Home</a>
          </div>
        </div>
      </section>
    </div>
  </fv-shell>

  <div class="fs-load" id="fsLoad">
    <div class="fs-card">
      <h3>Connecting‚Ä¶</h3>
      <div class="spin"></div>
      <p>Loading data for your farm</p>
    </div>
  </div>

  <script type="module">
    import {
      ready, getFirestore, doc, getDoc, getAuth, onAuthStateChanged
    } from '/Farm-vista/js/firebase-init.js';

    const $ = id => document.getElementById(id);

    // --- Canonicalize URL (strip legacy t/code); read id
    const qs = new URLSearchParams(location.search);
    const id = qs.get('id') || '';
    if (qs.has('t') || qs.has('code')) {
      qs.delete('t'); qs.delete('code');
      const clean = `${location.pathname}?${qs.toString()}`;
      history.replaceState(null,'', clean);
    }

    // --- Utilities
    const last6 = v => String(v||'').slice(-6);
    const capWords = s => String(s||'').replace(/\b\w/g, c=>c.toUpperCase());
    const setText = (id, val, opts={})=>{
      const el=$(id); if(!el) return;
      if(!val){ if(opts.hideIfEmpty) el.hidden=true; else el.textContent=''; return; }
      el.textContent = val; if(opts.unhide) el.hidden=false;
    };
    function showContent(){ $('fsLoad').hidden=true; $('content').hidden=false; }

    // --- Watchdog (slightly longer for cold starts)
    const TIMEOUT_MS = 22000;
    let finished=false;
    const watchdog=setTimeout(()=>{
      if(finished) return;
      showContent();
      $('timeoutCard').hidden=false;
      $('status').textContent='Timed out waiting for data.'; $('status').hidden=false;
    },TIMEOUT_MS);

    // --- Auth gate: wait for first auth state emission (user or null)
    const authReady = () => new Promise(resolve=>{
      try{
        const auth = getAuth();
        const off = onAuthStateChanged(auth, ()=>{ try{off();}catch{} resolve(); }, { onlyOnce:true });
      }catch{ resolve(); } // if auth not available, proceed
    });

    // --- Gentle retry for getDoc (handles transient cold-start failures)
    async function getDocWithRetry(ref){
      try { return await getDoc(ref); }
      catch(e){
        await new Promise(r=>setTimeout(r, 600));
        return await getDoc(ref);
      }
    }

    // --- Single-run guard so only the latest init wins
    let runId = 0;
    async function init(){
      const my = ++runId;

      await ready;
      await authReady(); // ensure auth is rehydrated before first read
      const db=getFirestore();

      if (my !== runId) return; // a newer run started; drop this attempt

      if(!id){
        clearTimeout(watchdog); finished=true; showContent();
        $('status').textContent='No equipment id provided.'; $('status').hidden=false;
        return;
      }

      let snap;
      try{
        const ref = doc(db,'equipment',id);
        snap = await getDocWithRetry(ref);
      }catch(e){
        console.error(e);
        clearTimeout(watchdog); finished=true; showContent();
        $('status').textContent='Error loading hub.'; $('status').hidden=false;
        return;
      }

      if (my !== runId) return; // guard again after await chain

      clearTimeout(watchdog); finished=true; showContent();

      if(!snap.exists()){
        $('status').textContent='Not found.'; $('status').hidden=false;
        return;
      }

      const d=snap.data()||{}; d.id=id;

      // Title and header
      const typeRaw=d.type||'equipment';
      const hubTitle=`${capWords(typeRaw)} Hub`;
      setText('pageTitle',hubTitle);
      document.title=`FarmVista ‚Ä¢ ${hubTitle}`;

      // Main card
      const mm=[d.makeName,d.modelName].filter(Boolean).join(' ');
      const ls=last6(d.serial);
      const title=mm?`${mm}${ls?` (#${ls})`:''}`:(d.name||`Unit ${id.slice(0,6)}`);
      setText('eqName',title);
      setText('eqType',typeRaw);
      setText('eqMakeModel',mm);
      if(ls) setText('eqSerial',`SN #${ls}`,{unhide:true});
      if(d.engineHours!=null) setText('eqHours',`${d.engineHours} hrs`,{unhide:true});
      if(d.notes) setText('eqNotes',d.notes,{unhide:true});
      $('eqCard').hidden=false;

      // Archived state vs links
      const isArchived=(String(d.status||'').toLowerCase()==='archived')||(d.archived===true);
      if(isArchived){
        const name=mm||'This unit';
        $('archivedMsg').textContent=`‚Äú${name}${ls?' ‚Ä¢ SN ‚Ä¶'+ls:''}‚Äù is archived and not available for new entries.`;
        $('archivedCard').hidden=false;
      }else{
        const base="/Farm-vista/pages/equipment/actions";
        const qstr=`?id=${encodeURIComponent(id)}&from=hub`;
        $('linkHours').href=`${base}/engine-hours.html${qstr}`;
        $('linkMaint').href=`${base}/maintenance.html${qstr}`;
        $('linkReq').href=`${base}/service-request.html${qstr}`;
        $('linkPre').href=`${base}/pre-check.html${qstr}`;
        $('fnLinks').hidden=false;
      }
    }

    // Kick once now, and again on true resumes
    init().catch(e=>{
      console.error(e);
      clearTimeout(watchdog); finished=true; showContent();
      $('status').textContent='Error loading hub.'; $('status').hidden=false;
    });

    window.addEventListener('pageshow', (e)=>{ if(e.persisted) init(); });
    document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') init(); });
  </script>
</body>
</html>