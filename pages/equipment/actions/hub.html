<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista ‚Ä¢ Equipment Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>

  <!-- Connection warmups -->
  <link rel="preconnect" href="https://firestore.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://www.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>

  <!-- Theme + app CSS -->
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <!-- IMPORTANT: match tractors ‚Äî load Firebase CONFIG first -->
  <script src="/Farm-vista/js/firebase-config.js"></script>

  <!-- Ensure fv-shell -->
  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true; document.head.appendChild(s);
      }
    })();
  </script>

  <style>
    :root{ --card-max:900px; --brand:var(--green,#3B7E46); }
    body{ background:var(--app-bg,var(--surface)); margin:0; }

    /* kill blue links in dark mode */
    .wrap, .wrap * { -webkit-tap-highlight-color: transparent; }
    .wrap a, .wrap a:visited, .wrap a:active, .wrap a:hover { color:inherit; text-decoration:none; }
    .btn { color:var(--ink-1,#0f1a13); }
    :root[data-theme="dark"] .btn { color:var(--ink-1,#eaece9); }
    .btn-primary { color:#fff; }

    .wrap{
      max-width:var(--card-max);
      margin:0 auto;
      padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px)+72px)!important;
    }
    .hero{
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));
      overflow:hidden;
      margin:8px 0 18px;
    }
    .hero-head{
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      background:color-mix(in srgb,var(--brand) 12%, transparent);
    }
    .hero-head h1{ margin:0; font-size:clamp(20px,3.2vw,26px); }
    .muted{ color:var(--muted,#67706B) }
    .body{ padding:16px; display:grid; gap:18px }
    .card{
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--surface);
      padding:14px;
      display:grid;
      gap:8px
    }
    .meta{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .chip{
      font-size:12px;
      border:1px solid var(--border);
      border-radius:999px;
      padding:6px 10px;
      background:var(--surface)
    }
    .actions{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px
    }
    @media (max-width:640px){
      .actions{ grid-template-columns:1fr }
    }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-height:52px;
      font-weight:800;
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--card-surface,var(--surface));
      text-decoration:none
    }
    .btn-primary{
      background:var(--brand);
      border-color:transparent
    }

    .actions-return{
      margin-top:26px; /* extra separation between main actions and return buttons */
    }

    .state{
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--surface);
      padding:22px;
      display:grid;
      gap:12px;
      justify-items:center;
      text-align:center;
    }
    .state .emo{ font-size:44px; line-height:1; filter:grayscale(.05); }
    .state h2{ margin:0; font-size:20px; font-weight:900; }
    .state p{ margin:0; color:var(--muted,#67706B); max-width:520px; }
    [hidden]{ display:none !important; }

    /* ===== Metric Modal ===== */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + 14px);
      z-index:9999;
    }
    .modal-backdrop[data-open="1"]{ display:flex; }

    .modal{
      width:min(680px, 100%);
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:0 22px 60px rgba(0,0,0,.22);
      overflow:hidden;
    }
    .modal-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:14px 14px;
      border-bottom:1px solid var(--border);
      background:color-mix(in srgb,var(--brand) 10%, transparent);
    }
    .modal-head h3{
      margin:0;
      font-size:16px;
      font-weight:950;
      letter-spacing:.2px;
    }
    .icon-btn{
      appearance:none;
      border:1px solid var(--border);
      background:var(--surface);
      border-radius:12px;
      height:40px;
      width:40px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
    }
    .icon-btn svg{ width:18px; height:18px; }
    .modal-body{
      padding:14px;
      display:grid;
      gap:12px;
    }
    .form-grid{
      display:grid;
      gap:10px;
    }
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width:560px){
      .row{ grid-template-columns:1fr; }
    }
    .field{
      display:grid;
      gap:6px;
    }
    .label{
      font-size:12px;
      font-weight:850;
      color:var(--ink-2, #2a332d);
    }
    :root[data-theme="dark"] .label{ color:var(--ink-2, #d7dbd8); }
    .help{
      font-size:12px;
      color:var(--muted,#67706B);
      line-height:1.25;
    }
    .input{
      width:100%;
      min-height:46px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--card-surface,var(--surface));
      padding:10px 12px;
      font-size:16px;
      font-weight:800;
      color:var(--ink-1,#0f1a13);
      outline:none;
    }
    :root[data-theme="dark"] .input{ color:var(--ink-1,#eaece9); }

    .modal-actions{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      padding:14px;
      border-top:1px solid var(--border);
      background:color-mix(in srgb, var(--surface) 70%, transparent);
    }
    @media (max-width:560px){
      .modal-actions{ grid-template-columns:1fr; }
    }
    .btn-danger{
      background:color-mix(in srgb, #b51f1f 14%, var(--surface));
      border-color:color-mix(in srgb, #b51f1f 30%, var(--border));
    }
    .banner{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      background:color-mix(in srgb, #b51f1f 10%, transparent);
      color:var(--ink-1,#0f1a13);
      font-size:13px;
      line-height:1.3;
      display:none;
      white-space:pre-line; /* allow \n in banner text */
    }
    :root[data-theme="dark"] .banner{ color:var(--ink-1,#eaece9); }
    .banner[data-show="1"]{ display:block; }
    .small-note{
      font-size:12px;
      color:var(--muted,#67706B);
      line-height:1.25;
    }
    .textarea{
      width:100%;
      min-height:88px;
      resize:vertical;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--card-surface,var(--surface));
      padding:10px 12px;
      font-size:14px;
      color:var(--ink-1,#0f1a13);
      outline:none;
    }
    :root[data-theme="dark"] .textarea{ color:var(--ink-1,#eaece9); }

    /* ===== Combine guard (red box + subtle hint) ===== */
    .input-error{
      border-color:#c62828 !important;
      box-shadow:0 0 0 2px rgba(198,40,40,.15);
    }
    .input-hint{
      font-size:12px;
      color:#c62828;
      line-height:1.25;
      margin-top:2px;
      display:none;
    }
    .input-hint[data-show="1"]{ display:block; }
  </style>
</head>

<body>
  <fv-shell>
    <div class="wrap" id="content" hidden>
      <section class="hero">
        <header class="hero-head">
          <h1 id="pageTitle">Equipment Hub</h1>
          <p class="muted" id="status" hidden></p>
        </header>

        <div class="body">
          <!-- Main equipment card -->
          <div class="card" id="eqCard" hidden>
            <h2 id="eqName" style="margin:0"></h2>
            <div class="meta">
              <span id="eqSerial" class="chip" hidden></span>
              <span id="eqMetric" class="chip" hidden></span>
            </div>
          </div>

          <!-- Primary actions: dynamic per type -->
          <div class="actions" id="fnLinks" hidden>
            <a id="linkReq"    class="btn" href="#">Submit Service Request</a>
            <a id="linkMetric" class="btn" href="#">Update Usage</a>
            <a id="linkMaint"  class="btn" href="#">Service Records</a>
            <a id="linkPre"    class="btn" href="#">Pre-Season Checklist</a>
          </div>

          <!-- Combine-only calculators -->
          <div class="card" id="combineCalcs" hidden>
            <div>
              <h3 style="margin:0 0 4px;font-size:16px;font-weight:800;">Calculators</h3>
              <p class="muted" style="margin:0 0 8px;font-size:13px;">
                Quick access to grain loss, yield checks, and yield calibration for this combine.
              </p>
            </div>
            <div class="actions">
              <a id="linkCalcLoss"        class="btn" href="#">Combine Grain Loss</a>
              <a id="linkCalcYieldCheck"  class="btn" href="#">Combine Yield Check</a>
              <a id="linkCalcYieldCal"    class="btn" href="#">Combine Yield Calibration</a>
            </div>
          </div>

          <!-- Archived state -->
          <div id="archivedCard" class="state" hidden>
            <div class="emo">üì¶</div>
            <h2>This equipment is archived</h2>
            <p id="archivedMsg">This item isn‚Äôt available for new entries at this time.</p>
            <div class="actions">
              <a class="btn btn-primary" href="/Farm-vista/pages/qr-scan.html">Rescan</a>
            </div>
          </div>

          <!-- Timeout state -->
          <div id="timeoutCard" class="state" hidden>
            <div class="emo">‚è±Ô∏è</div>
            <h2>Timed out</h2>
            <p>It‚Äôs taking longer than expected to load this equipment.</p>
            <div class="actions">
              <a class="btn btn-primary" href="/Farm-vista/pages/qr-scan.html">Rescan</a>
              <a class="btn" href="/Farm-vista/index.html">Return to Home</a>
            </div>
          </div>

          <!-- Return buttons: separated row -->
          <div class="actions actions-return" id="returnActions">
            <a id="btnReturnOrigin" class="btn" href="#">Return</a>
            <a id="btnReturnHome"   class="btn" href="/Farm-vista/index.html">Return to Home</a>
          </div>
        </div>
      </section>
    </div>

    <!-- ===== Metric Modal (hours / mileage / acres) ===== -->
    <div class="modal-backdrop" id="metricModal" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="metricModalTitle">
        <div class="modal-head">
          <h3 id="metricModalTitle">Update Usage</h3>
          <button class="icon-btn" id="metricModalClose" type="button" aria-label="Close">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
              <path d="M18 6L6 18"></path><path d="M6 6l12 12"></path>
            </svg>
          </button>
        </div>

        <div class="modal-body">
          <div class="banner" id="metricBanner"></div>

          <div class="form-grid" id="metricForm">
            <!-- dynamic rows injected -->
          </div>

          <div id="adjustBlock" hidden>
            <div class="card" style="padding:12px; gap:10px">
              <div style="display:grid; gap:6px">
                <div style="font-weight:950;">Request permissioned adjustment</div>
                <div class="small-note">
                  If a number needs to go DOWN (or was entered wrong), you must request an adjustment.
                  This sends a request to the office/admin queue.
                </div>
              </div>
              <div class="field">
                <div class="label">Reason / note to office</div>
                <textarea class="textarea" id="adjustReason" placeholder="Explain what happened (typo, meter replaced, etc.)"></textarea>
              </div>
              <div class="actions" style="grid-template-columns:1fr 1fr; gap:10px">
                <button class="btn btn-danger" id="btnRequestAdjust" type="button">Send Adjustment Request</button>
                <button class="btn" id="btnAdjustCancel" type="button">Cancel Request</button>
              </div>
            </div>
          </div>

          <div class="help" id="metricHelp"></div>
        </div>

        <div class="modal-actions">
          <button class="btn" id="metricCancel" type="button">Cancel</button>
          <button class="btn btn-primary" id="metricSave" type="button">Save</button>
        </div>
      </div>
    </div>

  </fv-shell>

  <script type="module">
    import {
      ready,
      getFirestore, doc, getDoc, updateDoc,
      getAuth, onAuthStateChanged,
      collection, addDoc, serverTimestamp
    } from '/Farm-vista/js/firebase-init.js';

    const $ = id => document.getElementById(id);

    // --- Query params
    const qs  = new URLSearchParams(location.search);
    const id  = qs.get('id')   || '';
    const from = (qs.get('from') || '').toLowerCase();
    console.info('[hub] start; id=', id, 'from=', from);

    const HUB_CONFIG = {
      tractor: {
        display: 'Tractor',
        metricFields: [
          { key:'engineHours', label:'Engine Hours', suffix:'hrs', step:'0.1' }
        ],
        updateLabel: 'Update Engine Hours',
        hasPreSeason: true
      },
      combine: {
        display: 'Combine',
        metricFields: [
          { key:'engineHours',    label:'Engine Hours',    suffix:'hrs', step:'0.1' },
          { key:'separatorHours', label:'Separator Hours', suffix:'hrs', step:'0.1' }
        ],
        updateLabel: 'Update Hours',
        hasPreSeason: true
      },
      sprayer: {
        display: 'Sprayer',
        metricFields: [
          { key:'engineHours', label:'Engine Hours', suffix:'hrs', step:'0.1' }
        ],
        updateLabel: 'Update Engine Hours',
        hasPreSeason: true
      },
      fertilizer: {
        display: 'Fertilizer Equipment',
        metricFields: [
          { key:'engineHours', label:'Engine Hours', suffix:'hrs', step:'0.1' }
        ],
        updateLabel: 'Update Engine Hours',
        hasPreSeason: true
      },
      construction: {
        display: 'Construction',
        metricFields: [
          { key:'engineHours', label:'Engine Hours', suffix:'hrs', step:'0.1' }
        ],
        updateLabel: 'Update Engine Hours',
        hasPreSeason: false
      },
      truck: {
        display: 'Truck',
        metricFields: [
          { key:'odometerMiles', label:'Odometer (miles)', suffix:'mi', step:'1' },
          { key:'engineHours',   label:'Engine Hours',     suffix:'hrs', step:'0.1' }
        ],
        updateLabel: 'Update Mileage / Hours',
        hasPreSeason: false
      },
      trailer: {
        display: 'Trailer',
        metricFields: [],
        updateLabel: '',
        hasPreSeason: false
      },
      implement: {
        display: 'Implement',
        metricFields: [],
        updateLabel: 'Update Planter Usage',
        hasPreSeason: false
      },
      starfire: {
        display: 'StarFire',
        metricFields: [],
        updateLabel: 'Update Location',
        hasPreSeason: false
      },
      technology: {
        display: 'Technology',
        metricFields: [],
        updateLabel: '',
        hasPreSeason: false
      },
      equipment: {
        display: 'Equipment',
        metricFields: [],
        updateLabel: '',
        hasPreSeason: false
      }
    };

    const FROM_MAP = {
      tractors: { label: 'Return to Tractors', href: '/Farm-vista/pages/equipment/equipment-tractors.html' },
      combines: { label: 'Return to Combines', href: '/Farm-vista/pages/equipment/equipment-combines.html' },
      trucks:   { label: 'Return to Trucks', href: '/Farm-vista/pages/equipment/equipment-trucks.html' },
      trailers: { label: 'Return to Trailers', href: '/Farm-vista/pages/equipment/equipment-trailers.html' },
      implements:{ label:'Return to Implements', href:'/Farm-vista/pages/equipment/equipment-implements.html' },
      sprayers: { label: 'Return to Sprayers', href: '/Farm-vista/pages/equipment/equipment-sprayers.html' },
      construction:{ label:'Return to Construction Equipment', href:'/Farm-vista/pages/equipment/equipment-construction.html' },
      starfire: { label: 'Return to StarFire', href: '/Farm-vista/pages/equipment/equipment-starfire.html' },
      lookup:   { label: 'Return to Equipment', href: '/Farm-vista/pages/equipment/actions/lookup.html' },
      scanner:  { label: 'Return to Scanner', href: '/Farm-vista/pages/qr-scan.html' }
    };

    const last6 = v => String(v || '').slice(-6);
    const setText = (id, val, opts = {}) => {
      const el = $(id); if(!el) return;
      if(!val){
        if(opts.hideIfEmpty) el.hidden = true;
        else el.textContent = '';
        return;
      }
      el.textContent = val;
      if(opts.unhide) el.hidden = false;
    };
    function showContent(){ $('content').hidden = false; }

    function setupReturnButtons(typeKey){
      const btnOrigin = $('btnReturnOrigin');
      const btnHome   = $('btnReturnHome');
      const wrap      = $('returnActions');
      if(!btnOrigin || !btnHome || !wrap) return;

      let cfg = null;

      if(from && FROM_MAP[from]) {
        cfg = FROM_MAP[from];
      } else {
        switch(typeKey){
          case 'tractor':   cfg = FROM_MAP.tractors; break;
          case 'combine':   cfg = FROM_MAP.combines; break;
          case 'truck':     cfg = FROM_MAP.trucks; break;
          case 'trailer':   cfg = FROM_MAP.trailers; break;
          case 'implement': cfg = FROM_MAP.implements; break;
          case 'sprayer':   cfg = FROM_MAP.sprayers; break;
          case 'construction': cfg = FROM_MAP.construction; break;
          case 'starfire':  cfg = FROM_MAP.starfire; break;
          default: cfg = FROM_MAP.lookup; break;
        }
      }

      if(cfg){
        btnOrigin.textContent = cfg.label;
        btnOrigin.href        = cfg.href;
        btnOrigin.hidden      = false;
      }else{
        btnOrigin.hidden = true;
      }

      btnHome.href   = '/Farm-vista/index.html';
      btnHome.hidden = false;
      wrap.hidden    = false;
    }

    // ===== Metric Modal Logic =====
    const MODAL = {
      open: false,
      doc: null,
      cfg: null,
      typeKey: null,
      db: null,
      snapRef: null,
      fields: [],
      lastInputs: null
    };

    function showBanner(msg){
      const b = $('metricBanner');
      if(!b) return;
      if(!msg){ b.textContent=''; b.dataset.show='0'; return; }
      b.textContent = msg;
      b.dataset.show='1';
    }

    function openModal(){
      const back = $('metricModal');
      if(!back) return;
      back.dataset.open = '1';
      back.setAttribute('aria-hidden','false');
      MODAL.open = true;
      showBanner('');
      $('adjustBlock').hidden = true;
      $('adjustReason').value = '';
      document.body.style.overflow = 'hidden';
    }

    function closeModal(){
      const back = $('metricModal');
      if(!back) return;
      back.dataset.open = '0';
      back.setAttribute('aria-hidden','true');
      MODAL.open = false;
      document.body.style.overflow = '';
      showBanner('');
      $('adjustBlock').hidden = true;
      $('adjustReason').value = '';
    }

    function fmtNum(v){
      if(v == null || v === '') return '';
      const n = Number(v);
      if(Number.isNaN(n)) return '';
      if(Math.abs(n - Math.round(n)) < 1e-9) return String(Math.round(n));
      return String(n);
    }

    function buildMetricForm(docData, cfg){
      const form = $('metricForm');
      const help = $('metricHelp');
      if(!form || !help) return;

      form.innerHTML = '';
      const fields = Array.isArray(cfg.metricFields) ? cfg.metricFields : [];
      MODAL.fields = fields;

      const rows = [];
      for (const f of fields){
        const current = docData?.[f.key];
        const label = f.label || f.key;
        const suffix = f.suffix || '';
        const step = f.step || '1';

        const el = document.createElement('div');
        el.className = 'field';
        el.innerHTML = `
          <div class="label">${label}</div>
          <input
            class="input"
            inputmode="decimal"
            autocomplete="off"
            spellcheck="false"
            id="metric_${f.key}"
            type="number"
            step="${String(step).replace(/"/g,'')}"
            placeholder="Enter new ${label.toLowerCase()}"
          />
          <div class="input-hint" id="hint_metric_${f.key}"></div>
          <div class="help">Current: <b>${fmtNum(current) || '‚Äî'}</b>${suffix ? ` ${suffix}` : ''}. New value cannot be less than current.</div>
        `;
        rows.push(el);
      }

      for(let i=0;i<rows.length;i+=2){
        const row = document.createElement('div');
        row.className = 'row';
        row.appendChild(rows[i]);
        if(rows[i+1]) row.appendChild(rows[i+1]);
        form.appendChild(row);
      }

      if(fields.length === 0){
        const empty = document.createElement('div');
        empty.className = 'card';
        empty.style.padding = '12px';
        empty.innerHTML = `
          <div style="font-weight:950;">No usage metric configured</div>
          <div class="small-note">This equipment doesn‚Äôt have hours/mileage/acres tracking enabled.</div>
        `;
        form.appendChild(empty);
      }

      const overrideKey = 'equipment-metrics:override';
      help.innerHTML = `
        <div class="small-note">
          Rules:
          <b>No reductions allowed</b> (prevents rollback).
          If something truly needs to go down (meter replaced, typo), use the <b>Adjustment Request</b>.
          ${ (window.FV && typeof window.FV.can === 'function')
              ? `If you have special permission (<code>${overrideKey}</code>), an office user can override decreases with a reason.`
              : ``
          }
        </div>
      `;

      for (const f of fields){
        const inp = $(`metric_${f.key}`);
        if(inp) inp.value = '';
        const hint = $(`hint_metric_${f.key}`);
        if(hint){
          hint.textContent = '';
          hint.dataset.show = '0';
        }
      }
    }

    function toNum(v){
      const n = Number(String(v ?? '').trim());
      return Number.isFinite(n) ? n : null;
    }

    function clearInputError(key){
      const el = $(`metric_${key}`);
      const hint = $(`hint_metric_${key}`);
      if(el) el.classList.remove('input-error');
      if(hint){
        hint.textContent = '';
        hint.dataset.show = '0';
      }
    }

    function setInputError(key, msg){
      const el = $(`metric_${key}`);
      const hint = $(`hint_metric_${key}`);
      if(el) el.classList.add('input-error');
      if(hint){
        hint.textContent = msg || 'Invalid value.';
        hint.dataset.show = '1';
      }
    }

    // Combine-only: separator cannot exceed engine (live guard + red hint)
    function wireCombineModalGuard(){
      const engEl = $('metric_engineHours');
      const sepEl = $('metric_separatorHours');
      if(!engEl || !sepEl) return;

      const msg = 'Separator Hours cannot be greater than Engine Hours.';

      function validateAndGuard(){
        clearInputError('separatorHours');

        const eng = toNum(engEl.value);
        const sep = toNum(sepEl.value);

        // If either is blank, don‚Äôt yell.
        if(eng == null || sep == null) return;

        if(sep > eng){
          // Auto-fix so operators can‚Äôt swap values and save bad data
          sepEl.value = String(eng);

          // Show red + subtle message
          setInputError('separatorHours', msg);

          // Fade the hint after a moment (still prevents bad value)
          setTimeout(()=>{ clearInputError('separatorHours'); }, 2200);
        }
      }

      engEl.addEventListener('input', validateAndGuard);
      sepEl.addEventListener('input', validateAndGuard);
      engEl.addEventListener('change', validateAndGuard);
      sepEl.addEventListener('change', validateAndGuard);
    }

    function getCurrentValue(docData, key){
      const v = docData?.[key];
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    }

    function readInputs(){
      const out = {};
      for(const f of (MODAL.fields||[])){
        const el = $(`metric_${f.key}`);
        const raw = el ? String(el.value ?? '').trim() : '';
        if(raw === '') continue;
        const n = Number(raw);
        out[f.key] = Number.isFinite(n) ? n : NaN;
      }
      return out;
    }

    function hasAnyInput(inputs){
      return inputs && Object.keys(inputs).length > 0;
    }

    function computeValidation(docData, inputs){
      const results = {
        ok: true,
        anyDecrease: false,
        badNumbers: [],
        decreases: [],
        updates: {}
      };

      for(const [k,v] of Object.entries(inputs)){
        if(!Number.isFinite(v)){
          results.ok = false;
          results.badNumbers.push(k);
          continue;
        }
        const cur = getCurrentValue(docData, k);
        if(cur == null){
          results.updates[k] = v;
          continue;
        }
        if(v < cur){
          results.anyDecrease = true;
          results.decreases.push({ key:k, current:cur, next:v });
          continue;
        }
        if(v === cur) continue;
        results.updates[k] = v;
      }

      if(results.badNumbers.length) results.ok = false;
      return results;
    }

    function updateMetricChip(docData, cfg, typeKey){
      const chip = $('eqMetric');
      if(!chip) return;

      const fields = Array.isArray(cfg.metricFields) ? cfg.metricFields : [];
      if(fields.length === 0){ chip.hidden = true; return; }

      if(String(typeKey||'') === 'combine'){
        const e = docData?.engineHours;
        const s = docData?.separatorHours;
        const parts = [];
        if(e != null && e !== '') parts.push(`${fmtNum(e)} hrs eng`);
        if(s != null && s !== '') parts.push(`${fmtNum(s)} hrs sep`);
        if(parts.length){
          chip.textContent = parts.join(' ‚Ä¢ ');
          chip.hidden = false;
          return;
        }
      }

      if(String(typeKey||'') === 'implement'){
        const a = docData?.totalAcres;
        const h = docData?.totalHours;
        const parts = [];
        if(a != null && a !== '') parts.push(`${fmtNum(a)} ac`);
        if(h != null && h !== '') parts.push(`${fmtNum(h)} hrs`);
        if(parts.length){
          chip.textContent = parts.join(' ‚Ä¢ ');
          chip.hidden = false;
          return;
        }
      }

      const f0 = fields[0];
      const v0 = docData?.[f0.key];
      if(v0 != null){
        chip.textContent = `${fmtNum(v0)}${f0.suffix ? ` ${f0.suffix}` : ''}`;
        chip.hidden = false;
      }else{
        chip.hidden = true;
      }
    }

    async function saveMetrics(){
      if(!MODAL.db || !MODAL.snapRef || !MODAL.doc) return;

      const btnSave = $('metricSave');
      const btnCancel = $('metricCancel');
      if(btnSave) btnSave.disabled = true;
      if(btnCancel) btnCancel.disabled = true;
      showBanner('');

      try{
        const inputs = readInputs();
        MODAL.lastInputs = inputs;

        if(!hasAnyInput(inputs)){
          showBanner('Enter at least one new reading to save.');
          return;
        }

        // HARD backstop for combines (even if user disables JS, etc.)
        if(String(MODAL.typeKey||'') === 'combine'){
          const eng = (inputs.engineHours != null) ? Number(inputs.engineHours) : null;
          const sep = (inputs.separatorHours != null) ? Number(inputs.separatorHours) : null;
          if(Number.isFinite(eng) && Number.isFinite(sep) && sep > eng){
            setInputError('separatorHours', 'Separator Hours cannot be greater than Engine Hours.');
            showBanner('Fix: Separator Hours cannot be greater than Engine Hours.');
            return;
          }
        }

        const v = computeValidation(MODAL.doc, inputs);

        if(v.badNumbers.length){
          showBanner('One or more values are not valid numbers.');
          return;
        }

        const overrideKey = 'equipment-metrics:override';
        const canOverride = !!(window.FV && typeof window.FV.can === 'function' && window.FV.can(overrideKey));

        if(v.anyDecrease && !canOverride){
          const lines = v.decreases.map(x=>{
            const label = (MODAL.fields.find(f=>f.key===x.key)?.label) || x.key;
            return `‚Ä¢ ${label}: current ${fmtNum(x.current)} ‚Üí attempted ${fmtNum(x.next)}`;
          }).join('\n');

          showBanner(
            `Not allowed: readings cannot be reduced.\n` +
            `Use Adjustment Request (below) so an office/admin can review.\n\n` +
            `${lines}`
          );
          $('adjustBlock').hidden = false;
          return;
        }

        if(v.anyDecrease && canOverride){
          const reason = String($('adjustReason')?.value || '').trim();
          if(!reason){
            showBanner('Override requires a reason. Enter a note in the "Reason / note to office" box.');
            $('adjustBlock').hidden = false;
            return;
          }
          for(const dec of v.decreases){
            v.updates[dec.key] = dec.next;
          }
        }

        if(Object.keys(v.updates).length === 0){
          showBanner('No changes to save (new values match current).');
          return;
        }

        const auth = getAuth();
        const user = auth.currentUser || null;

        const patch = {
          ...v.updates,
          metricUpdatedAt: serverTimestamp(),
          metricUpdatedBy: user?.email || null
        };

        await updateDoc(MODAL.snapRef, patch);

        await addDoc(collection(MODAL.db, 'equipment_metric_entries'), {
          equipmentId: id,
          equipmentType: MODAL.typeKey || null,
          updatedAt: serverTimestamp(),
          updatedBy: user?.email || null,
          updates: v.updates,
          previous: Object.fromEntries(Object.keys(v.updates).map(k => [k, getCurrentValue(MODAL.doc, k)])),
          from: from || null,
          mode: (v.anyDecrease ? 'override' : 'normal')
        });

        for(const [k,val] of Object.entries(v.updates)){
          MODAL.doc[k] = val;
        }

        updateMetricChip(MODAL.doc, MODAL.cfg, MODAL.typeKey);
        showBanner('Saved.');
        setTimeout(()=>closeModal(), 220);
      }catch(e){
        console.error('[hub] saveMetrics error', e);
        showBanner('Save failed. Try again (or check connection).');
      }finally{
        if(btnSave) btnSave.disabled = false;
        if(btnCancel) btnCancel.disabled = false;
      }
    }

    async function sendAdjustmentRequest(){
      try{
        if(!MODAL.db || !MODAL.doc) return;

        const reason = String($('adjustReason')?.value || '').trim();
        if(!reason){
          showBanner('Please enter a reason so the office knows what to fix.');
          return;
        }

        const inputs = MODAL.lastInputs || readInputs();
        if(!hasAnyInput(inputs)){
          showBanner('Enter the value(s) you attempted, then send the request.');
          return;
        }

        const v = computeValidation(MODAL.doc, inputs);
        if(!v.anyDecrease){
          showBanner('This request is only needed when a value would be reduced.');
          $('adjustBlock').hidden = true;
          return;
        }

        const auth = getAuth();
        const user = auth.currentUser || null;

        await addDoc(collection(MODAL.db, 'equipment_metric_adjust_requests'), {
          equipmentId: id,
          equipmentType: MODAL.typeKey || null,
          createdAt: serverTimestamp(),
          createdBy: user?.email || null,
          status: 'open',
          reason,
          attempted: Object.fromEntries(v.decreases.map(d => [d.key, d.next])),
          current: Object.fromEntries(v.decreases.map(d => [d.key, d.current])),
          from: from || null
        });

        showBanner('Adjustment request sent. Office/admin will review.');
        setTimeout(()=>closeModal(), 380);
      }catch(e){
        console.error('[hub] sendAdjustmentRequest error', e);
        showBanner('Could not send request. Try again.');
      }
    }

    function wireModalButtons(){
      const back = $('metricModal');
      const closeBtn = $('metricModalClose');
      const cancelBtn = $('metricCancel');
      const saveBtn = $('metricSave');
      const reqBtn = $('btnRequestAdjust');
      const adjCancel = $('btnAdjustCancel');

      if(closeBtn) closeBtn.addEventListener('click', closeModal);
      if(cancelBtn) cancelBtn.addEventListener('click', closeModal);
      if(saveBtn) saveBtn.addEventListener('click', saveMetrics);

      if(reqBtn) reqBtn.addEventListener('click', sendAdjustmentRequest);
      if(adjCancel) adjCancel.addEventListener('click', ()=>{
        $('adjustBlock').hidden = true;
        showBanner('');
      });

      if(back){
        back.addEventListener('click', (e)=>{
          if(e.target === back) closeModal();
        });
      }

      window.addEventListener('keydown', (e)=>{
        if(e.key === 'Escape' && MODAL.open) closeModal();
      });
    }

    function openMetricModal(docData, cfg, typeKey, db, snapRef){
      MODAL.doc = docData;
      MODAL.cfg = cfg;
      MODAL.typeKey = typeKey;
      MODAL.db = db;
      MODAL.snapRef = snapRef;

      const title = cfg.updateLabel || 'Update Usage';
      $('metricModalTitle').textContent = title;

      buildMetricForm(docData, cfg);

      if(!Array.isArray(cfg.metricFields) || cfg.metricFields.length === 0){
        showBanner('No usage metric configured for this equipment.');
        return;
      }

      // Wire combine guard AFTER the form is built
      if(String(typeKey||'') === 'combine'){
        wireCombineModalGuard();
      }

      openModal();
    }

    const TIMEOUT_MS = 22000;
    let finished=false;
    const watchdog=setTimeout(()=>{
      if(finished) return;
      showContent();
      $('timeoutCard').hidden=false;
      $('status').textContent='Timed out waiting for data.'; $('status').hidden=false;
      console.warn('[hub] watchdog fired');
    },TIMEOUT_MS);

    async function userReady(maxMs=3000){
      const auth = getAuth();
      if (auth.currentUser) { console.info('[hub] userReady: currentUser present'); return; }
      const first = new Promise(res=>{
        const off = onAuthStateChanged(auth, (u)=>{ try{off();}catch{} res(u); }, { onlyOnce:true });
      });
      let u = await first;
      if (u) { console.info('[hub] userReady: got user from first event'); return; }
      const t0 = Date.now();
      while(!auth.currentUser && (Date.now()-t0) < maxMs){
        await new Promise(r=>setTimeout(r,120));
      }
      console.info('[hub] userReady: final user=', !!auth.currentUser);
    }

    async function getDocWithRetry(ref){
      try {
        console.info('[hub] getDoc attempt #1');
        return await getDoc(ref);
      }catch(e){
        console.warn('[hub] getDoc failed #1; retrying...', e?.code||e);
        await new Promise(r=>setTimeout(r, 600));
        console.info('[hub] getDoc attempt #2');
        return await getDoc(ref);
      }
    }

    function cloneCfg(base){
      return {
        display: base.display,
        updateLabel: base.updateLabel,
        hasPreSeason: !!base.hasPreSeason,
        metricFields: Array.isArray(base.metricFields) ? base.metricFields.slice() : []
      };
    }

    function resolveEffectiveCfg(typeKey, d){
      const base = HUB_CONFIG[typeKey] || HUB_CONFIG.equipment;
      const cfg = cloneCfg(base);

      if(typeKey === 'implement'){
        const it = String(d.implementType || '').toLowerCase();
        if(it === 'planter'){
          cfg.display = 'Planter';
          cfg.updateLabel = 'Update Planter Acres / Hours';
          cfg.metricFields = [
            { key:'totalAcres', label:'Total Acres', suffix:'ac', step:'1' },
            { key:'totalHours', label:'Total Hours', suffix:'hrs', step:'0.1' }
          ];
        }else{
          cfg.metricFields = [];
          cfg.updateLabel = '';
        }
      }

      if(typeKey === 'construction'){
        const ct = String(d.constructionType || '').toLowerCase();
        if(ct && ct !== 'machine'){
          cfg.metricFields = [];
          cfg.updateLabel = '';
        }
      }

      if(!cfg.metricFields || cfg.metricFields.length === 0){
        cfg.updateLabel = '';
      }

      return cfg;
    }

    let runId = 0;
    async function init(){
      const my = ++runId;
      await ready;
      await userReady();
      if (my !== runId) return;

      if(!id){
        clearTimeout(watchdog); finished=true; showContent();
        $('status').textContent='No equipment id provided.'; $('status').hidden=false;
        console.warn('[hub] no id');
        return;
      }

      const db=getFirestore();
      let snap;
      let ref;
      try{
        ref = doc(db,'equipment',id);
        snap = await getDocWithRetry(ref);
      }catch(e){
        console.error('[hub] getDoc error', e);
        clearTimeout(watchdog); finished=true; showContent();
        $('status').textContent='Error loading hub.'; $('status').hidden=false;
        return;
      }
      if (my !== runId) return;

      clearTimeout(watchdog); finished=true; showContent();

      if(!snap.exists()){
        $('status').textContent='Not found.'; $('status').hidden=false;
        console.warn('[hub] snap not exists for id', id);
        return;
      }

      const d = snap.data() || {}; d.id = id;
      const typeKey = String(d.type || 'equipment').toLowerCase();
      const cfg = resolveEffectiveCfg(typeKey, d);

      console.info('[hub] loaded doc', { id, type:d.type, make:d.makeName, model:d.modelName });

      const hubTitle = `${cfg.display} Hub`;
      setText('pageTitle', hubTitle);
      document.title = `FarmVista ‚Ä¢ ${hubTitle}`;

      const mm = [d.makeName, d.modelName].filter(Boolean).join(' ');
      const ls = last6(d.serial);
      const title = mm ? `${mm}${ls ? ` (#${ls})` : ''}` : (d.name || `Unit ${id.slice(0,6)}`);
      setText('eqName', title);

      if(ls){
        setText('eqSerial', `SN #${ls}`, { unhide:true });
      }

      updateMetricChip(d, cfg, typeKey);

      $('eqCard').hidden = false;

      const calcCard = $('combineCalcs');

      const isArchived = (String(d.status||'').toLowerCase() === 'archived') || (d.archived === true);
      if(isArchived){
        const name = mm || 'This unit';
        $('archivedMsg').textContent = `‚Äú${name}${ls ? ' ‚Ä¢ SN ‚Ä¶'+ls : ''}‚Äù is archived and not available for new entries.`;
        $('archivedCard').hidden = false;
        if (calcCard) calcCard.hidden = true;
      }else{
        setText('linkReq', 'Submit Service Request');
        $('linkReq').hidden = false;

        if(Array.isArray(cfg.metricFields) && cfg.metricFields.length > 0 && cfg.updateLabel){
          setText('linkMetric', cfg.updateLabel);
          $('linkMetric').hidden = false;
        }else{
          $('linkMetric').hidden = true;
        }

        $('linkMaint').hidden = false;
        $('linkPre').hidden   = !cfg.hasPreSeason;

        $('linkReq').href =
          `/Farm-vista/pages/equipment/actions/service-request.html?id=${encodeURIComponent(id)}${from ? `&from=${encodeURIComponent(from)}` : ''}`;

        $('linkMaint').href  = '#';
        $('linkPre').href    = '#';

        if(!$('linkMetric').hidden){
          $('linkMetric').href = '#';
          $('linkMetric').onclick = (e)=>{
            e.preventDefault();
            openMetricModal(d, cfg, typeKey, db, ref);
          };
        }else{
          $('linkMetric').onclick = null;
        }

        if(typeKey === 'starfire'){
          setText('linkMetric', 'Update Location');
          $('linkMetric').hidden = false;
          $('linkMetric').href =
            `/Farm-vista/pages/equipment/actions/starfire-location.html?id=${encodeURIComponent(id)}`;
          $('linkMetric').onclick = null;

          $('linkMaint').hidden = true;
          $('linkPre').hidden   = true;

          if (calcCard) calcCard.hidden = true;
        } else {
          if (typeKey === 'combine' && calcCard) {
            const lossLink   = $('linkCalcLoss');
            const checkLink  = $('linkCalcYieldCheck');
            const calibLink  = $('linkCalcYieldCal');
            const basePath   = '/Farm-vista/pages/calculators';

            if (lossLink)  lossLink.href  = `${basePath}/calc-combine-grain-loss.html?equipmentId=${encodeURIComponent(id)}`;
            if (checkLink) checkLink.href = `${basePath}/calc-combine-yield.html?equipmentId=${encodeURIComponent(id)}`;
            if (calibLink) calibLink.href = `${basePath}/calc-combine-yield-calibration.html?equipmentId=${encodeURIComponent(id)}`;

            calcCard.hidden = false;
          } else if (calcCard) {
            calcCard.hidden = true;
          }
        }

        $('fnLinks').hidden = false;
      }

      setupReturnButtons(typeKey);
    }

    wireModalButtons();

    init().catch(e=>{
      console.error('[hub] init fatal', e);
      clearTimeout(watchdog); finished=true; showContent();
      $('status').textContent='Error loading hub.'; $('status').hidden=false;
    });

    window.addEventListener('pageshow', (e)=>{ if(e.persisted) init(); });
    document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') init(); });
  </script>
</body>
</html>
