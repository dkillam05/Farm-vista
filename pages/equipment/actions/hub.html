<!-- =====================================================================
/Farm-vista/pages/equipment/equipment-hub.html  (FULL FILE REPLACEMENT)
Rev: 2025-12-18f
Updates:
 ‚Ä¢ Removed Pre-Season button + all JS refs
 ‚Ä¢ Service Record LIST tags now: Status + Item Count only
 ‚Ä¢ Detail header grid now: Status / Created / Updated / Completed only
 ‚Ä¢ Line items are collapsed by default; tap to expand
 ‚Ä¢ Print Summary / Print Detailed unchanged
 ‚Ä¢ Green buttons always white text (no black on green)
 ‚Ä¢ Keeps module script safe from early termination
===================================================================== -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista ‚Ä¢ Equipment Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>

  <!-- Connection warmups -->
  <link rel="preconnect" href="https://firestore.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://www.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>

  <!-- Theme + app CSS -->
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <!-- IMPORTANT: match tractors ‚Äî load Firebase CONFIG first -->
  <script src="/Farm-vista/js/firebase-config.js"></script>

  <!-- Cloud PDF helper (if present) -->
  <script src="/Farm-vista/js/fv-pdf.js"></script>

  <!-- Ensure fv-shell -->
  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true; document.head.appendChild(s);
      }
    })();
  </script>

  <style>
    :root{ --card-max:900px; --brand:var(--green,#3B7E46); }
    body{ background:var(--app-bg,var(--surface)); margin:0; }

    /* kill blue links in dark mode */
    .wrap, .wrap * { -webkit-tap-highlight-color: transparent; }
    .wrap a, .wrap a:visited, .wrap a:active, .wrap a:hover { color:inherit; text-decoration:none; }

    /* ‚úÖ GLOBAL OVERRIDE: NO BLACK TEXT ON GREEN */
    .btn-primary{ color:#fff !important; }

    .btn { color:var(--ink-1,#0f1a13); }
    :root[data-theme="dark"] .btn { color:var(--ink-1,#eaece9); }

    .wrap{
      max-width:var(--card-max);
      margin:0 auto;
      padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px)+72px)!important;
    }
    .hero{
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));
      overflow:hidden;
      margin:8px 0 18px;
    }
    .hero-head{
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      background:color-mix(in srgb,var(--brand) 12%, transparent);
    }
    .hero-head h1{ margin:0; font-size:clamp(20px,3.2vw,26px); }
    .muted{ color:var(--muted,#67706B) }
    .body{ padding:16px; display:grid; gap:18px }
    .card{
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--surface);
      padding:14px;
      display:grid;
      gap:8px
    }
    .meta{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .chip{
      font-size:12px;
      border:1px solid var(--border);
      border-radius:999px;
      padding:6px 10px;
      background:var(--surface)
    }
    .actions{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px
    }
    @media (max-width:640px){
      .actions{ grid-template-columns:1fr }
    }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-height:52px;
      font-weight:800;
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--card-surface,var(--surface));
      text-decoration:none;
      cursor:pointer;
      user-select:none;
    }
    .btn-primary{
      background:var(--brand);
      border-color:transparent
    }

    .actions-return{ margin-top:26px; }

    .state{
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--surface);
      padding:22px;
      display:grid;
      gap:12px;
      justify-items:center;
      text-align:center;
    }
    .state .emo{ font-size:44px; line-height:1; filter:grayscale(.05); }
    .state h2{ margin:0; font-size:20px; font-weight:900; }
    .state p{ margin:0; color:var(--muted,#67706B); max-width:520px; }
    [hidden]{ display:none !important; }

    /* ===== Modal shared ===== */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + 14px);
      z-index:9999;
    }
    .modal-backdrop[data-open="1"]{ display:flex; }

    .modal{
      width:min(720px, 100%);
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow:0 22px 60px rgba(0,0,0,.22);
      overflow:hidden;
    }
    .modal-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:14px 14px;
      border-bottom:1px solid var(--border);
      background:color-mix(in srgb,var(--brand) 10%, transparent);
    }
    .modal-head h3{
      margin:0;
      font-size:16px;
      font-weight:950;
      letter-spacing:.2px;
    }
    .icon-btn{
      appearance:none;
      border:1px solid var(--border);
      background:var(--surface);
      border-radius:12px;
      height:40px;
      width:40px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
    }
    .icon-btn svg{ width:18px; height:18px; }

    .modal-body{
      padding:14px;
      display:grid;
      gap:12px;
    }
    .modal-actions{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      padding:14px;
      border-top:1px solid var(--border);
      background:color-mix(in srgb, var(--surface) 70%, transparent);
    }
    @media (max-width:560px){ .modal-actions{ grid-template-columns:1fr; } }

    .banner{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 12px;
      background:color-mix(in srgb, #b51f1f 10%, transparent);
      color:var(--ink-1,#0f1a13);
      font-size:13px;
      line-height:1.3;
      display:none;
      white-space:pre-line;
    }
    :root[data-theme="dark"] .banner{ color:var(--ink-1,#eaece9); }
    .banner[data-show="1"]{ display:block; }

    .btn-danger{
      background:color-mix(in srgb, #b51f1f 14%, var(--surface));
      border-color:color-mix(in srgb, #b51f1f 30%, var(--border));
    }
    .small-note{ font-size:12px; color:var(--muted,#67706B); line-height:1.25; }

    /* ===== Metric Modal (existing) ===== */
    .form-grid{ display:grid; gap:10px; }
    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width:560px){ .row{ grid-template-columns:1fr; } }
    .field{ display:grid; gap:6px; }
    .label{
      font-size:12px;
      font-weight:850;
      color:var(--ink-2, #2a332d);
    }
    :root[data-theme="dark"] .label{ color:var(--ink-2, #d7dbd8); }
    .help{ font-size:12px; color:var(--muted,#67706B); line-height:1.25; }
    .input{
      width:100%;
      min-height:46px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--card-surface,var(--surface));
      padding:10px 12px;
      font-size:16px;
      font-weight:800;
      color:var(--ink-1,#0f1a13);
      outline:none;
    }
    :root[data-theme="dark"] .input{ color:var(--ink-1,#eaece9); }

    .textarea{
      width:100%;
      min-height:88px;
      resize:vertical;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--card-surface,var(--surface));
      padding:10px 12px;
      font-size:14px;
      color:var(--ink-1,#0f1a13);
      outline:none;
    }
    :root[data-theme="dark"] .textarea{ color:var(--ink-1,#eaece9); }

    .input-error{
      border-color:#b51f1f !important;
      box-shadow:0 0 0 2px rgba(181,31,31,.18);
    }
    .hint{ font-size:12px; line-height:1.25; color:var(--muted,#67706B); margin-top:2px; }
    .hint.error{ color:#b51f1f; font-weight:850; }

    /* ===== Service Records Modal ===== */
    #srModalBody{
      max-height: min(70vh, 640px);
      overflow:auto;
      -webkit-overflow-scrolling:touch;
    }

    .sr-view{ display:none; }
    .sr-view[data-show="1"]{ display:block; }

    .sr-list{ display:grid; gap:10px; }
    .sr-item{
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--surface);
      padding:12px;
      display:grid;
      gap:8px;
      cursor:pointer;
      user-select:none;
      transition:transform .06s, box-shadow .12s, border-color .12s;
    }
    .sr-item:active{ transform:scale(.996); }
    .sr-item[aria-selected="true"]{
      border-color: color-mix(in srgb, var(--brand) 42%, var(--border));
      box-shadow: 0 10px 26px rgba(0,0,0,.10);
      background: color-mix(in srgb, var(--brand) 6%, var(--surface));
    }

    .sr-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }
    .sr-title{
      font-weight:950;
      font-size:14px;
      line-height:1.15;
      margin:0;
    }
    .sr-sub{
      font-size:12px;
      color:var(--muted,#67706B);
      margin:0;
      line-height:1.25;
    }
    .sr-tags{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .sr-tag{
      font-size:12px;
      border:1px solid var(--border);
      border-radius:999px;
      padding:5px 10px;
      background:var(--surface);
      white-space:nowrap;
    }
    .sr-notes{
      font-size:13px;
      color:var(--ink-1,#0f1a13);
      line-height:1.35;
      white-space:pre-wrap;
      margin:0;
    }
    :root[data-theme="dark"] .sr-notes{ color:var(--ink-1,#eaece9); }
    .sr-empty{
      border:1px dashed var(--border);
      border-radius:12px;
      padding:14px;
      text-align:center;
      color:var(--muted,#67706B);
      background:color-mix(in srgb, var(--surface) 70%, transparent);
    }

    /* ===== SR Detail View (inside modal) ===== */
    .sr-detail-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 10px 8px;
      border:1px solid var(--border);
      border-radius:12px;
      background:color-mix(in srgb, var(--brand) 6%, var(--surface));
    }
    .sr-back{
      min-height:42px;
      padding:8px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--surface);
      font-weight:900;
      cursor:pointer;
      color:var(--ink-1,#0f1a13);
    }
    :root[data-theme="dark"] .sr-back{ color:var(--ink-1,#eaece9); }
    .sr-detail-title{
      font-weight:950;
      font-size:14px;
      line-height:1.15;
      margin:0;
    }
    .sr-detail-sub{
      margin:2px 0 0;
      font-size:12px;
      color:var(--muted,#67706B);
      line-height:1.2;
    }

    .sr-detail-grid{
      margin-top:10px;
      display:grid;
      grid-template-columns:repeat(2, minmax(0, 1fr));
      gap:10px;
    }
    @media (max-width:560px){
      .sr-detail-grid{ grid-template-columns:1fr; }
    }
    .sr-pair{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 10px 9px;
      background:var(--surface);
    }
    .sr-k{ font-size:11px; text-transform:uppercase; letter-spacing:.10em; opacity:.75; font-weight:950; }
    .sr-v{ margin-top:3px; font-size:13px; font-weight:800; line-height:1.25; word-break:break-word; }

    .sr-block{
      margin-top:10px;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 10px 9px;
      background:var(--surface);
    }
    .sr-block h4{
      margin:0 0 6px;
      font-size:12px;
      letter-spacing:.10em;
      text-transform:uppercase;
      font-weight:950;
      opacity:.85;
    }
    .sr-block .txt{
      font-size:13px;
      white-space:pre-wrap;
      line-height:1.35;
    }

    .sr-li-list{ display:grid; gap:10px; margin-top:8px; }
    .sr-li{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 10px 9px;
      background:linear-gradient(135deg, rgba(59,126,70,0.05), var(--surface));
    }
    .sr-li-top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      padding-bottom:7px;
      border-bottom:1px solid color-mix(in srgb, var(--border) 60%, transparent);
      margin-bottom:8px;
    }
    .sr-li-title{ font-weight:950; font-size:13px; line-height:1.25; }
    .sr-li-badge{
      font-size:11px;
      font-weight:950;
      letter-spacing:.08em;
      text-transform:uppercase;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(59,126,70,0.28);
      background:rgba(59,126,70,0.07);
      white-space:nowrap;
    }
    .sr-li-badge.open{
      border-color: rgba(234,179,8,0.35);
      background: rgba(234,179,8,0.10);
    }

    .sr-li-grid{
      display:grid;
      grid-template-columns:repeat(2, minmax(0,1fr));
      gap:10px;
      font-size:13px;
    }
    @media (max-width:560px){
      .sr-li-grid{ grid-template-columns:1fr; }
    }
    .sr-li-notes{
      grid-column:1/-1;
      margin-top:8px;
      padding-top:8px;
      border-top:1px dashed color-mix(in srgb, var(--border) 65%, transparent);
      white-space:pre-wrap;
      line-height:1.35;
    }

    /* ===== Collapsible Line Items ===== */
    .sr-li{ cursor:pointer; }
    .sr-li-top{ margin-bottom:0; border-bottom:none; padding-bottom:0; }

    .sr-li-body{
      display:none;
      margin-top:8px;
    }
    .sr-li[data-open="1"] .sr-li-body{ display:block; }

    .sr-li-title{
      display:flex;
      align-items:center;
      gap:8px;
      min-width:0;
    }
    .sr-li-title .sr-li-text{
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .sr-li-chev{
      opacity:.7;
      font-weight:950;
      user-select:none;
    }
  </style>
</head>

<body>
  <fv-shell>
    <div class="wrap" id="content" hidden>
      <section class="hero">
        <header class="hero-head">
          <h1 id="pageTitle">Equipment Hub</h1>
          <p class="muted" id="status" hidden></p>
        </header>

        <div class="body">
          <div class="card" id="eqCard" hidden>
            <h2 id="eqName" style="margin:0"></h2>
            <div class="meta">
              <span id="eqSerial" class="chip" hidden></span>
              <span id="eqMetric" class="chip" hidden></span>
            </div>
          </div>

          <div class="actions" id="fnLinks" hidden>
            <a id="linkReq"    class="btn" href="#">Submit Service Request</a>
            <a id="linkMetric" class="btn" href="#">Update Usage</a>
            <a id="linkMaint"  class="btn" href="#">Service Records</a>
          </div>

          <div class="card" id="combineCalcs" hidden>
            <div>
              <h3 style="margin:0 0 4px;font-size:16px;font-weight:800;">Calculators</h3>
              <p class="muted" style="margin:0 0 8px;font-size:13px;">
                Quick access to grain loss, yield checks, and yield calibration for this combine.
              </p>
            </div>
            <div class="actions">
              <a id="linkCalcLoss"        class="btn" href="#">Combine Grain Loss</a>
              <a id="linkCalcYieldCheck"  class="btn" href="#">Combine Yield Check</a>
              <a id="linkCalcYieldCal"    class="btn" href="#">Combine Yield Calibration</a>
            </div>
          </div>

          <div id="archivedCard" class="state" hidden>
            <div class="emo">üì¶</div>
            <h2>This equipment is archived</h2>
            <p id="archivedMsg">This item isn‚Äôt available for new entries at this time.</p>
            <div class="actions">
              <a class="btn btn-primary" href="/Farm-vista/pages/qr-scan.html">Rescan</a>
            </div>
          </div>

          <div id="timeoutCard" class="state" hidden>
            <div class="emo">‚è±Ô∏è</div>
            <h2>Timed out</h2>
            <p>It‚Äôs taking longer than expected to load this equipment.</p>
            <div class="actions">
              <a class="btn btn-primary" href="/Farm-vista/pages/qr-scan.html">Rescan</a>
              <a class="btn" href="/Farm-vista/index.html">Return to Home</a>
            </div>
          </div>

          <div class="actions actions-return" id="returnActions">
            <a id="btnReturnOrigin" class="btn" href="#">Return</a>
            <a id="btnReturnHome"   class="btn" href="/Farm-vista/index.html">Return to Home</a>
          </div>
        </div>
      </section>
    </div>

    <!-- ===== Metric Modal ===== -->
    <div class="modal-backdrop" id="metricModal" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="metricModalTitle">
        <div class="modal-head">
          <h3 id="metricModalTitle">Update Usage</h3>
          <button class="icon-btn" id="metricModalClose" type="button" aria-label="Close">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
              <path d="M18 6L6 18"></path><path d="M6 6l12 12"></path>
            </svg>
          </button>
        </div>

        <div class="modal-body">
          <div class="banner" id="metricBanner"></div>
          <div class="form-grid" id="metricForm"></div>

          <div id="adjustBlock" hidden>
            <div class="card" style="padding:12px; gap:10px">
              <div style="display:grid; gap:6px">
                <div style="font-weight:950;">Request permissioned adjustment</div>
                <div class="small-note">
                  If a number needs to go DOWN (or was entered wrong), you must request an adjustment.
                  This sends a request to the office/admin queue.
                </div>
              </div>
              <div class="field">
                <div class="label">Reason / note to office</div>
                <textarea class="textarea" id="adjustReason" placeholder="Explain what happened (typo, meter replaced, etc.)"></textarea>
              </div>
              <div class="actions" style="grid-template-columns:1fr 1fr; gap:10px">
                <button class="btn btn-danger" id="btnRequestAdjust" type="button">Send Adjustment Request</button>
                <button class="btn" id="btnAdjustCancel" type="button">Cancel Request</button>
              </div>
            </div>
          </div>

          <div class="help" id="metricHelp"></div>
        </div>

        <div class="modal-actions">
          <button class="btn" id="metricCancel" type="button">Cancel</button>
          <button class="btn btn-primary" id="metricSave" type="button">Save</button>
        </div>
      </div>
    </div>

    <!-- ===== Service Records Modal ===== -->
    <div class="modal-backdrop" id="srModal" aria-hidden="true">
      <div class="modal" role="dialog" aria-modal="true" aria-labelledby="srTitle">
        <div class="modal-head">
          <h3 id="srTitle">Service Records</h3>
          <button class="icon-btn" id="srClose" type="button" aria-label="Close">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
              <path d="M18 6L6 18"></path><path d="M6 6l12 12"></path>
            </svg>
          </button>
        </div>

        <div class="modal-body" id="srModalBody">
          <div class="banner" id="srBanner"></div>

          <!-- LIST VIEW -->
          <div class="sr-view" id="srListView" data-show="1">
            <div class="sr-list" id="srList"></div>
          </div>

          <!-- DETAIL VIEW -->
          <div class="sr-view" id="srDetailView" data-show="0" aria-live="polite">
            <div class="sr-detail-head">
              <button class="sr-back" id="srBackBtn" type="button">‚Üê Back</button>
              <div style="min-width:0; flex:1 1 auto;">
                <div class="sr-detail-title" id="srDetailTitle">Work Order Summary</div>
                <div class="sr-detail-sub" id="srDetailSub">Tap a record to view details.</div>
              </div>
              <div class="sr-tags" style="justify-content:flex-end">
                <span class="sr-tag" id="srDetailStatusTag" hidden></span>
              </div>
            </div>

            <div class="sr-detail-grid" id="srDetailGrid"></div>

            <div class="sr-block" id="srDetailNotesBlock" hidden>
              <h4 id="srDetailNotesLabel">Summary Notes</h4>
              <div class="txt" id="srDetailNotesTxt"></div>
            </div>

            <div class="sr-block" id="srDetailLineItemsBlock" hidden>
              <h4>Line Items</h4>
              <div class="sr-li-list" id="srDetailLineItems"></div>
            </div>
          </div>
        </div>

        <div class="modal-actions">
          <button class="btn" id="srPrintSummary" type="button">Print Summary</button>
          <button class="btn btn-primary" id="srPrintDetailed" type="button">Print Detailed</button>
        </div>
      </div>
    </div>

  </fv-shell>

  <script type="module">
    import {
      ready,
      getFirestore, doc, getDoc, updateDoc,
      getAuth, onAuthStateChanged,
      collection, addDoc, serverTimestamp,
      getDocs, query, where, limit
    } from '/Farm-vista/js/firebase-init.js';

    const $ = id => document.getElementById(id);

    const qs  = new URLSearchParams(location.search);
    const id  = qs.get('id')   || '';
    const from = (qs.get('from') || '').toLowerCase();
    console.info('[hub] start; id=', id, 'from=', from);

    const HUB_CONFIG = {
      tractor: {
        display: 'Tractor',
        metricFields: [{ key:'engineHours', label:'Engine Hours', suffix:'hrs', step:'0.1' }],
        updateLabel: 'Update Engine Hours',
        hasPreSeason: true
      },
      combine: {
        display: 'Combine',
        metricFields: [
          { key:'engineHours',    label:'Engine Hours',    suffix:'hrs', step:'0.1' },
          { key:'separatorHours', label:'Separator Hours', suffix:'hrs', step:'0.1' }
        ],
        updateLabel: 'Update Hours',
        hasPreSeason: true
      },
      sprayer: {
        display: 'Sprayer',
        metricFields: [{ key:'engineHours', label:'Engine Hours', suffix:'hrs', step:'0.1' }],
        updateLabel: 'Update Engine Hours',
        hasPreSeason: true
      },
      fertilizer: {
        display: 'Fertilizer Equipment',
        metricFields: [{ key:'engineHours', label:'Engine Hours', suffix:'hrs', step:'0.1' }],
        updateLabel: 'Update Engine Hours',
        hasPreSeason: true
      },
      construction: {
        display: 'Construction',
        metricFields: [{ key:'engineHours', label:'Engine Hours', suffix:'hrs', step:'0.1' }],
        updateLabel: 'Update Engine Hours',
        hasPreSeason: false
      },
      truck: {
        display: 'Truck',
        metricFields: [
          { key:'odometerMiles', label:'Odometer (miles)', suffix:'mi', step:'1' },
          { key:'engineHours',   label:'Engine Hours',     suffix:'hrs', step:'0.1' }
        ],
        updateLabel: 'Update Mileage / Hours',
        hasPreSeason: false
      },
      trailer: { display: 'Trailer', metricFields: [], updateLabel: '', hasPreSeason: false },
      implement: { display: 'Implement', metricFields: [], updateLabel: 'Update Planter Usage', hasPreSeason: false },
      starfire: { display: 'StarFire', metricFields: [], updateLabel: 'Update Location', hasPreSeason: false },
      technology: { display: 'Technology', metricFields: [], updateLabel: '', hasPreSeason: false },
      equipment: { display: 'Equipment', metricFields: [], updateLabel: '', hasPreSeason: false }
    };

    const FROM_MAP = {
      tractors: { label: 'Return to Tractors', href: '/Farm-vista/pages/equipment/equipment-tractors.html' },
      combines: { label: 'Return to Combines', href: '/Farm-vista/pages/equipment/equipment-combines.html' },
      trucks:   { label: 'Return to Trucks', href: '/Farm-vista/pages/equipment/equipment-trucks.html' },
      trailers: { label: 'Return to Trailers', href: '/Farm-vista/pages/equipment/equipment-trailers.html' },
      implements:{ label:'Return to Implements', href:'/Farm-vista/pages/equipment/equipment-implements.html' },
      sprayers: { label: 'Return to Sprayers', href: '/Farm-vista/pages/equipment/equipment-sprayers.html' },
      construction:{ label:'Return to Construction Equipment', href:'/Farm-vista/pages/equipment/equipment-construction.html' },
      starfire: { label: 'Return to StarFire', href: '/Farm-vista/pages/equipment/equipment-starfire.html' },
      lookup:   { label: 'Return to Equipment', href: '/Farm-vista/pages/equipment/actions/lookup.html' },
      scanner:  { label: 'Return to Scanner', href: '/Farm-vista/pages/qr-scan.html' }
    };

    /* ======================
       Helpers
       ====================== */
    function escapeHtml(str){
      return String(str || '').replace(/[&<>"']/g, m => (
        { '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]
      ));
    }

    const last6 = v => String(v || '').slice(-6);
    const setText = (id, val, opts = {}) => {
      const el = $(id); if(!el) return;
      if(!val){
        if(opts.hideIfEmpty) el.hidden = true;
        else el.textContent = '';
        return;
      }
      el.textContent = val;
      if(opts.unhide) el.hidden = false;
    };

    function showContent(){ $('content').hidden = false; }

    function setupReturnButtons(typeKey){
      const btnOrigin = $('btnReturnOrigin');
      const btnHome   = $('btnReturnHome');
      const wrap      = $('returnActions');
      if(!btnOrigin || !btnHome || !wrap) return;

      let cfg = null;

      if(from && FROM_MAP[from]) cfg = FROM_MAP[from];
      else{
        switch(typeKey){
          case 'tractor':   cfg = FROM_MAP.tractors; break;
          case 'combine':   cfg = FROM_MAP.combines; break;
          case 'truck':     cfg = FROM_MAP.trucks; break;
          case 'trailer':   cfg = FROM_MAP.trailers; break;
          case 'implement': cfg = FROM_MAP.implements; break;
          case 'sprayer':   cfg = FROM_MAP.sprayers; break;
          case 'construction': cfg = FROM_MAP.construction; break;
          case 'starfire':  cfg = FROM_MAP.starfire; break;
          default: cfg = FROM_MAP.lookup; break;
        }
      }

      if(cfg){
        btnOrigin.textContent = cfg.label;
        btnOrigin.href        = cfg.href;
        btnOrigin.hidden      = false;
      }else{
        btnOrigin.hidden = true;
      }

      btnHome.href   = '/Farm-vista/index.html';
      btnHome.hidden = false;
      wrap.hidden    = false;
    }

    function fmtNum(v){
      if(v == null || v === '') return '';
      const n = Number(v);
      if(Number.isNaN(n)) return '';
      if(Math.abs(n - Math.round(n)) < 1e-9) return String(Math.round(n));
      return String(n);
    }

    function toDateMaybe(ts){
      if(!ts) return null;
      try{
        if(ts.toDate) return ts.toDate();
        if(ts && typeof ts === 'object' && typeof ts.seconds === 'number'){
          const d = new Date(ts.seconds * 1000);
          return Number.isFinite(d.getTime()) ? d : null;
        }
        if(typeof ts === 'string' || typeof ts === 'number'){
          const d = new Date(ts);
          return Number.isFinite(d.getTime()) ? d : null;
        }
      }catch(_){}
      return null;
    }
    function formatDate(d){
      if(!d) return '';
      try{ return d.toLocaleDateString(undefined,{month:'short',day:'numeric',year:'numeric'}); }
      catch{ return ''; }
    }
    function formatDateTime(d){
      if(!d) return '';
      try{ return d.toLocaleString(); }
      catch{ return ''; }
    }

    function titleCaseType(s){
      const v = String(s||'').trim().toLowerCase();
      if(!v) return '';
      const map = { 'in_progress':'In progress', 'pending':'Pending', 'completed':'Completed' };
      if(map[v]) return map[v];
      return v.replace(/_/g,' ').replace(/\b\w/g, c => c.toUpperCase());
    }

    function normalizeStatus(s){
      const v = String(s||'').trim().toLowerCase();
      if(v === 'in progress' || v === 'in-progress') return 'in_progress';
      if(v === 'in_progress') return 'in_progress';
      if(v === 'pending') return 'pending';
      if(v === 'open') return 'pending';
      if(v === 'completed' || v === 'complete') return 'completed';
      return v;
    }

    function statusLabel(st){
      const n = normalizeStatus(st);
      if(n === 'pending') return 'Pending';
      if(n === 'in_progress') return 'In progress';
      if(n === 'completed') return 'Completed';
      return st || '‚Äî';
    }

    /* ==========================
       PRE-SEASON / PRE-INSPECTION DETECTOR (same logic as maintenance page)
       ========================== */
    function isPreSeasonWO(d){
      if(!d) return false;

      const directKeys = [
        d.precheckTemplateId,
        d.preCheckTemplateId,
        d.preInspectionTemplateId,
        d.preInspectionId,
        d.templateId
      ].map(x => String(x || '').trim()).filter(Boolean);
      if(directKeys.length) return true;

      const kind = String(d.workOrderType || d.type || d.kind || '').trim().toLowerCase();
      if(kind){
        if(kind.includes('precheck') || kind.includes('pre-check') || kind.includes('preseason') || kind.includes('pre-season') || kind.includes('preinspection') || kind.includes('pre-inspection')) return true;
      }

      const tag = String(d.tag || d.category || '').trim().toLowerCase();
      if(tag){
        if(tag.includes('precheck') || tag.includes('preseason') || tag.includes('preinspection')) return true;
      }

      const li = Array.isArray(d.lineItems) ? d.lineItems : [];
      if(li.some(x => String(x?.origin || '').toLowerCase() === 'precheck_template')) return true;

      return false;
    }

    /* ==========================
       TEMPLATE ITEMS LOADER (for older precheck WOs)
       ========================== */
    const TPL_CACHE = new Map(); // tplId -> items[]

    async function getPrecheckTemplateItems(db, tplId){
      const id = String(tplId || '').trim();
      if(!id) return [];
      if(TPL_CACHE.has(id)) return TPL_CACHE.get(id);

      try{
        const snap = await getDocs(collection(db, 'seasonal_precheck_templates', id, 'items'));
        const out = [];
        snap.forEach(d=>{
          const v = d.data() || {};
          if(v.archived === true) return;
          out.push({
            id: d.id,
            label: String(v.label || '').trim(),
            notesHint: String(v.notesHint || '').trim(),
            order: Number(v.order || 0)
          });
        });
        out.sort((a,b)=> (a.order||0) - (b.order||0));
        TPL_CACHE.set(id, out);
        return out;
      }catch(e){
        console.warn('[hub][tpl] items load failed:', e);
        TPL_CACHE.set(id, []);
        return [];
      }
    }

    /* ======================
       Metric modal (unchanged from your working version)
       ====================== */
    const MODAL = {
      open: false,
      doc: null,
      cfg: null,
      typeKey: null,
      db: null,
      snapRef: null,
      fields: [],
      lastInputs: null,
      combineInvalid: false,
      _combineUnwire: null
    };

    function showBanner(msg){
      const b = $('metricBanner');
      if(!b) return;
      if(!msg){ b.textContent=''; b.dataset.show='0'; return; }
      b.textContent = msg;
      b.dataset.show='1';
    }

    function openModal(){
      const back = $('metricModal');
      if(!back) return;
      back.dataset.open = '1';
      back.setAttribute('aria-hidden','false');
      MODAL.open = true;
      showBanner('');
      $('adjustBlock').hidden = true;
      $('adjustReason').value = '';
      document.body.style.overflow = 'hidden';
    }

    function closeModal(){
      const back = $('metricModal');
      if(!back) return;
      back.dataset.open = '0';
      back.setAttribute('aria-hidden','true');
      MODAL.open = false;
      document.body.style.overflow = '';
      showBanner('');
      $('adjustBlock').hidden = true;
      $('adjustReason').value = '';
      MODAL.combineInvalid = false;
      if (typeof MODAL._combineUnwire === 'function'){
        try{ MODAL._combineUnwire(); }catch{}
      }
      MODAL._combineUnwire = null;
    }

    function buildMetricForm(docData, cfg){
      const form = $('metricForm');
      const help = $('metricHelp');
      if(!form || !help) return;

      form.innerHTML = '';
      const fields = Array.isArray(cfg.metricFields) ? cfg.metricFields : [];
      MODAL.fields = fields;

      const rows = [];
      for (const f of fields){
        const current = docData?.[f.key];
        const label = f.label || f.key;
        const suffix = f.suffix || '';
        const step = f.step || '1';

        const el = document.createElement('div');
        el.className = 'field';
        el.innerHTML = `
          <div class="label">${escapeHtml(label)}</div>
          <input
            class="input"
            inputmode="decimal"
            autocomplete="off"
            spellcheck="false"
            id="metric_${escapeHtml(f.key)}"
            type="number"
            step="${escapeHtml(String(step).replace(/"/g,''))}"
            placeholder="Enter new ${escapeHtml(label.toLowerCase())}"
          />
          <div class="hint" id="hint_metric_${escapeHtml(f.key)}" hidden></div>
          <div class="help">Current: <b>${escapeHtml(fmtNum(current) || '‚Äî')}</b>${suffix ? ` ${escapeHtml(suffix)}` : ''}. New value cannot be less than current.</div>
        `;
        rows.push(el);
      }

      for(let i=0;i<rows.length;i+=2){
        const row = document.createElement('div');
        row.className = 'row';
        row.appendChild(rows[i]);
        if(rows[i+1]) row.appendChild(rows[i+1]);
        form.appendChild(row);
      }

      if(fields.length === 0){
        const empty = document.createElement('div');
        empty.className = 'card';
        empty.style.padding = '12px';
        empty.innerHTML = `
          <div style="font-weight:950;">No usage metric configured</div>
          <div class="small-note">This equipment doesn‚Äôt have hours/mileage/acres tracking enabled.</div>
        `;
        form.appendChild(empty);
      }

      const overrideKey = 'equipment-metrics:override';
      help.innerHTML = `
        <div class="small-note">
          Rules:
          <b>No reductions allowed</b> (prevents rollback).
          If something truly needs to go down (meter replaced, typo), use the <b>Adjustment Request</b>.
          ${ (window.FV && typeof window.FV.can === 'function')
              ? `If you have special permission (<code>${escapeHtml(overrideKey)}</code>), an office user can override decreases with a reason.`
              : ``
          }
        </div>
      `;

      for (const f of fields){
        const inp = $(`metric_${f.key}`);
        if(inp) inp.value = '';
        const hint = $(`hint_metric_${f.key}`);
        if (hint){ hint.hidden = true; hint.textContent = ''; hint.classList.remove('error'); }
      }
    }

    function toNum(v){
      const n = Number(String(v ?? '').trim());
      return Number.isFinite(n) ? n : null;
    }

    function wireCombineModalRule(){
      const eng = $('metric_engineHours');
      const sep = $('metric_separatorHours');
      const hint = $('hint_metric_separatorHours');
      if (!eng || !sep || !hint) { MODAL.combineInvalid = false; return; }

      function clearErr(){
        sep.classList.remove('input-error');
        hint.hidden = true;
        hint.textContent = '';
        hint.classList.remove('error');
        MODAL.combineInvalid = false;
      }
      function setErr(){
        sep.classList.add('input-error');
        hint.hidden = false;
        hint.textContent = 'Separator Hours cannot be greater than Engine Hours. (You may have typed into the wrong box.)';
        hint.classList.add('error');
        MODAL.combineInvalid = true;
      }
      function validate(){
        const e = toNum(eng.value);
        const s = toNum(sep.value);
        if (e == null || s == null){ clearErr(); return; }
        if (s > e) setErr(); else clearErr();
      }

      const onAny = ()=>validate();
      eng.addEventListener('input', onAny);
      sep.addEventListener('input', onAny);
      eng.addEventListener('change', onAny);
      sep.addEventListener('change', onAny);
      validate();

      MODAL._combineUnwire = ()=>{
        eng.removeEventListener('input', onAny);
        sep.removeEventListener('input', onAny);
        eng.removeEventListener('change', onAny);
        sep.removeEventListener('change', onAny);
      };
    }

    function getCurrentValue(docData, key){
      const v = docData?.[key];
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    }

    function readInputs(){
      const out = {};
      for(const f of (MODAL.fields||[])){
        const el = $(`metric_${f.key}`);
        const raw = el ? String(el.value ?? '').trim() : '';
        if(raw === '') continue;
        const n = Number(raw);
        out[f.key] = Number.isFinite(n) ? n : NaN;
      }
      return out;
    }

    function hasAnyInput(inputs){
      return inputs && Object.keys(inputs).length > 0;
    }

    function computeValidation(docData, inputs){
      const results = { ok:true, anyDecrease:false, badNumbers:[], decreases:[], updates:{} };
      for(const [k,v] of Object.entries(inputs)){
        if(!Number.isFinite(v)){ results.ok=false; results.badNumbers.push(k); continue; }
        const cur = getCurrentValue(docData, k);
        if(cur == null){ results.updates[k]=v; continue; }
        if(v < cur){ results.anyDecrease=true; results.decreases.push({ key:k, current:cur, next:v }); continue; }
        if(v === cur) continue;
        results.updates[k]=v;
      }
      if(results.badNumbers.length) results.ok=false;
      return results;
    }

    function updateMetricChip(docData, cfg, typeKey){
      const chip = $('eqMetric');
      if(!chip) return;

      const fields = Array.isArray(cfg.metricFields) ? cfg.metricFields : [];
      if(fields.length === 0){ chip.hidden = true; return; }

      if(String(typeKey||'') === 'combine'){
        const e = docData?.engineHours;
        const s = docData?.separatorHours;
        const parts = [];
        if(e != null && e !== '') parts.push(`${fmtNum(e)} hrs eng`);
        if(s != null && s !== '') parts.push(`${fmtNum(s)} hrs sep`);
        if(parts.length){ chip.textContent = parts.join(' ‚Ä¢ '); chip.hidden=false; return; }
      }

      const f0 = fields[0];
      const v0 = docData?.[f0.key];
      if(v0 != null){ chip.textContent = `${fmtNum(v0)}${f0.suffix ? ` ${f0.suffix}` : ''}`; chip.hidden=false; }
      else chip.hidden=true;
    }

    async function saveMetrics(){
      if(!MODAL.db || !MODAL.snapRef || !MODAL.doc) return;

      const btnSave = $('metricSave');
      const btnCancel = $('metricCancel');
      if(btnSave) btnSave.disabled = true;
      if(btnCancel) btnCancel.disabled = true;
      showBanner('');

      try{
        const inputs = readInputs();
        MODAL.lastInputs = inputs;

        if(!hasAnyInput(inputs)){ showBanner('Enter at least one new reading to save.'); return; }

        if (String(MODAL.typeKey||'') === 'combine'){
          const e = toNum($('metric_engineHours')?.value);
          const s = toNum($('metric_separatorHours')?.value);
          if (e != null && s != null && s > e){ showBanner('Fix required: Separator Hours cannot be greater than Engine Hours.'); return; }
        }

        const v = computeValidation(MODAL.doc, inputs);
        if(v.badNumbers.length){ showBanner('One or more values are not valid numbers.'); return; }

        const overrideKey = 'equipment-metrics:override';
        const canOverride = !!(window.FV && typeof window.FV.can === 'function' && window.FV.can(overrideKey));

        if(v.anyDecrease && !canOverride){
          const lines = v.decreases.map(x=>{
            const label = (MODAL.fields.find(f=>f.key===x.key)?.label) || x.key;
            return `‚Ä¢ ${label}: current ${fmtNum(x.current)} ‚Üí attempted ${fmtNum(x.next)}`;
          }).join('\n');

          showBanner(
            `Not allowed: readings cannot be reduced.\n` +
            `Use Adjustment Request (below) so an office/admin can review.\n\n` +
            `${lines}`
          );
          $('adjustBlock').hidden = false;
          return;
        }

        if(v.anyDecrease && canOverride){
          const reason = String($('adjustReason')?.value || '').trim();
          if(!reason){
            showBanner('Override requires a reason. Enter a note in the "Reason / note to office" box.');
            $('adjustBlock').hidden = false;
            return;
          }
          for(const dec of v.decreases){ v.updates[dec.key] = dec.next; }
        }

        if(Object.keys(v.updates).length === 0){ showBanner('No changes to save (new values match current).'); return; }

        const auth = getAuth();
        const user = auth.currentUser || null;

        const patch = {
          ...v.updates,
          metricUpdatedAt: serverTimestamp(),
          metricUpdatedBy: user?.email || null
        };

        await updateDoc(MODAL.snapRef, patch);

        await addDoc(collection(MODAL.db, 'equipment_metric_entries'), {
          equipmentId: id,
          equipmentType: MODAL.typeKey || null,
          updatedAt: serverTimestamp(),
          updatedBy: user?.email || null,
          updates: v.updates,
          previous: Object.fromEntries(Object.keys(v.updates).map(k => [k, getCurrentValue(MODAL.doc, k)])),
          from: from || null,
          mode: (v.anyDecrease ? 'override' : 'normal')
        });

        for(const [k,val] of Object.entries(v.updates)){ MODAL.doc[k] = val; }

        updateMetricChip(MODAL.doc, MODAL.cfg, MODAL.typeKey);
        showBanner('Saved.');
        setTimeout(()=>closeModal(), 220);
      }catch(e){
        console.error('[hub] saveMetrics error', e);
        showBanner('Save failed. Try again (or check connection).');
      }finally{
        if(btnSave) btnSave.disabled = false;
        if(btnCancel) btnCancel.disabled = false;
      }
    }

    async function sendAdjustmentRequest(){
      try{
        if(!MODAL.db || !MODAL.doc) return;
        const reason = String($('adjustReason')?.value || '').trim();
        if(!reason){ showBanner('Please enter a reason so the office knows what to fix.'); return; }

        const inputs = MODAL.lastInputs || readInputs();
        if(!hasAnyInput(inputs)){ showBanner('Enter the value(s) you attempted, then send the request.'); return; }

        const v = computeValidation(MODAL.doc, inputs);
        if(!v.anyDecrease){ showBanner('This request is only needed when a value would be reduced.'); $('adjustBlock').hidden = true; return; }

        const auth = getAuth();
        const user = auth.currentUser || null;

        await addDoc(collection(MODAL.db, 'equipment_metric_adjust_requests'), {
          equipmentId: id,
          equipmentType: MODAL.typeKey || null,
          createdAt: serverTimestamp(),
          createdBy: user?.email || null,
          status: 'open',
          reason,
          attempted: Object.fromEntries(v.decreases.map(d => [d.key, d.next])),
          current: Object.fromEntries(v.decreases.map(d => [d.key, d.current])),
          from: from || null
        });

        showBanner('Adjustment request sent. Office/admin will review.');
        setTimeout(()=>closeModal(), 380);
      }catch(e){
        console.error('[hub] sendAdjustmentRequest error', e);
        showBanner('Could not send request. Try again.');
      }
    }

    function wireMetricModalButtons(){
      const back = $('metricModal');
      const closeBtn = $('metricModalClose');
      const cancelBtn = $('metricCancel');
      const saveBtn = $('metricSave');
      const reqBtn = $('btnRequestAdjust');
      const adjCancel = $('btnAdjustCancel');

      if(closeBtn) closeBtn.addEventListener('click', closeModal);
      if(cancelBtn) cancelBtn.addEventListener('click', closeModal);
      if(saveBtn) saveBtn.addEventListener('click', saveMetrics);

      if(reqBtn) reqBtn.addEventListener('click', sendAdjustmentRequest);
      if(adjCancel) adjCancel.addEventListener('click', ()=>{
        $('adjustBlock').hidden = true;
        showBanner('');
      });

      if(back){
        back.addEventListener('click', (e)=>{
          if(e.target === back) closeModal();
        });
      }

      window.addEventListener('keydown', (e)=>{
        if(e.key === 'Escape' && MODAL.open) closeModal();
      });
    }

    function openMetricModal(docData, cfg, typeKey, db, snapRef){
      MODAL.doc = docData;
      MODAL.cfg = cfg;
      MODAL.typeKey = typeKey;
      MODAL.db = db;
      MODAL.snapRef = snapRef;

      $('metricModalTitle').textContent = cfg.updateLabel || 'Update Usage';
      buildMetricForm(docData, cfg);

      if(!Array.isArray(cfg.metricFields) || cfg.metricFields.length === 0){
        showBanner('No usage metric configured for this equipment.');
        return;
      }

      if (String(typeKey||'') === 'combine'){ wireCombineModalRule(); }
      openModal();
    }

    /* ======================
       Service Records Modal + On-screen summary + Print Reports
       ====================== */
    const SR = {
      open:false,
      rows:[],
      db:null,
      selectedId:null,
      eqDoc:null,
      eqTypeKey:'equipment',
      eqDisplay:'Equipment',
      eqTitle:'Equipment',
      eqMake:'',
      eqModel:'',
      eqSerial:'',
      tplItemsById: {} // tplId -> items[] (used for print + detail)
    };

    function srShowBanner(msg){
      const b = $('srBanner');
      if(!b) return;
      if(!msg){ b.textContent=''; b.dataset.show='0'; return; }
      b.textContent = msg;
      b.dataset.show='1';
    }

    function srOpen(){
      const back = $('srModal');
      if(!back) return;
      back.dataset.open='1';
      back.setAttribute('aria-hidden','false');
      SR.open=true;
      document.body.style.overflow='hidden';
    }

    function srClose(){
      const back = $('srModal');
      if(!back) return;
      back.dataset.open='0';
      back.setAttribute('aria-hidden','true');
      SR.open=false;
      document.body.style.overflow='';
      SR.selectedId = null;
      srShowListView();
    }

    function srShowListView(){
      $('srListView').dataset.show = '1';
      $('srDetailView').dataset.show = '0';
      $('srDetailGrid').innerHTML = '';
      $('srDetailNotesBlock').hidden = true;
      $('srDetailLineItemsBlock').hidden = true;
      $('srDetailTitle').textContent = 'Work Order Summary';
      $('srDetailSub').textContent = 'Tap a record to view details.';
      $('srDetailStatusTag').hidden = true;

      // clear selection UI
      const list = $('srList');
      if(list){
        list.querySelectorAll('.sr-item[aria-selected="true"]').forEach(el=>{
          el.setAttribute('aria-selected','false');
        });
      }
    }

    function srShowDetailView(){
      $('srListView').dataset.show = '0';
      $('srDetailView').dataset.show = '1';
      // keep scroll at top for detail
      const body = $('srModalBody');
      if(body) body.scrollTop = 0;
    }

    function safeText(v){ return String(v ?? '').trim(); }

    function pickTitle(r){
      return (
        safeText(r?.title) ||
        safeText(r?.summary) ||
        safeText(r?.problem) ||
        safeText(r?.issue) ||
        safeText(r?.subject) ||
        (isPreSeasonWO(r) ? 'Pre-Season Check List' : 'Service Record')
      );
    }

    function pickNotes(r){
      return (
        safeText(r?.summaryNotes) ||
        safeText(r?.notes) ||
        safeText(r?.description) ||
        safeText(r?.details) ||
        safeText(r?.workDone) ||
        ''
      );
    }

    function money(v){
      const n = Number(v);
      if(!Number.isFinite(n)) return '';
      return `$${n.toFixed(2)}`;
    }

    function bestRecordDate(r){
      return (
        toDateMaybe(r?.completedAt) ||
        toDateMaybe(r?.updatedAt) ||
        toDateMaybe(r?.createdAt) ||
        toDateMaybe(r?.date) ||
        null
      );
    }

    function buildSrItemHtml(row){
      const r = row.data || {};
      const when = bestRecordDate(r);
      const status = statusLabel(r.status);
      const title = pickTitle(r);
      const notes = pickNotes(r);

      const tags = [];
      if(status && status !== '‚Äî') tags.push(status);

      const li = Array.isArray(r.lineItems) ? r.lineItems : [];
      const openCount = li.filter(x => !x?.completed).length;
      if(li.length) tags.push(`${li.length} items (${openCount} open)`);

      return `
        <div class="sr-item" data-id="${escapeHtml(row.id)}" aria-selected="false">
          <div class="sr-top">
            <div style="min-width:0">
              <p class="sr-title">${escapeHtml(title)}</p>
              <p class="sr-sub">${escapeHtml(when ? formatDateTime(when) : '‚Äî')}</p>
            </div>
            <div class="sr-tags" aria-hidden="true" style="justify-content:flex-end">
              ${tags.slice(0,3).map(t=>`<span class="sr-tag">${escapeHtml(t)}</span>`).join('')}
            </div>
          </div>

          ${tags.length > 3 ? `
            <div class="sr-tags">
              ${tags.slice(3).map(t=>`<span class="sr-tag">${escapeHtml(t)}</span>`).join('')}
            </div>
          ` : ''}

          ${notes ? `<p class="sr-notes">${escapeHtml(notes)}</p>` : ''}
        </div>
      `;
    }

    function renderSrList(){
      const list = $('srList');
      if(!list) return;

      if(!SR.rows.length){
        list.innerHTML = `<div class="sr-empty">No service records found for this equipment.</div>`;
        return;
      }

      list.innerHTML = SR.rows.map(buildSrItemHtml).join('');
    }

    async function loadServiceRecordsForEquipment(db, equipmentId){
      const candidates = ['equipmentWorkOrders','equipment_work_orders','equipment_service_records'];

      for(const colName of candidates){
        try{
          const base = collection(db, colName);
          const q = query(base, where('equipmentId','==', equipmentId), limit(250));
          const snap = await getDocs(q);
          const rows = snap.docs.map(d=>({ id:d.id, data:d.data(), _col:colName }));
          if(rows.length){
            console.info('[hub][sr] loaded', rows.length, 'from', colName);
            return rows;
          }
        }catch(e){
          console.warn('[hub][sr] query failed for', colName, e?.code||e);
        }
      }
      return [];
    }

    async function ensureTplItemsForWO(db, woData){
      const d = woData || {};
      if(!isPreSeasonWO(d)) return null;
      const tplId = String(d.precheckTemplateId || d.preCheckTemplateId || '').trim();
      if(!tplId) return null;
      if(SR.tplItemsById[tplId]) return SR.tplItemsById[tplId];
      const items = await getPrecheckTemplateItems(db, tplId);
      SR.tplItemsById[tplId] = Array.isArray(items) ? items : [];
      return SR.tplItemsById[tplId];
    }

    function resolvePreSeasonLineItem(li, idx, tplItems){
      const origin = String(li?.origin || '').toLowerCase();
      const isPreSeasonItem = (origin === 'precheck_template');

      if(!isPreSeasonItem){
        const topic = li?.serviceTopicOther ? String(li.serviceTopicOther) : titleCaseType(li?.serviceTopic || 'Service');
        return {
          isPreSeasonItem:false,
          topic: String(topic || '').trim() || 'Service',
          notes: (String(li?.notes || '').trim() || '‚Äî'),
          parts: (String(li?.partsNeeded || '').trim() || '‚Äî')
        };
      }

      let tplHit = null;
      if(Array.isArray(tplItems) && tplItems.length){
        const tplItemId = String(li?.precheckTemplateItemId || '').trim();
        if(tplItemId){
          tplHit = tplItems.find(t => t.id === tplItemId) || null;
        }
        if(!tplHit && tplItems[idx]) tplHit = tplItems[idx];
      }

      const resolvedLabel =
        String(li?.label || '').trim() ||
        String(tplHit?.label || '').trim() ||
        String(li?.checkItem || li?.item || li?.title || '').trim() ||
        'Inspection Item';

      const resolvedNotesHint =
        String(li?.notesHint || '').trim() ||
        String(tplHit?.notesHint || '').trim() ||
        '‚Äî';

      return {
        isPreSeasonItem:true,
        topic: resolvedLabel,
        notes: resolvedNotesHint,
        parts: ''
      };
    }

    async function renderSrDetail(rowId){
      const row = (SR.rows || []).find(r => r.id === rowId) || null;
      if(!row) return;

      SR.selectedId = rowId;

      const list = $('srList');
      if(list){
        list.querySelectorAll('.sr-item').forEach(el=>{
          el.setAttribute('aria-selected', el.dataset.id === rowId ? 'true' : 'false');
        });
      }

      const d = row.data || {};
      const isPre = isPreSeasonWO(d);

      if(!SR.db) SR.db = getFirestore();
      const tplItems = await ensureTplItemsForWO(SR.db, d);

      const title = pickTitle(d);
      const st = statusLabel(d.status);

      const created = toDateMaybe(d.createdAt);
      const updated = toDateMaybe(d.updatedAt);
      const completed = toDateMaybe(d.completedAt);

      $('srDetailTitle').textContent = title || 'Work Order Summary';
      $('srDetailSub').textContent = `${SR.eqTitle || 'Equipment'} ‚Ä¢ ${isPre ? 'Pre-Season Check List' : 'Service Request'}`;

      const tag = $('srDetailStatusTag');
      if(tag){
        tag.textContent = st || '‚Äî';
        tag.hidden = false;
      }

      const grid = $('srDetailGrid');
      if(grid){
        grid.innerHTML = `
          <div class="sr-pair"><div class="sr-k">Status</div><div class="sr-v">${escapeHtml(st || '‚Äî')}</div></div>
          <div class="sr-pair"><div class="sr-k">Created</div><div class="sr-v">${escapeHtml(created ? formatDateTime(created) : '‚Äî')}</div></div>
          <div class="sr-pair"><div class="sr-k">Updated</div><div class="sr-v">${escapeHtml(updated ? formatDateTime(updated) : '‚Äî')}</div></div>
          <div class="sr-pair"><div class="sr-k">Completed</div><div class="sr-v">${escapeHtml(completed ? formatDateTime(completed) : '‚Äî')}</div></div>
        `;
      }

      const notes = pickNotes(d);
      const notesBlock = $('srDetailNotesBlock');
      if(notes && notesBlock){
        $('srDetailNotesLabel').textContent = isPre ? 'Summary / Notes' : 'Summary Notes';
        $('srDetailNotesTxt').textContent = notes;
        notesBlock.hidden = false;
      }else if(notesBlock){
        notesBlock.hidden = true;
      }

      const liBlock = $('srDetailLineItemsBlock');
      const liHost = $('srDetailLineItems');
      const lineItems = Array.isArray(d.lineItems) ? d.lineItems : [];

      if(liBlock && liHost){
        liHost.innerHTML = '';
        if(!lineItems.length){
          liBlock.hidden = true;
        }else{
          liBlock.hidden = false;

          lineItems.forEach((li, idx)=>{
            const r = resolvePreSeasonLineItem(li, idx, tplItems);

            const isDone = !!li.completed;
            const badge = isDone ? 'Completed' : 'Open';

            const submittedBy = (li.submittedByName || '').trim() || '‚Äî';
            const completedBy = (li.completedByEmployeeName || li.completedByEmployeeId || '').trim() || '‚Äî';
            const doneAt = li.completedAt ? formatDateTime(toDateMaybe(li.completedAt)) : '‚Äî';

            const el = document.createElement('div');
            el.className = 'sr-li';
            el.dataset.open = '0';
            el.innerHTML = `
              <div class="sr-li-top">
                <div class="sr-li-title">
                  <span class="sr-li-text">${escapeHtml(r.topic)}</span>
                  <span class="sr-li-chev" aria-hidden="true">‚ñæ</span>
                </div>
                <div class="sr-li-badge ${isDone ? '' : 'open'}">${escapeHtml(badge)}</div>
              </div>

              <div class="sr-li-body">
                <div class="sr-li-grid">
                  <div><div class="sr-k">Submitted by</div><div class="sr-v">${escapeHtml(submittedBy)}</div></div>
                  <div><div class="sr-k">Completed by</div><div class="sr-v">${escapeHtml(completedBy)}</div></div>
                  ${r.isPreSeasonItem ? '' : `<div><div class="sr-k">Parts</div><div class="sr-v">${escapeHtml(r.parts)}</div></div>`}
                  <div><div class="sr-k">Completed at</div><div class="sr-v">${escapeHtml(doneAt)}</div></div>

                  <div class="sr-li-notes">
                    <div class="sr-k">${escapeHtml(r.isPreSeasonItem ? 'Guidance' : 'Notes')}</div>
                    <div class="sr-v" style="margin-top:3px;font-weight:700;">${escapeHtml(r.notes)}</div>
                  </div>
                </div>
              </div>
            `;
            el.addEventListener('click', ()=>{
              el.dataset.open = (el.dataset.open === '1') ? '0' : '1';
            });
            liHost.appendChild(el);
          });
        }
      }

      srShowDetailView();
    }

    async function openServiceRecords(){
      try{
        if(!SR.db) SR.db = getFirestore();
        srShowBanner('');
        $('srList').innerHTML = `<div class="sr-empty">Loading‚Ä¶</div>`;
        $('srTitle').textContent = `Service Records ‚Äî ${$('eqName')?.textContent || 'Equipment'}`;

        srShowListView();
        srOpen();

        const rows = await loadServiceRecordsForEquipment(SR.db, id);

        rows.sort((a,b)=>{
          const da = bestRecordDate(a.data);
          const dbb = bestRecordDate(b.data);
          const ta = da ? da.getTime() : 0;
          const tb = dbb ? dbb.getTime() : 0;
          return tb - ta; // newest first
        });

        SR.rows = rows;
        renderSrList();
      }catch(e){
        console.error('[hub][sr] openServiceRecords error', e);
        srShowBanner('Could not load service records. Check connection.');
        $('srList').innerHTML = `<div class="sr-empty">Error loading records.</div>`;
      }
    }

    function wireServiceRecordTap(){
      const list = $('srList');
      if(!list) return;

      list.addEventListener('click', (e)=>{
        const item = e.target?.closest?.('.sr-item');
        if(!item) return;
        const rid = item.dataset.id || '';
        if(!rid) return;
        void renderSrDetail(rid);
      });
    }

    /* ===========================
       PRINT (same style as Equipment Maintenance ‚Äî Work Orders page)
       =========================== */
    async function loadCompanyHeader(db){
      try{
        const ref = doc(db, 'company', 'main');
        const snap = await getDoc(ref);
        const d = snap.exists() ? (snap.data() || {}) : {};
        const name = d.name || '';
        const address = [
          d.addressStreet || '',
          [d.addressCity, d.addressState].filter(Boolean).join(', '),
          d.addressZip || ''
        ].filter(Boolean).join(' ¬∑ ');
        const phone = d.phone || '';
        const email = d.email || '';
        return { name, address, phone, email };
      }catch(e){
        console.warn('[hub][sr] failed to load company header', e);
        return { name:'', address:'', phone:'', email:'' };
      }
    }

    function getSortDateForWO(d){
      const done = toDateMaybe(d.completedAt);
      const upd  = toDateMaybe(d.updatedAt);
      const crt  = toDateMaybe(d.createdAt);
      return done || upd || crt || null;
    }

    function computeCounts(items){
      const pending = items.filter(x => normalizeStatus(x.data.status) === 'pending').length;
      const ip = items.filter(x => normalizeStatus(x.data.status) === 'in_progress').length;
      const done = items.filter(x => normalizeStatus(x.data.status) === 'completed').length;
      return { pending, ip, done, total: items.length };
    }

    function computeDateRange(items){
      if(!items.length) return '';
      let min = Infinity, max = -Infinity;
      items.forEach(wo=>{
        const d = wo.data?._sortDate || null;
        if(!d) return;
        const t = d.getTime();
        if(t < min) min = t;
        if(t > max) max = t;
      });
      if(!Number.isFinite(min) || !Number.isFinite(max)) return '';
      const a = new Date(min);
      const b = new Date(max);
      if(a.toDateString() === b.toDateString()) return formatDate(a);
      return `${formatDate(a)} ‚Äì ${formatDate(b)}`;
    }

    function groupForPrint(items){
      const typeKey = String(SR.eqTypeKey || 'unknown').toLowerCase() || 'unknown';
      const equipObj = {
        equipId: id,
        name: SR.eqTitle || 'Equipment',
        make: SR.eqMake || '',
        model: SR.eqModel || '',
        serial: SR.eqSerial || '',
        workOrders: items
      };
      return [[typeKey, [equipObj]]];
    }

    function summarizePrintContext(){
      const parts = [];
      parts.push(`Equipment: ${SR.eqTitle || 'Equipment'}`);
      parts.push(`Type: ${titleCaseType(SR.eqTypeKey || '') || '‚Äî'}`);
      return parts.join(' ‚Ä¢ ');
    }

    async function printHtml(html, fileName, title){
      if (window.FVPdf && typeof window.FVPdf.openHtml === 'function') {
        try{
          window.FVPdf.openHtml({ html, fileName, title });
          return;
        }catch(err){
          console.warn('[hub][sr] FVPdf.openHtml failed, falling back to native print()', err);
        }
      }

      let iframe = document.getElementById('fv-print-frame');
      if(!iframe){
        iframe = document.createElement('iframe');
        iframe.id = 'fv-print-frame';
        iframe.style.position='fixed';
        iframe.style.right='0';
        iframe.style.bottom='0';
        iframe.style.width='0';
        iframe.style.height='0';
        iframe.style.border='0';
        iframe.style.visibility='hidden';
        document.body.appendChild(iframe);
      }

      const win = iframe.contentWindow || iframe.contentDocument;
      const docu = iframe.contentDocument || iframe.contentWindow.document;

      docu.open();
      docu.write(html);
      docu.close();

      setTimeout(() => {
        try{ win.focus(); win.print(); }
        catch(err){
          console.warn('[hub][sr] iframe print failed, falling back to window.print()', err);
          window.print();
        }
      }, 420);
    }

    /* ===== COPY OF YOUR MAINTENANCE REPORT BUILDERS (scoped to this equipment) ===== */
    function buildSummaryPrintHtml({ company, runStr, runDateOnly, filterSummary, dateRange, counts, grouped, preseasonCount }){
      return `<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Equipment Maintenance ‚Äî Summary</title>
  <style>
    :root{
      --fv-green:#3B7E46;
      --fv-border:#D1D5DB;
      --fv-text:#111827;
      --fv-muted:#6B7280;
      --fv-bg:#F3F4F6;
    }
    *{box-sizing:border-box;}
    html,body{ margin:0; padding:0; font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; color:var(--fv-text); background:var(--fv-bg); }
    body{ display:flex; justify-content:center; padding:22px 12px; }
    .page{ width:100%; max-width:920px; background:#fff; border-radius:14px; box-shadow:0 10px 30px rgba(15,23,42,0.12); padding:20px 22px 22px; }
    .hdr{ display:grid; grid-template-columns:auto 1fr auto; gap:14px; align-items:center; border-bottom:2px solid var(--fv-green); padding-bottom:12px; margin-bottom:14px; }
    .logo{ width:60px;height:60px;border-radius:16px; border:1px solid var(--fv-border); display:flex;align-items:center;justify-content:center; font-size:24px;font-weight:900;color:#fff; background:radial-gradient(circle at 30% 0%, #4CAF50, var(--fv-green)); }
    .co-name{font-size:16px;font-weight:900;margin:0 0 2px;}
    .co-line{font-size:11px;color:var(--fv-muted);margin:0;line-height:1.35;}
    .meta{ text-align:right; font-size:11px; color:var(--fv-muted); line-height:1.35; white-space:nowrap; }
    .meta strong{color:var(--fv-text);}
    .title{ margin:0; font-size:18px; font-weight:950; letter-spacing:0.06em; text-transform:uppercase; }
    .subtitle{ margin:4px 0 0; font-size:12px; color:var(--fv-muted); line-height:1.35; }

    .summary{
      margin-top:10px;
      padding:8px 10px;
      border-radius:12px;
      background:linear-gradient(90deg, rgba(59,126,70,0.10), transparent);
      border:1px solid rgba(59,126,70,0.22);
      display:flex;
      flex-wrap:wrap;
      gap:6px 14px;
      font-size:11px;
    }
    .pill{display:inline-flex; gap:6px; align-items:baseline; white-space:nowrap;}
    .k{font-size:10px; text-transform:uppercase; letter-spacing:0.10em; color:var(--fv-muted); font-weight:700;}
    .v{font-weight:800; color:var(--fv-text);}

    .kpis{ margin-top:12px; display:grid; grid-template-columns:repeat(5, minmax(0,1fr)); gap:10px; }
    .kpi{ border:1px solid var(--fv-border); border-radius:12px; padding:9px 10px; background:linear-gradient(135deg, rgba(59,126,70,0.06), #fff); }
    .kpi .lab{font-size:10px;text-transform:uppercase;letter-spacing:0.10em;color:var(--fv-muted);font-weight:900;}
    .kpi .val{font-size:18px;font-weight:950;margin-top:2px;}
    .kpi .note{font-size:10px;color:var(--fv-muted);margin-top:2px;line-height:1.25;}

    .section{ margin-top:16px; border-top:1px solid #EEF2F7; padding-top:14px; }
    .type-title{ font-size:12px; font-weight:950; letter-spacing:0.10em; text-transform:uppercase; color:#1F2937; margin:0 0 8px; display:flex; justify-content:space-between; gap:10px; align-items:baseline; }
    .equip-card{ border:1px solid var(--fv-border); border-radius:12px; padding:10px 10px 9px; margin-bottom:10px; break-inside:avoid; }
    .equip-name{ font-weight:950; font-size:13px; line-height:1.25; }
    .equip-sub{ margin-top:2px; font-size:11px; color:var(--fv-muted); }

    .wo-tags{ margin-top:8px; display:flex; flex-wrap:wrap; gap:6px; }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid #E5E7EB;
      background:#F9FAFB;
      font-size:10px;
      font-weight:950;
      letter-spacing:0.08em;
      text-transform:uppercase;
      color:#111827;
      white-space:nowrap;
    }
    .tag .n{
      font-size:10px;
      font-weight:950;
      letter-spacing:0.02em;
      text-transform:none;
      color:var(--fv-muted);
    }
    .tag.pre{
      border-color: rgba(59,126,70,0.28);
      background: rgba(59,126,70,0.08);
    }
    .tag.req{
      border-color: rgba(17,24,39,0.18);
      background: rgba(17,24,39,0.04);
    }

    .footer{ margin-top:16px; padding-top:10px; border-top:1px solid var(--fv-border); display:flex; justify-content:space-between; gap:12px; font-size:10px; color:var(--fv-muted); line-height:1.3; }
    .footer .l{max-width:65%;}
    .footer .r{text-align:right;}
    @media (max-width:860px){
      .kpis{grid-template-columns:repeat(2, minmax(0,1fr));}
      .meta{white-space:normal;}
    }
    @media print{
      html,body{background:#fff;padding:0;}
      .page{ max-width:none; border-radius:0; box-shadow:none; padding:12mm 13mm; }
      .equip-card{break-inside:avoid; page-break-inside:avoid;}
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="hdr">
      <div class="logo"><span>DF</span></div>
      <div>
        <p class="co-name">${escapeHtml(company.name || '')}</p>
        <p class="co-line">
          ${company.address ? escapeHtml(company.address) + '<br>' : ''}
          ${company.phone ? 'Phone: ' + escapeHtml(company.phone) : ''}${company.phone && company.email ? ' ¬∑ ' : ''}
          ${company.email ? 'Email: ' + escapeHtml(company.email) : ''}
        </p>
      </div>
      <div class="meta">
        <div><strong>Equipment Maintenance</strong></div>
        <div>Generated: ${escapeHtml(runStr)}</div>
        <div>Prepared by: ${escapeHtml(company.name || 'FarmVista')}</div>
      </div>
    </header>

    <h1 class="title">Equipment Maintenance ‚Äî Summary</h1>
    <p class="subtitle">Summary of work orders for active equipment, grouped by type and equipment. Matches current selection.</p>

    <div class="summary">
      <div class="pill"><span class="k">Date range</span><span class="v">${escapeHtml(dateRange || 'All dates')}</span></div>
      <div class="pill"><span class="k">Filters</span><span class="v">${escapeHtml(filterSummary)}</span></div>
    </div>

    <div class="kpis">
      <div class="kpi">
        <div class="lab">Work orders</div>
        <div class="val">${counts.total}</div>
        <div class="note">Matching selection</div>
      </div>

      <div class="kpi"><div class="lab">Pending</div><div class="val">${counts.pending}</div></div>
      <div class="kpi"><div class="lab">In progress</div><div class="val">${counts.ip}</div></div>
      <div class="kpi"><div class="lab">Completed</div><div class="val">${counts.done}</div></div>

      <div class="kpi">
        <div class="lab">Pre-Season Checks</div>
        <div class="val">${Number(preseasonCount || 0)}</div>
        <div class="note">From pre-check templates</div>
      </div>
    </div>

    ${grouped.map(([typeKey, equipmentArr]) => {
      const typeLabel = typeKey === 'unknown' ? 'Unknown type' : titleCaseType(typeKey);
      const typeTotal = equipmentArr.reduce((sum, e) => sum + (e.workOrders?.length || 0), 0);

      return `
      <section class="section">
        <div class="type-title">
          <span>${escapeHtml(typeLabel)}</span>
          <span style="font-size:11px;color:var(--fv-muted);letter-spacing:0.06em;text-transform:none;font-weight:900;">${typeTotal} total</span>
        </div>

        ${equipmentArr.map(e => {
          const wos = Array.isArray(e.workOrders) ? e.workOrders : [];
          const preCount = wos.filter(wo => isPreSeasonWO(wo && wo.data)).length;
          const reqCount = Math.max(0, wos.length - preCount);

          return `
            <div class="equip-card">
              <div class="equip-name">${escapeHtml(e.name || 'Equipment')}</div>
              <div class="equip-sub">${escapeHtml([e.make, e.model].filter(Boolean).join(' ') || '')}${e.serial ? ` ¬∑ Serial: ${escapeHtml(e.serial)}` : ''}</div>

              <div class="wo-tags" aria-label="Work order origin">
                ${reqCount ? `<span class="tag req">Service Request</span>` : ''}
                ${preCount ? `<span class="tag pre">Pre-Season Check List</span>` : ''}
                ${(!reqCount && !preCount) ? `<span class="tag req">No work orders <span class="n">(0)</span></span>` : ''}
              </div>
            </div>
          `;
        }).join('')}
      </section>
      `;
    }).join('')}

    <footer class="footer">
      <div class="l">Summary report. Line-item details are available in the detailed report.</div>
      <div class="r">FarmVista ‚Ä¢ Equipment Maintenance ‚Ä¢ ${escapeHtml(runDateOnly || '')}</div>
    </footer>
  </div>
</body>
</html>`;
    }

    function buildDetailedPrintHtml({ company, runStr, runDateOnly, filterSummary, dateRange, counts, grouped, tplItemsById }){
      function resolvePreSeasonLineItemPrint(li, idx, tplItems){
        const origin = String(li?.origin || '').toLowerCase();
        const isPreSeasonItem = (origin === 'precheck_template');

        if(!isPreSeasonItem){
          const topic = li?.serviceTopicOther ? String(li.serviceTopicOther) : titleCaseType(li?.serviceTopic || 'Service');
          return {
            isPreSeasonItem:false,
            topic: String(topic || '').trim() || 'Service',
            notes: (String(li?.notes || '').trim() || '‚Äî'),
            parts: (String(li?.partsNeeded || '').trim() || '‚Äî')
          };
        }

        let tplHit = null;
        if(Array.isArray(tplItems) && tplItems.length){
          const tplItemId = String(li?.precheckTemplateItemId || '').trim();
          if(tplItemId){
            tplHit = tplItems.find(t => t.id === tplItemId) || null;
          }
          if(!tplHit && tplItems[idx]) tplHit = tplItems[idx];
        }

        const resolvedLabel =
          String(li?.label || '').trim() ||
          String(tplHit?.label || '').trim() ||
          String(li?.checkItem || li?.item || li?.title || '').trim() ||
          'Inspection Item';

        const resolvedNotesHint =
          String(li?.notesHint || '').trim() ||
          String(tplHit?.notesHint || '').trim() ||
          '‚Äî';

        return {
          isPreSeasonItem:true,
          topic: resolvedLabel,
          notes: resolvedNotesHint,
          parts: ''
        };
      }

      const preseasonCount = (grouped || []).reduce((sum, [, equipmentArr]) => {
        const eqSum = (equipmentArr || []).reduce((s2, e) => {
          const wos = Array.isArray(e.workOrders) ? e.workOrders : [];
          return s2 + wos.filter(wo => isPreSeasonWO(wo && wo.data)).length;
        }, 0);
        return sum + eqSum;
      }, 0);

      return `<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Equipment Maintenance ‚Äî Detailed</title>
  <style>
    :root{
      --fv-green:#3B7E46;
      --fv-border:#D1D5DB;
      --fv-text:#111827;
      --fv-muted:#6B7280;
      --fv-bg:#F3F4F6;
    }
    *{box-sizing:border-box;}
    html,body{ margin:0; padding:0; font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif; color:var(--fv-text); background:var(--fv-bg); }
    body{ display:flex; justify-content:center; padding:22px 12px; }

    .page{ width:100%; max-width:920px; background:#fff; border-radius:14px; box-shadow:0 10px 30px rgba(15,23,42,0.12); padding:20px 22px 22px; }

    .hdr{ display:grid; grid-template-columns:auto 1fr auto; gap:14px; align-items:center; border-bottom:2px solid var(--fv-green); padding-bottom:12px; margin-bottom:14px; }
    .logo{ width:60px;height:60px;border-radius:16px; border:1px solid var(--fv-border); display:flex;align-items:center;justify-content:center; font-size:24px;font-weight:900;color:#fff; background:radial-gradient(circle at 30% 0%, #4CAF50, var(--fv-green)); }
    .co-name{font-size:16px;font-weight:900;margin:0 0 2px;}
    .co-line{font-size:11px;color:var(--fv-muted);margin:0;line-height:1.35;}
    .meta{ text-align:right; font-size:11px; color:var(--fv-muted); line-height:1.35; white-space:nowrap; }
    .meta strong{color:var(--fv-text);}

    .title{ margin:0; font-size:18px; font-weight:950; letter-spacing:0.06em; text-transform:uppercase; }
    .subtitle{ margin:4px 0 0; font-size:12px; color:var(--fv-muted); line-height:1.35; }

    .summary{
      margin-top:10px; padding:8px 10px; border-radius:12px;
      background:linear-gradient(90deg, rgba(59,126,70,0.10), transparent);
      border:1px solid rgba(59,126,70,0.22);
      display:flex; flex-wrap:wrap; gap:6px 14px; font-size:11px;
    }
    .pill{display:inline-flex; gap:6px; align-items:baseline; white-space:nowrap;}
    .k{font-size:10px; text-transform:uppercase; letter-spacing:0.10em; color:var(--fv-muted); font-weight:700;}
    .v{font-weight:800; color:var(--fv-text);}

    .kpis{ margin-top:12px; display:grid; grid-template-columns:repeat(5, minmax(0,1fr)); gap:10px; }
    .kpi{ border:1px solid var(--fv-border); border-radius:12px; padding:9px 10px; background:linear-gradient(135deg, rgba(59,126,70,0.06), #fff); }
    .kpi .lab{font-size:10px;text-transform:uppercase;letter-spacing:0.10em;color:var(--fv-muted);font-weight:900; white-space:nowrap;}
    .kpi .val{font-size:18px;font-weight:950;margin-top:2px;line-height:1.05; white-space:nowrap;}
    .kpi .note{font-size:10px;color:var(--fv-muted);margin-top:2px;line-height:1.25;}

    .section{ margin-top:16px; border-top:1px solid #EEF2F7; padding-top:14px; }

    .type-head{ display:flex; justify-content:space-between; gap:10px; align-items:baseline; margin:12px 0 8px; }
    .type-title{ font-size:12px; font-weight:950; letter-spacing:0.10em; text-transform:uppercase; color:#111827; margin:0; white-space:nowrap; }
    .type-right{ font-size:11px; color:var(--fv-muted); font-weight:900; white-space:nowrap; text-align:right; }

    .equip-card{
      border:1px solid var(--fv-border);
      border-radius:12px;
      padding:10px 10px 9px;
      margin-bottom:10px;
      break-inside:auto;
      page-break-inside:auto;
    }
    .equip-name{ font-weight:950; font-size:13px; line-height:1.25; }
    .equip-sub{ margin-top:2px; font-size:11px; color:var(--fv-muted); }

    .wo{
      margin-top:10px;
      border:1px solid #E5E7EB;
      border-radius:12px;
      padding:10px 10px 9px;
      break-inside:auto;
      page-break-inside:auto;
    }

    .wo-head{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; padding-bottom:8px; border-bottom:1px solid #EEF2F7; margin-bottom:8px; }
    .wo-title{ font-weight:950; font-size:12px; line-height:1.25; }
    .wo-sub{ margin-top:2px; font-size:10px; color:var(--fv-muted); line-height:1.25; }

    .wo-right{ display:flex; gap:6px; align-items:flex-start; justify-content:flex-end; flex:0 0 auto; white-space:nowrap; }
    .pill-pre{
      font-size:9px; font-weight:950; letter-spacing:0.08em; text-transform:uppercase;
      padding:3px 8px; border-radius:999px;
      border:1px solid rgba(59,126,70,0.28);
      background:rgba(59,126,70,0.08);
      color:#0F172A;
      white-space:nowrap;
    }
    .badge{
      font-size:9px; font-weight:950; letter-spacing:0.08em; text-transform:uppercase;
      padding:3px 8px; border-radius:999px;
      border:1px solid rgba(59,126,70,0.26);
      background:rgba(59,126,70,0.06);
      color:#0F172A;
      white-space:nowrap;
    }
    .badge.open{ border-color: rgba(234,179,8,0.35); background: rgba(234,179,8,0.10); }

    .wo-meta{ display:grid; grid-template-columns:repeat(4, minmax(0,1fr)); gap:8px 10px; font-size:10px; }
    .pair .kk{ font-size:9px; text-transform:uppercase; letter-spacing:0.10em; color:var(--fv-muted); font-weight:900; margin-bottom:2px; line-height:1.1; white-space:nowrap; }
    .pair .vv{ font-weight:650; color:#111827; line-height:1.2; word-break:break-word; }

    .lines{ margin-top:8px; padding-top:8px; border-top:1px dashed #E5E7EB; }

    .line{
      border:1px solid #E5E7EB;
      border-radius:12px;
      padding:9px 9px 8px;
      margin-top:8px;
      break-inside:avoid;
      page-break-inside:avoid;
      background:linear-gradient(135deg, rgba(59,126,70,0.05), #fff);
    }
    .line-top{ display:flex; justify-content:space-between; gap:10px; align-items:flex-start; margin-bottom:8px; padding-bottom:7px; border-bottom:1px solid #EEF2F7; }
    .line-title{ font-weight:950; font-size:11px; line-height:1.25; }
    .line-badge{
      font-size:9px; font-weight:950; letter-spacing:0.08em; text-transform:uppercase;
      padding:3px 8px; border-radius:999px;
      border:1px solid rgba(59,126,70,0.26);
      background:rgba(59,126,70,0.06);
      white-space:nowrap;
      flex:0 0 auto;
    }
    .line-badge.open{ border-color: rgba(234,179,8,0.35); background: rgba(234,179,8,0.10); }

    .line-grid{ display:grid; grid-template-columns:repeat(4, minmax(0,1fr)); gap:8px 10px; font-size:10px; }
    .line-notes{ grid-column:1/-1; margin-top:6px; padding-top:6px; border-top:1px dashed #E5E7EB; white-space:pre-wrap; line-height:1.25; font-size:10px; }

    .footer{ margin-top:16px; padding-top:10px; border-top:1px solid var(--fv-border); display:flex; justify-content:space-between; gap:12px; font-size:10px; color:var(--fv-muted); line-height:1.3; }
    .footer .l{max-width:65%;}
    .footer .r{text-align:right;}

    @media (max-width:860px){
      .kpis{grid-template-columns:repeat(2, minmax(0,1fr));}
      .meta{white-space:normal;}
      .wo-meta{grid-template-columns:repeat(2, minmax(0,1fr));}
      .line-grid{grid-template-columns:repeat(2, minmax(0,1fr));}
      .wo-right{white-space:normal; flex-wrap:wrap;}
    }

    @media print{
      html,body{background:#fff;padding:0;}
      body{padding:0;}
      .page{ max-width:none; border-radius:0; box-shadow:none; padding:12mm 13mm; }
      .equip-card{ break-inside:auto; page-break-inside:auto; }
      .wo{ break-inside:auto; page-break-inside:auto; }
      .line{ break-inside:avoid; page-break-inside:avoid; }
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="hdr">
      <div class="logo"><span>DF</span></div>
      <div>
        <p class="co-name">${escapeHtml(company.name || '')}</p>
        <p class="co-line">
          ${company.address ? escapeHtml(company.address) + '<br>' : ''}
          ${company.phone ? 'Phone: ' + escapeHtml(company.phone) : ''}${company.phone && company.email ? ' ¬∑ ' : ''}
          ${company.email ? 'Email: ' + escapeHtml(company.email) : ''}
        </p>
      </div>
      <div class="meta">
        <div><strong>Equipment Maintenance</strong></div>
        <div>Generated: ${escapeHtml(runStr)}</div>
        <div>Prepared by: ${escapeHtml(company.name || 'FarmVista')}</div>
      </div>
    </header>

    <h1 class="title">Equipment Maintenance ‚Äî Detailed</h1>
    <p class="subtitle">Detailed work orders and line items for active equipment. Matches current selection.</p>

    <div class="summary">
      <div class="pill"><span class="k">Date range</span><span class="v">${escapeHtml(dateRange || 'All dates')}</span></div>
      <div class="pill"><span class="k">Filters</span><span class="v">${escapeHtml(filterSummary)}</span></div>
    </div>

    <div class="kpis">
      <div class="kpi"><div class="lab">Work orders</div><div class="val">${counts.total}</div><div class="note">Matching selection</div></div>
      <div class="kpi"><div class="lab">Pending</div><div class="val">${counts.pending}</div></div>
      <div class="kpi"><div class="lab">In progress</div><div class="val">${counts.ip}</div></div>
      <div class="kpi"><div class="lab">Completed</div><div class="val">${counts.done}</div></div>
      <div class="kpi"><div class="lab">Pre-Season Checks</div><div class="val">${Number(preseasonCount || 0)}</div><div class="note">From pre-check templates</div></div>
    </div>

    ${grouped.map(([typeKey, equipmentArr]) => {
      const typeLabel = typeKey === 'unknown' ? 'Unknown type' : titleCaseType(typeKey);
      const typeTotal = (equipmentArr || []).reduce((sum, e) => sum + ((e.workOrders || []).length), 0);

      return `
      <section class="section">
        <div class="type-head">
          <h3 class="type-title">${escapeHtml(typeLabel)}</h3>
          <div class="type-right">${typeTotal} total</div>
        </div>

        ${(equipmentArr || []).map(e => {
          const wos = Array.isArray(e.workOrders) ? e.workOrders : [];
          return `
            <div class="equip-card">
              <div class="equip-name">${escapeHtml(e.name || 'Equipment')}</div>
              <div class="equip-sub">${escapeHtml([e.make, e.model].filter(Boolean).join(' ') || '')}${e.serial ? ` ¬∑ Serial: ${escapeHtml(e.serial)}` : ''}</div>

              ${wos.map(wo => {
                const d = wo.data || {};
                const stNorm = normalizeStatus(d.status);
                const st = statusLabel(d.status);

                const created = d.createdAt ? formatDateTime(toDateMaybe(d.createdAt)) : '‚Äî';
                const updated = d.updatedAt ? formatDateTime(toDateMaybe(d.updatedAt)) : '‚Äî';
                const completedAt = d.completedAt ? formatDateTime(toDateMaybe(d.completedAt)) : '‚Äî';

                const meterLine = d.meterLabel
                  ? (String(d.meterLabel) + ((d.completionMeter != null) ? (': ' + String(d.completionMeter)) : ''))
                  : '‚Äî';

                const lineItems = Array.isArray(d.lineItems) ? d.lineItems : [];
                const openCount = lineItems.filter(x=>!x?.completed).length;

                const pre = isPreSeasonWO(d);
                const tplId = String(d.precheckTemplateId || d.preCheckTemplateId || '').trim();
                const tplItems = (pre && tplId && tplItemsById && tplItemsById[tplId]) ? tplItemsById[tplId] : null;

                return `
                  <article class="wo">
                    <div class="wo-head">
                      <div>
                        <div class="wo-title">${escapeHtml(e.name || 'Equipment')} ‚Äî ${lineItems.length} item${lineItems.length===1?'':'s'} (${openCount} open)</div>
                        <div class="wo-sub">Meter: ${escapeHtml(meterLine)} ¬∑ Created: ${escapeHtml(created)}${updated && updated!=='‚Äî' ? ` ¬∑ Updated: ${escapeHtml(updated)}` : ''}${completedAt && completedAt!=='‚Äî' ? ` ¬∑ Completed: ${escapeHtml(completedAt)}` : ''}</div>
                      </div>
                      <div class="wo-right">
                        ${pre ? `<span class="pill-pre">Pre-Season Check List</span>` : ``}
                        <span class="badge ${stNorm==='completed' ? '' : 'open'}">${escapeHtml(st)}</span>
                      </div>
                    </div>

                    ${d.summaryNotes ? `<div class="lines"><div class="pair"><div class="kk">Summary notes</div><div class="vv">${escapeHtml(String(d.summaryNotes))}</div></div></div>` : ''}

                    <div class="lines">
                      ${lineItems.map((li, idx) => {
                        const r = resolvePreSeasonLineItemPrint(li, idx, tplItems);

                        const isDone = !!li.completed;
                        const badge = isDone ? 'Completed' : 'Open';
                        const submittedBy = (li.submittedByName || '').trim() || '‚Äî';
                        const completedBy = (li.completedByEmployeeName || li.completedByEmployeeId || '').trim() || '‚Äî';
                        const doneAt = li.completedAt ? formatDateTime(toDateMaybe(li.completedAt)) : '‚Äî';

                        return `
                          <div class="line">
                            <div class="line-top">
                              <div class="line-title">
                                ${escapeHtml(r.topic)}
                                ${r.isPreSeasonItem ? '' : ` <span style="opacity:.65;font-weight:800">#${idx+1}</span>`}
                              </div>
                              <div class="line-badge ${isDone ? '' : 'open'}">${escapeHtml(badge)}</div>
                            </div>

                            <div class="line-grid">
                              <div class="pair"><div class="kk">Submitted by</div><div class="vv">${escapeHtml(submittedBy)}</div></div>
                              <div class="pair"><div class="kk">Completed by</div><div class="vv">${escapeHtml(completedBy)}</div></div>
                              ${r.isPreSeasonItem ? '' : `<div class="pair"><div class="kk">Parts</div><div class="vv">${escapeHtml(r.parts)}</div></div>`}
                              <div class="pair"><div class="kk">Completed at</div><div class="vv">${escapeHtml(doneAt)}</div></div>

                              <div class="line-notes">
                                <span class="kk" style="display:block;margin-bottom:2px;">${escapeHtml(r.isPreSeasonItem ? 'Guidance' : 'Notes')}</span>
                                ${escapeHtml(r.notes)}
                              </div>
                            </div>
                          </div>
                        `;
                      }).join('')}
                    </div>
                  </article>
                `;
              }).join('')}
            </div>
          `;
        }).join('')}
      </section>
      `;
    }).join('')}

    <footer class="footer">
      <div class="l">Detailed report includes work orders and line items. Data reflects what is stored in FarmVista.</div>
      <div class="r">FarmVista ‚Ä¢ Equipment Maintenance ‚Ä¢ ${escapeHtml(runDateOnly || '')}</div>
    </footer>
  </div>
</body>
</html>`;
    }

    async function runSummaryPrint(){
      const itemsRaw = SR.rows || [];
      if(!itemsRaw.length){ srShowBanner('No records to print.'); return; }

      if(!SR.db) SR.db = getFirestore();
      const company = await loadCompanyHeader(SR.db);

      const items = itemsRaw.map(x=>{
        const d = x.data || {};
        return { id:x.id, data:{ ...d, _sortDate: getSortDateForWO(d) } };
      });

      const now = new Date();
      const runStr = formatDateTime(now);
      const runDateOnly = formatDate(now);

      const counts = computeCounts(items);
      const grouped = groupForPrint(items);
      const filterSummary = summarizePrintContext();
      const dateRange = computeDateRange(items);

      const preseasonCount = items.filter(wo => isPreSeasonWO(wo.data)).length;

      const html = buildSummaryPrintHtml({
        company,
        runStr,
        runDateOnly,
        filterSummary,
        dateRange,
        counts,
        grouped,
        preseasonCount
      });

      const fileName = `equipment_maintenance_summary_${now.toISOString().slice(0,10)}.pdf`;
      await printHtml(html, fileName, 'Equipment Maintenance ‚Äî Summary');
    }

    async function runDetailedPrint(){
      const itemsRaw = SR.rows || [];
      if(!itemsRaw.length){ srShowBanner('No records to print.'); return; }

      if(!SR.db) SR.db = getFirestore();
      const company = await loadCompanyHeader(SR.db);

      const items = itemsRaw.map(x=>{
        const d = x.data || {};
        return { id:x.id, data:{ ...d, _sortDate: getSortDateForWO(d) } };
      });

      // preload template items for any pre-season WOs
      const tplItemsById = {};
      for(const wo of items){
        const d = wo?.data || {};
        if(!isPreSeasonWO(d)) continue;
        const tplId = String(d.precheckTemplateId || d.preCheckTemplateId || '').trim();
        if(!tplId) continue;
        if(tplItemsById[tplId]) continue;
        const t = await getPrecheckTemplateItems(SR.db, tplId);
        tplItemsById[tplId] = Array.isArray(t) ? t : [];
      }

      const now = new Date();
      const runStr = formatDateTime(now);
      const runDateOnly = formatDate(now);

      const counts = computeCounts(items);
      const grouped = groupForPrint(items);
      const filterSummary = summarizePrintContext();
      const dateRange = computeDateRange(items);

      const html = buildDetailedPrintHtml({
        company,
        runStr,
        runDateOnly,
        filterSummary,
        dateRange,
        counts,
        grouped,
        tplItemsById
      });

      const fileName = `equipment_maintenance_detailed_${now.toISOString().slice(0,10)}.pdf`;
      await printHtml(html, fileName, 'Equipment Maintenance ‚Äî Detailed');
    }

    function wireServiceRecordsModalButtons(){
      const back = $('srModal');
      const closeBtn = $('srClose');

      if(closeBtn) closeBtn.addEventListener('click', srClose);
      if(back){
        back.addEventListener('click', (e)=>{ if(e.target === back) srClose(); });
      }

      window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape' && SR.open) srClose(); });

      $('srBackBtn')?.addEventListener('click', ()=> srShowListView());

      $('srPrintSummary')?.addEventListener('click', async ()=>{
        srShowBanner('');
        await runSummaryPrint();
      });

      $('srPrintDetailed')?.addEventListener('click', async ()=>{
        srShowBanner('');
        await runDetailedPrint();
      });
    }

    /* ======================
       Init
       ====================== */
    const TIMEOUT_MS = 22000;
    let finished=false;
    const watchdog=setTimeout(()=>{
      if(finished) return;
      showContent();
      $('timeoutCard').hidden=false;
      $('status').textContent='Timed out waiting for data.'; $('status').hidden=false;
      console.warn('[hub] watchdog fired');
    },TIMEOUT_MS);

    async function userReady(maxMs=3000){
      const auth = getAuth();
      if (auth.currentUser) return;
      const first = new Promise(res=>{
        const off = onAuthStateChanged(auth, (u)=>{ try{off();}catch{} res(u); }, { onlyOnce:true });
      });
      let u = await first;
      if (u) return;
      const t0 = Date.now();
      while(!auth.currentUser && (Date.now()-t0) < maxMs){
        await new Promise(r=>setTimeout(r,120));
      }
    }

    async function getDocWithRetry(ref){
      try { return await getDoc(ref); }
      catch(e){ await new Promise(r=>setTimeout(r, 600)); return await getDoc(ref); }
    }

    function cloneCfg(base){
      return {
        display: base.display,
        updateLabel: base.updateLabel,
        hasPreSeason: !!base.hasPreSeason,
        metricFields: Array.isArray(base.metricFields) ? base.metricFields.slice() : []
      };
    }

    function resolveEffectiveCfg(typeKey, d){
      const base = HUB_CONFIG[typeKey] || HUB_CONFIG.equipment;
      const cfg = cloneCfg(base);

      if(typeKey === 'implement'){
        const it = String(d.implementType || '').toLowerCase();
        if(it === 'planter'){
          cfg.display = 'Planter';
          cfg.updateLabel = 'Update Planter Acres / Hours';
          cfg.metricFields = [
            { key:'totalAcres', label:'Total Acres', suffix:'ac', step:'1' },
            { key:'totalHours', label:'Total Hours', suffix:'hrs', step:'0.1' }
          ];
        }else{
          cfg.metricFields = [];
          cfg.updateLabel = '';
        }
      }

      if(typeKey === 'construction'){
        const ct = String(d.constructionType || '').toLowerCase();
        if(ct && ct !== 'machine'){
          cfg.metricFields = [];
          cfg.updateLabel = '';
        }
      }

      if(!cfg.metricFields || cfg.metricFields.length === 0){
        cfg.updateLabel = '';
      }

      return cfg;
    }

    let runId = 0;
    async function init(){
      const my = ++runId;
      await ready;
      await userReady();
      if (my !== runId) return;

      if(!id){
        clearTimeout(watchdog); finished=true; showContent();
        $('status').textContent='No equipment id provided.'; $('status').hidden=false;
        return;
      }

      const db=getFirestore();
      let snap;
      let ref;

      try{
        ref = doc(db,'equipment',id);
        snap = await getDocWithRetry(ref);
      }catch(e){
        console.error('[hub] getDoc error', e);
        clearTimeout(watchdog); finished=true; showContent();
        $('status').textContent='Error loading hub.'; $('status').hidden=false;
        return;
      }
      if (my !== runId) return;

      clearTimeout(watchdog); finished=true; showContent();

      if(!snap.exists()){
        $('status').textContent='Not found.'; $('status').hidden=false;
        return;
      }

      const d = snap.data() || {}; d.id = id;
      const typeKey = String(d.type || 'equipment').toLowerCase();
      const cfg = resolveEffectiveCfg(typeKey, d);

      const hubTitle = `${cfg.display} Hub`;
      setText('pageTitle', hubTitle);
      document.title = `FarmVista ‚Ä¢ ${hubTitle}`;

      const mm = [d.makeName, d.modelName].filter(Boolean).join(' ');
      const ls = last6(d.serial);
      const title = mm ? `${mm}${ls ? ` (#${ls})` : ''}` : (d.name || `Unit ${id.slice(0,6)}`);
      setText('eqName', title);
      if(ls) setText('eqSerial', `SN #${ls}`, { unhide:true });

      // store equipment context for SR print + detail
      SR.eqDoc = d;
      SR.eqTypeKey = typeKey || 'equipment';
      SR.eqDisplay = cfg.display || 'Equipment';
      SR.eqTitle = title || 'Equipment';
      SR.eqMake = String(d.makeName || '').trim();
      SR.eqModel = String(d.modelName || '').trim();
      SR.eqSerial = String(d.serial || '').trim();

      updateMetricChip(d, cfg, typeKey);
      $('eqCard').hidden = false;

      const calcCard = $('combineCalcs');

      const isArchived = (String(d.status||'').toLowerCase() === 'archived') || (d.archived === true);
      if(isArchived){
        const name = mm || 'This unit';
        $('archivedMsg').textContent = `‚Äú${name}${ls ? ' ‚Ä¢ SN ‚Ä¶'+ls : ''}‚Äù is archived and not available for new entries.`;
        $('archivedCard').hidden = false;
        if (calcCard) calcCard.hidden = true;
      }else{
        setText('linkReq', 'Submit Service Request');
        $('linkReq').hidden = false;

        if(Array.isArray(cfg.metricFields) && cfg.metricFields.length > 0 && cfg.updateLabel){
          setText('linkMetric', cfg.updateLabel);
          $('linkMetric').hidden = false;
        }else{
          $('linkMetric').hidden = true;
        }

        $('linkMaint').hidden = false;

        $('linkReq').href =
          `/Farm-vista/pages/equipment/actions/service-request.html?id=${encodeURIComponent(id)}${from ? `&from=${encodeURIComponent(from)}` : ''}`;

        // Service Records opens modal
        $('linkMaint').href = '#';
        $('linkMaint').onclick = (e)=>{ e.preventDefault(); openServiceRecords(); };

        if(!$('linkMetric').hidden){
          $('linkMetric').href = '#';
          $('linkMetric').onclick = (e)=>{
            e.preventDefault();
            openMetricModal(d, cfg, typeKey, db, ref);
          };
        }else{
          $('linkMetric').onclick = null;
        }

        if(typeKey === 'starfire'){
          setText('linkMetric', 'Update Location');
          $('linkMetric').hidden = false;
          $('linkMetric').href = `/Farm-vista/pages/equipment/actions/starfire-location.html?id=${encodeURIComponent(id)}`;
          $('linkMetric').onclick = null;
          $('linkMaint').hidden = true;
          if (calcCard) calcCard.hidden = true;
        } else {
          if (typeKey === 'combine' && calcCard) {
            const basePath   = '/Farm-vista/pages/calculators';
            $('linkCalcLoss').href  = `${basePath}/calc-combine-grain-loss.html?equipmentId=${encodeURIComponent(id)}`;
            $('linkCalcYieldCheck').href = `${basePath}/calc-combine-yield.html?equipmentId=${encodeURIComponent(id)}`;
            $('linkCalcYieldCal').href = `${basePath}/calc-combine-yield-calibration.html?equipmentId=${encodeURIComponent(id)}`;
            calcCard.hidden = false;
          } else if (calcCard) {
            calcCard.hidden = true;
          }
        }

        $('fnLinks').hidden = false;
      }

      setupReturnButtons(typeKey);
    }

    wireMetricModalButtons();
    wireServiceRecordsModalButtons();
    wireServiceRecordTap();

    init().catch(e=>{
      console.error('[hub] init fatal', e);
      clearTimeout(watchdog); finished=true; showContent();
      $('status').textContent='Error loading hub.'; $('status').hidden=false;
    });

    window.addEventListener('pageshow', (e)=>{ if(e.persisted) init(); });
    document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') init(); });
  </script>
</body>
</html>
