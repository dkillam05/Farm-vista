<!-- /Farm-vista/pages/equipment/actions/hub.html â€” INFO-ONLY HUB (Return-to-Tractors fully removed) -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista â€¢ Equipment Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>

  <!-- Theme + base app styles -->
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <!-- Ensure fv-shell -->
  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true; document.head.appendChild(s);
      }
    })();
  </script>

  <style>
    :root{ --card-max:900px; --brand:var(--green,#3B7E46); }
    body{ background:var(--app-bg,var(--surface)); }
    .wrap{ max-width:var(--card-max); margin:0 auto; padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px)+var(--ftr-h,42px)+64px)!important; }
    .hero{ border:1px solid var(--border); border-radius:14px; background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08)); overflow:hidden; margin:8px 0 18px; }
    .hero-head{ display:grid; grid-template-columns:36px 1fr; gap:12px; align-items:center;
      padding:14px 16px; border-bottom:1px solid var(--border);
      background:color-mix(in srgb,var(--brand) 12%,transparent); }
    .hero-head h1{ margin:0; font-size:clamp(20px,3.2vw,26px); }
    .muted{ color:var(--muted,#67706B) }
    .body{ padding:16px; display:grid; gap:18px }
    .card{ border:1px solid var(--border); border-radius:12px; background:var(--surface);
      padding:14px; display:grid; gap:6px }
    .meta{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .chip{ font-size:12px; border:1px solid var(--border); border-radius:999px;
      padding:4px 8px; background:var(--surface) }
    .actions{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px }
    @media (max-width:560px){ .actions{ grid-template-columns:1fr } }
    .btn{ display:inline-flex; align-items:center; justify-content:center;
      padding:12px 14px; border-radius:12px; border:1px solid var(--border);
      background:var(--card-surface,var(--surface)); font-weight:800;
      color:var(--text)!important; cursor:pointer; text-decoration:none; }
    .btn-primary{ border-color:transparent; background:var(--brand); color:#fff!important }

    /* Invalid QR modal */
    .modal-backdrop{ position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      z-index:99999; background:rgba(0,0,0,.45); }
    .modal-backdrop.show{ display:flex; }
    .modal-card{ width:min(420px,92vw); background:var(--surface); color:var(--text);
      border:1px solid var(--border); border-radius:16px; box-shadow:0 18px 60px rgba(0,0,0,.35); }
    .md-head{ padding:14px 16px; border-bottom:1px solid var(--border); font-weight:800; font-size:18px }
    .md-body{ padding:14px 16px; color:var(--muted,#67706B) }
    .md-foot{ padding:12px 16px; border-top:1px solid var(--border); display:flex; justify-content:flex-end }
  </style>
</head>

<body>
  <fv-shell>
    <div class="wrap">
      <section class="hero">
        <header class="hero-head">
          <div aria-hidden="true">ðŸ”—</div>
          <div>
            <h1>Equipment Hub</h1>
            <p class="muted" id="subtitle">Loadingâ€¦</p>
          </div>
        </header>

        <!-- Equipment block (valid equipment resolved) -->
        <div class="body" id="eqBlock" hidden>
          <div class="card">
            <h2 id="eqName" style="margin:0"></h2>
            <div class="meta">
              <span id="eqType" class="chip"></span>
              <span id="eqMakeModel" class="chip"></span>
              <span id="eqSerial" class="chip" hidden></span>
              <span id="eqHours" class="chip" hidden></span>
            </div>
            <p id="eqNotes" class="muted" hidden></p>
          </div>

          <!-- Only functional links -->
          <div class="actions">
            <a id="linkHours" class="btn btn-primary" href="#">Track Engine Hours</a>
            <a id="linkMaint" class="btn" href="#">Service Records</a>
            <a id="linkReq"   class="btn" href="#">Submit Service Request</a>
            <a id="linkPre"   class="btn" href="#">Pre-Season Checklist</a>
          </div>
        </div>

        <!-- Neutral block (no equipment context) -->
        <div class="body" id="neutralBlock" hidden>
          <div class="actions">
            <a class="btn" href="/Farm-vista/index.html">Return to Home</a>
          </div>
        </div>
      </section>
    </div>
  </fv-shell>

  <!-- Invalid QR modal -->
  <div id="badQR" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-card">
      <div class="md-head">Invalid QR for FarmVista</div>
      <div class="md-body">
        We couldnâ€™t open this code. It isnâ€™t linked to a piece of equipment. Please try scanning again.
      </div>
      <div class="md-foot">
        <button id="badQRClose" class="btn btn-primary" type="button">Close</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { ready, getFirestore, doc, getDoc } from '/Farm-vista/js/firebase-init.js';
    const $=id=>document.getElementById(id);
    const qs=new URLSearchParams(location.search);
    let idParam=qs.get('id')||'', token=qs.get('t')||'';

    if(!idParam){ const s=sessionStorage.getItem('fv.ctx.eqId'); if(s) idParam=s; }
    if(!token){ const t=sessionStorage.getItem('fv.ctx.eqTok'); if(t) token=t; }

    const fromScanFail=qs.get('qrError')==='1'||sessionStorage.getItem('fv.qrError')==='1';
    const setText=(id,v,o={})=>{const el=$(id);if(!el)return;
      if(!v){if(o.hideIfEmpty)el.hidden=true;else el.textContent='';return;}
      el.textContent=String(v);if(o.unhide)el.hidden=false;};
    const last6=v=>String(v||'').slice(-6);

    async function resolveIdByToken(db,t){
      try{const r=doc(db,'qr-tokens',t);const s=await getDoc(r);
        return s.exists()?(s.data()?.equipmentId||null):null;}catch{return null;}
    }

    function showInvalidModal(){
      const m=$('badQR');m.classList.add('show');m.setAttribute('aria-hidden','false');
      $('badQRClose').onclick=()=>{m.classList.remove('show');m.setAttribute('aria-hidden','true');
        sessionStorage.removeItem('fv.qrError');};
    }

    function showNeutral(){ $('neutralBlock').hidden=false; $('eqBlock').hidden=true;
      setText('subtitle','Ready'); }

    async function load(){
      setText('subtitle','Resolving equipmentâ€¦'); await ready;
      const db=getFirestore(); let eqId=idParam;
      if(!eqId&&token) eqId=await resolveIdByToken(db,token);
      if(!eqId){ if(fromScanFail) showInvalidModal(); showNeutral(); return; }

      const ref=doc(db,'equipment',eqId); const snap=await getDoc(ref);
      if(!snap.exists()){ if(fromScanFail) showInvalidModal(); showNeutral(); return; }

      const d=snap.data()||{}; const tokenOK=token?(d.qr&&d.qr.token===token):true;
      if(!tokenOK){ if(fromScanFail) showInvalidModal(); showNeutral(); return; }

      const type=d.type||'equipment';
      const mm=[d.makeName,d.modelName].filter(Boolean).join(' ');
      const ls=last6(d.serial);
      const title=mm?`${mm}${ls?` (#${ls})`:''}`:(d.name||`Unit ${String(eqId).slice(0,6)}`);

      setText('eqName',title); setText('eqType',type); setText('eqMakeModel',mm);
      if(ls) setText('eqSerial',`SN #${ls}`,{unhide:true});
      if(d.engineHours!=null) setText('eqHours',`${d.engineHours} hrs`,{unhide:true});
      if(d.notes) setText('eqNotes',d.notes,{unhide:true});

      const base="/Farm-vista/pages/equipment/actions";
      const tok=d.qr?.token||token||'';
      const q=`?id=${encodeURIComponent(eqId)}${tok?`&t=${encodeURIComponent(tok)}`:''}&from=hub`;
      $("linkHours").href=`${base}/engine-hours.html${q}`;
      $("linkMaint").href=`${base}/maintenance.html${q}`;
      $("linkReq").href=`${base}/service-request.html${q}`;
      $("linkPre").href=`${base}/pre-check.html${q}`;

      $('eqBlock').hidden=false; $('neutralBlock').hidden=true;
      setText('subtitle','Linked');
      sessionStorage.removeItem('fv.ctx.eqId');
      sessionStorage.removeItem('fv.ctx.eqTok');
    }

    load().catch(e=>{console.error(e);
      if(fromScanFail)showInvalidModal();showNeutral();});
  </script>
</body>
</html>