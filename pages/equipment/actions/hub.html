<!-- /Farm-vista/pages/equipment/actions/hub.html ‚Äî FULL FILE
     Adds:
       ‚Ä¢ Blur loading overlay (min 2s)
       ‚Ä¢ Empty-state when data can't be loaded
       ‚Ä¢ Archived-state when equipment is archived (no add actions)
       ‚Ä¢ Reveals hub actions only for active items
-->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista ‚Ä¢ Equipment Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>

  <!-- Theme + global CSS -->
  <script defer src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <style>
    :root{ --hub-max: 980px; }
    body{margin:0;background:var(--page-bg,#f6f7f6);}
    .page{max-width:var(--hub-max);margin:0 auto;padding:clamp(14px,3vw,22px);}
    .card{
      background:var(--card-surface,#fff);
      border-radius:18px;
      box-shadow:var(--elev-2,0 8px 24px rgba(0,0,0,.08));
      padding:clamp(14px,2.6vw,20px);
    }
    .card + .card{margin-top:16px;}

    .title{font-size:clamp(22px,2.6vw,28px);font-weight:800;color:var(--ink-1,#0f1a13);margin:0 0 8px;}
    .subtle{color:var(--ink-3,#6c756e);}

    .stack{display:grid;gap:14px;margin-top:14px;}
    .btn{
      display:block;width:100%;
      border:0;border-radius:14px;
      padding:16px 18px;
      background:var(--brand,#3B7E46);
      color:#fff;font-weight:800;font-size:18px;text-align:center;
    }
    .btn.ghost{background:#fff;color:var(--ink-1,#0f1a13);border:1px solid var(--line,#e6e7e6);}
    .btn.warn{background:#c23a2b;}
    .btn:active{transform:translateY(1px);}

    /* Overlay loader */
    .overlay{
      position:fixed;inset:0;z-index:50;display:none;align-items:center;justify-content:center;
      background:color-mix(in oklab, var(--ink-1,#0f1a13) 12%, transparent);
      backdrop-filter:blur(6px);
    }
    .overlay.show{display:flex;}
    .spinner{
      width:64px;height:64px;border-radius:50%;border:6px solid rgba(255,255,255,.35);
      border-top-color:#fff;animation:spin 1s linear infinite;margin:0 auto 14px;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    .overlay-box{
      width:min(92vw,460px);background:var(--card-surface,#fff);color:var(--ink-1,#0f1a13);
      border-radius:18px;padding:22px;text-align:center;box-shadow:var(--elev-3,0 10px 30px rgba(0,0,0,.12));
    }
    .overlay-title{font-weight:900;font-size:20px;margin:6px 0 2px;}
    .overlay-msg{color:var(--ink-3,#6c756e);font-size:15px;}

    /* Empty / Archived states */
    .empty,.arch{
      display:grid;justify-items:center;text-align:center;gap:8px;padding:24px 18px;
    }
    .emo{font-size:44px;line-height:1;margin-bottom:4px;filter:grayscale(.1);}
    .h{font-weight:900;font-size:20px;}
    .p{color:var(--ink-3,#6c756e);max-width:540px;}

    /* Visibility guards */
    .hub-actions[hidden],
    #emptyCard[hidden],
    #archivedCard[hidden]{display:none !important;}
  </style>
</head>
<body>
  <fv-shell app-title="FarmVista"></fv-shell>

  <main class="page">
    <!-- Summary -->
    <section class="card" id="summaryCard">
      <h1 class="title" id="hubTitle">Equipment Hub</h1>
      <p class="subtle" id="equipLine">Loading details‚Ä¶</p>
    </section>

    <!-- Actions (only when ACTIVE) -->
    <section class="card hub-actions" id="hubActions" hidden>
      <div class="stack">
        <a class="btn" id="btnHours">Track Engine Hours</a>
        <a class="btn ghost" id="btnService">Service Records</a>
        <a class="btn ghost" id="btnReq">Submit Service Request</a>
        <a class="btn ghost" id="btnPre">Pre-Season Checklist</a>
        <a class="btn ghost" href="/Farm-vista/pages/equipment/tractors.html">Return to Tractors</a>
        <a class="btn ghost" href="/Farm-vista/index.html">Return to Home</a>
      </div>
    </section>

    <!-- Empty (no data / load failed) -->
    <section class="card" id="emptyCard" hidden>
      <div class="empty">
        <div class="emo">üõ∞Ô∏è</div>
        <div class="h">We couldn‚Äôt load this equipment</div>
        <div class="p" id="emptyMsg">Either this QR isn‚Äôt linked yet or the network hiccupped.</div>
        <div class="stack" style="width:min(92vw,460px);">
          <button class="btn" id="btnTry">Try Again</button>
          <a class="btn ghost" href="/Farm-vista/pages/equipment/tractors.html">Return to Tractors</a>
          <a class="btn ghost" href="/Farm-vista/index.html">Return to Home</a>
        </div>
      </div>
    </section>

    <!-- Archived (no new entries allowed) -->
    <section class="card" id="archivedCard" hidden>
      <div class="arch">
        <div class="emo">üì¶</div>
        <div class="h">This equipment is archived</div>
        <div class="p" id="archivedMsg">
          This item isn‚Äôt available for new entries at this time. Please unarchive it in the Equipment list if you need to add updates.
        </div>
        <div class="stack" style="width:min(92vw,460px);">
          <a class="btn ghost" href="/Farm-vista/pages/equipment/tractors.html">Return to Tractors</a>
          <a class="btn ghost" href="/Farm-vista/index.html">Return to Home</a>
        </div>
      </div>
    </section>
  </main>

  <!-- Loading overlay -->
  <div class="overlay" id="loading">
    <div class="overlay-box">
      <div class="spinner" aria-hidden="true"></div>
      <div class="overlay-title">Loading‚Ä¶</div>
      <div class="overlay-msg">Finding your equipment by code.</div>
    </div>
  </div>

  <script>
    (function(){
      const qs = new URLSearchParams(location.search);
      const code = (qs.get('code') || '').trim();

      const loading = document.getElementById('loading');
      const emptyCard = document.getElementById('emptyCard');
      const archivedCard = document.getElementById('archivedCard');
      const hubActions = document.getElementById('hubActions');
      const equipLine = document.getElementById('equipLine');
      const hubTitle  = document.getElementById('hubTitle');
      const MIN_SPIN_MS = 2000;

      const btnHours = document.getElementById('btnHours');
      const btnService = document.getElementById('btnService');
      const btnReq = document.getElementById('btnReq');
      const btnPre = document.getElementById('btnPre');
      const btnTry = document.getElementById('btnTry');

      btnTry?.addEventListener('click', () => { showLoading(true); setTimeout(()=>location.reload(), 250); });

      function showLoading(on=true){
        loading.classList.toggle('show', on);
        document.body.style.overflow = on ? 'hidden' : '';
      }

      function setSummaryFromDoc(d){
        const type = (d.type || 'Equipment');
        const name = [d.make, d.model].filter(Boolean).join(' ');
        hubTitle.textContent = `${capitalize(type)} Hub`;
        equipLine.textContent = name ? `${name}${d.serialLast6 ? ' ‚Ä¢ SN ‚Ä¶'+d.serialLast6 : ''}` : 'Ready';
      }
      function capitalize(s){ return (s||'').charAt(0).toUpperCase() + (s||'').slice(1); }

      function showEmpty(reason){
        hubActions.hidden = true;
        archivedCard.hidden = true;
        emptyCard.hidden = false;
        equipLine.textContent = 'No equipment found for this code.';
        if(reason) document.getElementById('emptyMsg').textContent = reason;
      }
      function showArchived(d){
        hubActions.hidden = true;
        emptyCard.hidden = true;
        archivedCard.hidden = true; // toggle below after summary
        setSummaryFromDoc(d);
        document.getElementById('archivedMsg').textContent =
          `‚Äú${[d.make,d.model].filter(Boolean).join(' ')}${d.serialLast6 ? ' ‚Ä¢ SN ‚Ä¶'+d.serialLast6 : ''}‚Äù is archived and not available for new entries.`;
        archivedCard.hidden = false;
      }
      function showActive(d){
        emptyCard.hidden = true;
        archivedCard.hidden = true;
        setSummaryFromDoc(d);

        const id = d.id;
        btnHours.href   = `/Farm-vista/pages/equipment/actions/hours.html?id=${encodeURIComponent(id)}`;
        btnService.href = `/Farm-vista/pages/equipment/actions/service-records.html?id=${encodeURIComponent(id)}`;
        btnReq.href     = `/Farm-vista/pages/equipment/actions/service-request.html?id=${encodeURIComponent(id)}`;
        btnPre.href     = `/Farm-vista/pages/equipment/actions/preseason.html?id=${encodeURIComponent(id)}`;
        hubActions.hidden = false;
      }

      // Replace this with your data helper if you have one.
      async function fetchEquipmentByCode(qrCode){
        if(!(window.firebase && firebase.firestore)) throw new Error('Firebase not available');
        const db = firebase.firestore();
        const q = await db.collection('equipment').where('qr.code','==',qrCode).limit(1).get();
        if(q.empty) return null;
        const snap = q.docs[0];
        const d = snap.data() || {};
        d.id = snap.id;
        if(d.serial && typeof d.serial === 'string'){ d.serialLast6 = d.serial.slice(-6); }
        return d;
      }

      async function init(){
        const start = performance.now();
        showLoading(true);

        if(!code){
          const wait = Math.max(0, MIN_SPIN_MS - (performance.now()-start));
          return setTimeout(()=>{ showLoading(false); showEmpty('No QR code was provided.'); }, wait);
        }

        let doc=null, err=null;
        try{ doc = await fetchEquipmentByCode(code); }catch(e){ err = e; console.debug(e); }
        const wait = Math.max(0, MIN_SPIN_MS - (performance.now()-start));

        setTimeout(()=>{
          showLoading(false);
          if(err){ showEmpty('Something went wrong loading the details. Please try again.'); return; }
          if(!doc){ showEmpty('Either this QR isn‚Äôt linked yet or the connection hiccupped.'); return; }

          // Archived detection ‚Äî adjust to your schema if needed
          const isArchived = (String(doc.status||'').toLowerCase()==='archived') || (doc.archived===true);
          if(isArchived){ showArchived(doc); }
          else{ showActive(doc); }
        }, wait);
      }

      document.addEventListener('DOMContentLoaded', init);
    })();
  </script>
</body>
</html>
