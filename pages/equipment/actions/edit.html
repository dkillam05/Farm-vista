<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista • Edit Tractors</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>
  <script defer src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <!-- Ensure fv-shell -->
  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js'; s.defer=true; document.head.appendChild(s);
      }
    })();
  </script>

  <!-- Firebase CONFIG FIRST (matches your convention) -->
  <script src="/Farm-vista/js/firebase-config.js"></script>

  <style>
    :root{ --card-max:1100px; }
    html,body{ max-width:100vw; overflow-x:hidden; }
    body{ background:var(--app-bg, var(--bg)); color:var(--text); }

    .page{
      max-width:var(--card-max); margin:0 auto; padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + 96px)!important;
    }
    .title{ margin:0 0 4px; font-size:clamp(22px,3.6vw,32px); line-height:1.1; }
    .sub{ margin:0 10px 18px 0; color:var(--muted,#6f7772); }
    .toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:10px; }

    /* Search */
    .search{
      display:flex; align-items:center; gap:10px; border:1px solid var(--border);
      border-radius:12px; background:var(--surface); padding:10px 12px;
      min-width:min(340px, 100%);
      flex:1;
    }
    .search input{ flex:1; background:transparent; border:0; outline:none; font:inherit; color:var(--text); }

    /* Filter chip */
    .chip{
      display:inline-flex; align-items:center; gap:8px; border:1px solid var(--border);
      border-radius:999px; background:var(--surface); color:var(--text); padding:8px 12px; font-weight:800; cursor:pointer;
    }
    .chip .muted{ color:var(--muted); font-weight:600; }

    .count{ margin:10px 0; color:var(--muted,#6f7772); font-weight:700; }

    /* Cards (minimal list: make, model, #last6) */
    .group{ margin:14px 0; }
    .group h3{ margin:0 0 8px; color:var(--muted); font-weight:800; letter-spacing:.02em; }
    .card{
      border:1px solid var(--border);
      border-radius:16px;
      background:var(--surface);
      color:var(--text);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));
      padding:14px 16px; display:flex; align-items:center; justify-content:space-between; gap:10px;
      cursor:pointer;
    }
    .card:hover{ transform:translateY(-1px); box-shadow:0 12px 28px rgba(0,0,0,.12); }
    .card-title{ font-weight:800; font-size:16px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .badge{ font-size:12px; padding:4px 8px; border:1px solid var(--border); border-radius:999px; color:var(--muted); }

    /* Edit modal — dark theme compliant */
    dialog.sheet{
      width:min(740px, 92vw);
      border:1px solid var(--border);
      border-radius:16px;
      padding:0;
      background:var(--card-surface, var(--surface));
      color:var(--text);
      box-shadow:0 18px 40px rgba(0,0,0,.45);
    }
    .sheet::backdrop{ background:rgba(0,0,0,.55); }
    .sheet header{
      padding:14px 16px; border-bottom:1px solid var(--border);
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      background:var(--card-surface, var(--surface));
      color:var(--text);
    }
    .sheet .body{
      padding:14px 16px; max-height:70vh; overflow-y:auto; overflow-x:hidden; -webkit-overflow-scrolling:touch;
      background:var(--card-surface, var(--surface));
    }
    .sheet footer{
      padding:12px 16px; border-top:1px solid var(--border);
      display:flex; justify-content:flex-end; gap:8px; flex-wrap:wrap;
      background:var(--card-surface, var(--surface)); color:var(--text);
    }
    .kv{ display:grid; grid-template-columns:1fr 1fr; gap:10px 12px; }
    @media(max-width:700px){ .kv{ grid-template-columns:1fr } .kv div{ padding:2px 0 } }
    label{ font-size:13px; color:var(--muted); margin-bottom:6px; display:block; }
    input, select, textarea{
      width:100%; font:inherit; color:inherit; background:var(--surface);
      border:1px solid var(--border); border-radius:12px; padding:10px 12px;
    }
    textarea{ min-height:110px; resize:vertical; }

    .btn{
      display:inline-flex; align-items:center; gap:8px; border:1px solid var(--border); border-radius:12px;
      background:var(--surface); color:var(--text); padding:10px 14px; font-weight:800; cursor:pointer; text-decoration:none;
    }
    .btn[disabled]{ opacity:.55; pointer-events:none; }
    .btn-primary{ border-color:transparent; background:var(--brand-green,#3B7E46); color:#fff; }
    .btn-warn{ background:var(--brand-gold,#D0C542); color:#2b2b2b; border-color:var(--brand-gold,#D0C542); }
    .btn-danger{ background:#B3261E; color:#fff; border-color:#B3261E; }

    .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media(max-width:700px){ .row{ grid-template-columns:1fr } }

    .tip{ font-size:12px; color:var(--muted); margin-top:6px; }
    .ro input, .ro select, .ro textarea{ opacity:.7; pointer-events:none; }
  </style>
</head>
<body>
  <fv-shell>
    <div class="page">
      <h1 class="title">Edit Tractors</h1>
      <div class="toolbar">
        <div class="search" title="Search make, model, serial, notes…">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M21 21l-4.2-4.2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"/></svg>
          <input id="q" type="search" placeholder="Search tractors" autocomplete="off"/>
        </div>
        <button id="filterBtn" class="chip" type="button">
          <span>Filter:</span><span class="muted" id="filterLabel">Active</span>
        </button>
        <button id="sortBtn" class="chip" type="button">
          <span>Sort:</span><span class="muted" id="sortLabel">Make</span>
        </button>
      </div>

      <p id="count" class="count">0 entries</p>
      <div id="list"></div>
    </div>
  </fv-shell>

  <!-- Edit modal -->
  <dialog id="editDlg" class="sheet" aria-modal="true">
    <header>
      <strong id="dlgTitle">Edit Tractor</strong>
      <div style="display:flex; gap:8px; align-items:center">
        <span id="rolePill" class="badge">Checking permissions…</span>
        <button id="dlgClose" class="btn" type="button">Close</button>
      </div>
    </header>
    <div class="body">
      <div class="kv" id="formWrap">
        <div>
          <label for="mk">Make</label>
          <input id="mk" type="text" placeholder="e.g., John Deere"/>
        </div>
        <div>
          <label for="md">Model</label>
          <input id="md" type="text" placeholder="e.g., 8R 340"/>
        </div>

        <div>
          <label for="yr">Year</label>
          <input id="yr" type="text" inputmode="numeric" placeholder="e.g., 2021"/>
        </div>
        <div>
          <label for="sn">Serial (full)</label>
          <input id="sn" type="text" placeholder="Full serial"/>
          <div class="tip">Last 6 auto: <strong id="sn6">—</strong></div>
        </div>

        <div>
          <label for="st">Status</label>
          <select id="st">
            <option value="Active">Active</option>
            <option value="Archived">Archived</option>
            <option value="Out of Service">Out of Service</option>
          </select>
        </div>
        <div>
          <label for="hrs">Hours</label>
          <input id="hrs" type="number" min="0" step="1" placeholder="0"/>
        </div>

        <div class="row" style="grid-column:1/-1">
          <div>
            <label for="notes">Notes</label>
            <textarea id="notes" placeholder="Append a quick note…"></textarea>
            <div class="tip">Saving appends a new note entry instead of overwriting old notes.</div>
          </div>
        </div>
      </div>
    </div>
    <footer id="dlgFt">
      <button id="archiveBtn" class="btn btn-warn" type="button">Archive</button>
      <button id="deleteBtn" class="btn btn-danger" type="button" disabled>Delete</button>
      <button id="saveBtn" class="btn btn-primary" type="button">Save Changes</button>
    </footer>
  </dialog>

  <script type="module">
    import {
      ready,
      getFirestore, collection, doc, getDoc, getDocs, query, where, onSnapshot, setDoc, updateDoc, serverTimestamp, limit,
      arrayUnion
    } from '/Farm-vista/js/firebase-init.js';

    const $ = s=>document.querySelector(s);
    const list = $('#list');
    const countEl = $('#count');
    const qInput = $('#q');
    const filterBtn = $('#filterBtn');
    const sortBtn = $('#sortBtn');
    const filterLabel = $('#filterLabel');
    const sortLabel = $('#sortLabel');

    // Modal elements
    const dlg = $('#editDlg');
    const dlgTitle = $('#dlgTitle');
    const dlgClose = $('#dlgClose');
    const rolePill = $('#rolePill');

    // Form fields
    const f = {
      mk: $('#mk'), md: $('#md'), yr: $('#yr'), sn: $('#sn'), sn6: $('#sn6'),
      st: $('#st'), hrs: $('#hrs'), notes: $('#notes')
    };
    const saveBtn = $('#saveBtn');
    const archiveBtn = $('#archiveBtn');
    const deleteBtn = $('#deleteBtn');

    // App state
    let APP = { role:'', canAll:false, canEdit:false, orgId:null, user:null };
    let DATA = []; // tractors loaded
    let FILTER = 'Active'; // Active | Archived | All
    let SORT = 'Make';    // Make | Model | Hours | Updated | Last6
    let unsub = null;
    let currentId = null; // editing id
    let deleteClean = false; // delete eligibility

    // Helpers
    const safe = v => (v==null ? '' : String(v));
    const last6 = v => String(v||'').slice(-6).toUpperCase();
    const normStatus = v => String(v ?? 'active').toLowerCase();
    const isActive = d => {
      const s = normStatus(d.status);
      return s === 'active' || (d.active === true) || (d.status == null);
    };
    const isArchived = d => normStatus(d.status) === 'archived';
    const nameLine = d => {
      const mm = [d.make||d.makeName||'', d.model||d.modelName||''].filter(Boolean).join(' ').trim();
      const ls = last6(d.serial);
      return mm ? (ls ? `${mm} — #${ls}` : mm) : (ls ? `#${ls}` : '(tractor)');
    };

    function applyRole(){
      APP.canAll = ['Owner','Admin'].includes(APP.role);
      APP.canEdit = APP.canAll || APP.role==='Employee';
      rolePill.textContent = APP.canAll ? 'Owner/Admin' : (APP.canEdit ? 'Employee (limited)' : 'Read-only');

      // Footer buttons by role
      saveBtn.disabled = !APP.canEdit;
      archiveBtn.disabled = !APP.canEdit;
      deleteBtn.disabled = !APP.canAll || !deleteClean;
      // Read-only style on the form
      $('#formWrap').classList.toggle('ro', !APP.canEdit);
    }

    function groupRender(rows){
      countEl.textContent = `${rows.length}/${DATA.length} entries`;
      list.innerHTML = '';
      if(!rows.length){
        const p = document.createElement('p'); p.className='sub'; p.textContent='No matches.'; list.appendChild(p); return;
      }
      const by = {};
      rows.forEach(d=>{
        const n = nameLine(d); const k = (n||'?').charAt(0).toUpperCase(); (by[k] ||= []).push(d);
      });
      Object.keys(by).sort().forEach(letter=>{
        const wrap = document.createElement('div'); wrap.className='group';
        const h = document.createElement('h3'); h.textContent = letter; wrap.appendChild(h);
        by[letter].forEach(d=>{
          const card = document.createElement('div'); card.className='card'; card.setAttribute('role','button');
          const title = document.createElement('div'); title.className='card-title'; title.textContent = nameLine(d);
          const badge = document.createElement('span'); badge.className='badge'; badge.textContent = d.status||'Active';
          card.append(title, badge);
          card.addEventListener('click', ()=> openEditor(d.id));
          wrap.appendChild(card);
        });
        list.appendChild(wrap);
      });
    }

    function render(){
      const q = (qInput.value||'').toLowerCase().trim();
      let rows = DATA.filter(d=>{
        if(FILTER==='Active') return isActive(d);
        if(FILTER==='Archived') return isArchived(d);
        return true;
      }).filter(d=>{
        if(!q) return true;
        const blob = [
          nameLine(d), d.make, d.model, d.serial, d.year, d.notesText
        ].map(x=>String(x||'').toLowerCase()).join(' ');
        return blob.includes(q);
      });

      // sort
      rows.sort((a,b)=>{
        const ta = (a.updatedAt? a.updatedAt.toMillis?.()||a.updatedAt : 0);
        const tb = (b.updatedAt? b.updatedAt.toMillis?.()||b.updatedAt : 0);
        const a6 = (a.lastSix || last6(a.serial));
        const b6 = (b.lastSix || last6(b.serial));
        if(SORT==='Make'){
          const A = `${a.make||''}\u0000${a.model||''}\u0000${a6||''}`;
          const B = `${b.make||''}\u0000${b.model||''}\u0000${b6||''}`;
          return A.localeCompare(B);
        }
        if(SORT==='Model'){
          const A = `${a.model||''}\u0000${a.make||''}\u0000${a6||''}`;
          const B = `${b.model||''}\u0000${b.make||''}\u0000${b6||''}`;
          return A.localeCompare(B);
        }
        if(SORT==='Hours'){
          return (Number(b.hours||0) - Number(a.hours||0));
        }
        if(SORT==='Updated'){
          return (tb - ta);
        }
        if(SORT==='Last6'){
          return safe(a6).localeCompare(safe(b6));
        }
        return nameLine(a).localeCompare(nameLine(b));
      });

      groupRender(rows);
    }

    function toggleFilter(){
      FILTER = (FILTER==='Active') ? 'Archived' : (FILTER==='Archived' ? 'All' : 'Active');
      filterLabel.textContent = FILTER;
      render();
    }
    function toggleSort(){
      const order = ['Make','Model','Hours','Updated','Last6'];
      const i = order.indexOf(SORT);
      SORT = order[(i+1)%order.length];
      sortLabel.textContent = SORT === 'Last6' ? 'Last 6' : SORT;
      render();
    }

    async function attach(){
      if(unsub) return;
      const db = getFirestore();
      const qref = query(collection(db,'equipment'), where('type','==','tractor'));
      unsub = onSnapshot(qref, (snap)=>{
        const out=[];
        snap.forEach(docSnap=>{
          const d=docSnap.data()||{};
          const notesText = Array.isArray(d.notes) ? d.notes.map(n=>n.text).join(' ') : (d.notes||'');
          out.push({ id:docSnap.id, ...d, notesText });
        });
        DATA = out;
        render();
      }, (err)=> console.error('Tractors listener error:', err));
    }
    function detach(){ if (unsub){ try{unsub();}catch{}; unsub=null; } }

    function openModal(dlgEl){ try{ dlgEl.showModal(); }catch{ dlgEl.setAttribute('open',''); } }
    function closeModal(dlgEl){ try{ dlgEl.close(); }catch{ dlgEl.removeAttribute('open'); } }

    async function openEditor(id){
      currentId = id;
      deleteClean = false;
      deleteBtn.disabled = true;

      const db = getFirestore();
      const snap = await getDoc(doc(db,'equipment',id));
      if(!snap.exists()){
        alert('Tractor not found'); return;
      }
      const d = snap.data()||{};
      dlgTitle.textContent = nameLine(d);

      // Populate fields
      f.mk.value = d.make || d.makeName || '';
      f.md.value = d.model || d.modelName || '';
      f.yr.value = d.year || '';
      f.sn.value = d.serial || '';
      f.sn6.textContent = last6(d.serial);
      f.st.value = d.status || 'Active';
      f.hrs.value = d.hours ?? '';
      f.notes.value = '';

      // Archive button text
      archiveBtn.textContent = (f.st.value==='Archived') ? 'Unarchive' : 'Archive';

      // Role controls
      applyRole();

      // Pre-check delete eligibility (dependency guard)
      dependencyGuard(id).then(ok=>{
        deleteClean = ok;
        deleteBtn.disabled = !(APP.canAll && deleteClean);
      }).catch(()=>{ deleteClean=false; deleteBtn.disabled = true; });

      // Wire serial live last-6
      f.sn.oninput = ()=> (f.sn6.textContent = last6(f.sn.value||''));

      openModal(dlg);
    }

    async function dependencyGuard(equipmentId){
      const db = getFirestore();
      const checks = [
        ['equipmentLogs','equipmentId'],
        ['maintenance','equipmentId'],
        ['usage','equipmentId'],
        ['qrScans','equipmentId'],
      ].map(async ([c,field])=>{
        try{
          const qs = await getDocs(query(collection(db,c), where('orgId','==',APP.orgId), where(field,'==', equipmentId), limit(1)));
          return qs.size===0;
        }catch(_){ return false; } // fail closed
      });
      const rs = await Promise.all(checks);
      return rs.every(Boolean);
    }

    function collectPatch(){
      const make = f.mk.value.trim();
      const model = f.md.value.trim();
      const serial = f.sn.value.trim();
      const patch = {
        make, model,
        year: f.yr.value.trim(),
        serial, lastSix: last6(serial),
        status: f.st.value||'Active',
        hours: Number(f.hrs.value||0),
        updatedAt: serverTimestamp(),
        updatedBy: APP.user?.displayName || 'System'
      };
      const noteText = f.notes.value.trim();
      if(noteText){
        patch.notes = arrayUnion({
          text: noteText,
          authorName: APP.user?.displayName || 'Unknown',
          authorId: APP.user?.uid || null,
          ts: serverTimestamp()
        });
      }
      return patch;
    }
    function validate(p){
      if(!p.make) return 'Make is required.';
      if(!p.model) return 'Model is required.';
      if(!p.serial || p.serial.length<6) return 'Serial must be at least 6 characters.';
      if(p.hours<0) return 'Hours cannot be negative.';
      return '';
    }

    async function saveEdits(){
      if(!currentId) return;
      const db = getFirestore();
      const patch = collectPatch();
      const err = validate(patch);
      if(err){ alert(err); return; }

      // Employees can edit Hours + Notes only; Owners/Admins can edit all
      if(!APP.canAll && APP.canEdit){
        const limited = {
          hours: patch.hours,
          updatedAt: patch.updatedAt,
          updatedBy: patch.updatedBy
        };
        if(patch.notes) limited.notes = patch.notes;
        await setDoc(doc(db,'equipment',currentId), limited, { merge:true });
      }else if(APP.canAll){
        await setDoc(doc(db,'equipment',currentId), patch, { merge:true });
      }else{
        alert('Read-only.'); return;
      }
      f.notes.value='';
      alert('Saved ✓');
      closeModal(dlg);
    }

    async function toggleArchive(){
      if(!currentId) return;
      const db = getFirestore();
      const snap = await getDoc(doc(db,'equipment',currentId));
      if(!snap.exists()) return;
      const now = snap.data() || {};
      const nextStatus = (now.status==='Archived') ? 'Active' : 'Archived';
      await updateDoc(doc(db,'equipment',currentId), {
        status: nextStatus,
        updatedAt: serverTimestamp(),
        updatedBy: APP.user?.displayName || 'System'
      });
      alert(nextStatus==='Archived' ? 'Archived ✓' : 'Restored ✓');
      closeModal(dlg);
    }

    async function doDelete(){
      if(!currentId) return;
      if(!APP.canAll){ alert('Only Owner/Admin can delete.'); return; }
      if(!deleteClean){
        alert('This tractor is referenced by other data. Delete is blocked. Use Archive instead.');
        return;
      }
      const ok = confirm('Delete this tractor permanently? This cannot be undone.');
      if(!ok) return;
      const db = getFirestore();
      await updateDoc(doc(db,'equipment',currentId), { // soft delete fallback if rules block hard delete
        status: 'Archived',
        deletedAt: serverTimestamp(),
        updatedBy: APP.user?.displayName || 'System'
      }).catch(async ()=>{
        // If allowed, perform a hard delete:
        await (await import('/Farm-vista/js/firebase-init.js')).deleteDoc?.(doc(db,'equipment',currentId));
      });
      alert('Deleted (or archived) ✓');
      closeModal(dlg);
    }

    // Wire UI
    qInput.addEventListener('input', render);
    filterBtn.addEventListener('click', toggleFilter);
    sortBtn.addEventListener('click', toggleSort);
    dlgClose.addEventListener('click', ()=> closeModal(dlg));
    saveBtn.addEventListener('click', saveEdits);
    archiveBtn.addEventListener('click', toggleArchive);
    deleteBtn.addEventListener('click', doDelete);

    // Resume hooks
    function resume(){ if (!unsub) attach(); }
    window.addEventListener('pageshow', resume);
    document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') resume(); });
    window.addEventListener('focus', resume);
    window.addEventListener('pagehide', ()=>{ detach(); });

    // Boot
    (async()=>{
      await ready;
      // Resolve FVUserContext (provided by theme-boot)
      (function waitCtx(t0=Date.now()){
        if(window.FVUserContext && FVUserContext.orgId && FVUserContext.user){
          APP.user = FVUserContext.user;
          APP.orgId = FVUserContext.orgId;
          APP.role = FVUserContext.role || 'Employee';
          applyRole();
          attach();
        }else if(Date.now()-t0 > 6000){
          alert('Could not resolve account. Try reloading from Launch.');
        }else{
          setTimeout(()=>waitCtx(t0), 120);
        }
      })();
    })();
  </script>
</body>
</html>
