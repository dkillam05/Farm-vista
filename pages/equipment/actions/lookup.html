<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista • Equipment Lookup</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>
  <script defer src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <!-- Ensure fv-shell -->
  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js'; s.defer=true; document.head.appendChild(s);
      }
    })();
  </script>

  <!-- Firebase CONFIG FIRST -->
  <script src="/Farm-vista/js/firebase-config.js"></script>

  <style>
    :root{ --card-max:1100px; }

    /* ===== QL-820NWB / DK-2205 (62mm wide continuous) ===== */
    :root{
      --ql-tape-mm: 62mm;    /* fixed tape width = label HEIGHT */

      /* long strip defaults (non-starfire) */
      --ql-qr-mm: 48mm;
      --ql-pad-mm: 2.2mm;
      --ql-gap-mm: 2mm;

      --ql-font: 18pt;
      --ql-font-small: 16pt;
      --ql-font-lab: 12pt;

      /* starfire compact defaults */
      --sf-cut-mm: 62mm;      /* compact cut length */
      --sf-qr-mm: 46mm;       /* big QR */
      --sf-serial-font: 16pt;
      --sf-serial-font-sm: 13pt;
    }

    html,body{ max-width:100vw; overflow-x:hidden; }
    body{ background:var(--app-bg, var(--bg)); color:var(--text); }

    .page{
      max-width:var(--card-max); margin:0 auto; padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + 96px)!important;
    }
    .title{ margin:0 0 4px; font-size:clamp(22px,3.6vw,32px); line-height:1.1; }
    .sub{ margin:0 10px 12px 0; color:var(--muted,#6f7772); }

    /* Search row */
    .bar{ display:flex; gap:10px; align-items:center; }
    .search{
      display:flex; align-items:center; gap:10px; border:1px solid var(--border);
      border-radius:12px; background:var(--surface); padding:10px 12px; flex:1 1 auto;
    }
    .search input{ flex:1; background:transparent; border:0; outline:none; font:inherit; color:var(--text); }

    /* Filter icon button */
    .icon-btn{
      display:inline-flex; align-items:center; justify-content:center;
      width:42px; height:42px;
      border:1px solid var(--border); border-radius:12px;
      background:var(--surface); color:var(--text);
      cursor:pointer;
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.06));
    }
    .icon-btn:active{ transform:translateY(1px); }
    .icon-btn svg{ display:block }

    /* Popover – lowered z-index so header/footer win */
    .popover{
      position:absolute;
      z-index:5;
      min-width:220px;
      border:1px solid var(--border); border-radius:14px;
      background:var(--card-surface, var(--surface)); color:var(--text);
      box-shadow:0 18px 40px rgba(0,0,0,.28);
      padding:10px;
    }
    .popover header{ font-weight:800; margin:4px 2px 8px; color:var(--muted); }
    .opt{
      display:flex; align-items:center; gap:10px;
      padding:8px 10px; border-radius:10px; cursor:pointer;
    }
    .opt:hover{ background:var(--surface-2, rgba(127,127,127,.08)); }
    .opt input{ accent-color:var(--brand-green,#3B7E46); }

    .count{ margin:6px 0 10px; color:var(--muted,#6f7772); font-weight:700; }

    /* Cards */
    .group{ margin:14px 0; }
    .group h3{ margin:0 0 8px; color:var(--muted); font-weight:800; letter-spacing:.02em; }
    .card{
      border:1px solid var(--border);
      border-radius:16px;
      background:var(--surface);
      color:var(--text);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));
      padding:14px 16px; display:flex; align-items:center; justify-content:space-between; gap:12px;
      cursor:pointer;
    }
    .card:hover{ transform:translateY(-1px); box-shadow:0 12px 28px rgba(0,0,0,.12); }
    .card-title{ font-weight:800; font-size:16px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px; border-radius:999px; font-weight:800; font-size:12px;
      border:1px solid var(--border); background:var(--surface);
      color:var(--muted);
    }
    .badge.arch{ border-color:rgba(200,80,80,.35); color:rgba(200,80,80,.9); }

    /* Toast */
    .toast{
      position:fixed; left:50%; bottom:calc(env(safe-area-inset-bottom,0px) + 18px);
      transform:translateX(-50%); background:var(--surface); color:var(--text);
      border:1px solid var(--border); border-radius:12px; padding:10px 14px;
      box-shadow:0 10px 24px rgba(0,0,0,.18); z-index:9999; font-weight:800;
      max-width:min(560px, calc(100vw - 28px));
      text-align:center;
    }

    /* Detail modal */
    dialog.sheet{
      width:min(740px, 92vw);
      border:1px solid var(--border);
      border-radius:16px;
      padding:0;
      background:var(--card-surface, var(--surface));
      color:var(--text);
      box-shadow:0 18px 40px rgba(0,0,0,.45);
    }
    .sheet::backdrop{ background:rgba(0,0,0,.55); }
    .sheet header{
      padding:14px 16px; border-bottom:1px solid var(--border);
      display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap;
      background:var(--card-surface, var(--surface));
      color:var(--text);
    }
    .sheet .body{
      padding:14px 16px; max-height:70vh; overflow-y:auto; overflow-x:hidden; -webkit-overflow-scrolling:touch;
      background:var(--card-surface, var(--surface));
    }
    .kv{ display:grid; grid-template-columns:180px 1fr; gap:8px 12px; }
    @media(max-width:700px){ .kv{ grid-template-columns:1fr } .kv div{ padding:2px 0 } }
    .k{ font-weight:800; color:var(--brand-green,#3B7E46); }
    .v{ color:var(--text); }

    .qrbox{
      margin-top:14px; padding:14px; border:1px solid var(--border); border-radius:12px;
      display:grid; place-items:center; gap:10px; background:var(--surface);
    }
    .qrbox h4{ margin:0; font-size:16px; color:var(--text); }
    .qrbox img{
      display:block; width:min(220px, 70%); height:auto; image-rendering:crisp-edges; border-radius:8px;
      border:1px solid var(--border); background:#fff;
    }
    .qrnote{ margin:0; color:var(--muted); font-size:13px; }

    .sheet footer{
      padding:12px 16px; border-top:1px solid var(--border);
      display:flex; justify-content:flex-end; gap:8px; flex-wrap:wrap;
      background:var(--card-surface, var(--surface)); color:var(--text);
    }
    .btn{
      display:inline-flex; align-items:center; gap:8px; border:1px solid var(--border); border-radius:12px;
      background:var(--surface); color:var(--text); padding:10px 14px; font-weight:800; cursor:pointer; text-decoration:none;
    }
    .btn[disabled], .btn.disabled{ opacity:.55; pointer-events:none; }
    .btn-primary{ border-color:transparent; background:var(--brand-green,#3B7E46); color:#fff !important; }
    .btn-primary:visited{ color:#fff !important; }
    #openHub{ color:#fff !important; }
    #openHub:visited{ color:#fff !important; }

    /* ===== Print Preview ===== */
    dialog.sheet.sheet-print{ width:fit-content; max-width:calc(100vw - 24px); }
    dialog.sheet.sheet-print .body{
      width:fit-content; max-width:calc(100vw - 24px);
      overflow-x:auto; overflow-y:auto; -webkit-overflow-scrolling:touch;
    }
    .print-help{
      color:var(--muted,#6f7772);
      font-size:14px;
      line-height:1.35;
      margin:0 0 10px;
      max-width: min(560px, calc(100vw - 48px));
    }
    #printWrap{
      display:flex;
      width: 100%;
      max-width: calc(100vw - 48px);
      overflow-x:auto;
      overflow-y:hidden;
      -webkit-overflow-scrolling:touch;
      justify-content:flex-start;
      padding: 4px 2px 2px;
      box-sizing:border-box;
    }
    #printWrap.center{ justify-content:center; }
    #pPreviewHost{ flex: 0 0 auto; }

    .pv-long{
      width:140mm;
      height:var(--ql-tape-mm);
      border:1px dashed var(--border);
      border-radius:10px;
      background:#fff;
      color:#000;
      display:grid;
      grid-template-columns: max-content var(--ql-qr-mm) max-content;
      align-items:center;
      gap:var(--ql-gap-mm);
      padding:var(--ql-pad-mm);
      box-sizing:border-box;
      max-width:none !important;
      white-space:nowrap;
      overflow:visible;
    }
    .pv-long .left, .pv-long .right{
      display:flex; flex-direction:column; justify-content:center; min-width:max-content;
    }
    .pv-long .make{ font-weight:900; font-size:var(--ql-font); line-height:1.05; white-space:nowrap; }
    .pv-long .model{ font-weight:800; font-size:var(--ql-font-small); line-height:1.05; white-space:nowrap; margin-top:1mm; }
    .pv-long .mid{
      width:var(--ql-qr-mm); height:var(--ql-qr-mm);
      display:flex; align-items:center; justify-content:center; background:#fff;
    }
    .pv-long .mid img{ width:100%; height:100%; image-rendering:pixelated; display:block; }
    .pv-long .right{ align-items:flex-end; text-align:right; }
    .pv-long .lab{ font-weight:800; font-size:var(--ql-font-lab); line-height:1.05; opacity:.85; white-space:nowrap; }
    .pv-long .val{ font-weight:900; font-size:var(--ql-font); line-height:1.05; letter-spacing:.6px; margin-top:1mm; white-space:nowrap; }

    .pv-sf{
      width:var(--sf-cut-mm);
      height:var(--ql-tape-mm);
      border:1px dashed var(--border);
      border-radius:10px;
      background:#fff;
      color:#000;
      display:grid;
      grid-template-rows: var(--sf-qr-mm) 1fr;
      align-content:center;
      justify-items:center;
      gap: 2mm;
      padding: 2.2mm;
      box-sizing:border-box;
      overflow:hidden;
    }
    .pv-sf .qr{ width:var(--sf-qr-mm); height:var(--sf-qr-mm); display:flex; align-items:center; justify-content:center; background:#fff; }
    .pv-sf .qr img{ width:100%; height:100%; display:block; image-rendering:pixelated; }
    .pv-sf .serial{
      width:100%;
      text-align:center;
      font-weight:900;
      letter-spacing:.6px;
      line-height:1.05;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      font-size: var(--sf-serial-font);
    }
    .pv-sf .serial.small{ font-size: var(--sf-serial-font-sm); }
    #pPrint{ color:#fff !important; }
    #pPrint:visited{ color:#fff !important; }

    /* ✅ Hidden print iframe */
    #fv-print-frame{
      position:fixed;
      right:0;
      bottom:0;
      width:0;
      height:0;
      border:0;
      visibility:hidden;
    }
  </style>
</head>

<body>
  <fv-shell>
    <div class="page">
      <h1 id="pageTitle" class="title">Equipment Lookup</h1>
      <p id="subtitle" class="sub">Showing Active only. Search by make, model, serial, or year.</p>

      <div class="bar">
        <div class="search">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
            <path d="M21 21l-4.2-4.2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"/></svg>
          <input id="q" type="search" placeholder="Search" autocomplete="off"/>
        </div>

        <button id="filterBtn" class="icon-btn" aria-label="Filters" aria-haspopup="true" aria-expanded="false">
          <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M3 5h18l-7 8v5l-4 2v-7L3 5z" fill="currentColor"/>
          </svg>
        </button>
      </div>

      <div id="filterPop" class="popover" hidden>
        <header>Status</header>
        <label class="opt">
          <input type="radio" name="statusMode" value="active" checked/>
          <span>Active</span>
        </label>
        <label class="opt">
          <input type="radio" name="statusMode" value="archived"/>
          <span>Archived</span>
        </label>
        <label class="opt">
          <input type="radio" name="statusMode" value="all"/>
          <span>All</span>
        </label>
      </div>

      <p id="count" class="count">0 entries</p>
      <div id="list"></div>
    </div>
  </fv-shell>

  <iframe id="fv-print-frame"></iframe>

  <dialog id="detail" class="sheet" aria-modal="true">
    <header>
      <strong id="dTitle">Details</strong>
      <button id="dClose" class="btn" type="button">Close</button>
    </header>
    <div class="body">
      <div class="kv" id="dKV"></div>

      <div id="qrSection" class="qrbox" hidden>
        <h4>Equipment QR</h4>
        <img id="qrImg" alt="Equipment QR"/>
        <p id="qrLbl" class="qrnote"></p>
      </div>
    </div>
    <footer>
      <button id="btnPrintQR" class="btn" type="button" disabled>Reprint QR</button>
      <a id="openHub" class="btn btn-primary disabled" href="#" aria-disabled="true">Open Hub</a>
      <button id="dClose2" class="btn" type="button">Close</button>
    </footer>
  </dialog>

  <dialog id="printPrev" class="sheet sheet-print" aria-modal="true">
    <header>
      <strong id="pHdrTitle">Print QR Label</strong>
      <button id="pClose" class="btn" type="button">Close</button>
    </header>

    <div class="body">
      <p id="pHelp" class="print-help">
        Printer: <b>Brother QL-820NWB</b> • Tape: <b>DK-2205 (62mm / 2.4&quot; continuous)</b><br>
        ✅ Label length flexes to your text (up to <b>6&quot;</b>).
      </p>

      <div id="printWrap" aria-label="Preview scroller">
        <div id="pPreviewHost" aria-label="Label preview host"></div>
      </div>
    </div>

    <footer>
      <button id="pShare" class="btn" type="button">Share to Brother</button>
      <button id="pPrint" class="btn btn-primary" type="button">Print</button>
      <button id="pCancel" class="btn" type="button">Cancel</button>
    </footer>
  </dialog>

  <script type="module">
    import {
      ready,
      getFirestore, collection, query, where, onSnapshot
    } from '/Farm-vista/js/firebase-init.js';

    const $ = sel => document.querySelector(sel);
    const list = $('#list');
    const countEl = $('#count');
    const qInput = $('#q');
    const subtitle = $('#subtitle');
    const pageTitleEl = $('#pageTitle');

    const qs = new URLSearchParams(location.search);
    const TYPE = (qs.get('type') || 'tractor').toLowerCase();
    const IS_STARFIRE = TYPE === 'starfire';

    const TYPE_LABELS = {
      tractor:     { sing:'Tractor',        plural:'Tractors' },
      combine:     { sing:'Combine',        plural:'Combines' },
      sprayer:     { sing:'Sprayer',        plural:'Sprayers' },
      implement:   { sing:'Implement',      plural:'Implements' },
      fertilizer:  { sing:'Fertilizer',     plural:'Fertilizer Equipment' },
      truck:       { sing:'Truck',          plural:'Trucks' },
      trailer:     { sing:'Trailer',        plural:'Trailers' },
      construction:{ sing:'Construction',   plural:'Construction Equipment' },
      starfire:    { sing:'StarFire',       plural:'StarFire Receivers' }
    };
    function getTypeMeta(type){
      const meta = TYPE_LABELS[type] || {};
      const proper = type ? type.charAt(0).toUpperCase()+type.slice(1) : 'Equipment';
      return { type, sing: meta.sing || proper, plural: meta.plural || (proper.endsWith('s') ? proper : proper+'s') };
    }
    const TYPE_META = getTypeMeta(TYPE);

    document.title = `FarmVista • ${TYPE_META.plural}`;
    if (pageTitleEl) pageTitleEl.textContent = `${TYPE_META.sing} Lookup`;

    const filterBtn = $('#filterBtn');
    const filterPop = $('#filterPop');

    let DATA = [];
    let unsub = null;
    let mode = 'active';

    const last6 = v => String(v||'').slice(-6);
    const safe = v => (v==null ? '' : String(v));

    function toast(msg, ms=2200){
      const t = document.createElement('div');
      t.className='toast';
      t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(()=>{ try{ t.remove(); }catch{} }, ms);
    }

    function normStatus(d){
      const s = String((d && d.status != null ? d.status : '')||'').toLowerCase().trim();
      if (s === 'archived' || s === 'inactive') return 'archived';
      if (d && d.active === false) return 'archived';
      return 'active';
    }
    const isArchived = d => normStatus(d) === 'archived';

    const mmText = d => [safe(d.makeName), safe(d.modelName)].filter(Boolean).join(' ').trim();
    const displayLine = d => {
      const mm = mmText(d);
      const ls = last6(d.serial);
      const fallback = `(${TYPE_META.sing.toLowerCase()})`;
      return mm ? (ls ? `${mm} — #${ls}` : mm) : (ls ? `#${ls}` : fallback);
    };
    const titleFor = d => {
      const mm = mmText(d);
      const ls = last6(d.serial);
      const fallback = `(${TYPE_META.sing})`;
      return mm ? (ls ? `${mm} (#${ls})` : mm) : (d.name || fallback);
    };

    const hubUrl = (id) =>
      `${location.origin}/Farm-vista/pages/equipment/actions/hub.html?id=${encodeURIComponent(id)}`;

    function attach(){
      if (unsub) return;
      const db = getFirestore();
      const qref = query(collection(db,'equipment'), where('type','==', TYPE));
      unsub = onSnapshot(qref, (snap)=>{
        const out = [];
        snap.forEach(docSnap=>{
          const d = docSnap.data() || {};
          out.push({ id: docSnap.id, ...d });
        });
        out.sort((a,b)=> displayLine(a).localeCompare(displayLine(b)));
        DATA = out;
        render();
      }, (err)=> console.error(`${TYPE_META.plural} listener error:`, err));
    }
    function detach(){ if (unsub){ try{ unsub(); }catch{}; unsub = null; } }

    function render(){
      const q = (qInput.value || '').toLowerCase().trim();

      const statusFiltered = DATA.filter(d=>{
        if (mode === 'all') return true;
        return mode === 'archived' ? isArchived(d) : !isArchived(d);
      });

      const rows = statusFiltered.filter(d=>{
        if (!q) return true;
        const blob = [
          displayLine(d), d.makeName, d.modelName, d.serial, d.year, d.notes, d.starfireSerial
        ].map(x=>String(x||'').toLowerCase()).join(' ');
        return blob.includes(q);
      });

      subtitle.textContent =
        mode === 'all'
          ? `Showing Active + Archived. Search by make, model, serial, or year.`
        : mode === 'archived'
          ? `Showing Archived only. Search by make, model, serial, or year.`
          : `Showing Active only. Search by make, model, serial, or year.`;

      countEl.textContent = `${rows.length}/${statusFiltered.length} entries (${mode})`;
      list.innerHTML = '';

      if(!rows.length){
        const p = document.createElement('p');
        p.className='sub'; p.textContent='No matches.';
        list.appendChild(p);
        return;
      }

      const by = {};
      rows.forEach(d=>{
        const name = displayLine(d);
        const k = (name || '?').charAt(0).toUpperCase();
        (by[k] ||= []).push(d);
      });

      Object.keys(by).sort().forEach(letter=>{
        const wrap = document.createElement('div'); wrap.className='group';
        const h = document.createElement('h3'); h.textContent = letter; wrap.appendChild(h);
        by[letter].forEach(d=>{
          const card = document.createElement('div'); card.className='card'; card.setAttribute('role','button');

          const left = document.createElement('div'); left.style.display='flex';
          left.style.alignItems='center'; left.style.gap='10px'; left.style.minWidth='0';

          const title = document.createElement('div'); title.className='card-title'; title.textContent = displayLine(d);
          title.style.minWidth='0';

          left.append(title);

          const right = document.createElement('div'); right.style.display='flex'; right.style.gap='8px'; right.style.alignItems='center';

          if (isArchived(d)) {
            const badge = document.createElement('span');
            badge.className='badge arch';
            badge.textContent='Archived';
            right.append(badge);
          }

          card.append(left, right);
          card.addEventListener('click', ()=> openDetail(d));
          wrap.appendChild(card);
        });
        list.appendChild(wrap);
      });
    }

    // Detail modal
    const dlg = document.getElementById('detail');
    const dTitle = document.getElementById('dTitle');
    const dKV = document.getElementById('dKV');
    const btnHub = document.getElementById('openHub');
    const btnPrintQR = document.getElementById('btnPrintQR');
    const qrSection = document.getElementById('qrSection');
    const qrImg = document.getElementById('qrImg');
    const qrLbl = document.getElementById('qrLbl');

    btnHub.addEventListener('click', (e)=>{
      const href = btnHub.getAttribute('href') || '';
      if (!href.includes('id=')) e.preventDefault();
    });

    const closeDetail = ()=> { try{ dlg.close(); }catch{ dlg.removeAttribute('open'); } };
    document.getElementById('dClose').addEventListener('click', closeDetail);
    document.getElementById('dClose2').addEventListener('click', closeDetail);

    const has = v => !(v===undefined || v===null || v==='');
    function addRow(k, v){
      if(!has(v)) return;
      const K = document.createElement('div'); K.className='k'; K.textContent = k;
      const V = document.createElement('div'); V.className='v'; V.textContent = String(v);
      dKV.append(K,V);
    }

    function getQrUrl(d){
      try{
        if (!d || !d.qr) return '';
        const img = d.qr.image;
        if (!img) return '';
        if (typeof img === 'string') return img;
        if (typeof img.url === 'string') return img.url;
        return '';
      }catch{ return ''; }
    }

    // ===== Print Preview + Print Iframe preload =====
    const pDlg = document.getElementById('printPrev');
    const pHdrTitle = document.getElementById('pHdrTitle');
    const pHelp = document.getElementById('pHelp');
    const printWrap = document.getElementById('printWrap');
    const pHost = document.getElementById('pPreviewHost');
    const pClose = document.getElementById('pClose');
    const pCancel = document.getElementById('pCancel');
    const pPrint = document.getElementById('pPrint');
    const pShare = document.getElementById('pShare');

    const printFrame = document.getElementById('fv-print-frame');

    let __pendingPrint = null;
    let __labelLenMm = 90;
    let __previewQrSrc = '';
    let __rawQrUrl = '';

    const LABEL = { tapeWmm: 62, qrMm: 48, padMm: 2.2, gapMm: 2.0, minLenMm: 90, maxLenMm: 152.4 };
    const STARFIRE_LABEL = { tapeWmm: 62, cutLenMm: 62, qrMm: 46 };

    function clampLenMm(mm){
      let len = Math.max(LABEL.minLenMm, Math.min(LABEL.maxLenMm, mm));
      len = Math.round(len * 2) / 2;
      return len;
    }
    function normalizeSerial(s){ return String(s||'').trim().toUpperCase(); }
    function serialLast6(serial){
      const s = normalizeSerial(serial || '');
      if(!s) return '';
      return s.length <= 6 ? s : s.slice(-6);
    }
    function pickStarfireSerial(d){
      const raw = normalizeSerial(d?.starfireSerial || d?.serial || '');
      return raw || '';
    }

    function esc(s){
      return String(s||'').replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]));
    }

    function measureTextPxWithComputedStyle(text, styleRefEl){
      const cs = getComputedStyle(styleRefEl);
      const span = document.createElement('span');
      span.textContent = String(text ?? '');
      span.style.position = 'fixed';
      span.style.left = '-99999px';
      span.style.top = '-99999px';
      span.style.visibility = 'hidden';
      span.style.whiteSpace = 'nowrap';
      span.style.fontFamily = cs.fontFamily;
      span.style.fontSize = cs.fontSize;
      span.style.fontWeight = cs.fontWeight;
      span.style.letterSpacing = cs.letterSpacing;
      span.style.textTransform = cs.textTransform;
      document.body.appendChild(span);
      const w = span.getBoundingClientRect().width;
      span.remove();
      return w;
    }

    function pxPerMm(){ return 96 / 25.4; }
    function computeLongLenMmFromDOM({ makeEl, modelEl, labEl, valEl, makeName, modelName, serial6 }){
      const pmm = pxPerMm();

      const makeWpx  = measureTextPxWithComputedStyle(makeName || '', makeEl);
      const modelWpx = measureTextPxWithComputedStyle(modelName || '', modelEl);
      const leftWpx  = Math.max(makeWpx, modelWpx);

      const labText = 'VIN/Serial';
      const valText = serial6 || '';
      const labWpx = measureTextPxWithComputedStyle(labText, labEl);
      const valWpx = measureTextPxWithComputedStyle(valText, valEl);
      const rightWpx = Math.max(labWpx, valWpx);

      const leftMm  = leftWpx / pmm;
      const rightMm = rightWpx / pmm;

      const safetyMm = 6.0;
      const raw =
        (LABEL.padMm * 2) +
        (LABEL.gapMm * 2) +
        leftMm +
        LABEL.qrMm +
        rightMm +
        safetyMm;

      return clampLenMm(raw);
    }

    function clearPreviewHost(){
      pHost.innerHTML = '';
      __previewQrSrc = '';
      __rawQrUrl = '';
    }

    function writePrintFrame(html){
      const win = printFrame.contentWindow;
      const docu = printFrame.contentDocument || win.document;
      docu.open();
      docu.write(html);
      docu.close();
    }

    function buildLabelPrintHtml(payload){
      const isSF = !!payload?.isStarfire;
      const qrSrc = String(payload?.qrSrc || payload?.url || '');
      const serialRaw = String(payload?.serial || '');
      const makeName = String(payload?.make || '');
      const modelName = String(payload?.model || '');

      if (isSF){
        const W = STARFIRE_LABEL.cutLenMm;
        const H = STARFIRE_LABEL.tapeWmm;
        const Q = STARFIRE_LABEL.qrMm;
        const fontSize = (serialRaw && serialRaw.length > 12) ? '13pt' : '16pt';

        return `<!doctype html>
<html><head><meta charset="utf-8">
<title>Print StarFire Label</title>
<style>
@page{ size:${W}mm ${H}mm; margin:0; }
html,body{ margin:0; padding:0; width:${W}mm; height:${H}mm; background:#fff; }
.label{
  width:${W}mm; height:${H}mm; box-sizing:border-box; padding:2.2mm;
  display:grid; grid-template-rows:${Q}mm 1fr; align-content:center; justify-items:center;
  gap:2mm; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:#000; overflow:hidden;
}
.qr{ width:${Q}mm; height:${Q}mm; display:flex; align-items:center; justify-content:center; }
.qr img{ width:100%; height:100%; display:block; image-rendering:pixelated; }
.serial{
  width:100%; text-align:center; font-weight:900; letter-spacing:.6px; line-height:1.05;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-size:${fontSize};
}
</style></head>
<body>
  <div class="label">
    <div class="qr"><img alt="QR" src="${qrSrc}"></div>
    <div class="serial">${esc(serialRaw || '—')}</div>
  </div>
</body></html>`;
      }

      const cutLen = Number(payload?.cutLenMm || __labelLenMm || LABEL.minLenMm);
      const W = cutLen;
      const H = LABEL.tapeWmm;
      const Q = LABEL.qrMm;
      const serial6 = serialLast6(serialRaw) || '';

      return `<!doctype html>
<html><head><meta charset="utf-8">
<title>Print Label</title>
<style>
@page{ size:${W}mm ${H}mm; margin:0; }
html,body{ margin:0; padding:0; width:${W}mm; height:${H}mm; background:#fff; }
.label{
  width:${W}mm; height:${H}mm; box-sizing:border-box; padding:2.2mm;
  display:grid; grid-template-columns:max-content ${Q}mm max-content;
  gap:2mm; align-items:center;
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; color:#000; overflow:hidden;
}
.left,.right{ display:flex; flex-direction:column; justify-content:center; min-width:max-content; }
.make{ font-weight:900; font-size:18pt; line-height:1.05; white-space:nowrap; }
.model{ font-weight:800; font-size:16pt; line-height:1.05; white-space:nowrap; margin-top:1mm; }
.mid{ width:${Q}mm; height:${Q}mm; display:flex; align-items:center; justify-content:center; }
.mid img{ width:100%; height:100%; display:block; image-rendering:pixelated; }
.right{ align-items:flex-end; text-align:right; }
.lab{ font-weight:800; font-size:12pt; line-height:1.05; opacity:.85; white-space:nowrap; }
.val{ font-weight:900; font-size:18pt; line-height:1.05; letter-spacing:.6px; margin-top:1mm; white-space:nowrap; }
</style></head>
<body>
  <div class="label">
    <div class="left">
      <div class="make">${esc(makeName) || '—'}</div>
      <div class="model">${esc(modelName) || '—'}</div>
    </div>
    <div class="mid"><img alt="QR" src="${qrSrc}"></div>
    <div class="right">
      <div class="lab">VIN/Serial</div>
      <div class="val">${esc(serial6) || '—'}</div>
    </div>
  </div>
</body></html>`;
    }

    // ===== Share support + CORS-safe fallback =====
    function canShare(){
      return !!navigator.share;
    }

    function isLikelyCorsCanvasError(err){
      const msg = String(err?.message || err || '');
      return msg.toLowerCase().includes('image load failed')
          || msg.toLowerCase().includes('cors')
          || msg.toLowerCase().includes('tainted')
          || msg.toLowerCase().includes('failed');
    }

    function waitImage(img){
      return new Promise((resolve, reject)=>{
        if (!img) return reject(new Error('No image'));
        if (img.complete && img.naturalWidth > 0) return resolve();
        const onLoad = ()=>{ cleanup(); resolve(); };
        const onErr = ()=>{ cleanup(); reject(new Error('Image load failed')); };
        const cleanup = ()=>{ img.removeEventListener('load', onLoad); img.removeEventListener('error', onErr); };
        img.addEventListener('load', onLoad, { once:true });
        img.addEventListener('error', onErr, { once:true });
      });
    }

    async function loadImageToCanvasSource(src){
      const img = new Image();
      img.decoding = 'async';
      // This DOES NOT bypass CORS; it only lets canvas use it IF the server sends CORS headers.
      img.crossOrigin = 'anonymous';
      img.src = src;
      await waitImage(img);
      return img;
    }

    function mmToPx(mm, dpi){
      const ppmm = dpi / 25.4;
      return Math.round(mm * ppmm);
    }

    async function buildLabelPngBlob(payload){
      const dpi = 300;
      const isSF = !!payload?.isStarfire;

      if (isSF){
        const Wmm = STARFIRE_LABEL.cutLenMm;
        const Hmm = STARFIRE_LABEL.tapeWmm;
        const Qmm = STARFIRE_LABEL.qrMm;

        const W = mmToPx(Wmm, dpi);
        const H = mmToPx(Hmm, dpi);
        const pad = mmToPx(2.2, dpi);
        const gap = mmToPx(2.0, dpi);
        const Q = mmToPx(Qmm, dpi);

        const canvas = document.createElement('canvas');
        canvas.width = W;
        canvas.height = H;
        const ctx = canvas.getContext('2d', { alpha:false });

        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0,0,W,H);

        const qrSrc = String(payload?.qrSrc || payload?.url || '');
        const img = await loadImageToCanvasSource(qrSrc);
        const qrX = Math.round((W - Q)/2);
        const qrY = pad;
        ctx.imageSmoothingEnabled = false;
        ctx.drawImage(img, qrX, qrY, Q, Q);

        const serial = String(payload?.serial || '').trim() || '—';
        const fontPt = (serial.length > 12) ? 13 : 16;
        const fontPx = Math.round((fontPt / 72) * dpi);
        ctx.fillStyle = '#000000';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.font = `900 ${fontPx}px system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif`;

        const textY = qrY + Q + gap + Math.round((H - (qrY + Q + gap))/2);
        const maxW = W - pad*2;
        let s = serial;
        while (ctx.measureText(s).width > maxW && s.length > 4){
          s = s.slice(0, -2) + '…';
        }
        ctx.fillText(s, Math.round(W/2), Math.min(H - pad - Math.round(fontPx/2), Math.max(qrY + Q + gap + Math.round(fontPx/2), textY)));

        return await new Promise((resolve)=> canvas.toBlob(b=>resolve(b), 'image/png'));
      }

      const cutLenMm = Number(payload?.cutLenMm || __labelLenMm || LABEL.minLenMm);
      const Wmm = cutLenMm;
      const Hmm = LABEL.tapeWmm;
      const Qmm = LABEL.qrMm;

      const W = mmToPx(Wmm, dpi);
      const H = mmToPx(Hmm, dpi);

      const pad = mmToPx(2.2, dpi);
      const gap = mmToPx(2.0, dpi);
      const Q = mmToPx(Qmm, dpi);

      const canvas = document.createElement('canvas');
      canvas.width = W;
      canvas.height = H;
      const ctx = canvas.getContext('2d', { alpha:false });

      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0,0,W,H);

      const make = String(payload?.make || '').trim() || '—';
      const model = String(payload?.model || '').trim() || '—';
      const serial6 = serialLast6(payload?.serial || '') || '—';

      const makePt = 18, modelPt = 16, labPt = 12, valPt = 18;
      const makePx = Math.round((makePt/72)*dpi);
      const modelPx = Math.round((modelPt/72)*dpi);
      const labPx = Math.round((labPt/72)*dpi);
      const valPx = Math.round((valPt/72)*dpi);

      const makeFont = `900 ${makePx}px system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif`;
      const modelFont = `800 ${modelPx}px system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif`;
      const labFont = `800 ${labPx}px system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif`;
      const valFont = `900 ${valPx}px system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif`;

      ctx.font = makeFont; const makeW = ctx.measureText(make).width;
      ctx.font = modelFont; const modelW = ctx.measureText(model).width;
      let leftW = Math.max(makeW, modelW);

      ctx.font = labFont; const labW = ctx.measureText('VIN/Serial').width;
      ctx.font = valFont; const valW = ctx.measureText(serial6).width;
      const rightW = Math.max(labW, valW);

      const availableLeft = W - (pad + gap + Q + gap + rightW + pad);
      const leftMax = Math.max(10, availableLeft);

      function ellipsize(text, font, maxWidth){
        ctx.font = font;
        if (ctx.measureText(text).width <= maxWidth) return text;
        let t = text;
        while (t.length > 4 && ctx.measureText(t + '…').width > maxWidth){
          t = t.slice(0, -1);
        }
        return t.length <= 4 ? '…' : (t + '…');
      }

      const makeDraw = ellipsize(make, makeFont, leftMax);
      const modelDraw = ellipsize(model, modelFont, leftMax);

      ctx.font = makeFont; const makeW2 = ctx.measureText(makeDraw).width;
      ctx.font = modelFont; const modelW2 = ctx.measureText(modelDraw).width;
      leftW = Math.max(makeW2, modelW2);

      const leftX = pad;
      const qrX = Math.round(pad + leftW + gap);
      const qrY = Math.round((H - Q)/2);

      const lineGap = mmToPx(1.0, dpi);
      const totalTextH = makePx + lineGap + modelPx;
      const textTop = Math.round((H - totalTextH)/2);

      ctx.fillStyle = '#000';
      ctx.textAlign = 'left';
      ctx.textBaseline = 'top';

      ctx.font = makeFont;
      ctx.fillText(makeDraw, leftX, textTop);

      ctx.font = modelFont;
      ctx.fillText(modelDraw, leftX, textTop + makePx + lineGap);

      const qrSrc = String(payload?.qrSrc || payload?.url || '');
      const img = await loadImageToCanvasSource(qrSrc);
      ctx.imageSmoothingEnabled = false;
      ctx.drawImage(img, qrX, qrY, Q, Q);

      const rightStartX = Math.round(qrX + Q + gap);
      const rightTop = Math.round((H - (labPx + lineGap + valPx))/2);

      ctx.textAlign = 'right';
      ctx.textBaseline = 'top';
      ctx.font = labFont;
      ctx.globalAlpha = 0.85;
      ctx.fillText('VIN/Serial', Math.min(W - pad, rightStartX + rightW), rightTop);

      ctx.globalAlpha = 1.0;
      ctx.font = valFont;
      ctx.fillText(serial6, Math.min(W - pad, rightStartX + rightW), rightTop + labPx + lineGap);

      return await new Promise((resolve)=> canvas.toBlob(b=>resolve(b), 'image/png'));
    }

    async function shareToBrother(payload){
      try{
        toast('Preparing share…', 900);

        const blob = await buildLabelPngBlob(payload);
        if (!blob) throw new Error('Could not build PNG');

        const base =
          payload.isStarfire
            ? `StarFire-${String(payload.serial||'').trim() || 'label'}`
            : `${String(payload.make||'').trim() || 'Equip'}-${String(payload.model||'').trim() || 'QR'}-${serialLast6(payload.serial||'') || 'label'}`;

        const safeName = String(base).replace(/[^a-z0-9\-_]+/gi,'_').slice(0,60);
        const file = new File([blob], `${safeName}.png`, { type:'image/png' });

        if (!navigator.share) {
          // desktop fallback
          const url = URL.createObjectURL(file);
          window.open(url, '_blank', 'noopener');
          toast('Opened PNG in a new tab (desktop).');
          return;
        }

        if (navigator.canShare){
          const ok = navigator.canShare({ files:[file] });
          if (!ok) throw new Error('Share sheet does not accept files');
        }

        await navigator.share({
          title: 'FarmVista QR Label',
          text: 'QR label image (PNG)',
          files: [file]
        });
      }catch(err){
        console.warn('[equipment-label] share failed', err);

        // ✅ CORS/workaround fallback:
        if (isLikelyCorsCanvasError(err) && __rawQrUrl){
          toast('CORS blocked PNG. Sharing QR link instead…', 1400);

          // Try sharing a URL (Brother may accept, or you can open it then share from viewer)
          if (navigator.share){
            try{
              await navigator.share({
                title: 'Equipment QR',
                text: 'QR image link',
                url: __rawQrUrl
              });
              return;
            }catch(e2){
              console.warn('[equipment-label] url share failed', e2);
            }
          }

          // Last fallback: open QR image in new tab
          window.open(__rawQrUrl, '_blank', 'noopener');
          toast('Opened QR image. Share it from the viewer / Brother app.');
          return;
        }

        toast('Share failed. (Most likely Storage CORS).');
      }
    }

    async function setPreview(payload){
      const isSF = !!payload?.isStarfire;
      const qrUrl = payload?.url || '';
      __rawQrUrl = qrUrl || '';

      printWrap.classList.toggle('center', isSF);

      const bust = (qrUrl && qrUrl.includes('?') ? '&' : '?') + '_=' + Date.now();
      const qrSrc = qrUrl ? (qrUrl + bust) : '';

      clearPreviewHost();

      if (isSF){
        pHdrTitle.textContent = 'Print StarFire QR Label';
        pHelp.innerHTML = `Printer: <b>Brother QL-820NWB</b> • Tape: <b>DK-2205</b><br>✅ Compact StarFire label.`;

        document.documentElement.style.setProperty('--sf-cut-mm', `${STARFIRE_LABEL.cutLenMm}mm`);
        document.documentElement.style.setProperty('--sf-qr-mm', `${STARFIRE_LABEL.qrMm}mm`);

        const serialTxt = (payload?.serial || '') || '—';

        const wrap = document.createElement('div');
        wrap.className = 'pv-sf';

        const q = document.createElement('div');
        q.className = 'qr';
        const img = document.createElement('img');
        img.alt = 'QR';
        img.src = qrSrc;
        q.appendChild(img);

        const s = document.createElement('div');
        s.className = 'serial' + (String(serialTxt).length > 12 ? ' small' : '');
        s.textContent = serialTxt;

        wrap.append(q, s);
        pHost.appendChild(wrap);

        __previewQrSrc = img.src || qrSrc;

        writePrintFrame(buildLabelPrintHtml({
          isStarfire:true,
          url: qrUrl,
          qrSrc: __previewQrSrc,
          serial: payload?.serial || ''
        }));

        return;
      }

      pHdrTitle.textContent = 'Print QR Label';
      pHelp.innerHTML = `Printer: <b>Brother QL-820NWB</b> • Tape: <b>DK-2205</b><br>✅ Long label for equipment.`;

      const makeName = payload?.make || '—';
      const modelName = payload?.model || '—';
      const serial6 = serialLast6(payload?.serial) || '—';

      const wrap = document.createElement('div');
      wrap.className = 'pv-long';
      wrap.style.width = `${LABEL.minLenMm}mm`;
      wrap.style.height = `${LABEL.tapeWmm}mm`;

      const left = document.createElement('div');
      left.className = 'left';
      const mk = document.createElement('div');
      mk.className = 'make';
      mk.textContent = makeName;
      const md = document.createElement('div');
      md.className = 'model';
      md.textContent = modelName;
      left.append(mk, md);

      const mid = document.createElement('div');
      mid.className = 'mid';
      const img = document.createElement('img');
      img.alt = 'QR';
      img.src = qrSrc;
      mid.appendChild(img);

      const right = document.createElement('div');
      right.className = 'right';
      const lab = document.createElement('div');
      lab.className = 'lab';
      lab.textContent = 'VIN/Serial';
      const val = document.createElement('div');
      val.className = 'val';
      val.textContent = serial6;
      right.append(lab, val);

      wrap.append(left, mid, right);
      pHost.appendChild(wrap);

      await new Promise(r=>requestAnimationFrame(()=>requestAnimationFrame(r)));
      __labelLenMm = computeLongLenMmFromDOM({
        makeEl: mk,
        modelEl: md,
        labEl: lab,
        valEl: val,
        makeName,
        modelName,
        serial6
      });

      wrap.style.width = `${__labelLenMm}mm`;
      wrap.style.height = `${LABEL.tapeWmm}mm`;

      __previewQrSrc = img.src || qrSrc;

      writePrintFrame(buildLabelPrintHtml({
        isStarfire:false,
        url: qrUrl,
        qrSrc: __previewQrSrc,
        make: makeName,
        model: modelName,
        serial: payload?.serial || '',
        cutLenMm: __labelLenMm
      }));
    }

    function openReprintPreview(payload){
      __pendingPrint = payload || null;
      if(!__pendingPrint) return;
      try{ pDlg.showModal(); }catch{ pDlg.setAttribute('open',''); }
      setPreview(__pendingPrint);
    }
    function closeReprintPreview(){
      __pendingPrint = null;
      clearPreviewHost();
      printWrap.classList.remove('center');
      try{ pDlg.close(); }catch{ pDlg.removeAttribute('open'); }
    }
    pClose.addEventListener('click', closeReprintPreview);
    pCancel.addEventListener('click', closeReprintPreview);

    pPrint.addEventListener('click', ()=>{
      try{
        const win = printFrame.contentWindow;
        if (!win) return;
        win.focus();
        win.print();
      }catch(err){
        console.warn('[equipment-label] print failed', err);
      }
      setTimeout(()=>closeReprintPreview(), 50);
    });

    pShare.addEventListener('click', async ()=>{
      if (!__pendingPrint) return;
      const payload = {
        ...__pendingPrint,
        qrSrc: __previewQrSrc || __pendingPrint.qrSrc || __pendingPrint.url || '',
        cutLenMm: __pendingPrint.isStarfire ? STARFIRE_LABEL.cutLenMm : (__labelLenMm || LABEL.minLenMm)
      };
      await shareToBrother(payload);
    });

    function openDetail(d){
      btnHub.classList.add('disabled');
      btnHub.setAttribute('aria-disabled','true');
      btnHub.setAttribute('href','#');

      dTitle.textContent = titleFor(d);
      dKV.innerHTML = '';
      addRow('Type', TYPE_META.sing);
      addRow('Make', d.makeName);
      addRow('Model', d.modelName);
      addRow('Year', d.year);

      const ls = last6(d.serial);
      if(ls) addRow('Serial (last 6)', ls);

      addRow('Notes', d.notes);

      btnHub.href = hubUrl(d.id);
      btnHub.classList.remove('disabled');
      btnHub.removeAttribute('aria-disabled');

      const url = getQrUrl(d);
      const labelText = [safe(d.modelName)].filter(Boolean).join(' ') + (ls ? ` - #${ls}` : '');
      if (url){
        const bust = (url.includes('?') ? '&' : '?') + '_=' + Date.now();
        qrImg.src = url + bust;
        qrImg.alt = `QR for ${labelText || TYPE_META.sing}`;
        qrLbl.textContent = labelText || TYPE_META.sing;
        qrSection.hidden = false;
        btnPrintQR.disabled = false;

        btnPrintQR.onclick = ()=>{
          if (IS_STARFIRE){
            const sfSerial = pickStarfireSerial(d);
            openReprintPreview({
              isStarfire: true,
              url,
              serial: sfSerial || (d.serial || '')
            });
          } else {
            openReprintPreview({
              isStarfire: false,
              url,
              make: d.makeName || '',
              model: d.modelName || '',
              serial: d.serial || ''
            });
          }
        };
      } else {
        qrImg.removeAttribute('src');
        qrLbl.textContent = 'No QR image saved for this equipment.';
        qrSection.hidden = false;
        btnPrintQR.disabled = true;
        btnPrintQR.onclick = null;
      }

      try{ dlg.showModal(); }catch{ dlg.setAttribute('open',''); }
    }

    // Filter popover logic
    function openPop(){
      if (!filterPop.hidden) return;
      const r = filterBtn.getBoundingClientRect();
      filterPop.style.top = `${r.bottom + window.scrollY + 8}px`;
      const maxLeft = window.scrollX + document.documentElement.clientWidth - 12 - 220;
      const desiredLeft = r.right + window.scrollX - 220;
      filterPop.style.left = `${Math.max(12, Math.min(maxLeft, desiredLeft))}px`;
      filterPop.hidden = false;
      filterBtn.setAttribute('aria-expanded','true');
    }
    function closePop(){
      if (filterPop.hidden) return;
      filterPop.hidden = true;
      filterBtn.setAttribute('aria-expanded','false');
    }
    filterBtn.addEventListener('click', (e)=>{
      e.stopPropagation();
      if (filterPop.hidden) openPop(); else closePop();
    });
    document.addEventListener('click', (e)=>{
      if (!filterPop.hidden && !filterPop.contains(e.target) && e.target !== filterBtn) closePop();
    });
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closePop(); });
    window.addEventListener('scroll', () => { if (!filterPop.hidden) closePop(); }, { passive:true });

    filterPop.addEventListener('change', (e)=>{
      if (e.target && e.target.name === 'statusMode') {
        mode = e.target.value;
        render();
        closePop();
      }
    });
    function syncRadios(){
      const r = filterPop.querySelector(`input[name="statusMode"][value="${mode}"]`);
      if (r) r.checked = true;
    }

    function resume(){ if (!unsub) attach(); }

    (async()=>{
      await ready;
      attach();
      syncRadios();
      qInput.addEventListener('input', render);
      window.addEventListener('pageshow', resume);
      document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='visible') resume(); });
      window.addEventListener('focus', resume);
      window.addEventListener('pagehide', ()=>{ detach(); });
    })();
  </script>
</body>
</html>
