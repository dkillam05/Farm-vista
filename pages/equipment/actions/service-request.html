<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>FarmVista • Submit Service Request</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#3B7E46"/>

  <!-- Standard includes (ABSOLUTE paths) -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <!-- IMPORTANT: Firebase CONFIG (needed or equipment load fails) -->
  <script src="/Farm-vista/js/firebase-config.js"></script>

  <!-- Ensure fv-shell -->
  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true; document.head.appendChild(s);
      }
    })();
  </script>

  <style>
    :root{
      --card-max:900px;
      --brand:var(--green,#3B7E46);
    }
    body{
      background:var(--app-bg,var(--surface));
      margin:0;
    }
    .wrap{
      max-width:var(--card-max);
      margin:0 auto;
      padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px)+72px)!important;
    }
    .hero{
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));
      overflow:hidden;
      margin:8px 0 18px;
    }
    .hero-head{
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      background:color-mix(in srgb,var(--brand) 10%, transparent);
    }
    .hero-head h1{
      margin:0;
      font-size:clamp(20px,3.1vw,26px);
    }
    .muted{
      color:var(--muted,#67706B);
      font-size:13px;
      margin-top:4px;
    }
    .body{
      padding:16px;
      display:grid;
      gap:18px;
    }
    .eq-summary{
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--surface-soft,var(--surface));
      padding:14px;
      display:grid;
      gap:6px;
    }
    .eq-title{
      font-weight:800;
      font-size:16px;
      margin:0;
    }
    .eq-chips{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:4px;
    }
    .chip{
      font-size:12px;
      border:1px solid var(--border);
      border-radius:999px;
      padding:4px 10px;
      background:var(--surface);
    }
    .form-card{
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--surface);
      padding:14px;
      display:grid;
      gap:14px;
    }
    .form-row{
      display:grid;
      gap:6px;
    }
    .form-row label{
      font-size:13px;
      font-weight:700;
    }
    .inline-two{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    @media(max-width:640px){
      .inline-two{
        grid-template-columns:1fr;
      }
    }
    .req-badge{
      font-size:11px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:.04em;
      padding:2px 6px;
      border-radius:999px;
      background:color-mix(in srgb,var(--brand) 12%, transparent);
      color:var(--brand,#3B7E46);
      margin-left:6px;
    }
    select, textarea, input[type="text"]{
      border-radius:10px;
      border:1px solid var(--border-strong,var(--border));
      padding:8px 10px;
      font:inherit;
      background:var(--surface);
      resize:vertical;
      min-height:40px;
    }
    textarea{
      min-height:90px;
    }
    .helper{
      font-size:12px;
      color:var(--muted,#67706B);
    }

    .readonly-field{
      border-radius:10px;
      border:1px solid var(--border);
      padding:8px 10px;
      font-size:14px;
      background:var(--surface-soft,var(--surface));
      min-height:40px;
      display:flex;
      align-items:center;
    }

    .notes-row{
      display:grid;
      gap:6px;
    }
    .notes-toolbar{
      display:flex;
      align-items:center;
      justify-content:flex-end;
      gap:8px;
    }
    .icon-btn{
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--surface);
      padding:6px 12px;
      display:inline-flex;
      align-items:center;
      gap:6px;
      font-size:12px;
      cursor:pointer;
    }
    .icon-btn svg{
      width:16px;
      height:16px;
    }

    .actions{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin-top:10px;
    }
    @media(max-width:640px){
      .actions{
        grid-template-columns:1fr;
      }
    }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-height:50px;
      font-weight:800;
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--card-surface,var(--surface));
      text-decoration:none;
      cursor:pointer;
    }
    .btn-primary{
      background:var(--brand);
      border-color:transparent;
      color:#fff;
    }
    .btn[disabled]{
      opacity:.6;
      cursor:progress;
    }

    .status-banner{
      font-size:13px;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--surface-soft,var(--surface));
      display:flex;
      align-items:flex-start;
      gap:8px;
    }
    .status-banner .emo{
      font-size:18px;
      line-height:1.1;
    }

    .success-card{
      border:1px solid color-mix(in srgb,var(--brand) 30%, transparent);
      background:color-mix(in srgb,var(--brand) 6%, var(--surface));
      border-radius:12px;
      padding:16px;
      display:grid;
      gap:6px;
      margin-top:4px;
    }
    .success-card h2{
      margin:0;
      font-size:18px;
      font-weight:900;
    }
    .success-card p{
      margin:0;
      font-size:13px;
      color:var(--muted,#67706B);
    }

    [hidden]{ display:none !important; }

    /* kill blue links/highlights */
    .wrap, .wrap * { -webkit-tap-highlight-color: transparent; }
    .wrap a, .wrap a:visited, .wrap a:active, .wrap a:hover {
      color:inherit;
      text-decoration:none;
    }
  </style>
</head>

<body>
  <fv-shell>
    <div class="wrap" id="content" hidden>
      <section class="hero">
        <header class="hero-head">
          <h1>Submit Service Request</h1>
          <p class="muted" id="subtitle">Loading equipment…</p>
        </header>

        <div class="body">
          <!-- Equipment summary -->
          <div class="eq-summary" id="eqSummary" hidden>
            <h2 class="eq-title" id="eqTitle"></h2>
            <div class="eq-chips">
              <span class="chip" id="eqType"></span>
              <span class="chip" id="eqSerial" hidden></span>
            </div>
          </div>

          <!-- Status / errors -->
          <div class="status-banner" id="statusBanner" hidden>
            <div class="emo" id="statusIcon">ℹ️</div>
            <div id="statusText"></div>
          </div>

          <!-- Main form -->
          <form class="form-card" id="serviceForm" novalidate>
            <!-- Submitted by + Date row -->
            <div class="form-row inline-two">
              <div class="form-row">
                <label>Submitted by</label>
                <div class="readonly-field" id="submittedByDisplay">Loading…</div>
              </div>
              <div class="form-row">
                <label>Date</label>
                <div class="readonly-field" id="submittedDateDisplay">Loading…</div>
              </div>
            </div>

            <!-- Service topic -->
            <div class="form-row">
              <label for="serviceTopic">
                Service topic
                <span class="req-badge">Required</span>
              </label>
              <select id="serviceTopic" required>
                <option value="">Select a topic…</option>
                <option value="engine">Engine / Powertrain</option>
                <option value="hydraulics">Hydraulics</option>
                <option value="electrical">Electrical / Wiring</option>
                <option value="driveline">Driveline / Transmission</option>
                <option value="tires_tracks">Tires / Tracks / Undercarriage</option>
                <option value="precision">Precision / GPS / StarFire</option>
                <option value="cab_controls">Cab Controls / Displays</option>
                <option value="leaks">Leaks / Fluids</option>
                <option value="scheduled_service">Scheduled Service / Oil Change</option>
                <option value="inspection">Pre-Season Inspection</option>
                <option value="other">Other (describe below)</option>
              </select>
              <p class="helper">
                Keep this list clean. If “Other” is truly needed, describe it clearly in the notes.
              </p>
            </div>

            <!-- If "Other" topic -->
            <div class="form-row" id="topicOtherRow" hidden>
              <label for="serviceTopicOther">If “Other”, what’s the main topic?</label>
              <input id="serviceTopicOther" type="text" maxlength="120"
                     placeholder="Example: Rear axle vibration, cab door seal, etc."/>
            </div>

            <!-- Notes + dictation -->
            <div class="form-row notes-row">
              <label for="notes">
                Notes for shop
                <span class="req-badge">Required</span>
              </label>
              <div class="notes-toolbar">
                <button type="button" class="icon-btn" id="btnDictate">
                  <svg viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 0 0-6 0v5a3 3 0 0 0 3 3zm5-3a1 1 0 0 1 2 0 7 7 0 0 1-6 6.93V20h2a1 1 0 1 1 0 2H9a1 1 0 1 1 0-2h2v-2.07A7 7 0 0 1 5 11a1 1 0 0 1 2 0 5 5 0 0 0 10 0z"/>
                  </svg>
                  <span id="dictateLabel">Dictate</span>
                </button>
              </div>
              <textarea id="notes" required
                        placeholder="Describe the issue, when it happens, any warning lights, and how urgent it is."></textarea>
              <p class="helper">
                Example: “Rattle in front right at 1,800–2,000 RPM under load, no codes, started 12/3 after chisel.”
              </p>
            </div>

            <!-- Parts needed -->
            <div class="form-row">
              <label for="partsNeeded">Parts needed (if known)</label>
              <textarea id="partsNeeded"
                        placeholder="Filter kits, bearings, hoses, tires/tracks, DEF sensor, etc. List part numbers if you have them."></textarea>
            </div>

            <!-- Coming-soon: attachments (photos/files) -->
            <div class="form-row">
              <label>Photos & files (coming soon)</label>
              <p class="helper">
                We’ll add photo/file uploads to this screen next. For now, give a clear description in the notes if a photo would help.
              </p>
            </div>

            <!-- Actions -->
            <div class="actions">
              <button type="button" class="btn" id="btnCancel">Cancel</button>
              <button type="submit" class="btn btn-primary" id="btnSubmit">
                Submit Request
              </button>
            </div>

            <!-- Success message -->
            <div class="success-card" id="successCard" hidden>
              <h2>Service request submitted</h2>
              <p>
                Your request has been saved and will show up in the service approval queue.
                You’ll be returned to the equipment hub in a moment.
              </p>
            </div>
          </form>
        </div>
      </section>
    </div>
  </fv-shell>

  <script type="module">
    import {
      ready,
      getFirestore,
      doc,
      getDoc,
      collection,
      addDoc,
      serverTimestamp,
      getAuth,
      onAuthStateChanged
    } from '/Farm-vista/js/firebase-init.js';

    const $ = id => document.getElementById(id);

    const qs = new URLSearchParams(location.search);
    const equipmentId = qs.get('id') || qs.get('equipmentId') || '';
    const from        = (qs.get('from') || '').toLowerCase();

    const db   = getFirestore();
    const auth = getAuth();

    let cachedUser = null;

    function showContent(){ $('content').hidden = false; }

    function setStatus(msg, icon='ℹ️'){
      const banner = $('statusBanner');
      const text   = $('statusText');
      const ico    = $('statusIcon');
      if(!banner || !text || !ico) return;
      text.textContent = msg || '';
      ico.textContent  = icon || 'ℹ️';
      banner.hidden = !msg;
    }

    function last6(v){
      return String(v || '').slice(-6);
    }

    function goBackToHub(){
      if(history.length > 1){
        history.back();
        return;
      }
      if(equipmentId){
        location.href =
          `/Farm-vista/pages/equipment/actions/hub.html?id=${encodeURIComponent(equipmentId)}${from ? `&from=${encodeURIComponent(from)}` : ''}`;
      }else{
        location.href = '/Farm-vista/pages/equipment/equipment-tractors.html';
      }
    }

    // --- Dictation support
    let recognizer = null;
    let dictating  = false;

    function setupDictation(){
      const btn = $('btnDictate');
      const label = $('dictateLabel');
      const notes = $('notes');
      if(!btn || !label || !notes) return;

      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SpeechRecognition){
        btn.disabled = true;
        label.textContent = 'Dictation not supported';
        return;
      }

      recognizer = new SpeechRecognition();
      recognizer.lang = 'en-US';
      recognizer.continuous = false;
      recognizer.interimResults = false;

      recognizer.onresult = (event)=>{
        const t = Array.from(event.results)
          .map(r=>r[0]?.transcript || '')
          .join(' ');
        if(t){
          const cur = notes.value.trim();
          notes.value = cur ? (cur + (cur.endsWith('.') ? ' ' : '. ') + t) : t;
        }
      };
      recognizer.onend = ()=>{
        dictating = false;
        label.textContent = 'Dictate';
        btn.disabled = false;
      };
      recognizer.onerror = ()=>{
        dictating = false;
        label.textContent = 'Dictate';
        btn.disabled = false;
      };

      btn.addEventListener('click', ()=>{
        if(dictating){
          recognizer.stop();
          return;
        }
        try{
          dictating = true;
          label.textContent = 'Listening…';
          btn.disabled = true;
          recognizer.start();
        }catch(e){
          console.warn('dictation error', e);
          dictating = false;
          label.textContent = 'Dictate';
          btn.disabled = false;
        }
      });
    }

    // --- Topic "Other" toggle
    function setupTopicOther(){
      const select = $('serviceTopic');
      const row    = $('topicOtherRow');
      if(!select || !row) return;
      const onChange = ()=>{
        const v = select.value;
        row.hidden = (v !== 'other');
      };
      select.addEventListener('change', onChange);
      onChange();
    }

    async function userReady(maxMs=3000){
      if(cachedUser) return cachedUser;
      if(auth.currentUser){
        cachedUser = auth.currentUser;
        return cachedUser;
      }
      const first = new Promise(res=>{
        const off = onAuthStateChanged(auth, (u)=>{
          try{ off(); }catch{}
          res(u);
        }, { onlyOnce:true });
      });
      let u = await first;
      if(u){
        cachedUser = u;
        return cachedUser;
      }
      const t0 = Date.now();
      while(!auth.currentUser && (Date.now()-t0) < maxMs){
        await new Promise(r=>setTimeout(r,120));
      }
      cachedUser = auth.currentUser || null;
      return cachedUser;
    }

    function fillSubmittedByAndDate(){
      const elBy   = $('submittedByDisplay');
      const elDate = $('submittedDateDisplay');

      // Date for display
      const now = new Date();
      const displayDate = now.toLocaleDateString('en-US', {
        year:'numeric', month:'short', day:'numeric'
      });
      if(elDate) elDate.textContent = displayDate;

      // User (async)
      userReady().then(user=>{
        if(!elBy) return;
        if(user){
          const name = user.displayName || user.email || 'Current user';
          elBy.textContent = name;
        }else{
          elBy.textContent = 'Unknown user';
        }
      }).catch(()=>{
        if(elBy) elBy.textContent = 'Unknown user';
      });
    }

    async function loadEquipment(){
      if(!equipmentId){
        setStatus('No equipment ID provided in the link.', '⚠️');
        $('subtitle').textContent = 'Missing equipment id.';
        showContent();
        return null;
      }

      try{
        const ref  = doc(db,'equipment',equipmentId);
        const snap = await getDoc(ref);
        showContent();

        if(!snap.exists()){
          setStatus('Equipment record not found. Check the QR or link and try again.', '⚠️');
          $('subtitle').textContent = 'Equipment not found.';
          return null;
        }

        const d = snap.data() || {};
        const makeModel = [d.makeName, d.modelName].filter(Boolean).join(' ');
        const ls = last6(d.serial);
        const title = makeModel
          ? `${makeModel}${ls ? ` (#${ls})` : ''}`
          : (d.name || `Unit ${equipmentId.slice(0,6)}`);

        $('eqTitle').textContent = title;
        $('eqType').textContent =
          (d.type ? String(d.type).charAt(0).toUpperCase() + String(d.type).slice(1) : 'Equipment');
        if(ls){
          $('eqSerial').textContent = `SN #${ls}`;
          $('eqSerial').hidden = false;
        }

        $('eqSummary').hidden = false;
        $('subtitle').textContent = 'Tell the shop what needs attention on this unit.';

        return { id: equipmentId, data: d, title, serialLast6: ls };
      }catch(e){
        console.error('loadEquipment error', e);
        showContent();
        setStatus('Error loading equipment. Try re-opening from the QR scan or lookup.', '⚠️');
        $('subtitle').textContent = 'Error loading equipment.';
        return null;
      }
    }

    function setupForm(equipmentMeta){
      const form      = $('serviceForm');
      const btnSubmit = $('btnSubmit');
      const btnCancel = $('btnCancel');
      const topicSel  = $('serviceTopic');
      const topicOther= $('serviceTopicOther');
      const notesEl   = $('notes');
      const partsEl   = $('partsNeeded');
      const success   = $('successCard');

      if(!form || !btnSubmit || !btnCancel) return;

      btnCancel.addEventListener('click', (evt)=>{
        evt.preventDefault();
        goBackToHub();
      });

      form.addEventListener('submit', async (evt)=>{
        evt.preventDefault();
        if(btnSubmit.disabled) return;

        success.hidden = true;
        setStatus('', 'ℹ️');

        const topic = (topicSel?.value || '').trim();
        const topicOtherText = (topicOther?.value || '').trim();
        const notes = (notesEl?.value || '').trim();
        const parts = (partsEl?.value || '').trim();

        if(!topic){
          setStatus('Choose a service topic before submitting.', '⚠️');
          topicSel?.focus();
          return;
        }
        if(!notes){
          setStatus('Tell the shop what is going on in the notes field.', '⚠️');
          notesEl?.focus();
          return;
        }

        btnSubmit.disabled = true;
        btnSubmit.textContent = 'Submitting…';

        try{
          const user = await userReady();
          const createdByUid   = user?.uid || null;
          const createdByEmail = user?.email || null;
          const createdByName  = user?.displayName || null;

          const now = new Date();
          const requestedDate = now.toISOString().slice(0,10); // YYYY-MM-DD

          const payload = {
            equipmentId: equipmentMeta?.id || equipmentId || null,
            equipmentName: equipmentMeta?.title || null,
            equipmentType: equipmentMeta?.data?.type || null,
            equipmentMake: equipmentMeta?.data?.makeName || null,
            equipmentModel: equipmentMeta?.data?.modelName || null,
            equipmentSerialLast6: equipmentMeta?.serialLast6 || null,

            serviceTopic: topic,
            serviceTopicOther: topic === 'other' && topicOtherText ? topicOtherText : null,
            notes,
            partsNeeded: parts || null,

            status: 'Pending',
            requestedDate,              // local date string for humans/filters
            createdAt: serverTimestamp(),
            createdByUid,
            createdByEmail,
            createdByName
          };

          await addDoc(collection(db,'equipmentServiceRequests'), payload);

          setStatus('Service request submitted.', '✅');
          success.hidden = false;

          // Small delay, then go back to hub
          setTimeout(()=>{ goBackToHub(); }, 1300);
        }catch(e){
          console.error('submit service request error', e);
          setStatus('Error submitting request. Check your connection and try again.', '⚠️');
        }finally{
          btnSubmit.disabled = false;
          btnSubmit.textContent = 'Submit Request';
        }
      });
    }

    async function init(){
      await ready;
      setupDictation();
      setupTopicOther();
      fillSubmittedByAndDate();
      const eq = await loadEquipment();
      setupForm(eq);
    }

    init().catch(e=>{
      console.error('service-request init error', e);
      showContent();
      setStatus('Unexpected error loading page.', '⚠️');
    });

    // Handle bfcache resume gently
    window.addEventListener('pageshow', (e)=>{ if(e.persisted) init(); });
  </script>
</body>
</html>
