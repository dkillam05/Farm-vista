<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FarmVista • Submit Service Request</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#3B7E46" />

  <script src="/Farm-vista/js/theme-boot.js"></script>

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest" />
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png" />
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png" />
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css" />
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css" />

  <!-- IMPORTANT: match hub – load Firebase CONFIG first -->
  <script src="/Farm-vista/js/firebase-config.js"></script>

  <!-- Ensure fv-shell -->
  <script>
    (function () {
      if (!customElements.get('fv-shell')) {
        const s = document.createElement('script');
        s.src = '/Farm-vista/js/fv-shell.js';
        s.defer = true;
        document.head.appendChild(s);
      }
    })();
  </script>

  <style>
    :root{
      --card-max: 900px;
      --accent: #2F6C3C;
    }
    body{
      background: var(--app-bg, var(--surface));
      margin:0;
    }
    #btnSubmit,
#btnSubmit *,
#btnSubmit:disabled,
#btnSubmit:disabled *{
  color:#fff !important;
}
    .wrap{
      max-width: var(--card-max);
      margin: 0 auto;
      padding: clamp(14px,3vw,22px);
      padding-bottom: calc(env(safe-area-inset-bottom,0px) + 72px) !important;
      box-sizing:border-box;
    }

    .hero{
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));
      overflow:hidden;
    }
    .hero-head{
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);
    }
    .hero-head h1{
      margin:0;
      font-size:clamp(20px,3.1vw,26px);
      line-height:1.2;
    }
    .muted{
      color:var(--muted,#67706B);
      font-size:13px;
      margin-top:4px;
    }

    .body{
      padding:16px;
      display:grid;
      gap:16px;
    }

    .eq-summary{
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--surface-soft,var(--surface));
      padding:14px;
      display:grid;
      gap:6px;
    }
    .eq-title{
      font-weight:800;
      font-size:16px;
      margin:0;
    }
    .eq-chips{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:4px;
    }
    .chip{
      font-size:12px;
      border:1px solid var(--border);
      border-radius:999px;
      padding:4px 10px;
      background:var(--surface);
    }

    .form-card{
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--surface);
      padding:14px;
      display:grid;
      gap:14px;
    }

    .form-row{
      display:grid;
      gap:6px;
    }
    .row-two{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    @media (max-width:720px){
      .row-two{ grid-template-columns:1fr; }
    }

    .fm-row-label,
    .form-row label{
      display:block;
      font-weight:800;
      margin:0 0 4px 0;
      font-size:13px;
    }

    .req-badge{
      font-size:11px;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:.04em;
      padding:2px 6px;
      border-radius:999px;
      background:color-mix(in srgb,var(--accent) 12%, transparent);
      color:var(--accent);
      margin-left:6px;
    }

    .input,
    .select,
    .textarea{
      width:100%;
      font:inherit;
      font-size:15px;
      font-weight:400;
      color:var(--text);
      background:var(--card-surface,var(--surface));
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px 12px;
      outline:none;
    }
    .textarea{
      min-height:110px;
      resize:vertical;
    }
    .input-readonly[readonly]{
      cursor:default;
      background:var(--card-surface,var(--surface));
    }

    .helper{
      font-size:12px;
      color:var(--muted,#67706B);
    }

    .ta-wrap{ position:relative; }
    .textarea.fm-notes{ padding-right:52px; }

    .mic-btn{
      position:absolute;
      right:10px;
      bottom:10px;
      width:36px;
      height:36px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--surface);
      display:grid;
      place-items:center;
      cursor:pointer;
    }
    .mic-btn[disabled]{ opacity:.6; cursor:not-allowed; }
    .mic-svg{ width:18px; height:18px; display:block; }
    .mic-active{
      background:#2F6C3C;
      color:#fff;
      border-color:#2F6C3C;
    }

    .actions{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:6px;
      justify-content:flex-end;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:148px;
      min-height:48px;
      padding:12px 16px;
      border-radius:12px;
      border:1px solid var(--border);
      font-weight:800;
      text-decoration:none;
      cursor:pointer;
      user-select:none;
      color:var(--text);
      background:var(--card-surface,var(--surface));
    }
    .btn-primary{
      border-color:transparent;
      background:#2F6C3C;
      color:#fff;
    }
    .btn[disabled]{ opacity:.6; cursor:not-allowed; }

    .status-banner{
      font-size:13px;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--surface-soft,var(--surface));
      display:flex;
      align-items:flex-start;
      gap:8px;
    }
    .status-banner .emo{
      font-size:18px;
      line-height:1.1;
    }

    .success-card{
      border:1px solid color-mix(in srgb,var(--accent) 30%, transparent);
      background:color-mix(in srgb,var(--accent) 6%, var(--surface));
      border-radius:12px;
      padding:12px 14px;
      display:grid;
      gap:4px;
      margin-top:4px;
      font-size:13px;
    }
    .success-card h2{
      margin:0;
      font-size:16px;
      font-weight:900;
    }
    .success-card p{
      margin:0;
      color:var(--muted,#67706B);
    }

    .error{
      border:1px solid #b3261e;
      background:#fff;
      color:#b3261e;
      border-radius:10px;
      padding:10px 12px;
      display:none;
    }
    .error.show{ display:block; }

    /* file input + thumbs */
    input[type="file"].file-input{
      width:100%;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--card-surface,var(--surface));
      font-size:0.9rem;
      color:var(--text);
    }
    input[type="file"].file-input::file-selector-button{
      border:none;
      border-radius:999px;
      padding:4px 12px;
      margin-right:10px;
      background:var(--surface);
      color:var(--text);
      font-size:0.85rem;
      cursor:pointer;
    }
    .thumbs{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:6px;
    }
    .thumb{
      width:72px;
      height:72px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--card-surface,var(--surface));
      display:grid;
      place-items:center;
      overflow:hidden;
      font-size:11px;
      text-align:center;
      padding:4px;
    }
    .thumb img{
      max-width:100%;
      max-height:100%;
      display:block;
    }
    .muted-line{
      font-size:13px;
      color:var(--muted,#67706B);
      margin-top:4px;
    }

    [hidden]{ display:none !important; }

    /* kill blue links/highlights */
    .wrap, .wrap * { -webkit-tap-highlight-color: transparent; }
    .wrap a, .wrap a:visited, .wrap a:active, .wrap a:hover {
      color:inherit;
      text-decoration:none;
    }

    
  </style>
</head>
<body>
  <fv-shell>
    <div class="wrap" id="content">
      <section class="hero">
        <header class="hero-head">
          <h1>Submit Service Request</h1>
          <p class="muted" id="subtitle">Tell the shop what needs attention on this unit.</p>
        </header>

        <div class="body">
          <div id="err" class="error"></div>

          <!-- Equipment summary -->
          <div class="eq-summary" id="eqSummary" hidden>
            <h2 class="eq-title" id="eqTitle"></h2>
            <div class="eq-chips">
              <span class="chip" id="eqType"></span>
              <span class="chip" id="eqSerial" hidden></span>
            </div>
          </div>

          <!-- Status / errors -->
          <div class="status-banner" id="statusBanner" hidden>
            <div class="emo" id="statusIcon">ℹ️</div>
            <div id="statusText"></div>
          </div>

          <!-- Main form -->
          <form class="form-card" id="serviceForm" novalidate>
            <!-- Submitted by / Date row -->
            <div class="row-two">
              <div class="form-row">
                <div class="fm-row-label">Submitted by</div>
                <input
                  id="submittedByDisplay"
                  class="input input-readonly"
                  type="text"
                  readonly
                  value="Detecting user…">
                <input id="submittedBy" type="hidden">
                <input id="submittedUid" type="hidden">
                <input id="submittedEmail" type="hidden">
              </div>
              <div class="form-row">
                <div class="fm-row-label">Date submitted</div>
                <input
                  id="dateSubmittedDisplay"
                  class="input input-readonly"
                  type="text"
                  readonly>
              </div>
            </div>

            <!-- Service topic -->
            <div class="form-row">
              <label for="serviceTopic">
                Service topic
                <span class="req-badge">Required</span>
              </label>
              <select id="serviceTopic" class="select" required>
                <option value="">Select a topic…</option>
                <option value="engine">Engine / Powertrain</option>
                <option value="hydraulics">Hydraulics</option>
                <option value="electrical">Electrical / Wiring</option>
                <option value="driveline">Driveline / Transmission</option>
                <option value="tires_tracks">Tires / Tracks / Undercarriage</option>
                <option value="precision">Precision / GPS / StarFire</option>
                <option value="cab_controls">Cab Controls / Displays</option>
                <option value="leaks">Leaks / Fluids</option>
                <option value="scheduled_service">Scheduled Service / Oil Change</option>
                <option value="inspection">Pre-Season Inspection</option>
                <option value="other">Other (describe below)</option>
              </select>
              <p class="helper">
                Keep this list clean. If “Other” is truly needed, describe it clearly in the notes.
              </p>
            </div>

            <!-- If "Other" topic -->
            <div class="form-row" id="topicOtherRow" hidden>
              <label for="serviceTopicOther">If “Other”, what’s the main topic?</label>
              <input id="serviceTopicOther" class="input" type="text" maxlength="120"
                placeholder="Example: Rear axle vibration, cab door seal, etc.">
            </div>

            <!-- Notes + mic -->
            <div class="form-row">
              <label for="notes">
                Notes for shop
                <span class="req-badge">Required</span>
              </label>
              <div class="ta-wrap">
                <textarea
                  id="notes"
                  class="textarea fm-notes"
                  placeholder="Describe the issue, when it happens, any warning lights, and how urgent it is."></textarea>
                <button id="mic" type="button" class="mic-btn" aria-label="Start dictation">
                  <svg class="mic-svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                    <path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 1 0-6 0v5a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 6 6.92V21H9v2h6v-2h-2v-3.08A7 7 0 0 0 19 11h-2z"/>
                  </svg>
                </button>
              </div>
              <p class="helper">
                Example: “Rattle in front right at 1,800–2,000 RPM under load, no codes, started 12/3 after chisel.”
              </p>
            </div>

            <!-- Parts needed -->
            <div class="form-row">
              <label for="partsNeeded">Parts needed (if known)</label>
              <textarea
                id="partsNeeded"
                class="textarea"
                placeholder="Filter kits, bearings, hoses, tires/tracks, DEF sensor, etc. List part numbers if you have them."></textarea>
            </div>

            <!-- Photos & files -->
            <div class="form-row">
              <label for="attachments">Photos & files</label>
              <input
                id="attachments"
                class="file-input"
                type="file"
                multiple
                accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt">
              <div id="thumbs" class="thumbs" aria-hidden="true"></div>
              <div id="fileHint" class="muted-line" aria-hidden="true"></div>
              <p class="helper">
                Attach photos of warning lights, leaks, wear points, or upload related documents (inspection reports, service quotes, etc.).
              </p>
            </div>

            <!-- Actions -->
            <div class="actions">
              <button id="btnCancel" type="button" class="btn">Cancel</button>
              <button id="btnSubmit" type="submit" class="btn btn-primary">Submit Request</button>
            </div>

            <!-- Success message -->
            <div class="success-card" id="successCard" hidden>
              <h2>Service request submitted</h2>
              <p id="successMsg">
                Your request has been saved and will show up in the service approval queue.
                You’ll be returned to the equipment hub in a moment.
              </p>
            </div>
          </form>
        </div>
      </section>
    </div>
  </fv-shell>

  <script type="module">
    import {
      ready,
      getFirestore,
      collection,
      addDoc,
      serverTimestamp,
      doc,
      getDoc,
      getStorage,
      ref,
      uploadBytes,
      getDownloadURL,
      updateDoc
    } from '/Farm-vista/js/firebase-init.js';

    const $ = id => document.getElementById(id);

    const qs = new URLSearchParams(location.search);
    const equipmentId = qs.get('id') || qs.get('equipmentId') || '';
    const from        = (qs.get('from') || '').toLowerCase();

    let DB = null;

    /* ---------------------- helpers ---------------------- */

    const showErr = msg => {
      const box = $("err");
      box.textContent = msg || "";
      box.classList.toggle("show", !!msg);
    };

    function setStatus(msg, icon='ℹ️'){
      const banner = $('statusBanner');
      const text   = $('statusText');
      const ico    = $('statusIcon');
      if(!banner || !text || !ico) return;
      text.textContent = msg || '';
      ico.textContent  = icon || 'ℹ️';
      banner.hidden = !msg;
    }

    const last6 = v => String(v || '').slice(-6);

    function formatLocalDate(d = new Date()){
      const dt = new Date(d.getTime() - d.getTimezoneOffset()*60000);
      return dt.toISOString().slice(0,10);
    }
    function prettyDateFromIso(dStr){
      if(!dStr) return "";
      const d = new Date(dStr);
      if(Number.isNaN(d.getTime())) return dStr;
      return d.toLocaleDateString();
    }

    function titleCase(s){
      return String(s||"").replace(/\s+/g," ").trim().split(" ")
        .filter(Boolean).map(w=>w.charAt(0).toUpperCase()+w.slice(1).toLowerCase()).join(" ");
    }
    function nameFromEmail(email){
      const local = String(email||"").split("@")[0]||"";
      if(!local) return "";
      if(/[._-]/.test(local)){
        return titleCase(local.replace(/[0-9]+/g," ").split(/[._-]+/).join(" "));
      }
      const spaced = local.replace(/([a-z])([A-Z])/g,"$1 $2");
      return titleCase(spaced || local);
    }

    /* -------- Submitted by / date (copied pattern) -------- */

    function setSubmittedByNow(){
      const disp = $("submittedByDisplay");
      const hidName = $("submittedBy");
      const hidUid = $("submittedUid");
      const hidEmail = $("submittedEmail");
      let label = "";

      try{
        const ctx = window.FVUserContext && window.FVUserContext.get && window.FVUserContext.get();
        if(ctx){
          if(ctx.displayName || ctx.email) label = ctx.displayName || ctx.email || "";
          if(ctx.uid && !hidUid.value) hidUid.value = ctx.uid;
          if(ctx.email && !hidEmail.value) hidEmail.value = ctx.email;
        }
      }catch{}

      if(!label){
        try{
          const u = window.firebaseAuth && window.firebaseAuth.currentUser;
          if(u){
            label = u.displayName || u.email || "";
            if(u.uid && !hidUid.value) hidUid.value = u.uid;
            if(u.email && !hidEmail.value) hidEmail.value = u.email;
          }
        }catch{}
      }

      if(label && label.includes("@")) label = nameFromEmail(label);
      label = titleCase(label || "");
      if(label){
        disp.value = label;
        hidName.value = label;
        return true;
      }
      disp.value = "FarmVista User";
      return false;
    }

    function setupAuth(){
      let tries = 30;
      const timer = setInterval(()=>{
        if(setSubmittedByNow() || --tries<=0) clearInterval(timer);
      }, 200);
    }

    function setupDate(){
      const todayIso = formatLocalDate();
      $("dateSubmittedDisplay").value = prettyDateFromIso(todayIso);
    }

    /* -------- mic dictation (same as maintenance) -------- */

    function wireMic(buttonId, textareaId){
      const btn = $(buttonId);
      const ta  = $(textareaId);
      if(!btn || !ta) return;

      const ok = ('webkitSpeechRecognition' in window) || ('SpeechRecognition' in window);
      if(!ok){
        btn.style.display = "none";
        return;
      }

      const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
      const rec = new Rec();
      rec.lang = "en-US";
      rec.interimResults = true;
      rec.continuous = false;

      let active = false;
      let baseText = "";

      const setMic = on=>{
        btn.classList.toggle("mic-active", on);
        btn.setAttribute("aria-label", on ? "Stop dictation" : "Start dictation");
      };

      btn.addEventListener("click", ()=>{
        if(!active){
          baseText = ta.value ? (ta.value + " ") : "";
          try{ rec.start(); active=true; setMic(true); }catch{}
        }else{
          try{ rec.stop(); rec.abort(); }catch{}
          active=false; setMic(false);
        }
      });

      rec.onresult = ev=>{
        let txt = "";
        for(let i=ev.resultIndex;i<ev.results.length;i++){
          txt += ev.results[i][0].transcript;
        }
        ta.value = baseText + txt;
      };
      rec.onend = ()=>{ active=false; setMic(false); };
      rec.onerror = ()=>{ active=false; setMic(false); };
    }

    function setupMic(){
      wireMic("mic", "notes");
    }

    /* ---------------- Files: preview + upload ---------------- */

    function setupFiles(){
      const inp    = $("attachments");
      const thumbs = $("thumbs");
      const hint   = $("fileHint");
      if(!inp) return;

      inp.addEventListener("change", ()=>{
        const files = Array.from(inp.files || []);
        thumbs.innerHTML = "";
        if(!files.length){
          thumbs.setAttribute("aria-hidden","true");
          hint.textContent = "";
          hint.setAttribute("aria-hidden","true");
          return;
        }

        files.forEach(f=>{
          const wrap = document.createElement("div");
          wrap.className = "thumb";

          if(f.type && f.type.startsWith("image/")){
            const img = document.createElement("img");
            img.alt = f.name;
            wrap.appendChild(img);
            const reader = new FileReader();
            reader.onload = e=>{ img.src = e.target.result; };
            reader.readAsDataURL(f);
          }else{
            wrap.textContent = (f.name || "file").split(".").pop().toUpperCase();
          }
          thumbs.appendChild(wrap);
        });

        thumbs.removeAttribute("aria-hidden");
        hint.textContent = files.length === 1 ? "1 file selected" : `${files.length} files selected`;
        hint.removeAttribute("aria-hidden");
      });
    }

    async function uploadRequestFiles(docId){
      const input = $("attachments");
      const files = Array.from(input?.files || []);
      if(!files.length){
        return { urls: [], count: 0 };
      }

      // Storage optional – follow same pattern as maintenance
      if(!window.FV_HAS_STORAGE){
        console.warn("[svc-req] Storage flag FV_HAS_STORAGE is false; skipping uploads.");
        return { urls: [], count: files.length };
      }

      const storage = getStorage();
      if(!storage){
        console.warn("[svc-req] getStorage() returned null; skipping uploads.");
        return { urls: [], count: files.length };
      }

      const urls = [];
      let index = 0;

      for(const file of files){
        try{
          const cleanName = (file.name || "file").replace(/\s+/g,"-");
          const path = `equipmentServiceRequests/${docId}/${Date.now()}-${index}-${cleanName}`;
          const fileRef = ref(storage, path);
          await uploadBytes(fileRef, file);
          const url = await getDownloadURL(fileRef);
          urls.push(url);
          index++;
        }catch(err){
          console.error("[svc-req] single file upload failed", err);
        }
      }

      try{
        const refDoc = doc(DB, "equipmentServiceRequests", docId);
        await updateDoc(refDoc, {
          attachmentUrls: urls,
          attachmentCount: urls.length,
          updatedAt: serverTimestamp()
        });
      }catch(err){
        console.error("[svc-req] updateDoc with attachment URLs failed", err);
      }

      return { urls, count: urls.length };
    }

    /* ------------------ equipment load ------------------ */

    async function loadEquipment(){
      if(!equipmentId){
        setStatus('No equipment ID provided in the link.', '⚠️');
        $('subtitle').textContent = 'Missing equipment id.';
        return null;
      }

      try{
        const ref  = doc(DB, 'equipment', equipmentId);
        console.info('[svc-req] loading equipment', equipmentId);
        const snap = await getDoc(ref);

        if(!snap.exists()){
          setStatus('Equipment record not found. Check the QR or link and try again.', '⚠️');
          $('subtitle').textContent = 'Equipment not found.';
          console.warn('[svc-req] equipment not found', equipmentId);
          return null;
        }

        const d = snap.data() || {};
        const makeModel = [d.makeName, d.modelName].filter(Boolean).join(' ');
        const ls = last6(d.serial);
        const title = makeModel
          ? `${makeModel}${ls ? ` (#${ls})` : ''}`
          : (d.name || `Unit ${equipmentId.slice(0,6)}`);

        $('eqTitle').textContent = title;
        $('eqType').textContent =
          (d.type ? String(d.type).charAt(0).toUpperCase() + String(d.type).slice(1) : 'Equipment');
        if(ls){
          $('eqSerial').textContent = `SN #${ls}`;
          $('eqSerial').hidden = false;
        }

        $('eqSummary').hidden = false;
        setStatus('', 'ℹ️');
        return { id: equipmentId, data: d, title, serialLast6: ls };
      }catch(e){
        console.error('[svc-req] loadEquipment error', e);
        setStatus('Error loading equipment. Try re-opening from the QR scan or lookup.', '⚠️');
        $('subtitle').textContent = 'Error loading equipment.';
        return null;
      }
    }

    /* ------------------ topic + form ------------------ */

    function setupTopicOther(){
      const select = $('serviceTopic');
      const row    = $('topicOtherRow');
      if(!select || !row) return;
      const onChange = ()=>{
        const v = select.value;
        row.hidden = (v !== 'other');
      };
      select.addEventListener('change', onChange);
      onChange();
    }

    function goBackToHub(){
      if(history.length > 1){
        history.back();
        return;
      }
      if(equipmentId){
        location.href =
          `/Farm-vista/pages/equipment/actions/hub.html?id=${encodeURIComponent(equipmentId)}${from ? `&from=${encodeURIComponent(from)}` : ''}`;
      }else{
        location.href = '/Farm-vista/pages/equipment/equipment-tractors.html';
      }
    }

    function setupActions(equipmentMeta){
      const form      = $('serviceForm');
      const btnSubmit = $('btnSubmit');
      const btnCancel = $('btnCancel');
      const topicSel  = $('serviceTopic');
      const topicOther= $('serviceTopicOther');
      const notesEl   = $('notes');
      const partsEl   = $('partsNeeded');
      const success   = $('successCard');
      const successMsg= $('successMsg');

      btnCancel.addEventListener('click', (evt)=>{
        evt.preventDefault();
        goBackToHub();
      });

      form.addEventListener('submit', async (evt)=>{
        evt.preventDefault();
        if(btnSubmit.disabled) return;

        success.hidden = true;
        setStatus('');
        showErr('');

        const topic = (topicSel.value || '').trim();
        const topicOtherText = (topicOther.value || '').trim();
        const notes = (notesEl.value || '').trim();
        const parts = (partsEl.value || '').trim();

        if(!topic){
          showErr('Service topic is required.');
          topicSel.focus();
          return;
        }
        if(!notes){
          showErr('Notes for shop are required.');
          notesEl.focus();
          return;
        }
        if(!$('submittedBy').value){
          showErr('Unable to detect user. Please re-login.');
          return;
        }

        btnSubmit.disabled = true;
        btnSubmit.textContent = 'Submitting…';

        try{
          const now = new Date();
          const requestedDate = formatLocalDate(now);

          const fileInput = $("attachments");
          const rawCount  = fileInput && fileInput.files ? fileInput.files.length : 0;

          const payload = {
            equipmentId: equipmentMeta?.id || equipmentId || null,
            equipmentName: equipmentMeta?.title || null,
            equipmentType: equipmentMeta?.data?.type || null,
            equipmentMake: equipmentMeta?.data?.makeName || null,
            equipmentModel: equipmentMeta?.data?.modelName || null,
            equipmentSerialLast6: equipmentMeta?.serialLast6 || null,

            serviceTopic: topic,
            serviceTopicOther: topic === 'other' && topicOtherText ? topicOtherText : null,
            notes,
            partsNeeded: parts || null,

            status: 'needs approved',
            requestedDate,
            attachmentCount: rawCount, // will be corrected after upload
            createdAt: serverTimestamp(),
            submittedBy: {
              uid: $('submittedUid').value || null,
              name: $('submittedBy').value || null,
              email: $('submittedEmail').value || null
            }
          };

          const docRef = await addDoc(collection(DB,'equipmentServiceRequests'), payload);

          let uploadInfo = null;
          try{
            uploadInfo = await uploadRequestFiles(docRef.id);
          }catch(e){
            console.error('[svc-req] attachment upload failed', e);
          }

          let extra = '';
          if(uploadInfo && uploadInfo.count){
            extra = uploadInfo.count === 1
              ? ' 1 attachment uploaded.'
              : ` ${uploadInfo.count} attachments uploaded.`;
          }else if(rawCount && (!uploadInfo || !uploadInfo.count)){
            extra = ' Attachments not uploaded (Storage unavailable).';
          }

          setStatus('Service request submitted.', '✅');
          successMsg.textContent =
            'Your request has been saved and will show up in the service approval queue.' + extra +
            ' You’ll be returned to the equipment hub in a moment.';
          success.hidden = false;

          setTimeout(()=>{ goBackToHub(); }, 1500);
        }catch(e){
          console.error('[svc-req] submit error', e);
          showErr('Error submitting request. Check your connection and try again.');
        }finally{
          btnSubmit.disabled = false;
          btnSubmit.textContent = 'Submit Request';
        }
      });
    }

    /* ---------------------- boot ---------------------- */

    (async function boot(){
      await ready;
      DB = getFirestore();

      setupAuth();
      setupDate();
      setupMic();
      setupFiles();
      setupTopicOther();

      const eqMeta = await loadEquipment();
      setupActions(eqMeta);
    })().catch(e=>{
      console.error('[svc-req] init fatal', e);
      showErr('Unexpected error loading page.');
    });
  </script>
</body>
</html>
