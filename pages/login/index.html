<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Login — Dowson Farms • FarmVista</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
  <meta name="theme-color" content="#3B7E46" />

  <!-- Make all relative URLs resolve under /Farm-vista/ -->
  <base href="/Farm-vista/" />

  <!-- PWA bits -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="application-name" content="FarmVista" />
  <meta name="apple-mobile-web-app-title" content="FarmVista" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />

  <!-- Icons -->
  <link rel="icon" href="assets/icons/icon-192.png" sizes="192x192" type="image/png" />
  <link rel="icon" href="assets/icons/icon-512.png" sizes="512x512" type="image/png" />
  <link rel="apple-touch-icon" href="assets/icons/apple-touch-icon.png" />

  <!-- Theme -->
  <link rel="stylesheet" href="assets/css/theme.css?v=LG1" />

  <!-- ✅ Provide Firebase config BEFORE anything that may load js/firebase-init.js -->
  <script src="js/firebase-config.js"></script>

  <!-- Core boot (loads theme + firebase-init via theme-boot/core) -->
  <script src="js/core.js?v=LG1"></script>

  <style>
    /* =====================================================================
       /Farm-vista/auth/index.html  (FULL FILE REPLACEMENT)
       Rev: 2025-12-19a
       Fixes:
        • Inputs no longer go "light" while page is in FarmVista dark theme
        • Dark mode detection supports BOTH prefers-color-scheme AND data-theme="dark"
        • Chrome autofill no longer paints email white in dark mode
        • Sign In button text stays white
    ===================================================================== */

    .login * { box-sizing: border-box; }
    .login a { text-decoration: none; }

    /* Let UA widgets pick correct palette */
    :root{ color-scheme: light dark; }

    /* ---------------------------------------------------------------------
       IMPORTANT: Use FarmVista theme tokens from theme.css instead of
       redefining the whole color system here (that caused the mismatch).
       We only define "login-scoped" tokens that derive from theme.css vars.
    --------------------------------------------------------------------- */
    :root{
      --fv-green: #3B7E46;

      /* theme.css should define these; fallbacks are safe */
      --fv-bg:   var(--bg, #f5f7f4);
      --fv-card: var(--card, #ffffff);
      --fv-text: var(--text, #141514);
      --fv-border: var(--border, rgba(0,0,0,.12));
      --fv-muted: color-mix(in srgb, var(--fv-text) 60%, transparent);

      /* inputs */
      --fv-input-bg: color-mix(in srgb, var(--fv-card) 92%, var(--fv-bg));
      --fv-input-border: color-mix(in srgb, var(--fv-text) 18%, transparent);
      --fv-input-ph: color-mix(in srgb, var(--fv-text) 42%, transparent);
      --fv-ring: color-mix(in srgb, var(--fv-green) 28%, transparent);
      --fv-line: color-mix(in srgb, var(--fv-text) 14%, transparent);
    }

    /* ---------------------------------------------------------------------
       Dark theme detection:
       FarmVista often toggles via data-theme (not OS preference).
       Support BOTH mechanisms.
    --------------------------------------------------------------------- */
    html[data-theme="dark"],
    :root[data-theme="dark"],
    body[data-theme="dark"]{
      --fv-muted: color-mix(in srgb, var(--fv-text) 55%, transparent);
      --fv-line:  color-mix(in srgb, var(--fv-text) 18%, transparent);

      /* darker input surface */
      --fv-input-bg: color-mix(in srgb, var(--fv-card) 88%, #000);
      --fv-input-border: color-mix(in srgb, var(--fv-text) 22%, transparent);
      --fv-input-ph: color-mix(in srgb, var(--fv-text) 48%, transparent);
    }
    @media (prefers-color-scheme: dark){
      html:not([data-theme]),
      :root:not([data-theme]),
      body:not([data-theme]){
        --fv-muted: color-mix(in srgb, var(--fv-text) 55%, transparent);
        --fv-line:  color-mix(in srgb, var(--fv-text) 18%, transparent);

        --fv-input-bg: color-mix(in srgb, var(--fv-card) 88%, #000);
        --fv-input-border: color-mix(in srgb, var(--fv-text) 22%, transparent);
        --fv-input-ph: color-mix(in srgb, var(--fv-text) 48%, transparent);
      }
    }

    html, body { height:100%; background:var(--fv-bg); color:var(--fv-text); }
    body {
      margin:0;
      font:400 16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,sans-serif;
      -webkit-text-size-adjust:100%;
    }

    .wrap{ min-height:100%; display:grid; place-items:center; padding:24px; }

    .card{
      width:min(400px,100%);
      background:var(--fv-card);
      color:var(--fv-text);
      border-radius:16px;
      border:1px solid var(--fv-line);
      box-shadow:0 8px 28px rgba(0,0,0,.08),0 2px 8px rgba(0,0,0,.06);
      overflow:clip;
    }

    .pad{ padding: clamp(18px,5vw,26px); }

    .brand{ display:grid; grid-template-columns:44px 1fr; gap:12px; align-items:center; margin-bottom:6px; }
    .logo{
      width:44px; height:44px; border-radius:10px; object-fit:contain;
      background:color-mix(in srgb,var(--fv-bg) 65%,transparent);
      border:1px solid var(--fv-line);
    }
    .title{ display:grid; gap:2px; }
    .title h1{ margin:0; font-size:clamp(18px,2.4vw,22px); font-weight:800; line-height:1.2; }
    .title .byline{ margin:0; font-size:14px; font-weight:700; color:color-mix(in srgb,var(--fv-text) 80%, var(--fv-green)); }
    .title .slogan{ margin:0; font-size:14px; font-style:italic; color:var(--fv-muted); }

    form{ display:grid; gap:14px; margin-top:14px; }
    .field{ display:grid; gap:6px; }
    .field label{ font-size:14px; font-weight:700; }
    .control{ position:relative; }

    .input{
      width:100%;
      padding:12px 14px;
      padding-right:42px;
      background:var(--fv-input-bg);
      border:1px solid var(--fv-input-border);
      border-radius:12px;
      color:var(--fv-text);
      caret-color: var(--fv-text);
      outline:none;
      box-shadow:0 0 0 0 var(--fv-ring);
      transition: box-shadow .15s ease, border-color .15s ease, background .15s ease;
      -webkit-appearance:none;
      appearance:none;
    }
    .input::placeholder{ color: var(--fv-input-ph); }
    .input:focus{
      border-color: color-mix(in srgb, var(--fv-green) 60%, transparent);
      box-shadow:0 0 0 3px var(--fv-ring);
    }

    /* ------------------------------------------------------------
       Chrome autofill override (EMAIL + PASSWORD)
       This prevents the "white painted" autofill background in dark.
    ------------------------------------------------------------ */
    #email:-webkit-autofill,
    #email:-webkit-autofill:hover,
    #email:-webkit-autofill:focus,
    #password:-webkit-autofill,
    #password:-webkit-autofill:hover,
    #password:-webkit-autofill:focus{
      -webkit-text-fill-color: var(--fv-text) !important;
      caret-color: var(--fv-text) !important;
      -webkit-box-shadow: 0 0 0 1000px var(--fv-input-bg) inset !important;
      box-shadow: 0 0 0 1000px var(--fv-input-bg) inset !important;
      border:1px solid var(--fv-input-border) !important;
      transition: background-color 999999s ease-in-out 0s;
    }

    .eye{
      position:absolute; right:8px; top:0; bottom:0;
      width:34px; display:grid; place-items:center;
      color:color-mix(in srgb, var(--fv-text) 55%, transparent);
      cursor:pointer; background:none; border:none; outline:none;
    }
    .eye svg{ width:22px; height:22px; display:block; }
    .eye:hover{ color:color-mix(in srgb, var(--fv-text) 72%, transparent); }

    .actions{ display:grid; gap:10px; margin-top:6px; }

    .btn{
      appearance:none; display:grid; place-items:center;
      width:100%; min-height:44px; padding:12px 16px;
      border-radius:12px;
      background-color: var(--fv-green);
      color:#ffffff;
      border:1px solid color-mix(in srgb, var(--fv-green) 55%, var(--fv-line));
      box-shadow:0 2px 0 color-mix(in srgb,#000 25%, var(--fv-green));
      font-weight:900; letter-spacing:.2px; cursor:pointer;
    }
    .btn:active{ transform:translateY(1px); }

    /* hard guarantee: no black text on green */
    #signIn{ color:#ffffff !important; }

    .link{
      text-align:center;
      font-size:14px;
      color:color-mix(in srgb,var(--fv-text) 78%, var(--fv-green));
    }
    .link:hover{ text-decoration:underline; }

    .meta{ margin-top:16px; font-size:12px; text-align:center; color:var(--fv-muted); }
    .err{ color:#b3261e; font-size:13px; min-height:1.2em; }

    /* ---------- Mobile help button (mobile-only) ---------- */
    .help-wrap{
      display:none;
      margin-top:12px;
      padding-top:12px;
      border-top:1px solid var(--fv-line);
    }

    .help-btn{
      appearance:none;
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:10px;
      min-height:42px;
      padding:10px 14px;
      border-radius:12px;
      background:color-mix(in srgb, var(--fv-card) 88%, var(--fv-bg));
      border:1px solid color-mix(in srgb, var(--fv-text) 14%, transparent);
      color:color-mix(in srgb, var(--fv-text) 92%, transparent);
      font-weight:900;
      cursor:pointer;
      box-shadow:0 1px 0 rgba(0,0,0,.05);
    }
    .help-btn:active{ transform:translateY(1px); }
    .help-ic{
      width:22px; height:22px; flex:0 0 auto;
      border-radius:999px;
      display:grid; place-items:center;
      background:color-mix(in srgb, var(--fv-green) 16%, transparent);
      border:1px solid color-mix(in srgb, var(--fv-green) 28%, transparent);
      color:color-mix(in srgb, var(--fv-green) 85%, var(--fv-text));
      font-weight:900;
      line-height:1;
    }

    /* Only show on mobile-ish devices */
    @media (hover:none) and (pointer:coarse), (max-width: 820px){
      .help-wrap{ display:block; }
    }
    @media (min-width: 821px) and (hover:hover) and (pointer:fine){
      .help-wrap{ display:none !important; }
    }

    /* ---------- Help modal ---------- */
    .modal-backdrop{
      position:fixed; inset:0;
      background:rgba(0,0,0,.45);
      display:none;
      align-items:center;
      justify-content:center;
      padding:16px;
      z-index:9999;
    }
    .modal-backdrop.open{ display:flex; }

    .modal{
      width:min(520px, 100%);
      border-radius:18px;
      background:var(--fv-card);
      color:var(--fv-text);
      border:1px solid var(--fv-line);
      box-shadow:0 20px 70px rgba(0,0,0,.35), 0 2px 14px rgba(0,0,0,.18);
      overflow:hidden;
      transform:translateY(10px);
      opacity:0;
      transition:transform .16s ease, opacity .16s ease;
    }
    .modal-backdrop.open .modal{
      transform:translateY(0);
      opacity:1;
    }

    .modal-hd{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding:14px 14px 10px 14px;
      border-bottom:1px solid var(--fv-line);
      background:color-mix(in srgb, var(--fv-card) 86%, var(--fv-bg));
    }
    .modal-title{ display:grid; gap:2px; }
    .modal-title h2{
      margin:0;
      font-size:16px;
      font-weight:950;
      letter-spacing:.2px;
    }
    .modal-title p{
      margin:0;
      font-size:13px;
      color:var(--fv-muted);
      font-weight:700;
    }
    .modal-close{
      appearance:none;
      width:38px; height:38px;
      border-radius:12px;
      border:1px solid color-mix(in srgb, var(--fv-text) 14%, transparent);
      background:color-mix(in srgb, var(--fv-card) 90%, var(--fv-bg));
      color:color-mix(in srgb, var(--fv-text) 92%, transparent);
      cursor:pointer;
      display:grid; place-items:center;
      flex:0 0 auto;
    }
    .modal-close:active{ transform:translateY(1px); }

    .modal-bd{
      padding:14px;
      max-height:min(70vh, 520px);
      overflow:auto;
    }

    .help-card{
      border:1px solid var(--fv-line);
      border-radius:14px;
      padding:12px;
      background:color-mix(in srgb, var(--fv-card) 92%, var(--fv-bg));
      margin-bottom:12px;
    }
    .help-card h3{
      margin:0 0 8px 0;
      font-size:14px;
      font-weight:950;
      color:color-mix(in srgb, var(--fv-text) 92%, var(--fv-green));
    }
    .help-card ul{
      margin:0;
      padding-left:18px;
      display:grid;
      gap:6px;
      font-size:14px;
      color:color-mix(in srgb, var(--fv-text) 92%, transparent);
    }
    .kbd{
      font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      padding:.08em .42em;
      border-radius:7px;
      border:1px solid var(--fv-line);
      background:color-mix(in srgb, var(--fv-card) 88%, var(--fv-bg));
      color:color-mix(in srgb, var(--fv-text) 92%, transparent);
      white-space:nowrap;
    }
    .tip{
      margin:0;
      font-size:13px;
      color:var(--fv-muted);
      font-weight:700;
      line-height:1.35;
    }

    .modal-ft{
      padding:12px 14px 14px 14px;
      border-top:1px solid var(--fv-line);
      display:grid;
      gap:10px;
      background:color-mix(in srgb, var(--fv-card) 90%, var(--fv-bg));
    }
    .modal-primary{
      appearance:none;
      width:100%;
      min-height:42px;
      border-radius:12px;
      border:1px solid color-mix(in srgb, var(--fv-green) 55%, var(--fv-line));
      background:var(--fv-green);
      color:#fff;
      font-weight:950;
      cursor:pointer;
      box-shadow:0 2px 0 color-mix(in srgb,#000 25%, var(--fv-green));
    }
    .modal-primary:active{ transform:translateY(1px); }
  </style>
</head>

<body class="login">
  <div class="wrap">
    <main class="card" role="main" aria-labelledby="welcome">
      <div class="pad">
        <div class="brand">
          <img class="logo" src="assets/icons/logo.png" alt="FarmVista logo" />
          <div class="title">
            <h1 id="welcome">Welcome to Dowson Farms</h1>
            <p class="byline">powered by FarmVista</p>
            <p class="slogan">Clean Data, Smart Reporting</p>
          </div>
        </div>

        <form id="loginForm" autocomplete="on" novalidate>
          <div class="field">
            <label for="email">Email</label>
            <div class="control">
              <input id="email" name="email" class="input" type="email"
                     inputmode="email" autocomplete="username" spellcheck="false"
                     enterkeyhint="next" autocapitalize="none" autocorrect="off"
                     placeholder="you@example.com" />
            </div>
          </div>

          <div class="field">
            <label for="password">Password</label>
            <div class="control">
              <input id="password" name="password" class="input" type="password"
                     autocomplete="current-password" enterkeyhint="go" placeholder="••••••••" />
              <button type="button" class="eye" id="togglePwd" aria-controls="password" aria-label="Show password" title="Show/Hide password">
                <svg id="lashClosed" viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M3 13c2.5-3 5.5-4.5 9-4.5S18.5 10 21 13" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                  <path d="M6 11.5l-1-2M9 10.2l-.5-2.2M12 9.5V7M15 10.2l.5-2.2M18 11.5l1-2" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                </svg>
                <svg id="lashOpen" viewBox="0 0 24 24" aria-hidden="true" style="display:none">
                  <path d="M3 13c2.5-3 5.5-4.5 9-4.5S18.5 10 21 13" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                  <path d="M6 11.5l-1-2M9 10.2l-.5-2.2M12 9.5V7M15 10.2l.5-2.2M18 11.5l1-2" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                  <circle cx="12" cy="13.5" r="1.8" fill="currentColor"/>
                </svg>
              </button>
            </div>
          </div>

          <div class="err" id="errBox"></div>

          <div class="actions">
            <button class="btn" id="signIn" type="submit">Sign In</button>
            <a class="link" href="#" id="forgot">Forgot password?</a>
          </div>

          <!-- Mobile help button (only shows on mobile) -->
          <div class="help-wrap" id="helpWrap">
            <button type="button" class="help-btn" id="helpBtn" aria-haspopup="dialog" aria-controls="helpModalBackdrop">
              <span class="help-ic" aria-hidden="true">?</span>
              <span>Help • Install to Home Screen</span>
            </button>
          </div>

          <p class="meta" id="brandMeta">© Dowson Farms — </p>
        </form>
      </div>
    </main>
  </div>

  <!-- Help modal -->
  <div class="modal-backdrop" id="helpModalBackdrop" aria-hidden="true">
    <section class="modal" role="dialog" aria-modal="true" aria-labelledby="helpTitle" aria-describedby="helpDesc">
      <header class="modal-hd">
        <div class="modal-title">
          <h2 id="helpTitle">Best way to use FarmVista on your phone</h2>
          <p id="helpDesc">Install it like an app so it opens fast and stays full-screen.</p>
        </div>
        <button type="button" class="modal-close" id="helpClose" aria-label="Close help">✕</button>
      </header>

      <div class="modal-bd">
        <div class="help-card">
          <h3>iPhone / iPad (Safari)</h3>
          <ul>
            <li>Open FarmVista in <strong>Safari</strong> (not Chrome or Facebook browser).</li>
            <li>Tap the <span class="kbd">Share</span> button (square with arrow up).</li>
            <li>Scroll and tap <strong>Add to Home Screen</strong>.</li>
            <li>Name it “FarmVista”, then tap <strong>Add</strong>.</li>
            <li>Open FarmVista from the new Home Screen icon (full-screen app mode).</li>
          </ul>
        </div>

        <div class="help-card">
          <h3>Android (Chrome)</h3>
          <ul>
            <li>Open FarmVista in <strong>Chrome</strong>.</li>
            <li>Tap the <span class="kbd">⋮</span> menu.</li>
            <li>Tap <strong>Install app</strong> or <strong>Add to Home screen</strong>.</li>
          </ul>
        </div>

        <p class="tip">
          Tip: If you ever see a “weird login loop” or missing camera access, make sure you’re opening from the Home Screen icon (installed app mode).
        </p>
      </div>

      <footer class="modal-ft">
        <button type="button" class="modal-primary" id="helpGotIt">Got it</button>
      </footer>
    </section>
  </div>

  <script>
    // Eyelash toggle + footer date
    (function(){
      const pwd = document.getElementById('password');
      const btn = document.getElementById('togglePwd');
      const open = document.getElementById('lashOpen');
      const closed = document.getElementById('lashClosed');
      if (btn && pwd) {
        btn.addEventListener('click', () => {
          const show = pwd.type !== 'text';
          pwd.type = show ? 'text' : 'password';
          if (open) open.style.display = show ? 'block' : 'none';
          if (closed) closed.style.display = show ? 'none' : 'block';
        }, { passive: true });
      }

      const el = document.getElementById('brandMeta');
      if (el) {
        const fmt = new Intl.DateTimeFormat('en-US', { year:'numeric', month:'long', day:'2-digit' });
        el.textContent = `© ${new Date().getFullYear()} Dowson Farms — ${fmt.format(new Date())}`;
      }
    }());
  </script>

  <!-- Autofill nudges -->
  <script>
    (function(){
      const email = document.getElementById('email');
      const pwd = document.getElementById('password');
      try {
        const last = localStorage.getItem('fv_last_email');
        if (last && email && !email.value) email.value = last;
      } catch {}
      try {
        if (email && email.value) { pwd && pwd.focus({ preventScroll:true }); }
        else { email && email.focus({ preventScroll:true }); }
      } catch {}
    }());
  </script>

  <!-- Mobile help modal controller (mobile only; optional first-time auto pop) -->
  <script>
    (function(){
      const backdrop = document.getElementById('helpModalBackdrop');
      const btn = document.getElementById('helpBtn');
      const closeBtn = document.getElementById('helpClose');
      const gotItBtn = document.getElementById('helpGotIt');
      const pwd = document.getElementById('password');

      const isMobile = () => {
        try {
          const coarse = window.matchMedia && window.matchMedia('(pointer:coarse)').matches;
          const narrow = window.matchMedia && window.matchMedia('(max-width: 820px)').matches;
          return coarse || narrow;
        } catch { return false; }
      };

      function openHelp(){
        if (!backdrop || !isMobile()) return;
        backdrop.classList.add('open');
        backdrop.setAttribute('aria-hidden','false');
        try { closeBtn && closeBtn.focus({ preventScroll:true }); } catch {}
      }

      function closeHelp(markSeen){
        if (!backdrop) return;
        backdrop.classList.remove('open');
        backdrop.setAttribute('aria-hidden','true');
        if (markSeen) {
          try { localStorage.setItem('fv_help_seen','1'); } catch {}
        }
      }

      if (btn) btn.addEventListener('click', openHelp);
      if (closeBtn) closeBtn.addEventListener('click', () => closeHelp(true));
      if (gotItBtn) gotItBtn.addEventListener('click', () => closeHelp(true));

      if (backdrop) {
        backdrop.addEventListener('click', (e) => {
          if (e.target === backdrop) closeHelp(true);
        });
      }

      window.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && backdrop && backdrop.classList.contains('open')) {
          e.preventDefault();
          closeHelp(true);
        }
      });

      let fired = false;
      function maybeFirstTimePop(){
        if (fired) return;
        if (!isMobile()) return;

        let seen = false;
        try { seen = localStorage.getItem('fv_help_seen') === '1'; } catch {}
        if (seen) return;

        const hasPwd = !!(pwd && String(pwd.value || '').trim().length);
        if (!hasPwd) return;

        fired = true;
        openHelp();
      }

      if (pwd) {
        pwd.addEventListener('blur', maybeFirstTimePop, { passive:true });
        pwd.addEventListener('change', maybeFirstTimePop, { passive:true });
      }
    }());
  </script>

  <!-- Login controller -->
  <script type="module" src="js/app/login.js?v=LG1"></script>
</body>
</html>
