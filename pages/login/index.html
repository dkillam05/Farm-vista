<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
  <title>Login — Dowson Farms • FarmVista</title>

  <link rel="stylesheet" href="../../assets/css/theme.css" />
  <script defer src="../../js/theme-boot.js"></script>

  <style>
    :root{ --green:#3B7E46; --page:var(--app-bg,#f5f7f4); --text:#141514; --surface:#fff; --line:color-mix(in srgb,var(--text) 12%, transparent); }
    @media (prefers-color-scheme:dark){ :root{ --page:#141514; --text:#f5f7f4; --surface:#1c1e1c; --line:color-mix(in srgb,var(--text) 16%, transparent); } }
    html,body{height:100%;margin:0;background:var(--page);color:var(--text);font:400 16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;-webkit-text-size-adjust:100%}
    .wrap{min-height:100%;display:grid;place-items:center;padding:24px}
    .card{width:min(400px,100%);background:var(--surface);color:var(--text);border-radius:16px;border:1px solid var(--line);box-shadow:0 8px 28px rgba(0,0,0,.08),0 2px 8px rgba(0,0,0,.06);overflow:hidden}
    .pad{padding:clamp(18px,5vw,26px)}
    .brand{display:grid;grid-template-columns:44px 1fr;gap:12px;align-items:center;margin-bottom:6px}
    .logo{width:44px;height:44px;border-radius:10px;object-fit:contain;border:1px solid var(--line)}
    .title h1{margin:0;font-size:clamp(18px,2.4vw,22px);font-weight:800;line-height:1.2}
    .title .byline{margin:0;font-size:14px;font-weight:600;color:color-mix(in srgb,var(--text) 80%, var(--green))}
    form{display:grid;gap:14px;margin-top:14px}
    .field{display:grid;gap:6px}
    .control{position:relative}
    .input{width:100%;padding:12px 14px;padding-right:42px;border:1px solid color-mix(in srgb,var(--text) 18%, transparent);border-radius:12px;background:#fff;color:var(--text);outline:0}
    @media (prefers-color-scheme:dark){ .input{background:#232523} }
    .eye{position:absolute;right:8px;top:0;bottom:0;width:34px;display:grid;place-items:center;color:#8a8f8a;cursor:pointer;background:none;border:0}
    .eye svg{width:22px;height:22px;display:block}
    .actions{display:grid;gap:10px;margin-top:6px}
    .btn{appearance:none;display:grid;place-items:center;width:100%;min-height:44px;padding:12px 16px;border-radius:12px;background:#3B7E46;color:#fff;border:1px solid color-mix(in srgb,#3B7E46 55%, var(--line));box-shadow:0 2px 0 color-mix(in srgb,#000 25%, #3B7E46);font-weight:800;letter-spacing:.2px;cursor:pointer}
    .link{text-align:center;font-size:14px;color:color-mix(in srgb,var(--text) 78%, var(--green))}
    .meta{margin-top:16px;font-size:12px;text-align:center;color:color-mix(in srgb,var(--text) 60%, transparent)}
    .err{color:#b3261e;font-size:14px;min-height:1.2em}
  </style>
</head>
<body class="login">
  <div class="wrap">
    <main class="card" role="main" aria-labelledby="welcome">
      <div class="pad">
        <div class="brand">
          <img class="logo" src="../../assets/icons/logo.png" alt="FarmVista logo" />
          <div class="title">
            <h1 id="welcome">Welcome to Dowson Farms</h1>
            <p class="byline">powered by FarmVista</p>
          </div>
        </div>

        <form id="loginForm" novalidate>
          <div class="field">
            <label for="email">Email</label>
            <div class="control">
              <input id="email" name="email" class="input" type="email" inputmode="email" autocomplete="username" autocapitalize="none" autocorrect="off" placeholder="you@example.com" />
            </div>
          </div>

          <div class="field">
            <label for="password">Password</label>
            <div class="control">
              <input id="password" name="password" class="input" type="password" autocomplete="current-password" placeholder="••••••••" />
              <button type="button" class="eye" id="togglePwd" aria-controls="password" aria-label="Show password" title="Show/Hide password">
                <svg id="lashClosed" viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M3 13c2.5-3 5.5-4.5 9-4.5S18.5 10 21 13" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                  <path d="M6 11.5l-1-2M9 10.2l-.5-2.2M12 9.5V7M15 10.2l.5-2.2M18 11.5l1-2" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                </svg>
                <svg id="lashOpen" viewBox="0 0 24 24" aria-hidden="true" style="display:none">
                  <path d="M3 13c2.5-3 5.5-4.5 9-4.5S18.5 10 21 13" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/>
                  <path d="M6 11.5l-1-2M9 10.2l-.5-2.2M12 9.5V7M15 10.2l.5-2.2M18 11.5l1-2" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
                  <circle cx="12" cy="13.5" r="1.8" fill="currentColor"/>
                </svg>
              </button>
            </div>
          </div>

          <div class="err" id="errBox"></div>

          <div class="actions">
            <button class="btn" id="signIn" type="submit">Sign In</button>
            <a class="link" href="#" id="forgot">Forgot password?</a>
          </div>

          <p class="meta" id="brandMeta">© Dowson Farms</p>
        </form>
      </div>
    </main>
  </div>

  <script>
    // Eyelash toggle
    (function(){
      const pwd = document.getElementById('password');
      const btn = document.getElementById('togglePwd');
      const open = document.getElementById('lashOpen');
      const closed = document.getElementById('lashClosed');
      btn.addEventListener('click', () => {
        const show = pwd.type !== 'text';
        pwd.type = show ? 'text' : 'password';
        btn.setAttribute('aria-label', show ? 'Hide password' : 'Show password');
        open.style.display = show ? 'block' : 'none';
        closed.style.display = show ? 'none' : 'block';
      }, { passive: true });
    }());
    // Footer date
    (function(){
      const el = document.getElementById('brandMeta');
      const fmt = new Intl.DateTimeFormat('en-US', { year:'numeric', month:'long', day:'2-digit' });
      el.textContent = `© ${new Date().getFullYear()} Dowson Farms — ${fmt.format(new Date())}`;
    }());
  </script>

  <!-- Firebase sign-in (clean, no debug stripe, shows exact error) -->
  <script type="module">
    import {
      getAuth, setPersistence, browserLocalPersistence, signOut,
      signInWithEmailAndPassword, sendPasswordResetEmail
    } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js';

    const errBox = document.getElementById('errBox');
    const form = document.getElementById('loginForm');
    const email = document.getElementById('email');
    const password = document.getElementById('password');
    const nextUrl = new URLSearchParams(location.search).get('next') || '/Farm-vista/dashboard/';

    function showErr(msg){ errBox.textContent = msg || 'Sign-in failed.'; }

    // Ensure firebase-init is present (theme-boot loads it, this imports if not)
    async function ensureFirebase(){
      if (!window.firebaseApp) {
        try { await import('../../js/firebase-init.js'); } catch {}
      }
      if (!window.firebaseApp) throw new Error('Firebase init failed (firebaseApp not found).');
    }

    ensureFirebase().then(async ()=>{
      const auth = window.firebaseAuth || getAuth(window.firebaseApp);

      try { await setPersistence(auth, browserLocalPersistence); } catch {}
      // Force clean state so Logout truly logs out
      try { await signOut(auth); } catch {}

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        showErr('');
        const em = (email.value||'').trim();
        const pw = password.value||'';
        if (!em || !pw){ showErr('Enter email and password.'); return; }

        try{
          await signInWithEmailAndPassword(auth, em, pw);
          location.replace(nextUrl);
        }catch(err){
          // Surface the real Firebase error so we know EXACTLY what’s wrong
          const code = (err && err.code) || '';
          const msg  = (err && err.message) || 'Sign-in failed.';
          // Cleaner messages for common cases
          if (code.includes('invalid-credential') || code.includes('wrong-password')) { showErr('Wrong email or password.'); return; }
          if (code.includes('user-not-found')) { showErr('No account for this email.'); return; }
          if (code.includes('too-many-requests')) { showErr('Too many attempts. Try again later.'); return; }
          if (code.includes('network-request-failed')) { showErr('Network error. Check your connection.'); return; }
          if (code.includes('unauthorized-domain')) { showErr('Domain not authorized in Firebase Authentication.'); return; }
          // Otherwise, show the raw code/message to pinpoint root cause
          showErr(`${code || 'auth/unknown'} — ${msg}`);
        }
      });

      document.getElementById('forgot').addEventListener('click', async (e)=>{
        e.preventDefault(); showErr('');
        const em = (email.value||'').trim();
        if (!em){ showErr('Enter your email first.'); return; }
        try{
          await sendPasswordResetEmail(auth, em);
          showErr('Password reset link sent (if the email exists).');
          setTimeout(()=> showErr(''), 4000);
        }catch(err){
          showErr((err && err.code) ? `${err.code}` : 'Unable to send reset email.');
        }
      });
    }).catch((e)=> showErr(e && e.message ? e.message : 'Login init failed.'));
  </script>
</body>
</html>