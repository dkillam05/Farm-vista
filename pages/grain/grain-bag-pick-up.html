<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista â€¢ Pick Up Bag (Dev)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- Absolute paths (required) -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>

  <!-- Theme + app CSS -->
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <!-- Ensure fv-shell -->
  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true;
        document.head.appendChild(s);
      }
    })();
  </script>

  <style>
    :root{ --card-max:1100px; --page-bottom-gap:96px; --accent:#2F6C3C; }
    body{ background:var(--app-bg,var(--surface)); }

    .wrap{ max-width:var(--card-max); margin:0 auto; padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + var(--page-bottom-gap))!important; }

    .hero{ border:1px solid var(--border); border-radius:14px; background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08)); overflow:visible; margin-bottom:var(--page-bottom-gap); }
    .hero-head{ display:grid; grid-template-columns:36px 1fr; gap:12px; align-items:center;
      padding:14px 16px; border-bottom:1px solid var(--border);
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent); }
    .hero-head .icon{ width:24px; height:24px; color:var(--accent); display:grid; place-items:center }
    .hero-head h1{ margin:0; font-size:clamp(20px,3.2vw,26px); line-height:1.2 }
    .muted{ color:var(--muted,#67706B) }
    .body{ padding:16px; display:grid; gap:14px }
    .row{ display:grid; gap:10px; grid-template-columns:1fr 1fr }
    @media (max-width:880px){ .row{ grid-template-columns:1fr } }

    .field{ position:relative }
    .field label{ display:block; font-weight:800; margin:0 0 6px }
    .input,.textarea,.buttonish{
      width:100%; font:inherit; font-size:16px; color:var(--text);
      background:var(--card-surface,var(--surface)); border:1px solid var(--border);
      border-radius:10px; padding:12px; outline:none;
    }
    .buttonish{ cursor:pointer; text-align:left; position:relative; padding-right:42px }
    .buttonish.has-caret::after{
      content:""; position:absolute; right:14px; top:50%; width:0; height:0;
      border-left:6px solid transparent; border-right:6px solid transparent;
      border-top:7px solid var(--muted,#67706B); transform:translateY(-50%); pointer-events:none;
    }
    .textarea{ min-height:110px; resize:vertical }
    .help{ font-size:13px; color:var(--muted,#67706B); margin-top:6px }
    .error{ color:#b00020; font-weight:700 }

    .actions{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-top:6px }
    .btn{ display:inline-flex; align-items:center; justify-content:center; min-width:160px;
      padding:12px 16px; border-radius:12px; border:1px solid var(--border);
      background:var(--card-surface,var(--surface)); font-weight:800; color:var(--text)!important; cursor:pointer; }
    .btn-primary{ border-color:transparent; background:#2F6C3C; color:#fff!important }

    /* Combo */
    .combo{ position:relative }
    .combo-panel{
      position:absolute; left:0; right:0; top:calc(100% + 4px);
      background:var(--surface); border:1px solid var(--border); border-radius:12px;
      box-shadow:0 12px 26px rgba(0,0,0,.18); z-index:9999; padding:8px; display:none;
    }
    .combo-panel.show{ display:block }
    .combo-panel .search{ padding:4px 2px 8px }
    .combo-panel .search input{ width:100%; padding:10px; border:1px solid var(--border); border-radius:10px }
    .combo-panel .list{ max-height:50vh; overflow:auto; border-top:1px solid var(--border) }
    .combo-item{ padding:10px 8px; border-bottom:1px solid var(--border); cursor:pointer }
    .combo-item:hover{ background:rgba(0,0,0,.04) }
    .combo-empty{ padding:10px 8px; color:#67706B }

    .cards{ display:grid; grid-template-columns:1fr; gap:12px }
    .card{ border:1px solid var(--border); border-radius:12px; background:var(--surface); padding:12px; display:grid; gap:10px }
    .kvs{ display:flex; flex-wrap:wrap; gap:10px }
    .kv{ background:var(--card-surface,var(--surface)); border:1px dashed var(--border); border-radius:10px; padding:8px 10px }

    .toast{ position:fixed; left:50%; bottom:calc(env(safe-area-inset-bottom,0px) + 72px); transform:translateX(-50%);
      background:#2F6C3C; color:#fff; padding:10px 14px; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,.25);
      z-index:99999; display:none }
    .toast.show{ display:block; animation:fadeout 5s forwards }
    @keyframes fadeout{0%{opacity:1}85%{opacity:1}100%{opacity:0}}
  </style>
</head>

<body>
  <fv-shell>
    <div class="wrap">
      <section class="hero">
        <header class="hero-head">
          <div class="icon" aria-hidden="true">ðŸ§²</div>
          <div>
            <h1>Pick Up Bag (Dev)</h1>
            <p class="muted">Only shows fields with open bags for the selected crop year.</p>
          </div>
        </header>

        <div class="body">
          <!-- YEAR + FIELD -->
          <div class="row">
            <!-- Crop Year -->
            <div class="field combo" id="yearCombo">
              <label for="yearBtn">Crop Year</label>
              <button id="yearBtn" class="buttonish has-caret" type="button">â€” Select â€”</button>
              <div class="combo-panel" id="yearPanel"><div class="list" id="yearList"></div></div>
            </div>

            <!-- Field (searchable, filtered to open) -->
            <div class="field combo" id="fieldCombo">
              <label for="fieldBtn">Field</label>
              <button id="fieldBtn" class="buttonish has-caret" type="button">â€” Select field â€”</button>
              <div class="combo-panel" id="fieldPanel" role="listbox" aria-label="Field list">
                <div class="search"><input id="fieldSearch" type="search" placeholder="Search fieldsâ€¦"/></div>
                <div class="list" id="fieldList"></div>
              </div>
              <div id="fieldHelp" class="help">â€”</div>
            </div>
          </div>

          <!-- Crop filter appears after field chosen -->
          <div class="row" id="cropRow" hidden>
            <div class="field combo" id="cropCombo">
              <label for="cropBtn">Crop Type</label>
              <button id="cropBtn" class="buttonish has-caret" type="button">â€” Select â€”</button>
              <div class="combo-panel" id="cropPanel"><div class="list" id="cropList"></div></div>
            </div>
            <div class="field">
              <label>&nbsp;</label>
              <div id="summary" class="kv">â€”</div>
            </div>
          </div>

          <!-- Open bags list -->
          <div class="field">
            <label>Open Bags in Field</label>
            <div id="listHelp" class="help">Choose Year, then Field.</div>
            <div id="bagList" class="cards"></div>
          </div>

          <div id="pageErr" class="help error" hidden></div>
        </div>
      </section>
    </div>
  </fv-shell>

  <div id="toast" class="toast" role="status" aria-live="polite">Saved.</div>

  <!-- Firebase (modular) -->
  <script type="module">
    import {
      ready, getFirestore, getAuth,
      collection, getDocs, addDoc, doc, updateDoc,
      serverTimestamp
    } from '/Farm-vista/js/firebase-init.js';

    // Lazy Storage for photos
    async function loadStorageFns(){
      const m = await import('/Farm-vista/js/firebase-init.js');
      return { getStorage:m.getStorage, ref:m.ref, uploadBytes:m.uploadBytes, getDownloadURL:m.getDownloadURL };
    }

    /* ===== Utils ===== */
    const $ = id => document.getElementById(id);
    const esc = s => String(s??"").replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;",'"':"&quot;","'":"&#39;"}[m]));
    const toast = (msg="Saved.", ms=4200)=>{ const t=$("toast"); t.textContent=msg; t.classList.remove("show"); void t.offsetWidth; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),ms); };
    const todayISO = ()=>{ const d=new Date(); const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${da}`; };
    const toNum = v => (v===undefined||v===null||v==="") ? NaN : Number(v);
    const yearOf = (row)=>{
      // prefer explicit cropYear; fallback to YYYY from datePlaced
      const cy = toNum(row.cropYear);
      if(!Number.isNaN(cy)) return cy;
      const dp = row.datePlaced;
      if(typeof dp==="string" && /^\d{4}-\d{2}-\d{2}$/.test(dp)) return Number(dp.slice(0,4));
      return null;
    };

    /* ===== State ===== */
    let YEAR = new Date().getFullYear();
    let EMPLOYEES = [];
    let FIELDS_INDEX = []; // [{id,name}]
    // Map: fieldId -> { id,name, crops: { 'Corn':[rows], 'Soybeans':[rows], ... } }
    let OPEN_INDEX = new Map();

    let CHOSEN_FIELD = null; // {id,name}
    let CHOSEN_CROP = null;  // 'Corn' | 'Soybeans' | ...

    /* ===== Combo infra (single open at a time) ===== */
    function closeAllCombos(except=null){
      document.querySelectorAll('.combo-panel.show').forEach(p=>{ if(p!==except) p.classList.remove('show'); });
    }
    document.addEventListener('click', ()=> closeAllCombos());
    function makeCombo({btn, panel, list, items=[], searchable=false, formatter=x=>String(x.label||x), onPick}){
      function render(q=""){
        const qq=(q||"").toLowerCase();
        list.innerHTML = (items||[])
          .filter(x=>!qq || formatter(x).toLowerCase().includes(qq))
          .map(x=>`<div class="combo-item" data-id="${esc(x.id)}">${esc(formatter(x))}</div>`)
          .join('') || `<div class="combo-empty">(no matches)</div>`;
      }
      function open(){
        closeAllCombos(panel);
        panel.classList.add('show');
        if(searchable){ const i=panel.querySelector('input'); if(i){ i.value=""; i.focus(); } }
        render("");
      }
      function close(){ panel.classList.remove('show'); }

      btn.addEventListener('click', (e)=>{ e.stopPropagation(); panel.classList.contains('show')?close():open(); });
      list.addEventListener('click', (e)=>{
        const el=e.target.closest('.combo-item'); if(!el) return;
        const it=(items||[]).find(i=>i.id===el.dataset.id); if(!it) return;
        onPick?.(it); close();
      });
      if(searchable){
        const s=panel.querySelector('input'); if(s) s.addEventListener('input', e=>render(e.target.value));
      }
      return { setItems(arr){ items=arr||[]; render(""); }, open, close };
    }

    /* ===== Format helpers ===== */
    const skuText = r => `${r.bagSku?.brand||'Bag'} â€” ${r.bagSku?.sizeFeet||'?'} ft`;
    const countsText = r => `${Number(r.counts?.full||0)} full, ${Number(r.counts?.partial||0)} partial`;
    const consolidatedSummary = (rows)=>{
      let full=0, partial=0;
      rows.forEach(r=>{ full += Number(r.counts?.full||0); partial += Number(r.counts?.partial||0); });
      return {full, partial, entries:rows.length};
    };

    /* ===== Data loads ===== */
    async function loadEmployees(db, auth){
      const list=[];
      try{
        const snap = await getDocs(collection(db,'employees'));
        snap.forEach(d=>{
          const x=d.data()||{};
          list.push({ id:d.id, name:x.name||x.displayName||x.fullName||x.email||d.id, email:x.email||d.id });
        });
      }catch(e){ console.warn("employees load:", e); }
      list.sort((a,b)=>(a.name||"").localeCompare(b.name||""));
      EMPLOYEES = list;
    }

    async function loadFields(db){
      const arr=[];
      try{
        const snap = await getDocs(collection(db,'fields'));
        snap.forEach(d=>{
          const x=d.data()||{};
          const name=String(x.name||"").trim();
          if(name) arr.push({id:d.id, name});
        });
      }catch(e){ console.warn("fields load:", e); }
      arr.sort((a,b)=>a.name.localeCompare(b.name));
      FIELDS_INDEX = arr;
    }

    // Build OPEN_INDEX for selected YEAR from *all* events (no query filters)
    async function buildOpenIndexForYear(db){
      OPEN_INDEX.clear();
      $("fieldHelp").textContent = "Loadingâ€¦";
      try{
        const snap = await getDocs(collection(db,'grain_bag_events'));
        snap.forEach(d=>{
          const x = d.data()||{};
          const isPut = (x.type === 'putDown');
          const open = !x.status || x.status!=='pickedUp';
          if(!isPut || !open) return;

          const yr = yearOf(x);
          if(yr===null || Number(yr)!==Number(YEAR)) return;

          const fid = x.field?.id;
          if(!fid) return;

          const name = (FIELDS_INDEX.find(f=>f.id===fid)?.name) || x.field?.name || fid;
          const crop = x.cropType || x.crop || 'Unknown';
          const row = { id:d.id, ...x };

          if(!OPEN_INDEX.has(fid)) OPEN_INDEX.set(fid, { id:fid, name, crops:{} });
          const bucket = OPEN_INDEX.get(fid).crops;
          (bucket[crop] ||= []).push(row);
        });

        // toss empties
        for(const [fid, obj] of [...OPEN_INDEX.entries()]){
          const hasAny = Object.values(obj.crops).some(arr => (arr||[]).length>0);
          if(!hasAny) OPEN_INDEX.delete(fid);
        }

        $("fieldHelp").textContent = `${OPEN_INDEX.size} field(s) with open bags in ${YEAR}`;
      }catch(err){
        console.error("buildOpenIndexForYear error:", err);
        $("fieldHelp").textContent = `0 field(s) (load error)`;
      }
    }

    const getFieldsWithOpen = ()=> [...OPEN_INDEX.values()].sort((a,b)=> (a.name||"").localeCompare(b.name||""));
    const cropsForField = fid => {
      const obj = OPEN_INDEX.get(fid);
      return obj ? Object.keys(obj.crops).sort() : [];
    };

    function rowsForCurrent(){
      if(!CHOSEN_FIELD) return [];
      const obj = OPEN_INDEX.get(CHOSEN_FIELD.id);
      if(!obj) return [];
      if(!CHOSEN_CROP) return Object.values(obj.crops).flat();
      return obj.crops[CHOSEN_CROP] || [];
    }

    /* ===== UI wiring ===== */
    const y = new Date().getFullYear();
    const YEARS = [y-1,y,y+1].map(v=>({id:String(v), value:v, label:String(v)}));

    const yearCombo = makeCombo({
      btn:$("yearBtn"), panel:$("yearPanel"), list:$("yearList"),
      items:YEARS, searchable:false, formatter:x=>x.label,
      onPick: async (it)=>{
        YEAR = Number(it.value);
        $("yearBtn").textContent = it.label;
        CHOSEN_FIELD = null; CHOSEN_CROP=null;
        $("fieldBtn").textContent="â€” Select field â€”";
        $("summary").textContent="â€”"; $("cropRow").hidden=true;
        $("bagList").innerHTML=""; $("listHelp").textContent="Choose Field.";
        await buildOpenIndexForYear(db);
        fieldCombo.setItems( getFieldsWithOpen().map(f=>({id:f.id, name:f.name})) );
      }
    });

    const fieldCombo = makeCombo({
      btn:$("fieldBtn"), panel:$("fieldPanel"), list:$("fieldList"),
      items:[], searchable:true, formatter:x=>x.name,
      onPick: async (it)=>{
        CHOSEN_FIELD = it;
        $("fieldBtn").textContent = it.name;

        const crops = cropsForField(it.id).map(c=>({id:c,label:c,value:c}));
        cropCombo.setItems(crops);
        if(crops.length){
          CHOSEN_CROP = crops[0].value;
          $("cropBtn").textContent = crops[0].label;
          $("cropRow").hidden = false;
        }else{
          CHOSEN_CROP = null;
          $("cropRow").hidden = true;
        }
        await renderOpenBags();
      }
    });

    const cropCombo = makeCombo({
      btn:$("cropBtn"), panel:$("cropPanel"), list:$("cropList"),
      items:[], searchable:false, formatter:x=>x.label,
      onPick: async (it)=>{
        CHOSEN_CROP = it.value;
        $("cropBtn").textContent = it.label;
        await renderOpenBags();
      }
    });

    async function renderOpenBags(){
      $("bagList").innerHTML = "";
      if(!CHOSEN_FIELD){ $("listHelp").textContent="Choose Field."; return; }

      const rows = rowsForCurrent();
      if(!rows.length){
        $("listHelp").textContent = "No open bags.";
        $("summary").textContent = "â€”";
        $("bagList").innerHTML = `<div class="card">No open bags for <b>${esc(CHOSEN_FIELD.name)}</b>${CHOSEN_CROP?` â€¢ ${esc(CHOSEN_CROP)}`:''} in ${esc(String(YEAR))}.</div>`;
        return;
      }

      rows.sort((a,b)=>(Number(b.priority||0)-Number(a.priority||0)) || String(a.datePlaced||"").localeCompare(String(b.datePlaced||"")));

      const sum = consolidatedSummary(rows);
      $("summary").innerHTML = `<b>Total:</b> ${sum.full} full, ${sum.partial} partial â€¢ ${sum.entries} open entr${sum.entries===1?'y':'ies'}`;
      $("listHelp").textContent = `${rows.length} open bag entr${rows.length===1?'y':'ies'}`;

      $("bagList").innerHTML = rows.map(r=>{
        const id=esc(r.id);
        return `
          <div class="card" data-row="${id}">
            <div class="kvs">
              <span class="kv"><b>Placed:</b> ${esc(r.datePlaced||'â€”')}</span>
              <span class="kv"><b>SKU:</b> ${esc(skuText(r))}</span>
              <span class="kv"><b>Count:</b> ${esc(countsText(r))}</span>
              <span class="kv"><b>Priority:</b> ${Number(r.priority||0)}</span>
              <span class="kv"><b>Crop:</b> ${esc(r.cropType||r.crop||'â€”')}</span>
            </div>
            <div class="help">By: ${esc(r.submittedBy?.name || r.submittedBy?.email || 'Unknown')}</div>
            <div class="actions">
              <button class="btn btn-primary" data-action="open-pickup" data-id="${id}">Pick Up</button>
            </div>

            <!-- Inline pickup form -->
            <div class="pickup-form" id="pf-${id}" hidden>
              <div class="row">
                <div class="field combo">
                  <label>Employee (required)</label>
                  <button class="buttonish has-caret" type="button" data-emp-btn="${id}">â€” Select â€”</button>
                  <div class="combo-panel"><div class="list" data-emp-list="${id}"></div></div>
                  <div class="help">Defaults to current user if listed.</div>
                </div>
                <div class="field">
                  <label>Pickup Date</label>
                  <input class="input" type="date" data-emp-date="${id}"/>
                </div>
              </div>

              <div class="field">
                <label>Notes</label>
                <textarea class="textarea" placeholder="Optional" data-emp-notes="${id}"></textarea>
              </div>

              <div class="field">
                <label>Optional Photos</label>
                <input class="input" type="file" accept="image/*,.jpg,.jpeg,.png,.heic,.pdf" multiple data-emp-files="${id}">
              </div>

              <div class="actions">
                <button class="btn" type="button" data-action="cancel-pickup" data-id="${id}">Cancel</button>
                <button class="btn btn-primary" type="button" data-action="confirm-pickup" data-id="${id}">Mark Picked Up</button>
              </div>

              <div class="help error" hidden data-emp-err="${id}"></div>
            </div>
          </div>
        `;
      }).join('');
    }

    async function savePickup(db, auth, row, ctxId){
      const errEl = document.querySelector(`[data-emp-err="${CSS.escape(ctxId)}"]`);
      errEl.hidden = true;

      const empBtn = document.querySelector(`[data-emp-btn="${CSS.escape(ctxId)}"]`);
      const empId  = empBtn?.dataset.value || "";
      if(!empId){ errEl.textContent="Please choose an employee."; errEl.hidden=false; return; }

      const me = auth.currentUser;
      const emp = EMPLOYEES.find(e=>e.id===empId) || {};
      const who = {
        employeeId: empId,
        name: emp.name || me?.displayName || me?.email || "Unknown",
        email: emp.email || me?.email || null
      };

      const dateEl = document.querySelector(`[data-emp-date="${CSS.escape(ctxId)}"]`);
      const when = (dateEl?.value || todayISO());
      const notesEl = document.querySelector(`[data-emp-notes="${CSS.escape(ctxId)}"]`);
      const filesEl = document.querySelector(`[data-emp-files="${CSS.escape(ctxId)}"]`);

      // Create pickUp event
      const pick = {
        type:'pickUp',
        field:{ id:CHOSEN_FIELD.id, name:CHOSEN_FIELD.name },
        refPutDownId: row.id,
        cropYear: YEAR,
        bagSku: row.bagSku || null,
        counts: row.counts || null,
        notes: (notesEl?.value||"").trim(),
        pickedUpDate: when,
        pickedUpBy: who,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      };
      const ref = await addDoc(collection(db,'grain_bag_events'), pick);

      // Photos
      const files = Array.from((filesEl?.files||[]));
      if(files.length){
        try{
          const { getStorage, ref:stRef, uploadBytes, getDownloadURL } = await loadStorageFns();
          const st = getStorage();
          const uploaded=[];
          for(const f of files){
            const safe=(Date.now()+'-'+f.name).replace(/[^\w.\-]+/g,'_');
            const path=`grain_bag_events/${ref.id}/${safe}`;
            const r = stRef(st,path);
            await uploadBytes(r, f, {contentType:f.type||'application/octet-stream'});
            const url=await getDownloadURL(r);
            uploaded.push({name:f.name, url, path});
          }
          await updateDoc(doc(db,'grain_bag_events',ref.id), { files:uploaded, updatedAt:serverTimestamp() });
        }catch(stErr){
          errEl.textContent = `Saved pickup, but photo upload failed: ${stErr.message}`;
          errEl.hidden=false;
        }
      }

      // Mark source putDown as pickedUp
      try{
        await updateDoc(doc(db,'grain_bag_events',row.id), {
          status:'pickedUp',
          pickedUpAt: when,
          pickedUpBy: who,
          updatedAt: serverTimestamp()
        });
      }catch(e){ console.warn("mark putDown pickedUp failed:", e); }

      toast("Bag marked as picked up.");

      // Refresh indexes + UI so fields drop out when empty
      await buildOpenIndexForYear(db);
      if(!OPEN_INDEX.has(CHOSEN_FIELD.id)){
        CHOSEN_FIELD=null; CHOSEN_CROP=null;
        $("fieldBtn").textContent="â€” Select field â€”";
        $("cropRow").hidden=true; $("summary").textContent="â€”";
        $("bagList").innerHTML=""; $("listHelp").textContent="Choose Field.";
        fieldCombo.setItems( getFieldsWithOpen().map(f=>({id:f.id, name:f.name})) );
      }else{
        const crops = cropsForField(CHOSEN_FIELD.id).map(c=>({id:c,label:c,value:c}));
        cropCombo.setItems(crops);
        if(CHOSEN_CROP && !crops.find(c=>c.value===CHOSEN_CROP)){
          CHOSEN_CROP = crops[0]?.value || null;
          $("cropBtn").textContent = CHOSEN_CROP || "â€” Select â€”";
        }
        await renderOpenBags();
      }
    }

    /* ===== Boot ===== */
    let db, auth;
    (async()=>{
      await ready;
      db = getFirestore(); auth = getAuth();

      YEAR = new Date().getFullYear();
      const YEARS = [YEAR-1,YEAR,YEAR+1].map(v=>({id:String(v), value:v, label:String(v)}));
      // render year choices
      const yl = document.getElementById('yearList'); yl.innerHTML = YEARS.map(x=>`<div class="combo-item" data-id="${x.id}">${x.label}</div>`).join('');
      document.getElementById('yearBtn').textContent = String(YEAR);

      await Promise.all([ loadEmployees(db, auth), loadFields(db) ]);
      await buildOpenIndexForYear(db);

      // Seed field list from OPEN_INDEX
      const startFields = getFieldsWithOpen().map(f=>({id:f.id, name:f.name}));
      const fieldComboObj = document.getElementById('fieldList');
      fieldComboObj.innerHTML = startFields.map(it=>`<div class="combo-item" data-id="${esc(it.id)}">${esc(it.name)}</div>`).join('') || `<div class="combo-empty">(no matches)</div>`;

      // Wire combos programmatically (we built them above)
      // Year combo already wired via makeCombo earlier:
      // Now reapply items so the helper can click
      const yearItems = YEARS.map(x=>({id:x.id,label:x.label,value:x.value}));
      (function ensureYearCombo(){
        const list = document.getElementById('yearList');
        list.innerHTML = yearItems.map(x=>`<div class="combo-item" data-id="${esc(x.id)}">${esc(x.label)}</div>`).join('');
      })();

      // Field search filter
      document.getElementById('fieldSearch').addEventListener('input', (e)=>{
        const q=(e.target.value||"").toLowerCase();
        const base = getFieldsWithOpen().map(f=>({id:f.id, name:f.name}));
        const list = base.filter(f=>!q || f.name.toLowerCase().includes(q));
        document.getElementById('fieldList').innerHTML =
          list.map(it=>`<div class="combo-item" data-id="${esc(it.id)}">${esc(it.name)}</div>`).join('') || `<div class="combo-empty">(no matches)</div>`;
      });

      // Delegate clicks in field list to work with our combo helper
      document.getElementById('fieldList').addEventListener('click', async (e)=>{
        const el = e.target.closest('.combo-item');
        if(!el) return;
        const id = el.dataset.id;
        const match = getFieldsWithOpen().find(f=>f.id===id);
        if(!match) return;
        CHOSEN_FIELD = {id:match.id, name:match.name};
        document.getElementById('fieldBtn').textContent = match.name;

        const crops = cropsForField(match.id).map(c=>({id:c,label:c,value:c}));
        // render crop options
        document.getElementById('cropList').innerHTML =
          crops.map(c=>`<div class="combo-item" data-id="${esc(c.id)}">${esc(c.label)}</div>`).join('') || `<div class="combo-empty">(no matches)</div>`;
        if(crops.length){
          CHOSEN_CROP = crops[0].value;
          document.getElementById('cropBtn').textContent = crops[0].label;
          document.getElementById('cropRow').hidden = false;
        }else{
          CHOSEN_CROP = null;
          document.getElementById('cropRow').hidden = true;
        }
        await renderOpenBags();
      });

      // Bag list actions
      document.getElementById('bagList').addEventListener('click', async (e)=>{
        const btn = e.target.closest("button");
        if(!btn) return;
        const id = btn.getAttribute("data-id");
        const action = btn.getAttribute("data-action");
        if(!id || !action) return;

        const rows = rowsForCurrent();
        const row = rows.find(r=>r.id===id);
        if(!row) return;

        if(action==="open-pickup"){
          const form = document.getElementById("pf-"+id);
          if(!form) return;
          form.hidden=false;

          const dateEl = form.querySelector(`[data-emp-date="${CSS.escape(id)}"]`);
          if(dateEl) dateEl.value = todayISO();

          // Build employee combo
          const empBtn = form.querySelector(`[data-emp-btn="${CSS.escape(id)}"]`);
          const empPanel = empBtn?.nextElementSibling;
          const empList = form.querySelector(`[data-emp-list="${CSS.escape(id)}"]`);
          // simple list
          empList.innerHTML = (EMPLOYEES||[]).map(e=>`<div class="combo-item" data-id="${esc(e.id)}">${esc(e.name)}</div>`).join('') || `<div class="combo-empty">(no matches)</div>`;
          empBtn.addEventListener('click', (ev)=>{ ev.stopPropagation(); closeAllCombos(empPanel); empPanel.classList.toggle('show'); });

          empList.addEventListener('click', (ev)=>{
            const it = ev.target.closest('.combo-item'); if(!it) return;
            const picked = EMPLOYEES.find(x=>x.id===it.dataset.id);
            if(picked){ empBtn.textContent=picked.name; empBtn.dataset.value=picked.id; }
            empPanel.classList.remove('show');
          });
          const me = (auth.currentUser?.email||"").toLowerCase();
          const mine = EMPLOYEES.find(e=> (e.email||"").toLowerCase()===me ) || EMPLOYEES[0];
          if(mine){ empBtn.textContent=mine.name; empBtn.dataset.value=mine.id; }
        }

        if(action==="cancel-pickup"){
          const form = document.getElementById("pf-"+id);
          if(form) form.hidden = true;
        }

        if(action==="confirm-pickup"){
          await savePickup(db, auth, row, id);
        }
      });

      // Close combos on Escape
      document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeAllCombos(); });

      // Network hints
      window.addEventListener('online', ()=> toast("Back online â€” syncingâ€¦", 3000));
      window.addEventListener('offline',()=> toast("Currently offline â€” using saved data", 3000));
    })();
  </script>
</body>
</html>
