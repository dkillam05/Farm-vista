<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista â€¢ Pick Up Bag</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- Absolute paths -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>

  <!-- Theme + app CSS -->
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <!-- Ensure fv-shell is present -->
  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true;
        document.head.appendChild(s);
      }
    })();
  </script>

  <style>
    :root{
      --card-max:1100px;
      --page-bottom-gap:96px;
      --accent:#2F6C3C;
    }
    body{ background:var(--app-bg,var(--surface)); }

    .wrap{
      max-width:var(--card-max);
      margin:0 auto;
      padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + var(--page-bottom-gap))!important;
    }

    .hero{
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));
      overflow:hidden;
      margin-bottom:var(--page-bottom-gap);
    }
    .hero-head{
      display:grid;grid-template-columns:36px 1fr;gap:12px;align-items:center;
      padding:14px 16px;border-bottom:1px solid var(--border);
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);
    }
    .hero-head .icon{width:24px;height:24px;color:var(--accent);display:grid;place-items:center}
    .hero-head h1{margin:0;font-size:clamp(20px,3.2vw,26px)}
    .muted{color:var(--muted,#67706B)}
    .body{padding:16px;display:grid;gap:14px}
    .row{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    @media (max-width:880px){.row{grid-template-columns:1fr}}

    .field label{display:block;font-weight:800;margin:0 0 6px}
    .input,.select,.textarea,.buttonish{
      width:100%;font:inherit;font-size:16px;color:var(--text);
      background:var(--card-surface,var(--surface));border:1px solid var(--border);
      border-radius:10px;padding:12px;outline:none
    }
    .textarea{min-height:110px;resize:vertical}
    .buttonish{cursor:pointer;text-align:left}
    .help{font-size:13px;color:var(--muted,#67706B);margin-top:6px}
    .error{color:#b00020;font-weight:700}

    .cards{display:grid;grid-template-columns:1fr;gap:10px}
    .card{
      border:1px solid var(--border);border-radius:12px;background:var(--surface);
      padding:12px;display:grid;gap:10px
    }
    .badge{display:inline-block;border:1px solid var(--border);border-radius:999px;padding:4px 10px}
    .kvs{display:flex;flex-wrap:wrap;gap:10px}
    .kv{background:var(--card-surface,var(--surface));border:1px dashed var(--border);border-radius:10px;padding:8px 10px}

    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;justify-content:center;min-width:140px;
      padding:10px 14px;border-radius:12px;border:1px solid var(--border);
      background:var(--card-surface,var(--surface));font-weight:800;color:var(--text)!important;cursor:pointer}
    .btn-primary{border-color:transparent;background:#2F6C3C;color:#fff!important}

    /* Bottom sheet for pickup */
    .sheet{position:fixed;inset:auto 0 0 0;background:var(--surface);border-top:1px solid var(--border);
      box-shadow:0 -12px 30px rgba(0,0,0,.18);border-radius:16px 16px 0 0;transform:translateY(105%);transition:transform .25s ease;z-index:10000}
    .sheet.show{transform:translateY(0)}
    .sheet .cap{display:flex;align-items:center;gap:10px;padding:12px 14px;border-bottom:1px solid var(--border)}
    .sheet .cap .bar{width:40px;height:4px;border-radius:4px;background:#CBCDCB;margin:0 auto}
    .sheet .inner{padding:14px;display:grid;gap:12px}
    .grid-2{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    @media (max-width:880px){.grid-2{grid-template-columns:1fr}}

    .toast{position:fixed;left:50%;bottom:calc(env(safe-area-inset-bottom,0px) + 72px);transform:translateX(-50%);
      background:#2F6C3C;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.25);z-index:99999;display:none}
    .toast.show{display:block;animation:fadeout 5s forwards}
    @keyframes fadeout{0%{opacity:1}85%{opacity:1}100%{opacity:0}}
  </style>
</head>

<body>
  <fv-shell>
    <div class="wrap">
      <section class="hero">
        <header class="hero-head">
          <div class="icon" aria-hidden="true">ðŸ§²</div>
          <div>
            <h1>Pick Up Bag</h1>
            <p class="muted">Choose a field, then select which bag(s) to mark as picked up.</p>
          </div>
        </header>

        <div class="body">
          <!-- Field picker -->
          <div class="row">
            <div class="field">
              <label for="fieldBtn">Field</label>
              <button id="fieldBtn" class="buttonish" type="button">â€” Select field â€”</button>
              <div id="fieldHelp" class="help">0 fields</div>
            </div>

            <div class="field">
              <label for="pickedUpDate">Pickup Date</label>
              <input id="pickedUpDate" class="input" type="date"/>
              <div class="help">Defaults to today; you can change if needed.</div>
            </div>
          </div>

          <!-- Open bags list -->
          <div class="field">
            <label>Open Bags in Field</label>
            <div id="listHelp" class="help">Select a field to load open bags.</div>
            <div id="bagList" class="cards"></div>
          </div>

          <div id="pageErr" class="help error" hidden></div>
        </div>
      </section>
    </div>
  </fv-shell>

  <!-- Field Picker Sheet -->
  <div id="fieldSheet" class="sheet" role="dialog" aria-modal="true" aria-labelledby="fieldTitle">
    <div class="cap"><div class="bar" aria-hidden="true"></div></div>
    <div class="inner">
      <input id="fieldSearch" class="input" type="search" placeholder="Search fieldsâ€¦" autocomplete="off"/>
      <div id="fieldList" style="max-height:50vh;overflow:auto"></div>
    </div>
  </div>

  <!-- Pickup Sheet -->
  <div id="pickupSheet" class="sheet" role="dialog" aria-modal="true" aria-labelledby="pickupTitle">
    <div class="cap"><div class="bar" aria-hidden="true"></div></div>
    <div class="inner">
      <h3 id="pickupTitle" style="margin:0 0 4px">Complete Pickup</h3>
      <div id="pickupMeta" class="help"></div>

      <div class="grid-2">
        <div class="field">
          <label for="employee">Employee (required)</label>
          <select id="employee" class="select"></select>
          <div id="empHelp" class="help">Defaults to current user if listed.</div>
        </div>
        <div class="field">
          <label for="sheetDate">Pickup Date</label>
          <input id="sheetDate" class="input" type="date"/>
        </div>
      </div>

      <div class="field">
        <label for="sheetNotes">Notes</label>
        <textarea id="sheetNotes" class="textarea" placeholder="Optional"></textarea>
      </div>

      <div class="field">
        <label for="sheetFiles">Optional Photos</label>
        <input id="sheetFiles" class="input" type="file" accept="image/*,.jpg,.jpeg,.png,.heic,.pdf" multiple>
      </div>

      <div id="sheetErr" class="help error" hidden></div>

      <div class="actions">
        <button id="cancelPickup" class="btn" type="button">Cancel</button>
        <button id="confirmPickup" class="btn btn-primary" type="button">Mark Picked Up</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite">Saved.</div>

  <!-- Firebase (modular) -->
  <script type="module">
    import {
      ready, getFirestore, getAuth,
      collection, getDocs, addDoc, doc, updateDoc,
      serverTimestamp, query, orderBy, where
    } from '/Farm-vista/js/firebase-init.js';

    // Lazy Storage
    async function loadStorageFns(){
      const m = await import('/Farm-vista/js/firebase-init.js');
      return { getStorage:m.getStorage, ref:m.ref, uploadBytes:m.uploadBytes, getDownloadURL:m.getDownloadURL };
    }

    /* ---------- utils ---------- */
    const $ = id => document.getElementById(id);
    const esc = s => String(s??"").replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;",'"':"&quot;","'":"&#39;"}[m]));
    function todayISO(){ const d=new Date(); const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${da}`; }
    function toast(msg="Saved.", ms=4200){ const t=$("toast"); t.textContent=msg; t.classList.remove("show"); void t.offsetWidth; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),ms); }

    /* ---------- state ---------- */
    let FIELD_INDEX = [];         // [{id,name}]
    let EMPLOYEES   = [];         // [{id,name,email}]
    let chosenField = null;       // {id,name}
    let OPEN_PUTDOWNS = [];       // array of putDown docs for field
    let PICK_TARGET = null;       // current selected putDown doc for pickup

    /* ---------- field list ---------- */
    async function loadFields(db){
      try{
        const snap = await getDocs(query(collection(db,'fields'), orderBy('name')));
        const items = [];
        snap.forEach(d=>{
          const x=d.data()||{};
          const name=String(x.name||"").trim();
          if(name) items.push({id:d.id, name});
        });
        items.sort((a,b)=>a.name.localeCompare(b.name));
        FIELD_INDEX = items;
        $("fieldList").innerHTML = items.map(it=>`<div class="card item" data-id="${esc(it.id)}">${esc(it.name)}</div>`).join('');
        $("fieldHelp").textContent = `${items.length} fields`;
      }catch(err){
        console.warn("loadFields:", err);
        $("fieldHelp").textContent = "0 fields (load error)";
      }
    }
    function openFieldSheet(){ $("fieldSheet").classList.add('show'); $("fieldSearch").value=""; $("fieldSearch").focus(); filterFields(""); }
    function closeFieldSheet(){ $("fieldSheet").classList.remove('show'); }
    function filterFields(q){
      q=(q||"").toLowerCase().trim();
      const out = FIELD_INDEX.filter(f=>!q || f.name.toLowerCase().includes(q))
        .map(it=>`<div class="card item" data-id="${esc(it.id)}">${esc(it.name)}</div>`).join('');
      $("fieldList").innerHTML = out || `<div class="card">(no matches)</div>`;
    }

    /* ---------- employees ---------- */
    async function loadEmployees(db, auth){
      const list=[];
      try{
        const snap = await getDocs(collection(db,'employees'));
        snap.forEach(d=>{
          const x=d.data()||{};
          const name = String(x.name || x.displayName || x.fullName || x.email || d.id);
          const email = x.email || d.id;
          list.push({id:d.id, name, email});
        });
      }catch(e){ /* ignore, fall back to current user only */ }
      list.sort((a,b)=> (a.name||"").localeCompare(b.name||""));
      EMPLOYEES = list;

      const sel = $("employee");
      if(list.length){
        sel.innerHTML = list.map(e=>`<option value="${esc(e.id)}">${esc(e.name)}${e.email?' â€” '+esc(e.email):''}</option>`).join('');
        // default to current user if present
        const me = ( (await getAuth().currentUser)?.email || "" ).toLowerCase();
        const mine = EMPLOYEES.find(e=> (e.email||"").toLowerCase()===me );
        if(mine) sel.value = mine.id;
      }else{
        const me = getAuth().currentUser;
        const name = me?.displayName || me?.email || "Unknown";
        sel.innerHTML = `<option value="${esc(me?.uid||'self')}">${esc(name)}</option>`;
      }
      $("empHelp").textContent = `${EMPLOYEES.length || 1} employee option(s)`;
    }

    /* ---------- list open putDowns ---------- */
    async function loadOpenBags(db){
      $("bagList").innerHTML = "";
      $("listHelp").textContent = chosenField ? "Loadingâ€¦" : "Select a field to load open bags.";
      OPEN_PUTDOWNS = [];
      if(!chosenField) return;

      try{
        // Grab all putDowns; filter client-side by field & status
        const snap = await getDocs(query(collection(db,'grain_bag_events'), where('type','==','putDown'), orderBy('priority')));
        const rows = [];
        snap.forEach(d=>{
          const x=d.data()||{};
          const isField = x.field?.id === chosenField.id;
          const open = !x.status || x.status !== 'pickedUp';
          if(isField && open){
            rows.push({id:d.id, ...x});
          }
        });
        // sort: higher priority first, then datePlaced asc
        rows.sort((a,b)=> (Number(b.priority||0) - Number(a.priority||0)) || String(a.datePlaced||"").localeCompare(String(b.datePlaced||"")) );
        OPEN_PUTDOWNS = rows;

        if(!rows.length){
          $("bagList").innerHTML = `<div class="card">No open bags for this field.</div>`;
          $("listHelp").textContent = "â€”";
          return;
        }

        $("listHelp").textContent = `${rows.length} open bag(s)`;
        $("bagList").innerHTML = rows.map(r=>{
          const sku = `${esc(r.bagSku?.brand||'Bag')} â€” ${esc(r.bagSku?.sizeFeet||'?')} ft`;
          const counts = `${Number(r.counts?.full||0)} full, ${Number(r.counts?.partial||0)} partial`;
          const pr = Number(r.priority||0);
          return `
          <div class="card">
            <div class="kvs">
              <span class="kv"><b>Placed:</b> ${esc(r.datePlaced||'â€”')}</span>
              <span class="kv"><b>SKU:</b> ${sku}</span>
              <span class="kv"><b>Count:</b> ${esc(counts)}</span>
              <span class="kv"><b>Priority:</b> <span class="badge">${pr}</span></span>
            </div>
            <div class="help">By: ${esc(r.submittedBy?.name || r.submittedBy?.email || 'Unknown')}</div>
            <div class="actions">
              <button class="btn btn-primary" data-pick="${esc(r.id)}">Pick Up</button>
            </div>
          </div>`;
        }).join('');
      }catch(err){
        $("pageErr").hidden = false;
        $("pageErr").textContent = `Failed to load open bags: ${err.message}`;
      }
    }

    /* ---------- pickup flow ---------- */
    function openPickupSheet(row){
      PICK_TARGET = row;
      $("sheetErr").hidden = true;
      $("sheetNotes").value = "";
      $("sheetFiles").value = "";
      $("sheetDate").value = $("pickedUpDate").value || todayISO();

      const sku = `${esc(row.bagSku?.brand||'Bag')} â€” ${esc(row.bagSku?.sizeFeet||'?')} ft`;
      const counts = `${Number(row.counts?.full||0)} full, ${Number(row.counts?.partial||0)} partial`;
      $("pickupMeta").innerHTML = `
        Field: <b>${esc(chosenField?.name||'')}</b> â€¢ Placed: <b>${esc(row.datePlaced||'â€”')}</b><br/>
        SKU: <b>${sku}</b> â€¢ Count: <b>${esc(counts)}</b> â€¢ Priority: <b>${Number(row.priority||0)}</b>
      `;
      $("pickupSheet").classList.add('show');
    }
    function closePickupSheet(){ $("pickupSheet").classList.remove('show'); PICK_TARGET = null; }

    async function savePickup(db, auth){
      $("sheetErr").hidden = true;
      if(!PICK_TARGET) return;
      const empId = $("employee").value;
      if(!empId){ $("sheetErr").hidden=false; $("sheetErr").textContent="Please choose an employee."; return; }
      const emp = EMPLOYEES.find(e=>e.id===empId) || {};
      const who = {
        employeeId: empId,
        name: emp.name || auth.currentUser?.displayName || auth.currentUser?.email || "Unknown",
        email: emp.email || auth.currentUser?.email || null
      };
      const when = $("sheetDate").value || todayISO();

      // Create a pickUp event
      const pick = {
        type: 'pickUp',
        field: { id: chosenField.id, name: chosenField.name },
        refPutDownId: PICK_TARGET.id,
        bagSku: PICK_TARGET.bagSku || null,
        counts: PICK_TARGET.counts || null,
        notes: $("sheetNotes").value.trim(),
        pickedUpDate: when,
        pickedUpBy: who,
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      };
      const ref = await addDoc(collection(db,'grain_bag_events'), pick);

      // Optional photos
      const files = Array.from(($("sheetFiles").files||[]));
      if(files.length){
        try{
          const { getStorage, ref:stRef, uploadBytes, getDownloadURL } = await loadStorageFns();
          const st = getStorage();
          const uploaded = [];
          for(const f of files){
            const safe = (Date.now()+'-'+f.name).replace(/[^\w.\-]+/g,'_');
            const path = `grain_bag_events/${ref.id}/${safe}`;
            const r = stRef(st, path);
            await uploadBytes(r, f, { contentType:f.type || 'application/octet-stream' });
            const url = await getDownloadURL(r);
            uploaded.push({name:f.name, url, path});
          }
          await updateDoc(doc(db,'grain_bag_events',ref.id), { files: uploaded, updatedAt: serverTimestamp() });
        }catch(stErr){
          $("sheetErr").hidden=false;
          $("sheetErr").textContent = `Saved pickup, but photo upload failed: ${stErr.message}`;
        }
      }

      // Update source putDown as picked up
      try{
        await updateDoc(doc(db,'grain_bag_events',PICK_TARGET.id), {
          status: 'pickedUp',
          pickedUpAt: when,
          pickedUpBy: who,
          updatedAt: serverTimestamp()
        });
      }catch(e){
        console.warn("mark putDown pickedUp failed:", e);
      }

      closePickupSheet();
      toast("Bag marked as picked up.");
      await loadOpenBags(db); // refresh list
    }

    /* ---------- boot ---------- */
    (async()=>{
      const ctx = await ready;
      const db = getFirestore();
      const auth = getAuth();

      // Defaults
      $("pickedUpDate").value = todayISO();

      // Load lists
      await Promise.all([ loadFields(db), loadEmployees(db, auth) ]);

      // Field picker wiring
      $("fieldBtn").addEventListener("click", openFieldSheet);
      $("fieldSearch").addEventListener("input", (e)=> filterFields(e.target.value));
      $("fieldList").addEventListener("click", (e)=>{
        const el = e.target.closest(".item");
        if(!el) return;
        const id = el.dataset.id;
        const it = FIELD_INDEX.find(f=>f.id===id);
        if(it){ chosenField = it; $("fieldBtn").textContent = it.name; closeFieldSheet(); loadOpenBags(db); }
      });
      document.addEventListener("keydown", (e)=>{ if(e.key==="Escape"){ closeFieldSheet(); closePickupSheet(); } });

      // List item buttons â†’ open pickup sheet
      $("bagList").addEventListener("click", (e)=>{
        const b = e.target.closest("button[data-pick]");
        if(!b) return;
        const id = b.getAttribute("data-pick");
        const row = OPEN_PUTDOWNS.find(r=>r.id===id);
        if(row) openPickupSheet(row);
      });

      // Pickup sheet controls
      $("cancelPickup").addEventListener("click", closePickupSheet);
      $("confirmPickup").addEventListener("click", ()=> savePickup(db, auth));

      // Helpful network toasts
      window.addEventListener('online', ()=> toast("Back online â€” syncingâ€¦", 3000));
      window.addEventListener('offline',()=> toast("Currently offline â€” using saved data", 3000));
    })();
  </script>

  <!-- Notes:
       â€¢ Reads open putDowns from /grain_bag_events where type=='putDown' (client-filter by field & !pickedUp).
       â€¢ Saves a new 'pickUp' event + marks the source putDown status to 'pickedUp'.
       â€¢ Requires Employee selection to confirm pickup.
       â€¢ Photos are optional and use lazy Storage load.
  -->
</body>
</html>