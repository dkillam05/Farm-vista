<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista • Add to Grain Bin Inventory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- Standard includes (ABSOLUTE paths) -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <!-- Shell + Core -->
  <script src="/Farm-vista/js/version.js" defer></script>
  <script src="/Farm-vista/js/core.js" defer></script>
  <script src="/Farm-vista/js/fv-shell.js" defer></script>

  <!-- Firebase config (expects window.firebaseConfig) -->
  <script src="/Farm-vista/js/firebase-config.js"></script>

  <style>
    .page{max-width:1100px;margin:0 auto;padding:clamp(14px,3vw,22px)}
    .card{border-radius:16px}
    .grid{display:grid;gap:12px}
    @media(min-width:800px){.grid{grid-template-columns:1fr 1fr}}
    label{font-weight:600}
    input, select, textarea{
      width:100%;padding:10px 12px;border:1px solid var(--surface-3,#d6d6d6);
      border-radius:12px;outline:none;background:var(--surface-1,#fff)
    }
    /* Rounded corners only; let theme handle the rest */
    select{appearance:auto}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .btn{border:0;border-radius:999px;padding:10px 16px;font-weight:700;cursor:pointer}
    .btn-primary{} /* use themed colors */
    .btn-ghost{}
    .muted{opacity:.8}
  </style>

  <!-- Firebase SDK (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
    import { getFirestore, collection, query, where, orderBy, getDocs, doc, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
    import { getAuth } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

    const $ = s => document.querySelector(s);
    const notify = (msg)=>{
      if(window.FV && typeof window.FV.toast === 'function'){ window.FV.toast(msg); }
      else { alert(msg); }
    };

    // Init
    const app = initializeApp(window.firebaseConfig);
    const db  = getFirestore(app);
    const auth = getAuth(app);

    // DOM
    const siteSel = () => $('#site');
    const binSel  = () => $('#bin');
    const cropSel = () => $('#crop');
    const yearInp = () => $('#cropYear');
    const buInp   = () => $('#bushels');
    const moistInp= () => $('#moisture');
    const noteInp = () => $('#note');
    const saveBtn = () => $('#saveBtn');

    async function loadSites(){
      const qSites = query(collection(db,'grainBinSites'), where('archived','!=',true), orderBy('archived'), orderBy('name'));
      const snap = await getDocs(qSites);
      siteSel().innerHTML = `<option value="" disabled selected>Select a bin site…</option>` +
        snap.docs.map(d => `<option value="${d.id}">${(d.data().name||'Unnamed')}</option>`).join('');
      siteSel().disabled = false;
    }

    async function loadBins(siteId){
      binSel().innerHTML = `<option value="" disabled selected>Select a bin…</option>`;
      binSel().disabled = true;
      if(!siteId) return;
      const qBins = query(collection(db,'grainBins'),
                          where('archived','!=',true),
                          where('siteId','==',siteId),
                          orderBy('name'));
      const snap = await getDocs(qBins);
      binSel().innerHTML += snap.docs.map(d => `<option value="${d.id}">${(d.data().name||d.data().binNumber||'Bin')}</option>`).join('');
      binSel().disabled = false;
    }

    async function save(){
      const siteId = siteSel().value;
      const binId  = binSel().value;
      const crop   = (cropSel().value||'').trim();
      const cropYear = yearInp().value ? parseInt(yearInp().value,10) : null;
      const bushels  = parseFloat(buInp().value);
      const moisture = moistInp().value ? parseFloat(moistInp().value) : null;
      const note = (noteInp().value||'').trim();

      if(!siteId || !binId || !bushels || isNaN(bushels)){
        notify('Please complete Site, Bin, and Bushels.'); return;
      }

      const user = auth.currentUser;
      const submittedBy = user?.displayName || 'Dane Killam';

      const binRef = doc(db,'grainBins',binId);

      await runTransaction(db, async (tx)=>{
        // movement
        const mv = doc(collection(db,'binMovements'));
        tx.set(mv, {
          direction:'in', siteId, binId, crop: crop||null, cropYear,
          bushels, moisture, note: note||null, timestamp: serverTimestamp(), submittedBy
        });

        // tally
        const snap = await tx.get(binRef);
        const curr = Number(snap.data()?.currentBushels||0);
        tx.update(binRef, { currentBushels: curr + bushels });
      });

      notify('Added to inventory');
      setTimeout(()=>location.href='/Farm-vista/pages/grain/grain-bins.html', 600);
    }

    document.addEventListener('DOMContentLoaded', async ()=>{
      await loadSites();
      siteSel().addEventListener('change', e=> loadBins(e.target.value));
      saveBtn().addEventListener('click', save);
    });
  </script>
</head>
<body>
  <fv-shell>
    <div class="page container">
      <h1 class="page-title">Add to Inventory</h1>
      <p class="page-sub muted">Deposit bushels into a bin. Select a site first, then choose a bin.</p>

      <div class="card">
        <div class="card-body grid">
          <div>
            <label for="site">Grain Bin Site</label>
            <select id="site" disabled>
              <option>Loading sites…</option>
            </select>
          </div>

          <div>
            <label for="bin">Bin</label>
            <select id="bin" disabled>
              <option>Select a site first…</option>
            </select>
          </div>

          <div class="row">
            <div>
              <label for="crop">Crop (optional)</label>
              <select id="crop">
                <option value="">-- Select --</option>
                <option>Corn</option>
                <option>Soybeans</option>
                <option>Wheat</option>
                <option>Other</option>
              </select>
            </div>
            <div>
              <label for="cropYear">Crop Year (optional)</label>
              <input id="cropYear" type="number" inputmode="numeric" placeholder="2025"/>
            </div>
          </div>

          <div class="row">
            <div>
              <label for="bushels">Bushels</label>
              <input id="bushels" type="number" inputmode="decimal" placeholder="e.g. 1,200"/>
            </div>
            <div>
              <label for="moisture">Moisture % (optional)</label>
              <input id="moisture" type="number" inputmode="decimal" step="0.1" placeholder="e.g. 15.3"/>
            </div>
          </div>

          <div>
            <label for="note">Note (optional)</label>
            <textarea id="note" rows="3" placeholder="Ticket #, source, etc."></textarea>
          </div>

          <div class="actions">
            <button id="saveBtn" class="btn btn-primary">Add to Inventory</button>
            <a class="btn btn-ghost" href="/Farm-vista/pages/grain/grain-bins.html">Cancel</a>
          </div>
        </div>
      </div>
    </div>
  </fv-shell>

  <noscript>
    <div class="container"><div class="card">JavaScript is required.</div></div>
  </noscript>
</body>
</html>