<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista • Add to Grain Bin Inventory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- Absolute paths -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>

  <!-- Theme + base -->
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <!-- Grain capacity helpers (crop-based capacity) -->
  <script src="/Farm-vista/js/grain-capacity.js"></script>

  <!-- Ensure fv-shell -->
  <script>(function(){if(!customElements.get('fv-shell')){const s=document.createElement('script');s.src='/Farm-vista/js/fv-shell.js';s.defer=true;document.head.appendChild(s);}})();</script>

  <style>
    :root{
      --card-max:1100px;
      --page-bottom-gap:96px;
      --accent:#2F6C3C;

      /* match your combo template */
      --combo-gap:4px;
      --combo-radius:12px;
      --combo-btn-radius:10px;
    }

    body{ background:var(--app-bg,var(--surface)); }
    .wrap{
      max-width:var(--card-max);
      margin:0 auto;
      padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + var(--page-bottom-gap))!important;
    }
    .hero{
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));
      overflow:hidden;
      margin-bottom:var(--page-bottom-gap);
    }
    .hero-head{
      display:grid;grid-template-columns:36px 1fr;gap:12px;align-items:center;
      padding:14px 16px;border-bottom:1px solid var(--border);
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);
    }
    .hero-head .icon{width:24px;height:24px;color:var(--accent);display:grid;place-items:center}
    .hero-head h1{margin:0;font-size:clamp(20px,3.2vw,26px);line-height:1.2}
    .muted{color:var(--muted,#67706B)}
    .body{padding:16px;display:grid;gap:14px}

    .row{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    @media (max-width:880px){.row{grid-template-columns:1fr}}

    .field label{display:block;font-weight:800;margin:0 0 6px}

    /* Inputs + selects: tight + rounded */
    .field .input,
    .field .select{
      width:100%;
      font:inherit;
      font-size:16px;
      color:var(--text);
      background:var(--card-surface,var(--surface));
      border:1px solid var(--border) !important;
      border-radius:var(--combo-btn-radius) !important;
      padding:10px 12px !important;
      min-height:40px;
      line-height:1.2;
      outline:none;
      background-clip:padding-box;
    }

    .field .select{
      -webkit-appearance:none !important;
      -moz-appearance:none !important;
      appearance:none !important;
      position:relative;
      background-image:
        url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="14" height="8" viewBox="0 0 14 8"><path d="M1 1l6 6 6-6" fill="none" stroke="%2367706B" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>');
      background-repeat:no-repeat;
      background-position:right 12px center;
      background-size:14px 8px;
      padding-right:42px !important;
      cursor:pointer;
    }
    .field .select::-ms-expand{ display:none; }

    .field .input:focus, .field .select:focus{
      border-color: color-mix(in srgb, var(--accent), #000 15%) !important;
      box-shadow: 0 0 0 2px color-mix(in srgb, var(--accent), transparent 70%);
    }
    .field .input:hover, .field .select:hover{
      border-color: color-mix(in srgb, var(--border), #000 20%) !important;
    }

    .help{font-size:13px;color:var(--muted,#67706B);margin-top:6px}

    .actions{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:6px}
    .btn{
      display:inline-flex;align-items:center;justify-content:center;min-width:160px;
      padding:12px 16px;border-radius:12px;border:1px solid var(--border);
      background:var(--card-surface,var(--surface));font-weight:800;color:var(--text)!important;cursor:pointer
    }
    .btn-primary{border-color:transparent;background:#2F6C3C;color:#fff!important}
    .btn[disabled]{opacity:.5;cursor:not-allowed}

    .invalid{ color:#b00020 !important; border-color:#b00020 !important; }

    .toast{
      position:fixed;left:50%;bottom:calc(env(safe-area-inset-bottom,0px) + 72px);transform:translateX(-50%);
      background:#2F6C3C;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.25);z-index:99999;display:none
    }
    .toast.show{display:block;animation:fadeout 2.2s forwards}
    @keyframes fadeout{0%{opacity:1}70%{opacity:1}100%{opacity:0}}
    .error{color:#b00020;font-weight:700}
  </style>
</head>

<body>
  <fv-shell>
    <div class="wrap">
      <section class="hero">
        <header class="hero-head">
          <div class="icon" aria-hidden="true">➕</div>
          <div>
            <h1>Add to Grain Bin Inventory</h1>
            <p class="muted">Select a site, then crop type to see bins that can accept that grain.</p>
          </div>
        </header>

        <div class="body">
          <div class="row">
            <div class="field">
              <label for="site">Grain Bin Site</label>
              <select id="site" class="select"><option value="">— Loading… —</option></select>
              <div id="siteHelp" class="help">0 sites</div>
            </div>

            <div class="field">
              <label for="cropType">Crop Type</label>
              <select id="cropType" class="select">
                <option value="">— Select —</option>
                <option value="Corn">Corn</option>
                <option value="Soybeans">Soybeans</option>
                <option value="Wheat">Wheat</option>
              </select>
              <div class="help">Pick crop after selecting a site to filter bins.</div>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="bin">Bin</label>
              <select id="bin" class="select" disabled>
                <option value="">Select a site & crop first…</option>
              </select>
              <div id="binHelp" class="help">—</div>
            </div>

            <div class="field">
              <label for="cropMoisture">Crop Moisture (%)</label>
              <input id="cropMoisture" class="input" type="number" step="0.1" inputmode="decimal" placeholder="e.g. 15.3"/>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="submittedBy">Submitted By</label>
              <select id="submittedBy" class="select">
                <option value="">— Loading employees… —</option>
              </select>
              <div id="submittedByHelp" class="help">—</div>
            </div>
            <div class="field">
              <label for="date">Date</label>
              <input id="date" class="input" type="date"/>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="bushels">Bushels</label>
              <input id="bushels" class="input" type="number" inputmode="decimal" placeholder="e.g. 1,200"/>
              <div id="capHelp" class="help">Capacity: — • On hand: — • After add: —</div>
            </div>
            <div class="field">
              <label for="note">Note (optional)</label>
              <input id="note" class="input" placeholder="Ticket #, source, etc."/>
            </div>
          </div>

          <div id="err" class="help error" hidden></div>

          <div class="actions">
            <button id="btnSave" class="btn btn-primary" type="button" disabled>Add to Inventory</button>
            <a class="btn" href="/Farm-vista/pages/grain/grain-bins.html">Cancel</a>
          </div>
        </div>
      </section>
    </div>
  </fv-shell>

  <div id="toast" class="toast" role="status" aria-live="polite">Saved.</div>

  <script type="module">
    import {
      ready, getFirestore, getAuth,
      collection, getDocs, doc, getDoc, setDoc, addDoc,
      serverTimestamp, query, orderBy
    } from '/Farm-vista/js/firebase-init.js';

    const $=id=>document.getElementById(id);
    const esc=s=>String(s||"").replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
    function toast(msg="Saved.", ms=2200){ const t=$("toast"); t.textContent=msg; t.classList.remove("show"); void t.offsetWidth; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"), ms); }

    let SITES=[]; let CURRENT_SITE=null; let CURRENT_BIN_INDEX=-1;

    const todayISO=()=>new Date().toISOString().slice(0,10);

    function getSelectedCropRaw(){
      return $("cropType").value || "";
    }

    function getSelectedCropId(){
      // normalize to something FVGrainCapacity understands
      const raw = getSelectedCropRaw();
      return raw || "Corn";
    }

    function getEffectiveCapacityForCrop(cornCap, cropId){
      let cap = Number(cornCap) || 0;
      const g = (typeof window !== "undefined" ? window.FVGrainCapacity : null);
      if (g && typeof g.capacityForCrop === "function") {
        cap = g.capacityForCrop(cap, cropId, { round:true });
      }
      return cap;
    }

    function cropsMatch(lastCrop, selectedCropId){
      const g = (typeof window !== "undefined" ? window.FVGrainCapacity : null);
      if (!lastCrop) return false;
      const last = String(lastCrop);
      const selId = selectedCropId || "Corn";

      if (g && typeof g.getFactor === "function") {
        return g.getFactor(last) === g.getFactor(selId);
      }
      return last.trim().toLowerCase() === selId.trim().toLowerCase();
    }

    function hasRoomForCrop(b, cropId){
      if(!b) return false;
      const cornCap = +b.bushels || 0;
      const on = +b.onHand || 0;
      if (cornCap <= 0) return false;

      const effCap = getEffectiveCapacityForCrop(cornCap, cropId);
      const hasCapacity = effCap > 0 && on < effCap;

      // If no grain in bin, any crop is allowed (as long as capacity)
      if (!(on > 0)) return hasCapacity;

      // Grain on hand — only allow same crop
      const lastCrop = b.lastCropType || b.cropType || null;
      if (!lastCrop) return false;
      return hasCapacity && cropsMatch(lastCrop, cropId);
    }

    function getSelectedEmployee(){
      const sel = $("submittedBy");
      const uid = sel.value || null; // your employees doc id appears to be email
      const name = sel.options[sel.selectedIndex]?.textContent || null;
      return { uid, name };
    }

    async function loadEmployees(db, auth){
      const sel = $("submittedBy");
      const help = $("submittedByHelp");
      sel.disabled = true;
      if (help) help.textContent = "Loading…";

      const cu = auth.currentUser || {};
      const curUid   = cu.uid || "";
      const curEmail = (cu.email || "").toLowerCase();
      const curName  = (cu.displayName || "Dane Killam").trim();

      let list = [];

      try {
        // Safe read first: unordered /employees (no index surprises)
        try{
          const snap = await getDocs(collection(db, "employees"));
          snap.forEach(d=>{
            const v = d.data()||{};
            const name  = (v.fullName || v.displayName || v.name || "").toString().trim();
            const email = (v.email || d.id || "").toString().toLowerCase();
            if (name) list.push({ id:d.id, email, name });
          });
        }catch(e){ console.warn("employees unordered failed:", e); }

        // If empty, try orderBy fullName
        if(!list.length){
          try{
            const snap2 = await getDocs(query(collection(db,"employees"), orderBy("fullName")));
            snap2.forEach(d=>{
              const v = d.data()||{};
              const name  = (v.fullName || v.displayName || v.name || "").toString().trim();
              const email = (v.email || d.id || "").toString().toLowerCase();
              if (name) list.push({ id:d.id, email, name });
            });
          }catch(e){ console.warn("employees orderBy(fullName) failed:", e); }
        }

        // Fallback: /accountRoles
        if(!list.length){
          try{
            const snap3 = await getDocs(collection(db, "accountRoles"));
            snap3.forEach(d=>{
              const v = d.data()||{};
              const name  = (v.fullName || v.displayName || v.name || "").toString().trim();
              const email = (v.email || d.id || "").toString().toLowerCase();
              if (name) list.push({ id:d.id, email, name });
            });
          }catch(e){ console.warn("accountRoles read failed:", e); }
        }
      } finally {
        // Ensure current user is present
        const found = list.find(e =>
          e.id.toLowerCase() === curEmail ||
          e.email === curEmail ||
          e.name === curName
        );
        if (!found && (curEmail || curUid || curName)) {
          list.unshift({ id: curEmail || curUid || "unknown", email: curEmail, name: curName });
        }

        // Sort + render
        list.sort((a,b)=>a.name.localeCompare(b.name));
        sel.innerHTML = list.map(e =>
          `<option value="${esc(e.id)}">${esc(e.name)}</option>`
        ).join("") || `<option value="${esc(curEmail || curUid || "unknown")}">${esc(curName)}</option>`;

        // ✅ Default to the logged-in user (email match → name match → first)
        const match = list.find(e =>
          e.id.toLowerCase() === curEmail ||
          e.email === curEmail ||
          e.name === curName
        );
        if (match) {
          sel.value = match.id;
        } else if (sel.options.length) {
          sel.selectedIndex = 0;
        }

        sel.disabled = false;
        if (help) help.textContent = `${sel.options.length} option${sel.options.length===1?"":"s"}`;
      }
    }

    function updateCapacityHelp(){
      const capEl=$("capHelp"), buEl=$("bushels"), save=$("btnSave");
      const siteSel = $("site");
      const cropSel = $("cropType");

      if(!CURRENT_SITE || CURRENT_BIN_INDEX<0){
        capEl.textContent="Capacity: — • On hand: — • After add: —";
        buEl.classList.remove('invalid');
        save.disabled=true;
        return;
      }

      const bin=CURRENT_SITE.bins[CURRENT_BIN_INDEX]||{};
      const cornCap = +bin.bushels || 0;
      const on = +bin.onHand || 0;
      const add = parseFloat(buEl.value||"0");
      const cropId = getSelectedCropId();

      const effCap = getEffectiveCapacityForCrop(cornCap, cropId);
      const after = on + (isNaN(add)?0:add);
      const over=(effCap>0 && after>effCap);

      capEl.textContent=`Capacity: ${effCap.toLocaleString()} • On hand: ${on.toLocaleString()} • After add: ${after.toLocaleString()}`;
      buEl.classList.toggle('invalid',over);

      const hasAdd = add > 0;
      const hasSite = !!(siteSel && siteSel.value);
      const hasBin = CURRENT_BIN_INDEX>=0;
      const hasCrop = !!(cropSel && cropSel.value);

      save.disabled = over || !hasAdd || !hasSite || !hasBin || !hasCrop;
    }

    async function loadSites(db){
      const snap=await getDocs(query(collection(db,'binSites'), orderBy('name')));
      const filtered=[];
      snap.forEach(d=>{
        const v=d.data()||{}, bins=Array.isArray(v.bins)?v.bins:[];
        // keep same site filter as before: any bin with any remaining capacity (corn-based)
        const hasRoom = bins.some(b=>{
          const cap=+b?.bushels||0, on=+b?.onHand||0;
          return cap>0 ? on<cap : true;
        });
        if(hasRoom) filtered.push({ id:d.id, name:String(v.name||'Unnamed'), bins });
      });
      filtered.sort((a,b)=>a.name.localeCompare(b.name));
      SITES=filtered;
      $("site").innerHTML='<option value="">— Select —</option>'+SITES.map(s=>`<option value="${esc(s.id)}">${esc(s.name)}</option>`).join('');
      $("site").disabled=false;
      $("siteHelp").textContent=`${SITES.length} site${SITES.length===1?'':'s'} with capacity`;
    }

    function loadBinsFor(siteId){
      CURRENT_SITE=SITES.find(s=>s.id===siteId)||null;
      const sel=$("bin"), help=$("binHelp");
      CURRENT_BIN_INDEX=-1;

      const cropRaw = getSelectedCropRaw();

      if(!CURRENT_SITE){
        sel.innerHTML='<option value="">Select a site & crop first…</option>';
        sel.disabled=true;
        help.textContent='—';
        updateCapacityHelp();
        return;
      }

      if(!cropRaw){
        sel.innerHTML='<option value="">Choose crop type to see bins…</option>';
        sel.disabled=true;
        help.textContent='Select a crop to filter bins';
        updateCapacityHelp();
        return;
      }

      const cropId = getSelectedCropId();
      const items=(CURRENT_SITE.bins||[])
        .map((b,i)=>({b,i}))
        .filter(({b})=> hasRoomForCrop(b, cropId));

      if(!items.length){
        sel.innerHTML='<option value="">No bins for this crop with remaining capacity</option>';
        sel.disabled=true;
        help.textContent='0 bins';
        updateCapacityHelp();
        return;
      }

      sel.innerHTML = '<option value="">— Select —</option>' + items.map(({b,i})=>{
        const cornCap=+b.bushels||0;
        const on=+b.onHand||0;
        const effCap = getEffectiveCapacityForCrop(cornCap, cropId);
        const num=b.num ?? (i+1);
        const room=effCap?effCap-on:null;
        return `<option value="${i}">Bin #${num} — On hand: ${on.toLocaleString()} / Cap: ${effCap.toLocaleString()}${room!==null?` (Room: ${room.toLocaleString()})`:''}</option>`;
      }).join('');
      sel.disabled=false;
      help.textContent=`${items.length} bin${items.length===1?'':'s'} available for ${cropRaw}`;

      if(items.length===1){
        sel.value=String(items[0].i);
        CURRENT_BIN_INDEX=items[0].i;
      }
      updateCapacityHelp();
    }

    async function saveAdd(db, auth){
      $("err").hidden=true;

      const siteId=$("site").value;
      const binIdx=parseInt($("bin").value,10);
      const bushels=parseFloat($("bushels").value);
      const cropTypeVal = $("cropType").value;
      const dateVal = $("date").value;

      if(!siteId || !(binIdx>=0) || !(bushels>0) || !cropTypeVal){
        alert("Complete site, crop type, bin and bushels.");
        return;
      }

      try{
        const siteRef=doc(db,'binSites',siteId);
        const snap=await getDoc(siteRef);
        if(!snap.exists()) throw new Error("Site not found.");
        const data=snap.data()||{};
        const bins=Array.isArray(data.bins)?[...data.bins]:[];

        const latestBin = bins[binIdx] || {};
        const cornCap = +latestBin.bushels || 0;
        const on = +latestBin.onHand || 0;
        const cropId = getSelectedCropId();

        // Enforce crop match rule at save time
        if (on > 0) {
          const lastCrop = latestBin.lastCropType || latestBin.cropType || null;
          if (!lastCrop) {
            $("err").hidden=false;
            $("err").textContent="Selected bin has grain on hand with unknown crop type. Edit bin setup before adding more.";
            toast("Bin crop unknown",2200);
            return;
          }
          if (!cropsMatch(lastCrop, cropId)) {
            $("err").hidden=false;
            $("err").textContent="Selected bin currently holds a different crop. Choose another bin.";
            toast("Wrong crop for bin",2200);
            return;
          }
        }

        // Capacity check using effective capacity for selected crop
        const effCap = getEffectiveCapacityForCrop(cornCap, cropId);
        const after = on + bushels;
        if(effCap>0 && after>effCap){
          $("bushels").classList.add('invalid');
          $("err").hidden=false;
          $("err").textContent="Bushels exceed bin capacity for this crop.";
          toast("Over capacity",2200);
          return;
        }

        const { uid:submittedByUid, name:submittedByName } = getSelectedEmployee();

        bins[binIdx] = {
          ...(bins[binIdx]||{}),
          onHand: after,
          lastCropType: cropTypeVal || null,
          lastCropMoisture: $("cropMoisture").value ? parseFloat($("cropMoisture").value) : null,
          lastUpdatedBy: submittedByName || (auth.currentUser?.displayName || 'Dane Killam'),
          lastUpdatedUid: submittedByUid || (auth.currentUser?.uid || null),
          lastUpdatedMs: Date.now()
        };

        await setDoc(siteRef, { bins }, { merge:true });

        await addDoc(collection(db,'binMovements'), {
          siteId, siteName: CURRENT_SITE?.name || null,
          binIndex: binIdx, binNum: bins[binIdx]?.num ?? (binIdx+1),
          direction: 'in',
          bushels,
          cropType: cropTypeVal || null,
          cropMoisture: $("cropMoisture").value ? parseFloat($("cropMoisture").value) : null,
          note: ($("note").value||"").trim() || null,
          submittedBy: submittedByName || (auth.currentUser?.displayName || 'Dane Killam'),
          submittedByUid: submittedByUid || (auth.currentUser?.uid || null),
          dateISO: dateVal || null,
          createdAt: serverTimestamp()
        });

        toast("Added to inventory");
        setTimeout(()=>location.reload(),700);

      }catch(err){
        console.error(err);
        $("err").hidden=false; $("err").textContent=err.message||"Save failed.";
        toast("Save failed",2200);
      }
    }

    (async()=>{
      await ready;
      const db=getFirestore(); const auth=getAuth();

      $("date").value = todayISO();

      await Promise.all([
        loadSites(db),
        loadEmployees(db, auth)
      ]);

      $("site").addEventListener("change", e=> {
        loadBinsFor(e.target.value);
      });

      $("cropType").addEventListener("change", () => {
        // When crop changes, reload bins for selected site and update capacity for current bin
        const siteId = $("site").value;
        loadBinsFor(siteId);
      });

      $("bin").addEventListener("change", e=> {
        CURRENT_BIN_INDEX=parseInt(e.target.value,10);
        updateCapacityHelp();
      });

      $("bushels").addEventListener("input", updateCapacityHelp);
      $("cropMoisture").addEventListener("input", updateCapacityHelp);

      $("btnSave").addEventListener("click", ()=> saveAdd(db, auth));
    })();
  </script>
</body>
</html>
