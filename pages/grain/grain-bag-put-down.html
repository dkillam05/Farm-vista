<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista ‚Ä¢ Grain Bag ‚Äî Put Down</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- Absolute paths (required) -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>

  <!-- Theme + app CSS -->
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <!-- Ensure fv-shell -->
  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true;
        document.head.appendChild(s);
      }
    })();
  </script>

  <style>
    :root{
      --card-max:1100px; --page-bottom-gap:96px; --accent:#2F6C3C;
      /* Standardized combo vars */
      --combo-gap:4px;                 /* tight space from trigger to panel */
      --combo-radius:12px;             /* panel rounding */
      --combo-btn-radius:10px;         /* trigger + search rounding */
      --combo-shadow:0 12px 26px rgba(0,0,0,.18);
      --combo-item-pad:10px 8px;
      --combo-max-h:50vh;
    }

    body{ background:var(--app-bg,var(--surface)); }

    .wrap{ max-width:var(--card-max); margin:0 auto; padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + var(--page-bottom-gap))!important; }

    .hero{ border:1px solid var(--border); border-radius:14px; background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08)); overflow:visible; margin-bottom:var(--page-bottom-gap); }
    .hero-head{ display:grid; grid-template-columns:36px 1fr; gap:12px; align-items:center;
      padding:14px 16px; border-bottom:1px solid var(--border);
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent); }
    .hero-head .icon{ width:24px; height:24px; color:var(--accent); display:grid; place-items:center }
    .hero-head h1{ margin:0; font-size:clamp(20px,3.2vw,26px); line-height:1.2 }
    .muted{ color:var(--muted,#67706B) }
    .body{ padding:16px; display:grid; gap:14px }
    .row{ display:grid; gap:10px; grid-template-columns:1fr 1fr }
    @media (max-width:880px){ .row{ grid-template-columns:1fr } }

    .field{ position:relative }
    .field label{ display:block; font-weight:800; margin:0 0 6px }

    .input,.textarea,.buttonish{
      width:100%; font:inherit; font-size:16px; color:var(--text);
      background:var(--card-surface,var(--surface)); border:1px solid var(--border);
      border-radius:var(--combo-btn-radius); padding:12px; outline:none;
    }
    .buttonish{ cursor:pointer; text-align:left; position:relative; padding-right:42px }
    .buttonish.has-caret::after{
      content:""; position:absolute; right:14px; top:50%; width:0; height:0;
      border-left:6px solid transparent; border-right:6px solid transparent;
      border-top:7px solid var(--muted,#67706B); transform:translateY(-50%); pointer-events:none;
    }
    .textarea{ min-height:110px; resize:vertical }
    .help{ font-size:13px; color:var(--muted,#67706B); margin-top:6px }
    .error{ color:#b00020; font-weight:700 }
    .invalid{ border-color:#b00020 !important; color:#b00020 !important; }

    .actions{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-top:6px }
    .btn{ display:inline-flex; align-items:center; justify-content:center; min-width:160px;
      padding:12px 16px; border-radius:12px; border:1px solid var(--border);
      background:var(--card-surface,var(--surface)); font-weight:800; color:var(--text)!important; cursor:pointer; }
    .btn-primary{ border-color:transparent; background:#2F6C3C; color:#fff!important }

    /* Standardized Inline Combo Dropdown (tight + rounded) */
    .combo{ position:relative }
    .combo .combo-anchor{ position:relative; display:inline-block; width:100%; }
    .combo-panel{
      position:absolute; left:0; right:0; top:calc(100% + var(--combo-gap));
      background:var(--surface); border:1px solid var(--border); border-radius:var(--combo-radius);
      box-shadow:var(--combo-shadow); z-index:9999; padding:8px; display:none;
    }
    .combo-panel.show{ display:block }
    .combo-panel .search{ padding:4px 2px 8px }
    .combo-panel .search input{
      width:100%; padding:10px; border:1px solid var(--border); border-radius:var(--combo-btn-radius)
    }
    .combo-panel .list{ max-height:var(--combo-max-h); overflow:auto; border-top:1px solid var(--border) }
    .combo-item{ padding:var(--combo-item-pad); border-bottom:1px solid var(--border); cursor:pointer }
    .combo-item:hover{ background:rgba(0,0,0,.04) }
    .combo-item:last-child{ border-bottom:none }
    .combo-empty{ padding:var(--combo-item-pad); color:#67706B }

    .grid-3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px }
    @media (max-width:880px){ .grid-3{ grid-template-columns:1fr } }

    .partial-row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; align-items:end }
    @media (max-width:880px){ .partial-row{ grid-template-columns:1fr } }
    .partial-help{ margin-top:4px }

    .toast{ position:fixed; left:50%; bottom:calc(env(safe-area-inset-bottom,0px) + 72px); transform:translateX(-50%);
      background:#2F6C3C; color:#fff; padding:10px 14px; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,.25);
      z-index:99999; display:none }
    .toast.show{ display:block; animation:fadeout 5s forwards }
    @keyframes fadeout{0%{opacity:1}85%{opacity:1}100%{opacity:0}}

    /* Priority slider styles (match maintenance-add) */
    .priority-readout{
      font-size:0.9rem;
      color:var(--muted,#67706B);
      margin-top:4px;
    }
    .priority-reason textarea{
      min-height:80px;
      resize:vertical;
    }
  </style>
</head>

<body>
  <fv-shell>
    <div class="wrap">
      <section class="hero">
        <header class="hero-head">
          <div class="icon" aria-hidden="true">üõ¢Ô∏è</div>
          <div>
            <h1>Put Bag Down</h1>
            <p class="muted">Record bags placed in the field. Defaults bag if only one SKU exists.</p>
          </div>
        </header>

        <div class="body">
          <!-- FIELD + CROP YEAR + ADD BAG -->
          <div class="row">
            <!-- Field (searchable) -->
            <div class="field combo" id="fieldCombo">
              <label for="fieldBtn">Field</label>
              <div class="combo-anchor">
                <button id="fieldBtn" class="buttonish has-caret" type="button">‚Äî Select field ‚Äî</button>
                <div class="combo-panel" id="fieldPanel" role="listbox" aria-label="Field list">
                  <div class="search"><input id="fieldSearch" type="search" placeholder="Search fields‚Ä¶"/></div>
                  <div class="list" id="fieldList"></div>
                </div>
              </div>
            </div>

            <!-- Crop Year (non-search) -->
            <div class="field combo" id="yearCombo">
              <label for="yearBtn">Crop Year</label>
              <div class="combo-anchor">
                <button id="yearBtn" class="buttonish has-caret" type="button">‚Äî Select ‚Äî</button>
                <div class="combo-panel" id="yearPanel" role="listbox" aria-label="Year list">
                  <div class="list" id="yearList"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Add Bag Entry + Cancel (Cancel is to the right) -->
          <div class="actions">
            <button id="addBag" class="btn btn-primary" type="button">Add Bag Entry</button>
            <button id="btnCancelTop" class="btn" type="button">Cancel</button>
          </div>

          <!-- Bag form (shown after Add Bag Entry). ORDER per request -->
          <div id="bagForm" hidden>

            <!-- 1) Date  |  2) Submitted By -->
            <div class="row">
              <div class="field">
                <label for="datePlaced">Date Bag Was Put Down</label>
                <input id="datePlaced" class="input" type="date"/>
              </div>

              <div class="field combo" id="subCombo">
                <label for="subBtn">Submitted By</label>
                <div class="combo-anchor">
                  <button id="subBtn" class="buttonish has-caret" type="button">‚Äî Select ‚Äî</button>
                  <div class="combo-panel" id="subPanel" role="listbox" aria-label="Employee list">
                    <div class="list" id="subList"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 3) Crop Type | 4) Crop Moisture -->
            <div class="row">
              <div class="field combo" id="cropCombo">
                <label for="cropBtn">Crop Type</label>
                <div class="combo-anchor">
                  <button id="cropBtn" class="buttonish has-caret" type="button">‚Äî Select ‚Äî</button>
                  <div class="combo-panel" id="cropPanel" role="listbox" aria-label="Crop list">
                    <div class="list" id="cropList"></div>
                  </div>
                </div>
              </div>

              <div class="field">
                <label for="cropMoisture">Crop Moisture (%)</label>
                <input id="cropMoisture" class="input" type="number" inputmode="decimal" min="0" max="40" step="0.1" placeholder="e.g., 18.5"/>
              </div>
            </div>

            <!-- 5) Pickup Priority | 6) Bag Brand & Size -->
            <div class="row">
              <!-- Priority slider (replaces dropdown) -->
              <div class="field">
                <label for="priority">Pickup Priority (1‚Äì10)</label>
                <input id="priority" class="input" type="range" min="1" max="10" step="1" value="5">
                <div class="priority-readout">
                  Priority: <strong><span id="priorityValue">5</span>/10</strong> ¬∑ 1 = low urgency ¬∑ 10 = high urgency
                </div>
                <div id="priorityReasonBlock" class="priority-reason" hidden>
                  <label for="priorityReason">Why is this a high-priority (7‚Äì10) pickup?</label>
                  <textarea id="priorityReason" class="textarea" placeholder="Explain why this needs urgent attention‚Ä¶"></textarea>
                </div>
              </div>

              <div class="field combo" id="bagComboField">
                <label for="bagBtn">Bag Brand & Size</label>
                <div class="combo-anchor">
                  <button id="bagBtn" class="buttonish has-caret" type="button">‚Äî Select ‚Äî</button>
                  <div class="combo-panel" id="bagPanel" role="listbox" aria-label="Bag list">
                    <div class="search"><input id="bagSearch" type="search" placeholder="Search bags‚Ä¶"/></div>
                    <div class="list" id="bagList"></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- counts -->
            <div class="grid-3">
              <div class="field">
                <label for="fullBags">Number of Full Bags</label>
                <input id="fullBags" class="input" type="number" inputmode="numeric" min="0" step="1" value="0"/>
              </div>
              <div class="field">
                <label for="partialBags">Number of Partial Bags</label>
                <input id="partialBags" class="input" type="number" inputmode="numeric" min="0" step="1" value="0"/>
                <div class="help">Each partial must be at least 50 ft. Max shows after choosing a bag.</div>
              </div>
              <div class="field"><!-- spacer --></div>
            </div>

            <!-- Per-partial rows (length + usage with the same combo style) -->
            <div id="partialsBlock" hidden>
              <div id="partialsList" class="body" style="padding:0; gap:12px"></div>
              <div id="partialsRangeHelp" class="help"></div>
            </div>

            <div class="field">
              <label for="notes">Notes</label>
              <textarea id="notes" class="textarea" placeholder="Optional details"></textarea>
            </div>

            <div class="field">
              <label for="files">Optional Photos</label>
              <input id="files" class="input" type="file" accept="image/*,.jpg,.jpeg,.png,.heic,.pdf" multiple>
            </div>

            <div id="err" class="help error" hidden></div>

            <div class="actions">
              <button id="btnClear" class="btn" type="button">Clear</button>
              <button id="btnSave" class="btn btn-primary" type="button">Save</button>
            </div>
          </div>
        </div>
      </section>
    </div>
  </fv-shell>

  <div id="toast" class="toast" role="status" aria-live="polite">Bag Entry Saved.</div>

  <!-- Firebase (modular) -->
  <script type="module">
    import {
      ready,
      getFirestore, getAuth,
      collection, getDocs, addDoc, doc, updateDoc,
      serverTimestamp, query, orderBy
    } from '/Farm-vista/js/firebase-init.js';

    /* ---------- utils ---------- */
    const $ = id => document.getElementById(id);
    const esc = s => String(s ?? "").replace(/[&<>"']/g, m => (
      {"&":"&amp;","<":"&lt;","&gt;":"&gt;","\"":"&quot;","'":"&#39;"}[m]
    ));
    const toast = (msg="Bag Entry Saved.", ms=4200)=>{
      const t=$("toast");
      t.textContent=msg;
      t.classList.remove("show");
      void t.offsetWidth;
      t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"),ms);
    };
    const todayISO = ()=>{
      const d=new Date();
      const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0');
      return `${y}-${m}-${da}`;
    };

    /* ---------- state ---------- */
    let FIELD_INDEX=[], EMPLOYEES=[], BAG_SKUS=[];
    let chosen = { field:null, year:null, sub:null, crop:null, prio:5, bag:null };
    let debounceTimer=null;

    /* ---------- global combo manager (one open at a time) ---------- */
    function closeAllCombos(exceptPanel=null){
      document.querySelectorAll('.combo-panel.show').forEach(p=>{
        if(p!==exceptPanel) p.classList.remove('show');
      });
    }
    document.addEventListener('click', ()=> closeAllCombos());
    document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeAllCombos(); });

    /* ---------- generic combo helper ---------- */
    function makeCombo({btn, panel, list, items=[], searchable=false, formatter=x=>String(x.label||x), onPick}){
      panel.addEventListener('click', e=> e.stopPropagation());
      panel.addEventListener('mousedown', e=> e.stopPropagation());

      function render(q=""){
        const qq=(q||"").toLowerCase();
        list.innerHTML = (items||[])
          .filter(x=>!qq || formatter(x).toLowerCase().includes(qq))
          .map(x=>`<div class="combo-item" data-id="${esc(String(x.id))}">${esc(formatter(x))}</div>`)
          .join('') || `<div class="combo-empty">(no matches)</div>`;
      }
      function open(){
        closeAllCombos(panel);
        panel.classList.add('show');
        render("");
        if(searchable){
          const i=panel.querySelector('input');
          if(i){ i.value=""; i.focus(); }
        }
      }
      function close(){ panel.classList.remove('show'); }

      btn.addEventListener('click', e=>{
        e.stopPropagation();
        panel.classList.contains('show') ? close() : open();
      });

      list.addEventListener('mousedown', e=>{
        const el=e.target.closest('.combo-item'); if(!el) return;
        const it=(items||[]).find(i=>String(i.id)===String(el.dataset.id)); if(!it) return;
        onPick?.(it);
        close();
      });

      if(searchable){
        const s=panel.querySelector('input');
        if(s){ s.addEventListener('input', e=>render(e.target.value)); }
      }

      return { setItems(arr){ items=arr||[]; render(""); }, close, open };
    }

    /* ---------- partial rows ---------- */
    function updatePartialRangeHelp(){
      const L = Number(chosen.bag?.sizeFeet||0);
      const min=50, max=Math.max(0,L-50);
      $("partialsRangeHelp").textContent = L ? `Allowed range: ${min}‚Äì${max} ft per partial (bag ${L} ft).` : "";
      return {min, max};
    }
    function buildPartialRow(idx){
      const row=document.createElement('div'); row.className='partial-row';

      // length col
      const lenWrap=document.createElement('div'); lenWrap.className='field';
      const lenLbl=document.createElement('label'); lenLbl.textContent=`Partial ${idx+1} length (ft)`;
      const len=document.createElement('input'); len.type='number'; len.inputMode='numeric'; len.min='0'; len.step='1'; len.className='input';
      const lenHelp=document.createElement('div'); lenHelp.className='help partial-help';
      len.addEventListener('input', schedulePartialValidate);
      lenWrap.append(lenLbl,len,lenHelp);

      // usage col
      const useWrap=document.createElement('div'); useWrap.className='field combo';
      const useLbl=document.createElement('label'); useLbl.textContent=`Partial ${idx+1} usage`;

      const anchor=document.createElement('div'); anchor.className='combo-anchor';
      const useBtn=document.createElement('button'); useBtn.type='button'; useBtn.className='buttonish has-caret'; useBtn.textContent='‚Äî Select ‚Äî';
      const usePanel=document.createElement('div'); usePanel.className='combo-panel'; usePanel.setAttribute('role','listbox'); usePanel.setAttribute('aria-label','Partial usage list');
      const useList=document.createElement('div'); useList.className='list';
      usePanel.appendChild(useList);
      anchor.append(useBtn,usePanel);

      useWrap.append(useLbl,anchor);

      const USAGE_ITEMS=[
        {id:'carryover', label:'Carryover from previous usage', value:'carryover'},
        {id:'new',       label:'Start of a new bag',            value:'new'}
      ];
      makeCombo({
        btn: useBtn, panel: usePanel, list: useList, items:USAGE_ITEMS,
        searchable:false, formatter:x=>x.label,
        onPick: it => { useBtn.textContent = it.label; useBtn.dataset.value = it.value; }
      });

      row.append(lenWrap,useWrap);
      return row;
    }
    function renderPartialInputs(){
      const n=Math.max(0, Number($("partialBags").value||0));
      const wrap=$("partialsBlock"); const list=$("partialsList");
      list.innerHTML=""; wrap.hidden = n<=0;
      if(n<=0) return;
      for(let i=0;i<n;i++){ list.appendChild(buildPartialRow(i)); }
      updatePartialRangeHelp(); schedulePartialValidate();
    }
    function schedulePartialValidate(){ clearTimeout(debounceTimer); debounceTimer = setTimeout(validatePartials, 1000); }
    function validatePartials(){
      const L = Number(chosen.bag?.sizeFeet||0);
      const min=50, max=Math.max(0,L-50);
      let ok=true;
      const rows=[...$("partialsList").querySelectorAll('.partial-row')];
      for(const r of rows){
        const inp=r.querySelector('input'); const help=r.querySelector('.partial-help');
        const v=Number(inp.value||0);
        const bad = !(v>=min && v<=max);
        const showInvalid = bad && inp.value!=="";
        inp.classList.toggle('invalid', showInvalid);
        help.textContent = (inp.value==="") ? "" : (showInvalid ? `Enter ${min}‚Äì${max} ft.` : "");
        if(showInvalid) ok=false;
      }
      return ok;
    }

    /* ---------- priority slider ---------- */
    function setupPriority(){
      const slider = $("priority");
      const valSpan = $("priorityValue");
      const block = $("priorityReasonBlock");
      const reason = $("priorityReason");
      if(!slider || !valSpan || !block || !reason) return;

      const sync = ()=>{
        const v = Number(slider.value || 5);
        valSpan.textContent = v;
        if(v>=7){
          block.hidden = false;
        }else{
          block.hidden = true;
          reason.value = "";
        }
        chosen.prio = v;
      };
      slider.addEventListener("input", sync);
      sync();
    }

    /* ---------- formatting ---------- */
    function bagLabel(b){
      const invDisplay =
        (b.onHand != null)
          ? `on hand: ${b.onHand}`
          : (b.initialQty != null ? `purchased: ${b.initialQty}` : null);

      const parts=[
        `${b.brand} ‚Äî ${b.sizeFeet} ft`,
        b.diameterFt?`√ò${b.diameterFt}'`:null,
        b.location||null,
        invDisplay
      ].filter(Boolean);
      return parts.join(' ‚Ä¢ ');
    }

    /* ---------- save ---------- */
    async function handleSave(db,auth){
      $("err").hidden=true;
      if(!chosen.field){ alert("Please choose a Field."); return; }
      if(!chosen.year){ alert("Please choose Crop Year."); return; }
      if(!chosen.bag){ alert("Please choose Bag Brand & Size."); return; }
      if(!chosen.crop){ alert("Please choose Crop Type."); return; }
      const datePlaced=$("datePlaced").value; if(!datePlaced){ alert("Please set the Date placed."); return; }

      // Priority validation + high-priority reason
      const sliderEl = $("priority");
      const priority = Number(sliderEl?.value || chosen.prio || 5);
      if(!priority || priority<1 || priority>10){
        alert("Pickup priority must be between 1 and 10.");
        return;
      }
      let priorityReason = null;
      if(priority>=7){
        priorityReason = ($("priorityReason").value || "").trim();
        if(!priorityReason){
          alert("Please explain why this is a high-priority (7‚Äì10) pickup.");
          return;
        }
      }
      chosen.prio = priority;

      const partialCount=Math.max(0,Number($("partialBags").value||0));
      if(partialCount>0 && !validatePartials()){
        $("err").hidden=false;
        $("err").textContent="One or more partial lengths are outside the allowed range.";
        return;
      }

      const rows=[...$("partialsList").querySelectorAll('.partial-row')];
      const partialFeet=[], partialUsage=[];
      for(const r of rows){
        const len=Number(r.querySelector('input').value||0);
        const useVal=r.querySelector('.buttonish').dataset.value || 'carryover';
        if(len>0){ partialFeet.push(len); partialUsage.push(useVal); }
      }
      if(partialCount>0 && partialFeet.length!==partialCount){
        alert("Please complete each partial row.");
        return;
      }

      const fullBags=Math.max(0,Number($("fullBags").value||0));

      const sub = chosen.sub;
      const subEmail=sub?.email||getAuth().currentUser?.email||"";
      const subName =sub?.name ||getAuth().currentUser?.displayName|| subEmail ||"Unknown";

      const record={
        type:'putDown',
        field:{id:chosen.field.id,name:chosen.field.name},
        cropYear:chosen.year,
        cropType:chosen.crop,
        cropMoisture: ($("cropMoisture").value===""? null : Number($("cropMoisture").value)),
        datePlaced,
        bagSku:{
          id:chosen.bag.id,
          brand:chosen.bag.brand,
          sizeFeet:Number(chosen.bag.sizeFeet||0),
          diameterFt:chosen.bag.diameterFt||null,
          location:chosen.bag.location||null
        },
        counts:{ full:fullBags, partial:partialCount, partialFeet, partialUsage },
        priority,
        priorityReason,
        notes:$("notes").value.trim(),
        submittedBy:{ employeeId:sub?.id||null, name:subName, email:subEmail },
        createdAt:serverTimestamp(), updatedAt:serverTimestamp()
      };

      const ref=await addDoc(collection(db,'grain_bag_events'), record);

      // Optional photos
      const files=Array.from(($("files").files||[]));
      if(files.length){
        try{
          const m=await import('/Farm-vista/js/firebase-init.js');
          const st=m.getStorage(); const stRef=m.ref; const upload=m.uploadBytes; const url=m.getDownloadURL;
          const uploaded=[];
          for(const f of files){
            const safe=(Date.now()+'-'+f.name).replace(/[^\w.\-]+/g,'_');
            const path=`grain_bag_events/${ref.id}/${safe}`;
            await upload(stRef(st,path), f, {contentType:f.type||'application/octet-stream'});
            uploaded.push({name:f.name, url:await url(stRef(st,path)), path});
          }
          await updateDoc(doc(db,'grain_bag_events',ref.id), { files:uploaded, updatedAt:serverTimestamp() });
        }catch(err){
          $("err").hidden=false;
          $("err").textContent=`Saved, but photo upload failed: ${err.message}`;
        }
      }

      // --------- Inventory decrement using qty/onHand ----------
      // full bags = 1 each; each partial marked "new" = 1 each.
      const newPartialsCount = partialUsage.filter(v => v === 'new').length;
      const debit = fullBags + newPartialsCount;

      if (chosen.bag && debit > 0) {
        // Seed onHand from qty if it doesn't exist yet.
        const currentOnHand =
          (chosen.bag.onHand != null)
            ? Number(chosen.bag.onHand)
            : (chosen.bag.initialQty != null ? Number(chosen.bag.initialQty) : null);

        if (currentOnHand != null) {
          if (debit > currentOnHand) {
            $("err").hidden = false;
            $("err").textContent = `You only have ${currentOnHand} bags on hand for this SKU but are trying to use ${debit}. Adjust counts or update inventory.`;
            return;
          }
          try {
            const next = Math.max(0, currentOnHand - debit);
            await updateDoc(doc(db, 'inventoryGrainBagMovements', chosen.bag.id), {
              onHand: next,
              updatedAt: serverTimestamp()
            });
            // keep local state in sync
            chosen.bag.onHand = next;
          } catch (err) {
            console.warn("Inventory decrement failed:", err);
          }
        }
      }

      // Success UX
      toast("Bag Entry Saved.");
      window.scrollTo({ top: 0, behavior: 'smooth' });
      closeAllCombos();
      $("bagForm").hidden = true;

      // Reset field for next entry; keep year
      chosen.field = null;
      $("fieldBtn").textContent = "‚Äî Select field ‚Äî";

      // Reset form internals
      chosen.bag=null; $("bagBtn").textContent="‚Äî Select ‚Äî";
      chosen.crop=null; $("cropBtn").textContent="‚Äî Select ‚Äî";
      $("cropMoisture").value="";
      $("datePlaced").value=todayISO();
      $("fullBags").value="0"; $("partialBags").value="0";
      $("partialsList").innerHTML=""; $("partialsBlock").hidden=true;
      $("notes").value=""; $("files").value="";
      $("partialsRangeHelp").textContent="";

      // Reset priority slider to default 5
      chosen.prio = 5;
      const pSlider = $("priority");
      const pVal = $("priorityValue");
      const pBlock = $("priorityReasonBlock");
      const pReason = $("priorityReason");
      if(pSlider) pSlider.value = "5";
      if(pVal) pVal.textContent = "5";
      if(pBlock) pBlock.hidden = true;
      if(pReason) pReason.value = "";

      setTimeout(()=>{
        const fb = document.getElementById('fieldBtn');
        if(fb) fb.focus();
      }, 350);
    }

    /* ---------- boot ---------- */
    (async()=>{
      await ready;
      const db=getFirestore(); const auth=getAuth();
      $("datePlaced").value = todayISO();

      /* Years / Crops */
      const y=new Date().getFullYear();
      const YEARS=[y-1,y,y+1].map(v=>({id:String(v), value:v, label:String(v)}));
      const CROPS=[
        {id:"Corn",value:"Corn",label:"Corn"},
        {id:"Soybeans",value:"Soybeans",label:"Soybeans"}
      ];

      setupPriority();

      const fieldCombo = makeCombo({
        btn: document.getElementById("fieldBtn"),
        panel: document.getElementById("fieldPanel"),
        list: document.getElementById("fieldList"),
        items:[], searchable:true, formatter:(x)=>x.name,
        onPick:(it)=>{
          chosen.field=it;
          document.getElementById("fieldBtn").textContent=it.name;
        }
      });

      const yearCombo = makeCombo({
        btn: document.getElementById("yearBtn"),
        panel: document.getElementById("yearPanel"),
        list: document.getElementById("yearList"),
        items:YEARS, searchable:false, formatter:x=>x.label,
        onPick:(it)=>{
          chosen.year=Number(it.value);
          document.getElementById("yearBtn").textContent=it.label;
        }
      });
      chosen.year = y;
      document.getElementById("yearBtn").textContent=String(y);

      const subCombo = makeCombo({
        btn: document.getElementById("subBtn"),
        panel: document.getElementById("subPanel"),
        list: document.getElementById("subList"),
        items:[], searchable:false, formatter:x=>x.name,
        onPick:(it)=>{
          chosen.sub=it;
          document.getElementById("subBtn").textContent=it.name;
        }
      });

      const cropCombo = makeCombo({
        btn: document.getElementById("cropBtn"),
        panel: document.getElementById("cropPanel"),
        list: document.getElementById("cropList"),
        items:CROPS, searchable:false, formatter:x=>x.label,
        onPick:(it)=>{
          chosen.crop=it.value;
          document.getElementById("cropBtn").textContent=it.label;
        }
      });

      const bagCombo = makeCombo({
        btn: document.getElementById("bagBtn"),
        panel: document.getElementById("bagPanel"),
        list: document.getElementById("bagList"),
        items:[], searchable:true, formatter:(x)=>bagLabel(x),
        onPick:(it)=>{
          chosen.bag=it;
          document.getElementById("bagBtn").textContent=bagLabel(it);
          updatePartialRangeHelp();
          schedulePartialValidate();
        }
      });

      /* Load Firestore data */
      async function loadFields(){
        try{
          const snap=await getDocs(query(collection(db,'fields'),orderBy('name')));
          const arr=[];
          snap.forEach(d=>{
            const x=d.data()||{};
            if(x.name) arr.push({id:d.id,name:String(x.name)});
          });
          arr.sort((a,b)=>a.name.localeCompare(b.name));
          FIELD_INDEX=arr;
          fieldCombo.setItems(arr);
        }catch(e){
          console.warn("Fields load error:", e);
          fieldCombo.setItems([]);
        }
      }
      async function loadEmployees(){
        try{
          const snap=await getDocs(collection(db,'employees'));
          const list=[];
          snap.forEach(d=>{
            const x=d.data()||{};
            list.push({
              id:d.id,
              name:x.name||x.displayName||x.fullName||x.email||d.id,
              email:x.email||d.id
            });
          });
          list.sort((a,b)=>(a.name||"").localeCompare(b.name||""));
          EMPLOYEES=list;
          subCombo.setItems(list);
          const me=(auth.currentUser?.email||"").toLowerCase();
          const mine=list.find(e=>(e.email||"").toLowerCase()===me) || list[0];
          if(mine){
            chosen.sub=mine;
            document.getElementById("subBtn").textContent=mine.name;
          }
        }catch(e){
          console.warn("Employees load error:", e);
          subCombo.setItems([]);
        }
      }
      async function loadBags(){
        try{
          const snap=await getDocs(collection(db,'inventoryGrainBagMovements'));
          const list=[];
          snap.forEach(d=>{
            const x=d.data()||{};
            const brand=String(x.brand||"Bag");
            const sizeFeet=Number(x.lengthFt||x.length||0);
            if(sizeFeet<=0) return;

            const qty = (x.qty !== undefined ? Number(x.qty) : null);
            const onHand = (x.onHand !== undefined ? Number(x.onHand) :
                            qty !== null ? qty : null);

            list.push({
              id:d.id,
              brand,
              sizeFeet,
              diameterFt:Number(x.diameterFt||x.diameter||0)||null,
              location:x.location||null,
              onHand,
              initialQty: qty
            });
          });
          list.sort((a,b)=>(`${a.brand} ${a.sizeFeet}`).localeCompare(
            `${b.brand} ${b.sizeFeet}`,
            undefined,
            {numeric:true}
          ));
          BAG_SKUS=list;
          bagCombo.setItems(list);

          // Default to the single bag if only one SKU exists
          if(list.length===1){
            chosen.bag=list[0];
            document.getElementById("bagBtn").textContent=bagLabel(list[0]);
            updatePartialRangeHelp();
          }
        }catch(e){
          console.warn("Bags load error:", e);
          bagCombo.setItems([]);
        }
      }

      await Promise.all([loadFields(), loadEmployees(), loadBags()]);

      // Gate to reveal bag form
      document.getElementById("addBag").addEventListener("click", ()=>{
        if(!chosen.field) return alert("Choose a Field first.");
        if(!chosen.year)  return alert("Choose Crop Year.");
        document.getElementById("bagForm").hidden=false;
        toast("Bag form ready.", 2200);
      });

      // Cancel (top)
      const cancelTop = document.getElementById("btnCancelTop");
      if(cancelTop){
        cancelTop.addEventListener("click", ()=> window.history.back());
      }

      // Partials
      document.getElementById("partialBags").addEventListener("input", renderPartialInputs);

      // Actions
      document.getElementById("btnSave").addEventListener("click", ()=> handleSave(getFirestore(), getAuth()));
      document.getElementById("btnClear").addEventListener("click", ()=>{
        // Clear only form internals; keep Year; keep Field selection
        chosen.bag=null; document.getElementById("bagBtn").textContent="‚Äî Select ‚Äî";
        chosen.crop=null; document.getElementById("cropBtn").textContent="‚Äî Select ‚Äî";
        document.getElementById("cropMoisture").value="";
        document.getElementById("datePlaced").value=todayISO();
        document.getElementById("fullBags").value="0"; document.getElementById("partialBags").value="0";
        document.getElementById("partialsList").innerHTML=""; document.getElementById("partialsBlock").hidden=true;
        document.getElementById("notes").value=""; document.getElementById("files").value="";
        document.getElementById("partialsRangeHelp").textContent="";

        // Reset priority slider + reason
        chosen.prio = 5;
        const pSlider = $("priority");
        const pVal = $("priorityValue");
        const pBlock = $("priorityReasonBlock");
        const pReason = $("priorityReason");
        if(pSlider) pSlider.value = "5";
        if(pVal) pVal.textContent = "5";
        if(pBlock) pBlock.hidden = true;
        if(pReason) pReason.value = "";

        const me=(getAuth().currentUser?.email||"").toLowerCase();
        const mine=EMPLOYEES.find(e=>(e.email||"").toLowerCase()===me) || EMPLOYEES[0];
        if(mine){
          chosen.sub=mine;
          document.getElementById("subBtn").textContent=mine.name;
        }
      });
    })();
  </script>
</body>
</html>
