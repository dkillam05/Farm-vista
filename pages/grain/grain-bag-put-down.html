<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista ‚Ä¢ Put Bag Down</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- Absolute paths (required) -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>

  <!-- Theme + app styles -->
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <!-- Ensure fv-shell is present (global header/footer/menu) -->
  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true;
        document.head.appendChild(s);
      }
    })();
  </script>

  <style>
    :root{
      --card-max:1100px;
      --page-bottom-gap:96px;
      --accent:#2F6C3C;
    }
    body{ background:var(--app-bg,var(--surface)); }

    .wrap{
      max-width:var(--card-max);
      margin:0 auto;
      padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + var(--page-bottom-gap))!important;
    }

    .hero{
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));
      overflow:hidden;
      margin-bottom:var(--page-bottom-gap);
    }
    .hero-head{
      display:grid;grid-template-columns:36px 1fr;gap:12px;align-items:center;
      padding:14px 16px;border-bottom:1px solid var(--border);
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);
    }
    .hero-head .icon{width:24px;height:24px;color:var(--accent);display:grid;place-items:center}
    .hero-head h1{margin:0;font-size:clamp(20px,3.2vw,26px);line-height:1.2}
    .muted{color:var(--muted,#67706B)}
    .body{padding:16px;display:grid;gap:14px}
    .row{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    @media (max-width:880px){.row{grid-template-columns:1fr}}

    .field label{display:block;font-weight:800;margin:0 0 6px}
    .input,.select,.textarea,.buttonish{
      width:100%;font:inherit;font-size:16px;color:var(--text);
      background:var(--card-surface,var(--surface));border:1px solid var(--border);
      border-radius:10px;padding:12px;outline:none
    }
    .buttonish{cursor:pointer;text-align:left}
    .textarea{min-height:110px;resize:vertical}
    .help{font-size:13px;color:var(--muted,#67706B);margin-top:6px}
    .error{color:#b00020;font-weight:700}
    .actions{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:6px}
    .btn{display:inline-flex;align-items:center;justify-content:center;min-width:160px;
      padding:12px 16px;border-radius:12px;border:1px solid var(--border);
      background:var(--card-surface,var(--surface));font-weight:800;color:var(--text)!important;cursor:pointer}
    .btn-primary{border-color:transparent;background:#2F6C3C;color:#fff!important}

    /* Picker sheet */
    .sheet{position:fixed;inset:auto 0 0 0;background:var(--surface);border-top:1px solid var(--border);
      box-shadow:0 -12px 30px rgba(0,0,0,.18);border-radius:16px 16px 0 0;transform:translateY(105%);transition:transform .25s ease;z-index:10000}
    .sheet.show{transform:translateY(0)}
    .sheet .cap{display:flex;align-items:center;gap:10px;padding:12px 14px;border-bottom:1px solid var(--border)}
    .sheet .cap .bar{width:40px;height:4px;border-radius:4px;background:#CBCDCB;margin:0 auto}
    .sheet .cap h3{margin:0;font-size:16px}
    .sheet .search{padding:10px 14px;border-bottom:1px solid var(--border)}
    .sheet .search input{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px}
    .sheet .list{max-height:50vh;overflow:auto}
    .sheet .item{padding:12px 14px;border-bottom:1px solid var(--border);cursor:pointer}
    .sheet .item:hover{background:rgba(0,0,0,.03)}

    .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    @media (max-width:880px){ .grid-3{grid-template-columns:1fr} }

    .subtle{opacity:.8}
    .toast{position:fixed;left:50%;bottom:calc(env(safe-area-inset-bottom,0px) + 72px);transform:translateX(-50%);
      background:#2F6C3C;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.25);z-index:99999;display:none}
    .toast.show{display:block;animation:fadeout 5s forwards}
    @keyframes fadeout{0%{opacity:1}85%{opacity:1}100%{opacity:0}}
  </style>
</head>

<body>
  <fv-shell>
    <div class="wrap">
      <section class="hero">
        <header class="hero-head">
          <div class="icon" aria-hidden="true">üõ¢Ô∏è</div>
          <div>
            <h1>Put Bag Down</h1>
            <p class="muted">Record bags placed in the field. Inventory auto-adjusts when using <strong>New</strong> bags.</p>
          </div>
        </header>

        <div class="body">
          <!-- FIELD (searchable picker) + CROP YEAR + ADD BAG -->
          <div class="row">
            <div class="field">
              <label for="fieldBtn">Field</label>
              <button id="fieldBtn" class="buttonish" type="button">‚Äî Select field ‚Äî</button>
              <div id="fieldHelp" class="help">0 fields</div>
            </div>

            <div class="field">
              <label for="cropYear">Crop Year</label>
              <select id="cropYear" class="select"></select>
              <div class="help">Defaults to current year.</div>
            </div>
          </div>

          <div class="actions">
            <button id="addBag" class="btn btn-primary" type="button">Add Bag Entry</button>
          </div>

          <!-- HIDDEN BAG FORM (shown after ‚ÄúAdd Bag Entry‚Äù) -->
          <div id="bagForm" hidden>
            <div class="row">
              <div class="field">
                <label for="submittedBy">Submitted By</label>
                <select id="submittedBy" class="select"></select>
                <div id="subHelp" class="help">Defaults to current user.</div>
              </div>

              <div class="field">
                <label for="cropType">Crop Type</label>
                <select id="cropType" class="select">
                  <option value="">‚Äî Select ‚Äî</option>
                  <option value="Corn">Corn</option>
                  <option value="Soybeans">Soybeans</option>
                </select>
              </div>
            </div>

            <div class="row">
              <div class="field">
                <label for="datePlaced">Date Bag Was Put Down</label>
                <input id="datePlaced" class="input" type="date"/>
              </div>

              <div class="field">
                <label for="carryType">Bag Usage</label>
                <select id="carryType" class="select">
                  <option value="">‚Äî Select ‚Äî</option>
                  <option value="carryover">Carryover (don‚Äôt reduce inventory)</option>
                  <option value="new">New (reduce inventory)</option>
                </select>
                <div class="help">If any partial from a <b>new</b> bag is used, inventory will count it as 1 opened bag.</div>
              </div>
            </div>

            <div class="row">
              <div class="field">
                <label for="bagPick">Bag Brand & Size</label>
                <select id="bagPick" class="select">
                  <option value="">‚Äî Loading‚Ä¶ ‚Äî</option>
                </select>
                <div id="bagHelp" class="help">0 bag SKUs</div>
              </div>

              <div class="field">
                <label for="priority">Pickup Priority (1‚Äì10)</label>
                <select id="priority" class="select"></select>
              </div>
            </div>

            <div class="grid-3">
              <div class="field">
                <label for="fullBags">Number of Full Bags</label>
                <input id="fullBags" class="input" type="number" inputmode="numeric" min="0" step="1" value="0"/>
              </div>
              <div class="field">
                <label for="partialBags">Number of Partial Bags</label>
                <input id="partialBags" class="input" type="number" inputmode="numeric" min="0" step="1" value="0"/>
                <div class="help">We‚Äôll ask for each partial‚Äôs estimated length.</div>
              </div>
              <div class="field">
                <label class="subtle">Bag Length Constraint</label>
                <div id="lengthRule" class="help">Select a bag SKU to see allowed partial length range.</div>
              </div>
            </div>

            <!-- Partial lengths container -->
            <div id="partialsBox" class="field" hidden>
              <label>Partial Bag Lengths (ft)</label>
              <div id="partialsList" class="row"></div>
              <div id="partialsHelp" class="help"></div>
            </div>

            <div class="field">
              <label for="notes">Notes</label>
              <textarea id="notes" class="textarea" placeholder="Optional details"></textarea>
            </div>

            <div class="field">
              <label for="files">Optional Photos</label>
              <input id="files" class="input" type="file" accept="image/*,.jpg,.jpeg,.png,.heic,.pdf" multiple>
              <div class="help">You can attach photos of the bag placement/location.</div>
            </div>

            <div id="err" class="help error" hidden></div>

            <div class="actions">
              <button id="btnClear" class="btn" type="button">Clear</button>
              <button id="btnSave" class="btn btn-primary" type="button">Save</button>
            </div>
          </div>
        </div>
      </section>
    </div>
  </fv-shell>

  <div id="toast" class="toast" role="status" aria-live="polite">Saved.</div>

  <!-- FIELD PICKER SHEET -->
  <div id="fieldSheet" class="sheet" role="dialog" aria-modal="true" aria-labelledby="fieldTitle">
    <div class="cap">
      <div class="bar" aria-hidden="true"></div>
    </div>
    <div class="search">
      <input id="fieldSearch" type="search" placeholder="Search fields‚Ä¶" autocomplete="off"/>
    </div>
    <div class="list" id="fieldList"></div>
  </div>

  <!-- Firebase (modular) -->
  <script type="module">
    import {
      ready, getFirestore, getAuth,
      collection, getDocs, addDoc, doc, updateDoc,
      serverTimestamp, query, orderBy, where, limit
    } from '/Farm-vista/js/firebase-init.js';

    // Lazy Storage loader (only if files are added)
    async function loadStorageFns(){
      const m = await import('/Farm-vista/js/firebase-init.js');
      return { getStorage:m.getStorage, ref:m.ref, uploadBytes:m.uploadBytes, getDownloadURL:m.getDownloadURL };
    }

    // Shorthands
    const $ = id => document.getElementById(id);
    const esc = s => String(s??"").replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;",'"':"&quot;","'":"&#39;"}[m]));
    function toast(msg="Saved.", ms=4200){ const t=$("toast"); t.textContent=msg; t.classList.remove("show"); void t.offsetWidth; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"),ms); }

    // State
    let FIELD_INDEX = [];   // [{id,name,farm?}]
    let EMPLOYEES   = [];   // [{id,email,name}]
    let BAG_SKUS    = [];   // [{id,brand,sizeFeet,onHand}]
    let chosenField = null; // {id,name}
    let chosenBag   = null; // BAG_SKUS item

    // Helpers
    function todayISO(){ const d=new Date(); const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), da=String(d.getDate()).padStart(2,'0'); return `${y}-${m}-${da}`; }

    function fillYears(){
      const y = new Date().getFullYear();
      const opts = [y-1, y, y+1].map(v=>`<option value="${v}" ${v===y?'selected':''}>${v}</option>`).join('');
      $("cropYear").innerHTML = opts;
    }

    function fillPriority(){
      const opts = Array.from({length:10},(_,i)=>i+1).map(v=>`<option value="${v}" ${v===5?'selected':''}>${v}</option>`).join('');
      $("priority").innerHTML = opts;
    }

    function renderFieldButton(){
      $("fieldBtn").textContent = chosenField ? `${chosenField.name}` : "‚Äî Select field ‚Äî";
      $("fieldHelp").textContent = `${FIELD_INDEX.length} fields`;
    }

    function renderBagConstraint(){
      const rule = $("lengthRule");
      if(!chosenBag){ rule.textContent = "Select a bag SKU to see allowed partial length range."; return; }
      const L = Number(chosenBag.sizeFeet||0);
      const min = 50;
      const max = Math.max(0, L - 50);
      rule.textContent = `Partial per-bag length must be between ${min} ft and ${max} ft (bag length ${L} ft).`;
    }

    function renderPartialInputs(){
      const n = Math.max(0, Number($("partialBags").value||0));
      const box = $("partialsBox");
      const list = $("partialsList");
      list.innerHTML = "";
      if(n<=0){ box.hidden=true; return; }
      box.hidden=false;
      for(let i=0;i<n;i++){
        const inp = document.createElement('input');
        inp.type = 'number';
        inp.inputMode='numeric';
        inp.min = '50';
        inp.step='1';
        inp.placeholder = `Partial ${i+1} length (ft)`;
        inp.className = 'input';
        inp.dataset.idx = String(i);
        list.appendChild(inp);
      }
      $("partialsHelp").textContent = "Enter each partial‚Äôs estimated feet. All must obey the allowed range.";
    }

    function getSelectedEmployeeDefault(auth){
      const email = (auth.currentUser?.email||"").toLowerCase();
      let i = EMPLOYEES.findIndex(e => e.email?.toLowerCase()===email);
      return i>=0 ? EMPLOYEES[i].id : (EMPLOYEES[0]?.id||"");
    }

    function setBagChoiceById(id){
      chosenBag = BAG_SKUS.find(b=>b.id===id) || null;
      renderBagConstraint();
    }

    function validatePartials(){
      if(!chosenBag) return true; // nothing to validate yet
      const L = Number(chosenBag.sizeFeet||0);
      const min = 50;
      const max = Math.max(0, L - 50);
      const inputs = Array.from($("partialsList").querySelectorAll('input'));
      for(const inp of inputs){
        const v = Number(inp.value||0);
        if(!(v>=min && v<=max)){
          inp.focus();
          throw new Error(`Partial length must be between ${min} and ${max} ft for ${L} ft bag.`);
        }
      }
      return true;
    }

    async function populateFields(db){
      // Primary: /fields ordered by name
      try{
        const snap = await getDocs(query(collection(db,'fields'), orderBy('name')));
        const items = [];
        snap.forEach(d=>{
          const x=d.data()||{};
          const name=String(x.name||"").trim();
          if(name) items.push({id:d.id, name, farm:x.farm||null});
        });
        items.sort((a,b)=>a.name.localeCompare(b.name));
        FIELD_INDEX = items;
        $("fieldList").innerHTML = items.map(it=>`<div class="item" data-id="${esc(it.id)}">${esc(it.name)}</div>`).join('');
        $("fieldHelp").textContent = `${items.length} fields`;
      }catch(err){
        $("fieldHelp").textContent = `0 fields (load error)`;
        console.warn("Fields load failed:", err);
      }
    }

    async function populateEmployees(db, auth){
      try{
        const snap = await getDocs(collection(db,'employees'));
        const list=[];
        snap.forEach(d=>{
          const x=d.data()||{};
          const name = String(x.name || x.displayName || x.fullName || x.email || d.id);
          const email = x.email || d.id;
          list.push({id:d.id, name, email});
        });
        list.sort((a,b)=> (a.name||"").localeCompare(b.name||""));
        EMPLOYEES = list;
        $("submittedBy").innerHTML = list.map(e=>`<option value="${esc(e.id)}">${esc(e.name)}${e.email?' ‚Äî '+esc(e.email):''}</option>`).join('');
        $("submittedBy").value = getSelectedEmployeeDefault(auth);
        $("subHelp").textContent = `${list.length} employees`;
      }catch(err){
        console.warn("Employees load failed:", err);
        $("submittedBy").innerHTML = `<option value="">(no employees)</option>`;
      }
    }

    async function populateBags(db){
      // Try preferred collection id first; then fallback name.
      async function tryLoad(colName){
        const snap = await getDocs(collection(db,colName));
        const list=[];
        snap.forEach(d=>{
          const x=d.data()||{};
          // Expecting fields like brand, sizeFeet (number), onHand (number)
          const brand = x.brand || x.name || 'Bag';
          const sizeFeet = Number(x.sizeFeet || x.lengthFeet || x.length || 0);
          const onHand = Number(x.onHand || x.qty || x.quantity || 0);
          if(sizeFeet>0) list.push({id:d.id, brand, sizeFeet, onHand});
        });
        return list;
      }
      try{
        let list = await tryLoad('products_grain_bags');
        if(!list.length) list = await tryLoad('products-grain-bags');
        list.sort((a,b)=>{
          const A=`${a.brand} ${a.sizeFeet}`, B=`${b.brand} ${b.sizeFeet}`;
          return A.localeCompare(B, undefined, {numeric:true});
        });
        BAG_SKUS = list;
        $("bagPick").innerHTML = `<option value="">‚Äî Select ‚Äî</option>` + list.map(b=>{
          const label = `${b.brand} ‚Äî ${b.sizeFeet} ft (on hand: ${b.onHand})`;
          return `<option value="${esc(b.id)}">${esc(label)}</option>`;
        }).join('');
        $("bagHelp").textContent = `${list.length} bag SKUs`;
      }catch(err){
        console.warn("Bags load failed:", err);
        $("bagPick").innerHTML = `<option value="">‚Äî Error ‚Äî</option>`;
        $("bagHelp").textContent = `0 bag SKUs (load error)`;
      }
    }

    function openFieldSheet(){ $("fieldSheet").classList.add('show'); $("fieldSearch").value=""; filterFields(""); $("fieldSearch").focus(); }
    function closeFieldSheet(){ $("fieldSheet").classList.remove('show'); }
    function filterFields(q){
      q=(q||"").trim().toLowerCase();
      const box = $("fieldList");
      const out=[];
      for(const it of FIELD_INDEX){
        if(!q || it.name.toLowerCase().includes(q)) out.push(`<div class="item" data-id="${esc(it.id)}">${esc(it.name)}</div>`);
      }
      box.innerHTML = out.join('') || `<div class="item subtle">(no matches)</div>`;
    }

    async function handleSave(db, auth){
      $("err").hidden=true;
      // Required checkpoints
      if(!chosenField) { alert("Please choose a Field."); return; }
      const cropYear = Number($("cropYear").value||0);
      if(!cropYear){ alert("Please choose Crop Year."); return; }
      const carryType = $("carryType").value;
      if(!carryType){ alert("Please select Bag Usage (Carryover or New)."); return; }
      const bagId = $("bagPick").value;
      if(!bagId){ alert("Please choose Bag Brand & Size."); return; }
      const cropType = $("cropType").value;
      if(!cropType){ alert("Please choose Crop Type."); return; }
      const datePlaced = $("datePlaced").value;
      if(!datePlaced){ alert("Please set the Date placed."); return; }
      setBagChoiceById(bagId);
      try{ validatePartials(); }catch(e){ $("err").hidden=false; $("err").textContent=e.message; return; }

      const fullBags = Math.max(0, Number($("fullBags").value||0));
      const partialCount = Math.max(0, Number($("partialBags").value||0));
      const partialLens = Array.from($("partialsList").querySelectorAll('input')).map(i=>Number(i.value||0)).filter(v=>v>0);

      if(partialCount !== partialLens.length){
        alert("Please enter each partial bag length.");
        return;
      }

      // Submitted by (employee id/email + best-effort name)
      const subId = $("submittedBy").value || "";
      const subEmp = EMPLOYEES.find(e=>e.id===subId) || {};
      const subEmail = subEmp.email || (auth.currentUser?.email || "");
      const subName  = subEmp.name  || (auth.currentUser?.displayName || subEmail || "Unknown");

      // Build record
      const record = {
        type: 'putDown',
        field: { id: chosenField.id, name: chosenField.name },
        cropYear,
        cropType,
        datePlaced, // ISO yyyy-mm-dd (client local)
        usage: carryType, // 'carryover' | 'new'
        bagSku: {
          id: chosenBag?.id || bagId,
          brand: chosenBag?.brand || null,
          sizeFeet: Number(chosenBag?.sizeFeet || 0)
        },
        counts: {
          full: fullBags,
          partial: partialCount,
          partialFeet: partialLens
        },
        priority: Number($("priority").value||5),
        notes: $("notes").value.trim(),
        submittedBy: {
          employeeId: subId || null,
          name: subName,
          email: subEmail
        },
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      };

      // Save base doc
      const ref = await addDoc(collection(db, 'grain_bag_events'), record);

      // Upload files (lazy-load Storage)
      const files = Array.from(($("files").files||[]));
      if(files.length){
        try{
          const { getStorage, ref:stRef, uploadBytes, getDownloadURL } = await loadStorageFns();
          const st = getStorage();
          const uploaded = [];
          for(const f of files){
            const safe = (Date.now()+'-'+f.name).replace(/[^\w.\-]+/g,'_');
            const path = `grain_bag_events/${ref.id}/${safe}`;
            const r = stRef(st, path);
            await uploadBytes(r, f, { contentType:f.type || 'application/octet-stream' });
            const url = await getDownloadURL(r);
            uploaded.push({name:f.name, url, path});
          }
          await updateDoc(doc(db,'grain_bag_events',ref.id), { files: uploaded, updatedAt: serverTimestamp() });
        }catch(stErr){
          $("err").hidden=false; $("err").textContent = `Saved, but photo upload failed: ${stErr.message}`;
        }
      }

      // Inventory decrement (NEW only)
      if(carryType === 'new'){
        try{
          // Decrement by (fullBags) + (openedPartial ? 1 : 0)
          const debit = fullBags + (partialLens.length>0 ? 1 : 0);
          if(debit>0){
            // Best-effort: try primary collection then fallback
            const tryDec = async (col) => {
              const skuDoc = doc(db, col, chosenBag.id);
              // read current and update (optimistic)
              // For simplicity (no transaction here): fetch then update
              const s = await getDocs(query(collection(db, col), where('__name__','==', chosenBag.id), limit(1)));
              if(!s.empty){
                // Re-fetch onHand from list cache; if undefined, just decrement
                const onHand = Number(chosenBag.onHand ?? 0);
                const next = Math.max(0, onHand - debit);
                await updateDoc(skuDoc, { onHand: next, updatedAt: serverTimestamp() });
                return true;
              }
              return false;
            };
            let ok = await tryDec('products_grain_bags');
            if(!ok) ok = await tryDec('products-grain-bags');
          }
        }catch(invErr){
          console.warn("Inventory decrement failed:", invErr);
          // Non-blocking; record is already saved.
        }
      }

      toast("Put Down recorded.");
      // Reset some UI, keep field/year
      $("carryType").value = "";
      $("bagPick").value = "";
      $("cropType").value = "";
      $("datePlaced").value = todayISO();
      $("fullBags").value = "0";
      $("partialBags").value = "0";
      $("notes").value = "";
      $("files").value = "";
      setBagChoiceById(null);
      renderBagConstraint();
      renderPartialInputs();
    }

    // Boot
    (async()=>{
      const ctx = await ready;
      const db = getFirestore();
      const auth = getAuth();

      fillYears();
      fillPriority();
      $("datePlaced").value = todayISO();

      // Load lists
      await Promise.all([
        populateFields(db),
        populateEmployees(db, auth),
        populateBags(db)
      ]);
      renderFieldButton();
      renderBagConstraint();

      // Field picker wiring
      $("fieldBtn").addEventListener("click", openFieldSheet);
      $("fieldSearch").addEventListener("input", (e)=> filterFields(e.target.value));
      $("fieldList").addEventListener("click", (e)=>{
        const el = e.target.closest(".item");
        if(!el) return;
        const id = el.dataset.id;
        const it = FIELD_INDEX.find(f=>f.id===id);
        if(it){ chosenField = it; renderFieldButton(); closeFieldSheet(); }
      });
      // Close sheet on outside tap (drag handle area)
      document.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeFieldSheet(); });

      // Add Bag button
      $("addBag").addEventListener("click", ()=>{
        if(!chosenField) { alert("Choose a Field first."); return; }
        if(!$("cropYear").value){ alert("Choose Crop Year."); return; }
        $("bagForm").hidden = false;
        toast("Bag form ready.");
      });

      // Bag selection + constraints
      $("bagPick").addEventListener("change", (e)=> setBagChoiceById(e.target.value));
      $("partialBags").addEventListener("input", renderPartialInputs);

      // Save/Clear
      $("btnSave").addEventListener("click", ()=> handleSave(db, auth));
      $("btnClear").addEventListener("click", ()=>{
        $("carryType").value=""; $("bagPick").value=""; $("cropType").value="";
        $("datePlaced").value=todayISO(); $("fullBags").value="0"; $("partialBags").value="0"; renderPartialInputs();
        $("notes").value=""; $("files").value="";
        $("submittedBy").value = getSelectedEmployeeDefault(auth);
      });

      // Online/offline toasts
      window.addEventListener('online', ()=> toast("Back online ‚Äî syncing‚Ä¶", 3000));
      window.addEventListener('offline',()=> toast("Currently offline ‚Äî using saved data", 3000));
    })();
  </script>

  <!-- Notes:
       ‚Ä¢ Saves to /grain_bag_events (type: 'putDown').
       ‚Ä¢ Bag inventory best-effort decrement in /products_grain_bags or /products-grain-bags.
       ‚Ä¢ Partial-length rule: min 50 ft; max (bagLength - 50 ft).
       ‚Ä¢ If usage = 'new' and any partials exist, inventory counts as +1 opened bag.
       ‚Ä¢ Employees default to logged-in user; list from /employees.
  -->
</body>
</html>