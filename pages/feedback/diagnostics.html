<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista ‚Ä¢ Diagnostics</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- Standard includes (absolute paths, Option A safe) -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <style>
    :root{ --ok:#2F6C3C; --warn:#D0C542; --err:#B3261E; --ink:#141514; --card:var(--surface,#fff); }
    .page{max-width:1100px;margin:0 auto;padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + 96px)!important;}
    h1{margin:0 0 6px 0}
    p.sub{margin:0 0 18px 0;color:var(--muted,#67706B)}
    .grid{display:grid;gap:14px}
    .card{border:1px solid var(--border);border-radius:14px;background:var(--card);box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));overflow:hidden}
    .head{display:flex;gap:10px;align-items:center;padding:12px 14px;border-bottom:1px solid var(--border);
      background:linear-gradient(90deg, rgba(47,108,60,.10), transparent);}
    .body{padding:14px}
    .kvs{display:grid;grid-template-columns:260px 1fr;gap:8px 14px}
    .k{color:#5b625e}
    .v{color:var(--ink);word-break:break-all}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
    .btns{display:flex;flex-wrap:wrap;gap:10px;margin:10px 0 0}
    .btn{display:inline-flex;align-items:center;gap:8px;border:1px solid var(--border);border-radius:12px;
      background:var(--card);padding:10px 14px;font-weight:800;cursor:pointer}
    .btn-primary{border-color:transparent;background:#2F6C3C;color:#fff}
    .btn-warn{border-color:transparent;background:#D0C542;color:#141514}
    .btn-danger{border-color:transparent;background:#B3261E;color:#fff}
    .status{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;font-weight:800}
    .ok{background:rgba(47,108,60,.12);color:#2F6C3C}
    .warn{background:rgba(208,197,66,.18);color:#6a5f08}
    .err{background:rgba(179,38,30,.12);color:#B3261E}
    .log{border:1px dashed var(--border);border-radius:10px;background:#fafbfa;padding:10px;max-height:42vh;overflow:auto}
    .small{font-size:13px;color:#5b625e}
    .hl{padding:2px 6px;border-radius:6px;background:#f2f3f2}
    code{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size: 13px;}
  </style>

  <!-- Ensure fv-shell -->
  <script>(function(){
    if(!customElements.get('fv-shell')){
      const s=document.createElement('script'); s.src='/Farm-vista/js/fv-shell.js'; s.defer=true; document.head.appendChild(s);
    }
  })();</script>
</head>
<body>
  <fv-shell>
    <div class="page container">
      <h1>Diagnostics</h1>
      <p class="sub">Quick checks for build, auth, user context, Service Worker, Firestore, Storage, and resource loads. Includes real Storage and Firestore tests.</p>

      <div class="grid">

        <!-- App / Build -->
        <section class="card">
          <header class="head"><strong>App &amp; Build</strong> <span id="st-app" class="status warn">‚è≥ Pending</span></header>
          <div class="body">
            <div class="kvs mono">
              <div class="k">Location</div><div class="v" id="v-url"></div>
              <div class="k">FV Version</div><div class="v" id="v-version"></div>
              <div class="k">Runtime Mode</div><div class="v" id="v-mode"></div>
              <div class="k">Config Present</div><div class="v" id="v-config"></div>
              <div class="k">Project ID</div><div class="v" id="v-project"></div>
              <div class="k">Auth Domain</div><div class="v" id="v-authdom"></div>
              <div class="k">Storage Bucket (config)</div><div class="v" id="v-bucket"></div>
              <div class="k">Config Checks</div><div class="v" id="v-config-ok"></div>
              <div class="k">Init Signature</div><div class="v" id="v-init-len"></div>
            </div>
            <div class="btns">
              <button id="btn-run" class="btn btn-primary">‚ñ∂ Run All Tests</button>
              <button id="btn-refresh" class="btn">‚Üª Soft Refresh ( <code>fv:refresh</code> )</button>
              <button id="btn-hard" class="btn btn-warn">üåÄ Hard Reload w/o SW</button>
            </div>
          </div>
        </section>

        <!-- Resource loader (did we fetch firebase-storage.js?) -->
        <section class="card">
          <header class="head"><strong>Resource Loader</strong> <span id="st-res" class="status warn">‚è≥ Pending</span></header>
          <div class="body mono" id="res-box"></div>
        </section>

        <!-- Auth -->
        <section class="card">
          <header class="head"><strong>Auth</strong> <span id="st-auth" class="status warn">‚è≥ Pending</span></header>
          <div class="body">
            <div class="kvs mono">
              <div class="k">Signed In</div><div class="v" id="v-signed"></div>
              <div class="k">UID</div><div class="v" id="v-uid"></div>
              <div class="k">Email</div><div class="v" id="v-email"></div>
              <div class="k">Display Name</div><div class="v" id="v-name"></div>
              <div class="k">Admin claim</div><div class="v" id="v-admin"></div>
            </div>
            <div class="btns">
              <button id="btn-token" class="btn">‚ôªÔ∏è Force Token Refresh</button>
              <button id="btn-signout" class="btn btn-danger">üö™ Sign Out</button>
              <a class="btn" href="/Farm-vista/pages/auth/index.html">‚û°Ô∏è Go to Login</a>
            </div>
          </div>
        </section>

        <!-- User Context -->
        <section class="card">
          <header class="head"><strong>User Context</strong> <span id="st-ctx" class="status warn">‚è≥ Pending</span></header>
          <div class="body">
            <div class="kvs mono">
              <div class="k">Role</div><div class="v" id="v-role"></div>
              <div class="k">Allowed IDs (count)</div><div class="v" id="v-allow-count"></div>
              <div class="k">Last Updated</div><div class="v" id="v-ctx-updated"></div>
            </div>
          </div>
        </section>

        <!-- Service Worker & Caches -->
        <section class="card">
          <header class="head"><strong>Service Worker &amp; Caches</strong> <span id="st-sw" class="status warn">‚è≥ Pending</span></header>
          <div class="body">
            <div class="kvs mono">
              <div class="k">SW Registered</div><div class="v" id="v-sw"></div>
              <div class="k">Controlled</div><div class="v" id="v-sw-ctrl"></div>
              <div class="k">Cache Keys</div><div class="v" id="v-cache-keys"></div>
            </div>
            <div class="btns">
              <button id="btn-nuke" class="btn btn-danger">üß® Nuke SW Caches</button>
              <button id="btn-unreg" class="btn btn-danger">üö´ Unregister SW</button>
              <button id="btn-clear" class="btn btn-danger">üßΩ Clear local/session/IndexedDB</button>
            </div>
          </div>
        </section>

        <!-- Firebase Modules -->
        <section class="card">
          <header class="head"><strong>Firebase Modules</strong> <span id="st-mods" class="status warn">‚è≥ Pending</span></header>
          <div class="body">
            <div class="kvs mono">
              <div class="k">Firestore API</div><div class="v" id="v-has-fs"></div>
              <div class="k">Storage API</div><div class="v" id="v-has-st"></div>
              <div class="k">Storage Bucket (SDK)</div><div class="v" id="v-bucket-sdk"></div>
              <div class="k">Module Fresh Import</div><div class="v" id="v-fresh"></div>
            </div>
            <div class="small">If ‚ÄúModule Fresh Import‚Äù is <em>false</em> or old, your Service Worker may be serving a stale <code>firebase-init.js</code>.</div>
          </div>
        </section>

        <!-- Firestore tests -->
        <section class="card">
          <header class="head"><strong>Firestore Tests</strong> <span id="st-fs" class="status warn">‚è≥ Pending</span></header>
          <div class="body">
            <div class="btns">
              <button id="btn-try-read" class="btn">üõ†Ô∏è Try Read: <code>accountRoles</code></button>
              <button id="btn-try-write" class="btn btn-primary">‚úçÔ∏è Try Write: <code>diagnostics</code></button>
            </div>
            <div class="log mono" id="fs-log"></div>
          </div>
        </section>

        <!-- Storage tests -->
        <section class="card">
          <header class="head"><strong>Storage Tests</strong> <span id="st-up" class="status warn">‚è≥ Pending</span></header>
          <div class="body">
            <p class="small">Uploads a tiny text blob to <span class="hl">user-uploads/&lt;uid&gt;/diagnostics/diag-&lt;timestamp&gt;.txt</span>, then reports the public URL.</p>
            <div class="btns">
              <button id="btn-upload" class="btn btn-primary">‚¨Ü Upload Blob</button>
              <button id="btn-list" class="btn">üìÇ List Folder</button>
            </div>
            <div class="log mono" id="log"></div>
          </div>
        </section>

      </div>
    </div>
  </fv-shell>

  <script type="module">
    const $ = (s)=>document.querySelector(s);
    const st = {
      app: $('#st-app'), res: $('#st-res'), auth: $('#st-auth'), ctx: $('#st-ctx'),
      sw: $('#st-sw'), mods: $('#st-mods'), fs: $('#st-fs'), up: $('#st-up')
    };
    const vv = {
      url: $('#v-url'), version: $('#v-version'), mode: $('#v-mode'),
      config: $('#v-config'), project: $('#v-project'), authdom: $('#v-authdom'),
      bucket: $('#v-bucket'), cfgOk: $('#v-config-ok'), initLen: $('#v-init-len'),
      signed: $('#v-signed'), uid: $('#v-uid'), email: $('#v-email'), name: $('#v-name'), admin: $('#v-admin'),
      role: $('#v-role'), allow: $('#v-allow-count'), ctxUp: $('#v-ctx-updated'),
      sw: $('#v-sw'), swCtrl: $('#v-sw-ctrl'), cacheKeys: $('#v-cache-keys'),
      hasFs: $('#v-has-fs'), hasSt: $('#v-has-st'), bucketSdk: $('#v-bucket-sdk'), fresh: $('#v-fresh')
    };
    const logEl = $('#log');
    const fsLog = $('#fs-log');

    const addLog = (el)=>(l)=>{ const t=new Date().toLocaleTimeString(); el.textContent += `[${t}] ${l}\n`; el.scrollTop = el.scrollHeight; };
    const addUpLog = addLog(logEl);
    const addFsLog = addLog(fsLog);

    const setOK   = (el)=>{ el.className='status ok';   el.textContent='‚úÖ OK'; };
    const setWARN = (el)=>{ el.className='status warn'; el.textContent='‚ö†Ô∏è Check'; };
    const setERR  = (el)=>{ el.className='status err';  el.textContent='‚ùå Error'; };

    const setKV = (el, val)=>{ el.textContent = (val === undefined || val === null || val === '') ? '‚Äî' : String(val); };

    /* ---------------- App / Build ---------------- */
    async function runApp(mod){
      setKV(vv.url, location.href);
      setKV(vv.version, (window.FV_VERSION && window.FV_VERSION.number) || 'unknown');
      const cfg = window.FV_FIREBASE_CONFIG || null;
      setKV(vv.config, !!cfg);
      setKV(vv.project, cfg?.projectId || '‚Äî');
      setKV(vv.authdom, cfg?.authDomain || '‚Äî');
      setKV(vv.bucket, cfg?.storageBucket || '‚Äî');
      setKV(vv.cfgOk, cfg ? 'ok' : 'missing');
      setKV(vv.initLen, (mod && String(mod.ready).length) || '‚Äî');
      setKV(vv.mode, (mod && mod.mode) || (window.FV_HAS_STORAGE ? 'firebase' : 'stub'));
      setOK(st.app);
    }

    /* ---------------- Resource Loader ---------------- */
    function runResourceLoader(){
      const perf = performance.getEntriesByType('resource') || [];
      const has = (needle)=> perf.some(p => (p.name || '').includes(needle));
      const rows = [
        ['firebase-app.js', has('firebase-app.js')],
        ['firebase-auth.js', has('firebase-auth.js')],
        ['firebase-firestore.js', has('firebase-firestore.js')],
        ['firebase-storage.js', has('firebase-storage.js')]
      ];
      const pre = rows.map(r => `${r[0].padEnd(22)} ${String(!!r[1]).padStart(5)}`).join('\n');
      $('#res-box').textContent = pre + '\n\nData is from performance.getEntriesByType(\'resource\').\nIf storage is "false", your page never fetched the Storage SDK and uploads will say "Storage not loaded".';
      setOK(st.res);
    }

    /* ---------------- Auth ---------------- */
    async function runAuth(mod){
      try{
        const auth = mod.getAuth();
        const u = auth?.currentUser || null;
        setKV(vv.signed, !!u);
        setKV(vv.uid, u?.uid || '');
        setKV(vv.email, u?.email || '');
        setKV(vv.name, u?.displayName || '');
        let adminClaim = '‚Äî';
        if (u){
          try{
            const tok = await u.getIdTokenResult?.();
            adminClaim = tok?.claims?.admin === true ? 'true' : 'false';
          }catch{}
        }
        setKV(vv.admin, adminClaim);
        setOK(st.auth);

        // Wire buttons
        $('#btn-token').onclick = async ()=>{
          try{ await u?.getIdToken(true); addFsLog('Token refreshed'); }catch(e){ addFsLog('Token refresh failed: '+e); }
        };
        $('#btn-signout').onclick = async ()=>{ try{ await mod.signOut(); location.href='/Farm-vista/pages/auth/index.html'; }catch(e){ addFsLog('Sign out failed: '+e); } };
      }catch(e){ setERR(st.auth); addFsLog('Auth error: '+e); }
    }

    /* ---------------- User Context ---------------- */
    async function runCtx(){
      try{
        const ctx = window.FVUserContext && (await window.FVUserContext.ready());
        setKV(vv.role, ctx?.roleName || '‚Äî');
        setKV(vv.allow, Array.isArray(ctx?.allowedIds) ? ctx.allowedIds.length : 0);
        setKV(vv.ctxUp, ctx?.updatedAt || '‚Äî');
        setOK(st.ctx);
      }catch(e){ setERR(st.ctx); addFsLog('UserContext error: '+e); }
    }

    /* ---------------- Service Worker ---------------- */
    async function runSW(){
      try{
        const reg = await navigator.serviceWorker?.getRegistration?.();
        setKV(vv.sw, !!reg);
        setKV(vv.swCtrl, !!navigator.serviceWorker?.controller);
        const keys = await caches?.keys?.() || [];
        setKV(vv.cacheKeys, keys.join(', ') || '‚Äî');
        setOK(st.sw);
      }catch(e){ setERR(st.sw); addFsLog('SW error: '+e); }
    }
    $('#btn-nuke').onclick = async ()=>{
      try{ navigator.serviceWorker?.controller?.postMessage('NUKE_CACHES'); }catch{}
      setTimeout(()=>location.reload(), 600);
    };
    $('#btn-unreg').onclick = async ()=>{
      try{ const reg = await navigator.serviceWorker?.getRegistration?.(); await reg?.unregister(); }catch{}
      location.reload();
    };
    $('#btn-clear').onclick = async ()=>{
      try{ localStorage.clear(); sessionStorage.clear(); }catch{}
      try{ indexedDB.databases && (await Promise.all((await indexedDB.databases()).map(db=>indexedDB.deleteDatabase(db.name)))); }catch{}
      alert('Local/session/IndexedDB cleared. Reloading‚Ä¶'); location.reload();
    };
    $('#btn-hard').onclick = async ()=>{
      try{ const reg = await navigator.serviceWorker?.getRegistration?.(); await reg?.unregister(); }catch{}
      location.reload(true);
    };

    /* ---------------- Firebase Modules ---------------- */
    async function runModulesFresh(){
      try{
        const fresh = await import('/Farm-vista/js/firebase-init.js?rev='+Date.now());
        await fresh.ready; // <-- critical: wait for init
        const hasFs = !!(fresh.getFirestore && fresh.doc && fresh.getDoc && fresh.addDoc);
        const hasSt = !!(fresh.getStorage && (fresh.ref || fresh.storageRef) && fresh.uploadBytes && fresh.getDownloadURL);
        setKV(vv.hasFs, hasFs);
        setKV(vv.hasSt, hasSt);
        let bucketSdk = '‚Äî';
        try{
          const app = (fresh.getApp ? fresh.getApp() : null) || window.firebaseApp || null;
          bucketSdk = app?.options?.storageBucket || '‚Äî';
        }catch{}
        setKV(vv.bucketSdk, bucketSdk);
        setKV(vv.fresh, hasSt && hasFs ? 'true' : 'false');
        (hasSt && hasFs) ? setOK(st.mods) : setWARN(st.mods);
      }catch(e){
        setERR(st.mods);
        setKV(vv.fresh, 'false');
        addFsLog('Fresh import failed: '+e);
      }
    }

    /* ---------------- Firestore Tests ---------------- */
    async function fsTryRead(mod){
      try{
        const db = mod.getFirestore();
        const snap = await mod.getDocs(mod.collection(db,'accountRoles'));
        addFsLog(`Read OK: accountRoles size=${snap.size}`);
        setOK(st.fs);
      }catch(e){
        setERR(st.fs);
        addFsLog('Read failed: '+(e.message||e.code||e));
      }
    }
    async function fsTryWrite(mod){
      try{
        const db = mod.getFirestore();
        const ref = await mod.addDoc(mod.collection(db,'diagnostics'), {
          at: mod.serverTimestamp(), by: (window.__FV_USER?.uid || null), note: 'diag probe'
        });
        addFsLog(`Write OK: doc id ${ref.id}`);
        setOK(st.fs);
      }catch(e){
        setERR(st.fs);
        addFsLog('Write failed: '+(e.message||e.code||e));
      }
    }

    /* ---------------- Storage Tests ---------------- */
    async function doUploadTest(){
      try{
        const fresh = await import('/Farm-vista/js/firebase-init.js?rev='+Date.now());
        await fresh.ready; // <-- CRITICAL
        const hasSt = !!(fresh.getStorage && (fresh.storageRef || fresh.ref) && fresh.uploadBytes && fresh.getDownloadURL);
        if (!hasSt){
          setERR(st.up); addUpLog('Storage APIs not available (is firebase-storage.js imported?)'); return;
        }
        const auth = fresh.getAuth();
        const u = auth?.currentUser || null;
        if (!u){ setERR(st.up); addUpLog('No signed-in user; cannot compute user-uploads/<uid> path.'); return; }

        const store = fresh.getStorage();                 // now initialized
        const storageRef = (fresh.storageRef || fresh.ref);
        const ts = Date.now();
        const filename = `diag-${ts}.txt`;
        const path = `user-uploads/${u.uid}/diagnostics/${filename}`;

        const blob = new Blob([`FarmVista Diagnostics OK @ ${new Date().toISOString()}`], { type:'text/plain' });
        addUpLog(`Uploading to gs://${(window.FV_FIREBASE_CONFIG && window.FV_FIREBASE_CONFIG.storageBucket) || '(bucket?)'}/${path}`);
        const r = storageRef(store, path);
        await fresh.uploadBytes(r, blob, { contentType:'text/plain' });
        const url = await fresh.getDownloadURL(r);
        addUpLog('Upload success. Download URL: '+url);
        setOK(st.up);
      }catch(e){
        setERR(st.up);
        addUpLog('Upload failed: '+(e && (e.message||e.code||e)) );
      }
    }

    async function doListFolder(){
      addUpLog('listAll not available in exported API; skipping list.');
    }

    /* ---------------- Buttons ---------------- */
    $('#btn-run').addEventListener('click', async ()=>{
      [st.app, st.res, st.auth, st.ctx, st.sw, st.mods, st.fs, st.up].forEach(setWARN);
      logEl.textContent = ''; fsLog.textContent='';
      const mod = await import('/Farm-vista/js/firebase-init.js?rev='+Date.now());
      await mod.ready; // <-- important
      await runApp(mod);
      runResourceLoader();
      await runAuth(mod);
      await runCtx();
      await runSW();
      await runModulesFresh();
      setOK(st.app); // keep green
      addUpLog('All checks complete.');
    });

    $('#btn-refresh').addEventListener('click', ()=>{
      try { document.dispatchEvent(new CustomEvent('fv:refresh')); addUpLog('Emitted fv:refresh'); } catch {}
    });

    $('#btn-try-read').onclick = async ()=>{
      const mod = await import('/Farm-vista/js/firebase-init.js?rev='+Date.now());
      await mod.ready;
      await fsTryRead(mod);
    };
    $('#btn-try-write').onclick = async ()=>{
      const mod = await import('/Farm-vista/js/firebase-init.js?rev='+Date.now());
      await mod.ready;
      await fsTryWrite(mod);
    };

    $('#btn-upload').addEventListener('click', doUploadTest);
    $('#btn-list').addEventListener('click', doListFolder);

    // Auto run basic checks on load
    (async()=>{
      const mod = await import('/Farm-vista/js/firebase-init.js?rev='+Date.now());
      await mod.ready; // <-- important
      await runApp(mod);
      runResourceLoader();
      await runAuth(mod);
      await runCtx();
      await runSW();
      await runModulesFresh();
      addUpLog('Initial checks complete. You can now run Storage/Firestore tests.');
    })();
  </script>
</body>
</html>