<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista ‚Ä¢ Feedback ‚Üí Bugs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- Standard includes -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <style>
    .page{max-width:1100px;margin:0 auto;padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + 96px)!important;}
    .page-title{margin:0 0 8px 0;}
    .page-sub{margin:0 0 14px 0;color:var(--muted,#67706B);}
    .section{border:1px solid var(--border);border-radius:14px;background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));overflow:hidden;}
    .section-head{display:grid;grid-template-columns:36px 1fr;gap:12px;align-items:center;
      padding:14px 16px;border-bottom:1px solid var(--border);
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);}
    .section-head .icon{width:24px;height:24px;color:#2F6C3C;display:grid;place-items:center;}
    .section-body{padding:16px;display:grid;gap:14px;}

    .row{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    .row-1{display:grid;gap:10px;grid-template-columns:1fr}
    @media(max-width:980px){.row{grid-template-columns:1fr 1fr}}
    @media(max-width:720px){.row,.row-1{grid-template-columns:1fr}}

    .field label{display:block;font-weight:800;margin:0 0 6px 0;}
    .input,.select,.textarea{
      width:100%;font:inherit;font-size:16px;color:var(--text);
      background:var(--card-surface,var(--surface));border:1px solid var(--border);
      border-radius:10px;padding:12px;outline:none;}
    .textarea{min-height:120px;resize:vertical;}
    .muted{ color:var(--muted,#67706B); }

    .actions{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .btn{display:inline-flex;align-items:center;justify-content:center;min-width:148px;padding:12px 16px;border-radius:12px;
      border:1px solid var(--border);background:var(--card-surface,var(--surface));font-weight:800;color:var(--text);cursor:pointer;}
    .btn-quiet{min-width:auto;padding:8px 12px}
    .btn-primary{border-color:transparent;background:#2F6C3C;color:#fff;}
    .btn[disabled]{opacity:.6;cursor:not-allowed}

    .thumbs{display:flex;gap:8px;flex-wrap:wrap}
    .thumbs img{width:84px;height:84px;object-fit:cover;border-radius:10px;border:1px solid var(--border);background:var(--surface)}

    /* Toast */
    .toast{position:fixed;left:50%;bottom:calc(env(safe-area-inset-bottom,0px) + 72px);transform:translateX(-50%);
      background:#2F6C3C;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.25);z-index:99999;display:none;
      white-space:nowrap;text-align:center;max-width:92vw;overflow:hidden;text-overflow:ellipsis;}
    .toast.show{display:block;animation:fadeout 4s forwards;}
    @keyframes fadeout{0%{opacity:1}85%{opacity:1}100%{opacity:0}}

    .error{border:1px solid #b3261e;background:#fff;color:#b3261e;border-radius:10px;padding:10px 12px;display:none}
    .error.show{display:block}
  </style>

  <!-- Ensure fv-shell -->
  <script>(function(){
    if(!customElements.get('fv-shell')){
      const s=document.createElement('script');s.src='/Farm-vista/js/fv-shell.js';s.defer=true;document.head.appendChild(s);
    }
  })();</script>
</head>
<body>
  <fv-shell>
    <div class="page container">
      <h1 class="page-title">Report a Bug / Issue</h1>
      <p class="page-sub">Tell us what broke and where it happened so we can fix it fast.</p>

      <section class="section">
        <header class="section-head">
          <div class="icon" aria-hidden="true">ü™≤</div>
          <div><strong>New Bug / Issue</strong></div>
        </header>

        <div class="section-body">
          <div id="err" class="error"></div>

          <div class="row">
            <div class="field">
              <label for="submittedBy">Submitted by *</label>
              <input id="submittedBy" class="input" readonly aria-readonly="true" required />
              <p class="muted" style="margin:6px 2px 0">Auto-filled from your login.</p>
            </div>
            <div class="field">
              <label for="date">Date *</label>
              <input id="date" class="input" type="date" required />
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="mainMenu">Main menu *</label>
              <select id="mainMenu" class="select" required>
                <option value="" selected>‚Äî Select ‚Äî</option>
              </select>
              <p class="muted" style="margin:6px 2px 0">Loaded from <em>js/menu.js</em>. Includes ‚ÄúOther‚Äù.</p>
            </div>
            <div class="field">
              <label for="subMenu">Submenu *</label>
              <select id="subMenu" class="select" required disabled>
                <option value="" selected>‚Äî Select a main menu first ‚Äî</option>
              </select>
            </div>
          </div>

          <div class="row-1">
            <div class="field">
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <label for="notes">Issue (notes) *</label>
                <button id="dictate" type="button" class="btn btn-quiet" title="Dictate (when supported)">üéôÔ∏è Dictate</button>
              </div>
              <textarea id="notes" class="textarea" placeholder="What happened? Steps to reproduce? What did you expect?" required></textarea>
              <p class="muted" style="margin:6px 2px 0">You can also use the keyboard mic on iOS.</p>
            </div>
          </div>

          <div class="row-1">
            <div class="field">
              <label for="shots">Screenshot(s)</label>
              <input id="shots" class="input" type="file" accept="image/*" multiple />
              <div id="previews" class="thumbs" aria-live="polite"></div>
            </div>
          </div>

          <div class="actions">
            <button id="cancel" class="btn" type="button" onclick="location.href='/Farm-vista/pages/feedback/index.html'">Cancel</button>
            <button id="save" class="btn btn-primary" type="button">Submit Bug</button>
          </div>
        </div>
      </section>
    </div>
  </fv-shell>

  <div id="toast" class="toast" role="status" aria-live="polite">Saved.</div>

  <script type="module">
    import {
      ready,
      getFirestore, collection, addDoc, serverTimestamp, updateDoc, doc,
      getStorage, ref, uploadBytes, getDownloadURL
    } from '/Farm-vista/js/firebase-init.js';

    (function(){
      "use strict";
      const $ = s => document.querySelector(s);
      const el = {
        err:   $('#err'),
        toast: $('#toast'),
        save:  $('#save'),
        date:  $('#date'),
        by:    $('#submittedBy'),
        main:  $('#mainMenu'),
        sub:   $('#subMenu'),
        notes: $('#notes'),
        shots: $('#shots'),
        prev:  $('#previews'),
        mic:   $('#dictate')
      };

      let db, storage;

      /* ============ UI helpers ============ */
      function showToast(msg="Saved.", ms=4000){
        el.toast.textContent = msg;
        el.toast.classList.remove('show'); void el.toast.offsetWidth;
        el.toast.classList.add('show');
        setTimeout(()=> el.toast.classList.remove('show'), ms);
      }
      const showErr = (m)=>{ el.err.textContent=m||""; el.err.classList.toggle('show',!!m); };
      const todayISO = ()=> {
        const d = new Date(); return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);
      };

      /* ============ Menu helpers ============ */
      async function getNavMenu(){
        try{
          const mod = await import('/Farm-vista/js/menu.js');
          if (mod?.NAV_MENU?.items) return mod.NAV_MENU;
          if (mod?.default?.items)  return mod.default;
        }catch{}
        if (window.NAV_MENU?.items) return window.NAV_MENU;
        if (window.FV_MENU?.items)  return window.FV_MENU;
        return { items: [] };
      }
      function toMainList(NAV_MENU){
        const items = Array.isArray(NAV_MENU.items) ? NAV_MENU.items : [];
        const mains=[];
        for(const it of items){
          if(it.type==='group'){
            const kids=(Array.isArray(it.children)?it.children:[])
              .filter(c=>c && (c.type==='link' || c.type==='group'))
              .map(c=>({id: c.id||c.label||c.href||'', label: c.label||c.id||'Item'}));
            mains.push({ id: it.id||it.label||it.href||'', label: it.label||it.id||'Group', children: kids });
          }else if(it.type==='link'){
            mains.push({ id: it.id||it.label||it.href||'', label: it.label||it.id||'Link', children: [] });
          }
        }
        return mains;
      }
      function buildMainAndHookSubs(mains){
        el.main.innerHTML = '<option value="">‚Äî Select ‚Äî</option>';
        mains.forEach(m=>{
          const o=document.createElement('option');
          o.value=String(m.id); o.textContent=String(m.label);
          o.dataset.children='[]';
          if (Array.isArray(m.children) && m.children.length){
            o.dataset.children = JSON.stringify(m.children);
          }
          el.main.appendChild(o);
        });
        const other=document.createElement('option'); other.value='other'; other.textContent='Other'; other.dataset.children='[]';
        el.main.appendChild(other);

        el.sub.innerHTML='<option value="">‚Äî Select a main menu first ‚Äî</option>';
        el.sub.disabled=true;

        el.main.addEventListener('change', ()=>{
          const opt=el.main.options[el.main.selectedIndex]; let kids=[]; try{ kids=JSON.parse(opt?.dataset?.children||'[]'); }catch{}
          el.sub.innerHTML='';
          kids.forEach(c=>{
            const s=document.createElement('option'); s.value=String(c.id||c.label||''); s.textContent=String(c.label||c.id||'Item');
            el.sub.appendChild(s);
          });
          const sOther=document.createElement('option'); sOther.value='other'; sOther.textContent='Other'; el.sub.appendChild(sOther);
          el.sub.disabled=false;
        });
      }

      /* ============ User prefill (mirrors shell behavior) ============ */
      function titleCase(s){ return String(s||'').replace(/\s+/g,' ').trim().split(' ').filter(Boolean).map(w=>w[0]?.toUpperCase()+w.slice(1).toLowerCase()).join(' '); }
      function nameFromEmail(email){
        const local = String(email||'').split('@')[0]||'';
        if(!local) return '';
        if(/[._-]/.test(local)){
          return titleCase(local.replace(/[0-9]+/g,' ').split(/[._-]+/).join(' '));
        }
        const spaced = local.replace(/([a-z])([A-Z])/g,'$1 $2');
        return titleCase(spaced || local);
      }
      let tries = 30;
      function setSubmittedByNow(){
        let label='';
        try{
          const ctx = window.FVUserContext && window.FVUserContext.get && window.FVUserContext.get();
          if (ctx && (ctx.displayName || ctx.email)) label = ctx.displayName || ctx.email || '';
          if (ctx && !el.by.dataset.uid && ctx.uid) el.by.dataset.uid = ctx.uid;
          if (ctx && !el.by.dataset.email && ctx.email) el.by.dataset.email = ctx.email;
        }catch{}
        if (!label){
          try{
            const u = window.firebaseAuth && window.firebaseAuth.currentUser;
            if (u){
              label = u.displayName || u.email || '';
              if (!el.by.dataset.uid) el.by.dataset.uid = u.uid || '';
              if (!el.by.dataset.email) el.by.dataset.email = u.email || '';
            }
          }catch{}
        }
        if (label && label.includes('@')) label = nameFromEmail(label);
        label = titleCase(label || '');
        if (label) el.by.value = label;
        return !!label;
      }
      function subscribeUserChanges(){
        const ok = setSubmittedByNow();
        try{
          if (window.FVUserContext && typeof window.FVUserContext.onChange === 'function'){
            window.FVUserContext.onChange(()=> setSubmittedByNow());
          }
        }catch{}
        const tick = setInterval(()=>{
          if (setSubmittedByNow() || --tries <= 0) clearInterval(tick);
        }, 200);
        if (ok) { /* no-op */ }
      }

      /* ============ Previews ============ */
      function previewFiles(files){
        el.prev.innerHTML='';
        Array.from(files||[]).forEach(f=>{
          if (!f.type.startsWith('image/')) return;
          const fr=new FileReader();
          fr.onload=e=>{
            const img=new Image(); img.src=e.target.result; img.alt=f.name||'screenshot';
            el.prev.appendChild(img);
          };
          fr.readAsDataURL(f);
        });
      }

      /* ============ Uploads ============ */
      async function uploadShots(docId, files){
        const out=[]; if(!files||!files.length) return out;
        const base=`feedback/bugs/${docId}/screenshots`;
        for(let i=0;i<files.length;i++){
          const f = files[i];
          const safe = (Date.now() + '-' + i + '-' + (f.name||'shot')).replace(/[^\w.\-]+/g,'_');
          const r = ref(storage, `${base}/${safe}`);
          await uploadBytes(r, f, { contentType: f.type || 'image/jpeg' });
          const url = await getDownloadURL(r);
          out.push({ name: f.name||safe, url, path:`${base}/${safe}`, contentType:f.type||'image/jpeg', size:f.size||0 });
        }
        return out;
      }

      /* ============ Save ============ */
      async function save(){
        try{
          showErr('');
          if(!el.by.value.trim()) { showErr('Missing user. Please re-login.'); return; }
          if(!el.date.value)      { showErr('Please choose a date.'); return; }
          if(!el.main.value)      { showErr('Please choose a main menu.'); return; }
          if(el.sub.disabled || !el.sub.value){ showErr('Please choose a submenu.'); return; }
          if(!el.notes.value.trim()){ showErr('Please describe the issue.'); return; }

          const payload = {
            type:'bug',
            submittedBy:{ uid: el.by.dataset.uid||null, name: el.by.value, email: el.by.dataset.email||null },
            date: el.date.value,
            mainMenu:{ id: el.main.value, label: el.main.options[el.main.selectedIndex]?.textContent||el.main.value },
            subMenu:{  id: el.sub.value,  label: el.sub.options[el.sub.selectedIndex]?.textContent ||el.sub.value  },
            notes: el.notes.value.trim(),
            createdAt: serverTimestamp(),
            appVersion: (window.FV_VERSION||null)
          };

          const docRef = await addDoc(collection(db,'feedback'), payload);
          const shots  = await uploadShots(docRef.id, el.shots.files);
          if(shots.length){
            await updateDoc(doc(db,'feedback',docRef.id), { screenshots: shots });
          }

          // Reset UI
          el.notes.value=''; el.shots.value=''; el.prev.innerHTML='';

          // Toast + auto-redirect after 3s (match Ideas page behavior)
          showToast('Thanks ‚Äî bug submitted.');
          setTimeout(()=>{ location.href='/Farm-vista/pages/feedback/index.html'; }, 3000);

          window.scrollTo({top:0,behavior:'smooth'});
        }catch(e){
          console.error(e);
          showErr('Save failed. Check permissions or network.');
        }
      }

      /* ============ Dictation ============ */
      function speechSetup(){
        const ok=('webkitSpeechRecognition' in window)||('SpeechRecognition' in window);
        if(!ok){ el.mic.style.display='none'; return; }
        const Rec=window.SpeechRecognition||window.webkitSpeechRecognition;
        const rec=new Rec(); rec.lang='en-US'; rec.interimResults=true; rec.continuous=false;
        let base=''; el.mic.addEventListener('click', ()=>{
          base = el.notes.value ? (el.notes.value+' ') : '';
          el.mic.disabled=true; el.mic.textContent='üéôÔ∏è Listening‚Ä¶';
          try{ rec.start(); }catch{}
        });
        rec.onresult=ev=>{
          let txt=''; for(let i=ev.resultIndex;i<ev.results.length;i++){ txt+=ev.results[i][0].transcript; }
          el.notes.value=base+txt;
        };
        rec.onend=()=>{ el.mic.disabled=false; el.mic.textContent='üéôÔ∏è Dictate'; };
        rec.onerror=()=>{ el.mic.disabled=false; el.mic.textContent='üéôÔ∏è Dictate'; };
      }

      /* ============ Init ============ */
      (async ()=>{
        await ready; db=getFirestore(); storage=getStorage();

        subscribeUserChanges();
        el.date.value = todayISO();

        const NAV = await getNavMenu();
        buildMainAndHookSubs(toMainList(NAV));

        el.shots.addEventListener('change', ()=> previewFiles(el.shots.files));
        el.save.addEventListener('click', save);
        speechSetup();
      })();
    })();
  </script>
</body>
</html>