<!doctype html><html lang="en"><head>
  <meta charset="utf-8"/>
  <title>FarmVista ‚Ä¢ Feedback ‚Üí Bugs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- Standard includes -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <!-- Menus data -->
  <script src="/Farm-vista/assets/data/menus.js"></script>

  <style>
    .page{max-width:1100px;margin:0 auto;padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + 96px)!important;}
    .page-title{margin:0 0 8px 0;}
    .page-sub{margin:0 0 14px 0;color:var(--muted,#67706B);}

    .section{border:1px solid var(--border);border-radius:14px;background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));overflow:hidden;}
    .section-head{display:grid;grid-template-columns:36px 1fr;gap:12px;align-items:center;
      padding:14px 16px;border-bottom:1px solid var(--border);
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);}
    .section-head .icon{width:24px;height:24px;color:#2F6C3C;display:grid;place-items:center;}
    .section-body{padding:16px;display:grid;gap:14px;}

    .row{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    .row-1{display:grid;gap:10px;grid-template-columns:1fr}
    @media(max-width:980px){.row{grid-template-columns:1fr 1fr}}
    @media(max-width:720px){.row{grid-template-columns:1fr}}

    .field label{display:block;font-weight:800;margin:0 0 6px 0;}
    .input, .select, .textarea{
      width:100%;font:inherit;font-size:16px;color:var(--text);
      background:var(--card-surface,var(--surface));border:1px solid var(--border);
      border-radius:10px;padding:12px;outline:none;}
    .textarea{min-height:120px;resize:vertical;}
    .muted{ color:var(--muted,#67706B); }

    .actions{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .btn{display:inline-flex;align-items:center;justify-content:center;min-width:148px;padding:12px 16px;border-radius:12px;
      border:1px solid var(--border);background:var(--card-surface,var(--surface));font-weight:800;color:var(--text);cursor:pointer;}
    .btn-quiet{min-width:auto;padding:8px 12px}
    .btn-primary{border-color:transparent;background:#2F6C3C;color:#fff;}
    .btn[disabled]{opacity:.6;cursor:not-allowed}

    .thumbs{display:flex;gap:8px;flex-wrap:wrap}
    .thumbs img{width:84px;height:84px;object-fit:cover;border-radius:10px;border:1px solid var(--border);background:var(--surface)}

    .toast{position:fixed;left:50%;bottom:calc(env(safe-area-inset-bottom,0px) + 72px);transform:translateX(-50%);
      background:#2F6C3C;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.25);z-index:99999;display:none;}
    .toast.show{display:block;animation:fadeout 4s forwards;}
    @keyframes fadeout{0%{opacity:1}85%{opacity:1}100%{opacity:0}}
    .error{border:1px solid #b3261e;background:#fff;color:#b3261e;border-radius:10px;padding:10px 12px;display:none}
    .error.show{display:block}
  </style>

  <script>(function(){
    if(!customElements.get('fv-shell')){
      const s=document.createElement('script');s.src='/Farm-vista/js/fv-shell.js';s.defer=true;document.head.appendChild(s);
    }
  })();</script>
</head><body>
  <fv-shell>
    <div class="page container">
      <h1 class="page-title">Report a Bug / Issue</h1>
      <p class="page-sub">Tell us what broke and where it happened so we can fix it fast.</p>

      <section class="section">
        <header class="section-head">
          <div class="icon" aria-hidden="true">ü™≤</div>
          <div><strong>New Bug / Issue</strong></div>
        </header>

        <div class="section-body">
          <div id="err" class="error"></div>

          <div class="row">
            <div class="field">
              <label for="submittedBy">Submitted by *</label>
              <input id="submittedBy" class="input" readonly aria-readonly="true" />
              <p class="muted" style="margin:6px 2px 0">Auto-filled from your login.</p>
            </div>
            <div class="field">
              <label for="date">Date *</label>
              <input id="date" class="input" type="date" required />
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="mainMenu">Main menu *</label>
              <select id="mainMenu" class="select" required></select>
              <p class="muted" style="margin:6px 2px 0">Loaded from <em>assets/data/menus.js</em>. Includes ‚ÄúOther‚Äù.</p>
            </div>
            <div class="field">
              <label for="subMenu">Submenu *</label>
              <select id="subMenu" class="select" required></select>
            </div>
          </div>

          <div class="row-1">
            <div class="field">
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <label for="notes">Issue (notes) *</label>
                <button id="dictate" type="button" class="btn btn-quiet" title="Dictate (when supported)">üéôÔ∏è Dictate</button>
              </div>
              <textarea id="notes" class="textarea" placeholder="What happened? Steps to reproduce? What did you expect?" required></textarea>
              <p class="muted" style="margin:6px 2px 0">You can also use the keyboard mic on iOS.</p>
            </div>
          </div>

          <div class="row-1">
            <div class="field">
              <label for="shots">Screenshot(s)</label>
              <input id="shots" class="input" type="file" accept="image/*" multiple />
              <div id="previews" class="thumbs" aria-live="polite"></div>
            </div>
          </div>

          <div class="actions">
            <button id="cancel" class="btn" type="button" onclick="location.href='/Farm-vista/feedback/index.html'">Cancel</button>
            <button id="save" class="btn btn-primary" type="button">Submit Bug</button>
          </div>
        </div>
      </section>
    </div>
  </fv-shell>

  <div id="toast" class="toast" role="status" aria-live="polite">Saved.</div>

  <script type="module">
  import {
    ready,
    getFirestore, collection, addDoc, serverTimestamp,
    getStorage, ref, uploadBytes, getDownloadURL
  } from '/Farm-vista/js/firebase-init.js';

  (function(){
    "use strict";
    const $ = sel => document.querySelector(sel);

    const el = {
      err:   $('#err'),
      toast: $('#toast'),
      save:  $('#save'),
      date:  $('#date'),
      by:    $('#submittedBy'),
      main:  $('#mainMenu'),
      sub:   $('#subMenu'),
      notes: $('#notes'),
      shots: $('#shots'),
      prev:  $('#previews'),
      mic:   $('#dictate')
    };

    let db, storage;

    function showToast(msg="Saved.", ms=4000){
      el.toast.textContent = msg;
      el.toast.classList.remove('show'); void el.toast.offsetWidth;
      el.toast.classList.add('show');
      setTimeout(()=> el.toast.classList.remove('show'), ms);
    }
    function showErr(msg){ el.err.textContent = msg||""; el.err.classList.toggle('show', !!msg); }
    function todayISO(){
      const d = new Date(); const off = d.getTimezoneOffset();
      return new Date(d.getTime()-off*60000).toISOString().slice(0,10);
    }

    function getMenuSource(){ return window.FV_MENU || window.FVMenu || window.MENU || window.menu || null; }
    function buildMenus(){
      const src = getMenuSource();
      el.main.innerHTML=''; el.sub.innerHTML='';
      let mains=[];
      if (Array.isArray(src)){
        mains = src.map(x=>({id:String(x.id||x.label),label:String(x.label||x.title||x.id||'Untitled'),children:Array.isArray(x.children||x.items)?(x.children||x.items):[]}));
      }else if (src && typeof src==='object'){
        mains = Object.keys(src).map(k=>({id:k,label:src[k].label||k,children:src[k].children||src[k].items||[]}));
      }
      for(const m of mains){
        const o=document.createElement('option');
        o.value=m.id; o.textContent=m.label;
        o.dataset.children = JSON.stringify(m.children||[]);
        el.main.appendChild(o);
      }
      const other=document.createElement('option'); other.value='other'; other.textContent='Other'; other.dataset.children='[]';
      el.main.appendChild(other);

      function fillSub(fromMain){
        el.sub.innerHTML='';
        let kids=[]; if(fromMain?.dataset?.children){ try{ kids=JSON.parse(fromMain.dataset.children)||[]; }catch{} }
        for(const c of kids){
          const o=document.createElement('option');
          o.value=String(c.id||c.label||c.title||''); o.textContent=String(c.label||c.title||c.id||'Item');
          el.sub.appendChild(o);
        }
        const oOther=document.createElement('option'); oOther.value='other'; oOther.textContent='Other';
        el.sub.appendChild(oOther);
      }
      fillSub(el.main.options[0] || other);
      el.main.addEventListener('change', ()=> fillSub(el.main.options[el.main.selectedIndex]));
    }

    function setUserAndDate(){
      const ctx = window.FVUserContext || {};
      let name = ctx.displayName || ctx.name || '';
      let email = ctx.email || '';
      let uid = ctx.uid || '';
      try{
        if ((!name || !email || !uid) && window.firebase && firebase.auth){
          const u = firebase.auth().currentUser;
          if (u){ name ||= u.displayName || ''; email ||= u.email || ''; uid ||= u.uid || ''; }
        }
      }catch{}
      el.by.value = (name || email || uid || 'Unknown User');
      el.by.dataset.uid = uid || '';
      el.by.dataset.email = email || '';
      el.date.value = todayISO();
    }

    function previewFiles(files){
      el.prev.innerHTML='';
      Array.from(files||[]).forEach(file=>{
        const fr=new FileReader();
        fr.onload = ev=>{ const img=new Image(); img.src=ev.target.result; img.alt='screenshot'; el.prev.appendChild(img); };
        fr.readAsDataURL(file);
      });
    }

    function speechSetup(){
      const Support = ('webkitSpeechRecognition' in window) || ('SpeechRecognition' in window);
      if(!Support){ el.mic.style.display='none'; return; }
      const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
      const rec = new Rec(); rec.lang='en-US'; rec.interimResults=true; rec.continuous=false;
      let base='';
      el.mic.addEventListener('click', ()=>{
        base = el.notes.value ? (el.notes.value + ' ') : '';
        el.mic.disabled=true; el.mic.textContent='üéôÔ∏è Listening‚Ä¶';
        rec.start();
      });
      rec.onresult = evt=>{
        let txt=''; for(let i=evt.resultIndex;i<evt.results.length;i++){ txt += evt.results[i][0].transcript; }
        el.notes.value = base + txt;
      };
      rec.onend = ()=>{ el.mic.disabled=false; el.mic.textContent='üéôÔ∏è Dictate'; };
      rec.onerror = ()=>{ el.mic.disabled=false; el.mic.textContent='üéôÔ∏è Dictate'; };
    }

    async function uploadShots(docId, files){
      const urls=[];
      if(!files || !files.length) return urls;
      const folder = `feedback/bugs/${docId}/screenshots`;
      for(const f of files){
        const safe = Date.now() + '-' + (f.name||'shot.jpg').replace(/[^\w.\-]+/g,'_');
        const r = ref(storage, `${folder}/${safe}`);
        await uploadBytes(r, f, { contentType: f.type || 'image/jpeg' });
        urls.push({ name: safe, url: await getDownloadURL(r), path: `${folder}/${safe}` });
      }
      return urls;
    }

    async function handleSave(){
      try{
        showErr('');
        if(!el.notes.value.trim()){ showErr('Please describe the issue.'); return; }
        const uid = el.by.dataset.uid || null;
        const email = el.by.dataset.email || null;

        const base = {
          type: 'bug',
          submittedBy: { uid, name: el.by.value || 'Unknown User', email },
          date: el.date.value,
          mainMenu: { id: el.main.value, label: el.main.options[el.main.selectedIndex]?.textContent || el.main.value },
          subMenu:  { id: el.sub.value,  label: el.sub.options[el.sub.selectedIndex]?.textContent  || el.sub.value  },
          notes: el.notes.value.trim(),
          createdAt: serverTimestamp(),
          appVersion: (window.FV_VERSION || null)
        };

        const docRef = await addDoc(collection(db,'feedback'), base);
        const shots = await uploadShots(docRef.id, el.shots.files);
        if (shots.length){
          try{ await firebase.firestore().collection('feedback').doc(docRef.id).set({screenshots:shots},{merge:true}); }catch{}
        }

        el.notes.value=''; el.shots.value=''; el.prev.innerHTML='';
        setUserAndDate(); buildMenus();
        showToast('Thanks ‚Äî bug submitted.');
      }catch(e){
        console.error(e); showErr('Save failed. Check permissions or network.');
      }
    }

    (async ()=>{
      await ready; db = getFirestore(); storage = getStorage();
      setUserAndDate(); buildMenus(); speechSetup();
      el.shots.addEventListener('change', ()=> previewFiles(el.shots.files));
      el.save.addEventListener('click', handleSave);
    })();
  })();
  </script>
</body></html>