<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista • Feedback → Bugs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <script src="/Farm-vista/js/theme-boot.js"></script>

  <!-- Standard includes -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <style>
    .page{
      max-width:1100px;
      margin:0 auto;
      padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + 96px)!important;
    }
    .page-title{margin:0 0 8px 0;}
    .page-sub{margin:0 0 14px 0;color:var(--muted,#67706B);}
    .section{
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));
      /* overflow removed so dropdowns can extend outside */
    }
    .section-head{
      display:grid;
      grid-template-columns:36px 1fr;
      gap:12px;
      align-items:center;
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);
    }
    .section-head .icon{
      width:24px;
      height:24px;
      color:#2F6C3C;
      display:grid;
      place-items:center;
    }
    .section-head .icon svg{
      width:20px;
      height:20px;
      display:block;
      fill:currentColor;
    }
    .section-body{
      padding:16px;
      display:grid;
      gap:14px;
    }

    .row{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    .row-1{display:grid;gap:10px;grid-template-columns:1fr}
    @media(max-width:980px){.row{grid-template-columns:1fr 1fr}}
    @media(max-width:720px){.row,.row-1{grid-template-columns:1fr}}

    .field label{
      display:block;
      font-weight:800;
      margin:0 0 6px 0;
    }
    .input,.select,.textarea{
      width:100%;
      font:inherit;
      font-size:16px;
      color:var(--text);
      background:var(--card-surface,var(--surface));
      border:1px solid var(--border);
      border-radius:10px;
      padding:12px;
      outline:none;
    }
    .textarea{
      min-height:120px;
      resize:vertical;
      padding-right:52px;
    }

    .actions{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center
    }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:148px;
      padding:12px 16px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--card-surface,var(--surface));
      font-weight:800;
      color:#141514;
      cursor:pointer;
    }
    .btn-primary{
      border-color:transparent;
      background:#2F6C3C;
      color:#fff;
    }
    .btn[disabled]{opacity:.6;cursor:not-allowed}

    .thumbs{
      display:flex;
      gap:8px;
      flex-wrap:wrap
    }
    .thumbs img{
      width:84px;
      height:84px;
      object-fit:cover;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--surface)
    }

    /* Mic-in-textarea */
    .ta-wrap{position:relative}
    .mic-btn{
      position:absolute;
      right:10px;
      bottom:10px;
      width:36px;
      height:36px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--surface);
      display:grid;
      place-items:center;
      cursor:pointer
    }
    .mic-btn[disabled]{opacity:.6;cursor:not-allowed}
    .mic-svg{width:18px;height:18px;display:block}
    .mic-active{
      background:#2F6C3C;
      color:#fff;
      border-color:#2F6C3C
    }

    /* Toast */
    .toast{
      position:fixed;
      left:50%;
      bottom:calc(env(safe-area-inset-bottom,0px) + 72px);
      transform:translateX(-50%);
      background:#2F6C3C;
      color:#fff;
      padding:10px 14px;
      border-radius:10px;
      box-shadow:0 6px 20px rgba(0,0,0,.25);
      z-index:99999;
      display:none;
      white-space:nowrap;
      text-align:center;
      max-width:92vw;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .toast.show{display:block;animation:fadeout 4s forwards;}
    @keyframes fadeout{0%{opacity:1}85%{opacity:1}100%{opacity:0}}

    .error{
      border:1px solid #b3261e;
      background:#fff;
      color:#b3261e;
      border-radius:10px;
      padding:10px 12px;
      display:none
    }
    .error.show{display:block}
  </style>

  <!-- Ensure fv-shell -->
  <script>(function(){
    if(!customElements.get('fv-shell')){
      const s=document.createElement('script');
      s.src='/Farm-vista/js/fv-shell.js';
      s.defer=true;
      document.head.appendChild(s);
    }
  })();</script>
</head>
<body>
  <fv-shell>
    <div class="page container">
      <h1 class="page-title">Report a Bug / Issue</h1>
      <p class="page-sub">Tell us what broke and where it happened so we can fix it fast.</p>

      <section class="section">
        <header class="section-head">
          <div class="icon" aria-hidden="true">
            <!-- SVG bug icon (uses currentColor, so it matches the green) -->
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M7.5 9a4.5 4.5 0 0 1 9 0v1.5h.75a2.75 2.75 0 0 1 2.75 2.75v.25a.75.75 0 0 1-1.5 0v-.25c0-.69-.56-1.25-1.25-1.25H16.5V15a4.5 4.5 0 0 1-3.75 4.44V21a.75.75 0 0 1-1.5 0v-1.56A4.5 4.5 0 0 1 7.5 15v-2.25H5.75c-.69 0-1.25.56-1.25 1.25v.25a.75.75 0 0 1-1.5 0v-.25A2.75 2.75 0 0 1 5.75 10.5H6.5V9Zm1.5 0v1.5h6V9a3 3 0 0 0-6 0Z"/>
            </svg>
          </div>
          <div><strong>New Bug / Issue</strong></div>
        </header>

        <div class="section-body">
          <div id="err" class="error"></div>

          <div class="row">
            <div class="field">
              <label for="submittedBy">Submitted by *</label>
              <input id="submittedBy" class="input" readonly aria-readonly="true" required />
            </div>
            <div class="field">
              <label for="date">Date *</label>
              <input id="date" class="input" type="date" required />
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="mainMenu">Main menu *</label>
              <select id="mainMenu" class="select" required>
                <option value="" selected>— Select —</option>
              </select>
            </div>
            <div class="field">
              <label for="subMenu">Submenu *</label>
              <select id="subMenu" class="select" required disabled>
                <option value="" selected>— Select a main menu first —</option>
              </select>
            </div>
          </div>

          <div class="row-1">
            <div class="field">
              <label for="notes">Issue (notes) *</label>
              <div class="ta-wrap">
                <textarea id="notes" class="textarea" placeholder="What happened? Steps to reproduce? What did you expect?" required></textarea>
                <button id="mic" type="button" class="mic-btn" aria-label="Start dictation">
                  <svg class="mic-svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                    <path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 1 0-6 0v5a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 6 6.92V21H9v2h6v-2h-2v-3.08A7 7 0 0 0 19 11h-2z"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>

          <div class="row-1">
            <div class="field">
              <label for="shots">Screenshot(s)</label>
              <input id="shots" class="input" type="file" accept="image/*" multiple />
              <div id="previews" class="thumbs" aria-live="polite"></div>
            </div>
          </div>

          <div class="actions">
            <button id="cancel" class="btn" type="button" onclick="location.href='/Farm-vista/pages/feedback/index.html'">Cancel</button>
            <button id="save" class="btn btn-primary" type="button">Submit Bug</button>
          </div>
        </div>
      </section>
    </div>
  </fv-shell>

  <div id="toast" class="toast" role="status" aria-live="polite">Saved.</div>

  <script type="module">
    import {
      ready,
      getFirestore, collection, addDoc, serverTimestamp, updateDoc, doc,
      getStorage, ref, uploadBytes, getDownloadURL
    } from '/Farm-vista/js/firebase-init.js';

    (function(){
      "use strict";
      const $ = s => document.querySelector(s);
      const el = {
        err:   $('#err'),
        toast: $('#toast'),
        save:  $('#save'),
        date:  $('#date'),
        by:    $('#submittedBy'),
        main:  $('#mainMenu'),
        sub:   $('#subMenu'),
        notes: $('#notes'),
        shots: $('#shots'),
        prev:  $('#previews'),
        mic:   $('#mic')
      };

      let db, storage;

      function showToast(msg="Saved.", ms=4000){
        el.toast.textContent = msg;
        el.toast.classList.remove('show'); void el.toast.offsetWidth;
        el.toast.classList.add('show');
        setTimeout(()=> el.toast.classList.remove('show'), ms);
      }
      const showErr = (m)=>{
        el.err.textContent = m || "";
        el.err.classList.toggle('show', !!m);
      };
      const todayISO = ()=>{
        const d = new Date();
        return new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,10);
      };

      async function getNavMenu(){
        try{
          const mod = await import('/Farm-vista/js/menu.js');
          if (mod?.NAV_MENU?.items) return mod.NAV_MENU;
          if (mod?.default?.items)  return mod.default;
        }catch{}
        if (window.NAV_MENU?.items) return window.NAV_MENU;
        if (window.FV_MENU?.items)  return window.FV_MENU;
        return { items: [] };
      }

      function toMainList(NAV_MENU){
        const items = Array.isArray(NAV_MENU.items) ? NAV_MENU.items : [];
        const mains = [];
        for(const it of items){
          if(it.type === 'group'){
            const kids = (Array.isArray(it.children) ? it.children : [])
              .filter(c => c && (c.type === 'link' || c.type === 'group'))
              .map(c => ({
                id: c.id || c.label || c.href || '',
                label: c.label || c.id || 'Item'
              }));
            mains.push({
              id: it.id || it.label || it.href || '',
              label: it.label || it.id || 'Group',
              children: kids
            });
          }else if(it.type === 'link'){
            mains.push({
              id: it.id || it.label || it.href || '',
              label: it.label || it.id || 'Link',
              children: []
            });
          }
        }
        return mains;
      }

      function buildMainAndHookSubs(mains){
        el.main.innerHTML = '<option value="">— Select —</option>';
        mains.forEach(m=>{
          const o = document.createElement('option');
          o.value = String(m.id);
          o.textContent = String(m.label);
          o.dataset.children = JSON.stringify(m.children || []);
          el.main.appendChild(o);
        });
        const other = document.createElement('option');
        other.value = 'other';
        other.textContent = 'Other';
        other.dataset.children = '[]';
        el.main.appendChild(other);

        el.sub.innerHTML = '<option value="">— Select a main menu first —</option>';
        el.sub.disabled = true;

        el.main.addEventListener('change', ()=>{
          const opt = el.main.options[el.main.selectedIndex];
          let kids = [];
          try{
            kids = JSON.parse(opt?.dataset?.children || '[]');
          }catch{}
          el.sub.innerHTML = '';
          kids.forEach(c=>{
            const s = document.createElement('option');
            s.value = String(c.id || c.label || '');
            s.textContent = String(c.label || c.id || 'Item');
            el.sub.appendChild(s);
          });
          const sOther = document.createElement('option');
          sOther.value = 'other';
          sOther.textContent = 'Other';
          el.sub.appendChild(sOther);
          el.sub.disabled = false;
        });
      }

      /* Previews */
      function previewFiles(files){
        el.prev.innerHTML = '';
        Array.from(files || []).forEach(f=>{
          if (!f.type.startsWith('image/')) return;
          const fr = new FileReader();
          fr.onload = e=>{
            const img = new Image();
            img.src = e.target.result;
            img.alt = f.name || 'screenshot';
            el.prev.appendChild(img);
          };
          fr.readAsDataURL(f);
        });
      }

      /* Mic dictation */
      function speechSetup(){
        const ok = ('webkitSpeechRecognition' in window) || ('SpeechRecognition' in window);
        if(!ok){
          el.mic.style.display = 'none';
          return;
        }
        const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
        const rec = new Rec();
        rec.lang = 'en-US';
        rec.interimResults = true;
        rec.continuous = false;

        let active = false, base = '';
        const setMic = (on)=>{
          el.mic.classList.toggle('mic-active', on);
          el.mic.setAttribute('aria-label', on ? 'Stop dictation' : 'Start dictation');
        };

        el.mic.addEventListener('click', ()=>{
          if (!active){
            base = el.notes.value ? (el.notes.value + ' ') : '';
            try{
              rec.start();
              active = true;
              setMic(true);
            }catch{}
          } else {
            try{
              rec.stop();
              rec.abort();
            }catch{}
            active = false;
            setMic(false);
          }
        });

        rec.onresult = ev=>{
          let txt = '';
          for(let i = ev.resultIndex; i < ev.results.length; i++){
            txt += ev.results[i][0].transcript;
          }
          el.notes.value = base + txt;
        };
        rec.onend   = ()=>{ active = false; setMic(false); };
        rec.onerror = ()=>{ active = false; setMic(false); };
      }

      async function uploadShots(docId, files){
        const out = [];
        if(!files || !files.length) return out;
        const base = `feedback/bugs/${docId}/screenshots`;
        for(let i=0;i<files.length;i++){
          const f = files[i];
          const safe = (Date.now() + '-' + i + '-' + (f.name || 'shot')).replace(/[^\w.\-]+/g,'_');
          const r = ref(storage, `${base}/${safe}`);
          await uploadBytes(r, f, { contentType: f.type || 'image/jpeg' });
          const url = await getDownloadURL(r);
          out.push({
            name: f.name || safe,
            url,
            path: `${base}/${safe}`,
            contentType: f.type || 'image/jpeg',
            size: f.size || 0
          });
        }
        return out;
      }

      async function save(){
        try{
          showErr('');
          if(!el.by.value.trim()){
            showErr('Missing user. Please re-login.');
            return;
          }
          if(!el.date.value){
            showErr('Please choose a date.');
            return;
          }
          if(!el.main.value){
            showErr('Please choose a main menu.');
            return;
          }
          if(el.sub.disabled || !el.sub.value){
            showErr('Please choose a submenu.');
            return;
          }
          if(!el.notes.value.trim()){
            showErr('Please describe the issue.');
            return;
          }

          const payload = {
            // plural "bugs" so it matches Ideas + reports + rules
            type: 'bugs',
            submittedBy: {
              uid:   el.by.dataset.uid   || null,
              name:  el.by.value,
              email: el.by.dataset.email || null
            },
            date: el.date.value,
            mainMenu: {
              id: el.main.value,
              label: el.main.options[el.main.selectedIndex]?.textContent || el.main.value
            },
            subMenu: {
              id: el.sub.value,
              label: el.sub.options[el.sub.selectedIndex]?.textContent || el.sub.value
            },
            notes: el.notes.value.trim(),
            createdAt: serverTimestamp(),
            appVersion: (window.FV_VERSION || null)
          };

          const docRef = await addDoc(collection(db,'feedback'), payload);

          // Upload screenshots, then attach to doc as "attachments"
          const shots = await uploadShots(docRef.id, el.shots.files);
          if (shots.length){
            await updateDoc(doc(db,'feedback', docRef.id), {
              attachments: shots,    // for reports + consistency with ideas
              screenshots: shots     // optional: keep for backward compatibility
            });
          }

          el.notes.value = '';
          el.shots.value = '';
          el.prev.innerHTML = '';

          showToast('Thanks — bug submitted.');
          setTimeout(()=>{ location.href='/Farm-vista/pages/feedback/index.html'; }, 3000);
          window.scrollTo({top:0,behavior:'smooth'});
        }catch(e){
          console.error(e);
          showErr('Save failed. Check permissions or network.');
        }
      }

      (async ()=>{
        await ready;
        db = getFirestore();
        storage = getStorage();

        // Prefill user (same behavior as shell-backed pages)
        (function subscribeUser(){
          let tries = 30;
          function titleCase(s){
            return String(s||'')
              .replace(/\s+/g,' ')
              .trim()
              .split(' ')
              .filter(Boolean)
              .map(w => (w[0]?.toUpperCase() || '') + w.slice(1).toLowerCase())
              .join(' ');
          }
          function nameFromEmail(email){
            const local = String(email||'').split('@')[0] || '';
            if(!local) return '';
            if(/[._-]/.test(local)){
              return titleCase(
                local.replace(/[0-9]+/g,' ')
                     .split(/[._-]+/)
                     .join(' ')
              );
            }
            const spaced = local.replace(/([a-z])([A-Z])/g,'$1 $2');
            return titleCase(spaced || local);
          }
          function setNow(){
            let label = '';
            try{
              const ctx = window.FVUserContext?.get?.();
              if (ctx){
                label = ctx.displayName || ctx.email || '';
                el.by.dataset.uid   ??= (ctx.uid   || '');
                el.by.dataset.email ??= (ctx.email || '');
              }
            }catch{}
            if(!label){
              try{
                const u = window.firebaseAuth?.currentUser;
                if (u){
                  label = u.displayName || u.email || '';
                  el.by.dataset.uid   ??= (u.uid   || '');
                  el.by.dataset.email ??= (u.email || '');
                }
              }catch{}
            }
            if(label && label.includes('@')){
              label = nameFromEmail(label);
            }
            label = titleCase(label || '');
            if(label) el.by.value = label;
            return !!label;
          }
          const ok = setNow();
          try{
            window.FVUserContext?.onChange?.(()=>setNow());
          }catch{}
          const t = setInterval(()=>{
            if(setNow() || --tries <= 0) clearInterval(t);
          },200);
          if(ok){ /* noop */ }
        })();

        el.date.value = todayISO();

        const NAV = await getNavMenu();
        buildMainAndHookSubs(toMainList(NAV));

        el.shots.addEventListener('change', ()=> previewFiles(el.shots.files));
        el.save.addEventListener('click', save);
        speechSetup();
      })();
    })();
  </script>
</body>
</html>
