<!doctype html><html lang="en"><head>
  <meta charset="utf-8"/>
  <title>FarmVista ‚Ä¢ Feedback ‚Üí Ideas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- Standard includes -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <style>
    .page{max-width:1100px;margin:0 auto;padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + 96px)!important;}
    .page-title{margin:0 0 8px 0;}
    .page-sub{margin:0 0 14px 0;color:var(--muted,#67706B);}

    .section{border:1px solid var(--border);border-radius:14px;background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));overflow:hidden;}
    .section-head{display:grid;grid-template-columns:36px 1fr;gap:12px;align-items:center;
      padding:14px 16px;border-bottom:1px solid var(--border);
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);}
    .section-head .icon{width:24px;height:24px;color:#2F6C3C;display:grid;place-items:center;}
    .section-body{padding:16px;display:grid;gap:14px;}

    .row{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    .row-1{display:grid;gap:10px;grid-template-columns:1fr}
    @media(max-width:980px){.row{grid-template-columns:1fr 1fr}}
    @media(max-width:720px){.row,.row-1{grid-template-columns:1fr}}

    .field label{display:block;font-weight:800;margin:0 0 6px 0;}
    .input,.select,.textarea{
      width:100%;font:inherit;font-size:16px;color:var(--text);
      background:var(--card-surface,var(--surface));border:1px solid var(--border);
      border-radius:10px;padding:12px;outline:none;}
    .input[readonly]{opacity:1}
    .textarea{min-height:120px;resize:vertical;}

    .actions{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .btn{display:inline-flex;align-items:center;justify-content:center;min-width:148px;padding:12px 16px;border-radius:12px;
      border:1px solid var(--border);background:var(--card-surface,var(--surface));font-weight:800;color:var(--text);cursor:pointer;}
    .btn-quiet{min-width:auto;padding:8px 12px}
    .btn-primary{border-color:transparent;background:#2F6C3C;color:#fff;}
    .btn[disabled]{opacity:.6;cursor:not-allowed}

    /* Toast: single line, centered, never wraps */
    .toast{position:fixed;left:50%;bottom:calc(env(safe-area-inset-bottom,0px) + 72px);transform:translateX(-50%);
      background:#2F6C3C;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.25);z-index:99999;display:none;
      white-space:nowrap; text-align:center; max-width:92vw; overflow:hidden; text-overflow:ellipsis;}
    .toast.show{display:block;animation:fadeout 4s forwards;}
    @keyframes fadeout{0%{opacity:1}85%{opacity:1}100%{opacity:0}}

    .error{border:1px solid #b3261e;background:#fff;color:#b3261e;border-radius:10px;padding:10px 12px;display:none}
    .error.show{display:block}

    /* Tiny thumbnails for chosen files (optional preview) */
    .thumbs{display:flex;gap:8px;flex-wrap:wrap}
    .thumb{width:72px;height:72px;border:1px solid var(--border);border-radius:10px;overflow:hidden;display:grid;place-items:center;background:var(--surface)}
    .thumb img{max-width:100%;max-height:100%;display:block}
    .muted-line{font-size:13px;color:var(--muted);margin-top:4px}
  </style>

  <!-- Ensure fv-shell -->
  <script>(function(){
    if(!customElements.get('fv-shell')){
      const s=document.createElement('script');s.src='/Farm-vista/js/fv-shell.js';s.defer=true;document.head.appendChild(s);
    }
  })();</script>
</head><body>
  <fv-shell>
    <div class="page container">
      <h1 class="page-title">Submit an Idea</h1>
      <p class="page-sub">Share improvements that would make FarmVista faster and clearer.</p>

      <section class="section">
        <header class="section-head">
          <div class="icon" aria-hidden="true">üí°</div>
          <div><strong>New Idea</strong></div>
        </header>

        <div class="section-body">
          <div id="err" class="error"></div>

          <div class="row">
            <div class="field">
              <label for="submittedBy">Submitted by *</label>
              <input id="submittedBy" class="input" readonly aria-readonly="true" required />
            </div>
            <div class="field">
              <label for="date">Date *</label>
              <input id="date" class="input" type="date" required />
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="mainMenu">Main menu *</label>
              <select id="mainMenu" class="select" required>
                <option value="" selected>‚Äî Select ‚Äî</option>
              </select>
            </div>
            <div class="field">
              <label for="subMenu">Submenu *</label>
              <select id="subMenu" class="select" required disabled>
                <option value="" selected>‚Äî Select a main menu first ‚Äî</option>
              </select>
            </div>
          </div>

          <div class="row-1">
            <div class="field">
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <label for="notes">Idea (notes) *</label>
                <button id="dictate" type="button" class="btn btn-quiet" title="Dictate (when supported)">üéôÔ∏è Dictate</button>
              </div>
              <textarea id="notes" class="textarea" placeholder="Describe the improvement you‚Äôd like to see‚Ä¶" required></textarea>
            </div>
          </div>

          <!-- OPTIONAL: Screenshots / files -->
          <div class="row-1">
            <div class="field">
              <label for="files">Screenshot(s) (optional)</label>
              <input id="files" class="input" type="file" accept="image/*" multiple />
              <div id="thumbs" class="thumbs" aria-hidden="true"></div>
              <div id="fileHint" class="muted-line" aria-hidden="true"></div>
            </div>
          </div>

          <div class="actions">
            <button class="btn" type="button" onclick="location.href='/Farm-vista/pages/feedback/index.html'">Cancel</button>
            <button id="save" class="btn btn-primary" type="button">Submit Idea</button>
          </div>
        </div>
      </section>
    </div>
  </fv-shell>

  <div id="toast" class="toast" role="status" aria-live="polite">Saved.</div>

  <script type="module">
  import {
    ready,
    getFirestore, collection, addDoc, serverTimestamp, updateDoc
  } from '/Farm-vista/js/firebase-init.js';

  (function(){
    "use strict";
    const $ = (s)=>document.querySelector(s);

    const el = {
      err:   $('#err'),
      toast: $('#toast'),
      save:  $('#save'),
      date:  $('#date'),
      by:    $('#submittedBy'),
      main:  $('#mainMenu'),
      sub:   $('#subMenu'),
      notes: $('#notes'),
      mic:   $('#dictate'),
      files: $('#files'),
      thumbs: $('#thumbs'),
      fileHint: $('#fileHint')
    };

    let db;

    /* ===== helpers ===== */
    function showToast(msg="Saved.", ms=4000){
      el.toast.textContent = msg;
      el.toast.classList.remove('show'); void el.toast.offsetWidth;
      el.toast.classList.add('show');
      setTimeout(()=> el.toast.classList.remove('show'), ms);
    }
    const showErr = (m)=>{ el.err.textContent=m||""; el.err.classList.toggle('show',!!m); };
    const todayISO = ()=>{
      const d=new Date(); return new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10);
    };

    const titleCase = (s)=>String(s||'').replace(/\s+/g,' ').trim().split(' ')
      .filter(Boolean).map(w=>w.charAt(0).toUpperCase()+w.slice(1).toLowerCase()).join(' ');
    const nameFromEmail = (email)=>{
      const local = String(email||'').split('@')[0]||'';
      if(!local) return '';
      if(/[._-]/.test(local)){
        return titleCase(local.replace(/[0-9]+/g,' ').split(/[._-]+/).join(' '));
      }
      const spaced = local.replace(/([a-z])([A-Z])/g,'$1 $2');
      return titleCase(spaced || local);
    };

    /* ===== Submitted-by (same pattern as shell) ===== */
    let _triesLeft = 30;   // ~6s polling
    function _setSubmittedByNow(){
      let label = '';
      try{
        const ctx = window.FVUserContext && window.FVUserContext.get && window.FVUserContext.get();
        if (ctx && (ctx.displayName || ctx.email)) label = ctx.displayName || ctx.email || '';
        if (ctx && !el.by.dataset.uid && ctx.uid) el.by.dataset.uid = ctx.uid;
        if (ctx && !el.by.dataset.email && ctx.email) el.by.dataset.email = ctx.email;
      }catch{}
      if (!label) {
        try{
          const u = window.firebaseAuth && window.firebaseAuth.currentUser;
          if (u){
            label = u.displayName || u.email || '';
            if (!el.by.dataset.uid) el.by.dataset.uid = u.uid || '';
            if (!el.by.dataset.email) el.by.dataset.email = u.email || '';
          }
        }catch{}
      }
      if (label && label.includes('@')) label = nameFromEmail(label);
      label = titleCase(label || '');
      if (label) el.by.value = label;
      return !!label;
    }
    function _subscribeUserChanges(){
      const okNow = _setSubmittedByNow();
      try {
        if (window.FVUserContext && typeof window.FVUserContext.onChange === 'function') {
          window.FVUserContext.onChange(() => _setSubmittedByNow());
        }
      } catch {}
      const tick = setInterval(()=>{
        if (_setSubmittedByNow() || --_triesLeft <= 0) clearInterval(tick);
      }, 200);
      if (okNow) { /* no-op */ }
    }

    /* ===== Menus (unchanged) ===== */
    async function getNavMenu(){
      try{
        const ver = (window.FV_VERSION && window.FV_VERSION.number) ? window.FV_VERSION.number : Date.now();
        const mod = await import(`/Farm-vista/js/menu.js?v=${ver}`);
        if (mod?.NAV_MENU?.items) return mod.NAV_MENU;
        if (mod?.default?.items)  return mod.default;
      }catch(e){ console.warn('menu.js import failed', e); }
      if (window.NAV_MENU?.items) return window.NAV_MENU;
      if (window.FV_MENU?.items)  return window.FV_MENU;
      return { items: [] };
    }
    function buildMainList(NAV_MENU){
      const items = Array.isArray(NAV_MENU.items) ? NAV_MENU.items : [];
      const out=[];
      for(const it of items){
        if(!it) continue;
        const entry = {
          id:    it.id || it.label || it.href || '',
          label: it.label || it.id || 'Item',
          kind:  it.type || 'link',
          children: []
        };
        const kids = Array.isArray(it.children) ? it.children : [];
        entry.children = kids.map(c=>({ id: c.id||c.label||c.href||'', label: c.label||c.id||'Item', type:c.type||'link', children: Array.isArray(c.children)?c.children:[] }));
        out.push(entry);
      }
      return out;
    }
    function wireMenus(mains){
      el.main.innerHTML = '<option value="">‚Äî Select ‚Äî</option>';
      for(const m of mains){
        const o=document.createElement('option');
        o.value = String(m.id);
        o.textContent = String(m.label);
        o.dataset.children = JSON.stringify(m.children||[]);
        el.main.appendChild(o);
      }
      const other=document.createElement('option');
      other.value='other'; other.textContent='Other'; other.dataset.children='[]';
      el.main.appendChild(other);

      el.sub.innerHTML = '<option value="">‚Äî Select a main menu first ‚Äî</option>';
      el.sub.disabled = true;

      el.main.addEventListener('change', ()=>{
        const opt = el.main.options[el.main.selectedIndex];
        let kids=[]; try{ kids = JSON.parse(opt?.dataset?.children||'[]'); }catch{}
        const flat=[];
        for(const c of kids){
          if(!c) continue;
          if(c.type==='group' && Array.isArray(c.children) && c.children.length){
            for(const gc of c.children){
              flat.push({ id: gc.id||gc.label||gc.href||'', label: gc.label||gc.id||'Item' });
            }
          }else{
            flat.push({ id: c.id||c.label||c.href||'', label: c.label||c.id||'Item' });
          }
        }
        el.sub.innerHTML = '';
        for(const s of flat){
          const op=document.createElement('option');
          op.value = String(s.id||s.label||'');
          op.textContent = String(s.label||s.id||'Item');
          el.sub.appendChild(op);
        }
        const sOther=document.createElement('option'); sOther.value='other'; sOther.textContent='Other';
        el.sub.appendChild(sOther);

        el.sub.disabled = false;
      });
    }

    /* ===== Optional file preview ===== */
    el.files?.addEventListener('change', ()=>{
      const files = Array.from(el.files.files||[]);
      el.thumbs.innerHTML = '';
      if (!files.length){ el.thumbs.setAttribute('aria-hidden','true'); el.fileHint.textContent=''; return; }
      files.forEach(f=>{
        const wrap = document.createElement('div'); wrap.className='thumb';
        if (f.type.startsWith('image/')){
          const img = document.createElement('img'); img.alt=f.name; wrap.appendChild(img);
          const reader = new FileReader();
          reader.onload = e=>{ img.src = e.target.result; };
          reader.readAsDataURL(f);
        } else {
          wrap.textContent = f.name.split('.').pop().toUpperCase();
        }
        el.thumbs.appendChild(wrap);
      });
      el.thumbs.removeAttribute('aria-hidden');
      el.fileHint.textContent = files.length + (files.length===1 ? ' file selected' : ' files selected');
    });

    /* ===== Lazy Storage loader (HTML-only fix) ===== */
    let _storageFns = null;
    async function loadStorageFns(){
      if (_storageFns) return _storageFns;
      // 1) Try your local firebase-init.js re-exports (cache-busted)
      try{
        const ver = (window.FV_VERSION && window.FV_VERSION.number) ? window.FV_VERSION.number : Date.now();
        const mod = await import(`/Farm-vista/js/firebase-init.js?v=${ver}`);
        const getStorage = mod?.getStorage;
        const ref = mod?.ref || mod?.storageRef;
        const uploadBytes = mod?.uploadBytes;
        const getDownloadURL = mod?.getDownloadURL;
        if (getStorage && ref && uploadBytes && getDownloadURL){
          _storageFns = { getStorage, ref, uploadBytes, getDownloadURL };
          return _storageFns;
        }
      }catch(e){ /* fall through */ }

      // 2) Fallback: official Firebase CDN ESM (no changes to your repo)
      const url = 'https://www.gstatic.com/firebasejs/10.13.1/firebase-storage.js';
      const mod2 = await import(url);
      _storageFns = {
        getStorage: mod2.getStorage,
        ref:        mod2.ref,
        uploadBytes:mod2.uploadBytes,
        getDownloadURL: mod2.getDownloadURL
      };
      return _storageFns;
    }

    async function uploadScreenshots(docId){
      const files = Array.from(el.files?.files || []);
      if (!files.length) return [];
      const { getStorage, ref, uploadBytes, getDownloadURL } = await loadStorageFns();
      const storage = getStorage(); // uses default initialized app from your firebase-init
      const out = [];
      for (let i=0; i<files.length; i++){
        const f = files[i];
        const safeName = (Date.now() + '-' + i + '-' + (f.name||'file')).replace(/[^a-zA-Z0-9._-]+/g,'_');
        const path = `feedback/${docId}/${safeName}`;
        const sref = ref(storage, path);
        await uploadBytes(sref, f, { contentType: f.type || 'application/octet-stream' });
        const url = await getDownloadURL(sref);
        out.push({ name: f.name||safeName, path, url, contentType: f.type||'', size: f.size||0 });
      }
      return out;
    }

    /* ===== Save (unchanged except lazy uploads) ===== */
    async function save(){
      try{
        showErr('');
        if(!el.by.value.trim()) { showErr('Missing user. Please re-login.'); return; }
        if(!el.date.value)      { showErr('Please choose a date.'); return; }
        if(!el.main.value)      { showErr('Please choose a main menu.'); return; }
        if(el.sub.disabled || !el.sub.value){ showErr('Please choose a submenu.'); return; }
        if(!el.notes.value.trim()){ showErr('Please enter your idea.'); return; }

        const payload = {
          type: 'idea',
          submittedBy: { uid: el.by.dataset.uid||null, name: el.by.value, email: el.by.dataset.email||null },
          date: el.date.value,
          mainMenu: { id: el.main.value, label: el.main.options[el.main.selectedIndex]?.textContent || el.main.value },
          subMenu:  { id: el.sub.value,  label: el.sub.options[el.sub.selectedIndex]?.textContent  || el.sub.value  },
          notes: el.notes.value.trim(),
          attachments: [],
          createdAt: serverTimestamp(),
          appVersion: (window.FV_VERSION || null)
        };

        const docRef = await addDoc(collection(db,'feedback'), payload);

        // Optional uploads (runs AFTER doc created; lazy-loads Storage without blocking init)
        const filesMeta = await uploadScreenshots(docRef.id);
        if (filesMeta.length){
          await updateDoc(docRef, { attachments: filesMeta });
        }

        // Reset only notes/files (keep date/menu/user)
        el.notes.value='';
        if (el.files){ el.files.value=''; el.thumbs.innerHTML=''; el.fileHint.textContent=''; el.thumbs.setAttribute('aria-hidden','true'); }

        showToast('Thanks ‚Äî idea submitted.');
        window.scrollTo({top:0,behavior:'smooth'});
      }catch(e){ console.error(e); showErr('Save failed. Check permissions or network.'); }
    }

    /* ===== Dictation (unchanged) ===== */
    function speechSetup(){
      const ok=('webkitSpeechRecognition' in window)||('SpeechRecognition' in window);
      if(!ok){ el.mic.style.display='none'; return; }
      const Rec=window.SpeechRecognition||window.webkitSpeechRecognition;
      const rec=new Rec(); rec.lang='en-US'; rec.interimResults=true; rec.continuous=false;
      let base=''; el.mic.addEventListener('click', ()=>{ base=el.notes.value?(el.notes.value+' '):''; el.mic.disabled=true; el.mic.textContent='üéôÔ∏è Listening‚Ä¶'; rec.start(); });
      rec.onresult=ev=>{ let txt=''; for(let i=ev.resultIndex;i<ev.results.length;i++){ txt+=ev.results[i][0].transcript; } el.notes.value=base+txt; };
      rec.onend=()=>{ el.mic.disabled=false; el.mic.textContent='üéôÔ∏è Dictate'; };
      rec.onerror=()=>{ el.mic.disabled=false; el.mic.textContent='üéôÔ∏è Dictate'; };
    }

    /* ===== Init ===== */
    (async ()=>{
      await ready; db=getFirestore();

      _subscribeUserChanges();
      el.date.value = todayISO();

      const NAV = await getNavMenu();
      wireMenus(buildMainList(NAV));

      el.save.addEventListener('click', save);
      speechSetup();
    })();
  })();
  </script>
</body></html>