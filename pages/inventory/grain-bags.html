<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista • Inventory → Add Grain Bags</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- Standard includes (ABSOLUTE paths) -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <!-- Firebase config FIRST, then FVData helpers -->
  <script src="/Farm-vista/js/firebase-config.js"></script>
  <script src="/Farm-vista/js/fv-data.js"></script>

  <!-- Ensure fv-shell custom element is available -->
  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true;
        document.head.appendChild(s);
      }
    })();
  </script>

  <style>
    /* Keep styling minimal so theme controls colors in light/dark */
    .page{max-width:960px;margin:0 auto;padding:clamp(14px,3vw,22px)}
    .card{border-radius:14px;box-shadow:var(--elev-2,0 1px 2px rgba(0,0,0,.06),0 8px 24px rgba(0,0,0,.06));padding:clamp(14px,2.5vw,20px);background:var(--surface,inherit)}
    form .grid{display:grid;gap:14px}
    @media(min-width:820px){form .grid{grid-template-columns:1fr 1fr}}
    .fld{display:flex;flex-direction:column;gap:6px}
    .fld label{font-weight:600}
    .row-span-2{grid-column:1 / -1}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .help{font-size:.95em;opacity:.8}
    select, input[type="number"], input[type="text"], textarea{
      appearance:none;border:1px solid var(--border,#CBCDCB);border-radius:12px;padding:12px 12px;font:inherit;line-height:1.2;background:var(--surface-2,#fff);color:inherit
    }
    textarea{min-height:96px;resize:vertical}
    .btn{border:0;border-radius:999px;padding:10px 16px;line-height:1.2;font-weight:600;cursor:pointer}
    .btn.primary{background:#3B7E46;color:#fff}
    .btn.secondary{background:var(--surface-3,#CBCDCB);color:inherit}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .toast{position:fixed;left:50%;bottom:22px;transform:translateX(-50%);padding:10px 14px;border-radius:999px;box-shadow:0 6px 24px rgba(0,0,0,.2);background:var(--surface-4,#141514);color:var(--on-surface-4,#fff);opacity:0;pointer-events:none;transition:opacity .25s}
    .toast.show{opacity:1}
  </style>
</head>
<body>
  <fv-shell>
    <div class="page container">
      <h1 class="page-title">Add Grain Bags to Inventory</h1>
      <p class="page-sub">Record <strong>bags on-hand in the shed</strong>. Choose the bag (brand • size) from your Products list, enter quantity, and save.</p>

      <section class="card" aria-label="Add bags form">
        <form id="bagForm" novalidate>
          <div class="grid">
            <div class="fld row-span-2">
              <label for="productId">Grain bag (brand • size)</label>
              <select id="productId" name="productId" required>
                <option value="">Loading options…</option>
              </select>
              <div class="help">Options come from <em>Products → Grain Bags</em> with <code>status="active"</code>.</div>
            </div>

            <div class="fld">
              <label for="qty">Quantity (bags)</label>
              <input id="qty" name="qty" type="number" inputmode="numeric" min="1" step="1" required placeholder="e.g., 10"/>
            </div>

            <div class="fld">
              <label for="location">Storage location (optional)</label>
              <input id="location" name="location" type="text" placeholder="e.g., North shed, bay 2"/>
            </div>

            <div class="fld row-span-2">
              <label for="note">Note (optional)</label>
              <textarea id="note" name="note" placeholder="Any extra details…"></textarea>
            </div>
          </div>

          <div class="actions">
            <button class="btn primary" id="submitBtn" type="submit" disabled>Save to Inventory</button>
            <button class="btn secondary" type="reset">Reset</button>
          </div>
        </form>
      </section>
    </div>
  </fv-shell>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script>
    (function(){
      const $ = (sel,root=document)=>root.querySelector(sel);

      const PRODUCTS_COL = 'productsGrainBags';
      const MOVEMENTS_COL = 'inventoryGrainBagMovements';

      let db, auth, FieldValue;
      let products = [];            // [{id, brand, diameterFt, lengthFt, status, ...}]
      const productMap = new Map(); // id -> product

      const form = $('#bagForm');
      const productSel = $('#productId');
      const qtyEl = $('#qty');
      const locEl = $('#location');
      const noteEl = $('#note');
      const submitBtn = $('#submitBtn');
      const toast = $('#toast');

      function showToast(msg){
        toast.textContent = msg;
        toast.classList.add('show');
        setTimeout(()=>toast.classList.remove('show'), 2200);
      }

      function labelFor(p){
        const d = (p.diameterFt!=null)? String(p.diameterFt).replace(/\.0$/,'') : '?';
        const l = (p.lengthFt!=null)? String(p.lengthFt).replace(/\.0$/,'') : '?';
        const brand = p.brand || 'Unknown';
        return `${brand} • ${d}' × ${l}'`;
      }

      function renderProductOptions(){
        productSel.innerHTML = '';
        const ph = document.createElement('option');
        ph.value = '';
        ph.textContent = 'Select a grain bag…';
        ph.disabled = true; ph.selected = true;
        productSel.appendChild(ph);

        if (!products.length){
          const none = document.createElement('option');
          none.value = '';
          none.textContent = 'No active grain bag products found';
          none.disabled = true;
          productSel.appendChild(none);
          return;
        }

        // Sort by brand, then diameter, then length
        products.sort((a,b)=>{
          const ba=(a.brand||'').toLowerCase(), bb=(b.brand||'').toLowerCase();
          if(ba!==bb) return ba<bb?-1:1;
          const da = Number(a.diameterFt||0), db = Number(b.diameterFt||0);
          if(da!==db) return da-db;
          const la = Number(a.lengthFt||0), lb = Number(b.lengthFt||0);
          return la-lb;
        });

        for(const p of products){
          const opt = document.createElement('option');
          opt.value = p.id;
          opt.textContent = labelFor(p);
          productSel.appendChild(opt);
          productMap.set(p.id, p);
        }
      }

      async function ensureFirebaseReady(){
        // wait for global firebase + app + firestore
        const start = Date.now();
        while(!(window.firebase && firebase.apps && firebase.apps.length)){
          if(Date.now()-start > 8000) throw new Error('Firebase app not ready');
          await new Promise(r=>setTimeout(r,100));
        }
        db = firebase.firestore();
        auth = firebase.auth();
        FieldValue = firebase.firestore.FieldValue;
      }

      function authReady(){
        return new Promise(resolve=>{
          const unsub = auth.onAuthStateChanged(u=>{ unsub(); resolve(u||null); });
        });
      }

      async function loadProducts(){
        // Use a direct Firestore query with status == "active"
        try{
          let list = [];
          if(window.FVData && typeof FVData.query === 'function'){
            // Prefer FVData query if available in your project
            list = await FVData.query(PRODUCTS_COL, [['status','==','active']]);
          }else if(window.FVData && typeof FVData.collection === 'function'){
            // Fallback to FVData.collection then filter
            const all = await FVData.collection(PRODUCTS_COL);
            list = (all||[]).filter(p => (p.status||'').toLowerCase()==='active');
          }else{
            const snap = await db.collection(PRODUCTS_COL).where('status','==','active').get();
            list = snap.docs.map(d=>({id:d.id, ...d.data()}));
          }
          products = Array.isArray(list) ? list : [];
          renderProductOptions();
        }catch(err){
          console.error('Failed to load productsGrainBags', err);
          productSel.innerHTML = '<option value="">Failed to load products</option>';
        }
      }

      function currentUserMeta(user){
        const name = (user && (user.displayName || user.email || user.uid)) || 'Unknown';
        return { uid: user ? user.uid : null, submittedBy: name };
      }

      async function saveMovement({productId, qty, location, note}){
        const p = productMap.get(productId);
        if(!p) throw new Error('Invalid product selection');

        const { uid, submittedBy } = currentUserMeta(auth.currentUser);

        const payload = {
          type: 'add',
          qty: Number(qty),
          productRef: db.collection(PRODUCTS_COL).doc(productId),
          brand: p.brand || null,
          diameterFt: (p.diameterFt!=null)? Number(p.diameterFt) : null,
          lengthFt: (p.lengthFt!=null)? Number(p.lengthFt) : null,
          // denorm that may help later:
          thicknessMil: (p.thicknessMil!=null)? Number(p.thicknessMil) : null,
          status: p.status || null,
          location: location || null,
          note: note || null,
          uid: uid,
          submittedBy: submittedBy,
          ts: FieldValue.serverTimestamp()
        };

        if(window.FVData && typeof FVData.add === 'function'){
          return FVData.add(MOVEMENTS_COL, payload);
        }else{
          return db.collection(MOVEMENTS_COL).add(payload);
        }
      }

      function validate(){
        const valid = !!productSel.value && Number(qtyEl.value)>=1 && Number.isInteger(Number(qtyEl.value));
        submitBtn.disabled = !valid;
      }

      // Wire events
      form.addEventListener('input', validate);
      form.addEventListener('change', validate);

      form.addEventListener('submit', async (e)=>{
        e.preventDefault();
        validate();
        if(submitBtn.disabled) return;

        submitBtn.disabled = true;
        submitBtn.textContent = 'Saving…';

        try{
          const data = {
            productId: productSel.value,
            qty: Number(qtyEl.value),
            location: (locEl.value||'').trim(),
            note: (noteEl.value||'').trim()
          };
          if(!(data.qty>=1 && Number.isInteger(data.qty))) throw new Error('Quantity must be a whole number ≥ 1');

          await saveMovement(data);
          form.reset();
          renderProductOptions(); // back to placeholder
          validate();
          showToast('Saved: bags added to inventory');
        }catch(err){
          console.error(err);
          showToast('Error: could not save');
        }finally{
          submitBtn.textContent = 'Save to Inventory';
          validate();
        }
      });

      // Boot: wait for Firebase + Auth, then load
      window.addEventListener('DOMContentLoaded', async ()=>{
        try{
          await ensureFirebaseReady();
          await authReady();         // ensures request.auth is set for rules that require it
          await loadProducts();      // now safe to query
          validate();

          // Optional: refresh if auth context changes (keeps behavior consistent with acl’ed reads)
          auth.onAuthStateChanged(async ()=>{ try{ await loadProducts(); }catch(_e){} });
        }catch(err){
          console.error('Startup error', err);
          productSel.innerHTML = '<option value="">Failed to initialize</option>';
          showToast('Startup error');
        }
      });
    })();
  </script>
</body>
</html>
