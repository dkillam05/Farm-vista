<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista â€¢ Inventory â†’ Add Grain Bags</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- Standard includes -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <!-- âœ… CRITICAL: ensure FV_FIREBASE_CONFIG exists BEFORE firebase-init.js resolves ready -->
  <script src="/Farm-vista/js/firebase-config.js"></script>

  <style>
    .page{max-width:1100px;margin:0 auto;padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + 96px)!important;}
    .page-title{margin:0 0 8px 0;}
    .page-sub{margin:0 0 14px 0;color:var(--muted,#67706B);}

    .section{border:1px solid var(--border);border-radius:14px;background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));overflow:hidden;}
    .section-head{display:grid;grid-template-columns:36px 1fr;gap:12px;align-items:center;
      padding:14px 16px;border-bottom:1px solid var(--border);
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);}
    .section-head .icon{width:24px;height:24px;color:#2F6C3C;display:grid;place-items:center;}
    .section-body{padding:16px;display:grid;gap:14px;}

    .row{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    .row-1{display:grid;gap:10px;grid-template-columns:1fr}
    @media(max-width:720px){.row{grid-template-columns:1fr}}

    .field label{display:block;font-weight:800;margin:0 0 6px 0;}
    .input, .select, textarea{
      width:100%;font:inherit;font-size:16px;color:var(--text);
      background:var(--card-surface,var(--surface));border:1px solid var(--border);
      border-radius:10px;padding:12px;outline:none;resize:vertical;
    }
    .actions{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .btn{display:inline-flex;align-items:center;justify-content:center;min-width:148px;padding:12px 16px;border-radius:12px;
      border:1px solid var(--border);background:var(--card-surface,var(--surface));font-weight:800;color:var(--text);cursor:pointer;}
    .btn-primary{border-color:transparent;background:#2F6C3C;color:#fff;}
    .btn-quiet{min-width:auto;padding:8px 12px}
    .muted{ color:var(--muted,#67706B); }

    /* Toast */
    .toast{position:fixed;left:50%;bottom:calc(env(safe-area-inset-bottom,0px) + 72px);transform:translateX(-50%);
      background:#2F6C3C;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.25);z-index:99999;display:none;}
    .toast.show{display:block;animation:fadeout 4s forwards;}
    @keyframes fadeout{0%{opacity:1}85%{opacity:1}100%{opacity:0}}
  </style>

  <!-- Ensure fv-shell -->
  <script>(function(){
    if(!customElements.get('fv-shell')){
      const s=document.createElement('script');s.src='/Farm-vista/js/fv-shell.js';s.defer=true;document.head.appendChild(s);
    }
  })();</script>
</head>
<body>
  <fv-shell>
    <div class="page container">
      <h1 class="page-title">Add Grain Bags to Inventory</h1>
      <p class="page-sub">
        Record <strong>bags on-hand in the shed</strong>. Choose the bag (brand â€¢ size) from your Products list, enter quantity, and save.
        Each save updates the running total for that bag.
      </p>

      <section class="section">
        <header class="section-head">
          <div class="icon" aria-hidden="true">ðŸ‘œ</div>
          <div><strong>Add Bags</strong></div>
        </header>

        <div class="section-body">
          <div class="row-1">
            <div class="field">
              <label for="bagSelect">Grain bag (brand â€¢ size)</label>
              <select id="bagSelect" class="select">
                <option value="">Loading optionsâ€¦</option>
              </select>
              <p class="muted" style="margin:6px 2px 0; line-height:1.3">
                Options pulled from <em>Products â†’ Grain Bags</em> (only items with <code>status="active"</code> are shown).
              </p>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="qty">Quantity (bags)</label>
              <input id="qty" class="input" inputmode="numeric" type="number" min="1" step="1" placeholder="e.g., 500">
            </div>
            <div class="field">
              <label for="location">Storage location <span class="muted">(optional)</span></label>
              <input id="location" class="input" placeholder="e.g., Main Shop, North shed, bay 2">
            </div>
          </div>

          <div class="row-1">
            <div class="field">
              <label for="note">Note <span class="muted">(optional)</span></label>
              <textarea id="note" class="input" placeholder="Any extra detailsâ€¦"></textarea>
            </div>
          </div>

          <div class="actions">
            <button id="save" class="btn btn-primary" type="button" disabled>Save to Inventory</button>
            <button id="reset" class="btn" type="button">Reset</button>
          </div>
        </div>
      </section>
    </div>
  </fv-shell>

  <div id="toast" class="toast" role="status" aria-live="polite">Saved.</div>

  <script type="module">
    import {
      ready,
      getFirestore, collection, query, orderBy, getDocs,
      addDoc, doc, serverTimestamp, where, updateDoc
    } from '/Farm-vista/js/firebase-init.js';

    (function(){
      "use strict";
      const $ = id => document.getElementById(id);
      const toast = $("toast");

      const showToast = (msg="Saved.")=>{
        toast.textContent = msg;
        toast.classList.remove("show"); void toast.offsetWidth;
        toast.classList.add("show");
        setTimeout(()=> toast.classList.remove("show"), 3500);
      };

      const toInt = (v)=> {
        const n = Number(String(v||"").replace(/,/g,"").trim());
        return Number.isFinite(n) ? Math.max(0, Math.round(n)) : 0;
      };

      let db;
      const productsRef  = ()=> collection(db, 'productsGrainBags');
      const movesRef     = ()=> collection(db, 'inventoryGrainBagMovements');

      let PRODUCTS = [];
      const P_MAP = new Map();

      function setSelectOne(msg){
        const sel = $("bagSelect");
        sel.innerHTML = '';
        const o = document.createElement('option');
        o.value = '';
        o.textContent = msg;
        o.disabled = true;
        o.selected = true;
        sel.appendChild(o);
      }

      function bagLabel(p){
        const d = (p.diameterFt!=null)? String(p.diameterFt).replace(/\.0$/,'') : '?';
        const l = (p.lengthFt!=null)? String(p.lengthFt).replace(/\.0$/,'') : '?';
        const brand = (p.brand && String(p.brand).trim()) ? String(p.brand).trim() : 'Unknown';
        return `${brand} â€¢ ${d}' Ã— ${l}'`;
      }

      function normalizeProductSnap(snap){
        const d = snap.data()||{};
        return {
          id: snap.id,
          brand: String(d.brand||'').trim(),
          diameterFt: d.diameterFt ?? null,
          lengthFt: d.lengthFt ?? null,
          thicknessMil: d.thicknessMil ?? null,
          status: (d.status || 'active')
        };
      }

      function isActive(p){
        return String(p.status || '').toLowerCase() === 'active';
      }

      function sortProducts(arr){
        arr.sort((a,b)=>{
          const ba=(a.brand||'').toLowerCase(), bb=(b.brand||'').toLowerCase();
          if(ba!==bb) return ba<bb?-1:1;
          const da = Number(a.diameterFt||0), db = Number(b.diameterFt||0);
          if(da!==db) return da-db;
          const la = Number(a.lengthFt||0), lb = Number(b.lengthFt||0);
          return la-lb;
        });
        return arr;
      }

      function renderProductSelect(){
        const sel = $("bagSelect");
        sel.innerHTML = '';

        const ph = document.createElement('option');
        ph.value=''; ph.textContent='Select a grain bagâ€¦'; ph.disabled=true; ph.selected=true;
        sel.appendChild(ph);

        if(!PRODUCTS.length){
          const none = document.createElement('option');
          none.value=''; none.textContent='No active grain bag products found'; none.disabled=true;
          sel.appendChild(none);
          return;
        }

        PRODUCTS.forEach(p=>{
          const o=document.createElement('option');
          o.value = p.id;
          o.textContent = bagLabel(p);
          sel.appendChild(o);
        });
      }

      async function loadProductsNoIndex(){
        PRODUCTS = [];
        P_MAP.clear();

        // âœ… Try orderBy only (no composite index)
        try{
          const qs = await getDocs(query(productsRef(), orderBy('brand')));
          qs.forEach(s=>{
            const it = normalizeProductSnap(s);
            PRODUCTS.push(it); P_MAP.set(it.id, it);
          });
        }catch(err){
          // Fallback: no orderBy at all
          console.warn('[bags] orderBy(brand) failed, falling back to plain getDocs:', err);
          const qs = await getDocs(productsRef());
          qs.forEach(s=>{
            const it = normalizeProductSnap(s);
            PRODUCTS.push(it); P_MAP.set(it.id, it);
          });
        }

        // Filter active locally (no index required)
        PRODUCTS = PRODUCTS.filter(isActive);
        sortProducts(PRODUCTS);
        renderProductSelect();
      }

      function validate(){
        const ok = $("bagSelect").value && toInt($("qty").value) >= 1;
        $("save").disabled = !ok;
        return ok;
      }

      async function saveMovement(){
        if(!validate()){ alert("Pick a grain bag and enter a quantity â‰¥ 1."); return; }

        const id = $("bagSelect").value;
        const p = P_MAP.get(id);
        if(!p){ alert("Invalid bag selection."); return; }

        const qty = toInt($("qty").value);
        if(!(qty>=1)){ alert("Quantity must be a whole number â‰¥ 1."); return; }

        const location = String($("location").value||"").trim() || null;
        const note = String($("note").value||"").trim() || null;

        const productDocRef = doc(db, 'productsGrainBags', id);

        const existingSnap = await getDocs(
          query(movesRef(), where('productRef', '==', productDocRef))
        );

        if (!existingSnap.empty) {
          const exDoc = existingSnap.docs[0];
          const ex = exDoc.data() || {};
          const prevQty = Number(ex.qty || 0);
          const prevOnHand =
            (ex.onHand != null) ? Number(ex.onHand) :
            (ex.qty != null ? Number(ex.qty) : 0);

          await updateDoc(exDoc.ref, {
            qty: prevQty + qty,
            onHand: prevOnHand + qty,
            location,
            note,
            brand: p.brand || null,
            diameterFt: (p.diameterFt!=null)? Number(p.diameterFt) : null,
            lengthFt: (p.lengthFt!=null)? Number(p.lengthFt) : null,
            thicknessMil: (p.thicknessMil!=null)? Number(p.thicknessMil) : null,
            status: p.status || null,
            updatedAt: serverTimestamp()
          });

        } else {
          await addDoc(movesRef(), {
            type: 'add',
            qty,
            onHand: qty,
            productRef: productDocRef,
            brand: p.brand || null,
            diameterFt: (p.diameterFt!=null)? Number(p.diameterFt) : null,
            lengthFt: (p.lengthFt!=null)? Number(p.lengthFt) : null,
            thicknessMil: (p.thicknessMil!=null)? Number(p.thicknessMil) : null,
            status: p.status || null,
            location,
            note,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          });
        }

        $("qty").value = "";
        $("location").value = "";
        $("note").value = "";
        $("bagSelect").value = "";
        validate();
        showToast("Saved: bags added to inventory (running total updated).");
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      (async()=>{
        setSelectOne("Loading optionsâ€¦");

        const ctx = await ready; // âœ… ready is a Promise in your firebase-init.js
        if(!ctx || ctx.mode !== 'firebase'){
          setSelectOne("Firebase not available");
          $("save").disabled = true;
          showToast("Firebase not available.");
          return;
        }

        db = getFirestore();

        try{
          await loadProductsNoIndex();
        }catch(err){
          console.error('[bags] failed to load products:', err);
          setSelectOne("Could not load products");
          $("save").disabled = true;
          showToast("Could not load products");
          return;
        }

        validate();
        $("bagSelect").addEventListener("change", validate);
        $("qty").addEventListener("input", validate);
        $("save").addEventListener("click", saveMovement);
        $("reset").addEventListener("click", ()=>{
          $("bagSelect").value = ""; $("qty").value=""; $("location").value=""; $("note").value="";
          validate();
        });
      })();
    })();
  </script>
</body>
</html>
