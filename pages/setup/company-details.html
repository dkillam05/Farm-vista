<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista ‚Ä¢ Setup ‚Üí Company Details</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- Match Ideas page boot order -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <style>
    .page{max-width:1100px;margin:0 auto;padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + 96px)!important;}
    .page-title{margin:0 0 8px 0;}
    .page-sub{margin:0 0 14px 0;color:var(--muted,#67706B);}

    .section{border:1px solid var(--border);border-radius:14px;background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));overflow:hidden;}
    .section-head{display:grid;grid-template-columns:36px 1fr;gap:12px;align-items:center;
      padding:14px 16px;border-bottom:1px solid var(--border);
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);}
    .section-head .icon{width:24px;height:24px;color:#2F6C3C;display:grid;place-items:center;}
    .section-body{padding:16px;display:grid;gap:14px;}

    .grid{display:grid;grid-template-columns:1fr 380px;gap:16px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .row{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    .row-3{display:grid;gap:10px;grid-template-columns:1fr 1fr 1fr}
    @media(max-width:860px){.row-3{grid-template-columns:1fr 1fr}}
    @media(max-width:600px){.row,.row-3{grid-template-columns:1fr}}
    .field label{display:block;font-weight:800;margin:0 0 6px 0;}
    .input,.select,.textarea{
      width:100%;font:inherit;font-size:16px;color:var(--text);
      background:var(--card-surface,var(--surface));border:1px solid var(--border);
      border-radius:10px;padding:12px;outline:none;}
    .textarea{min-height:96px;resize:vertical;}
    .muted{font-size:13px;color:var(--muted,#67706B)}
    .hint{font-size:12px;color:var(--muted,#67706B);margin-top:4px}

    .actions{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .btn{display:inline-flex;align-items:center;justify-content:center;min-width:148px;padding:12px 16px;border-radius:12px;
      border:1px solid var(--border);background:var(--card-surface,var(--surface));font-weight:800;color:var(--text);cursor:pointer;}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn-primary{border-color:transparent;background:#2F6C3C;color:#fff;}

    /* Logo card */
    .logo-card{border:1px dashed var(--border);border-radius:12px;padding:12px;display:grid;gap:12px;background:var(--card-surface,var(--surface))}
    .logo-preview{width:100%;aspect-ratio:1/1;border:1px solid var(--border);border-radius:12px;display:grid;place-items:center;overflow:hidden;background:#f6f7f6}
    .logo-preview img{max-width:100%;max-height:100%;object-fit:contain;display:block}
    .status{font-size:13px;color:var(--muted,#67706B)}

    /* Summary */
    .summary{border:1px solid var(--border);border-radius:12px;padding:14px;background:linear-gradient(180deg, rgba(47,108,60,.06), transparent);display:grid;gap:8px}
    .summary h3{margin:0 0 6px 0;font-size:1rem}
    .kv{display:grid;grid-template-columns:140px 1fr;gap:6px 10px;align-items:baseline}
    @media(max-width:560px){.kv{grid-template-columns:1fr}}

    /* Toast + Error */
    .toast{position:fixed;left:50%;bottom:calc(env(safe-area-inset-bottom,0px) + 72px);transform:translateX(-50%);
      background:#2F6C3C;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.25);z-index:99999;display:none;
      white-space:nowrap;text-align:center;max-width:92vw;overflow:hidden;text-overflow:ellipsis;}
    .toast.show{display:block;animation:fadeout 3.2s forwards;}
    @keyframes fadeout{0%{opacity:1}85%{opacity:1}100%{opacity:0}}
    .error{border:1px solid #b3261e;background:#fff;color:#b3261e;border-radius:10px;padding:10px 12px;display:none}
    .error.show{display:block}
  </style>

  <!-- Ensure fv-shell if user lands direct -->
  <script>(function(){
    if(!customElements.get('fv-shell')){
      const s=document.createElement('script');s.src='/Farm-vista/js/fv-shell.js';s.defer=true;document.head.appendChild(s);
    }
  })();</script>
</head>
<body>
  <fv-shell>
    <div class="page container">
      <h1 class="page-title">Company Details</h1>
      <p class="page-sub">Single record lives at <span class="muted">/company/main</span></p>

      <section class="section">
        <header class="section-head">
          <div class="icon" aria-hidden="true">üè¢</div>
          <div><strong>Company Information</strong></div>
        </header>

        <div class="section-body">
          <div id="err" class="error"></div>

          <div class="grid">
            <div class="fields">
              <div class="field">
                <label for="coName">Farm / Company Name *</label>
                <input id="coName" class="input" placeholder="e.g., Dowson Farms" autocomplete="organization">
              </div>

              <div class="field">
                <label>Address</label>
                <input id="addrStreet" class="input" placeholder="Street address" autocomplete="address-line1">
                <div class="row-3">
                  <input id="addrCity" class="input" placeholder="City" autocomplete="address-level2">
                  <select id="addrState" class="select" autocomplete="address-level1">
                    <option value="">State</option>
                    <option value="AL">AL</option><option value="AK">AK</option><option value="AZ">AZ</option><option value="AR">AR</option>
                    <option value="CA">CA</option><option value="CO">CO</option><option value="CT">CT</option><option value="DE">DE</option>
                    <option value="FL">FL</option><option value="GA">GA</option><option value="HI">HI</option><option value="ID">ID</option>
                    <option value="IL" selected>IL</option><option value="IN">IN</option><option value="IA">IA</option><option value="KS">KS</option>
                    <option value="KY">KY</option><option value="LA">LA</option><option value="ME">ME</option><option value="MD">MD</option>
                    <option value="MA">MA</option><option value="MI">MI</option><option value="MN">MN</option><option value="MS">MS</option>
                    <option value="MO">MO</option><option value="MT">MT</option><option value="NE">NE</option><option value="NV">NV</option>
                    <option value="NH">NH</option><option value="NJ">NJ</option><option value="NM">NM</option><option value="NY">NY</option>
                    <option value="NC">NC</option><option value="ND">ND</option><option value="OH">OH</option><option value="OK">OK</option>
                    <option value="OR">OR</option><option value="PA">PA</option><option value="RI">RI</option><option value="SC">SC</option>
                    <option value="SD">SD</option><option value="TN">TN</option><option value="TX">TX</option><option value="UT">UT</option>
                    <option value="VT">VT</option><option value="VA">VA</option><option value="WA">WA</option><option value="WV">WV</option>
                    <option value="WI">WI</option><option value="WY">WY</option>
                  </select>
                  <div>
                    <input id="addrZip" class="input" placeholder="ZIP" inputmode="numeric" maxlength="5" autocomplete="postal-code">
                    <div id="zipHint" class="hint"></div>
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="field">
                  <label for="coPhone">Phone</label>
                  <input id="coPhone" class="input" type="tel" inputmode="tel" placeholder="(217) 555-0123" autocomplete="tel">
                </div>
                <div class="field">
                  <label for="coEmail">Primary Email</label>
                  <input id="coEmail" class="input" type="email" placeholder="office@example.com" autocomplete="email">
                </div>
              </div>

              <div class="actions">
                <button id="clear" class="btn" type="button">Clear</button>
                <button id="save" class="btn btn-primary" type="button">Save</button>
              </div>
            </div>

            <div class="logo-card">
              <div class="field">
                <label for="coLogo">Farm Logo</label>
                <input id="coLogo" class="input" type="file" accept="image/png,image/jpeg,image/webp,image/svg+xml">
                <div class="hint">Square-ish works best; we auto-fit & compress.</div>
              </div>
              <div class="logo-preview" id="logoPreview" aria-live="polite">
                <div class="muted">No logo yet</div>
              </div>
              <div class="status" id="logoStatus"></div>
              <div class="actions">
                <button id="removeLogo" class="btn" type="button">Remove Logo</button>
              </div>
            </div>
          </div>

          <div class="summary" id="summary" hidden>
            <h3>Current Details</h3>
            <div class="kv">
              <div><strong>Name</strong></div><div id="sName">‚Äî</div>
              <div><strong>Address</strong></div><div id="sAddr">‚Äî</div>
              <div><strong>Phone</strong></div><div id="sPhone">‚Äî</div>
              <div><strong>Email</strong></div><div id="sEmail">‚Äî</div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </fv-shell>

  <div id="toast" class="toast" role="status" aria-live="polite">Saved.</div>

  <!-- Same modular init as Ideas page -->
  <script type="module">
    import {
      ready,
      getFirestore, doc, getDoc, setDoc, serverTimestamp,
      getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject
    } from '/Farm-vista/js/firebase-init.js';

    (function(){
      "use strict";
      const $ = (s)=>document.querySelector(s);

      /* Elements */
      const el = {
        err:$('#err'), toast:$('#toast'),
        save:$('#save'), clear:$('#clear'),
        name:$('#coName'),
        street:$('#addrStreet'), city:$('#addrCity'), state:$('#addrState'), zip:$('#addrZip'), zipHint:$('#zipHint'),
        phone:$('#coPhone'), email:$('#coEmail'),
        logo:$('#coLogo'), logoPreview:$('#logoPreview'), logoStatus:$('#logoStatus'), removeLogo:$('#removeLogo'),
        summary:$('#summary'), sName:$('#sName'), sAddr:$('#sAddr'), sPhone:$('#sPhone'), sEmail:$('#sEmail')
      };

      /* Constants */
      const DOC_REF = (db)=>doc(db, 'company', 'main');
      const STORAGE_PATH = 'company/logo-main.png';

      let db, busy=false, logoDataUrl="", logoUrl="";

      /* Small IL ZIP map (fast offline; includes Divernon) */
      const IL_ZIPS = {
        "DIVERNON":"62530","SPRINGFIELD":"62704","SPRINGFIELD_DOWNTOWN":"62701","CHATHAM":"62629",
        "JACKSONVILLE":"62650","QUINCY":"62301","ALTON":"62002","MOLINE":"61265",
        "ROCKFORD":"61101","CHAMPAIGN":"61820","URBANA":"61801","DECATUR":"62521","AUBURN":"62615"
      };

      /* Helpers */
      const showToast=(m="Saved.",ms=3200)=>{ el.toast.textContent=m; el.toast.classList.remove('show'); void el.toast.offsetWidth; el.toast.classList.add('show'); setTimeout(()=>el.toast.classList.remove('show'),ms); };
      const showErr=(m)=>{ el.err.textContent=m||""; el.err.classList.toggle('show',!!m); };
      const setBusy=(on)=>{ busy=!!on; [el.save,el.clear,el.logo,el.removeLogo,el.name,el.street,el.city,el.state,el.zip,el.phone,el.email].forEach(b=>b&&(b.disabled=busy)); el.logoStatus.textContent=on?"Working‚Ä¶":""; };
      const onlyDigits=(s)=>String(s||"").replace(/\D+/g,"");
      const normalizeEmail=(s)=>String(s||"").trim().toLowerCase();
      const validEmail=(s)=>/^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i.test(String(s||""));
      const escapeHTML=(s)=> String(s||"").replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]));

      /* Phone mask */
      function fmtPhoneLive(v){
        let d=onlyDigits(v); if(d.startsWith('1')&&d.length>10) d=d.slice(1);
        if(!d) return ""; if(d.length<4) return `(${d}`; if(d.length<7) return `(${d.slice(0,3)}) ${d.slice(3)}`;
        return `(${d.slice(0,3)}) ${d.slice(3,6)}-${d.slice(6,10)}` + (d.length>10?` x${d.slice(10)}`:"");
      }
      function fmtPhoneFinal(v){
        let d=onlyDigits(v); if(d.startsWith('1')&&d.length>10) d=d.slice(1);
        if(d.length>=10){ const base=`(${d.slice(0,3)}) ${d.slice(3,6)}-${d.slice(6,10)}`; return d.length>10?`${base} x${d.slice(10)}`:base; }
        return v.trim();
      }
      el.phone.addEventListener('input', ()=>{ el.phone.value = fmtPhoneLive(el.phone.value); });
      el.phone.addEventListener('blur',  ()=>{ el.phone.value = fmtPhoneFinal(el.phone.value); });

      /* ZIP helpers (IL offline) */
      function autofillZipFromCityState(){
        const st=(el.state.value||"").toUpperCase();
        const city=(el.city.value||"").trim().toUpperCase();
        if(st!=="IL"||!city) return;
        const key = city.replace(/\s+/g,'_');
        const z = IL_ZIPS[key] || IL_ZIPS[city] || "";
        if(z){ el.zip.value=z; el.zipHint.textContent=""; }
      }
      function autofillCityStateFromZip(){
        const z=onlyDigits(el.zip.value);
        if(z.length!==5) return;
        // reverse for a few we know
        if(z==="62530"){ if(!el.city.value) el.city.value="Divernon"; el.state.value="IL"; el.zipHint.textContent=""; }
        if(z==="62629"){ if(!el.city.value) el.city.value="Chatham";  el.state.value="IL"; el.zipHint.textContent=""; }
        if(z==="62704"||z==="62701"){ if(!el.city.value) el.city.value="Springfield"; el.state.value="IL"; el.zipHint.textContent=""; }
      }
      el.city.addEventListener('blur',autofillZipFromCityState);
      el.state.addEventListener('change',autofillZipFromCityState);
      el.zip.addEventListener('input', ()=>{ el.zip.value = onlyDigits(el.zip.value).slice(0,5); });
      el.zip.addEventListener('blur',autofillCityStateFromZip);

      /* Logo preview + compression for upload */
      function renderLogo(src){
        el.logoPreview.innerHTML="";
        if(src){
          const img=new Image(); img.alt="Farm logo"; img.src=src; el.logoPreview.appendChild(img);
        }else{
          const div=document.createElement("div"); div.className="muted"; div.textContent="No logo yet"; el.logoPreview.appendChild(div);
        }
      }
      function compressToDataURL(file,maxSide){
        return new Promise((resolve,reject)=>{
          const img=new Image(); const url=URL.createObjectURL(file);
          img.onload=()=>{
            const c=document.createElement('canvas'), ctx=c.getContext('2d');
            const w=img.naturalWidth, h=img.naturalHeight, s=Math.min(1, maxSide/Math.max(w,h));
            c.width=Math.round(w*s); c.height=Math.round(h*s);
            ctx.clearRect(0,0,c.width,c.height); ctx.drawImage(img,0,0,c.width,c.height);
            URL.revokeObjectURL(url);
            resolve(c.toDataURL('image/png'));
          };
          img.onerror=reject; img.src=url;
        });
      }
      function dataURLtoBlob(dataUrl){
        const [h,b]=String(dataUrl||'').split(','); const mime=(h.match(/:(.*?);/)||[])[1]||'image/png';
        const bin=atob(b||""); const arr=new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i);
        return new Blob([arr],{type:mime});
      }
      el.logo.addEventListener('change', async ()=>{
        const f=el.logo.files && el.logo.files[0]; if(!f) return;
        if (f.size > 12*1024*1024){ showErr("Logo too large (max 12 MB)."); return; }
        showErr(""); el.logoStatus.textContent="Preparing logo‚Ä¶";
        try{
          // Instant preview with object URL:
          renderLogo(URL.createObjectURL(f));
          // Keep a compressed data URL for upload:
          if (f.type === "image/svg+xml"){
            const r=new FileReader(); r.onload=()=>{ logoDataUrl=String(r.result||""); el.logoStatus.textContent="Ready to save."; }; r.onerror=()=>{ showErr("SVG read failed."); el.logoStatus.textContent=""; }; r.readAsDataURL(f);
          }else{
            logoDataUrl = await compressToDataURL(f, 1024);
            el.logoStatus.textContent="Ready to save.";
          }
        }catch(e){ console.error(e); showErr("Could not read logo file."); el.logoStatus.textContent=""; }
      });

      el.removeLogo.addEventListener('click', async ()=>{
        if(!confirm("Remove the saved logo?")) return;
        try{
          setBusy(true); showErr("");
          const store=getStorage(); try{ await deleteObject(storageRef(store,STORAGE_PATH)); }catch(_){}
          await setDoc(DOC_REF(db), { logoUrl:"", logoData:"", updatedAt: serverTimestamp() }, { merge:true });
          logoUrl=""; logoDataUrl=""; renderLogo(""); showToast("Saved. Logo removed.");
        }catch(e){ console.error(e); showErr("Failed to remove logo."); }
        finally{ setBusy(false); }
      });

      /* Load / Save */
      function prettyAddress(street,city,state,zip){
        const l1=(street||"").trim();
        const l2=[(city||"").trim(), (state||"").trim().toUpperCase(), (zip||"").trim()].filter(Boolean).join(' ');
        return [l1,l2].filter(Boolean).join('\n');
      }

      async function loadDoc(){
        try{
          const snap=await getDoc(DOC_REF(db));
          const d=snap.exists()? (snap.data()||{}) : {};
          el.name.value = d.name||"";
          el.street.value=d.addressStreet||"";
          el.city.value  =d.addressCity||"";
          el.state.value =d.addressState||(el.state.value||"IL");
          el.zip.value   =d.addressZip||"";
          el.phone.value = d.phone? fmtPhoneFinal(d.phone):"";
          el.email.value = d.email||"";
          logoUrl        = d.logoUrl||"";
          const logoData = d.logoData||"";
          renderLogo(logoUrl || logoData || "");

          const addr=prettyAddress(el.street.value,el.city.value,el.state.value,el.zip.value);
          el.sName.textContent  = el.name.value || "‚Äî";
          el.sAddr.innerHTML    = addr ? escapeHTML(addr).replace(/\n/g,"<br>") : "‚Äî";
          el.sPhone.textContent = el.phone.value || "‚Äî";
          el.sEmail.textContent = (el.email.value && validEmail(el.email.value)) ? el.email.value : "Not available";
          el.summary.hidden=false;

          // Make sure phone shows mask even if number was raw digits
          if (el.phone.value) el.phone.value = fmtPhoneFinal(el.phone.value);
        }catch(e){ console.error(e); showErr("Failed to load details."); }
      }

      async function uploadLogoIfNeeded(){
        if(!logoDataUrl) return { logoUrl, logoData:"" };
        try{
          const store=getStorage(); const ref=storageRef(store,STORAGE_PATH);
          const blob=dataURLtoBlob(logoDataUrl);
          el.logoStatus.textContent="Uploading logo‚Ä¶";
          await uploadBytes(ref,blob,{ contentType: blob.type||'image/png', cacheControl:'public,max-age=31536000,immutable', customMetadata:{app:'FarmVista',kind:'company-logo'} });
          const url=await getDownloadURL(ref);
          el.logoStatus.textContent="Logo uploaded.";
          return { logoUrl:url, logoData:"" };
        }catch(e){
          console.warn("Storage failed, embedding logo:", e);
          el.logoStatus.textContent="Using inline logo.";
          return { logoUrl:"", logoData:logoDataUrl };
        }
      }

      function validate(){
        if(!String(el.name.value||"").trim()){ showErr("Please enter the farm/company name."); return false; }
        const z=onlyDigits(el.zip.value); if(z && z.length!==5){ showErr("ZIP must be 5 digits."); return false; }
        const em=normalizeEmail(el.email.value); if(em && !validEmail(em)){ showErr("Email looks invalid."); return false; }
        showErr(""); return true;
      }

      async function save(){
        if(busy) return;
        if(!validate()) return;
        setBusy(true);
        try{
          const logoRes=await uploadLogoIfNeeded();
          const zipClean=onlyDigits(el.zip.value).slice(0,5);
          const phoneFinal=fmtPhoneFinal(el.phone.value);
          const emailNorm=normalizeEmail(el.email.value);
          const payload={
            name:String(el.name.value||"").trim(),
            addressStreet:String(el.street.value||"").trim(),
            addressCity:String(el.city.value||"").trim(),
            addressState:String(el.state.value||"").trim().toUpperCase(),
            addressZip:zipClean,
            address: prettyAddress(el.street.value, el.city.value, el.state.value, zipClean),
            phone:phoneFinal,
            email: emailNorm && validEmail(emailNorm) ? emailNorm : "",
            logoUrl:logoRes.logoUrl,
            logoData:logoRes.logoData,
            updatedAt: serverTimestamp()
          };
          await setDoc(DOC_REF(db), payload, { merge:true });
          logoUrl = logoRes.logoUrl || logoUrl;
          el.logoStatus.textContent = logoRes.logoUrl ? "Logo linked." : (logoRes.logoData ? "Logo embedded." : "");
          showToast("Saved.");
          await loadDoc(); // refresh summary
        }catch(e){ console.error(e); showErr("Save failed. Check permissions or network."); }
        finally{ setBusy(false); }
      }

      el.save.addEventListener('click', save);
      window.addEventListener('keydown', (e)=>{ if((e.metaKey||e.ctrlKey)&&e.key.toLowerCase()==='s'){ e.preventDefault(); save(); }});
      el.clear.addEventListener('click', ()=>{
        if(busy) return;
        if(!confirm("Clear unsaved changes?")) return;
        el.name.value=""; el.street.value=""; el.city.value=""; el.state.value="IL"; el.zip.value="";
        el.phone.value=""; el.email.value=""; logoDataUrl=""; renderLogo(""); el.logoStatus.textContent=""; el.zipHint.textContent="";
        showErr("");
      });

      (async ()=>{
        await ready;           // same readiness gate as Ideas page
        db = getFirestore();
        await loadDoc();
        // Ensure phone formats whatever you already typed
        el.phone.value = fmtPhoneFinal(el.phone.value);
      })();
    })();
  </script>
</body>
</html>