<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>Company Details</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- Standard includes -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <style>
    .page{max-width:980px;margin:0 auto;padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + 96px)!important;}
    .section{border:1px solid var(--border);border-radius:14px;background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));overflow:hidden;}
    .section-head{display:grid;grid-template-columns:36px 1fr;gap:12px;align-items:center;
      padding:14px 16px;border-bottom:1px solid var(--border);
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);}
    .section-body{padding:16px;display:grid;gap:14px;}
    .grid{display:grid;grid-template-columns:1fr 320px;gap:16px}
    @media(max-width:900px){.grid{grid-template-columns:1fr}}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media(max-width:640px){.row{grid-template-columns:1fr}}
    .field label{display:block;font-weight:800;margin:0 0 6px 0;}
    .input,.select,.textarea{width:100%;font:inherit;font-size:16px;color:var(--text);
      background:var(--card-surface,var(--surface));border:1px solid var(--border);
      border-radius:10px;padding:12px;outline:none;}
    .muted{font-size:13px;color:var(--muted,#67706B)}
    .actions{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:6px;}
    .btn{display:inline-flex;align-items:center;justify-content:center;min-width:140px;padding:12px 16px;border-radius:12px;
      border:1px solid var(--border);background:var(--card-surface,var(--surface));font-weight:800;color:var(--text);cursor:pointer;}
    .btn-primary{border-color:transparent;background:#2F6C3C;color:#fff;}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .error{border:1px solid #b3261e;background:#fff;color:#b3261e;border-radius:10px;padding:10px 12px;display:none;white-space:pre-wrap}
    .error.show{display:block}
    .toast{position:fixed;left:50%;bottom:calc(env(safe-area-inset-bottom,0px) + 72px);transform:translateX(-50%);
      background:#2F6C3C;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.25);
      z-index:99999;display:none}
    .toast.show{display:block;animation:fadeout 3s forwards;}
    @keyframes fadeout{0%{opacity:1}85%{opacity:1}100%{opacity:0}}

    /* Logo card */
    .logo-card{border:1px dashed var(--border);border-radius:12px;padding:12px;display:grid;gap:12px;background:var(--card-surface,var(--surface))}
    .logo-preview{width:100%;aspect-ratio:1/1;border:1px solid var(--border);border-radius:10px;display:grid;place-items:center;overflow:hidden;background:#f6f7f6}
    .logo-preview img{max-width:100%;max-height:100%;object-fit:contain;display:block}
    .logo-status{font-size:13px;color:var(--muted,#67706B);min-height:1em}
  </style>

  <!-- Ensure <fv-shell> exists when deep-linking -->
  <script>(function(){
    if(!customElements.get('fv-shell')){
      const s=document.createElement('script');s.src='/Farm-vista/js/fv-shell.js';s.defer=true;document.head.appendChild(s);
    }
  })();</script>
</head>
<body>
  <fv-shell>
    <div class="page container">
      <h1 class="page-title">Company Details</h1>

      <section class="section">
        <header class="section-head">
          <div class="icon" aria-hidden="true">üè¢</div>
          <div><strong>Organization Information</strong></div>
        </header>

        <div class="section-body">
          <div id="err" class="error"></div>

          <div class="grid">
            <!-- Left: form fields -->
            <div>
              <div class="field">
                <label for="farmName">Company / Farm Name *</label>
                <input id="farmName" class="input" placeholder="Example: Prairie Ridge Farms" autocomplete="organization">
              </div>

              <div class="field">
                <label for="addrStreet">Street</label>
                <input id="addrStreet" class="input" placeholder="123 Main St" autocomplete="address-line1">
              </div>

              <div class="row">
                <div class="field">
                  <label for="addrCity">City</label>
                  <input id="addrCity" class="input" placeholder="City" autocomplete="address-level2">
                </div>
                <div class="field">
                  <label for="addrState">State</label>
                  <select id="addrState" class="select" autocomplete="address-level1">
                    <option value="">‚Äî</option>
                    <option value="AL">AL</option><option value="AK">AK</option><option value="AZ">AZ</option><option value="AR">AR</option>
                    <option value="CA">CA</option><option value="CO">CO</option><option value="CT">CT</option><option value="DC">DC</option>
                    <option value="DE">DE</option><option value="FL">FL</option><option value="GA">GA</option><option value="HI">HI</option>
                    <option value="ID">ID</option><option value="IL">IL</option><option value="IN">IN</option><option value="IA">IA</option>
                    <option value="KS">KS</option><option value="KY">KY</option><option value="LA">LA</option><option value="ME">ME</option>
                    <option value="MD">MD</option><option value="MA">MA</option><option value="MI">MI</option><option value="MN">MN</option>
                    <option value="MS">MS</option><option value="MO">MO</option><option value="MT">MT</option><option value="NE">NE</option>
                    <option value="NV">NV</option><option value="NH">NH</option><option value="NJ">NJ</option><option value="NM">NM</option>
                    <option value="NY">NY</option><option value="NC">NC</option><option value="ND">ND</option><option value="OH">OH</option>
                    <option value="OK">OK</option><option value="OR">OR</option><option value="PA">PA</option><option value="RI">RI</option>
                    <option value="SC">SC</option><option value="SD">SD</option><option value="TN">TN</option><option value="TX">TX</option>
                    <option value="UT">UT</option><option value="VT">VT</option><option value="VA">VA</option><option value="WA">WA</option>
                    <option value="WV">WV</option><option value="WI">WI</option><option value="WY">WY</option>
                  </select>
                </div>
              </div>

              <div class="row">
                <div class="field">
                  <label for="addrZip">ZIP</label>
                  <input id="addrZip" class="input" placeholder="ZIP code" inputmode="numeric" maxlength="10" autocomplete="postal-code">
                </div>
                <div class="field">
                  <label for="farmPhone">Phone *</label>
                  <input id="farmPhone" class="input" type="tel" inputmode="tel" placeholder="(000) 000-0000" autocomplete="tel">
                </div>
              </div>

              <div class="field">
                <label for="farmEmail">Primary Email</label>
                <input id="farmEmail" class="input" type="email" placeholder="name@example.com" autocomplete="email">
                <div class="muted">These details appear in headers and reports where applicable.</div>
              </div>

              <div class="actions">
                <button id="clear" class="btn" type="button">Clear</button>
                <button id="save" class="btn btn-primary" type="button">Save</button>
              </div>
            </div>

            <!-- Right: logo card -->
            <div class="logo-card">
              <div class="field">
                <label for="logoFile">Logo (optional)</label>
                <input id="logoFile" class="input" type="file" accept="image/*">
                <div class="muted">Use a square or landscape image. Large files will be compressed during upload.</div>
              </div>
              <div id="logoPreview" class="logo-preview" aria-live="polite"><span class="muted">No logo selected</span></div>
              <div id="logoStatus" class="logo-status"></div>
              <div class="actions">
                <button id="removeLogo" class="btn" type="button">Remove Logo</button>
              </div>
            </div>
          </div>

        </div>
      </section>
    </div>
  </fv-shell>

  <div id="toast" class="toast" role="status" aria-live="polite">Saved.</div>

  <script type="module">
    import {
      ready,
      getFirestore, doc, getDoc, setDoc, serverTimestamp,
      getStorage, ref as storageRef, uploadBytes, getDownloadURL, deleteObject
    } from '/Farm-vista/js/firebase-init.js';

    (function(){
      "use strict";
      const $=(s)=>document.querySelector(s);
      const el={
        name:$('#farmName'),
        street:$('#addrStreet'), city:$('#addrCity'), state:$('#addrState'), zip:$('#addrZip'),
        phone:$('#farmPhone'), email:$('#farmEmail'),
        logoFile:$('#logoFile'), logoPreview:$('#logoPreview'), logoStatus:$('#logoStatus'), removeLogo:$('#removeLogo'),
        save:$('#save'), clear:$('#clear'),
        err:$('#err'), toast:$('#toast')
      };

      const REF=(db)=>doc(db,'company','main');
      const LOGO_PATH='company/logo/logo-main.png';
      const CACHE_KEY='fv_company_main';

      const showErr=(m)=>{ el.err.textContent=m||""; el.err.classList.toggle('show',!!m); };
      const showToast=(m="Saved.")=>{ el.toast.textContent=m; el.toast.classList.remove('show'); void el.toast.offsetWidth; el.toast.classList.add('show'); };

      // Phone helpers
      const onlyDigits=(s)=>String(s||"").replace(/\D+/g,"");
      function fmtPhoneLive(v){ let d=onlyDigits(v); if(d.startsWith('1')&&d.length>10)d=d.slice(1);
        if(!d) return ""; if(d.length<4) return `(${d}`; if(d.length<7) return `(${d.slice(0,3)}) ${d.slice(3)}`;
        return `(${d.slice(0,3)}) ${d.slice(3,6)}-${d.slice(6,10)}`+(d.length>10?` x${d.slice(10)}`:""); }
      function fmtPhoneFinal(v){ let d=onlyDigits(v); if(d.startsWith('1')&&d.length>10)d=d.slice(1);
        if(d.length>=10) return `(${d.slice(0,3)}) ${d.slice(3,6)}-${d.slice(6,10)}`+(d.length>10?` x${d.slice(10)}`:""); return v.trim(); }
      function normalizeEmail(s){ return String(s||"").trim().toLowerCase(); }

      el.phone.addEventListener('input', ()=>{ el.phone.value = fmtPhoneLive(el.phone.value); });
      el.phone.addEventListener('blur',  ()=>{ el.phone.value = fmtPhoneFinal(el.phone.value); });
      el.email.addEventListener('blur', ()=>{ el.email.value = normalizeEmail(el.email.value); });

      // Local cache
      function cacheWrite(d){ try{ localStorage.setItem(CACHE_KEY, JSON.stringify(d)); }catch{} }
      function cacheRead(){ try{ const s=localStorage.getItem(CACHE_KEY); return s? JSON.parse(s): null; }catch{ return null; } }

      // Logo preview
      function renderLogo(src){
        el.logoPreview.innerHTML='';
        if(src){
          const img=new Image(); img.alt='Organization logo'; img.src=src; el.logoPreview.appendChild(img);
        }else{
          const span=document.createElement('span'); span.className='muted'; span.textContent='No logo selected'; el.logoPreview.appendChild(span);
        }
      }

      // File compression (basic: scale down large images client-side)
      async function readAndMaybeCompress(file, maxSide=1200){
        const dataUrl = await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); });
        const img = await new Promise((res,rej)=>{ const i=new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=dataUrl; });
        const w=img.naturalWidth||img.width, h=img.naturalHeight||img.height;
        const scale=Math.min(1, maxSide/Math.max(w,h));
        if(scale>=1) return dataUrl;
        const c=document.createElement('canvas'); c.width=Math.round(w*scale); c.height=Math.round(h*scale);
        const ctx=c.getContext('2d'); ctx.fillStyle="#fff"; ctx.fillRect(0,0,c.width,c.height); ctx.drawImage(img,0,0,c.width,c.height);
        return c.toDataURL('image/png');
      }
      function dataURLtoBlob(dataUrl){
        const [m,b]=String(dataUrl||'').split(','); const mime=(m.match(/:(.*?);/)||[])[1]||'image/png';
        const bin=atob(b||''); const arr=new Uint8Array(bin.length); for(let i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i);
        return new Blob([arr],{type:mime});
      }

      let db, store;
      let pendingLogoBlob=null; // if user picked a new logo this session

      el.logoFile.addEventListener('change', async ()=>{
        const f = el.logoFile.files && el.logoFile.files[0];
        if(!f){ pendingLogoBlob=null; renderLogo(''); el.logoStatus.textContent=''; return; }
        if(f.size > 12*1024*1024){ showErr('Logo file is too large (max 12 MB).'); el.logoFile.value=''; return; }
        showErr('');
        try{
          el.logoStatus.textContent='Preparing logo‚Ä¶';
          const dataUrl = await readAndMaybeCompress(f, 1200);
          pendingLogoBlob = dataURLtoBlob(dataUrl);
          renderLogo(URL.createObjectURL(pendingLogoBlob));
          el.logoStatus.textContent='Ready to upload.';
        }catch(e){
          console.error(e); showErr('Could not read logo file.'); pendingLogoBlob=null; renderLogo(''); el.logoStatus.textContent='';
        }
      });

      el.removeLogo.addEventListener('click', async ()=>{
        if(!confirm('Remove the saved logo?')) return;
        try{
          el.logoStatus.textContent='Removing‚Ä¶';
          showErr('');
          // Best-effort delete storage object
          try{
            store = store || getStorage();
            await deleteObject(storageRef(store, LOGO_PATH));
          }catch(e){}
          // Clear Firestore fields
          await setDoc(REF(db), { logoURL:'', logoPath:'', updatedAt: serverTimestamp() }, { merge:true });
          pendingLogoBlob=null; el.logoFile.value=''; renderLogo(''); el.logoStatus.textContent='Logo removed.';
          showToast('Logo removed.');
        }catch(e){
          console.error(e); showErr('Failed to remove logo.');
        }
      });

      function fillForm(d){
        el.name.value   = d?.name || "";
        el.street.value = d?.addressStreet || "";
        el.city.value   = d?.addressCity || "";
        el.state.value  = d?.addressState || "";
        el.zip.value    = d?.addressZip || "";
        el.phone.value  = d?.phone ? fmtPhoneFinal(d.phone) : "";
        el.email.value  = d?.email || "";
        renderLogo(d?.logoURL || '');
        el.logoStatus.textContent = d?.logoURL ? 'Saved logo linked.' : '';
      }
      function readForm(){
        return {
          name:(el.name.value||"").trim(),
          addressStreet:(el.street.value||"").trim(),
          addressCity:(el.city.value||"").trim(),
          addressState:(el.state.value||"").trim(),
          addressZip:(el.zip.value||"").trim(),
          phone:fmtPhoneFinal(el.phone.value||""),
          email:normalizeEmail(el.email.value||"")
        };
      }

      async function loadFromFirestore(){
        try{
          const snap=await getDoc(REF(db));
          const d=snap.exists()? (snap.data()||{}) : {};
          fillForm(d); cacheWrite(d); showErr('');
        }catch(e){ console.error(e); showErr(`Failed to load.\n${e.code||''} ${e.message||''}`.trim()); }
      }

      async function uploadLogoIfNeeded(){
        if(!pendingLogoBlob) return null;
        try{
          store = store || getStorage();
          el.logoStatus.textContent='Uploading‚Ä¶';
          const ref = storageRef(store, LOGO_PATH);
          await uploadBytes(ref, pendingLogoBlob, { contentType: pendingLogoBlob.type || 'image/png', cacheControl: 'public,max-age=31536000,immutable' });
          const url = await getDownloadURL(ref);
          el.logoStatus.textContent='Logo uploaded.';
          return { logoURL:url, logoPath:LOGO_PATH };
        }catch(e){
          console.error(e);
          el.logoStatus.textContent='Upload failed (check Storage rules).';
          return null;
        }
      }

      async function save(){
        try{
          showErr('');
          const data = readForm();
          if(!data.name || !data.phone){ showErr('Please fill required fields (Name, Phone).'); return; }

          // If user selected a new logo, upload first to get URL/path
          const logoMeta = await uploadLogoIfNeeded();

          const payload = { ...data, updatedAt: serverTimestamp() };
          if(logoMeta){ payload.logoURL = logoMeta.logoURL; payload.logoPath = logoMeta.logoPath; }

          await setDoc(REF(db), payload, { merge:true });
          cacheWrite(payload);
          showToast('Saved.');
          // Once saved, treat the new logo as persisted
          if(logoMeta){ pendingLogoBlob=null; }
          await loadFromFirestore();
        }catch(e){
          console.error(e);
          showErr(`Save failed.\n${e.code||''} ${e.message||''}`.trim());
        }
      }

      el.save.addEventListener('click', save);
      el.clear.addEventListener('click', ()=>{
        fillForm({ name:'', addressStreet:'', addressCity:'', addressState:'', addressZip:'', phone:'', email:'', logoURL:'' });
        el.logoFile.value=''; pendingLogoBlob=null; showErr('');
      });

      (async ()=>{
        await ready;
        db = getFirestore();

        // Instant prefill from cache, then refresh from Firestore
        const cached = cacheRead(); if(cached) fillForm(cached);
        await loadFromFirestore();
      })();
    })();
  </script>
</body>
</html>