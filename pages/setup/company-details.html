<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista ‚Ä¢ Setup ‚Üí Company Details</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- Standard includes -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>
  <script src="/Farm-vista/js/theme-boot.js" defer></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <style>
    .page{max-width:1100px;margin:0 auto;padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + 96px)!important;}
    .page-title{margin:0 0 8px 0;}
    .page-sub{margin:0 0 14px 0;color:var(--muted,#67706B);}

    .section{border:1px solid var(--border);border-radius:14px;background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));overflow:hidden;}
    .section-head{display:grid;grid-template-columns:36px 1fr;gap:12px;align-items:center;
      padding:14px 16px;border-bottom:1px solid var(--border);
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);}
    .section-head .icon{width:24px;height:24px;color:#2F6C3C;display:grid;place-items:center;}
    .section-body{padding:16px;display:grid;gap:14px;}

    .grid{display:grid;grid-template-columns:1fr 380px;gap:16px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .row{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    @media(max-width:720px){.row{grid-template-columns:1fr}}
    .field label{display:block;font-weight:800;margin:0 0 6px 0;}
    .input, .select, .textarea{
      width:100%;font:inherit;font-size:16px;color:var(--text);
      background:var(--card-surface,var(--surface));border:1px solid var(--border);
      border-radius:10px;padding:12px;outline:none;}
    .textarea{min-height:96px;resize:vertical;}
    .actions{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .btn{display:inline-flex;align-items:center;justify-content:center;min-width:148px;padding:12px 16px;border-radius:12px;
      border:1px solid var(--border);background:var(--card-surface,var(--surface));font-weight:800;color:var(--text);cursor:pointer;}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn-primary{border-color:transparent;background:#2F6C3C;color:#fff;}

    /* Logo card */
    .logo-card{border:1px dashed var(--border);border-radius:12px;padding:12px;display:grid;gap:12px;background:var(--card-surface,var(--surface))}
    .logo-preview{width:100%;aspect-ratio:1/1;border:1px solid var(--border);border-radius:12px;display:grid;place-items:center;overflow:hidden;background:#f6f7f6}
    .logo-preview img{max-width:100%;max-height:100%;object-fit:contain;display:block}
    .help{font-size:13px;color:var(--muted,#67706B)}
    .status{font-size:13px;color:var(--muted,#67706B)}

    /* Summary */
    .summary{border:1px solid var(--border);border-radius:12px;padding:14px;background:linear-gradient(180deg, rgba(47,108,60,.06), transparent);display:grid;gap:8px}
    .summary h3{margin:0 0 6px 0;font-size:1rem}
    .kv{display:grid;grid-template-columns:140px 1fr;gap:6px 10px;align-items:baseline}
    @media(max-width:560px){.kv{grid-template-columns:1fr}}

    /* Toast */
    .toast{position:fixed;left:50%;bottom:calc(env(safe-area-inset-bottom,0px) + 72px);transform:translateX(-50%);
      background:#2F6C3C;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.25);z-index:99999;display:none;}
    .toast.show{display:block;animation:fadeout 2.8s forwards;}
    @keyframes fadeout{0%{opacity:1}85%{opacity:1}100%{opacity:0}}

    /* Inline error */
    .error{border:1px solid #b3261e;background:#fff; color:#b3261e;border-radius:10px;padding:10px 12px;display:none}
    .error.show{display:block}
  </style>

  <script>
    // Ensure <fv-shell> if navigating directly to this subpage
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');s.src='/Farm-vista/js/fv-shell.js';s.defer=true;document.head.appendChild(s);
      }
    })();
  </script>
</head>
<body>
  <fv-shell>
    <div class="page container">
      <h1 class="page-title">Company Details</h1>
      <p class="page-sub">Set your farm‚Äôs identity for use across the app and on reports.</p>

      <section class="section">
        <header class="section-head">
          <div class="icon" aria-hidden="true">üè¢</div>
          <div><strong>Company Information</strong></div>
        </header>

        <div class="section-body">
          <div id="err" class="error"></div>

          <div class="grid">
            <!-- Left: form fields -->
            <div class="fields">
              <div class="field">
                <label for="coName">Farm / Company Name</label>
                <input id="coName" class="input" placeholder="e.g., Dowson Farms" autocomplete="organization">
              </div>

              <div class="field">
                <label for="coAddr">Address</label>
                <textarea id="coAddr" class="textarea" placeholder="Street&#10;City, State ZIP" autocomplete="street-address"></textarea>
              </div>

              <div class="row">
                <div class="field">
                  <label for="coPhone">Phone</label>
                  <input id="coPhone" class="input" type="tel" inputmode="tel" placeholder="(217) 555-0123" autocomplete="tel">
                </div>
                <div class="field">
                  <label for="coEmail">Primary Email</label>
                  <input id="coEmail" class="input" type="email" placeholder="office@example.com" autocomplete="email">
                </div>
              </div>

              <div class="actions">
                <button id="clear" class="btn" type="button">Clear</button>
                <button id="save" class="btn btn-primary" type="button">Save</button>
              </div>
            </div>

            <!-- Right: logo -->
            <div class="logo-card">
              <div class="field">
                <label for="coLogo">Farm Logo</label>
                <input id="coLogo" class="input" type="file" accept="image/png,image/jpeg,image/webp,image/svg+xml">
                <div class="help">Upload a square-ish logo. We‚Äôll auto-fit & compress it for reports and headers.</div>
              </div>
              <div class="logo-preview" id="logoPreview" aria-live="polite">
                <div class="help">No logo yet</div>
              </div>
              <div class="status" id="logoStatus"></div>
              <div class="actions">
                <button id="removeLogo" class="btn" type="button">Remove Logo</button>
              </div>
            </div>
          </div>

          <!-- Saved preview -->
          <div class="summary" id="summary" hidden>
            <h3>Current Details</h3>
            <div class="kv">
              <div><strong>Name</strong></div><div id="sName"></div>
              <div><strong>Address</strong></div><div id="sAddr"></div>
              <div><strong>Phone</strong></div><div id="sPhone"></div>
              <div><strong>Email</strong></div><div id="sEmail"></div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </fv-shell>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite">Saved.</div>

  <script>
  (function(){
    "use strict";

    const $ = id => document.getElementById(id);

    const coName = $("coName"), coAddr = $("coAddr"), coPhone = $("coPhone"), coEmail = $("coEmail");
    const coLogo = $("coLogo"), logoPreview = $("logoPreview"), removeLogo = $("removeLogo");
    const logoStatus = $("logoStatus");
    const summary = $("summary"), sName = $("sName"), sAddr = $("sAddr"), sPhone = $("sPhone"), sEmail = $("sEmail");
    const toast = $("toast"), errBox = $("err");
    const btnSave = $("save"), btnClear = $("clear");

    // --- Firestore/Storage paths ---
    const FS_DOC_PATH = 'company/main';
    const STORAGE_LOGO_PATH = 'company/logo-main.png';

    let logoDataUrl = "";   // chosen (compressed) logo as data URL (unsaved)
    let logoUrl = "";       // last saved storage URL
    let busy = false;

    // ===== UI helpers =====
    const showToast = (msg="Saved.")=>{
      toast.textContent = msg;
      toast.classList.remove("show"); void toast.offsetWidth; toast.classList.add("show");
    };
    const showErr = (msg)=>{ errBox.textContent = msg || ""; errBox.classList.toggle("show", !!msg); };
    const setBusy = (on)=>{
      busy = !!on;
      [btnSave, btnClear, coLogo, removeLogo].forEach(b => b && (b.disabled = busy));
      logoStatus.textContent = on ? "Working‚Ä¶" : "";
    };
    const escapeHTML = (s)=> String(s||"").replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]));
    const onlyDigits = (s)=> String(s||"").replace(/\D+/g,"");
    function formatUSPhone(s){
      const d = onlyDigits(s);
      if(d.length===11 && d.startsWith("1")) return `+1 (${d.slice(1,4)}) ${d.slice(4,7)}-${d.slice(7,11)}`;
      if(d.length>=10) return `(${d.slice(0,3)}) ${d.slice(3,6)}-${d.slice(6,10)}` + (d.length>10 ? ` x${d.slice(10)}` : "");
      return d;
    }
    const normalizeEmail = (s)=> String(s||"").trim().toLowerCase();
    function isLikelyValidEmail(s){
      const e = normalizeEmail(s);
      if(!/^[^\s@]+@[^\s@]+\.[^\s@]{2,}$/i.test(e)) return false;
      const tld = (e.split(".").pop()||"").toLowerCase();
      if(tld==="con") return false;
      return tld.length>=2 && tld.length<=24;
    }

    coPhone.addEventListener("blur", ()=>{ coPhone.value = formatUSPhone(coPhone.value); });
    coEmail.addEventListener("blur", ()=>{ coEmail.value = normalizeEmail(coEmail.value); });

    // ===== Logo handling =====
    function renderLogo(src){
      logoPreview.innerHTML = "";
      const url = src || logoDataUrl || logoUrl || "";
      if(url){
        const img = new Image();
        img.alt = "Farm logo";
        img.src = url;
        logoPreview.appendChild(img);
      }else{
        const div = document.createElement("div");
        div.className = "help";
        div.textContent = "No logo yet";
        logoPreview.appendChild(div);
      }
    }

    function fileToCompressedDataURL(file, maxSide){
      return new Promise((resolve, reject)=>{
        const fr = new FileReader();
        fr.onerror = reject;
        fr.onload = ()=>{
          const img = new Image();
          img.onload = ()=>{
            const c = document.createElement("canvas");
            const ctx = c.getContext("2d");
            const w = img.naturalWidth || img.width, h = img.naturalHeight || img.height;
            const scale = Math.min(1, maxSide / Math.max(w,h));
            c.width = Math.round(w * scale);
            c.height = Math.round(h * scale);
            ctx.clearRect(0,0,c.width,c.height); // preserve transparency
            ctx.drawImage(img, 0, 0, c.width, c.height);
            resolve(c.toDataURL("image/png"));
          };
          img.onerror = reject;
          img.src = fr.result;
        };
        fr.readAsDataURL(file);
      });
    }

    function dataURLtoBlob(dataUrl){
      const parts = (dataUrl||'').split(',');
      const mime = (parts[0].match(/:(.*?);/)||[])[1] || 'image/png';
      const bin = atob(parts[1]||"");
      const arr = new Uint8Array(bin.length);
      for (let i=0;i<bin.length;i++) arr[i] = bin.charCodeAt(i);
      return new Blob([arr], { type:mime });
    }

    coLogo.addEventListener("change", async ()=>{
      const f = coLogo.files && coLogo.files[0];
      if(!f) return;
      if (f.size > 12 * 1024 * 1024) { showErr("Logo file is too large (max 12 MB)."); return; }
      showErr("");
      try{
        logoStatus.textContent = "Preparing logo‚Ä¶";
        if (f.type === "image/svg+xml") {
          const fr = new FileReader();
          fr.onload = ()=>{ logoDataUrl = String(fr.result||""); renderLogo(logoDataUrl); logoStatus.textContent = "Ready to save."; };
          fr.onerror = (e)=>{ console.error(e); showErr("Could not read SVG."); logoStatus.textContent=""; };
          fr.readAsDataURL(f);
          return;
        }
        logoDataUrl = await fileToCompressedDataURL(f, 1024);
        renderLogo(logoDataUrl);
        logoStatus.textContent = "Ready to save.";
      }catch(e){
        console.error(e);
        showErr("Could not read logo file.");
      }
    });

    removeLogo.addEventListener("click", async ()=>{
      if(!confirm("Remove the saved logo?")) return;
      try{
        setBusy(true);
        showErr("");
        try{
          await firebase.storage().ref(STORAGE_LOGO_PATH).delete();
        }catch(e){ /* ignore if not present or no permission */ }
        await firebase.firestore().doc(FS_DOC_PATH).set({
          logoUrl: "", logoData: "", updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });
        logoUrl = ""; logoDataUrl = "";
        renderLogo("");
        showToast("Logo removed.");
      }catch(e){
        console.error(e); showErr("Failed to remove logo.");
      }finally{
        setBusy(false);
      }
    });

    // ===== Auth + load gating =====
    function waitForAuth(){
      return new Promise(resolve=>{
        try{
          const unsub = firebase.auth().onAuthStateChanged(u=>{ unsub(); resolve(u||null); });
        }catch(e){
          console.warn("Auth not ready yet; retrying‚Ä¶", e);
          setTimeout(async ()=>resolve(await waitForAuth()), 250);
        }
      });
    }

    // ===== Firestore IO =====
    async function loadFromFirestore(){
      showErr("");
      try{
        const snap = await firebase.firestore().doc(FS_DOC_PATH).get();
        if (!snap.exists) {
          // No doc yet: don't error‚Äîjust render empty controls.
          renderLogo("");
          renderSummary({ name:"", address:"", phone:"", email:"" });
          return;
        }
        const d = snap.data()||{};
        coName.value  = d.name   || "";
        coAddr.value  = d.address|| "";
        coPhone.value = d.phone  || "";
        coEmail.value = d.email  ? normalizeEmail(d.email) : "";
        logoUrl       = d.logoUrl|| "";
        logoDataUrl   = d.logoData||"";
        renderLogo(logoUrl || logoDataUrl || "");
        renderSummary({ name: coName.value, address: coAddr.value, phone: coPhone.value, email: coEmail.value });
      }catch(e){
        console.error("Company Details load error:", e);
        const code = (e && e.code) ? ` (${e.code})` : "";
        showErr("Failed to load details"+code+".");
      }
    }

    async function uploadLogoIfNeeded(){
      if (!logoDataUrl) return { logoUrl, logoData:"" }; // nothing new chosen
      try{
        const ref = firebase.storage().ref(STORAGE_LOGO_PATH);
        const blob = dataURLtoBlob(logoDataUrl);
        logoStatus.textContent = "Uploading logo‚Ä¶";
        await ref.put(blob, {
          contentType: blob.type || 'image/png',
          cacheControl: 'public,max-age=31536000,immutable',
          customMetadata: { app: 'FarmVista', kind: 'company-logo' }
        });
        const url = await ref.getDownloadURL();
        logoStatus.textContent = "Logo uploaded.";
        return { logoUrl: url, logoData:"" }; // prefer URL
      }catch(e){
        console.warn("Storage upload failed, falling back to inline data URL:", e);
        logoStatus.textContent = "Using inline logo.";
        return { logoUrl:"", logoData: logoDataUrl };
      }
    }

    async function saveToFirestore(){
      if (busy) return;
      const name = coName.value.trim();
      if(!name){ showErr("Please enter the farm/company name."); return; }
      setBusy(true); showErr("");

      const phoneFormatted = formatUSPhone(coPhone.value);
      const emailNorm = normalizeEmail(coEmail.value);
      const emailToStore = isLikelyValidEmail(emailNorm) ? emailNorm : "";

      try{
        const logoRes = await uploadLogoIfNeeded();
        const payload = {
          name,
          address: coAddr.value.trim(),
          phone: phoneFormatted,
          email: emailToStore,
          logoUrl: logoRes.logoUrl,
          logoData: logoRes.logoData,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        await firebase.firestore().doc(FS_DOC_PATH).set(payload, { merge:true });
        logoUrl = logoRes.logoUrl;
        renderSummary({ name: payload.name, address: payload.address, phone: payload.phone, email: payload.email });
        showToast("Saved.");
        logoStatus.textContent = logoRes.logoUrl ? "Logo linked." : (logoRes.logoData ? "Logo embedded." : "");
      }catch(e){
        console.error("Company Details save error:", e);
        const code = (e && e.code) ? ` (${e.code})` : "";
        showErr("Save failed"+code+". Check permissions or network.");
      }finally{
        setBusy(false);
      }
    }

    // ===== Summary =====
    function renderSummary(obj){
      sName.textContent  = obj.name ? obj.name : "‚Äî";
      sAddr.innerHTML    = obj.address ? escapeHTML(obj.address).replace(/\n/g,"<br>") : "‚Äî";
      sPhone.textContent = obj.phone ? formatUSPhone(obj.phone) : "‚Äî";
      sEmail.textContent = obj.email && isLikelyValidEmail(obj.email) ? obj.email : "Not available";
      summary.hidden = false;
    }

    // ===== Wire buttons =====
    btnSave.addEventListener("click", saveToFirestore);
    btnClear.addEventListener("click", ()=>{
      if(busy) return;
      if(!confirm("Clear unsaved changes?")) return;
      coName.value = ""; coAddr.value = ""; coPhone.value = ""; coEmail.value = "";
      logoDataUrl = ""; renderLogo(""); logoStatus.textContent = "";
      showErr("");
    });

    // ===== Init after boot =====
    document.addEventListener('DOMContentLoaded', async ()=>{
      if(!(window.firebase && firebase.firestore && firebase.storage && firebase.auth)){
        console.error('Firebase SDK not available via theme-boot.js'); showErr("Failed to load details (sdk)."); return;
      }
      // Wait for a real auth user before reading (avoids rules ‚Äúpermission-denied‚Äù on first paint)
      await waitForAuth();
      await loadFromFirestore();
    });
  })();
  </script>
</body>
</html>