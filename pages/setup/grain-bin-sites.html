<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista • Setup → Grain Bin Sites</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <script src="/Farm-vista/js/theme-boot.js"></script>

  <!-- Standard includes -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>
  

  <!-- ✅ Permission UI controller -->
  <script src="/Farm-vista/js/perm-ui.js"></script>

  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <!-- Firebase config -->
  <script src="/Farm-vista/js/firebase-config.js"></script>

  <style>
    .page{max-width:1100px;margin:0 auto;padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + 96px)!important;}
    .page-title{margin:0 0 8px 0;}
    .page-sub{margin:0 0 14px 0;color:var(--muted,#67706B);}

    .section{border:1px solid var(--border);border-radius:14px;background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));overflow:hidden;}
    .section-head{display:grid;grid-template-columns:36px 1fr;gap:12px;align-items:center;
      padding:14px 16px;border-bottom:1px solid var(--border);
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);}
    .section-head .icon{width:24px;height:24px;color:#2F6C3C;display:grid;place-items:center;}
    .section-body{padding:16px;display:grid;gap:14px;}

    /* Align Site Name + buttons along the bottom on desktop */
    .row{display:grid;gap:10px;grid-template-columns:1fr auto;align-items:end;}
    @media(max-width:720px){
      .row{grid-template-columns:1fr;align-items:stretch;}
    }

    .field label{display:block;font-weight:800;margin:0 0 6px 0;}
    .input, .select{width:100%;font:inherit;font-size:16px;color:var(--text);
      background:var(--card-surface,var(--surface));border:1px solid var(--border);
      border-radius:10px;padding:12px;outline:none;}

    .actions{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .btn{display:inline-flex;align-items:center;justify-content:center;min-width:148px;padding:12px 16px;border-radius:12px;
      border:1px solid var(--border);background:var(--card-surface,var(--surface));font-weight:800;color:var(--text);cursor:pointer;}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .btn-primary{border-color:transparent;background:#2F6C3C;color:#fff;}
    .btn-danger{border-color:#b3261e;color:#b3261e;background:var(--surface);}
    .btn-quiet{min-width:auto;padding:8px 12px}

    /* Bins card */
    .bins-card{border:1px dashed var(--border);border-radius:12px;padding:12px;display:grid;gap:12px;background:var(--card-surface,var(--surface));}
    .bins-head{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .bins-head-add{justify-content:flex-end;}
    .bins-title{font-weight:800}
    .bins-title-wrap{display:flex;align-items:center;gap:8px;}
    .bin-row{display:grid;grid-template-columns:120px 1fr auto;gap:10px;align-items:center}
    @media(max-width:720px){.bin-row{grid-template-columns:90px 1fr auto}}
    .bin-num{display:flex;align-items:center;gap:8px}
    .bin-num .badge{min-width:44px;text-align:center;border:1px solid var(--border);border-radius:8px;padding:8px 10px;background:var(--surface);font-weight:800}
    .bin-remove{border:1px solid var(--border);background:var(--surface);border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer;color:var(--text) !important;}

    .totals{display:flex;gap:12px;flex-wrap:wrap;align-items:center;justify-content:flex-end}
    .pill{font-size:13px;border:1px solid var(--border);padding:6px 10px;border-radius:999px;color:var(--muted,#67706B);background:var(--surface);}

    /* List */
    .list-head{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-top:1px solid var(--border);}
    .list-title{font-size:clamp(18px,2.6vw,22px);font-weight:800;}
    .list{padding:14px 16px;display:grid;gap:12px;}
    .item{border:1px solid var(--border);border-radius:12px;padding:12px;background:var(--card-surface,var(--surface));
      display:flex;align-items:center;justify-content:space-between;gap:12px;}
    .item-main{display:flex;flex-direction:column;gap:6px;flex:1 1 auto;}
    .item-meta{display:flex;align-items:center;flex-wrap:wrap;gap:6px;}
    .name{font-weight:800}
    .view{border:1px solid var(--border);background:var(--surface);border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer;color:var(--text) !important;align-self:center;}

    /* Modal */
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.42);z-index:9999;transition:opacity .15s;opacity:0;}
    .modal[open]{display:grid;opacity:1;}
    .dialog{width:min(760px,92vw);max-height:85vh;display:flex;flex-direction:column;background:var(--surface);color:var(--text);
      border-radius:14px;border:1px solid var(--border);box-shadow:0 16px 36px rgba(0,0,0,.28);}
    .dialog-sm{width:min(480px,92vw);}
    .dialog-head{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;}
    .dialog-body{padding:14px;display:grid;gap:12px;overflow:auto}
    .dialog-footer{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;padding:12px 14px;border-top:1px solid var(--border)}
    .left-btns{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .closex{border:1px solid var(--border);background:var(--surface);border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:700;color:var(--text) !important;}

    .info-ico{
      border-radius:999px;border:1px solid var(--border);background:var(--surface);
      width:28px;height:28px;display:inline-flex;align-items:center;justify-content:center;
      font-size:14px;font-weight:800;cursor:pointer;color:var(--muted,#67706B);flex-shrink:0;
    }

    /* Toast + error */
    .toast{position:fixed;left:50%;bottom:calc(env(safe-area-inset-bottom,0px) + 72px);transform:translateX(-50%);
      background:#2F6C3C;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.25);z-index:99999;display:none;}
    .toast.show{display:block;animation:fadeout 2.8s forwards;}
    @keyframes fadeout{0%{opacity:1}85%{opacity:1}100%{opacity:0}}
    .error{border:1px solid #b3261e;background:#fff;color:#b3261e;border-radius:10px;padding:10px 12px;display:none}
    .error.show{display:block}

    .muted{ color:var(--muted,#67706B); }
  </style>

  <script>(function(){
    if(!customElements.get('fv-shell')){
      const s=document.createElement('script');s.src='/Farm-vista/js/fv-shell.js';s.defer=true;document.head.appendChild(s);
    }
  })();</script>
</head>

<body>
  <fv-shell>
    <div class="page container" data-perm="setup-grain-sites:view">
      <h1 class="page-title">Grain Bin Sites</h1>
      <p class="page-sub">Create a site, add bins with <strong>rated corn bushel</strong> capacity, and we’ll total it up for you.</p>

      <section class="section">
        <header class="section-head">
          <div class="icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round">
              <path d="M6.5 7 L12 3.8 L17.5 7"/><rect x="7" y="7" width="10" height="13" rx="1.6"/>
              <path d="M10 7v13M14 7v13" stroke-linecap="round"/>
            </svg>
          </div>
          <div><strong>Add Bin Site</strong></div>
        </header>

        <div class="section-body" data-perm="setup-grain-sites:add">
          <div id="err" class="error"></div>

          <div class="row">
            <div class="field">
              <label for="siteName">Site Name</label>
              <input id="siteName" class="input" placeholder="e.g., Home Site">
            </div>
            <div class="actions">
              <button id="clear" class="btn" type="button">Clear</button>
              <button id="save" class="btn btn-primary" type="button">Save</button>
            </div>
          </div>

          <div class="bins-card">
            <div class="bins-head bins-head-add">
              <button id="addBin" class="btn" type="button">Add Bin</button>
            </div>
            <div id="bins"></div>
          </div>
        </div>

        <div class="list-head">
          <div class="list-title">Bin Sites</div>
        </div>
        <div id="list" class="list">
          <div class="muted">No bin sites yet.</div>
        </div>
      </section>
    </div>
  </fv-shell>

  <div id="toast" class="toast" role="status" aria-live="polite">Successfully saved.</div>

  <!-- Modal: Add Bin -->
  <div id="binModal" class="modal" aria-hidden="true">
    <div class="dialog dialog-sm" role="dialog" aria-modal="true" aria-labelledby="binMdTitle">
      <div class="dialog-head">
        <h3 id="binMdTitle">Add Bin</h3>
        <button id="binMdClose" class="closex" type="button">Back</button>
      </div>
      <div class="dialog-body" data-perm="setup-grain-sites:add">
        <div class="field">
          <label for="binBushels">Bushels</label>
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
            <input id="binBushels" class="input" placeholder="Bushels (corn bu)" inputmode="decimal">
            <button
              id="binInfoBtn"
              class="info-ico"
              type="button"
              title="These bushels are rated for corn. Other crop capacities will be calculated automatically based on their crop conversion factors.">
              i
            </button>
          </div>
        </div>
      </div>
      <div class="dialog-footer">
        <span></span>
        <button id="binMdSave" class="btn btn-primary" type="button" data-perm="setup-grain-sites:add">Add Bin</button>
      </div>
    </div>
  </div>

  <!-- Modal: View/Edit -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="mdTitle">
      <div class="dialog-head">
        <h3 id="mdTitle">View / Edit Bin Site</h3>
        <button id="mdClose" class="closex" type="button">Back</button>
      </div>

      <div class="dialog-body" data-perm="setup-grain-sites:edit">
        <div class="field">
          <label for="editName">Site Name</label>
          <input id="editName" class="input" placeholder="Site name">
        </div>

        <div class="bins-card">
          <div class="bins-head">
            <div class="bins-title-wrap">
              <div class="bins-title">Bushels</div>
              <button
                id="mdInfoBtn"
                class="info-ico"
                type="button"
                title="These bushels are rated for corn. Other crop capacities will be calculated automatically based on their crop conversion factors.">
                i
              </button>
            </div>
            <button id="mdAddBin" class="btn" type="button" data-perm="setup-grain-sites:edit">Add Bin</button>
          </div>
          <div id="mdBins"></div>
          <div class="totals">
            <span class="pill" id="mdBinCountPill">0 bins</span>
            <span class="pill" id="mdBushelTotalPill">0 corn bu</span>
          </div>
        </div>

        <div class="field" id="statusRow">
          <span class="pill" id="statusPill">Active</span>
          <span class="pill" id="usedPill" style="display:none">In use</span>
        </div>
      </div>

      <div class="dialog-footer">
        <div class="left-btns">
          <button id="mdArchive" class="btn btn-quiet" type="button" data-perm="setup-grain-sites:edit">Archive</button>
          <button id="mdDelete" class="btn btn-danger" type="button" title="Delete is disabled if the site is in use." data-perm="setup-grain-sites:delete">Delete</button>
        </div>
        <button id="mdSave" class="btn btn-primary" type="button" data-perm="setup-grain-sites:edit">Save Changes</button>
      </div>
    </div>
  </div>

  <script type="module">
    import {
      ready,
      getFirestore,
      collection,
      addDoc,
      getDocs,
      getDoc,
      setDoc,
      deleteDoc,
      doc,
      serverTimestamp
    } from '/Farm-vista/js/firebase-init.js';

    (function(){
      "use strict";

      const canNow = (k)=> (window.FV && typeof window.FV.can === 'function') ? window.FV.can(k) : true;

      const $ = id => document.getElementById(id);
      const toast = $("toast");
      const errBox = $("err");

      const binsBox = $("bins");
      const addBtn = $("addBin"), saveBtn = $("save"), clearBtn = $("clear");
      const siteName = $("siteName");

      const binModal = $("binModal"), binMdClose = $("binMdClose"), binMdSave = $("binMdSave");
      const binBushels = $("binBushels"), binMdTitle = $("binMdTitle");

      const listBox = $("list");
      const modal = $("modal"), mdClose = $("mdClose"), mdSave = $("mdSave"), mdArchive = $("mdArchive"), mdDelete = $("mdDelete");
      const mdName = $("editName"), mdBinsBox = $("mdBins"), mdBinCountPill = $("mdBinCountPill"), mdBushelTotalPill = $("mdBushelTotalPill");
      const statusPill = $("statusPill"), usedPill = $("usedPill");

      let db = null;

      let addBins = [];
      let editId = null;
      let mdBins = [];
      let pendingBinNum = null;
      let lockedBinNums = new Set();

      const COLL = 'binSites';

      const showToast = (msg="Successfully saved.")=>{
        toast.textContent = msg;
        toast.classList.remove("show"); void toast.offsetWidth;
        toast.style.display = 'block';
        toast.classList.add("show");
        setTimeout(()=>{ toast.classList.remove("show"); toast.style.display='none'; }, 2800);
      };
      const showErr = (msg)=>{ if(!errBox) return; errBox.textContent = msg||""; errBox.classList.toggle("show", !!msg); };

      const escapeHTML = (s)=> String(s||"").replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]));

      const fmtComma = (n)=>{
        if(n==null||n==="") return "";
        const num = Number(String(n).replace(/,/g,""));
        if(!isFinite(num)) return String(n);
        return num.toLocaleString();
      };

      const formatNumericString = (str)=>{
        if(str == null) return "";
        const clean = String(str).replace(/,/g,"").trim();
        if(clean === "") return "";
        const parts = clean.split(".");
        const intPart = parts[0].replace(/[^\d]/g,"");
        const decPart = parts[1]?.replace(/[^\d]/g,"");
        const intWithCommas = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        return decPart ? `${intWithCommas}.${decPart}` : intWithCommas;
      };

      const toNum = (v)=> {
        const n = Number(String(v||"").replace(/,/g,"").trim());
        return isFinite(n) ? n : 0;
      };

      const nextBinNumber = (list)=> list.length ? (Math.max(...list.map(b=>Number(b.num)||0)) + 1) : 1;

      function updateTotals(list, pills){
        if(!pills || !pills.count || !pills.total) return;
        const count = list.length;
        const total = list.reduce((s,b)=> s + toNum(b.bushels), 0);
        pills.count.textContent = `${count} ${count===1?'bin':'bins'}`;
        pills.total.textContent = `${fmtComma(total)} corn bu`;
      }

      function attachCommaInput(el, binObj, list, pills){
        el.addEventListener("input", (e)=>{
          const input = e.target;
          const rawBefore = input.value;
          const cursorPos = input.selectionStart || 0;

          const plainBeforeCursor = rawBefore.slice(0, cursorPos).replace(/,/g,"");
          const plainAll = rawBefore.replace(/,/g,"");

          if(plainAll === ""){
            binObj.bushels = 0;
            input.value = "";
            updateTotals(list, pills);
            return;
          }

          const numeric = toNum(plainAll);
          binObj.bushels = numeric;

          const formatted = formatNumericString(plainAll);
          input.value = formatted;

          const digitsUpToCursor = plainBeforeCursor.length;
          let newPos = 0;
          let digitCount = 0;
          for(let i=0;i<formatted.length;i++){
            if(/\d/.test(formatted[i])) digitCount++;
            if(digitCount >= digitsUpToCursor){ newPos = i+1; break; }
          }
          input.setSelectionRange(newPos,newPos);

          updateTotals(list, pills);
        });
      }

      function renderBins(list, box, pills, opts={}){
        const locked = opts.lockedBinNums || new Set();
        box.innerHTML = "";
        list.forEach((b, idx)=>{
          const row = document.createElement("div");
          row.className = "bin-row";
          row.innerHTML = `
            <div class="bin-num"><span class="badge">Bin ${escapeHTML(b.num)}</span></div>
            <input class="input bu" placeholder="Bushels (corn bu)" inputmode="decimal" value="${escapeHTML(formatNumericString(b.bushels))}">
            <button type="button" class="bin-remove">Remove</button>
          `;
          const bu = row.querySelector(".bu");
          attachCommaInput(bu, b, list, pills);

          const removeBtn = row.querySelector(".bin-remove");
          const isLocked = locked.has(String(b.num));
          if(isLocked){
            removeBtn.disabled = true;
            removeBtn.title = "This bin has grain on hand and cannot be removed.";
          }else{
            removeBtn.addEventListener("click", ()=>{
              if(opts.requireEditPerm && !canNow('setup-grain-sites:edit')) return;
              list.splice(idx,1);
              renderBins(list, box, pills, opts);
            });
          }

          box.appendChild(row);
        });
        updateTotals(list, pills);
      }

      function openBinModal(){
        if(!canNow('setup-grain-sites:add')){
          alert("You don't have permission to add bin sites.");
          return;
        }
        pendingBinNum = nextBinNumber(addBins);
        binMdTitle.textContent = `Add Bin ${pendingBinNum}`;
        binBushels.value = "";
        binModal.setAttribute("open",""); binModal.setAttribute("aria-hidden","false");
        document.documentElement.classList.add("no-scroll"); document.body.classList.add("no-scroll");
        setTimeout(()=> binBushels.focus(), 0);
      }
      function closeBinModal(){
        binModal.removeAttribute("open"); binModal.setAttribute("aria-hidden","true");
        document.documentElement.classList.remove("no-scroll"); document.body.classList.remove("no-scroll");
        pendingBinNum = null;
      }

      addBtn.addEventListener("click", openBinModal);
      binMdClose.addEventListener("click", closeBinModal);
      binModal.addEventListener("click", e=>{ if(e.target===binModal) closeBinModal(); });
      document.addEventListener("keydown", e=>{
        if(e.key==="Escape" && binModal.hasAttribute("open")) closeBinModal();
      });

      binMdSave.addEventListener("click", ()=>{
        if(!canNow('setup-grain-sites:add')){
          alert("You don't have permission to add bins.");
          return;
        }
        const bu = toNum(binBushels.value);
        if(!bu || bu <= 0){
          alert("Please enter bushels for this bin.");
          return;
        }
        const num = pendingBinNum || nextBinNumber(addBins);
        addBins.push({ num, bushels: bu });
        renderBins(addBins, binsBox, null, {});
        closeBinModal();
      });

      clearBtn.addEventListener("click", ()=>{
        siteName.value = "";
        addBins = [];
        renderBins(addBins, binsBox, null, {});
        showErr("");
      });

      async function fetchSites(){
        const snap = await getDocs(collection(db, COLL));
        const arr = [];
        snap.forEach(d=>{
          const v = d.data()||{};
          arr.push({ id:d.id, ...v });
        });
        arr.sort((a,b)=>{
          const sa = (a.status||'active')==='archived', sb = (b.status||'active')==='archived';
          const ta = a.updatedAt?.seconds || a.createdAt?.seconds || 0;
          const tb = b.updatedAt?.seconds || b.createdAt?.seconds || 0;
          return (sa - sb) || (tb - ta);
        });
        return arr;
      }

      async function renderList(){
        const items = await fetchSites();
        if(!items.length){
          listBox.innerHTML = '<div class="muted">No bin sites yet.</div>';
          return;
        }
        listBox.innerHTML = "";
        items.forEach(it=>{
          const div = document.createElement("div");
          div.className = "item";
          const binsCount = (it.bins||[]).length;
          const pills = `
            <span class="pill">${binsCount} ${binsCount===1?'bin':'bins'}</span>
            <span class="pill">${fmtComma(it.totalBushels||0)} corn bu</span>
            ${(it.status==='archived') ? `<span class="pill">Archived</span>` : ""}
          `;
          div.innerHTML = `
            <div class="item-main">
              <div class="name">${escapeHTML(it.name||'(Unnamed)')}</div>
              <div class="item-meta">
                ${pills}
              </div>
            </div>
            <button class="view" type="button" data-perm="setup-grain-sites:view">View / Edit</button>
          `;
          div.querySelector(".view").addEventListener("click", ()=> openEdit(it.id));
          listBox.appendChild(div);
        });
      }

      function openModal(){
        modal.setAttribute("open",""); modal.setAttribute("aria-hidden","false");
        document.documentElement.classList.add("no-scroll"); document.body.classList.add("no-scroll");
        setTimeout(()=> mdName.focus(), 0);
      }
      function closeModal(){
        modal.removeAttribute("open"); modal.setAttribute("aria-hidden","true");
        document.documentElement.classList.remove("no-scroll"); document.body.classList.remove("no-scroll");
        editId = null;
        lockedBinNums = new Set();
      }
      mdClose.addEventListener("click", closeModal);
      modal.addEventListener("click", e=>{ if(e.target===modal) closeModal(); });
      document.addEventListener("keydown", e=>{
        if(e.key==="Escape" && modal.hasAttribute("open")) closeModal();
      });

      async function openEdit(id){
        try{
          const snap = await getDoc(doc(db, COLL, id));
          if(!snap.exists()) return;
          const it = snap.data()||{};
          editId = id;

          mdName.value = it.name || "";

          const totalOnHand = Number(it.totalOnHand || 0);
          lockedBinNums = new Set();

          const rawBins = (it.bins||[]).map(b=>{
            const num = Number(b.num)||0;
            const bu = Number(b.bushels)||0;
            const onHand = Number(b.onHand || 0);
            if(onHand > 0) lockedBinNums.add(String(num));
            return { num, bushels: bu, onHand };
          });

          mdBins = rawBins.map(b=>({ num:b.num, bushels:b.bushels }));

          const hasGrain = (totalOnHand > 0) || rawBins.some(b=> b.onHand > 0);
          const used = !!it.used;

          statusPill.textContent = (it.status==='archived') ? "Archived" : "Active";
          usedPill.style.display = used ? "inline-block" : "none";
          mdArchive.textContent = (it.status==='archived') ? "Unarchive" : "Archive";

          if(hasGrain){
            mdArchive.disabled = true;
            mdArchive.title = "This site has grain on hand and cannot be archived. Move grain out of all bins first.";
            mdDelete.disabled = true;
            mdDelete.title = "This site has grain on hand and cannot be deleted.";
          }else{
            if(used){
              mdArchive.disabled = false;
              mdArchive.title = "Archive this site.";
              mdDelete.disabled = true;
              mdDelete.title = "This site has been used and cannot be deleted. Archive instead.";
            }else{
              mdArchive.disabled = true;
              mdArchive.title = "This site has never been used and does not need to be archived.";
              mdDelete.disabled = false;
              mdDelete.title = "Delete this unused site.";
            }
          }

          renderBins(mdBins, mdBinsBox, {count:mdBinCountPill,total:mdBushelTotalPill}, {
            lockedBinNums,
            requireEditPerm: true
          });

          openModal();
        }catch(e){
          console.error(e);
          showErr("Failed to open site.");
        }
      }

      $("mdAddBin").addEventListener("click", ()=>{
        if(!canNow('setup-grain-sites:edit')){
          alert("You don't have permission to edit bin sites.");
          return;
        }
        mdBins.push({ num: nextBinNumber(mdBins), bushels: 0 });
        renderBins(mdBins, mdBinsBox, {count:mdBinCountPill,total:mdBushelTotalPill}, { lockedBinNums, requireEditPerm:true });
      });

      saveBtn.addEventListener("click", async ()=>{
        if(!canNow('setup-grain-sites:add')){
          alert("You don't have permission to add bin sites.");
          return;
        }
        const name = siteName.value.trim();
        if(!name){ alert("Please enter a site name."); return; }
        if(addBins.length === 0){ alert("Please add at least one bin before saving."); return; }

        const bins = addBins.map(b=>({ num: Number(b.num)||0, bushels: toNum(b.bushels) }));
        const set = new Set(); let dup=false;
        bins.forEach(b=>{ const k=String(b.num); if(set.has(k)) dup=true; set.add(k); });
        if(dup){ alert("Duplicate bin numbers. Please adjust."); return; }

        const total = bins.reduce((s,b)=> s + (b.bushels||0), 0);

        try{
          showErr("");
          await addDoc(collection(db, COLL), {
            name,
            bins,
            totalBushels: total,
            status: 'active',
            used: false,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          });
          showToast("Successfully saved.");
          siteName.value = "";
          addBins = [];
          renderBins(addBins, binsBox, null, {});
          await renderList();
          window.scrollTo({top:0, behavior:"smooth"});
        }catch(e){
          console.error(e);
          showErr("Save failed. Check permissions or network.");
        }
      });

      mdSave.addEventListener("click", async ()=>{
        if(!canNow('setup-grain-sites:edit')){
          alert("You don't have permission to edit bin sites.");
          return;
        }
        const name = mdName.value.trim();
        if(!name){ alert("Please enter a site name."); return; }
        if(mdBins.length === 0){ alert("Please keep at least one bin on the site."); return; }

        const bins = mdBins.map(b=>({ num:Number(b.num)||0, bushels: toNum(b.bushels) }));
        const usedNums = new Set(); let dup=false;
        bins.forEach(b=>{ const k=String(b.num); if(usedNums.has(k)) dup=true; usedNums.add(k); });
        if(dup){ alert("Duplicate bin numbers. Please adjust."); return; }

        const total = bins.reduce((s,b)=> s + (b.bushels||0), 0);

        try{
          await setDoc(doc(db, COLL, editId), {
            name,
            bins,
            totalBushels: total,
            updatedAt: serverTimestamp()
          }, { merge:true });
          showToast("Changes saved.");
          await renderList();
          closeModal();
        }catch(e){
          console.error(e);
          showErr("Update failed.");
        }
      });

      mdArchive.addEventListener("click", async ()=>{
        if(!canNow('setup-grain-sites:edit')){
          alert("You don't have permission to archive/unarchive bin sites.");
          return;
        }
        if(mdArchive.disabled) return;

        try{
          const snap = await getDoc(doc(db, COLL, editId));
          if(!snap.exists()) return;
          const cur = snap.data()||{};
          const next = (cur.status==='archived') ? 'active' : 'archived';

          const totalOnHand = Number(cur.totalOnHand || 0);
          if(totalOnHand > 0){
            alert("This site has grain on hand and cannot be archived.");
            return;
          }

          await setDoc(doc(db, COLL, editId), { status: next, updatedAt: serverTimestamp() }, { merge:true });

          showToast(next==='archived' ? "Site archived." : "Site unarchived.");
          await renderList();
          statusPill.textContent = (next==='archived') ? 'Archived' : 'Active';
          mdArchive.textContent = (next==='archived') ? 'Unarchive' : 'Archive';
        }catch(e){
          console.error(e);
          showErr("Archive toggle failed.");
        }
      });

      mdDelete.addEventListener("click", async ()=>{
        if(!canNow('setup-grain-sites:delete')){
          alert("You don't have permission to delete bin sites.");
          return;
        }
        if(mdDelete.disabled) return;

        try{
          const snap = await getDoc(doc(db, COLL, editId));
          if(!snap.exists()) return;
          const cur = snap.data()||{};

          const totalOnHand = Number(cur.totalOnHand || 0);
          if(totalOnHand > 0){
            alert("This site has grain on hand and cannot be deleted.");
            return;
          }
          if(cur.used){
            alert("This site has been used and cannot be deleted. Archive instead.");
            return;
          }

          if(!confirm(`Delete site "${cur.name||''}"? This cannot be undone.`)) return;

          await deleteDoc(doc(db, COLL, editId));
          showToast("Site deleted.");
          await renderList();
          closeModal();
        }catch(e){
          console.error(e);
          showErr("Delete failed.");
        }
      });

      (async ()=>{
        try{
          await ready;
          db = getFirestore();
        }catch(e){
          console.warn(e);
          showErr("Firebase not ready.");
          return;
        }

        renderBins(addBins, binsBox, null, {});
        await renderList();
      })();

    })();
  </script>
</body>
</html>
