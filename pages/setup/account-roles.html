<!doctype html><html lang="en"><head>
  <meta charset="utf-8"/>
  <title>FarmVista â€¢ Setup â†’ Account Roles</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- Standard includes -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <style>
    body{background:var(--app-bg,var(--surface));min-height:100vh}
    .page{max-width:1100px;margin:0 auto;padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + 96px)!important;}
    .page-title{margin:0 0 8px 0;}
    .page-sub{margin:0 0 14px 0;color:var(--muted,#67706B);}

    .section{border:1px solid var(--border);border-radius:14px;background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));overflow:hidden;}
    .section-head{display:grid;grid-template-columns:36px 1fr;gap:12px;align-items:center;
      padding:14px 16px;border-bottom:1px solid var(--border);
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);}
    .section-head .icon{width:24px;height:24px;color:#2F6C3C;display:grid;place-items:center;}
    .section-body{padding:16px;display:grid;gap:14px;}

    .row{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    @media(max-width:900px){.row{grid-template-columns:1fr}}
    .field label{display:block;font-weight:800;margin:0 0 6px 0;}
    .input, .select{
      width:100%;font:inherit;font-size:16px;color:var(--text);
      background:var(--card-surface,var(--surface));border:1px solid var(--border);
      border-radius:10px;padding:12px;outline:none;}
    .actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{display:inline-flex;align-items:center;justify-content:center;min-width:140px;padding:10px 14px;border-radius:12px;
      border:1px solid var(--border);background:var(--card-surface,var(--surface));font-weight:800;color:var(--text);cursor:pointer;}
    .btn-primary{border-color:transparent;background:#2F6C3C;color:#fff;}
    .btn-danger{border-color:#b3261e;color:#b3261e;background:var(--surface);}
    .btn-quiet{min-width:auto;padding:8px 12px}

    /* Tree */
    .tree{border:1px solid var(--border);border-radius:12px;padding:10px;background:var(--card-surface,var(--surface));}
    details.node{border:1px solid var(--border);border-radius:10px;background:var(--surface);margin:8px 0;}
    summary{cursor:pointer;padding:10px 12px}
    .sum-line{display:flex;align-items:center;gap:10px}
    .indent-0{padding-left:0}
    .indent-1{padding-left:12px}
    .indent-2{padding-left:24px}
    .indent-3{padding-left:36px}
    .indent-4{padding-left:48px}
    .label{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

    .content{padding:8px 12px 12px}
    .pill-col{display:grid;gap:6px;grid-auto-flow:row;margin-bottom:8px}
    @media(min-width:840px){ .pill-col{grid-auto-flow:column} }
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:6px 10px;
      font-weight:800;background:var(--surface);color:var(--text);cursor:pointer;user-select:none;min-height:36px}
    .pill[data-on="true"]{background:#2F6C3C;color:#fff;border-color:#2F6C3C;}
    .tiny{font-size:12px;opacity:.92;font-weight:700}

    .children{display:grid;gap:6px}

    /* Toast */
    .toast{position:fixed;left:50%;bottom:calc(env(safe-area-inset-bottom,0px) + 72px);transform:translateX(-50%);
      background:#2F6C3C;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.25);z-index:99999;display:none;}
    .toast.show{display:block;animation:fadeout 2.8s forwards;}
    @keyframes fadeout{0%{opacity:1}85%{opacity:1}100%{opacity:0}}
  </style>

  <!-- Make NAV available so we can mirror it -->
  <script type="module">
    import NAV_MENU from '/Farm-vista/js/menu.js';
    window.FV_NAV_MENU = NAV_MENU;
    window.dispatchEvent(new Event('fv:menu-ready'));
  </script>

  <!-- Ensure fv-shell is loaded (same pattern as others) -->
  <script>(function(){
    if(!customElements.get('fv-shell')){
      const s=document.createElement('script');s.src='/Farm-vista/js/fv-shell.js';s.defer=true;document.head.appendChild(s);
    }
  })();</script>
</head><body>
  <fv-shell>
    <div class="page container">
      <h1 class="page-title">Account Roles</h1>
      <p class="page-sub">Create a role, then expand menus to choose what the role can see and do. Group switches cascade to children; open a child to override.</p>

      <!-- Role header -->
      <section class="section">
        <header class="section-head">
          <div class="icon" aria-hidden="true">ðŸ‘¥</div>
          <div><strong>Role Details</strong></div>
        </header>
        <div class="section-body">
          <div class="row">
            <div class="field">
              <label for="rolePicker">Existing Roles</label>
              <select id="rolePicker" class="select">
                <option value="">â€” New role â€”</option>
              </select>
            </div>
            <div class="field">
              <label for="roleName">Role Name</label>
              <input id="roleName" class="input" placeholder="e.g., Seasonal Operator">
            </div>
          </div>

          <div class="actions">
            <button id="newRole" class="btn" type="button">New</button>
            <button id="saveRole" class="btn btn-primary" type="button">Save Role</button>
            <button id="deleteRole" class="btn btn-danger" type="button">Delete Role</button>
          </div>
        </div>
      </section>

      <!-- Permissions tree -->
      <section class="section">
        <header class="section-head">
          <div class="icon" aria-hidden="true">ðŸ”’</div>
          <div><strong>Permissions</strong></div>
        </header>
        <div class="section-body">
          <div class="actions">
            <button id="expandAll" class="btn btn-quiet" type="button">Expand All</button>
            <button id="collapseAll" class="btn btn-quiet" type="button">Collapse All</button>
          </div>
          <div id="tree" class="tree" aria-live="polite"></div>
        </div>
      </section>
    </div>
  </fv-shell>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite">Saved.</div>

  <script>
  (function(){
    "use strict";
    const $ = id => document.getElementById(id);
    const toast = $("toast");
    const LS_ROLES = "fv_account_roles_v1";

    let currentRoleId = "";
    let roleDraft = { id:"", name:"", perms:{} };

    function showToast(msg="Saved."){ toast.textContent = msg; toast.classList.remove("show"); void toast.offsetWidth; toast.classList.add("show"); }
    function uid(){ return String(Date.now()) + Math.random().toString(36).slice(2,7); }
    function loadRoles(){ try{ const a=JSON.parse(localStorage.getItem(LS_ROLES)||"[]"); return Array.isArray(a)?a:[]; }catch(e){ return []; } }
    function saveRoles(arr){ localStorage.setItem(LS_ROLES, JSON.stringify(arr)); }
    function getMenu(){ return window.FV_NAV_MENU; }

    /* ===== Build a simple tree from NAV (labels only; hide Home) ===== */
    function flatten(items, depth=0, parent=null, out=[]){
      items.forEach(it=>{
        if(it.id === "home") return; // hide Home dashboard from roles UI
        const node = { id: it.id, type: it.type, label: it.label, depth, parent, children: (it.children||[]).map(c=>c.id) };
        out.push(node);
        if(it.children && it.children.length) flatten(it.children, depth+1, it.id, out);
      });
      return out;
    }

    /* ===== Permissions ===== */
    function defPerm(node){
      return node.type==="group"
        ? { visible:true, view:false, add:false, edit:false, archive:false }
        : { visible:true, view:true,  add:false, edit:false, archive:false };
    }
    function ensurePerm(nodeId, nodeObj){
      if(!roleDraft.perms[nodeId]) roleDraft.perms[nodeId] = defPerm(nodeObj);
      return roleDraft.perms[nodeId];
    }

    /* ===== Render ===== */
    function renderTree(){
      const NAV = getMenu();
      const tree = $("tree");
      if(!NAV){ tree.textContent = "Menu not available."; return; }

      const flat = flatten(NAV.items);
      const byId = Object.fromEntries(flat.map(n=>[n.id,n]));
      const byParent = {};
      flat.forEach(n=>{
        const p = n.parent || "__ROOT__";
        (byParent[p]||(byParent[p]=[])).push(n);
      });

      function cascade(nodeId, key, value){
        const stack = (byParent[nodeId]||[]).slice();
        while(stack.length){
          const n = stack.pop();
          const cur = ensurePerm(n.id, n);
          cur[key] = value;
          if(n.type==="group"){ (byParent[n.id]||[]).forEach(c=>stack.push(c)); }
        }
      }

      function makePill(label, key, node, isGroup){
        const btn = document.createElement("button");
        btn.type = "button"; btn.className="pill";
        const state = !!ensurePerm(node.id, node)[key];
        btn.dataset.on = String(state);
        btn.setAttribute("role","switch");
        btn.setAttribute("aria-checked", String(state));
        btn.innerHTML = `<span class="tiny">${label}</span>`;
        btn.addEventListener("click", (e)=>{
          e.stopPropagation();
          const cur = ensurePerm(node.id, node);
          const next = !cur[key];
          cur[key] = next;
          btn.dataset.on = String(next);
          btn.setAttribute("aria-checked", String(next));
          if(isGroup){
            cascade(node.id, key, next);
            renderTree();
          }
        });
        return btn;
      }

      function renderNode(node){
        const isGroup = node.type==="group";
        const d = document.createElement("details");
        d.className = "node";

        const sum = document.createElement("summary");
        const sumLine = document.createElement("div");
        sumLine.className = "sum-line indent-"+Math.min(node.depth,4);
        const label = document.createElement("div");
        label.className = "label";
        label.textContent = node.label;
        sumLine.appendChild(label);
        sum.appendChild(sumLine);
        d.appendChild(sum);

        const content = document.createElement("div");
        content.className = "content";

        if(isGroup){
          // group-level pills that cascade
          const pills = document.createElement("div");
          pills.className = "pill-col";
          pills.appendChild(makePill("Visible","visible",node,true));
          pills.appendChild(makePill("View","view",node,true));
          pills.appendChild(makePill("Add","add",node,true));
          pills.appendChild(makePill("Edit","edit",node,true));
          pills.appendChild(makePill("Archive/Delete","archive",node,true));
          content.appendChild(pills);

          // children list (each child is its own collapsible row showing its own pills inside)
          const kidsWrap = document.createElement("div");
          kidsWrap.className = "children";
          (byParent[node.id]||[]).forEach(k=>{
            kidsWrap.appendChild(renderLeaf(k));
          });
          content.appendChild(kidsWrap);
        }else{
          // link nodes normally rendered via renderLeaf() (so this path rarely runs)
          content.appendChild(renderLeafInner(node));
        }

        d.appendChild(content);
        return d;
      }

      function renderLeaf(node){
        const d = document.createElement("details");
        d.className = "node";
        const sum = document.createElement("summary");
        const sumLine = document.createElement("div");
        sumLine.className = "sum-line indent-"+Math.min(node.depth+1,4);
        const label = document.createElement("div"); label.className="label"; label.textContent=node.label;
        sumLine.appendChild(label);
        sum.appendChild(sumLine);
        d.appendChild(sum);

        const content = document.createElement("div");
        content.className = "content";
        content.appendChild(renderLeafInner(node));
        d.appendChild(content);
        return d;
      }

      function renderLeafInner(node){
        const pills = document.createElement("div");
        pills.className = "pill-col";
        pills.appendChild(makePill("Visible","visible",node,false));
        pills.appendChild(makePill("View","view",node,false));
        pills.appendChild(makePill("Add","add",node,false));
        pills.appendChild(makePill("Edit","edit",node,false));
        pills.appendChild(makePill("Archive/Delete","archive",node,false));
        return pills;
      }

      tree.innerHTML = "";
      (byParent["__ROOT__"]||[]).forEach(n => tree.appendChild(renderNode(n)));
    }

    /* ===== Role picker & actions ===== */
    function populateRolePicker(){
      const sel = $("rolePicker");
      const all = loadRoles();
      const keep = sel.value;
      sel.innerHTML = '<option value="">â€” New role â€”</option>';
      all.forEach(r=>{
        const o=document.createElement("option");
        o.value=r.id; o.textContent=r.name||"(unnamed)";
        sel.appendChild(o);
      });
      if(keep && all.some(r=>r.id===keep)) sel.value = keep;
    }
    function newDraft(){
      currentRoleId = "";
      roleDraft = { id:"", name:"", perms:{} };
      $("roleName").value = "";
      renderTree();
      $("rolePicker").value = "";
    }

    $("newRole").addEventListener("click", newDraft);

    $("saveRole").addEventListener("click", ()=>{
      const name = $("roleName").value.trim();
      if(!name){ alert("Please enter a role name."); return; }
      const all = loadRoles();
      if(currentRoleId){
        const i = all.findIndex(r=>r.id===currentRoleId);
        if(i>=0) all[i] = { id: currentRoleId, name, perms: roleDraft.perms, t: Date.now() };
      }else{
        const id = uid();
        all.unshift({ id, name, perms: roleDraft.perms, t: Date.now() });
        currentRoleId = id; roleDraft.id = id;
      }
      saveRoles(all);
      populateRolePicker();
      $("rolePicker").value = currentRoleId;
      showToast("Saved.");
    });

    $("deleteRole").addEventListener("click", ()=>{
      if(!currentRoleId){ alert("No role selected."); return; }
      const all = loadRoles();
      const r = all.find(x=>x.id===currentRoleId);
      if(!r) return;
      if(!confirm(`Delete role "${r.name}"? This cannot be undone.`)) return;
      const next = all.filter(x=>x.id!==currentRoleId);
      saveRoles(next);
      populateRolePicker();
      newDraft();
      showToast("Role deleted.");
    });

    $("rolePicker").addEventListener("change", ()=>{
      const id = $("rolePicker").value;
      if(!id){ newDraft(); return; }
      const r = loadRoles().find(x=>x.id===id);
      if(!r){ newDraft(); return; }
      currentRoleId = r.id;
      roleDraft = { id:r.id, name:r.name, perms: r.perms || {} };
      $("roleName").value = r.name || "";
      renderTree();
    });

    $("expandAll").addEventListener("click", ()=>{ document.querySelectorAll("#tree details").forEach(d=>d.open=true); });
    $("collapseAll").addEventListener("click", ()=>{ document.querySelectorAll("#tree details").forEach(d=>d.open=false); });

    /* ===== Init ===== */
    function init(){ populateRolePicker(); newDraft(); }
    if(window.FV_NAV_MENU){ init(); }
    else{
      window.addEventListener('fv:menu-ready', init, { once:true });
      setTimeout(()=>{ if(window.FV_NAV_MENU) init(); }, 300);
    }
  })();
  </script>
</body></html>