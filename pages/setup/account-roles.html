<!doctype html><html lang="en"><head>
  <meta charset="utf-8"/>
  <title>FarmVista ‚Ä¢ Setup ‚Üí Account Roles</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- Standard includes -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <style>
    .page{max-width:1100px;margin:0 auto;padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + 96px)!important;}
    .page-title{margin:0 0 8px 0;}
    .page-sub{margin:0 0 14px 0;color:var(--muted,#67706B);}

    .section{border:1px solid var(--border);border-radius:14px;background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));overflow:hidden;}
    .section-head{display:grid;grid-template-columns:36px 1fr;gap:12px;align-items:center;
      padding:14px 16px;border-bottom:1px solid var(--border);
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);}
    .section-head .icon{width:24px;height:24px;color:#2F6C3C;display:grid;place-items:center;}
    .section-body{padding:16px;display:grid;gap:14px;}

    .row{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    @media(max-width:900px){.row{grid-template-columns:1fr}}
    .field label{display:block;font-weight:800;margin:0 0 6px 0;}
    .input, .select{
      width:100%;font:inherit;font-size:16px;color:var(--text);
      background:var(--card-surface,var(--surface));border:1px solid var(--border);
      border-radius:10px;padding:12px;outline:none;}
    .actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{display:inline-flex;align-items:center;justify-content:center;min-width:140px;padding:10px 14px;border-radius:12px;
      border:1px solid var(--border);background:var(--card-surface,var(--surface));font-weight:800;color:var(--text);cursor:pointer;}
    .btn-primary{border-color:transparent;background:#2F6C3C;color:#fff;}
    .btn-quiet{min-width:auto;padding:8px 12px}
    .btn-danger{border-color:#b3261e;color:#b3261e;background:var(--surface);}

    /* Tree */
    .tree{border:1px solid var(--border);border-radius:12px;padding:10px;background:var(--card-surface,var(--surface));}
    .node{border:1px solid var(--border);border-radius:10px;background:var(--surface);margin:8px 0;}
    .node .bar{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 12px;}
    .node .left{display:flex;align-items:center;gap:10px;min-width:0;}
    .node .label{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .indent-0{padding-left:0}
    .indent-1{padding-left:12px}
    .indent-2{padding-left:24px}
    .indent-3{padding-left:36px}
    .indent-4{padding-left:48px}

    .pill-row{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:6px 10px;
      font-weight:800;background:var(--surface);color:var(--text);cursor:pointer;user-select:none;}
    .pill[data-on="true"]{background:#2F6C3C;color:#fff;border-color:#2F6C3C;}
    .pill .tiny{font-size:12px;opacity:.85;font-weight:700}
    .meta{font-size:12px;color:var(--muted,#67706B)}
    .meta .sep{margin:0 6px;color:var(--border)}

    /* Collapsible content */
    details{border-top:1px solid var(--border)}
    details[open] > .children{padding:8px 10px 12px}
    .children{display:grid;gap:6px}

    /* Toast */
    .toast{position:fixed;left:50%;bottom:calc(env(safe-area-inset-bottom,0px) + 72px);transform:translateX(-50%);
      background:#2F6C3C;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.25);z-index:99999;display:none;}
    .toast.show{display:block;animation:fadeout 2.8s forwards;}
    @keyframes fadeout{0%{opacity:1}85%{opacity:1}100%{opacity:0}}

    .help{font-size:13px;color:var(--muted,#67706B)}
  </style>

  <!-- We import the menu config as a module so we can mirror it -->
  <script type="module">
    import NAV_MENU from '/Farm-vista/js/menu.js';
    window.FV_NAV_MENU = NAV_MENU;
  </script>

  <script>(function(){
    if(!customElements.get('fv-shell')){
      const s=document.createElement('script');s.src='/Farm-vista/js/fv-shell.js';s.defer=true;document.head.appendChild(s);
    }
  })();</script>
</head><body>
  <fv-shell>
    <div class="page container">
      <h1 class="page-title">Account Roles</h1>
      <p class="page-sub">Create roles and choose which menus users can see and what actions they can perform. All sections are collapsed by default for a compact, phone-friendly view.</p>

      <!-- Role header -->
      <section class="section">
        <header class="section-head">
          <div class="icon" aria-hidden="true">üë•</div>
          <div><strong>Role Details</strong></div>
        </header>
        <div class="section-body">
          <div class="row">
            <div class="field">
              <label for="rolePicker">Existing Roles</label>
              <select id="rolePicker" class="select">
                <option value="">‚Äî New role ‚Äî</option>
              </select>
            </div>
            <div class="field">
              <label for="roleName">Role Name</label>
              <input id="roleName" class="input" placeholder="e.g., Seasonal Operator">
            </div>
          </div>

          <div class="actions">
            <button id="newRole" class="btn" type="button">New</button>
            <button id="saveRole" class="btn btn-primary" type="button">Save Role</button>
            <button id="deleteRole" class="btn btn-danger" type="button">Delete Role</button>
            <span class="help">Saving stores the permissions locally (fv_account_roles_v1). You can wire this to Firestore later.</span>
          </div>
        </div>
      </section>

      <!-- Permissions tree -->
      <section class="section">
        <header class="section-head">
          <div class="icon" aria-hidden="true">üîí</div>
          <div><strong>Permissions</strong><div class="help">Toggle visibility and actions per menu/sub-menu. Groups have an ‚ÄúApply to children‚Äù option.</div></div>
        </header>
        <div class="section-body">
          <div class="actions">
            <button id="expandAll" class="btn btn-quiet" type="button">Expand All</button>
            <button id="collapseAll" class="btn btn-quiet" type="button">Collapse All</button>
            <span class="help">Defaults: links ‚Üí Visible + View on; Add/Edit/Archive off.</span>
          </div>
          <div id="tree" class="tree" aria-live="polite"></div>
        </div>
      </section>
    </div>
  </fv-shell>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite">Saved.</div>

  <script>
  (function(){
    "use strict";
    const $ = id => document.getElementById(id);
    const toast = $("toast");

    const LS_ROLES = "fv_account_roles_v1";

    /** Role in memory */
    let currentRoleId = "";
    let roleDraft = null; // {id,name,perms:{[navId]:{visible,view,add,edit,archive}}}

    /** ===== Utilities ===== */
    function showToast(msg="Saved."){ toast.textContent = msg; toast.classList.remove("show"); void toast.offsetWidth; toast.classList.add("show"); }
    function uid(){ return String(Date.now()) + Math.random().toString(36).slice(2,7); }
    function loadRoles(){ try{ const a=JSON.parse(localStorage.getItem(LS_ROLES)||"[]"); return Array.isArray(a)?a:[]; }catch(e){ return []; } }
    function saveRoles(arr){ localStorage.setItem(LS_ROLES, JSON.stringify(arr)); }
    function getMenu(){ return window.FV_NAV_MENU; }

    function flatten(items, depth=0, parent=null, out=[]){
      items.forEach(it=>{
        const n = { id: it.id, type: it.type, label: it.label, icon: it.icon, href: it.href||"", depth, parent };
        out.push(n);
        if(it.children && it.children.length){
          flatten(it.children, depth+1, it.id, out);
        }
      });
      return out;
    }

    function defaultPermFor(node){
      // groups: visible on, others off (not used)
      if(node.type==="group"){
        return { visible:true, view:false, add:false, edit:false, archive:false };
      }
      // links: visible on, view on by default
      return { visible:true, view:true, add:false, edit:false, archive:false };
    }

    /** ===== Render tree ===== */
    function renderTree(){
      const tree = $("tree");
      const NAV = getMenu();
      if(!NAV){ tree.textContent = "Menu not available"; return; }
      const flat = flatten(NAV.items, 0, null, []);
      // Build a map for children to render collapsibles
      const byParent = {};
      flat.forEach(n=>{
        const p = n.parent || "__ROOT__";
        (byParent[p]||(byParent[p]=[])).push(n);
      });

      // Helper to get/set perms
      const perms = roleDraft.perms;

      function ensurePerm(id, node){
        if(!perms[id]) perms[id] = defaultPermFor(node);
        return perms[id];
      }

      function makePill(label, key, node){
        const perm = ensurePerm(node.id, node);
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "pill";
        btn.dataset.nodeId = node.id;
        btn.dataset.key = key;
        btn.setAttribute("role","switch");
        btn.setAttribute("aria-checked", String(!!perm[key]));
        btn.dataset.on = String(!!perm[key]);
        btn.innerHTML = `<span class="tiny">${label}</span>`;
        btn.addEventListener("click", ()=>{
          const cur = perms[node.id] || defaultPermFor(node);
          const next = !cur[key];
          cur[key] = next;
          perms[node.id] = cur;
          btn.dataset.on = String(next);
          btn.setAttribute("aria-checked", String(next));
        });
        return btn;
      }

      function renderNode(node){
        const isGroup = node.type==="group";
        const perm = ensurePerm(node.id, node);

        const wrap = document.createElement("div");
        wrap.className = "node";

        const bar = document.createElement("div");
        bar.className = "bar indent-"+Math.min(node.depth,4);
        const left = document.createElement("div");
        left.className = "left";
        const label = document.createElement("div");
        label.className = "label";
        label.textContent = node.label;
        const meta = document.createElement("div");
        meta.className = "meta";
        meta.innerHTML = (isGroup? "Group" : "Link") + (node.href? `<span class="sep">‚Ä¢</span>${node.href}`:"");

        left.appendChild(label);
        left.appendChild(meta);

        const pills = document.createElement("div");
        pills.className = "pill-row";

        // Always show Visible
        pills.appendChild(makePill("Visible", "visible", node));

        if(!isGroup){
          pills.appendChild(makePill("View", "view", node));
          pills.appendChild(makePill("Add", "add", node));
          pills.appendChild(makePill("Edit", "edit", node));
          pills.appendChild(makePill("Archive/Delete", "archive", node));
        }else{
          // Group-only helper: apply visible to children
          const applyBtn = document.createElement("button");
          applyBtn.type = "button";
          applyBtn.className = "pill";
          applyBtn.innerHTML = `<span class="tiny">Apply to children</span>`;
          applyBtn.addEventListener("click", ()=>{
            const want = (roleDraft.perms[node.id]||{}).visible ?? true;
            cascadeVisible(node.id, want);
            // re-render to reflect new states
            renderTree();
          });
          pills.appendChild(applyBtn);
        }

        bar.appendChild(left);
        bar.appendChild(pills);
        wrap.appendChild(bar);

        // Children (for groups)
        if(isGroup){
          const details = document.createElement("details");
          // collapsed by default
          const childrenBox = document.createElement("div");
          childrenBox.className = "children";
          const kids = byParent[node.id] || [];
          kids.forEach(k => childrenBox.appendChild(renderNode(k)));
          details.appendChild(childrenBox);
          wrap.appendChild(details);
        }

        return wrap;
      }

      // Cascade helper
      function cascadeVisible(parentId, state){
        const stack = (byParent[parentId] || []).slice();
        while(stack.length){
          const n = stack.pop();
          const cur = perms[n.id] || defaultPermFor(n);
          cur.visible = !!state;
          perms[n.id] = cur;
          if(n.type==="group"){
            (byParent[n.id]||[]).forEach(c=>stack.push(c));
          }
        }
      }

      // Root render: top-level items (parent null)
      tree.innerHTML = "";
      (byParent["__ROOT__"] || []).forEach(n => tree.appendChild(renderNode(n)));
    }

    /** ===== Role load/save UI ===== */
    function populateRolePicker(){
      const sel = $("rolePicker");
      const all = loadRoles();
      const curVal = sel.value;
      sel.innerHTML = '<option value="">‚Äî New role ‚Äî</option>';
      all.forEach(r=>{
        const o = document.createElement("option");
        o.value = r.id;
        o.textContent = r.name || "(unnamed)";
        sel.appendChild(o);
      });
      if(all.some(r=>r.id===curVal)) sel.value = curVal;
    }

    function newDraft(){
      currentRoleId = "";
      roleDraft = { id:"", name:"", perms:{} };
      $("roleName").value = "";
      renderTree();
      $("rolePicker").value = "";
    }

    $("newRole").addEventListener("click", newDraft);

    $("saveRole").addEventListener("click", ()=>{
      const name = $("roleName").value.trim();
      if(!name){ alert("Please enter a role name."); return; }
      const all = loadRoles();
      if(currentRoleId){
        const idx = all.findIndex(r=>r.id===currentRoleId);
        if(idx>=0){
          all[idx] = { id: currentRoleId, name, perms: roleDraft.perms, t: Date.now() };
        }
      }else{
        const id = uid();
        all.unshift({ id, name, perms: roleDraft.perms, t: Date.now() });
        currentRoleId = id;
        roleDraft.id = id;
      }
      saveRoles(all);
      populateRolePicker();
      $("rolePicker").value = currentRoleId;
      showToast("Role saved.");
    });

    $("deleteRole").addEventListener("click", ()=>{
      if(!currentRoleId){ alert("No role selected."); return; }
      const all = loadRoles();
      const r = all.find(x=>x.id===currentRoleId);
      if(!r){ return; }
      if(!confirm(`Delete role "${r.name}"? This cannot be undone.`)) return;
      const next = all.filter(x=>x.id!==currentRoleId);
      saveRoles(next);
      showToast("Role deleted.");
      populateRolePicker();
      newDraft();
    });

    $("rolePicker").addEventListener("change", ()=>{
      const id = $("rolePicker").value;
      if(!id){ newDraft(); return; }
      const r = loadRoles().find(x=>x.id===id);
      if(!r){ newDraft(); return; }
      currentRoleId = r.id;
      roleDraft = { id:r.id, name:r.name, perms: r.perms || {} };
      $("roleName").value = r.name || "";
      renderTree();
    });

    $("expandAll").addEventListener("click", ()=>{
      document.querySelectorAll("#tree details").forEach(d=>{ d.open = true; });
    });
    $("collapseAll").addEventListener("click", ()=>{
      document.querySelectorAll("#tree details").forEach(d=>{ d.open = false; });
    });

    /** ===== Init ===== */
    function initWhenMenuReady(){
      if(window.FV_NAV_MENU){ // module import placed it on window
        populateRolePicker();
        newDraft(); // also renders tree
        return;
      }
      // If menu hasn't loaded yet, wait a tick
      setTimeout(initWhenMenuReady, 50);
    }
    initWhenMenuReady();
  })();
  </script>
</body></html>