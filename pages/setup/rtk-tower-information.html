<!doctype html><html lang="en"><head>
  <meta charset="utf-8"/>
  <title>FarmVista ‚Ä¢ Setup ‚Üí RTK Tower Information</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- Standard app includes -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <style>
    .page{max-width:1100px;margin:0 auto;padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + 96px)!important;}
    .page-title{margin:0 0 8px 0;}
    .page-sub{margin:0 0 14px 0;color:var(--muted,#67706B);}

    .section{border:1px solid var(--border); border-radius:14px; background:var(--surface); box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08)); overflow:hidden;}
    .section-head{display:grid; grid-template-columns:36px 1fr; gap:12px; align-items:center; padding:14px 16px; border-bottom:1px solid var(--border); background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);}
    .section-head .icon{width:24px; height:24px; color:#2F6C3C; display:grid; place-items:center;}
    .section-body{padding:16px; display:grid; gap:14px;}

    .grid-3{display:grid; gap:10px; grid-template-columns:1fr 1fr 1fr;}
    @media(max-width:880px){ .grid-3 { grid-template-columns:1fr; } }

    .field label{display:block; font-weight:800; margin:0 0 6px 0;}
    .input,.select,.textarea{width:100%; font:inherit; font-size:16px; color:var(--text); background:var(--card-surface,var(--surface)); border:1px solid var(--border); border-radius:10px; padding:12px; outline:none;}
    .help{font-size:13px; color:var(--muted,#67706B);}

    .actions{display:flex; gap:12px; flex-wrap:wrap}
    .btn{display:inline-flex; align-items:center; justify-content:center; min-width:148px; padding:12px 16px; border-radius:12px; border:1px solid var(--border); background:var(--card-surface,var(--surface)); font-weight:800; color:var(--text); cursor:pointer;}
    .btn-primary{border-color:transparent; background:#2F6C3C; color:#fff;}

    .toast{position:fixed; left:50%; bottom:calc(env(safe-area-inset-bottom,0px) + 72px); transform:translateX(-50%); background:#2F6C3C; color:#fff; padding:10px 14px; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,.25); z-index:99999; display:none;}
    .toast.show{display:block; animation:fadeout 2.8s forwards;}
    @keyframes fadeout{0%{opacity:1} 85%{opacity:1} 100%{opacity:0}}
  </style>

  <script>(function(){
    if(!customElements.get('fv-shell')){
      const s=document.createElement('script'); s.src='/Farm-vista/js/fv-shell.js'; s.defer=true; document.head.appendChild(s);
    }
  })();</script>
</head><body>
  <fv-shell>
    <div class="page container">
      <h1 class="page-title">RTK Tower Information</h1>
      <p class="page-sub">Save RTK base/tower entries for reuse. Each entry requires a Tower Name, a numeric Network ID, and a Radio Frequency in MHz.</p>

      <section class="section">
        <header class="section-head">
          <div class="icon" aria-hidden="true">üõ∞Ô∏è</div>
          <div>
            <strong>New RTK Tower</strong>
            <div class="help">Frequency format: three digits, a decimal, then 1‚Äì5 decimals (e.g., <code>450.12345</code> MHz).</div>
          </div>
        </header>

        <div class="section-body">
          <div class="grid-3">
            <div class="field">
              <label for="name">Tower Name</label>
              <input id="name" class="input" placeholder="e.g., Divernon NW">
            </div>

            <div class="field">
              <label for="netid">Network ID</label>
              <input id="netid" class="input" inputmode="numeric" pattern="\\d+" placeholder="e.g., 12">
              <div class="help">Whole number only.</div>
            </div>

            <div class="field">
              <label for="freq">Radio Frequency (MHz)</label>
              <input id="freq" class="input" inputmode="decimal" placeholder="e.g., 450.12345" pattern="\\d{3}\\.\\d{1,5}">
              <div class="help">Format: <code>###.d</code> to <code>###.ddddd</code> (MHz).</div>
            </div>
          </div>

          <div class="actions">
            <button id="clear" class="btn" type="button">Clear</button>
            <button id="save" class="btn btn-primary" type="button">Save Tower</button>
          </div>
        </div>
      </section>
    </div>
  </fv-shell>

  <div id="toast" class="toast" role="status" aria-live="polite">Saved.</div>

  <!-- Firestore save -->
  <script type="module">
    import {
      ready,
      getFirestore, collection, addDoc, serverTimestamp
    } from '/Farm-vista/js/firebase-init.js';

    (function(){
      "use strict";
      const $ = id => document.getElementById(id);
      const toast = $("toast");

      function showToast(msg="Saved.") {
        toast.textContent = msg;
        toast.classList.remove("show"); void toast.offsetWidth;
        toast.classList.add("show");
      }

      function validate(){
        const name = $("name").value.trim();
        const netid = $("netid").value.trim();
        const freq = $("freq").value.trim();
        if(!name) return "Enter a tower name.";
        if(!/^[0-9]+$/.test(netid)) return "Network ID must be a whole number.";
        if(!/^[0-9]{3}\\.[0-9]{1,5}$/.test(freq)) return "Radio frequency must match ###.d to ###.ddddd (e.g., 450.12345).";
        return "";
      }

      $("save").addEventListener("click", async ()=>{
        const err = validate(); if (err) { alert(err); return; }

        try{
          const ctx = await ready;
          if (ctx.mode !== 'firebase') {
            alert("Firestore not available (stub mode). This page expects Firebase to be live.");
            return;
          }

          const db = getFirestore();
          const payload = {
            name: $("name").value.trim(),
            networkId: Number($("netid").value.trim()),
            frequencyMHz: $("freq").value.trim(),
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          };

          await addDoc(collection(db, 'rtkTowers'), payload);
          showToast("RTK tower saved.");

          // clear fields
          ["name","netid","freq"].forEach(id => { $(id).value = ""; });
        }catch(e){
          console.error(e);
          alert("Save failed.\n\n" + (e?.message || e));
        }
      });

      $("clear").addEventListener("click", ()=>{
        ["name","netid","freq"].forEach(id => { $(id).value = ""; });
      });
    })();
  </script>
</body></html>