<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista ‚Ä¢ Setup ‚Üí RTK Tower Information</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- Standard app includes -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <style>
    .page{max-width:1100px;margin:0 auto;padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px)+var(--ftr-h,42px)+96px)!important;}
    .page-title{margin:0 0 8px 0;}
    .page-sub{margin:0 0 14px 0;color:var(--muted,#67706B);}
    .section{border:1px solid var(--border);border-radius:14px;background:var(--surface);box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));overflow:hidden;}
    .section-head{display:grid;grid-template-columns:36px 1fr;gap:12px;align-items:center;padding:14px 16px;border-bottom:1px solid var(--border);background:linear-gradient(90deg,rgba(47,108,60,.12),transparent);}
    .section-head .icon{width:24px;height:24px;color:#2F6C3C;display:grid;place-items:center;}
    .section-body{padding:16px;display:grid;gap:14px;}
    .grid-3{display:grid;gap:10px;grid-template-columns:1fr 1fr 1fr;}
    @media(max-width:880px){.grid-3{grid-template-columns:1fr;}}
    .field label{display:block;font-weight:800;margin:0 0 6px 0;}
    .input{width:100%;font:inherit;font-size:16px;color:var(--text);background:var(--card-surface,var(--surface));border:1px solid var(--border);border-radius:10px;padding:12px;outline:none;}
    .help{font-size:13px;color:var(--muted,#67706B);}
    .actions{display:flex;gap:12px;flex-wrap:wrap;}
    .btn{display:inline-flex;align-items:center;justify-content:center;min-width:148px;padding:12px 16px;border-radius:12px;border:1px solid var(--border);background:var(--card-surface,var(--surface));font-weight:800;color:var(--text);cursor:pointer;}
    .btn-primary{border-color:transparent;background:#2F6C3C;color:#fff;}
    .btn-danger{border-color:transparent;background:#9A2B2B;color:#fff;}
    .toast{position:fixed;left:50%;bottom:calc(env(safe-area-inset-bottom,0px)+72px);transform:translateX(-50%);background:#2F6C3C;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.25);z-index:99999;display:none;}
    .toast.show{display:block;animation:fadeout 2.8s forwards;}
    @keyframes fadeout{0%{opacity:1}85%{opacity:1}100%{opacity:0}}
    .tbl{width:100%;border-collapse:separate;border-spacing:0;overflow:hidden;border:1px solid var(--border);border-radius:12px;}
    .tbl th,.tbl td{padding:12px 14px;text-align:left;border-bottom:1px solid var(--border);background:var(--card-surface,var(--surface));}
    .tbl th{font-weight:800;background:linear-gradient(0deg,rgba(47,108,60,.04),rgba(47,108,60,.04));}
    .tbl tr:last-child td{border-bottom:none;}
    .row-actions{display:flex;gap:8px;flex-wrap:wrap;}
    .muted{color:var(--muted,#67706B);font-size:13px;}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);}
  </style>

  <script>(function(){
    if(!customElements.get('fv-shell')){
      const s=document.createElement('script');s.src='/Farm-vista/js/fv-shell.js';s.defer=true;document.head.appendChild(s);
    }
  })();</script>
</head>
<body>
<fv-shell>
  <div class="page container">
    <h1 class="page-title">RTK Tower Information</h1>
    <p class="page-sub">Save RTK base/tower entries for reuse. Each entry requires a Tower Name, a 4-digit Network ID, and a Radio Frequency in MHz.</p>

    <section class="section">
      <header class="section-head">
        <div class="icon">üõ∞Ô∏è</div>
        <div>
          <strong id="formTitle">New RTK Tower</strong>
          <div class="help">Network ID: exactly 4 digits (e.g. <code>0123</code>) ‚Ä¢ Frequency: <code>###.#####</code> (e.g. <code>450.12345</code>).</div>
        </div>
      </header>
      <div class="section-body">
        <div class="grid-3">
          <div class="field">
            <label for="name">Tower Name</label>
            <input id="name" class="input" placeholder="e.g. Divernon NW">
          </div>
          <div class="field">
            <label for="netid">Network ID</label>
            <input id="netid" class="input" inputmode="numeric" maxlength="4" placeholder="e.g. 0123">
            <div class="help">Exactly 4 numbers.</div>
          </div>
          <div class="field">
            <label for="freq">Radio Frequency (MHz)</label>
            <input id="freq" class="input" inputmode="decimal" placeholder="e.g. 450.12345">
            <div class="help">Three digits, decimal, five digits.</div>
          </div>
        </div>
        <div class="actions">
          <button id="clear" class="btn" type="button">Clear</button>
          <button id="save" class="btn btn-primary" type="button">Save Tower</button>
        </div>
        <div id="editHint" class="muted" style="display:none;">Editing <span class="pill" id="editingName"></span>. Click Save Tower to update or Clear to cancel.</div>
      </div>
    </section>

    <section class="section" style="margin-top:16px;">
      <header class="section-head">
        <div class="icon">üìö</div>
        <div>
          <strong>RTK Towers Dictionary</strong>
          <div class="help">View, sort, edit, or delete saved towers.</div>
        </div>
      </header>
      <div class="section-body" id="dictBox">
        <div class="muted" id="emptyState">No towers saved yet.</div>
        <div style="overflow:auto;display:none;" id="tblWrap">
          <table class="tbl" id="dictTable">
            <thead>
              <tr><th>Tower Name</th><th>Network ID</th><th>Frequency (MHz)</th><th>Actions</th></tr>
            </thead>
            <tbody id="dictBody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>
</fv-shell>

<div id="toast" class="toast">Saved.</div>

<script type="module">
const $ = id=>document.getElementById(id);
const toast=$("toast");let editingId=null;

function showToast(msg="Saved."){toast.textContent=msg;toast.classList.remove("show");void toast.offsetWidth;toast.classList.add("show");}
function validate(){
  const n=$("name").value.trim(),id=$("netid").value.trim(),f=$("freq").value.trim();
  if(!n)return"Enter a tower name.";
  if(!/^[0-9]{4}$/.test(id))return"Network ID must be exactly 4 digits.";
  if(!/^[0-9]{3}\\.[0-9]{5}$/.test(f))return"Frequency must match 450.12345 format.";
  return"";
}
function payload(){return{name:$("name").value.trim(),networkId:Number($("netid").value.trim()),frequencyMHz:$("freq").value.trim(),updatedAt:Date.now()};}
function resetForm(){["name","netid","freq"].forEach(x=>$(x).value="");editingId=null;$("formTitle").textContent="New RTK Tower";$("save").textContent="Save Tower";$("editHint").style.display="none";}
function startEdit(r){editingId=r.id;$("name").value=r.name;$("netid").value=String(r.networkId).padStart(4,"0");$("freq").value=r.frequencyMHz;$("formTitle").textContent="Edit RTK Tower";$("save").textContent="Update Tower";$("editHint").style.display="block";$("editingName").textContent=r.name;}
function render(rows){const body=$("dictBody");body.innerHTML="";if(!rows.length){$("emptyState").style.display="";$("tblWrap").style.display="none";return;}$("emptyState").style.display="none";$("tblWrap").style.display="";for(const r of rows){const tr=document.createElement("tr");tr.innerHTML=`<td>${r.name}</td><td>${String(r.networkId).padStart(4,"0")}</td><td>${r.frequencyMHz}</td>
<td><div class='row-actions'>
<button class='btn' data-act='edit' data-id='${r.id}'>Edit</button>
<button class='btn btn-danger' data-act='del' data-id='${r.id}'>Delete</button>
</div></td>`;body.appendChild(tr);}}
async function load(){if(!window.FVData){$("emptyState").innerHTML="FVData not available.";return;}await FVData.init?.();const list=await FVData.list("rtkTowers");list.sort((a,b)=>(a.name||"").localeCompare(b.name||""));render(list);}
$("save").onclick=async()=>{const err=validate();if(err){alert(err);return;}const data=payload();try{if(editingId){await FVData.update("rtkTowers",editingId,data);showToast("Updated.");}else{data.createdAt=Date.now();await FVData.add("rtkTowers",data);showToast("Saved.");}resetForm();await load();}catch(e){alert("Save failed: "+e.message);}};
$("clear").onclick=resetForm;
$("dictBody").onclick=async e=>{const b=e.target.closest("button[data-act]");if(!b)return;const act=b.dataset.act,id=b.dataset.id;if(act==="edit"){const list=await FVData.list("rtkTowers");const rec=list.find(x=>x.id===id);if(rec)startEdit(rec);}else if(act==="del"){if(confirm("Delete this tower?")){await FVData.remove("rtkTowers",id);showToast("Deleted.");if(editingId===id)resetForm();await load();}}};
$("netid").oninput=e=>e.target.value=e.target.value.replace(/\\D/g,"").slice(0,4);
$("freq").onblur=e=>{const v=e.target.value.trim();const m=v.match(/^(\\d{3})\\.(\\d{1,5})$/);if(m){const f=(m[2]+"00000").slice(0,5);e.target.value=m[1]+"."+f;}};
load();
</script>
</body>
</html>