<!-- =====================================================================
/Farm-vista/pages/crop-production/field-maintenance/maintenance-edit.html
Worker Order Editor ‚Äì list, filter by status, full edit (delete from list w/ FV confirm)
Rev: 2025-12-18 (search removed, FV delete confirm, mobile + modal fixes)
===================================================================== -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FarmVista ‚Ä¢ Worker Order Editor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#3B7E46" />

  <script src="/Farm-vista/js/theme-boot.js"></script>

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest" />
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png" />
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png" />
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css" />
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css" />

  <!-- Ensure fv-shell -->
  <script>
    (function () {
      if (!customElements.get('fv-shell')) {
        const s = document.createElement('script');
        s.src = '/Farm-vista/js/fv-shell.js';
        s.defer = true;
        document.head.appendChild(s);
      }
    })();
  </script>

  <style>
    :root{
      --card-max: 1200px;
      --page-bottom-gap: 96px;
      --accent: #2F6C3C;

      --combo-gap:4px;
      --combo-radius:12px;
      --combo-btn-radius:10px;
      --combo-shadow:0 12px 26px rgba(0,0,0,.18);
      --combo-item-pad:10px 8px;
      --combo-max-h:50vh;
    }
    html{-webkit-text-size-adjust:100%}
    body{ background: var(--app-bg, var(--surface)); }

    /* HARD CLAMP */
    html, body{
      width:100%;
      max-width:100%;
      overflow-x:hidden !important;
    }
    @supports (width: 100dvw){
      html, body{ width:100dvw; }
    }

    .wrap{
      max-width: var(--card-max);
      margin: 0 auto;
      padding: clamp(14px,3vw,22px);
      padding-bottom: calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + var(--page-bottom-gap)) !important;
      box-sizing:border-box;
      display:grid;
      gap:12px;
    }

    .hero{
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));
      /* IMPORTANT: allow content like status to never be clipped */
      overflow:visible;
    }
    .hero-head{
      display:grid;
      grid-template-columns:36px 1fr;
      gap:12px;
      align-items:center;
      padding:14px 16px;
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);
      border-bottom:1px solid var(--border);
      border-top-left-radius:14px;
      border-top-right-radius:14px;
    }
    .hero-head .icon{
      width:24px;
      height:24px;
      color:var(--accent);
      display:grid;
      place-items:center;
    }
    .hero-head h1{ margin:0; font-size:clamp(20px,3.2vw,26px); line-height:1.2; }
    .muted{ color:var(--muted,#67706B); }

    .body{ padding:16px; display:grid; gap:14px; }

    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:flex-end;
      justify-content:space-between;
    }
    .toolbar-left{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .toolbar-right{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:flex-end;
    }

    .field-inline{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:180px;
    }
    .field-inline label{
      font-weight:800;
      font-size:0.85rem;
    }

    .input,
    .select{
      width:100%;
      font:inherit;
      font-size:14px;
      color:var(--text);
      background:var(--card-surface,var(--surface));
      border:1px solid var(--border);
      border-radius:10px;
      padding:8px 10px;
      outline:none;
    }

    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      min-width:120px; padding:10px 14px; border-radius:12px; border:1px solid var(--border);
      font-weight:800; text-decoration:none; cursor:pointer; user-select:none;
      color:var(--text) !important; background:var(--card-surface,var(--surface));
      font-size:0.9rem;
      gap:6px;
      -webkit-tap-highlight-color: transparent;
    }
    .btn-primary{ border-color:transparent; background:#2F6C3C; color:#fff !important; }
    .btn-quiet{ min-width:auto; padding-inline:10px; }
    .btn-danger{ border-color:transparent; background:#b3261e; color:#fff !important; }
    .btn[disabled]{ opacity:.6; cursor:not-allowed; }

    .error{
      border:1px solid #b3261e;
      background:#fff;
      color:#b3261e;
      border-radius:10px;
      padding:10px 12px;
      display:none;
      margin-bottom:4px;
      font-size:0.9rem;
    }
    .error.show{ display:block; }

    .toast{
      position:fixed;
      left:50%;
      bottom:calc(env(safe-area-inset-bottom,0px) + 72px);
      transform:translateX(-50%);
      background:#2F6C3C;
      color:#fff;
      padding:10px 14px;
      border-radius:10px;
      box-shadow:0 6px 20px rgba(0,0,0,.25);
      z-index:99999;
      display:none;
      white-space:nowrap;
      max-width:92vw;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .toast.show{ display:block; animation:fadeout 3.2s forwards; }
    @keyframes fadeout{0%{opacity:1}85%{opacity:1}100%{opacity:0}}

    /* STATUS OUTSIDE HERO (always visible) */
    .status-bar{
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--card-surface,var(--surface));
      padding:10px 12px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      box-shadow:var(--shadow,0 6px 16px rgba(0,0,0,.06));
    }
    .wo-status{
      font-size:0.9rem;
      color:var(--muted,#67706B);
      font-weight:700;
    }

    .wo-list{
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .wo-item{
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--card-surface,var(--surface));
      padding:12px 12px;
      display:grid;
      gap:6px;
      overflow:hidden;
    }
    .wo-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      font-size:0.95rem;
      font-weight:900;
    }
    .wo-topic{
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .wo-pill{
      font-size:0.75rem;
      padding:3px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      text-transform:uppercase;
      letter-spacing:0.03em;
      white-space:nowrap;
      background:rgba(0,0,0,.02);
    }
    .wo-sub{
      display:flex;
      flex-wrap:wrap;
      gap:6px 10px;
      font-size:0.82rem;
      color:var(--muted,#67706B);
    }
    .wo-notes{
      font-size:0.92rem;
      line-height:1.35;
      max-height:4.2em;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .wo-actions{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      justify-content:flex-end;
      margin-top:4px;
    }
    .wo-actions .btn{
      min-width:auto;
      padding-inline:12px;
      font-size:0.85rem;
    }

    /* === DEV-STYLE INLINE COMBOS (Farm / Field / Topic in editor) === */
    .buttonish{
      width:100%;
      font:inherit;
      font-size:16px;
      color:var(--text);
      background:var(--card-surface,var(--surface));
      border:1px solid var(--border);
      border-radius:var(--combo-btn-radius);
      padding:10px;
      padding-right:40px;
      outline:none;
      text-align:left;
      cursor:pointer;
      position:relative;
      max-width:100%;
    }
    .buttonish.has-caret::after{
      content:"";
      position:absolute;
      right:14px;
      top:50%;
      width:0;
      height:0;
      border-left:6px solid transparent;
      border-right:6px solid transparent;
      border-top:7px solid var(--muted,#67706B);
      transform:translateY(-50%);
      pointer-events:none;
    }

    .combo{ position:relative; }
    .combo .combo-anchor{
      position:relative;
      display:inline-block;
      width:100%;
      max-width:100%;
    }
    .combo-panel{
      position:absolute;
      left:0; right:0;
      top:calc(100% + var(--combo-gap));
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--combo-radius);
      box-shadow:var(--combo-shadow);
      padding:8px;
      display:none;
      z-index:9999;
    }
    .combo-panel.show{ display:block; }

    .combo-panel .search{
      padding:4px 2px 8px;
    }
    .combo-panel .search input{
      width:100%;
      padding:8px;
      border:1px solid var(--border);
      border-radius:var(--combo-btn-radius);
      background:var(--card-surface,var(--surface));
      color:var(--text);
      font-size:0.95rem;
    }

    .combo-panel .list{
      max-height:var(--combo-max-h);
      overflow:auto;
      border-top:1px solid var(--border);
    }
    .combo-item{
      padding:var(--combo-item-pad);
      border-bottom:1px solid var(--border);
      cursor:pointer;
      font-size:0.95rem;
    }
    .combo-item:hover{ background:rgba(0,0,0,.04); }
    .combo-item:last-child{ border-bottom:none; }
    .combo-empty{
      padding:var(--combo-item-pad);
      color:#67706B;
      font-size:0.95rem;
    }

    .fm-row-label{
      display:block;
      font-weight:900;
      margin:0 0 4px 0;
      font-size:0.92rem;
    }
    .fm-row-label .req{ color:var(--accent); }

    .textarea{
      width:100%;
      font:inherit;
      font-size:14px;
      font-weight:400;
      color:var(--text);
      background:var(--card-surface,var(--surface));
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px 10px;
      outline:none;
      min-height:90px;
      resize:vertical;
      max-width:100%;
    }

    .priority-readout{
      font-size:0.85rem;
      color:var(--muted,#67706B);
      margin-top:4px;
    }
    .priority-reason textarea{
      min-height:70px;
      resize:vertical;
    }

    /* === Modal === */
    .modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:100000;
    }
    .modal.show{ display:flex; }
    .backdrop{
      position:absolute;
      inset:0;
      background:rgba(0,0,0,.45);
    }
    .sheet{
      position:relative;
      width:min(100vw,820px);
      max-width:92vw;
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:14px;
      box-shadow:0 20px 40px rgba(0,0,0,.35);
      display:flex;
      flex-direction:column;
      overflow:hidden;
      max-height:92vh;

      /* stop any horizontal scroll inside modals */
      overflow-x:hidden;
    }
    .sheet header{
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      font-weight:900;
      display:flex;
      align-items:center;
      justify-content:space-between;
      color:var(--text);
      flex:0 0 auto;
      gap:10px;
    }
    .sheet header .close{
      border:none;
      background:transparent;
      font:inherit;
      font-weight:900;
      cursor:pointer;
      padding:6px 10px;
      border-radius:10px;
      color:var(--text);
    }
    .sheet header .close:hover{ background:var(--hover,rgba(0,0,0,.06)); }

    .edit-body{
      padding:12px 14px 8px;
      display:grid;
      gap:10px;
      flex:1 1 auto;
      min-height:0;
      overflow:auto;

      /* stop horizontal scroll */
      overflow-x:hidden;
    }
    .edit-grid{
      display:grid;
      gap:10px;
      grid-template-columns:1fr 1fr;
    }
    @media (max-width:820px){
      .edit-grid{ grid-template-columns:1fr; }
    }

    .edit-footer{
      padding:10px 14px;
      border-top:1px solid var(--border);
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .grow{ flex:1 1 auto; }

    #masterErr{ margin-top:4px; }

    /* Photos in editor */
    .photo-thumbs{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-bottom:4px;
    }
    .photo-thumb{
      width:78px;
      height:78px;
      border-radius:12px;
      border:1px solid var(--border);
      overflow:hidden;
      display:grid;
      place-items:center;
      background:var(--card-surface,var(--surface));
      position:relative;
      flex:0 0 auto;
    }
    .photo-thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    /* Hide raw URL editor (thumbnails only, as requested) */
    .photo-urls-raw{ display:none !important; }

    /* Map modal for editing location */
    .map-modal-body{
      padding:14px 16px;
      display:flex;
      flex-direction:column;
      gap:12px;
      flex:1 1 auto;
      min-height:0;
      overflow-x:hidden;
    }
    .map-shell{
      border-radius:14px;
      border:1px solid var(--border);
      overflow:hidden;
      background:#000;
      min-height:260px;
    }
    #editMap{
      width:100%;
      height:260px;
    }
    @media (min-width:700px){
      #editMap{ height:360px; }
    }
    .map-footer{
      padding:8px 10px;
      background:var(--surface);
      border-top:1px solid var(--border);
    }
    .map-modal-footer{
      padding:12px 14px;
      border-top:1px solid var(--border);
      display:flex;
      gap:12px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }

    /* FV confirm modal (smaller) */
    .confirm-sheet{
      width:min(100vw,520px);
      max-width:92vw;
    }
    .confirm-body{
      padding:14px 14px 10px;
      display:grid;
      gap:10px;
    }
    .confirm-title{
      font-weight:1000;
      font-size:1.02rem;
    }
    .confirm-msg{
      color:var(--muted,#67706B);
      line-height:1.35;
      font-size:0.95rem;
    }

    /* Mobile friendliness */
    @media (max-width:560px){
      .toolbar{ flex-direction:column; align-items:stretch; }
      .toolbar-left, .toolbar-right{ width:100%; justify-content:space-between; }
      .field-inline{ min-width:unset; width:100%; }
      .btn{ width:100%; min-width:unset; }
      .wo-actions .btn{ width:auto; }
      .status-bar{ gap:8px; flex-direction:column; align-items:flex-start; }
      .sheet{ max-width:96vw; width:96vw; }
      .edit-footer .btn{ width:100%; }
      .edit-footer{ justify-content:stretch; }
      .grow{ display:none; }
    }
  </style>
</head>
<body>
  <fv-shell>
    <div class="wrap">
      <section class="hero">
        <header class="hero-head">
          <div class="icon" aria-hidden="true">üß∞</div>
          <div>
            <h1>Worker Order Editor</h1>
            <p class="muted">
              View every field maintenance work order, filter by status, edit details, map, photos,
              or delete bad entries.
            </p>
          </div>
        </header>

        <div class="body">
          <div id="masterErr" class="error"></div>

          <div class="toolbar">
            <div class="toolbar-left">
              <button id="btnBack" type="button" class="btn btn-quiet">
                ‚Üê Back to Work Orders
              </button>
            </div>
            <div class="toolbar-right">
              <div class="field-inline">
                <label for="statusFilter">Status</label>
                <select id="statusFilter" class="select">
                  <option value="all">All statuses</option>
                  <option value="needs approved">Needs Approved</option>
                  <option value="pending">Pending</option>
                  <option value="active">Active</option>
                  <option value="complete">Complete</option>
                  <option value="cancelled">Cancelled</option>
                </select>
              </div>

              <!-- SEARCH BAR REMOVED (not needed right now) -->
            </div>
          </div>
        </div>
      </section>

      <!-- Status + list are OUTSIDE the hero card (so they never get clipped/hidden) -->
      <div class="status-bar">
        <div id="woStatus" class="wo-status">Loading work orders‚Ä¶</div>
      </div>
      <div id="woList" class="wo-list"></div>
    </div>
  </fv-shell>

  <!-- Edit Work Order modal -->
  <div id="editModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="editModalTitle">
    <div class="backdrop" data-close></div>
    <div class="sheet">
      <header>
        <div id="editModalTitle">Edit Work Order</div>
        <button class="close" type="button" data-close>Close</button>
      </header>
      <div class="edit-body">
        <div id="editErr" class="error"></div>

        <!-- Farm / Field -->
        <div class="edit-grid">
          <div class="field">
            <div class="fm-row-label">Farm <span class="req">*</span></div>
            <div class="combo">
              <div class="combo-anchor">
                <button id="edFarmBtn" class="buttonish has-caret" type="button">Select farm‚Ä¶</button>
                <div class="combo-panel" id="edFarmPanel">
                  <div class="search"><input id="edFarmSearch" type="search" placeholder="Search farms‚Ä¶"></div>
                  <div class="list" id="edFarmList"></div>
                </div>
              </div>
            </div>
          </div>
          <div class="field">
            <div class="fm-row-label">Field <span class="req">*</span></div>
            <div class="combo">
              <div class="combo-anchor">
                <button id="edFieldBtn" class="buttonish has-caret" type="button">Select field‚Ä¶</button>
                <div class="combo-panel" id="edFieldPanel">
                  <div class="search"><input id="edFieldSearch" type="search" placeholder="Search fields‚Ä¶"></div>
                  <div class="list" id="edFieldList"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Topic / Status -->
        <div class="edit-grid">
          <div class="field">
            <div class="fm-row-label">Topic / Category <span class="req">*</span></div>
            <div class="combo">
              <div class="combo-anchor">
                <button id="edTopicBtn" class="buttonish has-caret" type="button">Select topic‚Ä¶</button>
                <div class="combo-panel" id="edTopicPanel">
                  <div class="search"><input id="edTopicSearch" type="search" placeholder="Search topics‚Ä¶"></div>
                  <div class="list" id="edTopicList"></div>
                </div>
              </div>
            </div>
          </div>
          <div class="field">
            <label class="fm-row-label" for="edStatusSelect">Status <span class="req">*</span></label>
            <select id="edStatusSelect" class="select">
              <option value="needs approved">Needs Approved</option>
              <option value="pending">Pending</option>
              <option value="active">Active</option>
              <option value="complete">Complete</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>
        </div>

        <!-- Priority / Submitted -->
        <div class="edit-grid">
          <div class="field">
            <label class="fm-row-label" for="edPriority">Priority (1 = low, 10 = high) <span class="req">*</span></label>
            <input id="edPriority" class="input" type="range" min="1" max="10" step="1" value="5">
            <div class="priority-readout">
              Priority: <strong><span id="edPriorityValue">5</span>/10</strong>
            </div>
          </div>
          <div class="field">
            <label class="fm-row-label">Submitted</label>
            <div class="wo-sub" id="edSubmittedMeta">
              <!-- date + name/email -->
            </div>
          </div>
        </div>

        <!-- Priority reason -->
        <div id="edPriorityReasonBlock" class="priority-reason" hidden>
          <label class="fm-row-label" for="edPriorityReason">Why is this a high priority? (7‚Äì10)</label>
          <textarea
            id="edPriorityReason"
            class="textarea"
            placeholder="Explain why this needs urgent attention‚Ä¶"></textarea>
        </div>

        <!-- Details / Notes -->
        <div class="field">
          <label class="fm-row-label" for="edNotes">Details / Notes <span class="req">*</span></label>
          <textarea
            id="edNotes"
            class="textarea"
            placeholder="Describe the issue, location in the field, severity, equipment needed, etc."></textarea>
        </div>

        <!-- Location (editable) -->
        <div class="field">
          <label class="fm-row-label">Location (map editable)</label>
          <div class="wo-sub" id="edLocationMeta">
            <!-- "lat, lng" or "No location saved" -->
          </div>
          <div class="wo-actions">
            <button id="btnEditLocation" type="button" class="btn btn-quiet">Edit Location on Map</button>
          </div>
          <input id="edLocationLat" type="hidden">
          <input id="edLocationLng" type="hidden">
        </div>

        <!-- Photos (thumbnails only) -->
        <div class="field">
          <label class="fm-row-label">Photos</label>
          <div id="edPhotoThumbs" class="photo-thumbs"></div>

          <!-- hidden raw URLs editor (kept for saving, but not shown) -->
          <div class="photo-urls-raw">
            <textarea
              id="edPhotoUrlsRaw"
              class="textarea"
              placeholder="https://.../photo1.jpg&#10;https://.../photo2.jpg"></textarea>
          </div>
        </div>

        <!-- Final notes -->
        <div class="field">
          <label class="fm-row-label" for="edWorkPerformed">Work Performed / Final Notes</label>
          <textarea
            id="edWorkPerformed"
            class="textarea"
            placeholder="Summary of what was done (date, equipment, notes, etc.)"></textarea>
        </div>
      </div>
      <div class="edit-footer">
        <!-- DELETE BUTTON REMOVED from modal (delete happens from list w/ FV confirm) -->
        <div class="grow"></div>
        <button id="btnCancelEdit" type="button" class="btn">Cancel</button>
        <button id="btnSaveEdit" type="button" class="btn btn-primary">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- FV-style Delete Confirmation modal -->
  <div id="confirmModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
    <div class="backdrop" data-close></div>
    <div class="sheet confirm-sheet">
      <header>
        <div id="confirmTitle">Confirm Delete</div>
        <button class="close" type="button" data-close>Close</button>
      </header>
      <div class="confirm-body">
        <div class="confirm-title">Delete this work order?</div>
        <div id="confirmMsg" class="confirm-msg">This cannot be undone.</div>
      </div>
      <div class="edit-footer">
        <button id="btnConfirmCancel" type="button" class="btn">Cancel</button>
        <button id="btnConfirmYes" type="button" class="btn btn-danger">Yes, Delete</button>
      </div>
    </div>
  </div>

  <!-- Map modal for editing location -->
  <div id="mapModal" class="modal" role="dialog" aria-modal="true">
    <div class="backdrop" data-close></div>
    <div class="sheet">
      <header>
        <div>Edit Location</div>
        <button class="close" type="button" data-close>Close</button>
      </header>
      <div class="map-modal-body">
        <button id="btnUseEditLocation" type="button" class="btn">
          Use my location
        </button>
        <div class="map-shell">
          <div id="editMap"></div>
          <div class="map-footer">
            <span id="editMapStatus" class="wo-status"></span>
          </div>
        </div>
      </div>
      <footer class="map-modal-footer">
        <button id="btnClearEditLocation" type="button" class="btn btn-quiet">Clear</button>
        <button id="btnCancelEditLocation" type="button" class="btn">Cancel</button>
        <button id="btnSaveEditLocation" type="button" class="btn btn-primary">Save location</button>
      </footer>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite">Saved.</div>

  <!-- Google Maps JS (same key as maintenance-add page) -->
  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCzKBEQ1-wCJ8_nv1dR3wQI0nTk1IrgWzY"></script>

  <script type="module">
    import {
      ready,
      getFirestore,
      collection, getDocs,
      doc, updateDoc, deleteDoc,
      serverTimestamp
    } from '/Farm-vista/js/firebase-init.js';
    import { NAV_MENU } from '/Farm-vista/js/menu.js';

    const $ = id => document.getElementById(id);

    const state = {
      DB: null,
      farms: [],
      fields: [],
      topics: [],
      workOrders: [],
      editing: null,
      editSelections: {
        farm: null,
        field: null,
        topic: null
      },
      confirm: {
        pending: null, // { id, resolve }
      }
    };

    /* ------------ helpers ------------ */
    const showMasterErr = msg => {
      const box = $("masterErr");
      box.textContent = msg || "";
      box.classList.toggle("show", !!msg);
    };
    const showEditErr = msg => {
      const box = $("editErr");
      box.textContent = msg || "";
      box.classList.toggle("show", !!msg);
    };

    const showToast = (msg="Saved.")=>{
      const t = $("toast");
      t.textContent = msg;
      t.classList.remove("show");
      t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"), 3200);
    };

    const esc = s => String(s ?? "").replace(/[&<>"']/g, m =>
      ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])
    );

    function prettyDateFromTs(ts){
      if(!ts) return "";
      try{
        let d;
        if(ts.toDate){
          d = ts.toDate();
        }else if(ts instanceof Date){
          d = ts;
        }else{
          d = new Date(ts);
        }
        if(Number.isNaN(d.getTime())) return "";
        return d.toLocaleDateString();
      }catch{
        return "";
      }
    }

    function inferName(data){
      return data.name || data.farmName || data.fieldName || data.label || "Unnamed";
    }

    /* ---------- global combo closer ---------- */
    function closeAllCombos(exceptPanel=null){
      document.querySelectorAll('.combo-panel.show').forEach(p=>{
        if(p!==exceptPanel) p.classList.remove('show');
      });
    }
    document.addEventListener('click', ()=> closeAllCombos());
    document.addEventListener('keydown', e=>{ if(e.key==='Escape') closeAllCombos(); });

    function makeCombo({
      btn,
      panel,
      list,
      searchInput=null,
      items=[],
      searchable=false,
      formatter=x=>String(x.label||x.name||x),
      onPick
    }) {
      if(!btn || !panel || !list) return;

      panel.addEventListener('click', e=> e.stopPropagation());
      panel.addEventListener('mousedown', e=> e.stopPropagation());

      let DATA = items || [];

      function render(q=""){
        const qq = (q||"").toLowerCase();
        const rows = (DATA || []).filter(x=>{
          const label = formatter(x).toLowerCase();
          return !qq || label.includes(qq);
        });

        let html = "";
        if(rows.length){
          html += rows.map(x=>`<div class="combo-item" data-id="${esc(String(x.id))}">${esc(formatter(x))}</div>`).join('');
        }else{
          html += `<div class="combo-empty">(no matches)</div>`;
        }
        list.innerHTML = html;
      }

      function open(){
        closeAllCombos(panel);
        panel.classList.add('show');
        render("");
        if(searchable && searchInput){
          searchInput.value="";
          searchInput.focus();
        }
      }
      function close(){ panel.classList.remove('show'); }

      btn.addEventListener('click', e=>{
        e.stopPropagation();
        panel.classList.contains('show') ? close() : open();
      });

      list.addEventListener('mousedown', e=>{
        const row = e.target.closest('.combo-item');
        if(!row) return;
        const id = row.dataset.id;
        const it = (DATA || []).find(x => String(x.id) === id);
        if(!it) return;
        onPick?.(it);
        close();
      });

      if(searchable && searchInput){
        searchInput.addEventListener('input', e=>render(e.target.value));
      }

      return {
        setItems(arr){
          DATA = arr || [];
          render("");
        }
      };
    }

    /* ------------ farms & fields for editor ------------ */
    function refreshEditFieldComboForFarm(farmId){
      let list = state.fields;
      if(farmId){
        list = list.filter(f=>f.farmId === farmId);
      }
      editFieldCombo && editFieldCombo.setItems(list);

      const btn = $("edFieldBtn");
      if(state.editSelections.field && farmId && state.editSelections.field.farmId !== farmId){
        state.editSelections.field = null;
        if(btn) btn.textContent = "Select field‚Ä¶";
      }
    }

    function selectEditFarmById(farmId, fallbackName){
      const btn = $("edFarmBtn");
      if(!farmId){
        state.editSelections.farm = null;
        if(btn) btn.textContent = fallbackName || "Select farm‚Ä¶";
        return;
      }
      const farm = state.farms.find(f=>f.id === farmId);
      if(!farm){
        state.editSelections.farm = null;
        if(btn) btn.textContent = fallbackName || "Select farm‚Ä¶";
        return;
      }
      state.editSelections.farm = farm;
      btn.textContent = farm.name;
      refreshEditFieldComboForFarm(farm.id);
    }

    function selectEditFieldById(fieldId, fallbackName){
      const btn = $("edFieldBtn");
      if(!fieldId){
        state.editSelections.field = null;
        if(btn) btn.textContent = fallbackName || "Select field‚Ä¶";
        return;
      }
      const field = state.fields.find(f=>f.id === fieldId);
      if(!field){
        state.editSelections.field = null;
        if(btn) btn.textContent = fallbackName || "Select field‚Ä¶";
        return;
      }
      state.editSelections.field = field;
      btn.textContent = field.name;
    }

    function selectEditTopicById(topicId, fallbackLabel){
      const btn = $("edTopicBtn");
      if(!topicId){
        state.editSelections.topic = null;
        if(btn) btn.textContent = fallbackLabel || "Select topic‚Ä¶";
        return;
      }
      const topic = state.topics.find(t=>t.id === topicId);
      if(!topic){
        state.editSelections.topic = null;
        if(btn) btn.textContent = fallbackLabel || "Select topic‚Ä¶";
        return;
      }
      state.editSelections.topic = { id: topic.id, name: topic.label, label: topic.label };
      btn.textContent = topic.label;
    }

    /* ------------ load Firestore data ------------ */
    async function loadFarms(){
      const snap = await getDocs(collection(state.DB, "farms"));
      state.farms = snap.docs.map(docSnap => {
        const data = docSnap.data() || {};
        return { id: docSnap.id, name: inferName(data) };
      }).sort((a,b)=>a.name.localeCompare(b.name));
      editFarmCombo && editFarmCombo.setItems(state.farms);
    }

    async function loadFields(){
      const snap = await getDocs(collection(state.DB, "fields"));
      state.fields = snap.docs.map(docSnap => {
        const data = docSnap.data() || {};
        const farmId = data.farmId || data.farm || data.farmDocId || null;
        return { id: docSnap.id, name: inferName(data), farmId };
      }).sort((a,b)=>a.name.localeCompare(b.name));
      refreshEditFieldComboForFarm(state.editSelections.farm ? state.editSelections.farm.id : null);
    }

    async function loadTopics(){
      try{
        const snap = await getDocs(collection(state.DB, "fieldMaintenanceTopics"));
        const all = snap.docs.map(docSnap=>{
          const data = docSnap.data() || {};
          return {
            id: docSnap.id,
            label: inferName(data),
            isArchived: !!data.isArchived
          };
        }).sort((a,b)=>a.label.localeCompare(b.label));
        state.topics = all;
        editTopicCombo && editTopicCombo.setItems(
          state.topics.filter(t=>!t.isArchived).map(t=>({id:t.id,name:t.label}))
        );
      }catch(e){
        console.warn("loadTopics error", e);
      }
    }

    async function loadWorkOrders(){
      showMasterErr("");
      $("woStatus").textContent = "Loading work orders‚Ä¶";
      $("woList").innerHTML = "";

      try{
        const ref = collection(state.DB, "fieldMaintenance");
        const snap = await getDocs(ref);

        const rows = snap.docs.map(d=>{
          const data = d.data() || {};
          const createdAt = data.createdAt || data.dateSubmitted || null;
          const submittedByName = data.submittedBy && (data.submittedBy.name || data.submittedBy.email) || "";
          return {
            id: d.id,
            farmId: data.farmId || null,
            farmName: data.farmName || "",
            fieldId: data.fieldId || null,
            fieldName: data.fieldName || "",
            topicId: data.topicId || null,
            topicLabel: data.topicLabel || data.topic || "Untitled",
            priority: typeof data.priority === "number" ? data.priority : null,
            priorityReason: data.priorityReason || "",
            notes: data.notes || "",
            status: data.status || "",
            createdAt,
            submittedBy: submittedByName,
            submittedAt: createdAt,
            photoCount: data.photoCount || 0,
            photoUrls: Array.isArray(data.photoUrls) ? data.photoUrls : null,
            location: data.location || null,
            workPerformed: data.workPerformed || data.finalNotes || "",
            raw: data
          };
        });

        // newest first
        rows.sort((a,b)=>{
          const getTime = x=>{
            if(!x) return 0;
            try{
              if(x.toMillis) return x.toMillis();
              if(x instanceof Date) return x.getTime();
              return new Date(x).getTime() || 0;
            }catch{ return 0; }
          };
          return getTime(b.createdAt) - getTime(a.createdAt);
        });

        state.workOrders = rows;
        applyFilters();
      }catch(e){
        console.error("loadWorkOrders error", e);
        showMasterErr("Unable to load work orders. Check Firestore or network.");
        $("woStatus").textContent = "Error loading work orders.";
      }
    }

    /* ------------ filters + render ------------ */
    function applyFilters(){
      const statusFilter = $("statusFilter").value || "all";
      let rows = state.workOrders.slice();

      if(statusFilter !== "all"){
        rows = rows.filter(r => (r.status || "").toLowerCase() === statusFilter.toLowerCase());
      }

      renderWorkOrders(rows);
    }

    function renderWorkOrders(rows){
      const statusEl = $("woStatus");
      const listEl = $("woList");

      if(!rows.length){
        statusEl.textContent = "No work orders match the current filters.";
        listEl.innerHTML = "";
        return;
      }

      statusEl.textContent = `Showing ${rows.length} work order${rows.length===1?"":"s"}.`;

      listEl.innerHTML = rows.map(row=>{
        const topic = esc(row.topicLabel || "Untitled");
        const status = esc(row.status || "");
        const pr = row.priority != null ? `Priority: ${row.priority}` : "";
        const when = prettyDateFromTs(row.createdAt);
        const who = row.submittedBy ? esc(row.submittedBy) : "";
        const farmField = [row.farmName, row.fieldName].filter(Boolean).join(" ‚Ä¢ ");
        const notes = esc(row.notes || "");

        return `
          <div class="wo-item" data-id="${esc(row.id)}">
            <div class="wo-header">
              <div class="wo-topic">${topic}</div>
              <div class="wo-pill">${status || " "}</div>
            </div>
            <div class="wo-sub">
              <span>${farmField || "No farm / field set"}</span>
              <span>${when || ""}</span>
              <span>${who || ""}</span>
              ${pr ? `<span>${esc(pr)}</span>` : ""}
            </div>
            <div class="wo-notes">
              ${notes || "<span class='wo-empty'>No notes entered.</span>"}
            </div>
            <div class="wo-actions">
              <button type="button" class="btn btn-quiet act-edit">Edit</button>
              <button type="button" class="btn btn-danger act-delete">Delete</button>
            </div>
          </div>
        `;
      }).join("");
    }

    /* ------------ edit modal ------------ */
    function openEditModalForId(id){
      const row = state.workOrders.find(r => r.id === id);
      if(!row) return;

      state.editing = row;
      state.editSelections.farm = null;
      state.editSelections.field = null;
      state.editSelections.topic = null;

      showEditErr("");
      $("editModalTitle").textContent = `Edit Work Order ‚Äì ${row.topicLabel || "Untitled"}`;

      // Submitted meta
      const submittedParts = [];
      if(row.submittedAt){
        submittedParts.push(prettyDateFromTs(row.submittedAt));
      }
      if(row.submittedBy){
        submittedParts.push(row.submittedBy);
      }
      $("edSubmittedMeta").textContent = submittedParts.join(" ‚Ä¢ ") || "No submitted info saved.";

      // Location meta + hidden fields
      if(row.location && typeof row.location.lat === "number" && typeof row.location.lng === "number"){
        $("edLocationMeta").textContent = `${row.location.lat.toFixed(5)}, ${row.location.lng.toFixed(5)}`;
        $("edLocationLat").value = row.location.lat;
        $("edLocationLng").value = row.location.lng;
      }else{
        $("edLocationMeta").textContent = "No location saved on this work order.";
        $("edLocationLat").value = "";
        $("edLocationLng").value = "";
      }

      // status
      const statusSel = $("edStatusSelect");
      const stVal = row.status || "pending";
      if(Array.from(statusSel.options).some(o=>o.value===stVal)){
        statusSel.value = stVal;
      }else{
        statusSel.value = "pending";
      }

      // priority + reason
      const prSlider = $("edPriority");
      const prValue = $("edPriorityValue");
      const prBlock = $("edPriorityReasonBlock");
      const prReason = $("edPriorityReason");

      const pVal = typeof row.priority === "number" ? row.priority : 5;
      prSlider.value = pVal;
      prValue.textContent = pVal;
      if(pVal >= 7){
        prBlock.hidden = false;
        prReason.value = row.priorityReason || "";
      }else{
        prBlock.hidden = true;
        prReason.value = "";
      }

      // notes
      $("edNotes").value = row.notes || "";

      // farm/field/topic
      selectEditFarmById(row.farmId || null, row.farmName || "Select farm‚Ä¶");
      refreshEditFieldComboForFarm(row.farmId || null);
      selectEditFieldById(row.fieldId || null, row.fieldName || "Select field‚Ä¶");
      selectEditTopicById(row.topicId || null, row.topicLabel || "Select topic‚Ä¶");

      // photos (thumbs only)
      const thumbsEl = $("edPhotoThumbs");
      const urlsArea = $("edPhotoUrlsRaw");
      thumbsEl.innerHTML = "";
      const urls = Array.isArray(row.photoUrls) ? row.photoUrls : [];
      urlsArea.value = urls.join("\n"); // hidden, but used for saving

      if(urls.length){
        urls.forEach(url=>{
          const div = document.createElement("div");
          div.className = "photo-thumb";
          const img = document.createElement("img");
          img.src = url;
          img.alt = "Photo";
          div.appendChild(img);
          thumbsEl.appendChild(div);
        });
      }else{
        const span = document.createElement("span");
        span.className = "wo-status";
        span.textContent = row.photoCount
          ? `${row.photoCount} photo(s) recorded but no URLs stored.`
          : "No photos saved.";
        thumbsEl.appendChild(span);
      }

      // final notes
      $("edWorkPerformed").value = row.workPerformed || "";

      // Show modal
      const modal = $("editModal");
      modal.classList.add("show");
      document.body.style.overflow = "hidden";
    }

    function closeEditModal(){
      const modal = $("editModal");
      modal.classList.remove("show");
      document.body.style.overflow = "";
      state.editing = null;
      state.editSelections.farm = null;
      state.editSelections.field = null;
      state.editSelections.topic = null;
    }

    function setupPriorityEditor(){
      const slider = $("edPriority");
      const valSpan = $("edPriorityValue");
      const block = $("edPriorityReasonBlock");
      const reason = $("edPriorityReason");

      const sync = ()=>{
        const v = Number(slider.value || 5);
        valSpan.textContent = v;
        if(v>=7){
          block.hidden = false;
        }else{
          block.hidden = true;
          reason.value = "";
        }
      };
      slider.addEventListener("input", sync);
      sync();
    }

    function parsePhotoUrls(){
      const raw = $("edPhotoUrlsRaw").value || "";
      const urls = raw.split(/\n+/).map(s=>s.trim()).filter(Boolean);
      return urls;
    }

    async function saveEdit(){
      if(!state.editing || !state.DB) return;
      showEditErr("");

      const farmSel = state.editSelections.farm;
      const fieldSel = state.editSelections.field;
      const topicSel = state.editSelections.topic;

      const status = $("edStatusSelect").value || "";
      const priority = Number($("edPriority").value || 0);
      const notes = $("edNotes").value.trim();
      const priorityReason = $("edPriorityReason").value.trim();

      const fallbackFarmName = state.editing.farmName || null;
      const fallbackFieldName = state.editing.fieldName || null;
      const fallbackTopicLabel = state.editing.topicLabel || null;

      const farmId = farmSel ? farmSel.id : (state.editing.farmId || "");
      const fieldId = fieldSel ? fieldSel.id : (state.editing.fieldId || "");
      const topicId = topicSel ? topicSel.id : (state.editing.topicId || "");
      const farmName = farmSel ? farmSel.name : (fallbackFarmName || null);
      const fieldName = fieldSel ? fieldSel.name : (fallbackFieldName || null);
      const topicLabel = topicSel ? (topicSel.label || topicSel.name) : (fallbackTopicLabel || null);

      const workPerformed = $("edWorkPerformed").value.trim();

      // location
      const latStr = $("edLocationLat").value;
      const lngStr = $("edLocationLng").value;
      let location = null;
      if(latStr && lngStr){
        const latN = Number(latStr);
        const lngN = Number(lngStr);
        if(!Number.isNaN(latN) && !Number.isNaN(lngN)){
          location = { lat: latN, lng: lngN };
        }
      }

      if(!farmId || !fieldId || !topicId || !notes){
        showEditErr("Farm, Field, Topic, and Notes are required.");
        return;
      }
      if(!priority || priority<1 || priority>10){
        showEditErr("Priority must be between 1 and 10.");
        return;
      }
      if(!status){
        showEditErr("Status is required.");
        return;
      }
      if(priority>=7 && !priorityReason){
        showEditErr("Please explain why this is a high-priority (7‚Äì10) item.");
        return;
      }

      const ref = doc(state.DB, "fieldMaintenance", state.editing.id);

      const photoUrls = parsePhotoUrls();
      const photoCount = photoUrls.length;

      const payload = {
        farmId,
        farmName,
        fieldId,
        fieldName,
        topicId,
        topicLabel,
        priority,
        priorityReason: priority>=7 ? priorityReason : null,
        notes,
        status,
        workPerformed: workPerformed || null,
        photoUrls,
        photoCount,
        updatedAt: serverTimestamp()
      };

      payload.location = location ? location : null;

      $("btnSaveEdit").disabled = true;

      try{
        await updateDoc(ref, payload);
        showToast("Work order updated.");

        // Update local cache so UI stays in sync without full reload
        const idx = state.workOrders.findIndex(w=>w.id===state.editing.id);
        if(idx !== -1){
          const existing = state.workOrders[idx];
          state.workOrders[idx] = {
            ...existing,
            farmId,
            farmName: farmName || "",
            fieldId,
            fieldName: fieldName || "",
            topicId,
            topicLabel: topicLabel || "",
            priority,
            priorityReason: priority>=7 ? priorityReason : "",
            notes,
            status,
            workPerformed,
            photoUrls,
            photoCount,
            location
          };
        }

        closeEditModal();
        applyFilters();
      }catch(e){
        console.error("saveEdit error", e);
        showEditErr("Failed to save changes. Check permissions or network.");
      }finally{
        $("btnSaveEdit").disabled = false;
      }
    }

    /* ------------ FV confirm modal ------------ */
    function openConfirmDelete({ id, label }){
      return new Promise(resolve=>{
        state.confirm.pending = { id, resolve };
        $("confirmMsg").textContent = label
          ? `Delete "${label}"? This cannot be undone.`
          : "Delete this work order? This cannot be undone.";

        const modal = $("confirmModal");
        modal.classList.add("show");
        document.body.style.overflow = "hidden";
      });
    }

    function closeConfirmModal(result=false){
      const modal = $("confirmModal");
      modal.classList.remove("show");
      document.body.style.overflow = "";
      const pending = state.confirm.pending;
      state.confirm.pending = null;
      pending?.resolve?.(result);
    }

    async function deleteWorkOrderById(id){
      if(!state.DB || !id) return;
      try{
        const ref = doc(state.DB, "fieldMaintenance", id);
        await deleteDoc(ref);
        showToast("Work order deleted.");
        state.workOrders = state.workOrders.filter(w=>w.id !== id);
        applyFilters();
      }catch(e){
        console.error("deleteWorkOrderById error", e);
        showMasterErr("Failed to delete this work order.");
      }
    }

    /* ------------ map editing ------------ */
    let editMap = null;
    let editMapMarker = null;

    function ensureEditMap(){
      if(editMap) return;
      const el = $("editMap");
      if(!el) return;

      if(!(window.google && window.google.maps)){
        $("editMapStatus").textContent = "Map failed to load. Check your connection.";
        return;
      }

      const center = { lat: 39.8283, lng: -98.5795 }; // US center default
      editMap = new google.maps.Map(el, {
        center,
        zoom: 16,
        mapTypeId: "satellite",
        disableDefaultUI: true,
        zoomControl: true
      });

      editMap.addListener("click", (ev)=>{
        setEditMapMarker(ev.latLng);
      });
    }

    function setEditMapMarker(latLng){
      if(!latLng || !editMap) return;
      if(!editMapMarker){
        editMapMarker = new google.maps.Marker({
          position: latLng,
          map: editMap
        });
      }else{
        editMapMarker.setPosition(latLng);
      }
      $("editMapStatus").textContent = "Pin set. Tap again to move it.";
    }

    function openMapModal(){
      const modal = $("mapModal");
      if(!modal) return;
      modal.classList.add("show");
      document.body.style.overflow = "hidden";

      ensureEditMap();

      const lat = parseFloat($("edLocationLat").value);
      const lng = parseFloat($("edLocationLng").value);
      if(editMap && !Number.isNaN(lat) && !Number.isNaN(lng)){
        const ll = new google.maps.LatLng(lat, lng);
        editMap.setCenter(ll);
        editMap.setZoom(18);
        setEditMapMarker(ll);
      }else if(editMap){
        $("editMapStatus").textContent = "Tap on the map to drop a pin.";
      }
    }

    function closeMapModal(){
      const modal = $("mapModal");
      if(!modal) return;
      modal.classList.remove("show");
      document.body.style.overflow = "";
    }

    function setupMapModal(){
      const modal = $("mapModal");
      const backdrop = modal.querySelector(".backdrop");
      const closeBtns = modal.querySelectorAll("[data-close]");

      backdrop.addEventListener("click", closeMapModal);
      closeBtns.forEach(btn=>btn.addEventListener("click", closeMapModal));

      $("btnUseEditLocation").addEventListener("click", ()=>{
        if(!navigator.geolocation){
          $("editMapStatus").textContent = "Geolocation not supported on this device.";
          return;
        }
        $("editMapStatus").textContent = "Getting your location‚Ä¶";
        navigator.geolocation.getCurrentPosition(
          pos=>{
            ensureEditMap();
            if(!editMap) return;
            const ll = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
            editMap.panTo(ll);
            editMap.setZoom(18);
            setEditMapMarker(ll);
          },
          ()=>{
            $("editMapStatus").textContent = "Could not get current location. Check permissions.";
          },
          { enableHighAccuracy:true, timeout:12000 }
        );
      });

      $("btnSaveEditLocation").addEventListener("click", ()=>{
        if(!editMapMarker){
          $("editMapStatus").textContent = "Tap on the map to set a pin before saving.";
          return;
        }
        const pos = editMapMarker.getPosition();
        const lat = pos.lat();
        const lng = pos.lng();
        $("edLocationLat").value = lat;
        $("edLocationLng").value = lng;
        $("edLocationMeta").textContent = `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
        showToast("Location updated.");
        closeMapModal();
      });

      $("btnClearEditLocation").addEventListener("click", ()=>{
        $("edLocationLat").value = "";
        $("edLocationLng").value = "";
        $("edLocationMeta").textContent = "No location saved on this work order.";
        if(editMapMarker){
          editMapMarker.setMap(null);
          editMapMarker = null;
        }
        showToast("Location cleared.");
        closeMapModal();
      });

      $("btnCancelEditLocation").addEventListener("click", closeMapModal);
      $("btnEditLocation").addEventListener("click", openMapModal);
    }

    /* ------------ shell + events ------------ */
    function setupShellNav(){
      const shell = document.querySelector("fv-shell");
      if(shell && NAV_MENU) shell.nav = NAV_MENU;
    }

    function setupToolbar(){
      $("btnBack").addEventListener("click", ()=>{
        location.href = "/Farm-vista/pages/crop-production/maintenance.html";
      });

      $("statusFilter").addEventListener("change", applyFilters);

      const listEl = $("woList");
      listEl.addEventListener("click", async e=>{
        const item = e.target.closest(".wo-item");
        if(!item) return;
        const id = item.dataset.id;
        if(!id) return;

        if(e.target.classList.contains("act-edit")){
          openEditModalForId(id);
          return;
        }

        if(e.target.classList.contains("act-delete")){
          const row = state.workOrders.find(r=>r.id===id);
          const label = row ? (row.topicLabel || "Work Order") : "Work Order";
          const ok = await openConfirmDelete({ id, label });
          if(ok){
            await deleteWorkOrderById(id);
          }
        }
      });
    }

    function setupEditModalChrome(){
      const modal = $("editModal");
      modal.querySelectorAll("[data-close]").forEach(el=>{
        el.addEventListener("click", closeEditModal);
      });
      modal.querySelector(".backdrop").addEventListener("click", closeEditModal);

      $("btnCancelEdit").addEventListener("click", closeEditModal);
      $("btnSaveEdit").addEventListener("click", saveEdit);

      setupPriorityEditor();
    }

    function setupConfirmModal(){
      const modal = $("confirmModal");
      modal.querySelector(".backdrop").addEventListener("click", ()=>closeConfirmModal(false));
      modal.querySelectorAll("[data-close]").forEach(el=>{
        el.addEventListener("click", ()=>closeConfirmModal(false));
      });

      $("btnConfirmCancel").addEventListener("click", ()=>closeConfirmModal(false));
      $("btnConfirmYes").addEventListener("click", ()=>closeConfirmModal(true));

      document.addEventListener("keydown", (e)=>{
        if(e.key === "Escape" && modal.classList.contains("show")){
          closeConfirmModal(false);
        }
      });
    }

    /* ------------ combos for editor ------------ */
    let editFarmCombo = null;
    let editFieldCombo = null;
    let editTopicCombo = null;

    function setupEditCombos(){
      editFarmCombo = makeCombo({
        btn: $("edFarmBtn"),
        panel: $("edFarmPanel"),
        list: $("edFarmList"),
        searchInput: $("edFarmSearch"),
        searchable: true,
        formatter: x => x.name,
        onPick: it=>{
          state.editSelections.farm = it;
          $("edFarmBtn").textContent = it.name;
          refreshEditFieldComboForFarm(it.id);
        }
      });

      editFieldCombo = makeCombo({
        btn: $("edFieldBtn"),
        panel: $("edFieldPanel"),
        list: $("edFieldList"),
        searchInput: $("edFieldSearch"),
        searchable: true,
        formatter: x => x.name,
        onPick: it=>{
          state.editSelections.field = it;
          $("edFieldBtn").textContent = it.name;
        }
      });

      editTopicCombo = makeCombo({
        btn: $("edTopicBtn"),
        panel: $("edTopicPanel"),
        list: $("edTopicList"),
        searchInput: $("edTopicSearch"),
        searchable: true,
        formatter: x => x.name,
        onPick: it=>{
          state.editSelections.topic = { id: it.id, name: it.name, label: it.name };
          $("edTopicBtn").textContent = it.name;
        }
      });
    }

    /* ------------ boot ------------ */
    (async function boot(){
      await ready;
      state.DB = getFirestore();

      setupShellNav();
      setupToolbar();
      setupEditModalChrome();
      setupEditCombos();
      setupMapModal();
      setupConfirmModal();

      try{
        await Promise.all([
          loadFarms(),
          loadFields(),
          loadTopics()
        ]);
      }catch(e){
        console.error("Initial farms/fields/topics load failed", e);
        showMasterErr("Unable to load farms, fields, or topics. Check Firestore or network.");
      }

      await loadWorkOrders();
    })();
  </script>
</body>
</html>
