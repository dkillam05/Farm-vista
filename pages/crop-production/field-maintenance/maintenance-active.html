<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FarmVista • Active Field Maintenance Work Orders</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#3B7E46" />

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest" />
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png" />
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png" />
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css" />
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css" />

  <style>
    /* Make sure anything with [hidden] is actually hidden, even inside fv-shell */
    [hidden] {
      display: none !important;
    }

    .page-header {
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-bottom:18px;
    }

    .page-header-top {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    .page-header-meta {
      font-size:0.9rem;
      opacity:0.8;
    }

    .btn-back {
      border-radius:999px;
      border:1px solid var(--border-strong, var(--border));
      background:var(--surface-raised, var(--surface));
      padding:6px 10px;
      font-size:0.85rem;
      display:inline-flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
    }
    .btn-back span.icon {
      font-size:1.1rem;
      line-height:1;
    }

    .wo-list {
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:8px;
    }

    .wo-empty {
      padding:14px 16px;
      border-radius:12px;
      border:1px dashed var(--border);
      background:var(--card-surface, var(--surface));
      font-size:0.95rem;
      opacity:0.9;
    }

    .wo-card {
      border-radius:14px;
      border:1px solid var(--card-border, var(--border));
      background:var(--card-surface, var(--surface));
      box-shadow:var(--shadow-soft, var(--shadow));
      padding:12px 14px 10px;
      display:flex;
      flex-direction:column;
      gap:6px;
      transition:transform .06s, box-shadow .12s, border-color .12s, background .12s;
      cursor:pointer;
    }
    .wo-card:active {
      transform:scale(.995);
      box-shadow:var(--shadow);
    }

    .wo-row-top {
      display:flex;
      align-items:flex-start;
      gap:10px;
    }

    .wo-main {
      flex:1 1 auto;
      min-width:0;
    }

    .wo-title {
      font-weight:700;
      font-size:0.98rem;
      line-height:1.3;
    }

    .wo-sub {
      font-size:0.86rem;
      opacity:0.9;
      margin-top:2px;
    }

    .wo-meta {
      display:flex;
      flex-wrap:wrap;
      gap:6px 10px;
      margin-top:4px;
      font-size:0.8rem;
      opacity:0.85;
    }

    .wo-meta span {
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 7px;
      border-radius:999px;
      background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
    }

    .wo-meta-label {
      font-weight:600;
    }

    /* Status select on the right */
    .wo-status-wrap {
      flex:0 0 auto;
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:4px;
      padding-left:4px;
      min-width:150px;
    }

    .wo-status-label {
      font-size:0.78rem;
      text-transform:uppercase;
      letter-spacing:0.06em;
      opacity:0.75;
    }

    .wo-status-select {
      width:100%;
      max-width:170px;
      font:inherit;
      font-size:0.9rem;
      border-radius:999px;
      border:1px solid var(--border);
      padding:5px 10px;
      background:var(--card-surface, var(--surface));
      color:var(--text);
      outline:none;
      cursor:pointer;
    }

    .wo-bottom-row {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      font-size:0.78rem;
      opacity:0.8;
      margin-top:4px;
      flex-wrap:wrap;
    }

    .wo-status-chip {
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 8px;
      border-radius:999px;
      font-size:0.78rem;
      text-transform:uppercase;
      letter-spacing:0.06em;
      background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
    }

    /* Detail overlay */
    .wo-detail-overlay {
      position:fixed;
      inset:0;
      background:color-mix(in srgb, #000 45%, transparent);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:9999;
    }

    .wo-detail-panel {
      width:min(640px, 100% - 24px);
      max-height:90vh;
      border-radius:16px;
      background:var(--surface-raised, var(--card-surface, var(--surface)));
      box-shadow:var(--shadow-strong, 0 18px 45px rgba(0,0,0,0.35));
      padding:16px 16px 14px;
      display:flex;
      flex-direction:column;
      gap:12px;
      overflow:auto;
    }

    .wo-detail-header {
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
    }

    .wo-detail-title {
      font-weight:700;
      font-size:1rem;
      line-height:1.3;
    }

    .wo-detail-sub {
      font-size:0.86rem;
      opacity:0.9;
      margin-top:2px;
    }

    .wo-detail-close {
      border:none;
      background:transparent;
      font-size:1.3rem;
      line-height:1;
      cursor:pointer;
      padding:4px;
      border-radius:999px;
    }

    .wo-detail-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(160px, 1fr));
      gap:8px;
      font-size:0.82rem;
    }

    .wo-detail-chip {
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:3px 8px;
      border-radius:999px;
      background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
      font-size:0.78rem;
    }

    .wo-detail-label {
      font-weight:600;
      font-size:0.78rem;
      opacity:0.9;
    }

    .wo-detail-section {
      border-top:1px solid var(--border-soft, var(--border));
      padding-top:10px;
      margin-top:6px;
    }

    .wo-detail-section h3 {
      font-size:0.88rem;
      margin:0 0 4px;
    }

    .wo-detail-notes {
      font-size:0.82rem;
      white-space:pre-wrap;
    }

    .wo-detail-textarea {
      width:100%;
      min-height:80px;
      resize:vertical;
      font:inherit;
      font-size:0.82rem;
      padding:6px 8px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--surface);
      color:var(--text);
      box-sizing:border-box;
    }

    .wo-detail-row {
      display:flex;
      flex-wrap:wrap;
      gap:8px 10px;
      align-items:center;
      font-size:0.82rem;
    }

    .wo-detail-select,
    .wo-detail-input {
      font:inherit;
      font-size:0.82rem;
      padding:5px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--surface);
      color:var(--text);
      min-width:0;
    }

    .wo-detail-input {
      border-radius:10px;
      flex:1 1 120px;
    }

    .wo-detail-footer {
      display:flex;
      justify-content:flex-end;
      gap:8px;
      margin-top:6px;
    }

    .btn-outline {
      border-radius:999px;
      border:1px solid var(--border-strong, var(--border));
      background:var(--surface);
      padding:6px 12px;
      font-size:0.85rem;
      cursor:pointer;
    }

    .btn-primary {
      border-radius:999px;
      border:1px solid transparent;
      background:var(--green, #3B7E46);
      color:#fff;
      padding:6px 14px;
      font-size:0.85rem;
      font-weight:600;
      cursor:pointer;
    }

    @media (max-width:600px){
      .wo-detail-panel {
        border-radius:18px 18px 0 0;
        max-height:92vh;
        margin:0;
        align-self:flex-end;
      }
    }
  </style>

  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true;
        document.head.appendChild(s);
      }
    })();
  </script>

  <script type="module">
    import {
      ready,
      getFirestore,
      collection, query, where, getDocs,
      updateDoc, doc, serverTimestamp
    } from '/Farm-vista/js/firebase-init.js';

    import { NAV_MENU } from '/Farm-vista/js/menu.js';

    const CONFIG = {
      COLLECTION_PATH: 'fieldMaintenance',
      STATUS_FIELD:    'status',
      STATUS_PENDING:  'pending',
      STATUS_INPROG:   'in progress',
      STATUS_DONE:     'completed'
    };

    const $ = (sel, root=document) => root.querySelector(sel);

    const STATE = {
      db: null,
      items: [],
      currentItem: null
    };

    function getTime(ts){
      if(!ts) return 0;
      try{
        if(ts.toMillis) return ts.toMillis();
        if(ts.toDate)   return ts.toDate().getTime();
        if(ts instanceof Date) return ts.getTime();
        return new Date(ts).getTime() || 0;
      }catch{
        return 0;
      }
    }

    function openDetail(item){
      STATE.currentItem = item;
      const data = item.data;

      const field = data.fieldName || data.field || 'Field not set';
      const farm  = data.farmName  || data.farm  || '';
      const topic = data.topicLabel || data.topic || data.category || data.title || 'Maintenance';
      const priority = data.priority ?? data.priorityLevel ?? null;
      const equip = data.equipmentName || data.equipment || '';
      const createdBy = (data.submittedBy && (data.submittedBy.name || data.submittedBy.email))
                        || data.createdByName || data.createdBy || '';
      const ts = data.createdAt || data.dateSubmitted || data.timestamp || null;
      const when = ts && ts.toDate ? ts.toDate() : null;
      const status = (data[CONFIG.STATUS_FIELD] || '').toString() || 'pending';

      const originalNotes = data.details || data.description || data.notes || '';

      const overlay = $('#woDetailOverlay');
      const titleEl = $('#detailTitle');
      const subEl   = $('#detailSub');
      const chipsEl = $('#detailChips');
      const createdEl = $('#detailCreated');
      const statusChipEl = $('#detailStatusChip');
      const origNotesEl = $('#detailNotesOriginal');
      const compNotesEl = $('#detailNotesCompletion');
      const whoTypeSel  = $('#detailWhoType');
      const whoNamesInp = $('#detailWhoNames');

      if(titleEl){
        titleEl.textContent = farm ? `${field} · ${farm}` : field;
      }
      if(subEl){
        subEl.textContent = topic;
      }

      if(chipsEl){
        chipsEl.innerHTML = '';
        if(priority !== null){
          const span = document.createElement('span');
          span.className = 'wo-detail-chip';
          span.innerHTML = `<span class="wo-detail-label">Priority</span> ${priority}`;
          chipsEl.appendChild(span);
        }
        if(equip){
          const span = document.createElement('span');
          span.className = 'wo-detail-chip';
          span.innerHTML = `<span class="wo-detail-label">Equip</span> ${equip}`;
          chipsEl.appendChild(span);
        }
        if(createdBy){
          const span = document.createElement('span');
          span.className = 'wo-detail-chip';
          span.innerHTML = `<span class="wo-detail-label">By</span> ${createdBy}`;
          chipsEl.appendChild(span);
        }
      }

      if(createdEl){
        createdEl.textContent = when
          ? `Created ${when.toLocaleDateString()} ${when.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`
          : '';
      }
      if(statusChipEl){
        statusChipEl.textContent = status;
      }

      if(origNotesEl){
        origNotesEl.textContent = originalNotes || 'No original description was provided.';
      }

      if(compNotesEl){
        compNotesEl.value = data.completionNotes || '';
      }

      // Worker assignment (simple for now – we’ll hook to real lists later)
      if(whoTypeSel){
        whoTypeSel.value = data.assignedWorkerType || 'employee';
      }
      if(whoNamesInp){
        whoNamesInp.value = data.assignedWorkersNote || '';
      }

      if(overlay){
        overlay.hidden = false;
        document.body.style.overflow = 'hidden';
      }
    }

    function closeDetail(){
      const overlay = $('#woDetailOverlay');
      if(overlay){
        overlay.hidden = true;
      }
      document.body.style.overflow = '';
      STATE.currentItem = null;
    }

    async function saveDetailUpdates(){
      const item = STATE.currentItem;
      if(!item || !STATE.db) return;

      const compNotesEl = $('#detailNotesCompletion');
      const whoTypeSel  = $('#detailWhoType');
      const whoNamesInp = $('#detailWhoNames');

      const updates = {
        updatedAt: serverTimestamp()
      };

      if(compNotesEl){
        updates.completionNotes = compNotesEl.value.trim();
      }
      if(whoTypeSel){
        updates.assignedWorkerType = whoTypeSel.value || 'employee';
      }
      if(whoNamesInp){
        updates.assignedWorkersNote = whoNamesInp.value.trim();
      }

      try {
        await updateDoc(doc(STATE.db, CONFIG.COLLECTION_PATH, item.id), updates);

        // Update local copy so the data stays in sync if reopened
        Object.assign(item.data, updates);

        closeDetail();
      } catch(err){
        console.error('Failed to save detail updates:', err);
        alert('Could not save updates. Please try again.');
      }
    }

    function renderList(){
      const listEl  = $('.wo-list');
      const emptyEl = $('.wo-empty');
      listEl.innerHTML = '';

      if(!STATE.items.length){
        if(emptyEl) emptyEl.style.display = 'block';
        const countEl = $('#woCount');
        if(countEl) countEl.textContent = '0 active work orders';
        return;
      }
      if(emptyEl) emptyEl.style.display = 'none';

      for(const item of STATE.items){
        const data = item.data;
        const id   = item.id;

        const field = data.fieldName || data.field || 'Field not set';
        const farm  = data.farmName  || data.farm  || '';
        const topic = data.topicLabel || data.topic || data.category || data.title || 'Maintenance';
        const priority = data.priority ?? data.priorityLevel ?? null;
        const equip = data.equipmentName || data.equipment || '';
        const createdBy = (data.submittedBy && (data.submittedBy.name || data.submittedBy.email))
                          || data.createdByName || data.createdBy || '';
        const ts = data.createdAt || data.dateSubmitted || data.timestamp || null;
        const when = ts && ts.toDate ? ts.toDate() : null;
        const status = (data[CONFIG.STATUS_FIELD] || '').toString();

        const card = document.createElement('article');
        card.className = 'wo-card';
        card.dataset.id = id;

        card.innerHTML = `
          <div class="wo-row-top">
            <div class="wo-main">
              <div class="wo-title">
                ${field ? `<span>${field}</span>` : 'Maintenance Work Order'}
                ${farm ? ` · <span>${farm}</span>` : ''}
              </div>
              <div class="wo-sub">
                ${topic}
              </div>
              <div class="wo-meta">
                ${priority !== null ? `
                  <span><span class="wo-meta-label">Priority</span> ${priority}</span>
                ` : ''}
                ${equip ? `
                  <span><span class="wo-meta-label">Equip</span> ${equip}</span>
                ` : ''}
                ${createdBy ? `
                  <span><span class="wo-meta-label">By</span> ${createdBy}</span>
                ` : ''}
              </div>
            </div>

            <div class="wo-status-wrap">
              <div class="wo-status-label">Status</div>
              <select class="wo-status-select">
                <option value="${CONFIG.STATUS_PENDING}">Pending</option>
                <option value="${CONFIG.STATUS_INPROG}">In Progress</option>
                <option value="${CONFIG.STATUS_DONE}">Completed</option>
              </select>
            </div>
          </div>

          <div class="wo-bottom-row">
            <div>
              ${when ? `Created ${when.toLocaleDateString()} ${when.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}` : ''}
            </div>
            <div class="wo-status-chip">${status || 'unknown'}</div>
          </div>
        `;

        const select = card.querySelector('.wo-status-select');
        const chip   = card.querySelector('.wo-status-chip');

        // Set dropdown to current status
        if(status === CONFIG.STATUS_INPROG){
          select.value = CONFIG.STATUS_INPROG;
        }else if(status === CONFIG.STATUS_DONE){
          select.value = CONFIG.STATUS_DONE;
        }else{
          select.value = CONFIG.STATUS_PENDING;
        }

        // Status change handler
        select.addEventListener('change', async (ev) => {
          const newStatus = ev.target.value;

          try{
            await updateDoc(doc(STATE.db, CONFIG.COLLECTION_PATH, id), {
              [CONFIG.STATUS_FIELD]: newStatus,
              updatedAt: serverTimestamp()
            });

            if(newStatus === CONFIG.STATUS_DONE){
              // Completed → drop from list
              STATE.items = STATE.items.filter(x => x.id !== id);
              renderList();
            }else{
              // Keep in list, update chip + local status
              item.data[CONFIG.STATUS_FIELD] = newStatus;
              if(chip) chip.textContent = newStatus;
            }
          }catch(err){
            console.error('Failed to update status:', err);
            alert('Could not update work order status. Please try again.');
            // revert dropdown
            ev.target.value = status || CONFIG.STATUS_PENDING;
          }
        });

        // Card click -> open detail view (ignore clicks directly on the status select)
        card.addEventListener('click', (ev) => {
          if(ev.target.closest('.wo-status-select')) return;
          openDetail(item);
        });

        listEl.appendChild(card);
      }

      const countEl = $('#woCount');
      if(countEl){
        countEl.textContent = `${STATE.items.length} active work order${STATE.items.length === 1 ? '' : 's'}`;
      }
    }

    async function loadActiveWorkOrders(){
      const db  = STATE.db;
      const ref = collection(db, CONFIG.COLLECTION_PATH);

      try{
        const q = query(
          ref,
          where(CONFIG.STATUS_FIELD, 'in', [CONFIG.STATUS_PENDING, CONFIG.STATUS_INPROG])
        );

        const snap = await getDocs(q);

        const items = snap.docs.map(d => ({
          id: d.id,
          data: d.data()
        }));

        // Sort newest → oldest by createdAt / dateSubmitted / timestamp
        items.sort((a,b) => {
          const ta = getTime(a.data.createdAt || a.data.dateSubmitted || a.data.timestamp);
          const tb = getTime(b.data.createdAt || b.data.dateSubmitted || b.data.timestamp);
          return tb - ta;
        });

        STATE.items = items;
        renderList();
      }catch(err){
        console.error('Error loading active work orders:', err);
        const emptyEl = $('.wo-empty');
        if(emptyEl){
          emptyEl.textContent = 'Error loading work orders. Check console or Firestore indexes.';
          emptyEl.style.display = 'block';
        }
        const countEl = $('#woCount');
        if(countEl) countEl.textContent = 'Error loading work orders';
      }
    }

    (async function boot(){
      await ready;
      STATE.db = getFirestore();

      const shell = document.querySelector('fv-shell');
      if (shell) shell.nav = NAV_MENU;

      const overlay = $('#woDetailOverlay');
      if(overlay){
        overlay.addEventListener('click', (ev)=>{
          if(ev.target === overlay){
            closeDetail();
          }
        });
      }

      const closeBtn = $('#detailCloseBtn');
      if(closeBtn){
        closeBtn.addEventListener('click', closeDetail);
      }

      const cancelBtn = $('#detailCancelBtn');
      if(cancelBtn){
        cancelBtn.addEventListener('click', closeDetail);
      }

      const saveBtn = $('#detailSaveBtn');
      if(saveBtn){
        saveBtn.addEventListener('click', (ev)=>{
          ev.preventDefault();
          saveDetailUpdates();
        });
      }

      await loadActiveWorkOrders();
    })();
  </script>
</head>

<body>
  <fv-shell>
    <div class="page container">

      <header class="page-header">
        <div class="page-header-top">
          <h1 class="page-title">Active Field Maintenance Work Orders</h1>
          <button type="button" class="btn-back"
            onclick="location.href='/Farm-vista/pages/crop-production/maintenance.html'">
            <span class="icon">←</span>
            <span>Back to Field Maintenance</span>
          </button>
        </div>
        <div class="page-sub">
          Shows all work orders that have passed approval and are currently
          <strong>Pending</strong> or <strong>In Progress</strong>. Use the
          status dropdown to move them to <strong>In Progress</strong> or
          straight to <strong>Completed</strong>.
        </div>
        <div class="page-header-meta" id="woCount">
          0 active work orders
        </div>
      </header>

      <section aria-label="Pending and in-progress work orders">
        <div class="wo-empty">
          No work orders are currently pending or in progress.
          Once work orders are approved and ready to work, they will appear here.
        </div>
        <div class="wo-list"></div>
      </section>

    </div>

    <!-- Detail overlay -->
    <div id="woDetailOverlay" class="wo-detail-overlay" hidden>
      <div class="wo-detail-panel" role="dialog" aria-modal="true">
        <header class="wo-detail-header">
          <div>
            <div id="detailTitle" class="wo-detail-title">Field · Farm</div>
            <div id="detailSub" class="wo-detail-sub">Topic</div>
          </div>
          <button type="button" id="detailCloseBtn" class="wo-detail-close" aria-label="Close">
            ×
          </button>
        </header>

        <div class="wo-detail-grid">
          <div id="detailChips"></div>
          <div>
            <div class="wo-detail-label">Created</div>
            <div id="detailCreated" style="font-size:0.82rem;"></div>
          </div>
          <div>
            <div class="wo-detail-label">Status</div>
            <div id="detailStatusChip" class="wo-detail-chip">pending</div>
          </div>
        </div>

        <section class="wo-detail-section">
          <h3>Original request</h3>
          <div id="detailNotesOriginal" class="wo-detail-notes">
            No original description was provided.
          </div>
        </section>

        <section class="wo-detail-section">
          <h3>Who’s doing the work?</h3>
          <div class="wo-detail-row" style="margin-bottom:6px;">
            <label class="wo-detail-label" for="detailWhoType">Work done by</label>
            <select id="detailWhoType" class="wo-detail-select">
              <option value="employee">Employees</option>
              <option value="subcontractor">Sub-contractor</option>
            </select>
          </div>
          <div class="wo-detail-row">
            <label class="wo-detail-label" for="detailWhoNames">Who is working on it?</label>
            <input id="detailWhoNames" class="wo-detail-input"
              placeholder="Names / crew (we’ll hook this to employees & subs list later)" />
          </div>
        </section>

        <section class="wo-detail-section">
          <h3>Work performed / completion notes</h3>
          <textarea id="detailNotesCompletion" class="wo-detail-textarea"
            placeholder="Add notes about what was done, parts used, follow-up needed, etc."></textarea>
        </section>

        <footer class="wo-detail-footer">
          <button type="button" id="detailCancelBtn" class="btn-outline">Close</button>
          <button type="button" id="detailSaveBtn" class="btn-primary">Save updates</button>
        </footer>
      </div>
    </div>

  </fv-shell>
</body>
</html>
