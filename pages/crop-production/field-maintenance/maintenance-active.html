<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FarmVista • Active Field Maintenance Work Orders</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#3B7E46" />

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest" />
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png" />
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png" />
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css" />
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css" />

  <style>
    :root{
      --card-max: 1200px;
      --page-bottom-gap: 96px;
      --accent: #2F6C3C;
      --combo-gap:4px;
      --combo-radius:12px;
      --combo-btn-radius:10px;
      --combo-shadow:0 12px 26px rgba(0,0,0,.18);
      --combo-item-pad:8px 10px;
      --combo-max-h:50vh;
    }

    [hidden]{ display:none !important; }

    html{-webkit-text-size-adjust:100%}
    body{ background: var(--app-bg, var(--surface)); overflow-x:hidden; }

    .wrap{
      max-width: var(--card-max);
      margin: 0 auto;
      padding: clamp(14px,3vw,22px);
      padding-bottom: calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + var(--page-bottom-gap)) !important;
      box-sizing:border-box;
      display:grid;
      gap:16px;
    }

    .hero{
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));
      overflow:hidden;
    }
    .hero-head{
      display:grid;
      grid-template-columns:36px 1fr;
      gap:12px;
      align-items:center;
      padding:14px 16px;
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);
      border-bottom:1px solid var(--border);
    }
    .hero-head .icon{
      width:24px;
      height:24px;
      color:var(--accent);
      display:grid;
      place-items:center;
    }
    .hero-head h1{
      margin:0;
      font-size:clamp(20px,3.2vw,26px);
      line-height:1.2;
    }
    .muted{ color:var(--muted,#67706B); }

    .body{
      padding:16px;
      display:grid;
      gap:14px;
    }

    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:flex-end;
      justify-content:space-between;
    }
    .toolbar-left{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .toolbar-right{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:flex-end;
      font-size:0.9rem;
      opacity:0.8;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:120px;
      padding:10px 14px;
      border-radius:12px;
      border:1px solid var(--border);
      font-weight:800;
      text-decoration:none;
      cursor:pointer;
      user-select:none;
      color:var(--text) !important;
      background:var(--card-surface,var(--surface));
      font-size:0.9rem;
      gap:6px;
    }
    .btn-quiet{
      min-width:auto;
      padding-inline:10px;
    }
    .btn-small{
      min-width:auto;
      padding:5px 10px;
      font-size:0.78rem;
      font-weight:600;
      border-radius:999px;
    }
    .btn-outline {
      border-radius:999px;
      border:1px solid var(--border-strong, var(--border));
      background:var(--surface);
      padding:6px 12px;
      font-size:0.85rem;
      cursor:pointer;
    }
    .btn-primary {
      border-radius:999px;
      border:1px solid transparent;
      background:var(--green, #3B7E46);
      color:#fff;
      padding:6px 14px;
      font-size:0.85rem;
      font-weight:600;
      cursor:pointer;
    }
    .btn-outline:hover{ background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%); }
    .btn-primary:hover{ filter:brightness(1.05); }

    /* Work-order cards */

    .wo-list {
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:8px;
    }

    .wo-empty {
      padding:14px 16px;
      border-radius:12px;
      border:1px dashed var(--border);
      background:var(--card-surface, var(--surface));
      font-size:0.95rem;
      opacity:0.9;
    }

    .wo-card {
      border-radius:14px;
      border:1px solid var(--card-border, var(--border));
      background:var(--card-surface, var(--surface));
      box-shadow:var(--shadow-soft, var(--shadow));
      padding:12px 14px 10px;
      display:flex;
      flex-direction:column;
      gap:6px;
      transition:transform .06s, box-shadow .12s, border-color .12s, background .12s;
      cursor:pointer;
    }
    .wo-card:active {
      transform:scale(.995);
      box-shadow:var(--shadow);
    }

    .wo-row-top {
      display:flex;
      align-items:flex-start;
      gap:10px;
    }

    .wo-main {
      flex:1 1 auto;
      min-width:0;
    }

    .wo-title {
      font-weight:700;
      font-size:0.98rem;
      line-height:1.3;
    }

    .wo-sub {
      font-size:0.86rem;
      opacity:0.9;
      margin-top:2px;
    }

    .wo-meta {
      display:flex;
      flex-wrap:wrap;
      gap:6px 10px;
      margin-top:4px;
      font-size:0.8rem;
      opacity:0.85;
    }

    .wo-meta span {
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 7px;
      border-radius:999px;
      background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
    }

    .wo-meta-label {
      font-weight:600;
    }

    .wo-status-wrap {
      flex:0 0 auto;
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:4px;
      padding-left:4px;
      min-width:150px;
    }

    .wo-status-label {
      font-size:0.78rem;
      text-transform:uppercase;
      letter-spacing:0.06em;
      opacity:0.75;
    }

    .wo-status-select {
      width:100%;
      max-width:170px;
      font:inherit;
      font-size:0.9rem;
      border-radius:999px;
      border:1px solid var(--border);
      padding:5px 10px;
      background:var(--card-surface, var(--surface));
      color:var(--text);
      outline:none;
      cursor:pointer;
    }

    .wo-bottom-row {
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      font-size:0.78rem;
      opacity:0.8;
      margin-top:4px;
      flex-wrap:wrap;
    }

    .wo-status-chip {
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 8px;
      border-radius:999px;
      font-size:0.78rem;
      text-transform:uppercase;
      letter-spacing:0.06em;
      background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
    }

    /* Detail overlay */

    .wo-detail-overlay {
      position:fixed;
      inset:0;
      padding:16px;
      box-sizing:border-box;
      background:rgba(0,0,0,0.55);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:9999;
    }

    .wo-detail-panel {
      width:min(700px, 100% - 24px);
      max-height:90vh;
      border-radius:18px;
      background:var(--surface-raised, var(--card-surface, var(--surface)));
      box-shadow:0 18px 45px rgba(0,0,0,0.38);
      padding:14px 16px 10px;
      display:flex;
      flex-direction:column;
      gap:10px;
      box-sizing:border-box;
    }

    .wo-detail-header {
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      border-bottom:1px solid var(--border-soft, var(--border));
      padding-bottom:6px;
    }

    .wo-detail-title {
      font-weight:700;
      font-size:1rem;
      line-height:1.3;
    }

    .wo-detail-sub {
      font-size:0.86rem;
      opacity:0.9;
      margin-top:2px;
    }

    .wo-detail-close {
      border:none;
      background:transparent;
      font-size:1.3rem;
      line-height:1;
      cursor:pointer;
      padding:4px;
      border-radius:999px;
    }
    .wo-detail-close:hover{
      background:color-mix(in srgb, var(--surface) 60%, var(--border) 40%);
    }

    .wo-detail-content{
      flex:1 1 auto;
      overflow-y:auto;
      overflow-x:hidden;
      margin-top:4px;
      padding-right:2px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .wo-detail-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));
      gap:8px;
      font-size:0.82rem;
    }

    .wo-detail-chip {
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:3px 8px;
      border-radius:999px;
      background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
      font-size:0.78rem;
    }

    .wo-detail-label {
      font-weight:600;
      font-size:0.78rem;
      opacity:0.9;
    }

    .wo-detail-summary{
      padding-bottom:8px;
      border-bottom:1px solid var(--border-soft,var(--border));
    }

    .wo-detail-bullets{
      list-style:disc;
      padding-left:18px;
      margin:6px 0 0;
      font-size:0.8rem;
      color:var(--muted,#67706B);
    }
    .wo-detail-bullets li+li{
      margin-top:2px;
    }

    .summary-link{
      border:none;
      background:none;
      padding:0;
      margin:0;
      font:inherit;
      color:inherit;
      text-decoration:underline;
      text-decoration-thickness:1px;
      text-underline-offset:2px;
      cursor:pointer;
    }

    .wo-detail-section {
      border-top:1px solid var(--border-soft, var(--border));
      padding-top:10px;
      margin-top:4px;
    }
    .wo-detail-section-inline{
      border-top:none;
      padding-top:8px;
      margin-top:8px;
    }

    .wo-detail-section h3 {
      font-size:0.88rem;
      margin:0 0 4px;
    }

    .wo-detail-notes {
      font-size:0.82rem;
      white-space:pre-wrap;
    }

    .wo-detail-divider{
      height:3px;
      margin:10px -4px 10px;
      border-radius:8px;
      background:linear-gradient(90deg,#3B7E46,#AFCF71);
    }

    .wo-detail-row {
      display:flex;
      flex-wrap:wrap;
      gap:8px 10px;
      align-items:center;
      font-size:0.82rem;
    }

    .wo-detail-select,
    .wo-detail-input {
      font:inherit;
      font-size:0.82rem;
      padding:5px 8px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--surface);
      color:var(--text);
      min-width:0;
      box-sizing:border-box;
    }

    .wo-detail-input {
      border-radius:10px;
      flex:1 1 120px;
    }

    .wo-detail-textarea {
      width:100%;
      min-height:80px;
      resize:vertical;
      font:inherit;
      font-size:0.82rem;
      padding:6px 8px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--surface);
      color:var(--text);
      box-sizing:border-box;
      white-space:pre-wrap;
      overflow-wrap:break-word;
      overflow-x:hidden;
    }

    .wo-detail-footer {
      display:flex;
      justify-content:flex-end;
      gap:8px;
      margin-top:6px;
      padding-top:6px;
      border-top:1px solid var(--border-soft,var(--border));
    }

    /* Completion card */

    .wo-detail-completion{
      margin-top:4px;
      padding:8px 10px 10px;
      border-radius:14px;
      background:color-mix(in srgb, var(--surface) 94%, #000 6%);
      border:1px solid var(--border-soft,var(--border));
    }

    .wo-detail-completion .wo-detail-section:first-of-type{
      border-top:none;
      padding-top:4px;
      margin-top:0;
    }

    .wo-detail-completion-title{
      font-size:0.9rem;
      font-weight:700;
      margin:0 0 4px;
    }

    .wo-detail-helper{
      font-size:0.76rem;
      opacity:0.8;
      margin-top:4px;
    }

    .wo-date-range-inline{
      flex:1 1 auto;
      gap:6px;
    }
    .wo-date-range-sep{
      font-size:0.8rem;
    }

    /* Mic button (copied style) */

    .wo-detail-notes-wrap{
      position:relative;
    }
    .wo-detail-textarea.fm-notes{
      padding-right:52px;
    }
    .mic-btn{
      position:absolute;
      right:10px;
      bottom:10px;
      width:36px;
      height:36px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--surface);
      display:grid;
      place-items:center;
      cursor:pointer;
    }
    .mic-btn[disabled]{ opacity:.6; cursor:not-allowed; }
    .mic-svg{ width:18px; height:18px; display:block; }
    .mic-active{
      background:#2F6C3C;
      color:#fff;
      border-color:#2F6C3C;
    }

    /* Photos */

    .wo-detail-photos{
      margin-top:8px;
    }
    .wo-detail-gallery{
      margin-top:6px;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .wo-detail-thumb{
      width:72px;
      height:72px;
      border-radius:10px;
      overflow:hidden;
      border:1px solid var(--border-soft,var(--border));
      background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
      flex:0 0 auto;
      padding:0;
    }
    .wo-detail-thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }

    /* Combo for Submitted by */

    .combo{
      position:relative;
      width:100%;
    }
    .combo-anchor{
      position:relative;
      display:inline-block;
      width:100%;
    }
    .buttonish{
      width:100%;
      font:inherit;
      font-size:0.82rem;
      color:var(--text);
      background:var(--card-surface,var(--surface));
      border:1px solid var(--border);
      border-radius:var(--combo-btn-radius);
      padding:8px 12px;
      padding-right:36px;
      outline:none;
      text-align:left;
      cursor:pointer;
      position:relative;
      box-sizing:border-box;
    }
    .buttonish.has-caret::after{
      content:"";
      position:absolute;
      right:12px;
      top:50%;
      width:0;
      height:0;
      border-left:5px solid transparent;
      border-right:5px solid transparent;
      border-top:6px solid var(--muted,#67706B);
      transform:translateY(-50%);
      pointer-events:none;
    }
    .combo-panel{
      position:absolute;
      left:0;
      right:0;
      top:calc(100% + var(--combo-gap));
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--combo-radius);
      box-shadow:var(--combo-shadow);
      padding:6px;
      display:none;
      z-index:9999;
    }
    .combo-panel.show{ display:block; }
    .combo-panel .list{
      max-height:var(--combo-max-h);
      overflow:auto;
    }
    .combo-item{
      padding:var(--combo-item-pad);
      display:flex;
      align-items:center;
      gap:8px;
      border-radius:8px;
      cursor:pointer;
    }
    .combo-item:hover{
      background:rgba(0,0,0,.04);
    }
    .combo-item input{
      width:14px;
      height:14px;
      border-radius:50%;
      cursor:pointer;
    }
    .combo-empty{
      padding:var(--combo-item-pad);
      font-size:0.82rem;
      color:var(--muted,#67706B);
    }

    /* Photo lightbox */

    .wo-photo-lightbox{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.8);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:10000;
    }
    .wo-photo-lightbox-inner{
      position:relative;
      max-width:90vw;
      max-height:90vh;
    }
    .wo-photo-lightbox-inner img{
      max-width:100%;
      max-height:100%;
      display:block;
      border-radius:12px;
      box-shadow:0 12px 32px rgba(0,0,0,0.6);
    }
    .wo-photo-lightbox-close{
      position:absolute;
      top:-12px;
      right:-12px;
      width:32px;
      height:32px;
      border-radius:999px;
      border:none;
      background:rgba(0,0,0,0.65);
      color:#fff;
      font-size:1.2rem;
      cursor:pointer;
    }

    /* Map lightbox */

    .wo-map-lightbox{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.8);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:10000;
    }
    .wo-map-lightbox-inner{
      position:relative;
      max-width:95vw;
      max-height:95vh;
      width:min(900px,95vw);
      height:min(600px,90vh);
    }
    .wo-map-lightbox-inner iframe{
      width:100%;
      height:100%;
      display:block;
      border-radius:12px;
      border:none;
      box-shadow:0 12px 32px rgba(0,0,0,0.6);
      background:#000;
    }
    .wo-map-lightbox-close{
      position:absolute;
      top:-12px;
      right:-12px;
      width:32px;
      height:32px;
      border-radius:999px;
      border:none;
      background:rgba(0,0,0,0.65);
      color:#fff;
      font-size:1.2rem;
      cursor:pointer;
    }

    /* Status choice modal */

    .wo-status-modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.6);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:10050;
    }
    .wo-status-modal-panel{
      width:min(420px, 90vw);
      border-radius:18px;
      background:var(--surface-raised,var(--card-surface,var(--surface)));
      box-shadow:0 16px 40px rgba(0,0,0,0.4);
      padding:16px 18px 14px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .wo-status-modal-header h2{
      font-size:1rem;
      margin:0 0 4px;
    }
    .wo-status-options{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin:6px 0 8px;
    }
    .wo-status-option{
      display:flex;
      align-items:flex-start;
      gap:8px;
      font-size:0.88rem;
      padding:6px 8px;
      border-radius:10px;
      border:1px solid var(--border-soft,var(--border));
    }
    .wo-status-option input{
      margin-top:3px;
    }
    .wo-status-modal-footer{
      display:flex;
      justify-content:flex-end;
      gap:8px;
      margin-top:6px;
    }

    @media (max-width:600px){
      .wo-detail-overlay{
        padding:0;
        align-items:flex-end;
      }
      .wo-detail-panel {
        border-radius:18px 18px 0 0;
        max-height:92vh;
        margin:0;
        width:100%;
      }
    }
  </style>

  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true;
        document.head.appendChild(s);
      }
    })();
  </script>

  <script type="module">
    import {
      ready,
      getFirestore,
      collection, query, where, getDocs,
      updateDoc, doc, serverTimestamp
    } from '/Farm-vista/js/firebase-init.js';

    import { NAV_MENU } from '/Farm-vista/js/menu.js';

    const CONFIG = {
      COLLECTION_PATH: 'fieldMaintenance',
      STATUS_FIELD:    'status',
      STATUS_PENDING:  'pending',
      STATUS_INPROG:   'in progress',
      STATUS_DONE:     'completed'
    };

    const $ = (sel, root=document) => root.querySelector(sel);

    const STATE = {
      db: null,
      items: [],
      currentItem: null,
      currentPhotos: [],
      currentLocationUrl: '',
      employees: [],
      selectedEmployeeIds: new Set(),
      currentUserName: '',
      currentUserEmail: ''
    };

    /* ------------ helpers ------------ */

    function getTime(ts){
      if(!ts) return 0;
      try{
        if(ts.toMillis) return ts.toMillis();
        if(ts.toDate)   return ts.toDate().getTime();
        if(ts instanceof Date) return ts.getTime();
        return new Date(ts).getTime() || 0;
      }catch{
        return 0;
      }
    }

    function formatDurationLabel(startDate, endDate, isCompleted){
      if(!startDate || !endDate) return '';
      const diffMs = endDate.getTime() - startDate.getTime();
      if(diffMs <= 0) return '';

      const diffDays = diffMs / (1000 * 60 * 60 * 24);
      let days = Math.round(diffDays);
      if(days < 1) days = 1;

      const label = days === 1 ? '1 Day' : `${days} Days`;
      return isCompleted ? `Completed ${label}` : `Open ${label}`;
    }

    function detectCurrentUser(){
      let name = '';
      let email = '';
      try{
        const w = window;
        if(w.FV_AUTH && w.FV_AUTH.user){
          name = w.FV_AUTH.user.displayName || '';
          email = w.FV_AUTH.user.email || '';
        }else if(w.FV_CONTEXT && w.FV_CONTEXT.user){
          name = w.FV_CONTEXT.user.name || '';
          email = w.FV_CONTEXT.user.email || '';
        }
      }catch{/* ignore */}

      STATE.currentUserName = name || '';
      STATE.currentUserEmail = email || '';
    }

    /* ------------ photo lightbox ------------ */

    function openPhotoLightbox(url){
      const lb = $('#photoLightbox');
      const img = $('#photoLightboxImg');
      if(!lb || !img) return;
      img.src = url;
      lb.hidden = false;
    }

    function closePhotoLightbox(){
      const lb = $('#photoLightbox');
      const img = $('#photoLightboxImg');
      if(!lb || !img) return;
      img.src = '';
      lb.hidden = true;
    }

    /* ------------ map lightbox ------------ */

    function openMapLightbox(url){
      const lb = $('#mapLightbox');
      const frame = $('#mapLightboxFrame');
      if(!lb || !frame || !url) return;
      frame.src = url;
      lb.hidden = false;
    }

    function closeMapLightbox(){
      const lb = $('#mapLightbox');
      const frame = $('#mapLightboxFrame');
      if(!lb || !frame) return;
      frame.src = '';
      lb.hidden = true;
    }

    /* ------------ employees dropdown ------------ */

    function updateSubmittedByUI(){
      const btn = $('#detailSubmittedByBtn');
      const listEl = $('#detailSubmittedByList');
      if(!btn || !listEl) return;

      // Build list
      listEl.innerHTML = '';
      if(!STATE.employees.length){
        listEl.innerHTML = `<div class="combo-empty">No employees found.</div>`;
      }else{
        for(const emp of STATE.employees){
          const li = document.createElement('div');
          li.className = 'combo-item';
          li.dataset.id = emp.id;

          const input = document.createElement('input');
          input.type = 'checkbox';
          input.checked = STATE.selectedEmployeeIds.has(emp.id);

          const span = document.createElement('span');
          span.textContent = emp.fullName;

          li.appendChild(input);
          li.appendChild(span);

          li.addEventListener('click', (ev)=>{
            ev.stopPropagation();
            const checked = !STATE.selectedEmployeeIds.has(emp.id);
            if(checked){
              STATE.selectedEmployeeIds.add(emp.id);
            }else{
              STATE.selectedEmployeeIds.delete(emp.id);
            }
            updateSubmittedByUI();
          });

          listEl.appendChild(li);
        }
      }

      // Button label
      const selected = STATE.employees.filter(e => STATE.selectedEmployeeIds.has(e.id));
      if(selected.length){
        btn.textContent = selected.map(e => e.fullName).join(', ');
      }else{
        btn.textContent = 'Names (comma-separated; defaults to logged-in user)';
      }
    }

    async function loadEmployees(){
      try{
        const qRef = query(
          collection(STATE.db, 'employees'),
          where('active', '==', true)
        );
        const snap = await getDocs(qRef);
        STATE.employees = snap.docs.map(d => {
          const data = d.data() || {};
          return {
            id: d.id,
            fullName: data.fullName || data.firstName || d.id,
            email: data.email || d.id
          };
        }).sort((a,b)=>a.fullName.localeCompare(b.fullName));

        // Default selection to logged-in user if found
        STATE.selectedEmployeeIds.clear();
        if(STATE.currentUserEmail){
          const match = STATE.employees.find(e => e.email === STATE.currentUserEmail);
          if(match) STATE.selectedEmployeeIds.add(match.id);
        }

        updateSubmittedByUI();
      }catch(err){
        console.error('Error loading employees:', err);
      }
    }

    function selectedEmployeeNames(){
      const names = [];
      for(const emp of STATE.employees){
        if(STATE.selectedEmployeeIds.has(emp.id)){
          names.push(emp.fullName);
        }
      }
      return names;
    }

    /* ------------ summary bullets ------------ */

    function updateSummaryBullets(){
      const item = STATE.currentItem;
      const bulletsEl = $('#detailBullets');
      if(!item || !bulletsEl) return;

      const data = item.data;
      const statusRaw = (data[CONFIG.STATUS_FIELD] || '').toString() || CONFIG.STATUS_PENDING;
      let statusLabel = statusRaw;
      if(statusRaw === CONFIG.STATUS_PENDING) statusLabel = 'Pending';
      if(statusRaw === CONFIG.STATUS_INPROG)  statusLabel = 'In progress';
      if(statusRaw === CONFIG.STATUS_DONE)    statusLabel = 'Completed';

      const hasLocation = !!(
        data.fieldId ||
        data.fieldUid ||
        data.locationUrl ||
        data.mapUrl ||
        data.mapLink ||
        data.boundaryUrl
      );

      const hasPhotos = STATE.currentPhotos && STATE.currentPhotos.length > 0;

      bulletsEl.innerHTML = '';

      const liStatus = document.createElement('li');
      liStatus.textContent = `Status: ${statusLabel}`;
      bulletsEl.appendChild(liStatus);

      const liLoc = document.createElement('li');
      if(hasLocation && STATE.currentLocationUrl){
        liLoc.innerHTML = `<button type="button" class="summary-link js-location-link">Location mapped</button>`;
      }else{
        liLoc.textContent = 'No location mapped';
      }
      bulletsEl.appendChild(liLoc);

      const liPhotos = document.createElement('li');
      if(hasPhotos){
        const count = STATE.currentPhotos.length;
        liPhotos.innerHTML =
          `<button type="button" class="summary-link js-photos-link">${count} photo${count===1?'':'s'} attached</button>`;
      }else{
        liPhotos.textContent = 'No photos attached';
      }
      bulletsEl.appendChild(liPhotos);
    }

    function renderPhotoGallery(){
      const gallery = $('#detailPhotoGallery');
      const hint = $('#detailPhotoHint');
      if(!gallery) return;

      gallery.innerHTML = '';
      const urls = STATE.currentPhotos || [];

      if(!urls.length){
        if(hint){
          hint.textContent = 'Attach photos of what needs to be done or what was completed.';
        }
        return;
      }

      if(hint){
        hint.textContent = 'Tap a photo to view it larger.';
      }

      for(const url of urls){
        if(!url) continue;
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'wo-detail-thumb';

        const img = document.createElement('img');
        img.src = url;
        img.alt = 'Work order photo';
        img.loading = 'lazy';

        btn.addEventListener('click', () => openPhotoLightbox(url));

        btn.appendChild(img);
        gallery.appendChild(btn);
      }
    }

    /* ------------ open / close detail ------------ */

    function openDetail(item){
      STATE.currentItem = item;
      const data = item.data;

      const field = data.fieldName || data.field || 'Field not set';
      const farm  = data.farmName  || data.farm  || '';
      const topic = data.topicLabel || data.topic || data.category || data.title || 'Maintenance';
      const priority = data.priority ?? data.priorityLevel ?? null;
      const equip = data.equipmentName || data.equipment || '';
      const createdBy = (data.submittedBy && (data.submittedBy.name || data.submittedBy.email))
                        || data.createdByName || data.createdBy || '';
      const ts = data.createdAt || data.dateSubmitted || data.timestamp || null;
      const when = ts && ts.toDate ? ts.toDate() : (ts ? new Date(ts) : null);
      const status = (data[CONFIG.STATUS_FIELD] || '').toString() || CONFIG.STATUS_PENDING;

      const originalNotes = data.details || data.description || data.notes || '';

      const completedAtRaw = data.completedAt || data.completedOn || null;
      const completedDate = completedAtRaw && completedAtRaw.toDate ? completedAtRaw.toDate() :
                            (completedAtRaw ? new Date(completedAtRaw) : null);

      STATE.currentLocationUrl =
        data.locationUrl || data.mapUrl || data.mapLink || data.boundaryUrl || '';

      const overlay = $('#woDetailOverlay');
      const titleEl = $('#detailTitle');
      const subEl   = $('#detailSub');
      const chipsEl = $('#detailChips');
      const createdEl = $('#detailCreated');
      const durationEl = $('#detailDuration');
      const origNotesEl = $('#detailNotesOriginal');
      const completedRow = $('#detailCompletedRow');
      const completedOnEl = $('#detailCompletedOn');

      const workDateInp = $('#detailWorkDate');
      const workStartInp = $('#detailWorkRangeStart');
      const workEndInp = $('#detailWorkRangeEnd');
      const compNotesEl = $('#detailNotesCompletion');

      if(titleEl){
        titleEl.textContent = farm ? `${field} · ${farm}` : field;
      }
      if(subEl){
        subEl.textContent = topic;
      }

      if(chipsEl){
        chipsEl.innerHTML = '';
        if(priority !== null){
          const span = document.createElement('span');
          span.className = 'wo-detail-chip';
          span.innerHTML = `<span class="wo-detail-label">Priority</span> ${priority}`;
          chipsEl.appendChild(span);
        }
        if(equip){
          const span = document.createElement('span');
          span.className = 'wo-detail-chip';
          span.innerHTML = `<span class="wo-detail-label">Equip</span> ${equip}`;
          chipsEl.appendChild(span);
        }
        if(createdBy){
          const span = document.createElement('span');
          span.className = 'wo-detail-chip';
          span.innerHTML = `<span class="wo-detail-label">By</span> ${createdBy}`;
          chipsEl.appendChild(span);
        }
      }

      if(createdEl){
        createdEl.textContent = when
          ? `${when.toLocaleDateString()} ${when.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`
          : '';
      }

      if(durationEl){
        const isCompleted = status === CONFIG.STATUS_DONE;
        const end = isCompleted && completedDate ? completedDate : (when ? new Date() : null);
        durationEl.textContent = (when && end)
          ? formatDurationLabel(when, end, isCompleted)
          : '';
      }

      // Completed on row: only show once job is completed
      if(completedRow){
        if(completedDate){
          completedRow.hidden = false;
          if(completedOnEl){
            completedOnEl.textContent =
              `${completedDate.toLocaleDateString()} ${completedDate.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;
          }
        }else{
          completedRow.hidden = true;
        }
      }

      if(origNotesEl){
        origNotesEl.textContent = originalNotes || 'No original description was provided.';
      }

      // Work dates
      function isoFrom(any){
        if(!any) return '';
        if(any.toDate){
          return any.toDate().toISOString().slice(0,10);
        }
        if(typeof any === 'string' && any.length>=10) return any.slice(0,10);
        try{
          const d = new Date(any);
          if(!isNaN(d.getTime())) return d.toISOString().slice(0,10);
        }catch{}
        return '';
      }

      if(workDateInp){
        let val = isoFrom(data.completionWorkDate);
        if(!val){
          const today = new Date();
          val = today.toISOString().slice(0,10);
        }
        workDateInp.value = val;
      }
      if(workStartInp){
        workStartInp.value = isoFrom(data.completionWorkStart);
      }
      if(workEndInp){
        workEndInp.value = isoFrom(data.completionWorkEnd);
      }

      if(compNotesEl){
        compNotesEl.value = data.completionNotes || '';
      }

      // Submitted by -> multi select from employees
      STATE.selectedEmployeeIds.clear();
      let selectedNames = [];

      if(Array.isArray(data.completionSubmittedBy)){
        selectedNames = data.completionSubmittedBy;
      }else if(typeof data.completionSubmittedBy === 'string' && data.completionSubmittedBy.trim()){
        selectedNames = data.completionSubmittedBy.split(',').map(t=>t.trim()).filter(Boolean);
      }else if(data.assignedWorkersNote){
        selectedNames = data.assignedWorkersNote.split(',').map(t=>t.trim()).filter(Boolean);
      }else if(STATE.currentUserName){
        selectedNames = [STATE.currentUserName];
      }

      for(const name of selectedNames){
        const emp = STATE.employees.find(e => e.fullName === name);
        if(emp) STATE.selectedEmployeeIds.add(emp.id);
      }
      // If still none selected, default logged-in user by email
      if(!STATE.selectedEmployeeIds.size && STATE.currentUserEmail){
        const match = STATE.employees.find(e => e.email === STATE.currentUserEmail);
        if(match) STATE.selectedEmployeeIds.add(match.id);
      }
      updateSubmittedByUI();

      // Photos
      const existingPhotos =
        data.photos ||
        data.photoUrls ||
        data.attachments ||
        [];
      STATE.currentPhotos = Array.isArray(existingPhotos) ? [...existingPhotos] : [];

      updateSummaryBullets();
      renderPhotoGallery();

      if(overlay){
        overlay.hidden = false;
        document.body.style.overflow = 'hidden';
      }
    }

    function closeDetail(){
      const overlay = $('#woDetailOverlay');
      if(overlay){
        overlay.hidden = true;
      }
      document.body.style.overflow = '';
      STATE.currentItem = null;
      STATE.currentPhotos = [];
      STATE.currentLocationUrl = '';
    }

    /* ------------ photo upload ------------ */

    let storageApi = null;
    async function getStorageApi(){
      if(storageApi) return storageApi;
      try{
        const mod = await import('/Farm-vista/js/firebase-init.js');
        const { getStorage, ref, uploadBytes, getDownloadURL } = mod;
        if(getStorage && ref && uploadBytes && getDownloadURL){
          storageApi = { getStorage, ref, uploadBytes, getDownloadURL };
          return storageApi;
        }
      }catch(err){
        console.error('Storage API not available:', err);
      }
      return null;
    }

    async function handlePhotoFiles(ev){
      const input = ev.target;
      const files = Array.from(input.files || []);
      input.value = '';

      if(!files.length || !STATE.currentItem) return;

      const api = await getStorageApi();
      if(!api){
        alert('Photo upload is not configured yet. Ask Dane to enable Firebase Storage helpers.');
        return;
      }
      const { getStorage, ref, uploadBytes, getDownloadURL } = api;

      const hint = $('#detailPhotoHint');
      if(hint){
        hint.textContent = 'Uploading photos...';
      }

      const storage = getStorage();
      const urls = STATE.currentPhotos || [];

      for(const file of files){
        try{
          const safeName = (file.name || 'photo').replace(/[^\w.-]+/g,'_');
          const path = `${CONFIG.COLLECTION_PATH}/${STATE.currentItem.id}/${Date.now()}-${safeName}`;
          const storageRef = ref(storage, path);
          await uploadBytes(storageRef, file);
          const url = await getDownloadURL(storageRef);
          urls.push(url);
        }catch(err){
          console.error('Photo upload failed:', err);
        }
      }

      STATE.currentPhotos = urls;
      renderPhotoGallery();
      updateSummaryBullets();
    }

    /* ------------ save logic ------------ */

    async function applyDetailSave(newStatus){
      const item = STATE.currentItem;
      if(!item || !STATE.db) return;

      const compNotesEl = $('#detailNotesCompletion');
      const workDateInp = $('#detailWorkDate');
      const workStartInp = $('#detailWorkRangeStart');
      const workEndInp = $('#detailWorkRangeEnd');

      const updates = {
        updatedAt: serverTimestamp(),
        [CONFIG.STATUS_FIELD]: newStatus
      };

      if(compNotesEl){
        updates.completionNotes = compNotesEl.value.trim();
      }

      const names = selectedEmployeeNames();
      if(names.length){
        updates.completionSubmittedBy = names;
      }

      function toDateVal(inp){
        if(!inp || !inp.value) return null;
        const d = new Date(inp.value + 'T12:00:00');
        return isNaN(d.getTime()) ? null : d;
      }

      const workDateVal = toDateVal(workDateInp);
      if(workDateVal){
        updates.completionWorkDate = workDateVal;
      }

      const workStartVal = toDateVal(workStartInp);
      if(workStartVal){
        updates.completionWorkStart = workStartVal;
      }
      const workEndVal = toDateVal(workEndInp);
      if(workEndVal){
        updates.completionWorkEnd = workEndVal;
      }

      const currentStatus = item.data[CONFIG.STATUS_FIELD] || CONFIG.STATUS_PENDING;
      if(newStatus === CONFIG.STATUS_DONE && currentStatus !== CONFIG.STATUS_DONE){
        updates.completedAt = serverTimestamp();
      }

      if(STATE.currentPhotos && STATE.currentPhotos.length){
        updates.photos = STATE.currentPhotos;
        updates.photoUrls = STATE.currentPhotos;
      }

      try {
        await updateDoc(doc(STATE.db, CONFIG.COLLECTION_PATH, item.id), updates);
        Object.assign(item.data, updates);

        if(newStatus === CONFIG.STATUS_DONE){
          STATE.items = STATE.items.filter(x => x.id !== item.id);
          renderList();
        }else{
          renderList();
        }

        closeDetail();
      } catch(err){
        console.error('Failed to save detail updates:', err);
        alert('Could not save updates. Please try again.');
      }
    }

    function saveDetailUpdates(){
      const item = STATE.currentItem;
      const modal = $('#statusModal');
      const inProgRadio = $('#statusChoiceInProg');
      const doneRadio = $('#statusChoiceDone');

      if(!item){
        return;
      }
      if(!modal || !inProgRadio || !doneRadio){
        applyDetailSave(item.data[CONFIG.STATUS_FIELD] || CONFIG.STATUS_INPROG);
        return;
      }

      const currentStatus = item.data[CONFIG.STATUS_FIELD] || CONFIG.STATUS_PENDING;
      if(currentStatus === CONFIG.STATUS_DONE){
        doneRadio.checked = true;
        inProgRadio.checked = false;
      }else if(currentStatus === CONFIG.STATUS_INPROG){
        inProgRadio.checked = true;
        doneRadio.checked = false;
      }else{
        inProgRadio.checked = true;
        doneRadio.checked = false;
      }

      modal.hidden = false;
    }

    /* ------------ list rendering ------------ */

    function renderList(){
      const listEl  = $('.wo-list');
      const emptyEl = $('.wo-empty');
      listEl.innerHTML = '';

      if(!STATE.items.length){
        if(emptyEl) emptyEl.style.display = 'block';
        const countEl = $('#woCount');
        if(countEl) countEl.textContent = '0 active work orders';
        return;
      }
      if(emptyEl) emptyEl.style.display = 'none';

      for(const item of STATE.items){
        const data = item.data;
        const id   = item.id;

        const field = data.fieldName || data.field || 'Field not set';
        const farm  = data.farmName  || data.farm  || '';
        const topic = data.topicLabel || data.topic || data.category || data.title || 'Maintenance';
        const priority = data.priority ?? data.priorityLevel ?? null;
        const equip = data.equipmentName || data.equipment || '';
        const createdBy = (data.submittedBy && (data.submittedBy.name || data.submittedBy.email))
                          || data.createdByName || data.createdBy || '';
        const ts = data.createdAt || data.dateSubmitted || data.timestamp || null;
        const when = ts && ts.toDate ? ts.toDate() : (ts ? new Date(ts) : null);
        const status = (data[CONFIG.STATUS_FIELD] || '').toString();

        const card = document.createElement('article');
        card.className = 'wo-card';
        card.dataset.id = id;

        card.innerHTML = `
          <div class="wo-row-top">
            <div class="wo-main">
              <div class="wo-title">
                ${field ? `<span>${field}</span>` : 'Maintenance Work Order'}
                ${farm ? ` · <span>${farm}</span>` : ''}
              </div>
              <div class="wo-sub">
                ${topic}
              </div>
              <div class="wo-meta">
                ${priority !== null ? `
                  <span><span class="wo-meta-label">Priority</span> ${priority}</span>
                ` : ''}
                ${equip ? `
                  <span><span class="wo-meta-label">Equip</span> ${equip}</span>
                ` : ''}
                ${createdBy ? `
                  <span><span class="wo-meta-label">By</span> ${createdBy}</span>
                ` : ''}
              </div>
            </div>

            <div class="wo-status-wrap">
              <div class="wo-status-label">Status</div>
              <select class="wo-status-select">
                <option value="${CONFIG.STATUS_PENDING}">Pending</option>
                <option value="${CONFIG.STATUS_INPROG}">In Progress</option>
                <option value="${CONFIG.STATUS_DONE}">Completed</option>
              </select>
            </div>
          </div>

          <div class="wo-bottom-row">
            <div>
              ${when ? `Created ${when.toLocaleDateString()} ${when.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}` : ''}
            </div>
            <div class="wo-status-chip">${status || 'unknown'}</div>
          </div>
        `;

        const select = card.querySelector('.wo-status-select');
        const chip   = card.querySelector('.wo-status-chip');

        if(status === CONFIG.STATUS_INPROG){
          select.value = CONFIG.STATUS_INPROG;
        }else if(status === CONFIG.STATUS_DONE){
          select.value = CONFIG.STATUS_DONE;
        }else{
          select.value = CONFIG.STATUS_PENDING;
        }

        const originalStatus = status || CONFIG.STATUS_PENDING;

        select.addEventListener('change', async (ev) => {
          const newStatus = ev.target.value;

          const updates = {
            [CONFIG.STATUS_FIELD]: newStatus,
            updatedAt: serverTimestamp()
          };

          if(newStatus === CONFIG.STATUS_DONE && originalStatus !== CONFIG.STATUS_DONE){
            updates.completedAt = serverTimestamp();
          }

          try{
            await updateDoc(doc(STATE.db, CONFIG.COLLECTION_PATH, id), updates);

            if(newStatus === CONFIG.STATUS_DONE){
              STATE.items = STATE.items.filter(x => x.id !== id);
              renderList();
            }else{
              item.data[CONFIG.STATUS_FIELD] = newStatus;
              Object.assign(item.data, updates);
              if(chip) chip.textContent = newStatus;
            }
          }catch(err){
            console.error('Failed to update status:', err);
            alert('Could not update work order status. Please try again.');
            ev.target.value = originalStatus || CONFIG.STATUS_PENDING;
          }
        });

        card.addEventListener('click', (ev) => {
          if(ev.target.closest('.wo-status-select')) return;
          openDetail(item);
        });

        listEl.appendChild(card);
      }

      const countEl = $('#woCount');
      if(countEl){
        countEl.textContent = `${STATE.items.length} active work order${STATE.items.length === 1 ? '' : 's'}`;
      }
    }

    async function loadActiveWorkOrders(){
      const db  = STATE.db;
      const ref = collection(db, CONFIG.COLLECTION_PATH);

      try{
        const qRef = query(
          ref,
          where(CONFIG.STATUS_FIELD, 'in', [CONFIG.STATUS_PENDING, CONFIG.STATUS_INPROG])
        );
        const snap = await getDocs(qRef);

        const items = snap.docs.map(d => ({
          id: d.id,
          data: d.data()
        }));

        items.sort((a,b) => {
          const ta = getTime(a.data.createdAt || a.data.dateSubmitted || a.data.timestamp);
          const tb = getTime(b.data.createdAt || b.data.dateSubmitted || b.data.timestamp);
          return tb - ta;
        });

        STATE.items = items;
        renderList();
      }catch(err){
        console.error('Error loading active work orders:', err);
        const emptyEl = $('.wo-empty');
        if(emptyEl){
          emptyEl.textContent = 'Error loading work orders. Check console or Firestore indexes.';
          emptyEl.style.display = 'block';
        }
        const countEl = $('#woCount');
        if(countEl) countEl.textContent = 'Error loading work orders';
      }
    }

    /* ------------ mic wiring (from add page) ------------ */

    function wireMic(buttonId, textareaId){
      const btn = document.getElementById(buttonId);
      const ta  = document.getElementById(textareaId);
      if(!btn || !ta) return;

      const ok = ('webkitSpeechRecognition' in window) || ('SpeechRecognition' in window);
      if(!ok){
        btn.style.display = "none";
        return;
      }
      const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
      const rec = new Rec();
      rec.lang = "en-US";
      rec.interimResults = true;
      rec.continuous = false;

      let active = false;
      let baseText = "";

      const setMic = on=>{
        btn.classList.toggle("mic-active", on);
        btn.setAttribute("aria-label", on ? "Stop dictation" : "Start dictation");
      };

      btn.addEventListener("click", ()=>{
        if(!active){
          baseText = ta.value ? (ta.value + " ") : "";
          try{ rec.start(); active=true; setMic(true); }catch{}
        }else{
          try{ rec.stop(); rec.abort(); }catch{}
          active=false; setMic(false);
        }
      });

      rec.onresult = ev=>{
        let txt = "";
        for(let i=ev.resultIndex;i<ev.results.length;i++){
          txt += ev.results[i][0].transcript;
        }
        ta.value = baseText + txt;
      };
      rec.onend = ()=>{ active=false; setMic(false); };
      rec.onerror = ()=>{ active=false; setMic(false); };
    }

    /* ------------ boot ------------ */

    (async function boot(){
      await ready;
      STATE.db = getFirestore();
      detectCurrentUser();

      const shell = document.querySelector('fv-shell');
      if (shell) shell.nav = NAV_MENU;

      const backBtn = document.getElementById('btnBack');
      if(backBtn){
        backBtn.addEventListener('click', () => {
          location.href = '/Farm-vista/pages/crop-production/maintenance.html';
        });
      }

      const overlay = $('#woDetailOverlay');
      if(overlay){
        overlay.addEventListener('click', (ev)=>{
          if(ev.target === overlay){
            closeDetail();
          }
        });
      }

      const closeBtn = $('#detailCloseBtn');
      if(closeBtn){
        closeBtn.addEventListener('click', closeDetail);
      }

      const cancelBtn = $('#detailCancelBtn');
      if(cancelBtn){
        cancelBtn.addEventListener('click', closeDetail);
      }

      const saveBtn = $('#detailSaveBtn');
      if(saveBtn){
        saveBtn.addEventListener('click', (ev)=>{
          ev.preventDefault();
          saveDetailUpdates();
        });
      }

      const addPhotosBtn = $('#detailAddPhotosBtn');
      const photoInput   = $('#detailPhotoInput');
      if(addPhotosBtn && photoInput){
        addPhotosBtn.addEventListener('click', () => photoInput.click());
        photoInput.addEventListener('change', handlePhotoFiles);
      }

      // bullets (location / photos)
      const bulletsEl = $('#detailBullets');
      if(bulletsEl){
        bulletsEl.addEventListener('click', (ev)=>{
          const locBtn = ev.target.closest('.js-location-link');
          const photosBtn = ev.target.closest('.js-photos-link');
          if(locBtn){
            if(STATE.currentLocationUrl){
              openMapLightbox(STATE.currentLocationUrl);
            }
            return;
          }
          if(photosBtn){
            const urls = STATE.currentPhotos || [];
            if(urls.length){
              openPhotoLightbox(urls[0]);
            }else{
              const addBtn = $('#detailAddPhotosBtn');
              if(addBtn) addBtn.focus();
            }
          }
        });
      }

      // photo lightbox
      const lb = $('#photoLightbox');
      if(lb){
        lb.addEventListener('click', (ev)=>{
          if(ev.target === lb){
            closePhotoLightbox();
          }
        });
      }
      const lbClose = $('#photoLightboxClose');
      if(lbClose){
        lbClose.addEventListener('click', closePhotoLightbox);
      }

      // map lightbox
      const mapLb = $('#mapLightbox');
      if(mapLb){
        mapLb.addEventListener('click', (ev)=>{
          if(ev.target === mapLb){
            closeMapLightbox();
          }
        });
      }
      const mapClose = $('#mapLightboxClose');
      if(mapClose){
        mapClose.addEventListener('click', closeMapLightbox);
      }

      // status modal
      const statusModal = $('#statusModal');
      const statusCancel = $('#statusModalCancel');
      const statusSave = $('#statusModalSave');
      if(statusModal){
        statusModal.addEventListener('click', (ev)=>{
          if(ev.target === statusModal){
            statusModal.hidden = true;
          }
        });
      }
      if(statusCancel && statusModal){
        statusCancel.addEventListener('click', ()=>{
          statusModal.hidden = true;
        });
      }
      if(statusSave && statusModal){
        statusSave.addEventListener('click', async ()=>{
          const doneRadio = $('#statusChoiceDone');
          const chosen =
            doneRadio && doneRadio.checked ? CONFIG.STATUS_DONE : CONFIG.STATUS_INPROG;
          statusModal.hidden = true;
          await applyDetailSave(chosen);
        });
      }

      // submitted-by combo open/close
      const empBtn = $('#detailSubmittedByBtn');
      const empPanel = $('#detailSubmittedByPanel');
      if(empBtn && empPanel){
        empBtn.addEventListener('click', (ev)=>{
          ev.stopPropagation();
          const show = !empPanel.classList.contains('show');
          document.querySelectorAll('.combo-panel.show').forEach(p=>{
            if(p!==empPanel) p.classList.remove('show');
          });
          if(show) empPanel.classList.add('show');
          else empPanel.classList.remove('show');
        });
        document.addEventListener('click', ()=>{
          empPanel.classList.remove('show');
        });
      }

      // ESC handling
      document.addEventListener('keydown', (ev)=>{
        if(ev.key === 'Escape'){
          const statusModalNow = $('#statusModal');
          if(statusModalNow && !statusModalNow.hidden){
            statusModalNow.hidden = true;
            return;
          }
          const mapLbNow = $('#mapLightbox');
          if(mapLbNow && !mapLbNow.hidden){
            closeMapLightbox();
            return;
          }
          const photoLbNow = $('#photoLightbox');
          if(photoLbNow && !photoLbNow.hidden){
            closePhotoLightbox();
            return;
          }
          closeDetail();
        }
      });

      // Mic on Notes
      wireMic('detailDictationBtn', 'detailNotesCompletion');

      // Load data
      await loadEmployees();
      await loadActiveWorkOrders();
    })();
  </script>
</head>

<body>
  <fv-shell>
    <div class="wrap">
      <section class="hero">
        <header class="hero-head">
          <div class="icon" aria-hidden="true">🛠️</div>
          <div>
            <h1>Active Field Maintenance Work Orders</h1>
            <p class="muted">
              Shows all work orders that have passed approval and are currently
              <strong>Pending</strong> or <strong>In Progress</strong>. Use the
              status dropdown on each card to move them to <strong>In Progress</strong> or
              straight to <strong>Completed</strong>.
            </p>
          </div>
        </header>

        <div class="body">
          <div class="toolbar">
            <div class="toolbar-left">
              <button id="btnBack" type="button" class="btn btn-quiet">
                ← Back to Work Orders
              </button>
            </div>
            <div class="toolbar-right">
              <span id="woCount">0 active work orders</span>
            </div>
          </div>

          <section aria-label="Pending and in-progress work orders">
            <div class="wo-empty">
              No work orders are currently pending or in progress.
              Once work orders are approved and ready to work, they will appear here.
            </div>
            <div class="wo-list"></div>
          </section>
        </div>
      </section>
    </div>

    <!-- Detail overlay -->
    <div id="woDetailOverlay" class="wo-detail-overlay" hidden>
      <div class="wo-detail-panel" role="dialog" aria-modal="true" aria-labelledby="detailTitle">
        <header class="wo-detail-header">
          <div>
            <div id="detailTitle" class="wo-detail-title">Field · Farm</div>
            <div id="detailSub" class="wo-detail-sub">Topic</div>
          </div>
          <button type="button" id="detailCloseBtn" class="wo-detail-close" aria-label="Close">
            ×
          </button>
        </header>

        <div class="wo-detail-content">
          <!-- SUMMARY -->
          <section class="wo-detail-summary">
            <div class="wo-detail-grid">
              <div id="detailChips"></div>
              <div>
                <div class="wo-detail-label">Created</div>
                <div id="detailCreated" style="font-size:0.82rem;"></div>
              </div>
              <div>
                <div class="wo-detail-label">Timing</div>
                <div id="detailDuration" style="font-size:0.82rem;"></div>
              </div>
            </div>
            <ul id="detailBullets" class="wo-detail-bullets"></ul>
            <div class="wo-detail-section wo-detail-section-inline">
              <h3>Original request</h3>
              <div id="detailNotesOriginal" class="wo-detail-notes">
                No original description was provided.
              </div>
            </div>
          </section>

          <div class="wo-detail-divider"></div>

          <!-- COMPLETION FORM -->
          <div class="wo-detail-completion">
            <h3 class="wo-detail-completion-title">Field Maintenance Work Order</h3>

            <div class="wo-detail-section">
              <div class="wo-detail-row">
                <label class="wo-detail-label" for="detailSubmittedByBtn">Submitted by</label>
                <div class="combo">
                  <div class="combo-anchor">
                    <button id="detailSubmittedByBtn" type="button" class="buttonish has-caret">
                      Names (comma-separated; defaults to logged-in user)
                    </button>
                    <div id="detailSubmittedByPanel" class="combo-panel">
                      <div id="detailSubmittedByList" class="list"></div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="wo-detail-row">
                <label class="wo-detail-label" for="detailWorkDate">Date</label>
                <input id="detailWorkDate" type="date" class="wo-detail-input" />
              </div>

              <div class="wo-detail-row">
                <label class="wo-detail-label">Time worked on job</label>
                <div class="wo-detail-row wo-date-range-inline">
                  <input id="detailWorkRangeStart" type="date" class="wo-detail-input" />
                  <span class="wo-date-range-sep">to</span>
                  <input id="detailWorkRangeEnd" type="date" class="wo-detail-input" />
                </div>
              </div>
              <div class="wo-detail-helper">
                Use one date for single-day work, or both dates for a range.
              </div>
            </div>

            <div class="wo-detail-section">
              <h3>Notes</h3>

              <div id="detailCompletedRow" class="wo-detail-row" style="margin-bottom:4px;">
                <div class="wo-detail-label">Completed on</div>
                <div id="detailCompletedOn" style="font-size:0.82rem;"></div>
              </div>

              <div class="wo-detail-notes-wrap">
                <textarea id="detailNotesCompletion" class="wo-detail-textarea fm-notes"
                  placeholder="Add notes about what was done, parts used, follow-up needed, etc."></textarea>
                <button type="button" id="detailDictationBtn" class="mic-btn" aria-label="Start dictation">
                  <svg class="mic-svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                    <path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 1 0-6 0v5a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 6 6.92V21H9v2h6v-2h-2v-3.08A7 7 0 0 0 19 11h-2z"/>
                  </svg>
                </button>
              </div>

              <div class="wo-detail-photos">
                <div class="wo-detail-row">
                  <span class="wo-detail-label">Photos</span>
                  <button type="button" id="detailAddPhotosBtn" class="btn-outline btn-small">
                    Add photos
                  </button>
                  <input type="file" id="detailPhotoInput" accept="image/*" multiple hidden />
                </div>
                <div id="detailPhotoHint" class="wo-detail-helper">
                  Attach photos of what needs to be done or what was completed.
                </div>
                <div id="detailPhotoGallery" class="wo-detail-gallery"></div>
              </div>
            </div>
          </div>
        </div>

        <footer class="wo-detail-footer">
          <button type="button" id="detailCancelBtn" class="btn-outline">Close</button>
          <button type="button" id="detailSaveBtn" class="btn-primary">Save updates</button>
        </footer>
      </div>
    </div>

    <!-- Photo lightbox -->
    <div id="photoLightbox" class="wo-photo-lightbox" hidden>
      <div class="wo-photo-lightbox-inner">
        <button type="button" id="photoLightboxClose" class="wo-photo-lightbox-close" aria-label="Close photo">
          ×
        </button>
        <img id="photoLightboxImg" src="" alt="Work order photo" />
      </div>
    </div>

    <!-- Map lightbox -->
    <div id="mapLightbox" class="wo-map-lightbox" hidden>
      <div class="wo-map-lightbox-inner">
        <button type="button" id="mapLightboxClose" class="wo-map-lightbox-close" aria-label="Close map">
          ×
        </button>
        <iframe id="mapLightboxFrame" src="" title="Work order location"></iframe>
      </div>
    </div>

    <!-- Status choice modal -->
    <div id="statusModal" class="wo-status-modal" hidden>
      <div class="wo-status-modal-panel" role="dialog" aria-modal="true">
        <div class="wo-status-modal-header">
          <h2>Set work order status</h2>
          <p class="muted" style="font-size:0.86rem;">
            Choose how you want to save this work order.
          </p>
        </div>
        <div class="wo-status-options">
          <label class="wo-status-option">
            <input type="radio" name="statusChoice" id="statusChoiceInProg" value="in progress">
            <div>
              <div><strong>Keep In Progress</strong></div>
              <div>Work is started but not finished yet.</div>
            </div>
          </label>
          <label class="wo-status-option">
            <input type="radio" name="statusChoice" id="statusChoiceDone" value="completed">
            <div>
              <div><strong>Mark Completed</strong></div>
              <div>Job is fully done and ready to close.</div>
            </div>
          </label>
        </div>
        <div class="wo-status-modal-footer">
          <button type="button" id="statusModalCancel" class="btn-outline">Back</button>
          <button type="button" id="statusModalSave" class="btn-primary">Save status</button>
        </div>
      </div>
    </div>
  </fv-shell>
</body>
</html>
