<!-- =====================================================================
/Farm-vista/pages/field-maintenance/maintenance-add.html  (FULL FILE)

Purpose:
 â€¢ Add new field maintenance / repair requests.
 â€¢ Farm + Field are linked (either can drive the other).
 â€¢ Submitted By = logged-in user (read-only).
 â€¢ Date Submitted = today (display) + serverTimestamp() (stored).
 â€¢ Topic (category) comes from Firestore collection.
 â€¢ Priority 1â€“10, with reason required for 7+.
 â€¢ Notes + lazy photo uploads (upload on save, with previews).
===================================================================== -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FarmVista â€¢ Add Field Maintenance</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#3B7E46" />

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest" />
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png" />
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png" />
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css" />
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css" />

  <!-- Ensure fv-shell -->
  <script>
    (function () {
      if (!customElements.get('fv-shell')) {
        const s = document.createElement('script');
        s.src = '/Farm-vista/js/fv-shell.js';
        s.defer = true;
        document.head.appendChild(s);
      }
    })();
  </script>

  <style>
    .page{
      max-width:1100px;
      margin:0 auto;
      padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + 96px)!important;
    }
    .page-title{margin:0 0 8px 0;}
    .page-sub{margin:0 0 14px 0;color:var(--muted,#67706B);}

    /* Hero card */
    .fm-hero{
      width:min(720px, calc(100% - 24px));
      margin:0 auto;
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));
      overflow:hidden;
    }
    .fm-head{
      display:grid;
      grid-template-columns:36px 1fr;
      gap:12px;
      align-items:center;
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);
    }
    .fm-head-icon{
      width:24px;height:24px;display:grid;place-items:center;color:#2F6C3C;
    }
    .fm-head h2{margin:0;font-size:clamp(20px,3.2vw,26px);line-height:1.2;}
    .fm-body{
      padding:16px;
      display:grid;
      gap:14px;
    }

    .fm-grid{
      display:grid;
      gap:10px;
      grid-template-columns:1fr 1fr;
    }
    .fm-grid-1{
      display:grid;
      gap:10px;
      grid-template-columns:1fr;
    }
    @media(max-width:880px){
      .fm-grid{grid-template-columns:1fr;}
    }

    .fm-label{
      display:block;
      font-weight:800;
      margin:0 0 6px 0;
    }
    .text-required::after{
      content:" *";
      color:var(--green,#3B7E46);
    }

    .input,.select,.textarea{
      width:100%;
      font:inherit;
      font-size:16px;
      color:var(--text);
      background:var(--card-surface,var(--surface));
      border:1px solid var(--border);
      border-radius:10px;
      padding:12px;
      box-sizing:border-box;
      outline:none;
    }
    .textarea{
      min-height:120px;
      resize:vertical;
      padding-right:52px; /* room for mic */
    }
    .input[readonly]{opacity:1}

    .pill{
      display:inline-flex;
      align-items:center;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--card-surface,var(--surface));
      font-size:14px;
    }

    .priority-slider{width:100%;}
    .priority-readout{
      font-size:13px;
      color:var(--muted,#67706B);
      margin-top:4px;
    }

    .actions{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      justify-content:flex-end;
      margin-top:8px;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:148px;
      padding:10px 14px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--card-surface,var(--surface));
      font-weight:800;
      cursor:pointer;
      color:var(--text);
      text-decoration:none;
    }
    .btn-primary{
      border-color:transparent;
      background:#2F6C3C;
      color:#fff;
    }
    .btn[disabled]{opacity:.6;cursor:not-allowed;}

    /* Mic-in-textarea (from Ideas page) */
    .ta-wrap{position:relative;}
    .mic-btn{
      position:absolute;
      right:10px;
      bottom:10px;
      width:36px;
      height:36px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--surface);
      display:grid;
      place-items:center;
      cursor:pointer;
    }
    .mic-btn[disabled]{opacity:.6;cursor:not-allowed;}
    .mic-svg{width:18px;height:18px;display:block;}
    .mic-active{
      background:#2F6C3C;
      color:#fff;
      border-color:#2F6C3C;
    }

    /* Lazy file upload thumbnails (from Ideas page) */
    .thumbs{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px;}
    .thumb{
      width:72px;
      height:72px;
      border:1px solid var(--border);
      border-radius:10px;
      overflow:hidden;
      display:grid;
      place-items:center;
      background:var(--surface);
      font-size:11px;
    }
    .thumb img{max-width:100%;max-height:100%;display:block;}
    .muted-line{font-size:13px;color:var(--muted);margin-top:4px;}
    #uploadNote{margin-top:4px;}

    /* File input style (dark-mode friendly) */
    input[type="file"].input{
      height:auto;
      line-height:normal;
      padding:8px 12px;
      color:var(--text)!important;
      -webkit-text-fill-color:var(--text)!important;
    }
    input[type="file"].input::-webkit-file-upload-button{
      color:#111111!important;
      -webkit-text-fill-color:#111111!important;
      background-color:#ffffff;
    }
  </style>
</head>
<body>
  <fv-shell>
    <div class="page container">
      <h1 class="page-title">Add Field Maintenance</h1>
      <p class="page-sub">
        Log field maintenance or repair needs by farm and field so they can be tracked, prioritized, and completed.
      </p>

      <section class="fm-hero">
        <header class="fm-head">
          <div class="fm-head-icon" aria-hidden="true">ðŸ§°</div>
          <div>
            <h2>Add Maintenance Request</h2>
            <p class="page-sub" style="margin:2px 0 0 0;">Choose farm and field, set priority, add notes and optional photos.</p>
          </div>
        </header>

        <div class="fm-body">
          <form id="fmForm" autocomplete="off">
            <!-- Top: Farm / Field / Submitted By / Date -->
            <div class="fm-grid">
              <div class="field">
                <label for="farmSelect" class="fm-label text-required">Farm</label>
                <select id="farmSelect" class="select" required>
                  <option value="">Select farmâ€¦</option>
                </select>
              </div>

              <div class="field">
                <label for="fieldSelect" class="fm-label text-required">Field</label>
                <select id="fieldSelect" class="select" required>
                  <option value="">Select fieldâ€¦</option>
                </select>
              </div>

              <div class="field">
                <label class="fm-label">Submitted by</label>
                <span id="submittedByDisplay" class="pill">Detecting userâ€¦</span>
                <input id="submittedBy" type="hidden" />
              </div>

              <div class="field">
                <label class="fm-label">Date submitted</label>
                <span id="dateSubmittedDisplay" class="pill"></span>
              </div>
            </div>

            <!-- Topic + Priority -->
            <div class="fm-grid">
              <div class="field">
                <label for="topicSelect" class="fm-label text-required">Topic / Category</label>
                <select id="topicSelect" class="select" required>
                  <option value="">Select topicâ€¦</option>
                </select>
                <div class="muted-line">
                  Examples: Repair Needed, Washout, Tile Blowout, Fence, Tree Removal, etc.
                </div>
              </div>

              <div class="field">
                <label for="priority" class="fm-label text-required">Priority (1 = low, 10 = high)</label>
                <input
                  id="priority"
                  class="priority-slider"
                  type="range"
                  min="1"
                  max="10"
                  step="1"
                  value="5"
                />
                <div class="priority-readout">
                  Priority: <strong><span id="priorityValue">5</span>/10</strong>
                </div>

                <div id="priorityReasonBlock" style="margin-top:8px;display:none;">
                  <label for="priorityReason" class="fm-label">Why is this a high priority? (7â€“10)</label>
                  <textarea id="priorityReason" class="textarea" placeholder="Explain why this needs urgent attentionâ€¦"></textarea>
                </div>
              </div>
            </div>

            <!-- Notes with dictation mic -->
            <div class="fm-grid-1">
              <div class="field">
                <label for="notes" class="fm-label text-required">Details / Notes</label>
                <div class="ta-wrap">
                  <textarea
                    id="notes"
                    class="textarea"
                    placeholder="Describe the issue, location in the field, severity, equipment needed, etc."
                    required
                  ></textarea>
                  <button id="mic" type="button" class="mic-btn" aria-label="Start dictation">
                    <svg class="mic-svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                      <path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 1 0-6 0v5a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 6 6.92V21H9v2h6v-2h-2v-3.08A7 7 0 0 0 19 11h-2z"/>
                    </svg>
                  </button>
                </div>
              </div>
            </div>

            <!-- Photos with lazy upload + thumbs -->
            <div class="fm-grid-1">
              <div class="field">
                <label for="photos" class="fm-label">Photos (optional)</label>
                <input
                  id="photos"
                  class="input"
                  type="file"
                  accept="image/*"
                  multiple
                />
                <div id="thumbs" class="thumbs" aria-hidden="true"></div>
                <div id="fileHint" class="muted-line" aria-hidden="true"></div>
                <div id="uploadNote" class="muted-line" style="display:none"></div>
              </div>
            </div>

            <div class="actions">
              <button type="button" id="btnCancel" class="btn">Cancel</button>
              <button type="submit" id="btnSave" class="btn btn-primary">Save</button>
            </div>
          </form>
        </div>
      </section>
    </div>
  </fv-shell>

  <script type="module">
    import {
      ready,
      getFirestore,
      collection,
      getDocs,
      addDoc,
      updateDoc,
      serverTimestamp,
      getAuth,
      onAuthStateChanged,
      getStorage,
      ref as storageRef,
      uploadBytes,
      getDownloadURL
    } from '/Farm-vista/js/firebase-init.js';
    import { NAV_MENU } from '/Farm-vista/js/menu.js';

    const $ = (id) => document.getElementById(id);

    const db   = getFirestore();
    const auth = getAuth();

    const state = {
      farms: [],
      fields: [],
      topics: []
    };

    function formatLocalDate(d = new Date()) {
      const t = new Date(d.getTime() - d.getTimezoneOffset() * 60000);
      return t.toISOString().slice(0, 10); // yyyy-mm-dd if needed
    }
    function formatDisplayDate(d = new Date()) {
      const opts = { year: 'numeric', month: 'short', day: 'numeric' };
      return d.toLocaleDateString(undefined, opts);
    }

    function inferName(docData) {
      return docData.name || docData.farmName || docData.fieldName || docData.label || 'Unnamed';
    }

    async function loadFarms() {
      try {
        const snap = await getDocs(collection(db, 'farms'));
        state.farms = snap.docs.map((doc) => {
          const data = doc.data() || {};
          return { id: doc.id, name: inferName(data) };
        }).sort((a,b)=>a.name.localeCompare(b.name));

        const farmSelect = $('farmSelect');
        state.farms.forEach((f) => {
          const opt = document.createElement('option');
          opt.value = f.id;
          opt.textContent = f.name;
          farmSelect.appendChild(opt);
        });
      } catch (err) {
        console.error('Error loading farms:', err);
        alert('Error loading farms. Check console for details.');
      }
    }

    async function loadFields() {
      try {
        const snap = await getDocs(collection(db, 'fields'));
        state.fields = snap.docs.map((doc) => {
          const data = doc.data() || {};
          const farmId =
            data.farmId ||
            data.farm ||
            data.farmDocId ||
            (typeof data.farmRef === 'string' ? data.farmRef : null) ||
            null;

          return {
            id: doc.id,
            name: inferName(data),
            farmId
          };
        }).sort((a,b)=>a.name.localeCompare(b.name));

        populateFieldSelect(); // initial
      } catch (err) {
        console.error('Error loading fields:', err);
        alert('Error loading fields. Check console for details.');
      }
    }

    function populateFieldSelect(filteredFarmId = null) {
      const select = $('fieldSelect');
      const prev = select.value;
      select.innerHTML = '<option value="">Select fieldâ€¦</option>';

      let fieldsToShow = state.fields;
      if (filteredFarmId) {
        fieldsToShow = state.fields.filter((f) => f.farmId === filteredFarmId);
      }

      fieldsToShow.forEach((f) => {
        const opt = document.createElement('option');
        opt.value = f.id;
        opt.textContent = f.name;
        select.appendChild(opt);
      });

      if (fieldsToShow.some((f) => f.id === prev)) {
        select.value = prev;
      }
    }

    async function loadTopics() {
      try {
        const snap = await getDocs(collection(db, 'fieldMaintenanceTopics'));
        state.topics = snap.docs.map((doc) => {
          const data = doc.data() || {};
          return {
            id: doc.id,
            label: inferName(data),
            isArchived: !!data.isArchived
          };
        }).filter(t => !t.isArchived)
          .sort((a,b)=>a.label.localeCompare(b.label));

        const sel = $('topicSelect');
        state.topics.forEach((t) => {
          const opt = document.createElement('option');
          opt.value = t.id;
          opt.textContent = t.label;
          sel.appendChild(opt);
        });
      } catch (err) {
        console.error('Error loading topics:', err);
      }
    }

    function setupAuth() {
      const display = $('submittedByDisplay');
      const hidden  = $('submittedBy');

      onAuthStateChanged(auth, (user) => {
        if (!user) {
          display.textContent = 'Not signed in';
          hidden.value = '';
          return;
        }
        const who = user.displayName || user.email || 'Unknown user';
        display.textContent = who;
        hidden.value = who;
      });
    }

    function setupDate() {
      $('dateSubmittedDisplay').textContent = formatDisplayDate(new Date());
    }

    function setupPriority() {
      const slider = $('priority');
      const valueSpan = $('priorityValue');
      const block = $('priorityReasonBlock');
      const reason = $('priorityReason');

      const updateUI = () => {
        const v = Number(slider.value || 5);
        valueSpan.textContent = v;
        if (v >= 7) {
          block.style.display = '';
        } else {
          block.style.display = 'none';
          reason.value = '';
        }
      };

      slider.addEventListener('input', updateUI);
      updateUI(); // initial
    }

    function setupFarmFieldLinking() {
      const farmSelect = $('farmSelect');
      const fieldSelect = $('fieldSelect');

      farmSelect.addEventListener('change', () => {
        const farmId = farmSelect.value || null;
        populateFieldSelect(farmId);
      });

      fieldSelect.addEventListener('change', () => {
        const fieldId = fieldSelect.value;
        if (!fieldId) return;
        const field = state.fields.find((f) => f.id === fieldId);
        if (!field || !field.farmId) return;

        farmSelect.value = field.farmId;
        populateFieldSelect(field.farmId);
        fieldSelect.value = fieldId;
      });
    }

    /* Thumbs + lazy upload (Ideas pattern) */
    function setupFilePreview() {
      const input = $('photos');
      const thumbs = $('thumbs');
      const fileHint = $('fileHint');

      if (!input) return;

      input.addEventListener('change', () => {
        const files = Array.from(input.files || []);
        thumbs.innerHTML = '';
        if (!files.length) {
          thumbs.setAttribute('aria-hidden', 'true');
          fileHint.textContent = '';
          return;
        }
        files.forEach((f) => {
          const wrap = document.createElement('div');
          wrap.className = 'thumb';
          if (f.type.startsWith('image/')) {
            const img = document.createElement('img');
            img.alt = f.name;
            wrap.appendChild(img);
            const reader = new FileReader();
            reader.onload = (e) => { img.src = e.target.result; };
            reader.readAsDataURL(f);
          } else {
            wrap.textContent = (f.name || '').split('.').pop().toUpperCase();
          }
          thumbs.appendChild(wrap);
        });
        thumbs.removeAttribute('aria-hidden');
        fileHint.textContent = files.length + (files.length === 1 ? ' file selected' : ' files selected');
        fileHint.removeAttribute('aria-hidden');
      });
    }

    async function uploadPhotos(docId) {
      const input = $('photos');
      const uploadNote = $('uploadNote');
      uploadNote.style.display = 'none';
      uploadNote.textContent = '';

      const files = Array.from(input?.files || []);
      if (!files.length) return { ok:true, meta:[], note:'' };

      const store = getStorage();
      const meta = [];

      for (let i = 0; i < files.length; i++) {
        const f = files[i];
        const safeName = (Date.now() + '-' + i + '-' + (f.name || 'photo')).replace(/[^a-zA-Z0-9._-]+/g, '_');
        const path = `fieldMaintenance/${docId}/photos/${safeName}`;
        try {
          const ref = storageRef(store, path);
          await uploadBytes(ref, f, { contentType: f.type || 'application/octet-stream' });
          const url = await getDownloadURL(ref);
          meta.push({
            name: f.name || safeName,
            path,
            url,
            contentType: f.type || '',
            size: f.size || 0
          });
        } catch (e) {
          console.warn('[FieldMaintenance] upload error for', path, e);
          return {
            ok:false,
            meta,
            note:'Saved main record. Photo upload failed (check Storage / network).'
          };
        }
      }

      return { ok:true, meta, note:'' };
    }

    /* Dictation (mic) from Ideas page */
    function setupSpeech() {
      const mic = $('mic');
      const notes = $('notes');
      if (!mic || !notes) return;

      const hasSpeech = ('webkitSpeechRecognition' in window) || ('SpeechRecognition' in window);
      if (!hasSpeech) {
        mic.style.display = 'none';
        return;
      }

      const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
      const rec = new Rec();
      rec.lang = 'en-US';
      rec.interimResults = true;
      rec.continuous = false;

      let active = false;
      let baseText = '';

      const setMic = (on) => {
        mic.classList.toggle('mic-active', on);
        mic.setAttribute('aria-label', on ? 'Stop dictation' : 'Start dictation');
      };

      mic.addEventListener('click', () => {
        if (!active) {
          baseText = notes.value ? notes.value + ' ' : '';
          try {
            rec.start();
            active = true;
            setMic(true);
          } catch {}
        } else {
          try { rec.stop(); rec.abort(); } catch {}
          active = false;
          setMic(false);
        }
      });

      rec.onresult = (ev) => {
        let txt = '';
        for (let i = ev.resultIndex; i < ev.results.length; i++) {
          txt += ev.results[i][0].transcript;
        }
        notes.value = baseText + txt;
      };
      rec.onend = () => { active = false; setMic(false); };
      rec.onerror = () => { active = false; setMic(false); };
    }

    function setupActions() {
      $('btnCancel').addEventListener('click', () => {
        // Adjust path if your portal file name differs
        window.location.href = './maintenance.html';
      });

      $('fmForm').addEventListener('submit', async (evt) => {
        evt.preventDefault();
        const btnSave = $('btnSave');
        btnSave.disabled = true;

        try {
          const farmId = $('farmSelect').value;
          const fieldId = $('fieldSelect').value;
          const topicId = $('topicSelect').value;
          const priority = Number($('priority').value || 0);
          const notes = $('notes').value.trim();
          const submittedBy = $('submittedBy').value || null;
          const priorityReason = $('priorityReason').value.trim();

          if (!farmId || !fieldId || !topicId || !notes) {
            alert('Farm, Field, Topic, and Notes are required.');
            btnSave.disabled = false;
            return;
          }
          if (!priority || priority < 1 || priority > 10) {
            alert('Priority must be between 1 and 10.');
            btnSave.disabled = false;
            return;
          }
          if (priority >= 7 && !priorityReason) {
            alert('Please explain why this is a high-priority (7â€“10) item.');
            btnSave.disabled = false;
            return;
          }

          const farm  = state.farms.find((f) => f.id === farmId) || null;
          const field = state.fields.find((f) => f.id === fieldId) || null;
          const topic = state.topics.find((t) => t.id === topicId) || null;

          const payload = {
            farmId,
            farmName: farm?.name || null,
            fieldId,
            fieldName: field?.name || null,
            submittedBy,
            dateSubmitted: serverTimestamp(),
            topicId,
            topicLabel: topic?.label || null,
            priority,
            priorityReason: priority >= 7 ? priorityReason : null,
            notes,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp(),
            status: 'open'
          };

          const docRef = await addDoc(collection(db, 'fieldMaintenance'), payload);

          // Lazy upload photos AFTER main record exists
          const up = await uploadPhotos(docRef.id);
          if (up.meta.length) {
            await updateDoc(docRef, { photos: up.meta, updatedAt: serverTimestamp() });
          }
          if (!up.ok && up.note) {
            const n = $('uploadNote');
            n.textContent = up.note;
            n.style.display = 'block';
          }

          alert('Field maintenance item saved.');
          window.location.href = './maintenance.html';
        } catch (err) {
          console.error('Error saving maintenance item:', err);
          alert('There was an error saving this maintenance item. Check console for details.');
          $('btnSave').disabled = false;
        }
      });
    }

    ready().then(() => {
      const shell = document.querySelector('fv-shell');
      if (shell) shell.nav = NAV_MENU;

      setupAuth();
      setupDate();
      setupPriority();
      setupFarmFieldLinking();
      setupFilePreview();
      setupSpeech();
      setupActions();

      loadFarms();
      loadFields();
      loadTopics();
    });
  </script>
</body>
</html>