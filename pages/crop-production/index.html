<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FarmVista ‚Ä¢ Crop Production</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#3B7E46" />

  <!-- PWA + icons -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest" />
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png" />
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png" />

  <!-- Early theme boot (prevents flash) -->
  <script src="/Farm-vista/js/theme-boot.js"></script>

  <!-- Firebase config + FVData (needed for Field Maintenance KPI) -->
  <script src="/Farm-vista/js/firebase-config.js"></script>
  <script src="/Farm-vista/js/fv-data.js"></script>

  <!-- Global CSS (same as Setup / Dashboard) -->
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css" />
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css" />
  <link rel="stylesheet" href="/Farm-vista/assets/css/dashboard.css" />

  <style>
    body{
      background:var(--app-bg,var(--surface));
      min-height:100vh;
    }
    .page{
      max-width:1100px;
      margin:0 auto;
      padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + 96px)!important;
    }

    /* Dashboard-style KPI badge (same as main Dashboard) */
    .dash-kpi{
      display:block;
      margin:12px 0 18px 0;
      padding:14px 16px;
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--surface);
      box-shadow:0 8px 18px rgba(0,0,0,0.06);
      text-decoration:none;
      color:inherit;
      transition:transform 0.08s ease, box-shadow 0.08s ease, border-color 0.08s ease;
    }
    .dash-kpi:hover{
      transform:translateY(-1px);
      box-shadow:0 12px 24px rgba(0,0,0,0.10);
      border-color:rgba(59,126,70,0.55);
    }
    .dash-kpi-main{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .dash-kpi-text{
      flex:1 1 auto;
      min-width:0;
    }
    .dash-kpi-label{
      font-size:13px;
      letter-spacing:.06em;
      text-transform:uppercase;
      font-weight:600;
      color:var(--muted,#67706B);
      margin-bottom:4px;
    }
    .dash-kpi-title,
    .dash-kpi-title-secondary{
      font-size:15px;
      font-weight:600;
      color:var(--text,#1d211f);
    }
    .dash-kpi-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-top:6px;
    }
    /* extra space between first and second row so circles don't touch */
    .dash-kpi-row + .dash-kpi-row{
      margin-top:10px;
    }

    .dash-kpi-count{
      min-width:52px;
      min-height:52px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:22px;
      font-weight:700;
      border:1px solid rgba(59,126,70,0.4);
      background:rgba(59,126,70,0.10);
      color:var(--text,#1d211f);
    }
    /* second circle same size as first */
    .dash-kpi-count-secondary{
      /* same size, just re-use base style */
    }

    .dash-kpi-sub{
      margin-top:6px;
      font-size:12px;
      color:var(--muted,#67706B);
    }
    .dash-kpi-empty .dash-kpi-count,
    .dash-kpi-empty .dash-kpi-count-secondary{
      border-color:rgba(0,0,0,0.12);
      background:rgba(0,0,0,0.02);
      color:var(--muted,#67706B);
    }

    /* Badge links (keep numbers black, no purple visited) */
    .dash-kpi-count-link{
      text-decoration:none;
      display:inline-flex;
      color:inherit;
    }
    .dash-kpi-count-link:visited{
      color:inherit;
    }
    .dash-kpi-count-link:focus-visible{
      outline:2px solid var(--accent,#3B7E46);
      outline-offset:2px;
    }

    /* Overview card: left on mobile, centered on wider screens */
    .cp-overview-card{
      /* mobile / default: just use normal flow */
    }
    @media (min-width: 900px){
      .cp-overview-card{
        margin-left:auto;
        margin-right:auto;
      }
    }
  </style>
</head>
<body>
  <fv-shell>
    <div class="page container">
      <h1 class="page-title">Crop Production Dashboard</h1>

      <p class="muted" style="margin:0 0 18px 0; color:var(--muted, #87908a);">
        The Crop Production module is your central hub for recording and managing in-field operations across the season‚Äîplanting,
        in-season passes, maintenance, and harvest results.
      </p>
      <p class="muted" style="margin:0 0 18px 0; color:var(--muted, #87908a);">
        It also captures agronomic <strong>trials</strong> and <strong>check strips</strong> so you can compare hybrids, fertility programs,
        and application strategies across farms and years.
      </p>
      <p class="muted" style="margin:0 10px 22px 0; color:var(--muted, #87908a);">
        Use the sidebar to jump into <em>Planting</em>, <em>Spraying</em>, <em>Fertilizer</em>, <em>Maintenance</em>, <em>Harvest</em>,
        <em>Aerial Applications</em>, and <em>Trials</em>.
      </p>

      <!-- ============================
           KPI: Pending / In-Progress Field Maintenance
           ============================ -->
      <a
        href="field-maintenance/maintenance-active.html"
        class="dash-kpi dash-kpi-empty"
        id="wo-active-kpi"
      >
        <div class="dash-kpi-main">
          <div class="dash-kpi-text">
            <div class="dash-kpi-label">Field Maintenance</div>
            <div class="dash-kpi-row">
              <div class="dash-kpi-title">
                Pending &amp; in-progress work orders
              </div>
              <div class="dash-kpi-count" id="wo-active-count">‚Äì</div>
            </div>
          </div>
          <div class="dash-kpi-sub" id="wo-active-sub">
            Checking for active field maintenance work orders‚Ä¶
          </div>
        </div>
      </a>

      <!-- ============================
           KPI: Active Field Trials
           Two rows:
           ‚Ä¢ Row 1: Active trials (circle links to trials edit)
           ‚Ä¢ Row 2: Enrolled fields (circle links to report)
           ============================ -->
      <div
        class="dash-kpi dash-kpi-empty"
        id="trials-kpi"
      >
        <div class="dash-kpi-main">
          <div class="dash-kpi-text">
            <div class="dash-kpi-label">Field Trials</div>

            <!-- Row 1: Active crop trials & check strips -->
            <div class="dash-kpi-row">
              <div class="dash-kpi-title">
                Active crop trials &amp; check strips
              </div>
              <a
                href="trials/trials-edit.html"
                class="dash-kpi-count-link"
                aria-label="View active trials"
              >
                <div class="dash-kpi-count" id="trials-count-trials">‚Äì</div>
              </a>
            </div>

            <!-- Row 2: Fields enrolled in those active trials -->
            <div class="dash-kpi-row">
              <div class="dash-kpi-title-secondary">
                Fields enrolled in active trials
              </div>
              <a
                href="/Farm-vista/pages/reports/reports-field-activetrials.html"
                class="dash-kpi-count-link"
                aria-label="View report of fields in active trials"
              >
                <div class="dash-kpi-count dash-kpi-count-secondary" id="trials-count-fields">‚Äì</div>
              </a>
            </div>
          </div>

          <div class="dash-kpi-sub" id="trials-sub">
            Tap a circle to edit trials or open the active fields report.
          </div>
        </div>
      </div>

      <div class="card cp-overview-card" style="max-width:780px;">
        <h2 class="card-title">Overview</h2>
        <ul class="list">
          <li>üìù&nbsp; Enter and review production activities</li>
          <li>üåæ&nbsp; Track yield trials &amp; check strips</li>
          <li>üìÇ&nbsp; Maintain field-level history</li>
          <li>üìà&nbsp; Analyze year-over-year performance</li>
        </ul>
      </div>
    </div>
  </fv-shell>

  <!-- Bootloader: identical order/paths as the working Setup page -->
  <script>
    (function () {
      const urlRev = new URL(location.href).searchParams.get('rev');
      const REV = urlRev || String(Date.now());
      const files = [
        '/Farm-vista/js/version.js',
        '/Farm-vista/js/core.js',
        '/Farm-vista/js/fv-hero-card.js',
        '/Farm-vista/js/fv-shell.js',
        '/Farm-vista/js/fv-hero.js'
      ];
      (async function loadSeq() {
        for (const src of files) {
          await new Promise((resolve, reject) => {
            const s = document.createElement('script');
            s.src = src + '?rev=' + REV;
            s.async = false;
            s.onload = resolve;
            s.onerror = () => reject(new Error('Failed to load ' + s.src));
            document.body.appendChild(s);
          });
        }
      })().catch(err => console.error('Bootloader failed:', err));
    })();
  </script>

  <!-- ===========================================
       Field Maintenance KPI JS (pending + in progress)
       =========================================== -->
  <script>
    (function(){
      "use strict";

      const kpiEl   = document.getElementById("wo-active-kpi");
      const countEl = document.getElementById("wo-active-count");
      const subEl   = document.getElementById("wo-active-sub");

      if (!kpiEl || !countEl || !subEl) return;

      function applyState(count){
        const n = Number(count) || 0;
        countEl.textContent = n.toString();

        if (!n){
          kpiEl.classList.add("dash-kpi-empty");
          subEl.textContent = "No pending or in-progress field maintenance work orders.";
        }else{
          kpiEl.classList.remove("dash-kpi-empty");
          subEl.textContent = n === 1
            ? "field maintenance work order currently pending or in progress."
            : "field maintenance work orders currently pending or in progress.";
        }
      }

      async function loadActive(){
        try{
          if (!window.FVData || typeof FVData.getWhere !== "function"){
            console.warn("[crop-production] FVData.getWhere not available for KPI.");
            applyState(0);
            return;
          }

          if (typeof FVData.ready === "function"){
            await FVData.ready();
          }

          // Count docs where status == "pending" OR status == "in progress"
          const [pendingDocs, inProgDocs] = await Promise.all([
            FVData.getWhere("fieldMaintenance", "status", "==", "pending",     { limit: 500 }) || [],
            FVData.getWhere("fieldMaintenance", "status", "==", "in progress", { limit: 500 }) || []
          ]);

          const ids = new Set();
          pendingDocs.forEach(d => { if (d && d.id) ids.add(d.id); });
          inProgDocs.forEach(d => { if (d && d.id) ids.add(d.id); });

          applyState(ids.size);
        }catch(err){
          console.warn("[crop-production] failed to load active work-order KPI:", err);
          applyState(0);
        }
      }

      loadActive();
      document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === "visible") loadActive();
      });
    })();
  </script>

  <!-- ===========================================
       Field Trials KPI JS
       - Counts active trials
       - Counts fields in those active trials
       - Feeds both circles
       =========================================== -->
  <script type="module">
    import {
      ready,
      getFirestore,
      collection,
      getDocs,
      query,
      where
    } from '/Farm-vista/js/firebase-init.js';

    const kpiEl        = document.getElementById("trials-kpi");
    const trialsEl     = document.getElementById("trials-count-trials");
    const fieldsEl     = document.getElementById("trials-count-fields");
    const subElTrials  = document.getElementById("trials-sub");

    if (kpiEl && trialsEl && fieldsEl && subElTrials) {
      function applyState(trialCount, fieldCount){
        const nTrials = Number(trialCount) || 0;
        const nFields = Number(fieldCount) || 0;

        trialsEl.textContent = nTrials.toString();
        fieldsEl.textContent = nFields.toString();

        if (!nTrials){
          kpiEl.classList.add("dash-kpi-empty");
          subElTrials.textContent = "No active field trials found.";
        }else{
          kpiEl.classList.remove("dash-kpi-empty");
          subElTrials.textContent = "Tap a circle to edit trials or open the active fields report.";
        }
      }

      async function loadTrials(){
        try{
          // Ensure Firebase is initialized
          await ready;
          const db = getFirestore();

          // Only count trials where status == "active"
          const trialsRef = collection(db, "fieldTrials");
          const q = query(trialsRef, where("status", "==", "active"));
          const snap = await getDocs(q);

          const trialCount = typeof snap.size === "number" ? snap.size : 0;

          // If no active trials, we can short-circuit
          if (!trialCount){
            applyState(0, 0);
            return;
          }

          // For each active trial, count enrolled fields from subcollection:
          // fieldTrials/{trialId}/fields
          const trialIds = [];
          snap.forEach(docSnap => {
            if (docSnap && docSnap.id) {
              trialIds.push(docSnap.id);
            }
          });

          let fieldCount = 0;

          if (trialIds.length){
            const fieldPromises = trialIds.map(trialId => {
              const fieldsRef = collection(db, "fieldTrials", trialId, "fields");
              return getDocs(fieldsRef).then(fieldsSnap => {
                return typeof fieldsSnap.size === "number" ? fieldsSnap.size : 0;
              });
            });

            const fieldCounts = await Promise.all(fieldPromises);
            fieldCount = fieldCounts.reduce((sum, n) => sum + (Number(n) || 0), 0);
          }

          applyState(trialCount, fieldCount);
        }catch(err){
          console.warn("[crop-production] failed to load field trials KPI:", err);
          applyState(0, 0);
        }
      }

      loadTrials();
      document.addEventListener("visibilitychange", () => {
        if (document.visibilityState === "visible") loadTrials();
      });
    }
  </script>

  <noscript>
    <div class="container"><div class="card">JavaScript is required for Crop Production.</div></div>
  </noscript>
</body>
</html>
