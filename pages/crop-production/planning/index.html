<!-- =====================================================================
/Farm-vista/pages/crop-production/planning/index.html  (FULL FILE)
Rev: 2025-12-31c

DESKTOP: ‚úÖ unchanged (looks perfect)

MOBILE / NARROW SCREENS (PHONE VIEW MODE):
‚úÖ ‚ÄúView-only‚Äù reading mode (no fighting with DnD UI)
‚úÖ Auto-fit scale so nothing sticks out past the hero card
‚úÖ Still scrollable (vertical) to read the data
‚úÖ Prevents drag-start on phone (so it behaves like a report)

Notes:
- We do NOT change the crop-planner module code here.
- We mount the module into #plannerInner and then scale/fix overflow on phones.
===================================================================== -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FarmVista ‚Ä¢ Planning Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#3B7E46" />

  <script src="/Farm-vista/js/theme-boot.js"></script>

  <!-- Standard includes (ABSOLUTE paths) -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest" />
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png" />
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png" />

  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css" />
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css" />

  <!-- Ensure fv-shell -->
  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true;
        document.head.appendChild(s);
      }
    })();
  </script>

  <style>
    :root{
      --card-max:1200px;
      --page-bottom-gap:96px;
      --accent:#2F6C3C;
      --hero-icon-col:36px;
      --hero-icon-size:24px;

      /* Phone read-mode tuning */
      --phone-fit-max: 1;     /* computed in JS */
      --phone-fit-min: .72;   /* don't shrink into unreadable dust */
    }

    body{ background:var(--app-bg,var(--surface)); }

    .wrap{
      max-width:var(--card-max);
      margin:0 auto;
      padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + var(--page-bottom-gap)) !important;
    }

    .hero{
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));
      overflow:hidden;
    }

    .hero-head{
      display:grid;
      grid-template-columns:var(--hero-icon-col) 1fr;
      gap:12px;
      align-items:center;
      padding:14px 16px;
      background:linear-gradient(90deg,rgba(47,108,60,.12),transparent);
      border-bottom:1px solid var(--border);
    }

    .hero-head .icon{
      width:var(--hero-icon-size);
      height:var(--hero-icon-size);
      color:var(--accent);
      display:grid;
      place-items:center;
    }

    .hero-head h1{
      margin:0;
      font-size:clamp(20px,3.2vw,26px);
      line-height:1.2;
    }

    .muted{ color:var(--muted,#67706B); }

    .body{
      padding:16px;
      display:grid;
      gap:14px;
    }

    /* Tiles */
    .tiles{
      display:grid;
      gap:10px;
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }
    @media (max-width:980px){
      .tiles{ grid-template-columns:1fr; }
    }

    .tile{
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--card-surface,var(--surface));
      padding:12px;
      cursor:pointer;
      user-select:none;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      transition: transform .06s ease, border-color .12s ease, background .12s ease;
    }
    .tile:active{ transform: translateY(1px); }
    .tile:hover{ background: color-mix(in srgb, var(--surface) 92%, rgba(47,108,60,.05)); }

    .tile .left{
      display:flex;
      gap:10px;
      align-items:center;
      min-width:0;
    }

    .tileIcon{
      width:38px;
      height:38px;
      border-radius:12px;
      border:1px solid var(--border);
      background: var(--surface);
      display:grid;
      place-items:center;
      color: var(--accent);
      flex:0 0 auto;
      font-weight:900;
    }

    .tileText{ min-width:0; }
    .tileTitle{
      font-weight:900;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .tileSub{
      margin-top:3px;
      font-size:12px;
      color: var(--muted,#67706B);
      font-weight:800;
      letter-spacing:.2px;
      text-transform:uppercase;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .tile.active{
      border-color: color-mix(in srgb, var(--accent) 55%, var(--border));
      background: color-mix(in srgb, var(--surface) 88%, rgba(47,108,60,.10));
      box-shadow: 0 10px 20px rgba(0,0,0,.10);
    }

    /* Host */
    .hostWrap{
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--surface);
      overflow:hidden;
    }
    .hostTop{
      padding:12px 12px;
      border-bottom:1px solid var(--border);
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .hostTop .title{ font-weight:900; }
    .hostTop .hint{
      color: var(--muted,#67706B);
      font-size:12px;
      font-weight:800;
      letter-spacing:.2px;
      text-transform:uppercase;
    }

    /* Module mount area: keep desktop same */
    #plannerHost{ padding:0; }

    .hostEmpty{
      padding:16px;
      color:var(--muted,#67706B);
      font-weight:900;
    }

    /* =====================================================================
       PHONE READ MODE (VIEW-ONLY)
       - Auto-fit scale so content never overflows the hero card
       - Still scrolls vertically
    ===================================================================== */
    .phoneRead #plannerHost{
      padding: 10px 10px 12px 10px;
      background: var(--surface);
    }

    .phoneRead .hostTop{
      /* keep the header (so user knows what they're viewing), but tighten it up */
      padding:10px 10px;
      gap:8px;
    }

    /* the viewport that scrolls */
    .plannerViewport{
      overflow-y:auto;
      overflow-x:hidden;
      -webkit-overflow-scrolling:touch;
      padding: 0;
    }

    /* the inner content gets scaled down if needed */
    #plannerInner{
      transform-origin: top left;
      will-change: transform;
    }

    .phoneRead #plannerInner{
      /* JS sets --phone-fit-max */
      transform: scale(var(--phone-fit-max));
      width: calc(100% / var(--phone-fit-max));
    }

    /* Make sure nothing can force horizontal overflow on phone */
    .phoneRead #plannerInner,
    .phoneRead #plannerInner *{
      max-width:100% !important;
      box-sizing:border-box !important;
    }

    /* Prevent accidental drag behaviors on phone (still allows scrolling & taps) */
    .phoneRead *{
      -webkit-user-drag: none;
    }

    /* Only apply ‚ÄúphoneRead‚Äù on actual phone-ish widths */
    @media (max-width: 620px){
      /* optional: hide the tiles on phone so it‚Äôs just a clean viewer */
      .phoneRead #tiles{ display:none !important; }
      .phoneRead .body{ padding:12px; }
      .phoneRead .hero-head{ padding:12px 14px; }
      .phoneRead .hero-head h1{ font-size:20px; }
      .phoneRead .muted{ font-size:13px; }
    }
  </style>
</head>

<body>
  <fv-shell>
    <div class="wrap">
      <section class="hero">
        <header class="hero-head">
          <div class="icon" aria-hidden="true">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"
                 fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                 aria-hidden="true">
              <path d="M4 19V5"></path>
              <path d="M20 19V5"></path>
              <path d="M4 12h16"></path>
            </svg>
          </div>
          <div>
            <h1>Planning Dashboard</h1>
            <p class="muted" id="subHint">Pick a planner tool below. It opens inline (no popup, no iframe).</p>
          </div>
        </header>

        <div class="body">
          <div class="tiles" id="tiles">
            <div class="tile active"
                 data-title="Crop Planner"
                 data-module="/Farm-vista/js/crop-planning/crop-planner.module.js">
              <div class="left">
                <div class="tileIcon">üåΩ</div>
                <div class="tileText">
                  <div class="tileTitle">Crop Planner</div>
                  <div class="tileSub">Assign corn/beans</div>
                </div>
              </div>
              <div class="muted" style="font-weight:900;">Open</div>
            </div>

            <div class="tile"
                 data-title="Anhydrous"
                 data-module="">
              <div class="left">
                <div class="tileIcon">üßØ</div>
                <div class="tileText">
                  <div class="tileTitle">Anhydrous</div>
                  <div class="tileSub">vendors + complete</div>
                </div>
              </div>
              <div class="muted" style="font-weight:900;">Soon</div>
            </div>

            <div class="tile"
                 data-title="More planners"
                 data-module="">
              <div class="left">
                <div class="tileIcon">üõ†Ô∏è</div>
                <div class="tileText">
                  <div class="tileTitle">More planners</div>
                  <div class="tileSub">dry ‚Ä¢ liquid ‚Ä¢ spray</div>
                </div>
              </div>
              <div class="muted" style="font-weight:900;">Soon</div>
            </div>
          </div>

          <div class="hostWrap">
            <div class="hostTop">
              <div>
                <div class="title" id="hostTitle">Crop Planner</div>
                <div class="hint" id="hostHint">Loaded inline</div>
              </div>
              <div class="hint" id="hostModuleHint">crop-planner.module.js</div>
            </div>

            <div id="plannerHost">
              <!-- On phone we use this viewport to keep it scrollable while scaling the inner content -->
              <div class="plannerViewport" id="plannerViewport">
                <div id="plannerInner">
                  <div class="hostEmpty">Loading‚Ä¶</div>
                </div>
              </div>
            </div>
          </div>

        </div>
      </section>
    </div>
  </fv-shell>

  <script type="module">
    const tiles = document.getElementById('tiles');
    const hostTitle = document.getElementById('hostTitle');
    const hostModuleHint = document.getElementById('hostModuleHint');
    const subHint = document.getElementById('subHint');

    const viewport = document.getElementById('plannerViewport');
    const inner = document.getElementById('plannerInner');

    let current = null;

    const mqPhone = window.matchMedia('(max-width: 620px)');
    function applyPhoneClass(){
      document.body.classList.toggle('phoneRead', mqPhone.matches);
      subHint.textContent = mqPhone.matches
        ? 'Phone mode: view-only (auto-fit to screen).'
        : 'Pick a planner tool below. It opens inline (no popup, no iframe).';
    }

    // Prevent drag starts on phone (keeps it from feeling ‚Äújunk‚Äù / DnD-ish)
    function wireViewOnlyGuards(){
      const onDragStart = (e) => { if (mqPhone.matches) e.preventDefault(); };
      const onDrop = (e) => { if (mqPhone.matches) e.preventDefault(); };
      document.addEventListener('dragstart', onDragStart, { capture:true });
      document.addEventListener('drop', onDrop, { capture:true });
    }

    // Auto-fit: if module content is wider than viewport, scale it down to fit.
    function fitPhoneWidth(){
      if(!mqPhone.matches){
        document.documentElement.style.setProperty('--phone-fit-max', '1');
        return;
      }

      // Let layout settle (module builds DOM async sometimes)
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          const vw = viewport.clientWidth || 1;

          // Temporarily reset scale to measure true width
          document.documentElement.style.setProperty('--phone-fit-max', '1');

          requestAnimationFrame(() => {
            const contentW = inner.scrollWidth || inner.getBoundingClientRect().width || vw;
            let s = vw / Math.max(1, contentW);

            // Clamp scale so it's readable
            const min = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--phone-fit-min')) || 0.72;
            if(!isFinite(s) || s > 1) s = 1;
            if(s < min) s = min;

            document.documentElement.style.setProperty('--phone-fit-max', String(s));
          });
        });
      });
    }

    async function mountTile(tile){
      [...tiles.querySelectorAll('.tile')].forEach(t=>t.classList.remove('active'));
      tile.classList.add('active');

      const title = tile.getAttribute('data-title') || 'Planner';
      const modPath = tile.getAttribute('data-module') || '';

      hostTitle.textContent = title;
      hostModuleHint.textContent = modPath ? modPath.split('/').pop() : '(not set)';

      // unmount current
      try { if(current && typeof current.unmount === 'function') current.unmount(); } catch(e){ console.warn(e); }
      current = null;

      inner.innerHTML = modPath
        ? '<div class="hostEmpty">Loading‚Ä¶</div>'
        : '<div class="hostEmpty">Not wired yet.</div>';

      if(!modPath){
        fitPhoneWidth();
        return;
      }

      const mod = await import(modPath);
      if(!mod || typeof mod.mount !== 'function'){
        inner.innerHTML = '<div class="hostEmpty">Module missing mount(host, opts).</div>';
        fitPhoneWidth();
        return;
      }

      current = await mod.mount(inner, {
        // Keep your existing signal, but we also enforce phoneRead behavior here.
        viewOnly: window.matchMedia('(max-width: 980px)').matches
      });

      // After mount, fit it to phone width (only on phone)
      fitPhoneWidth();
    }

    tiles.addEventListener('click', (e)=>{
      const tile = e.target.closest('.tile');
      if(!tile) return;
      mountTile(tile);
    });

    // Re-fit on resize/orientation changes
    window.addEventListener('resize', () => fitPhoneWidth(), { passive:true });
    mqPhone.addEventListener?.('change', () => { applyPhoneClass(); fitPhoneWidth(); });

    // Init
    applyPhoneClass();
    wireViewOnlyGuards();

    // Mount default (first tile)
    mountTile(tiles.querySelector('.tile.active'));
  </script>
</body>
</html>
