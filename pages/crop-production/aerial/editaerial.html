<!-- =====================================================================
/Farm-vista/pages/crop-production/crop-aerial-view.html  (FULL FILE)
Rev: 2025-12-19d
Fixes per your list:
 1) Dropdown issue: crop/cropYear selects now sit ABOVE date-range popover
 2) Remove “Actions” label/row entirely
 3) Edit button sits FAR RIGHT on details row; in edit mode Save+Cancel replace it (far right)
 4) Where “Actions” was: show Trial info (Trial name) ONLY if fields are in trialLink.assignments
    then list which fields are in that trial.
 5) Add Delete button (red trash) beside Edit, with FV themed “type YES” modal,
    and disabled/greyed unless delete permission.

Also:
 • Summary tiles: NO status and NO status bubble (kept)
 • Details: no Updated row (kept)
 • Default load: last 50 jobs by jobNumber desc (kept)
===================================================================== -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista • Aerial Applications (View/Edit)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <script src="/Farm-vista/js/theme-boot.js"></script>

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <!-- Firebase config before firebase-init -->
  <script src="/Farm-vista/js/firebase-config.js"></script>

  <!-- Date range picker (non-module) -->
  <script src="/Farm-vista/js/fv-date-range-picker.js"></script>

  <style>
    :root{
      --card-max: 1200px;
      --page-bottom-gap: 96px;
      --accent: #2F6C3C;
      --danger: #C53030;
    }

    html{-webkit-text-size-adjust:100%}
    body{ background: var(--app-bg, var(--surface)); overflow-x:hidden; }

    .wrap{
      max-width: var(--card-max);
      margin: 0 auto;
      padding: clamp(14px,3vw,22px);
      padding-bottom: calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + var(--page-bottom-gap)) !important;
      box-sizing:border-box;
      display:grid;
      gap:12px;
    }

    .hero{
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));
      overflow:visible;
    }

    .hero-head{
      display:grid;
      grid-template-columns:36px 1fr;
      gap:12px;
      align-items:center;
      padding:14px 16px;
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);
      border-bottom:1px solid var(--border);
    }

    .hero-head .icon{
      width:24px;
      height:24px;
      color:var(--accent);
      display:grid;
      place-items:center;
    }

    .hero-head h1{
      margin:0;
      font-size:clamp(20px,3.2vw,26px);
      line-height:1.2;
    }

    .muted{ color:var(--muted,#67706B); }

    .body{ padding:16px; display:grid; gap:12px; }

    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }

    .toolbar-left{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }

    .toolbar-right{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      font-size:0.9rem;
      opacity:0.9;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:120px;
      padding:10px 14px;
      border-radius:12px;
      border:1px solid var(--border);
      font-weight:900;
      text-decoration:none;
      cursor:pointer;
      user-select:none;
      color:var(--text) !important;
      background:var(--card-surface,var(--surface));
      font-size:0.9rem;
      gap:6px;
      -webkit-appearance:none;
      appearance:none;
    }

    .btn-quiet{ min-width:auto; padding-inline:10px; }

    .btn-primary{
      background:var(--accent);
      border-color:var(--accent);
      color:#fff !important;
    }
    .btn-primary[disabled]{opacity:.6; cursor:not-allowed;}

    .input, .select{
      width:100%;
      font:inherit;
      font-size:16px;
      color:var(--text);
      background:var(--card-surface,var(--surface));
      border:1px solid var(--border);
      border-radius:10px;
      padding:10px 12px;
      outline:none;
      box-sizing:border-box;
      -webkit-appearance:none;
      appearance:none;
    }

    .select{
      background-image:
        linear-gradient(45deg, transparent 50%, var(--muted,#67706B) 50%),
        linear-gradient(135deg, var(--muted,#67706B) 50%, transparent 50%);
      background-position:
        calc(100% - 16px) 50%,
        calc(100% - 11px) 50%;
      background-size:5px 5px, 5px 5px;
      background-repeat:no-repeat;
    }

    /* Filters row */
    .filters-row{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:flex-end;
      margin-top:4px;
      position:relative;
      z-index:10;
    }

    /* FIX #1: ensure select wrappers always above calendar popover */
    .filter-wrap{
      display:flex;
      flex-direction:column;
      gap:3px;
      font-size:0.85rem;
      max-width:320px;
      position:relative;
      z-index:50; /* ✅ higher than calendar popover */
      flex:1 1 220px;
      min-width:220px;
    }

    .filter-label{
      font-size:0.78rem;
      text-transform:uppercase;
      letter-spacing:0.06em;
      opacity:0.7;
    }

    .filters-actions{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }

    /* List */
    .aerial-list{ display:flex; flex-direction:column; gap:10px; margin-top:4px; }

    .aerial-empty{
      padding:14px 16px;
      border-radius:12px;
      border:1px dashed var(--border);
      background:var(--card-surface, var(--surface));
      font-size:0.95rem;
      opacity:0.9;
    }

    .aerial-card{
      position:relative;
      border-radius:14px;
      border:1px solid var(--card-border, var(--border));
      background:var(--card-surface, var(--surface));
      box-shadow:var(--shadow-soft, var(--shadow));
      padding:12px 14px 10px;
      display:flex;
      flex-direction:column;
      gap:6px;
      transition:transform .06s, box-shadow .12s, border-color .12s, background .12s;
      cursor:pointer;
    }

    .aerial-card:active{ transform:scale(.995); box-shadow:var(--shadow); }

    .aerial-row-top{ display:flex; align-items:flex-start; gap:10px; }

    .aerial-main{ flex:1 1 auto; min-width:0; padding-right:12px; }

    .aerial-title{ font-weight:900; font-size:1.02rem; line-height:1.25; }

    .aerial-sub{ font-size:0.88rem; opacity:0.9; margin-top:2px; }

    .aerial-meta{
      font-size:0.8rem;
      opacity:0.9;
      margin-top:6px;
      display:flex;
      flex-wrap:wrap;
      gap:6px 10px;
    }

    .aerial-meta span{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 7px;
      border-radius:999px;
      background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
    }

    .aerial-meta-label{ font-weight:900; }
    .aerial-meta-value{ font-weight:900; }

    .aerial-bottom-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      font-size:0.78rem;
      opacity:0.8;
      margin-top:4px;
      flex-wrap:wrap;
    }

    /* Detail panel */
    .detail-panel{
      margin-top:10px;
      border-radius:14px;
      border:1px solid var(--card-border, var(--border));
      background:var(--card-surface, var(--surface));
      box-shadow:var(--shadow-soft, var(--shadow));
      padding:14px 16px 12px;
      display:none;
      flex-direction:column;
      gap:10px;
    }

    .detail-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }

    .detail-title-area{
      display:flex;
      flex-direction:column;
      gap:2px;
      flex:1 1 auto;
      min-width:0;
    }

    .detail-title{ font-weight:900; font-size:1.05rem; cursor:text; }

    .detail-title-input{
      display:none;
      font-size:1.05rem;
      font-weight:900;
      padding:4px 6px;
      border-radius:8px;
      border:1px solid var(--border);
      background:var(--surface-strong, var(--surface));
      color:var(--text);
      max-width:100%;
    }

    .detail-edit-hint{
      font-size:0.72rem;
      text-transform:uppercase;
      letter-spacing:0.08em;
      opacity:0.6;
    }

    .detail-close{
      border:none;
      outline:none;
      background:transparent;
      padding:0;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:28px;
      height:28px;
      border-radius:999px;
      color:var(--muted,#67706B);
      flex-shrink:0;
    }

    .detail-close:hover{
      background:color-mix(in srgb, var(--surface) 60%, var(--border) 40%);
      color:var(--text);
    }

    .detail-close svg{ width:16px; height:16px; display:block; }

    .visually-hidden{
      position:absolute;
      width:1px;
      height:1px;
      padding:0;
      margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      white-space:nowrap;
      border:0;
    }

    .detail-grid{
      display:grid;
      grid-template-columns:minmax(0,1fr);
      gap:8px 16px;
      font-size:0.92rem;
      margin-top:2px;
    }
    @media (min-width:700px){
      .detail-grid{ grid-template-columns:repeat(2, minmax(0,1fr)); }
    }

    .detail-item-label{
      font-size:0.8rem;
      text-transform:uppercase;
      letter-spacing:0.06em;
      opacity:0.7;
      margin-bottom:1px;
    }

    .detail-item-value{ font-size:0.94rem; }

    /* #3: right-side slot where Edit or Save/Cancel live */
    .detail-right-slot{
      display:flex;
      justify-content:flex-end;
      align-items:center;
      gap:8px;
      width:100%;
    }

    /* Smaller header-action buttons */
    #editBtn.edit-inline,
    #saveBtn.edit-inline,
    #cancelBtn.edit-inline{
      min-width:auto;
      padding:6px 10px;
      border-radius:10px;
      font-size:0.82rem;
      font-weight:900;
      white-space:nowrap;
    }

    .trash-btn{
      width:34px;
      height:34px;
      border-radius:999px;
      border:1px solid var(--danger);
      background:transparent;
      color:var(--danger);
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      -webkit-appearance:none;
      appearance:none;
    }
    .trash-btn svg{ width:16px; height:16px; display:block; fill: currentColor; }
    .trash-btn:hover{ background: rgba(197,48,48,0.08); }
    .trash-btn:disabled{
      opacity:.35;
      cursor:not-allowed;
      border-color: color-mix(in srgb, var(--border) 70%, var(--danger) 30%);
      color: color-mix(in srgb, var(--muted,#67706B) 75%, var(--danger) 25%);
      background:transparent;
    }
    .trash-btn:disabled:hover{ background:transparent; }

    .detail-notes{
      margin-top:2px;
      padding-top:10px;
      border-top:1px solid var(--border);
      font-size:0.92rem;
      white-space:pre-wrap;
    }
    .detail-notes-label{
      font-size:0.8rem;
      text-transform:uppercase;
      letter-spacing:0.06em;
      opacity:0.7;
      margin-bottom:2px;
    }

    .attachments{
      margin-top:2px;
      padding-top:10px;
      border-top:1px solid var(--border);
      font-size:0.9rem;
    }
    .attachments-label{
      font-size:0.8rem;
      text-transform:uppercase;
      letter-spacing:0.06em;
      opacity:0.7;
      margin-bottom:4px;
    }
    .attachments-grid{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .attachment-thumb{
      width:64px;
      height:64px;
      border-radius:10px;
      overflow:hidden;
      border:1px solid var(--border);
      background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:0.8rem;
      cursor:pointer;
      padding:0;
    }
    .attachment-thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .attachment-empty{ font-size:0.86rem; opacity:0.8; }

    .fields-block{
      margin-top:2px;
      padding-top:10px;
      border-top:1px solid var(--border);
      font-size:0.9rem;
    }
    .fields-label{
      font-size:0.8rem;
      text-transform:uppercase;
      letter-spacing:0.06em;
      opacity:0.7;
      margin-bottom:4px;
    }
    .fields-list{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .field-row{
      padding:6px 8px;
      border-radius:8px;
      background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
    }
    .field-name{ font-weight:900; font-size:0.92rem; }
    .field-meta{ font-size:0.82rem; opacity:0.85; margin-top:1px; }

    /* #4: Trial info block */
    .trial-block{
      margin-top:2px;
      padding-top:10px;
      border-top:1px solid var(--border);
      font-size:0.9rem;
    }
    .trial-label{
      font-size:0.8rem;
      text-transform:uppercase;
      letter-spacing:0.06em;
      opacity:0.7;
      margin-bottom:4px;
    }
    .trial-name{
      font-weight:900;
      font-size:0.98rem;
      margin-top:2px;
    }
    .trial-fields{
      display:flex;
      flex-direction:column;
      gap:4px;
      margin-top:6px;
    }
    .trial-field-line{
      padding:6px 8px;
      border-radius:8px;
      background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
      font-size:0.88rem;
      font-weight:800;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:calc(env(safe-area-inset-bottom,0px) + 72px);
      transform:translateX(-50%);
      background:#2F6C3C;
      color:#fff;
      padding:10px 14px;
      border-radius:10px;
      box-shadow:0 6px 20px rgba(0,0,0,.25);
      z-index:99999;
      display:none;
    }
    .toast.show{
      display:block;
      animation:fadeout 5s forwards;
    }
    @keyframes fadeout{
      0%{opacity:1}
      85%{opacity:1}
      100%{opacity:0}
    }

    /* Attachment viewer modal */
    .file-modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:100000;
    }
    .file-modal.show{ display:flex; }
    .file-backdrop{
      position:absolute;
      inset:0;
      background:rgba(0,0,0,.6);
    }
    .file-sheet{
      position:relative;
      max-width:90vw;
      max-height:90vh;
      background:var(--surface);
      border-radius:14px;
      border:1px solid var(--border);
      box-shadow:0 20px 40px rgba(0,0,0,.4);
      padding:8px 10px 10px;
      display:flex;
      flex-direction:column;
      gap:6px;
      z-index:1;
    }
    .file-close-row{ display:flex; justify-content:flex-end; margin-bottom:4px; }
    .file-close-btn{
      border:none;
      border-radius:999px;
      padding:4px 10px;
      font-size:0.85rem;
      cursor:pointer;
      background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
      color:var(--text);
      -webkit-appearance:none;
      appearance:none;
    }
    .file-content-wrap{
      border-radius:12px;
      overflow:hidden;
      background:#000;
      max-width:calc(90vw - 20px);
      max-height:calc(80vh - 40px);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .file-content-wrap img{ max-width:100%; max-height:100%; display:block; }
    .file-content-wrap iframe{
      border:0;
      width:calc(90vw - 20px);
      height:calc(80vh - 40px);
      background:#fff;
    }

    /* Date range picker popover styles */
    .cal-pop{
      position:absolute;
      top: calc(100% + 8px);
      left: 0;
      width: min(360px, 92vw);
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--surface);
      box-shadow:0 18px 38px rgba(0,0,0,.22);
      padding:10px 10px 10px;
      display:none;
      z-index:25; /* ✅ lower than filter-wrap z-index */
    }
    .cal-pop-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:8px;
    }
    .cal-pop-head .row{ display:flex; gap:8px; align-items:center; flex:1 1 auto; min-width:0; }
    .cal-pop select{
      flex:1 1 auto;
      min-width:0;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--card-surface,var(--surface));
      color:var(--text);
      font:inherit;
      font-size:14px;
    }
    .cal-close{
      width:32px;
      height:32px;
      border-radius:999px;
      border:1px solid var(--border);
      background:transparent;
      color:var(--text);
      cursor:pointer;
      display:grid;
      place-items:center;
    }
    .cal-close:hover{ background:color-mix(in srgb, var(--surface) 65%, var(--border) 35%); }

    .cal-dow{
      display:grid;
      grid-template-columns:repeat(7, 1fr);
      gap:6px;
      margin:6px 2px 6px;
      font-size:12px;
      opacity:.75;
      text-transform:uppercase;
      letter-spacing:.06em;
    }
    .cal-dow div{ text-align:center; }

    #calDays{
      display:grid;
      grid-template-columns:repeat(7, 1fr);
      gap:6px;
      padding:2px;
    }
    .cal-day{
      height:38px;
      border-radius:10px;
      border:1px solid color-mix(in srgb, var(--border) 65%, transparent);
      display:grid;
      place-items:center;
      cursor:pointer;
      user-select:none;
      background:color-mix(in srgb, var(--surface) 75%, var(--border) 25%);
      color:var(--text);
      font-weight:900;
      font-size:13px;
    }
    .cal-day.other-month{ opacity:.45; font-weight:800; }
    .cal-day:hover{ background:color-mix(in srgb, var(--surface) 60%, var(--border) 40%); }
    .cal-day.start-selected,
    .cal-day.range-start,
    .cal-day.range-end,
    .cal-day.single-day{
      background: var(--accent);
      border-color: var(--accent);
      color:#fff;
    }
    .cal-day.in-range{
      background: color-mix(in srgb, var(--accent) 18%, var(--surface) 82%);
      border-color: color-mix(in srgb, var(--accent) 40%, var(--border) 60%);
    }

    .cal-pop-foot{
      margin-top:10px;
      border-top:1px solid var(--border);
      padding-top:10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    #rangeSummary{ font-size:13px; opacity:.9; min-width:0; }
    .cal-btns{ display:flex; gap:8px; align-items:center; flex-shrink:0; }
    .cal-btn{
      min-width:auto;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--card-surface,var(--surface));
      color:var(--text);
      font-weight:900;
      cursor:pointer;
      -webkit-appearance:none;
      appearance:none;
    }
    .cal-btn.apply{
      background:var(--accent);
      border-color:var(--accent);
      color:#fff !important;
    }

    /* Delete modal */
    .modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:100001;
    }
    .modal.show{ display:flex; }
    .modal .backdrop{
      position:absolute;
      inset:0;
      background:rgba(0,0,0,.6);
    }
    .modal .sheet{
      position:relative;
      width:min(460px, 92vw);
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--surface);
      box-shadow:0 22px 46px rgba(0,0,0,.45);
      padding:10px 12px 12px;
      z-index:1;
    }
    .modal .head{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:6px;
    }
    .modal .title{
      font-weight:900;
      font-size:1.05rem;
      line-height:1.2;
      color:var(--danger);
    }
    .modal .hint{
      font-size:.92rem;
      line-height:1.35;
      color:var(--muted,#67706B);
    }
    .modal .row-actions{
      display:flex;
      justify-content:flex-end;
      gap:8px;
      margin-top:12px;
    }

    @media (max-width: 600px){
      .aerial-card{ padding:10px 12px; }
      .aerial-meta{ display:none; }
      .filter-wrap{ min-width: 180px; }
    }
  </style>

  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true;
        document.head.appendChild(s);
      }
    })();
  </script>

  <script type="module">
    import {
      ready,
      getFirestore,
      collection,
      getDocs,
      doc,
      getDoc,
      updateDoc,
      deleteDoc,
      query,
      orderBy,
      limit,
      where
    } from '/Farm-vista/js/firebase-init.js';

    import { NAV_MENU } from '/Farm-vista/js/menu.js';

    const CONFIG = {
      COLLECTION_AERIAL: 'aerialApplications',
      COLLECTION_TRIALS: 'fieldTrials',
      BACK_URL: '/Farm-vista/pages/crop-production/crop-aerial.html',
      DEFAULT_LIMIT: 50
    };

    const STORAGE_KEYS = {
      SEARCH: 'fv_aerialView_search',
      RANGE:  'fv_aerialView_rangeText',
      CROP:   'fv_aerialView_crop',
      YEAR:   'fv_aerialView_year'
    };

    const STATE = {
      db: null,
      loaded: false,
      isLoading: false,
      allItems: [],
      items: [],
      selectedId: null,
      search: '',
      fromYmd: '',
      toYmd: '',
      crop: 'all',
      cropYear: 'all',
      isEditing: false,
      isEditingTitle: false,
      trialCache: {} // trialId -> { trialName }
    };

    const UI = {
      editBtn: null,
      saveBtn: null,
      cancelBtn: null,
      trashBtn: null,
      canDelete: false
    };

    const $ = (sel, root=document) => root.querySelector(sel);

    async function safeReady(){
      if(typeof ready === 'function') return await ready();
      return await ready;
    }
    function sleep(ms){ return new Promise(r=>setTimeout(r, ms)); }

    async function withRetry(fn, label='op', tries=2){
      let lastErr = null;
      for(let i=1;i<=tries;i++){
        try{ return await fn(i); }
        catch(err){
          lastErr = err;
          console.warn('[AerialView]', `${label}.retry`, { attempt:i, code: err?.code, message: err?.message });
          await sleep(350 * i);
        }
      }
      throw lastErr;
    }

    async function getDocsServerFirst(ref){
      try{ return await getDocs(ref, { source: 'server' }); }
      catch{ return await getDocs(ref); }
    }

    function escapeHtml(str){
      if(str === null || str === undefined) return '';
      return String(str)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#39;');
    }

    function fmtNumber(value, decimals){
      const n = Number(value);
      if(!isFinite(n)) return null;
      return n.toFixed(decimals);
    }

    function isImageUrl(url){
      if(!url || typeof url !== 'string') return false;
      const u = url.split('?')[0].toLowerCase();
      return u.endsWith('.jpg') || u.endsWith('.jpeg') || u.endsWith('.png') ||
             u.endsWith('.gif') || u.endsWith('.webp') || u.endsWith('.heic');
    }

    function ymdFromDate(date){
      if(!(date instanceof Date) || isNaN(date.getTime())) return '';
      const y = date.getFullYear();
      const m = String(date.getMonth()+1).padStart(2,'0');
      const d = String(date.getDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    }

    function parseYmdToTime(ymd){
      if(!ymd || typeof ymd !== 'string') return 0;
      const m = /^(\d{4})-(\d{2})-(\d{2})$/.exec(ymd.trim());
      if(!m) return 0;
      const y = Number(m[1]), mo = Number(m[2])-1, d = Number(m[3]);
      return new Date(y, mo, d, 12, 0, 0, 0).getTime();
    }

    function getReleaseTime(d){
      return parseYmdToTime(d?.releaseDate || '') || 0;
    }

    function getFallbackTime(d){
      const ts = d?.updatedAt || d?.createdAt || null;
      try{
        if(ts?.toMillis) return ts.toMillis();
        if(ts?.toDate) return ts.toDate().getTime();
      }catch{}
      const t = Number(d?.t);
      if(isFinite(t) && t > 0) return t;
      const iso = d?.timestampISO;
      if(iso) return new Date(iso).getTime() || 0;
      return 0;
    }

    function buildSearchBlob(d){
      const job = d?.jobNumber != null ? String(d.jobNumber) : '';
      const crop = d?.crop || '';
      const year = d?.cropYear != null ? String(d.cropYear) : (d?.year != null ? String(d.year) : '');
      const farm = d?.farm || '';
      const fieldsArr = Array.isArray(d?.fields) ? d.fields : [];
      const fieldNames = fieldsArr.map(f => `${f?.farm || ''} ${f?.field || ''}`.trim()).join(' ');
      return `${job} ${crop} ${year} ${farm} ${fieldNames}`.toLowerCase();
    }

    function showToast(message){
      const el = document.getElementById('toast');
      if(!el) return;
      el.textContent = message || 'Saved.';
      el.classList.remove('show');
      void el.offsetWidth;
      el.classList.add('show');
    }

    // Prefs
    function loadPrefs(){
      try{
        STATE.search = (localStorage.getItem(STORAGE_KEYS.SEARCH) || '').toString();
        STATE.crop = (localStorage.getItem(STORAGE_KEYS.CROP) || 'all').toString();
        STATE.cropYear = (localStorage.getItem(STORAGE_KEYS.YEAR) || 'all').toString();

        const rangeText = (localStorage.getItem(STORAGE_KEYS.RANGE) || '').toString();
        const jobInput = document.getElementById('jobRangeInput');
        if(jobInput) jobInput.value = rangeText;

        deriveRangeFromPickerText();
      }catch{
        STATE.search = '';
        STATE.crop = 'all';
        STATE.cropYear = 'all';
      }
    }

    function savePrefs(){
      try{
        localStorage.setItem(STORAGE_KEYS.SEARCH, STATE.search || '');
        localStorage.setItem(STORAGE_KEYS.CROP, STATE.crop || 'all');
        localStorage.setItem(STORAGE_KEYS.YEAR, STATE.cropYear || 'all');
        const jobInput = document.getElementById('jobRangeInput');
        localStorage.setItem(STORAGE_KEYS.RANGE, (jobInput?.value || '').toString());
      }catch{}
    }

    // Date picker integration
    function parseLooseDate(str){
      const d = new Date(str);
      if(isNaN(d.getTime())) return null;
      return d;
    }

    function deriveRangeFromPickerText(){
      const jobInput = document.getElementById('jobRangeInput');
      if(!jobInput) return;

      const raw = (jobInput.value || '').trim();
      if(!raw){
        STATE.fromYmd = '';
        STATE.toYmd = '';
        return;
      }

      if(raw.includes('–')){
        const parts = raw.split('–').map(s=>s.trim());
        const a = parseLooseDate(parts[0]);
        const b = parseLooseDate(parts[1]);
        STATE.fromYmd = a ? ymdFromDate(a) : '';
        STATE.toYmd = b ? ymdFromDate(b) : '';
      }else if(raw.toLowerCase().startsWith('start:')){
        const s = raw.replace(/^\s*start:\s*/i,'').trim();
        const a = parseLooseDate(s);
        STATE.fromYmd = a ? ymdFromDate(a) : '';
        STATE.toYmd = '';
      }else{
        const a = parseLooseDate(raw);
        STATE.fromYmd = a ? ymdFromDate(a) : '';
        STATE.toYmd = '';
      }
    }

    function hasServerFilters(){
      return !!(
        (STATE.fromYmd && (STATE.toYmd || !STATE.toYmd)) ||
        (STATE.crop && STATE.crop !== 'all') ||
        (STATE.cropYear && STATE.cropYear !== 'all')
      );
    }

    function wireDateRangePickerEvents(){
      const applyBtn = document.getElementById('applyRangeBtn');
      const clearBtn = document.getElementById('clearRangeBtn');

      const afterChange = async () => {
        deriveRangeFromPickerText();
        savePrefs();
        await loadAll();
      };

      if(applyBtn) applyBtn.addEventListener('click', () => setTimeout(afterChange, 0));
      if(clearBtn) clearBtn.addEventListener('click', () => setTimeout(afterChange, 0));
    }

    // Sorting
    function sortItems(items){
      items.sort((a,b)=>{
        const ra = getReleaseTime(a.data) || getFallbackTime(a.data);
        const rb = getReleaseTime(b.data) || getFallbackTime(b.data);
        if(ra !== rb) return rb - ra;
        const ja = Number(a.data?.jobNumber) || 0;
        const jb = Number(b.data?.jobNumber) || 0;
        if(ja !== jb) return jb - ja;
        return getFallbackTime(b.data) - getFallbackTime(a.data);
      });
      return items;
    }

    // Trial cache
    async function fetchTrialName(trialId){
      if(!trialId) return '';
      if(STATE.trialCache[trialId]?.trialName) return STATE.trialCache[trialId].trialName;
      try{
        const snap = await getDoc(doc(STATE.db, CONFIG.COLLECTION_TRIALS, trialId));
        const d = snap.exists() ? (snap.data() || {}) : {};
        const name = (d.trialName || 'Field Trial').toString();
        STATE.trialCache[trialId] = { trialName: name };
        return name;
      }catch(err){
        console.warn('Trial name lookup failed', trialId, err);
        STATE.trialCache[trialId] = { trialName: '' };
        return '';
      }
    }

    // Server load:
    // default: last 50 jobNumber desc
    // filtered: up to 1000 results (range/crop/year)
    async function loadAll(){
      const db = STATE.db;
      if(!db || STATE.isLoading) return;
      STATE.isLoading = true;

      const emptyEl = document.getElementById('listEmpty');
      const countEl = document.getElementById('listCount');
      const listEl = document.getElementById('list');

      if(listEl && !STATE.allItems.length) listEl.innerHTML = '';
      if(emptyEl){
        emptyEl.style.display = 'block';
        emptyEl.textContent = STATE.allItems.length ? 'Refreshing jobs…' : 'Loading jobs…';
      }
      if(countEl) countEl.textContent = 'Loading…';

      try{
        const colRef = collection(db, CONFIG.COLLECTION_AERIAL);

        let qRef;

        if(!hasServerFilters()){
          qRef = query(colRef, orderBy('jobNumber','desc'), limit(CONFIG.DEFAULT_LIMIT));
        }else{
          const clauses = [];

          if(STATE.crop && STATE.crop !== 'all'){
            clauses.push(where('crop','==', STATE.crop));
          }

          if(STATE.cropYear && STATE.cropYear !== 'all'){
            const y = Number(STATE.cropYear);
            if(isFinite(y)) clauses.push(where('cropYear','==', y));
          }

          if(STATE.fromYmd && STATE.toYmd){
            clauses.push(where('releaseDate','>=', STATE.fromYmd));
            clauses.push(where('releaseDate','<=', STATE.toYmd));
            qRef = query(colRef, ...clauses, orderBy('releaseDate','desc'), limit(1000));
          }else if(STATE.fromYmd && !STATE.toYmd){
            clauses.push(where('releaseDate','>=', STATE.fromYmd));
            qRef = query(colRef, ...clauses, orderBy('releaseDate','desc'), limit(1000));
          }else{
            qRef = query(colRef, ...clauses, orderBy('jobNumber','desc'), limit(1000));
          }
        }

        const snap = await withRetry(async ()=> await getDocsServerFirst(qRef), 'loadAll', 2);

        const items = snap.docs.map(s=>{
          const data = s.data() || {};
          return { id: s.id, data, searchBlob: buildSearchBlob(data) };
        });

        sortItems(items);
        STATE.allItems = items;
        STATE.loaded = true;

        applyFilters();
      }catch(err){
        console.error('Error loading jobs:', err);
        if(emptyEl){
          emptyEl.style.display = 'block';
          emptyEl.textContent = 'Error loading jobs. Tap to retry.';
        }
        if(countEl) countEl.textContent = 'Error';
        clearDetails();
      }finally{
        STATE.isLoading = false;
      }
    }

    // In-memory filter (search only)
    function applyFilters(){
      const emptyEl = document.getElementById('listEmpty');
      const countEl = document.getElementById('listCount');

      if(!STATE.loaded){
        if(emptyEl){ emptyEl.style.display = 'block'; emptyEl.textContent = 'Loading jobs…'; }
        if(countEl) countEl.textContent = 'Loading…';
        clearDetails();
        return;
      }

      const q = (STATE.search || '').trim().toLowerCase();
      let filtered = STATE.allItems.slice();

      if(q){
        filtered = filtered.filter(it => (it.searchBlob || '').includes(q));
      }

      STATE.items = filtered;
      clearDetails();
      renderList();
    }

    // List render (no status)
    function renderList(){
      const listEl = document.getElementById('list');
      const emptyEl = document.getElementById('listEmpty');
      const countEl = document.getElementById('listCount');
      if(!listEl) return;

      listEl.innerHTML = '';

      const usingFilters = !!((STATE.search||'').trim() || hasServerFilters());

      if(!STATE.items.length){
        if(emptyEl){
          emptyEl.style.display = 'block';
          emptyEl.textContent = usingFilters ? 'No jobs match your filters.' : 'No jobs yet.';
        }
        if(countEl) countEl.textContent = '0 jobs';
        clearDetails();
        return;
      }

      if(emptyEl) emptyEl.style.display = 'none';

      for(const item of STATE.items){
        const d = item.data || {};
        const id = item.id;

        const job = d.jobNumber != null ? d.jobNumber : '—';
        const cropYear = d.cropYear ?? d.year ?? null;
        const crop = d.crop || '';
        const releaseDate = d.releaseDate || '';
        const releaseAcres = Number(d.releaseAcres);
        const totalTill = Number(d.totalTillableAcres);

        const submittedBy = d.submittedBy || d.submittedByEmail || '';
        const fields = Array.isArray(d.fields) ? d.fields : [];
        const fieldCount = fields.length;

        const acresLineParts = [];
        if(isFinite(releaseAcres)) acresLineParts.push(`${fmtNumber(releaseAcres, 1)} ac released`);
        if(isFinite(totalTill)) acresLineParts.push(`${fmtNumber(totalTill, 1)} ac total`);
        const acresLine = acresLineParts.join(' • ');

        const subtitleParts = [];
        if(cropYear != null) subtitleParts.push(String(cropYear));
        if(crop) subtitleParts.push(crop);
        if(releaseDate) subtitleParts.push(`Release ${releaseDate}`);
        const subtitle = subtitleParts.join(' • ');

        const card = document.createElement('article');
        card.className = 'aerial-card';
        card.dataset.id = id;

        card.innerHTML = `
          <div class="aerial-row-top">
            <div class="aerial-main">
              <div class="aerial-title">Job #${escapeHtml(job)}</div>
              <div class="aerial-sub">${escapeHtml(subtitle)}</div>

              <div class="aerial-meta">
                <span><span class="aerial-meta-label">Fields</span> <span class="aerial-meta-value">${fieldCount}</span></span>
                ${acresLine ? `<span><span class="aerial-meta-label">Acres</span> <span class="aerial-meta-value">${escapeHtml(acresLine)}</span></span>` : ''}
                ${submittedBy ? `<span><span class="aerial-meta-label">By</span> <span class="aerial-meta-value">${escapeHtml(submittedBy)}</span></span>` : ''}
              </div>
            </div>
          </div>

          <div class="aerial-bottom-row">
            <div>${releaseDate ? `Release ${escapeHtml(releaseDate)}` : ''}</div>
          </div>
        `;

        card.addEventListener('click', () => {
          STATE.selectedId = id;
          STATE.isEditing = false;
          renderDetails();
        });

        listEl.appendChild(card);
      }

      if(countEl){
        const total = STATE.items.length;
        countEl.textContent = usingFilters
          ? `${total} filtered job${total === 1 ? '' : 's'}`
          : `${total} job${total === 1 ? '' : 's'}`;
      }
    }

    // Details helpers
    function clearDetails(){
      const panel = document.getElementById('detailPanel');
      if(!panel) return;
      panel.style.display = 'none';
      panel.dataset.id = '';

      const titleText = document.getElementById('detailTitleText');
      const titleInput = document.getElementById('detailTitleInput');
      if(titleText){
        titleText.textContent = 'Aerial Job Details';
        titleText.style.display = 'block';
      }
      if(titleInput){
        titleInput.value = '';
        titleInput.style.display = 'none';
      }

      STATE.isEditing = false;
      STATE.isEditingTitle = false;

      const grid = document.getElementById('detailGrid');
      if(grid) grid.innerHTML = '';

      const notesBody = document.getElementById('detailNotesBody');
      if(notesBody) notesBody.textContent = '';

      const attGrid = document.getElementById('detailAttachments');
      if(attGrid) attGrid.innerHTML = '';

      const fieldsList = document.getElementById('detailFieldsList');
      if(fieldsList) fieldsList.innerHTML = '';

      const trialBox = document.getElementById('trialBox');
      if(trialBox) trialBox.innerHTML = '';

      resetButtonsForViewMode();
    }

    function resetButtonsForViewMode(){
      STATE.isEditing = false;

      if(UI.editBtn){
        UI.editBtn.style.display = STATE.selectedId ? 'inline-flex' : 'none';
        UI.editBtn.disabled = !STATE.selectedId;
        UI.editBtn.classList.remove('edit-inline');
      }
      if(UI.saveBtn){
        UI.saveBtn.style.display = 'none';
        UI.saveBtn.disabled = false;
        UI.saveBtn.textContent = 'Save';
        UI.saveBtn.classList.remove('edit-inline');
      }
      if(UI.cancelBtn){
        UI.cancelBtn.style.display = 'none';
        UI.cancelBtn.disabled = false;
        UI.cancelBtn.classList.remove('edit-inline');
      }

      if(UI.trashBtn){
        UI.trashBtn.disabled = !(UI.canDelete && STATE.selectedId);
        UI.trashBtn.style.display = (STATE.selectedId ? 'inline-flex' : 'none');
      }
    }

    function setTitleView(title){
      const textEl  = document.getElementById('detailTitleText');
      const inputEl = document.getElementById('detailTitleInput');
      if(!textEl || !inputEl) return;
      STATE.isEditingTitle = false;
      textEl.textContent = title || 'Aerial Job';
      textEl.style.display = 'block';
      inputEl.style.display = 'none';
    }

    function beginEditTitle(){
      if(!STATE.selectedId || !STATE.db) return;
      if(STATE.isEditing) return;
      const textEl  = document.getElementById('detailTitleText');
      const inputEl = document.getElementById('detailTitleInput');
      if(!textEl || !inputEl) return;

      STATE.isEditingTitle = true;
      inputEl.value = (textEl.textContent || '').trim();
      textEl.style.display = 'none';
      inputEl.style.display = 'inline-block';
      inputEl.focus();
      inputEl.select();
    }

    function cancelEditTitle(){
      const id = STATE.selectedId;
      const item = STATE.items.find(x => x.id === id);
      const job = item?.data?.jobNumber != null ? item.data.jobNumber : '';
      setTitleView(job ? `Job #${job}` : 'Aerial Job');
    }

    async function commitEditTitle(){
      const id = STATE.selectedId;
      const db = STATE.db;
      if(!id || !db){ cancelEditTitle(); return; }

      const inputEl = document.getElementById('detailTitleInput');
      if(!inputEl){ cancelEditTitle(); return; }

      const raw = (inputEl.value || '').trim();
      const m = raw.match(/(\d+)/);
      const jobNum = m ? Number(m[1]) : NaN;

      const itemAll = STATE.allItems.find(x => x.id === id);
      const old = Number(itemAll?.data?.jobNumber);

      if(!isFinite(jobNum) || jobNum <= 0){
        showToast('Enter a valid job number.');
        cancelEditTitle();
        return;
      }
      if(isFinite(old) && old === jobNum){
        setTitleView(`Job #${jobNum}`);
        return;
      }

      inputEl.disabled = true;
      try{
        await updateDoc(doc(db, CONFIG.COLLECTION_AERIAL, id), { jobNumber: jobNum });

        const itemAll2 = STATE.allItems.find(x => x.id === id);
        const itemFiltered = STATE.items.find(x => x.id === id);
        [itemAll2, itemFiltered].filter(Boolean).forEach(t => {
          t.data.jobNumber = jobNum;
          t.searchBlob = buildSearchBlob(t.data);
        });

        setTitleView(`Job #${jobNum}`);
        showToast('Job number updated.');
        applyFilters();
        STATE.selectedId = id;
        renderDetails();
      }catch(err){
        console.error('Error updating job number:', err);
        showToast('Error updating job number.');
        cancelEditTitle();
      }finally{
        inputEl.disabled = false;
      }
    }

    function renderFieldsList(d){
      const listEl = document.getElementById('detailFieldsList');
      if(!listEl) return;
      listEl.innerHTML = '';

      const fields = Array.isArray(d.fields) ? d.fields : [];
      if(!fields.length){
        const empty = document.createElement('div');
        empty.className = 'attachment-empty';
        empty.textContent = 'No fields attached.';
        listEl.appendChild(empty);
        return;
      }

      fields.forEach(f=>{
        const row = document.createElement('div');
        row.className = 'field-row';

        const farm = f?.farm || '';
        const field = f?.field || '';
        const till = Number(f?.tillableAcres);

        row.innerHTML = `
          <div class="field-name">${escapeHtml(farm)}${farm && field ? ' • ' : ''}${escapeHtml(field)}</div>
          <div class="field-meta">${isFinite(till) ? `${fmtNumber(till, 2)} ac tillable` : ''}</div>
        `;
        listEl.appendChild(row);
      });
    }

    async function renderTrialInfo(d){
      const trialBox = document.getElementById('trialBox');
      if(!trialBox) return;
      trialBox.innerHTML = '';

      const tl = d.trialLink || null;
      const enabled = !!tl?.enabled;
      const trialId = tl?.trialId || '';
      const assignments = Array.isArray(tl?.assignments) ? tl.assignments : [];

      if(!enabled || !trialId || !assignments.length){
        return;
      }

      const jobFields = Array.isArray(d.fields) ? d.fields : [];
      const fieldNameById = new Map(jobFields.map(f => [
        f.fieldId,
        `${f.farm || ''}${f.farm && f.field ? ' • ' : ''}${f.field || ''}`.trim()
      ]));

      const assignedNames = assignments
        .map(a => {
          const id = a?.fieldId || '';
          return fieldNameById.get(id) || id || '';
        })
        .filter(Boolean);

      const name = await fetchTrialName(trialId);

      const block = document.createElement('div');
      block.className = 'trial-block';
      block.innerHTML = `
        <div class="trial-label">Trial</div>
        <div class="trial-name">${escapeHtml(name || 'Field Trial')}</div>
        <div class="trial-label" style="margin-top:10px;">Fields in this trial</div>
        <div class="trial-fields" id="trialFieldsListInner"></div>
      `;
      trialBox.appendChild(block);

      const inner = block.querySelector('#trialFieldsListInner');
      if(inner){
        if(!assignedNames.length){
          inner.innerHTML = '<div class="attachment-empty">No fields assigned.</div>';
        }else{
          assignedNames.forEach(n=>{
            const line = document.createElement('div');
            line.className = 'trial-field-line';
            line.textContent = n;
            inner.appendChild(line);
          });
        }
      }
    }

    // Attachments
    let fileModal, fileBackdrop, fileCloseBtn, fileContentWrap;

    function openFileViewer(att){
      if(!fileModal || !fileContentWrap || !att || !att.url) return;
      fileContentWrap.innerHTML = '';
      if(isImageUrl(att.url)){
        const img = document.createElement('img');
        img.src = att.url;
        img.alt = att.name || 'Attachment';
        fileContentWrap.appendChild(img);
      }else{
        const iframe = document.createElement('iframe');
        iframe.src = att.url;
        fileContentWrap.appendChild(iframe);
      }
      fileModal.classList.add('show');
      document.body.style.overflow = 'hidden';
    }

    function closeFileViewer(){
      if(!fileModal) return;
      fileModal.classList.remove('show');
      if(fileContentWrap) fileContentWrap.innerHTML = '';
      document.body.style.overflow = '';
    }

    function renderAttachments(d){
      const grid = document.getElementById('detailAttachments');
      if(!grid) return;
      grid.innerHTML = '';

      const files = Array.isArray(d.files) ? d.files : [];
      if(!files.length){
        const empty = document.createElement('div');
        empty.className = 'attachment-empty';
        empty.textContent = 'No files or photos attached.';
        grid.appendChild(empty);
        return;
      }

      files.forEach(raw=>{
        if(!raw || !raw.url) return;
        const att = { url: raw.url, name: raw.name || raw.path || 'Attachment' };

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'attachment-thumb';
        btn.title = att.name;

        if(isImageUrl(att.url)){
          const img = document.createElement('img');
          img.src = att.url;
          img.alt = att.name;
          btn.appendChild(img);
        }else{
          btn.textContent = 'FILE';
        }

        btn.addEventListener('click', (ev)=>{
          ev.stopPropagation();
          openFileViewer(att);
        });

        grid.appendChild(btn);
      });
    }

    // #3: Build right-slot controls (Edit or Save/Cancel) + Delete
    function slotControls(mode){
      const slot = document.getElementById('detailRightSlot');
      if(!slot) return;
      slot.innerHTML = '';

      if(mode === 'edit'){
        if(UI.saveBtn){
          UI.saveBtn.classList.add('edit-inline');
          UI.saveBtn.style.display = 'inline-flex';
          slot.appendChild(UI.saveBtn);
        }
        if(UI.cancelBtn){
          UI.cancelBtn.classList.add('edit-inline');
          UI.cancelBtn.style.display = 'inline-flex';
          slot.appendChild(UI.cancelBtn);
        }
      }else{
        if(UI.editBtn){
          UI.editBtn.classList.add('edit-inline');
          UI.editBtn.style.display = 'inline-flex';
          slot.appendChild(UI.editBtn);
        }
      }

      if(UI.trashBtn){
        UI.trashBtn.style.display = 'inline-flex';
        UI.trashBtn.disabled = !(UI.canDelete && STATE.selectedId && !STATE.isEditing);
        slot.appendChild(UI.trashBtn);
      }
    }

    // Render details (NO Actions label; right slot controls; trial info in grid spot)
    async function renderDetails(){
      const panel = document.getElementById('detailPanel');
      if(!panel) return;

      const item = STATE.items.find(x => x.id === STATE.selectedId);
      if(!item){ clearDetails(); return; }

      const d = item.data || {};
      panel.dataset.id = item.id;

      const job = d.jobNumber != null ? d.jobNumber : '';
      setTitleView(job ? `Job #${job}` : 'Aerial Job');

      const cropYear = d.cropYear ?? d.year ?? null;
      const crop = d.crop || '';
      const releaseDate = d.releaseDate || '';
      const releaseAcres = d.releaseAcres;
      const totalTill = d.totalTillableAcres;
      const submittedBy = d.submittedBy || d.submittedByEmail || '';
      const notes = d.notes || '';
      const createdAt = d.createdAt?.toDate ? d.createdAt.toDate() : (d.createdAt ? new Date(d.createdAt) : null);

      // Trial (only if fields assigned)
      const tl = d.trialLink || null;
      const showTrial = !!(tl?.enabled && tl?.trialId && Array.isArray(tl?.assignments) && tl.assignments.length);

      let trialName = '';
      let trialFieldNames = [];
      if(showTrial){
        trialName = await fetchTrialName(tl.trialId);

        const jobFields = Array.isArray(d.fields) ? d.fields : [];
        const fieldNameById = new Map(jobFields.map(f => [
          f.fieldId,
          `${f.farm || ''}${f.farm && f.field ? ' • ' : ''}${f.field || ''}`.trim()
        ]));

        trialFieldNames = tl.assignments
          .map(a => fieldNameById.get(a?.fieldId) || a?.fieldId || '')
          .filter(Boolean);
      }

      const grid = document.getElementById('detailGrid');
      if(grid){
        let html = '';

        html += `
          <div>
            <div class="detail-item-label">Crop Year / Crop</div>
            <div class="detail-item-value">${cropYear != null ? escapeHtml(cropYear) : ''}${cropYear && crop ? ' • ' : ''}${escapeHtml(crop)}</div>
          </div>
        `;

        html += `
          <div>
            <div class="detail-item-label">Release Date</div>
            <div class="detail-item-value">${escapeHtml(releaseDate || '—')}</div>
          </div>
        `;

        html += `
          <div>
            <div class="detail-item-label">Release Acres</div>
            <div class="detail-item-value">${isFinite(Number(releaseAcres)) ? escapeHtml(fmtNumber(releaseAcres, 2)) + ' ac' : '—'}</div>
          </div>
        `;

        html += `
          <div>
            <div class="detail-item-label">Total Tillable Acres</div>
            <div class="detail-item-value">${isFinite(Number(totalTill)) ? escapeHtml(fmtNumber(totalTill, 2)) + ' ac' : '—'}</div>
          </div>
        `;

        html += `
          <div>
            <div class="detail-item-label">Submitted By</div>
            <div class="detail-item-value">${escapeHtml(submittedBy || '—')}</div>
          </div>
        `;

        if(createdAt){
          html += `
            <div>
              <div class="detail-item-label">Created</div>
              <div class="detail-item-value">${createdAt.toLocaleString()}</div>
            </div>
          `;
        }

        // #4: where “Actions” was -> Trial info (only when needed)
        if(showTrial){
          html += `
            <div>
              <div class="detail-item-label">Trial</div>
              <div class="detail-item-value">
                <div style="font-weight:900">${escapeHtml(trialName || 'Field Trial')}</div>
                <div style="margin-top:6px;font-size:.82rem;opacity:.8;text-transform:uppercase;letter-spacing:.06em;">Fields in this trial</div>
                <div style="margin-top:6px;display:flex;flex-direction:column;gap:4px">
                  ${trialFieldNames.map(n => `<div class="trial-field-line">${escapeHtml(n)}</div>`).join('')}
                </div>
              </div>
            </div>
          `;
        }

        // #3: Right slot control column (Edit or Save/Cancel + Delete)
        html += `
          <div>
            <div class="detail-item-label"> </div>
            <div class="detail-item-value">
              <div id="detailRightSlot" class="detail-right-slot"></div>
            </div>
          </div>
        `;

        grid.innerHTML = html;
      }

      const notesBody = document.getElementById('detailNotesBody');
      if(notesBody) notesBody.textContent = notes || 'No notes recorded.';

      renderAttachments(d);
      renderFieldsList(d);

      // we now render trial inside grid (so keep this empty)
      const trialBox = document.getElementById('trialBox');
      if(trialBox) trialBox.innerHTML = '';

      resetButtonsForViewMode();
      panel.style.display = 'flex';

      // Slot view mode controls
      slotControls('view');
    }

    // Enter edit mode (right slot becomes Save/Cancel)
    function enterEdit(){
      const id = STATE.selectedId;
      if(!id || !STATE.db) return;

      const item = STATE.items.find(x => x.id === id);
      if(!item) return;

      const d = item.data || {};
      STATE.isEditing = true;

      const grid = document.getElementById('detailGrid');
      if(!grid) return;

      const cropYear = d.cropYear ?? d.year ?? '';
      const crop = d.crop || '';
      const releaseDate = d.releaseDate || '';
      const releaseAcres = d.releaseAcres ?? '';
      const notes = d.notes || '';

      const thisYear = new Date().getFullYear();
      const baseYears = [thisYear - 1, thisYear, thisYear + 1, thisYear + 2];
      const baseCrops = ['Corn','Soybeans','Wheat'];

      const yearList = Array.from(new Set([...baseYears, cropYear].filter(v=>v!=='' && v!=null)))
        .sort((a,b)=>Number(a)-Number(b));

      const cropList = Array.from(new Set([...baseCrops, crop].filter(v=>String(v||'').trim()!=='')))
        .sort((a,b)=>String(a).localeCompare(String(b)));

      // Keep the grid order similar; replace editable fields only
      // (Trial info stays as-is in renderDetails; we don’t rebuild it here)
      grid.innerHTML = `
        <div>
          <div class="detail-item-label">Crop Year</div>
          <select id="editCropYear" class="select">
            <option value=""></option>
            ${yearList.map(y=>{
              const val = String(y);
              const sel = String(cropYear)===val ? ' selected' : '';
              return `<option value="${escapeHtml(val)}"${sel}>${escapeHtml(val)}</option>`;
            }).join('')}
          </select>
        </div>

        <div>
          <div class="detail-item-label">Crop</div>
          <select id="editCrop" class="select">
            <option value=""></option>
            ${cropList.map(c=>{
              const val = String(c);
              const sel = String(crop)===val ? ' selected' : '';
              return `<option value="${escapeHtml(val)}"${sel}>${escapeHtml(val)}</option>`;
            }).join('')}
          </select>
        </div>

        <div>
          <div class="detail-item-label">Release Date</div>
          <input id="editReleaseDate" type="text" class="input" value="${escapeHtml(releaseDate)}" placeholder="YYYY-MM-DD"/>
        </div>

        <div>
          <div class="detail-item-label">Release Acres</div>
          <input id="editReleaseAcres" type="number" step="0.01" class="input" value="${escapeHtml(releaseAcres)}" placeholder="0.00"/>
        </div>

        <div>
          <div class="detail-item-label">Notes</div>
          <div class="detail-item-value">Use the Notes box below</div>
        </div>

        <div>
          <div class="detail-item-label"> </div>
          <div class="detail-item-value">
            <div id="detailRightSlot" class="detail-right-slot"></div>
          </div>
        </div>
      `;

      const notesBody = document.getElementById('detailNotesBody');
      if(notesBody){
        notesBody.innerHTML = '';
        const ta = document.createElement('textarea');
        ta.id = 'editNotes';
        ta.className = 'input';
        ta.style.minHeight = '90px';
        ta.style.resize = 'vertical';
        ta.value = notes;
        notesBody.appendChild(ta);
      }

      // Slot edit mode controls
      slotControls('edit');
    }

    async function saveEdit(){
      const id = STATE.selectedId;
      const db = STATE.db;
      if(!id || !db) return;

      const cropYearEl = document.getElementById('editCropYear');
      const cropEl = document.getElementById('editCrop');
      const releaseDateEl = document.getElementById('editReleaseDate');
      const releaseAcresEl = document.getElementById('editReleaseAcres');
      const notesEl = document.getElementById('editNotes');

      if(!cropYearEl || !cropEl || !releaseDateEl || !releaseAcresEl || !notesEl){
        STATE.isEditing = false;
        renderDetails();
        return;
      }

      if(UI.saveBtn){
        UI.saveBtn.disabled = true;
        UI.saveBtn.textContent = 'Saving...';
      }
      if(UI.cancelBtn) UI.cancelBtn.disabled = true;

      const cropYearRaw = (cropYearEl.value || '').trim();
      const cropRaw = (cropEl.value || '').trim();
      const releaseDateRaw = (releaseDateEl.value || '').trim();
      const releaseAcresRaw = (releaseAcresEl.value || '').trim();
      const notesRaw = notesEl.value || '';

      const updates = {};

      if(cropYearRaw){
        const n = Number(cropYearRaw);
        updates.cropYear = isFinite(n) ? n : null;
        updates.year = isFinite(n) ? n : null;
      }else{
        updates.cropYear = null;
        updates.year = null;
      }

      updates.crop = cropRaw || '';
      updates.releaseDate = releaseDateRaw || '';

      if(releaseAcresRaw === ''){
        updates.releaseAcres = null;
      }else{
        const n = Number(releaseAcresRaw);
        updates.releaseAcres = isFinite(n) ? n : null;
      }

      updates.notes = notesRaw;

      try{
        await updateDoc(doc(db, CONFIG.COLLECTION_AERIAL, id), updates);

        const itemAll = STATE.allItems.find(x => x.id === id);
        const itemFiltered = STATE.items.find(x => x.id === id);
        [itemAll, itemFiltered].filter(Boolean).forEach(t=>{
          t.data.cropYear = updates.cropYear;
          t.data.year = updates.year;
          t.data.crop = updates.crop;
          t.data.releaseDate = updates.releaseDate;
          t.data.releaseAcres = updates.releaseAcres;
          t.data.notes = updates.notes;
          t.searchBlob = buildSearchBlob(t.data);
        });

        STATE.isEditing = false;
        showToast('Job updated.');
        applyFilters();
        STATE.selectedId = id;
        await renderDetails();
      }catch(err){
        console.error('Error saving job:', err);
        showToast('Error saving job.');
        STATE.isEditing = false;
        await renderDetails();
      }finally{
        if(UI.saveBtn){
          UI.saveBtn.disabled = false;
          UI.saveBtn.textContent = 'Save';
        }
        if(UI.cancelBtn) UI.cancelBtn.disabled = false;
      }
    }

    async function cancelEdit(){
      STATE.isEditing = false;
      await renderDetails();
    }

    // Delete permission
    function computeDeletePermission(){
      try{
        if(window.FV && typeof window.FV.can === 'function'){
          return !!window.FV.can('crop-aerial:delete');
        }
      }catch{}
      return false;
    }

    // Delete modal
    function openDeleteModal(){
      if(!UI.canDelete || !STATE.selectedId) return;

      const modal = document.getElementById('deleteModal');
      const inputEl = document.getElementById('deleteConfirmInput');
      const confirmBtn = document.getElementById('deleteConfirmBtn');
      const cancelBtn = document.getElementById('deleteCancelBtn');
      const backdrop = document.getElementById('deleteBackdrop');

      if(!modal || !inputEl || !confirmBtn || !cancelBtn) return;

      inputEl.value = '';
      confirmBtn.disabled = true;

      const onInput = () => {
        confirmBtn.disabled = (inputEl.value || '').trim().toUpperCase() !== 'YES';
      };

      const cleanup = () => {
        try{ inputEl.removeEventListener('input', onInput); }catch{}
        try{ cancelBtn.removeEventListener('click', onCancel); }catch{}
        try{ confirmBtn.removeEventListener('click', onConfirm); }catch{}
        try{ backdrop && backdrop.removeEventListener('click', onCancel); }catch{}
        try{ document.removeEventListener('keydown', onKey, true); }catch{}
      };

      const close = () => {
        modal.classList.remove('show');
        document.body.style.overflow = '';
      };

      const onCancel = () => { cleanup(); close(); };

      const onConfirm = async () => {
        if(!UI.canDelete) { cleanup(); close(); return; }
        confirmBtn.disabled = true;
        cleanup();
        close();
        await doDeleteSelected();
      };

      const onKey = (e) => {
        if(e.key === 'Escape'){ e.preventDefault(); onCancel(); }
        else if(e.key === 'Enter' && !confirmBtn.disabled){ e.preventDefault(); confirmBtn.click(); }
      };

      inputEl.addEventListener('input', onInput);
      cancelBtn.addEventListener('click', onCancel);
      confirmBtn.addEventListener('click', onConfirm);
      if(backdrop) backdrop.addEventListener('click', onCancel);
      document.addEventListener('keydown', onKey, true);

      modal.classList.add('show');
      document.body.style.overflow = 'hidden';
      setTimeout(()=>{ try{ inputEl.focus(); }catch{} }, 0);
    }

    async function doDeleteSelected(){
      const id = STATE.selectedId;
      if(!id || !STATE.db || !UI.canDelete) return;

      try{
        await deleteDoc(doc(STATE.db, CONFIG.COLLECTION_AERIAL, id));

        STATE.allItems = STATE.allItems.filter(x => x.id !== id);
        STATE.items = STATE.items.filter(x => x.id !== id);
        STATE.selectedId = null;

        applyFilters();
        clearDetails();
        showToast('Job deleted.');
      }catch(err){
        console.error('Delete failed', err);
        showToast('Error deleting job.');
      }
    }

    // Resume refresh
    let _resumeTimer = null;
    function resume(){
      if(_resumeTimer) return;
      _resumeTimer = setTimeout(async ()=>{
        _resumeTimer = null;
        if(!STATE.db) return;
        if(STATE.isLoading) return;
        try{ await loadAll(); }catch{}
      }, 300);
    }

    (async function boot(){
      await safeReady();

      STATE.db = getFirestore();

      const shell = document.querySelector('fv-shell');
      if(shell) shell.nav = NAV_MENU;

      UI.editBtn = document.getElementById('editBtn');
      UI.saveBtn = document.getElementById('saveBtn');
      UI.cancelBtn = document.getElementById('cancelBtn');
      UI.trashBtn = document.getElementById('trashBtn');

      UI.canDelete = computeDeletePermission();
      if(UI.trashBtn){
        UI.trashBtn.disabled = !UI.canDelete;
        UI.trashBtn.title = UI.canDelete ? 'Delete job' : 'No permission to delete';
      }

      // Back
      const backBtn = document.getElementById('btnBack');
      if(backBtn) backBtn.addEventListener('click', ()=> location.href = CONFIG.BACK_URL);

      // Filters
      loadPrefs();

      const searchEl = document.getElementById('filterSearch');
      const cropEl = document.getElementById('filterCrop');
      const yearEl = document.getElementById('filterYear');

      if(searchEl){
        searchEl.value = STATE.search || '';
        searchEl.addEventListener('input', ()=>{
          STATE.search = searchEl.value || '';
          savePrefs();
          applyFilters();
        });
      }

      if(cropEl){
        cropEl.value = STATE.crop || 'all';
        cropEl.addEventListener('change', async ()=>{
          STATE.crop = cropEl.value || 'all';
          savePrefs();
          await loadAll();
        });
      }

      if(yearEl){
        yearEl.value = STATE.cropYear || 'all';
        yearEl.addEventListener('change', async ()=>{
          STATE.cropYear = yearEl.value || 'all';
          savePrefs();
          await loadAll();
        });
      }

      wireDateRangePickerEvents();

      const clearBtn = document.getElementById('btnClearFilters');
      if(clearBtn){
        clearBtn.addEventListener('click', async ()=>{
          STATE.search = '';
          STATE.fromYmd = '';
          STATE.toYmd = '';
          STATE.crop = 'all';
          STATE.cropYear = 'all';

          if(searchEl) searchEl.value = '';
          if(cropEl) cropEl.value = 'all';
          if(yearEl) yearEl.value = 'all';

          const jobInput = document.getElementById('jobRangeInput');
          if(jobInput) jobInput.value = '';

          savePrefs();
          await loadAll();
        });
      }

      // Retry
      const emptyEl = document.getElementById('listEmpty');
      if(emptyEl){
        emptyEl.addEventListener('click', ()=>{
          if(!STATE.db || STATE.isLoading) return;
          loadAll();
        });
      }

      // Close details
      const closeBtn = document.getElementById('detailClose');
      if(closeBtn){
        closeBtn.addEventListener('click', ()=>{
          STATE.selectedId = null;
          clearDetails();
        });
      }

      // Edit/Save/Cancel (slot handled inside renderDetails/enterEdit)
      if(UI.editBtn) UI.editBtn.addEventListener('click', ()=> { if(STATE.selectedId) enterEdit(); });
      if(UI.saveBtn) UI.saveBtn.addEventListener('click', ()=> { if(STATE.selectedId) saveEdit(); });
      if(UI.cancelBtn) UI.cancelBtn.addEventListener('click', ()=> { if(STATE.selectedId) cancelEdit(); });

      // Delete
      if(UI.trashBtn){
        UI.trashBtn.addEventListener('click', (e)=>{
          e.stopPropagation();
          if(!UI.canDelete) return;
          if(!STATE.selectedId) return;
          if(STATE.isEditing) return;
          openDeleteModal();
        });
      }

      // Title edit
      const titleTextEl = document.getElementById('detailTitleText');
      const titleInputEl = document.getElementById('detailTitleInput');
      if(titleTextEl && titleInputEl){
        titleTextEl.addEventListener('click', ()=>{
          if(!STATE.selectedId) return;
          beginEditTitle();
        });

        titleInputEl.addEventListener('blur', ()=>{
          if(!STATE.isEditingTitle) return;
          commitEditTitle();
        });

        titleInputEl.addEventListener('keydown', (ev)=>{
          if(ev.key === 'Enter'){ ev.preventDefault(); titleInputEl.blur(); }
          else if(ev.key === 'Escape'){ ev.preventDefault(); cancelEditTitle(); }
        });
      }

      // File modal
      fileModal = document.getElementById('fileModal');
      fileBackdrop = document.getElementById('fileBackdrop');
      fileCloseBtn = document.getElementById('fileModalClose');
      fileContentWrap = document.getElementById('fileContentWrap');
      if(fileBackdrop) fileBackdrop.addEventListener('click', closeFileViewer);
      if(fileCloseBtn) fileCloseBtn.addEventListener('click', closeFileViewer);

      await loadAll();
    })();

    window.addEventListener('focus', () => resume());
    window.addEventListener('pageshow', () => resume());
    document.addEventListener('visibilitychange', () => { if(document.visibilityState === 'visible') resume(); });
  </script>
</head>

<body>
  <fv-shell>
    <div class="wrap">
      <section class="hero">
        <header class="hero-head">
          <div class="icon" aria-hidden="true">🛩️</div>
          <div>
            <h1>Aerial Applications</h1>
            <p class="muted">Loads the most recent 50 jobs by default. Use crop/year or date range to pull more.</p>
          </div>
        </header>

        <div class="body">
          <div class="toolbar">
            <div class="toolbar-left">
              <button id="btnBack" type="button" class="btn btn-quiet">← Back to Aerial</button>
            </div>
            <div class="toolbar-right">
              <span id="listCount">Loading…</span>
            </div>
          </div>

          <div class="filters-row">
            <div class="filter-wrap" style="flex:2 1 320px; min-width:260px;">
              <label class="filter-label" for="filterSearch">Search</label>
              <input id="filterSearch" class="input" type="search" placeholder="Search fields, farms, job #..." autocomplete="off"/>
            </div>

            <div class="filter-wrap" style="max-width:220px; min-width:200px;">
              <label class="filter-label" for="filterCrop">Crop</label>
              <select id="filterCrop" class="select">
                <option value="all">All crops</option>
                <option value="Corn">Corn</option>
                <option value="Soybeans">Soybeans</option>
                <option value="Wheat">Wheat</option>
              </select>
            </div>

            <div class="filter-wrap" style="max-width:180px; min-width:160px;">
              <label class="filter-label" for="filterYear">Crop Year</label>
              <select id="filterYear" class="select">
                <option value="all">All years</option>
                <option value="2024">2024</option>
                <option value="2025">2025</option>
                <option value="2026">2026</option>
                <option value="2027">2027</option>
                <option value="2028">2028</option>
              </select>
            </div>

            <!-- Date range picker standard markup IDs -->
            <div class="filter-wrap" style="max-width:360px; min-width:260px;">
              <label class="filter-label" for="jobRangeInput">Release Date Range</label>
              <div style="position:relative;">
                <input id="jobRangeInput" class="input" type="text" readonly placeholder="Pick a date range…"/>

                <div id="calendarPopover" class="cal-pop" role="dialog" aria-label="Date range picker">
                  <div class="cal-pop-head">
                    <div class="row">
                      <select id="monthSelect" aria-label="Month"></select>
                      <select id="yearSelect" aria-label="Year"></select>
                    </div>
                    <button id="closeCalBtn" class="cal-close" type="button" aria-label="Close">✕</button>
                  </div>

                  <div class="cal-dow" aria-hidden="true">
                    <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                  </div>

                  <div id="calDays" aria-label="Calendar days"></div>

                  <div class="cal-pop-foot">
                    <span id="rangeSummary">No dates selected</span>
                    <div class="cal-btns">
                      <button id="clearRangeBtn" class="cal-btn" type="button">Clear</button>
                      <button id="applyRangeBtn" class="cal-btn apply" type="button">Apply</button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="filters-actions">
              <button id="btnClearFilters" type="button" class="btn btn-quiet">Clear</button>
            </div>
          </div>

          <section aria-label="Aerial jobs">
            <div id="listEmpty" class="aerial-empty">Loading jobs…</div>
            <div id="list" class="aerial-list"></div>
          </section>
        </div>
      </section>

      <section id="detailPanel" class="detail-panel" aria-label="Aerial job details">
        <div class="detail-header">
          <div class="detail-title-area">
            <div class="detail-title" id="detailTitleText">Aerial Job Details</div>
            <input type="text" id="detailTitleInput" class="detail-title-input" maxlength="80" autocomplete="off"/>
            <div class="detail-edit-hint">Tap title to edit job #</div>
          </div>

          <button type="button" id="detailClose" class="detail-close">
            <span class="visually-hidden">Close</span>
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M6.225 4.811 4.81 6.225 10.586 12l-5.775 5.775 1.414 1.414L12 13.414l5.775 5.775 1.414-1.414L13.414 12l5.775-5.775-1.414-1.414L12 10.586 6.225 4.811Z" fill="currentColor"/>
            </svg>
          </button>
        </div>

        <div id="detailGrid" class="detail-grid"></div>

        <div class="detail-notes">
          <div class="detail-notes-label">Notes</div>
          <div id="detailNotesBody"></div>
        </div>

        <div class="attachments">
          <div class="attachments-label">Files &amp; Photos</div>
          <div id="detailAttachments" class="attachments-grid"></div>
        </div>

        <div class="fields-block">
          <div class="fields-label">Fields in this job</div>
          <div id="detailFieldsList" class="fields-list"></div>
        </div>

        <!-- Buttons live here and are slotted into the right slot -->
        <button type="button" id="editBtn" class="btn btn-quiet" style="display:none;">Edit</button>
        <button type="button" id="saveBtn" class="btn btn-quiet" style="display:none;">Save</button>
        <button type="button" id="cancelBtn" class="btn btn-quiet" style="display:none;">Cancel</button>

        <!-- Delete button (red trash) -->
        <button type="button" id="trashBtn" class="trash-btn" aria-label="Delete job" title="Delete job" style="display:none;">
          <svg viewBox="0 0 24 24" aria-hidden="true">
            <path d="M9 3a1 1 0 0 0-.894.553L7.382 5H5a1 1 0 1 0 0 2h.293l.853 11.093A2 2 0 0 0 8.14 20h7.72a2 2 0 0 0 1.994-1.907L18.707 7H19a1 1 0 1 0 0-2h-2.382l-.724-1.447A1 1 0 0 0 15 3H9Zm1.118 4a1 1 0 0 0-.996 1.09l.5 8a1 1 0 1 0 1.996-.124l-.5-8A1 1 0 0 0 10.118 7Zm3.764 0a1 1 0 0 0-.882 1.09l.5 8a1 1 0 0 0 1.996-.124l-.5-8A1 1 0 0 0 13.882 7Z" fill="currentColor"/>
          </svg>
        </button>
      </section>
    </div>
  </fv-shell>

  <div id="toast" class="toast" role="status" aria-live="polite">Saved.</div>

  <!-- File viewer -->
  <div id="fileModal" class="file-modal" role="dialog" aria-modal="true" aria-label="Aerial attachment">
    <div id="fileBackdrop" class="file-backdrop"></div>
    <div class="file-sheet">
      <div class="file-close-row">
        <button id="fileModalClose" type="button" class="file-close-btn">Close</button>
      </div>
      <div id="fileContentWrap" class="file-content-wrap"></div>
    </div>
  </div>

  <!-- Delete confirmation modal -->
  <div id="deleteModal" class="modal" role="dialog" aria-modal="true" aria-label="Delete job confirmation">
    <div id="deleteBackdrop" class="backdrop"></div>
    <div class="sheet">
      <div class="head">
        <div class="title">Delete Job</div>
      </div>

      <div class="body">
        <div class="hint">
          This will permanently delete this aerial job.<br/>
          <b>Type YES</b> to confirm.
        </div>

        <input
          id="deleteConfirmInput"
          type="text"
          class="input"
          placeholder="Type YES"
          autocomplete="off"
          spellcheck="false"
          style="margin-top:10px"
        />

        <div class="row-actions">
          <button type="button" id="deleteCancelBtn" class="btn btn-quiet">Cancel</button>
          <button type="button" id="deleteConfirmBtn" class="btn btn-primary" disabled>Delete</button>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
