<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FarmVista ‚Ä¢ Add Field to Trial</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#3B7E46" />

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest" />
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png" />
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png" />
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css" />
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css" />

  <style>
    :root{
      --card-max: 900px;
      --page-bottom-gap: 72px;
      --accent: #2F6C3C;

      --combo-gap:4px;
      --combo-radius:12px;
      --combo-btn-radius:10px;
      --combo-shadow:0 12px 26px rgba(0,0,0,.18);
      --combo-item-pad:10px 8px;
      --combo-max-h:50vh;
    }

    html{-webkit-text-size-adjust:100%}
    body{
      background: var(--app-bg,var(--surface));
      overflow-x:hidden;
    }

    .wrap{
      max-width: var(--card-max);
      margin: 0 auto;
      padding: clamp(14px,3vw,22px);
      padding-bottom: calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + var(--page-bottom-gap)) !important;
      box-sizing:border-box;
    }

    .hero{
      border:1px solid var(--border);
      border-radius:18px;
      background:var(--surface);
      box-shadow:var(--shadow,0 12px 28px rgba(0,0,0,.12));
      overflow:hidden;
    }

    .hero-head{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);
    }

    .hero-head-main{
      display:flex;
      gap:10px;
      align-items:flex-start;
    }

    .hero-head .icon{
      width:24px;
      height:24px;
      color:var(--accent);
      display:grid;
      place-items:center;
      margin-top:2px;
    }

    .hero-head h1{
      margin:0;
      font-size:clamp(20px,3.2vw,26px);
      line-height:1.2;
    }

    .muted{ color:var(--muted,#67706B); }

    .hero-head-actions{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      justify-content:flex-end;
    }

    .body{
      padding:16px;
      display:grid;
      gap:14px;
    }

    .row{
      display:grid;
      gap:10px;
      grid-template-columns:1fr 1fr;
    }
    @media (max-width:800px){
      .row{ grid-template-columns:1fr; }
    }

    .field{
      position:relative;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .field label{
      display:block;
      font-weight:800;
      margin:0 0 2px;
    }
    .field small{
      font-size:0.8rem;
      color:var(--muted,#67706B);
    }

    .input,
    .textarea{
      width:100%;
      font:inherit;
      font-size:16px;
      color:var(--text);
      background:var(--card-surface,var(--surface));
      border:1px solid var(--border);
      border-radius:10px;
      padding:12px;
      outline:none;
    }
    .textarea{
      min-height:110px;
      resize:vertical;
    }

    .helper{
      font-size:0.8rem;
      color:var(--muted,#67706B);
      margin-top:2px;
    }

    .error-box{
      border:1px solid #b3261e;
      background:#fff;
      color:#b3261e;
      border-radius:10px;
      padding:10px 12px;
      display:none;
    }
    .error-box.show{
      display:block;
    }

    .actions{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:flex-end;
      margin-top:10px;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:140px;
      padding:11px 16px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--card-surface,var(--surface));
      font-weight:800;
      font-size:0.95rem;
      text-decoration:none;
      cursor:pointer;
      user-select:none;
      color:var(--text)!important;
    }
    .btn-primary{
      border-color:transparent;
      background:#2F6C3C;
      color:#fff!important;
    }
    .btn-quiet{
      min-width:auto;
      padding-inline:10px;
    }
    .btn[disabled]{
      opacity:.6;
      cursor:not-allowed;
    }

    /* Trial summary chip row */
    .trial-summary{
      display:flex;
      flex-wrap:wrap;
      gap:6px 10px;
      font-size:0.85rem;
      color:var(--muted,#67706B);
    }
    .trial-chip{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:3px 8px;
      border-radius:999px;
      background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
      font-size:0.8rem;
    }
    .trial-chip-label{
      font-weight:700;
    }

    /* Mic button (dictation) */
    .ta-wrap{
      position:relative;
    }
    .textarea.with-mic{
      padding-right:52px;
    }
    .mic-btn{
      position:absolute;
      right:10px;
      bottom:10px;
      width:36px;
      height:36px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--surface);
      display:grid;
      place-items:center;
      cursor:pointer;
    }
    .mic-btn[disabled]{
      opacity:.6;
      cursor:not-allowed;
    }
    .mic-btn.mic-active{
      background:#2F6C3C;
      color:#fff;
      border-color:#2F6C3C;
    }
    .mic-svg{
      width:18px;
      height:18px;
      display:block;
    }

    /* Combos */

    .combo{ position:relative; }
    .buttonish{
      width:100%;
      font:inherit;
      font-size:16px;
      color:var(--text);
      background:var(--card-surface,var(--surface));
      border:1px solid var(--border);
      border-radius:var(--combo-btn-radius);
      padding:12px;
      padding-right:42px;
      outline:none;
      text-align:left;
      cursor:pointer;
      position:relative;
    }
    .buttonish.has-caret::after{
      content:"";
      position:absolute;
      right:14px;
      top:50%;
      width:0;
      height:0;
      border-left:6px solid transparent;
      border-right:6px solid transparent;
      border-top:7px solid var(--muted,#67706B);
      transform:translateY(-50%);
      pointer-events:none;
    }
    .combo .combo-anchor{
      position:relative;
      display:inline-block;
      width:100%;
    }
    .combo-panel{
      position:absolute;
      left:0; right:0;
      top:calc(100% + var(--combo-gap));
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--combo-radius);
      box-shadow:var(--combo-shadow);
      padding:8px;
      display:none;
      z-index:9999;
    }
    .combo-panel.show{
      display:block;
    }
    .combo-panel .search{
      padding:4px 2px 8px;
    }
    .combo-panel .search input{
      width:100%;
      padding:10px;
      border:1px solid var(--border);
      border-radius:var(--combo-btn-radius);
      background:var(--card-surface,var(--surface));
      color:var(--text);
    }
    .combo-panel .list{
      max-height:var(--combo-max-h);
      overflow:auto;
      border-top:1px solid var(--border);
    }
    .combo-item{
      padding:var(--combo-item-pad);
      border-bottom:1px solid var(--border);
      cursor:pointer;
    }
    .combo-item:hover{
      background:rgba(0,0,0,.04);
    }
    .combo-item:last-child{
      border-bottom:none;
    }
    .combo-empty{
      padding:var(--combo-item-pad);
      color:#67706B;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:calc(env(safe-area-inset-bottom,0px) + 72px);
      transform:translateX(-50%);
      background:#2F6C3C;
      color:#fff;
      padding:10px 14px;
      border-radius:10px;
      box-shadow:0 6px 20px rgba(0,0,0,.25);
      z-index:99999;
      display:none;
      white-space:nowrap;
      max-width:92vw;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .toast.show{
      display:block;
      animation:fadeout 3.2s forwards;
    }
    @keyframes fadeout{
      0%{opacity:1}
      85%{opacity:1}
      100%{opacity:0}
    }
  </style>

  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true;
        document.head.appendChild(s);
      }
    })();
  </script>

  <script type="module">
    import {
      ready,
      getFirestore,
      collection, getDocs, getDoc,
      addDoc, updateDoc, doc,
      serverTimestamp
    } from '/Farm-vista/js/firebase-init.js';

    import { NAV_MENU } from '/Farm-vista/js/menu.js';

    const CONFIG = {
      COLLECTION_TRIALS: 'fieldTrials',
      COLLECTION_FARMS:  'farms',
      COLLECTION_FIELDS: 'fields',
      RETURN_URL: '/Farm-vista/pages/crop-production/trials/trials-edit.html'
    };

    const STATE = {
      db: null,
      trialId: null,
      trial: null,
      farms: [],
      fields: [],
      selectedFarm: null,
      selectedField: null,
      selectedFieldMaxAcres: null
    };

    const $  = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    let toastEl;
    let errorBox;

    // farm/field combos
    let farmCombo, fieldCombo;
    let fieldFarmBtn, fieldFarmPanel, fieldFarmList;
    let fieldFieldBtn, fieldFieldPanel, fieldFieldList, fieldFieldSearch;

    // inputs
    let trialSummaryRow, trialNameSpan, trialCropSpan;
    let trialAcresInput, trialAcresHelp, notesInput, micBtn;

    function showToast(msg="Saved.", ms=3200){
      if(!toastEl) return;
      toastEl.textContent = msg;
      toastEl.classList.remove('show');
      void toastEl.offsetWidth;
      toastEl.classList.add('show');
      setTimeout(()=>toastEl.classList.remove('show'), ms);
    }

    function showError(msg){
      if(!errorBox) return;
      if(msg){
        errorBox.textContent = msg;
        errorBox.classList.add('show');
      }else{
        errorBox.textContent = '';
        errorBox.classList.remove('show');
      }
    }

    function getQueryParam(name){
      const params = new URLSearchParams(window.location.search);
      return params.get(name) || null;
    }

    function getTime(ts){
      if(!ts) return 0;
      try{
        if(ts.toMillis) return ts.toMillis();
        if(ts.toDate)   return ts.toDate().getTime();
        if(ts instanceof Date) return ts.getTime();
        return new Date(ts).getTime() || 0;
      }catch{
        return 0;
      }
    }

    function prettyDateFromTs(ts){
      if(!ts) return "";
      try{
        let d;
        if(ts.toDate) d = ts.toDate();
        else if(ts instanceof Date) d = ts;
        else d = new Date(ts);
        if(Number.isNaN(d.getTime())) return "";
        return d.toLocaleDateString();
      }catch{
        return "";
      }
    }

    function isImageUrl(url){
      if(!url || typeof url !== 'string') return false;
      const u = url.split('?')[0].toLowerCase();
      return u.endsWith('.jpg') || u.endsWith('.jpeg') || u.endsWith('.png') ||
             u.endsWith('.gif') || u.endsWith('.webp') || u.endsWith('.heic');
    }

    /* ---------- dictation helper ---------- */

    function wireMic(btn, ta){
      if(!btn || !ta) return;

      const ok = ('webkitSpeechRecognition' in window) || ('SpeechRecognition' in window);
      if(!ok){
        btn.style.display = 'none';
        return;
      }

      const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
      const rec = new Rec();
      rec.lang = 'en-US';
      rec.interimResults = true;
      rec.continuous = false;

      let active = false;
      let baseText = '';

      const setMic = (on)=>{
        btn.classList.toggle('mic-active', on);
        btn.setAttribute('aria-label', on ? 'Stop dictation' : 'Dictate notes');
      };

      btn.addEventListener('click', ()=>{
        if(!active){
          baseText = ta.value ? (ta.value + ' ') : '';
          try{
            rec.start();
            active = true;
            setMic(true);
          }catch(err){
            console.error('SpeechRecognition start error:', err);
          }
        }else{
          try{
            rec.stop();
            rec.abort();
          }catch{}
          active = false;
          setMic(false);
        }
      });

      rec.onresult = (ev)=>{
        let txt = '';
        for(let i=ev.resultIndex; i<ev.results.length; i++){
          txt += ev.results[i][0].transcript;
        }
        ta.value = baseText + txt;
      };

      rec.onend = ()=>{
        active = false;
        setMic(false);
      };

      rec.onerror = (e)=>{
        console.error('SpeechRecognition error:', e);
        active = false;
        setMic(false);
      };
    }

    /* ---------- global combo closer ---------- */

    function closeAllCombos(exceptPanel=null){
      $$('.combo-panel.show').forEach(p=>{
        if(p !== exceptPanel) p.classList.remove('show');
      });
    }

    document.addEventListener('click', ()=> closeAllCombos());
    document.addEventListener('keydown', e=>{
      if(e.key === 'Escape'){
        closeAllCombos();
      }
    });

    function makeCombo({ btn, panel, list, searchInput=null, items=[], searchable=false, formatter=x=>String(x?.label??x), onPick }){
      if(!btn || !panel || !list) return;

      panel.addEventListener('click', e=> e.stopPropagation());
      panel.addEventListener('mousedown', e=> e.stopPropagation());

      let DATA = items || [];

      function render(q=""){
        const qq = (q||"").toLowerCase();
        const rows = (DATA || []).filter(x=>{
          const label = formatter(x).toLowerCase();
          return !qq || label.includes(qq);
        });
        let html = "";
        if(rows.length){
          html += rows.map(x => `<div class="combo-item" data-id="${String(x.id)}">${formatter(x)}</div>`).join('');
        }else{
          html += `<div class="combo-empty">(no matches)</div>`;
        }
        list.innerHTML = html;
      }

      function open(){
        closeAllCombos(panel);
        panel.classList.add('show');
        render("");
        if(searchable && searchInput){
          searchInput.value = "";
          searchInput.focus();
        }
      }
      function close(){ panel.classList.remove('show'); }

      btn.addEventListener('click', e=>{
        e.stopPropagation();
        panel.classList.contains('show') ? close() : open();
      });

      list.addEventListener('mousedown', e=>{
        const row = e.target.closest('.combo-item');
        if(!row) return;
        const id = row.dataset.id;
        const it = (DATA || []).find(x => String(x.id) === id);
        if(!it) return;
        onPick?.(it);
        close();
      });

      if(searchable && searchInput){
        searchInput.addEventListener('input', e=>render(e.target.value));
      }

      return {
        setItems(arr){
          DATA = Array.isArray(arr) ? arr : [];
          render("");
        }
      };
    }

    /* ---------- data loaders ---------- */

    function inferName(data){
      return data.name || data.farmName || data.fieldName || data.label || "Unnamed";
    }

    async function loadTrial(){
      if(!STATE.trialId) return;
      try{
        const refDoc = doc(STATE.db, CONFIG.COLLECTION_TRIALS, STATE.trialId);
        const snap = await getDoc(refDoc);
        if(!snap.exists()){
          showError("This trial could not be found. It may have been deleted.");
          return;
        }
        STATE.trial = snap.data() || {};

        if(trialNameSpan){
          trialNameSpan.textContent = STATE.trial.trialName || "Field Trial";
        }
        if(trialCropSpan){
          const cy = STATE.trial.cropYear ?? null;
          const crop = STATE.trial.crop || "";
          const bits = [];
          if(cy !== null) bits.push(cy);
          if(crop) bits.push(crop);
          trialCropSpan.textContent = bits.join(" ‚Ä¢ ");
        }
      }catch(err){
        console.error("Error loading trial:", err);
        showError("Unable to load trial details. You can still add a field, but some labels may be missing.");
      }
    }

    async function loadFarmsAndFields(){
      const db = STATE.db;
      try{
        const farmSnap = await getDocs(collection(db, CONFIG.COLLECTION_FARMS));
        const farms = [];
        farmSnap.forEach(docSnap=>{
          const data = docSnap.data() || {};
          const name = inferName(data);
          if(!name) return;
          farms.push({ id: docSnap.id, name:String(name) });
        });
        farms.sort((a,b)=>a.name.localeCompare(b.name));
        STATE.farms = farms;
      }catch(err){
        console.error("Error loading farms:", err);
        STATE.farms = [];
      }

      try{
        const fieldSnap = await getDocs(collection(db, CONFIG.COLLECTION_FIELDS));
        const fields = [];
        fieldSnap.forEach(docSnap=>{
          const data = docSnap.data() || {};
          const fieldName = inferName(data);
          if(!fieldName) return;
          const farmId = data.farmId || data.farmDocId || data.farm || null;
          const farmName = data.farmName || data.farm || "";
          const tillable =
            data.tillable ??
            data.tillableAcres ??
            data.acres ??
            null;
          fields.push({
            id: docSnap.id,
            fieldName:String(fieldName),
            farmId,
            farmName: farmName ? String(farmName) : null,
            tillable: tillable != null ? Number(tillable) : null
          });
        });
        STATE.fields = fields;
      }catch(err){
        console.error("Error loading fields:", err);
        STATE.fields = [];
      }
    }

    function refreshFarmCombo(){
      if(!farmCombo) return;
      const items = STATE.farms.map(f=>({
        id: f.id,
        label: f.name
      }));
      farmCombo.setItems(items);
    }

    function refreshFieldComboForFarm(farmId){
      STATE.selectedFarm = STATE.farms.find(f=>f.id === farmId) || null;
      STATE.selectedField = null;
      STATE.selectedFieldMaxAcres = null;

      if(fieldFarmBtn){
        fieldFarmBtn.textContent = STATE.selectedFarm ? STATE.selectedFarm.name : "‚Äî Select farm ‚Äî";
      }
      if(fieldFieldBtn){
        fieldFieldBtn.textContent = "‚Äî Select field ‚Äî";
      }
      if(trialAcresHelp){
        trialAcresHelp.textContent = "";
      }

      if(!fieldCombo) return;

      const items = STATE.fields
        .filter(f => !farmId || f.farmId === farmId)
        .map(f => ({
          id: f.id,
          label: f.farmName ? `${f.farmName} ‚Ä¢ ${f.fieldName}` : f.fieldName,
          raw: f
        }))
        .sort((a,b)=>a.label.localeCompare(b.label));

      fieldCombo.setItems(items);
    }

    /* ---------- save ---------- */

    async function handleSave(ev){
      ev.preventDefault();
      showError("");

      const farm = STATE.selectedFarm;
      const field = STATE.selectedField;

      if(!farm){
        showError("Please select a farm.");
        return;
      }
      if(!field){
        showError("Please select a field.");
        return;
      }
      if(field.farmId && field.farmId !== farm.id){
        showError("Selected field does not belong to the selected farm. Please choose a matching farm and field.");
        return;
      }

      const acresStr = trialAcresInput.value.trim();
      const notes    = notesInput.value.trim();

      let acres = acresStr ? Number(acresStr) : null;
      if(acresStr && isNaN(acres)){
        showError("Trial acres must be a number.");
        return;
      }

      const maxAcres = STATE.selectedFieldMaxAcres;
      if(maxAcres != null && acres != null && acres > maxAcres + 0.0001){
        showError(`Trial acres cannot be more than the field tillable acres (${maxAcres}).`);
        return;
      }

      const saveBtn = document.getElementById("btnSave");
      if(saveBtn) saveBtn.disabled = true;

      try{
        const db = STATE.db;
        const trialId = STATE.trialId;

        // add field record under trial
        const fieldsCol = collection(db, CONFIG.COLLECTION_TRIALS, trialId, "fields");
        await addDoc(fieldsCol, {
          farmId: farm.id,
          farmName: farm.name,
          fieldId: field.id,
          fieldName: field.fieldName,
          tillable: maxAcres != null ? maxAcres : null,
          trialAcres: acres != null ? acres : null,
          notes: notes || null,
          createdAt: serverTimestamp()
        });

        // update trial to active
        const trialRef = doc(db, CONFIG.COLLECTION_TRIALS, trialId);
        await updateDoc(trialRef, {
          status: "active",
          updatedAt: serverTimestamp()
        });

        showToast("Field saved and trial marked Active.");
        setTimeout(()=>{
          window.location.href = CONFIG.RETURN_URL;
        }, 700);
      }catch(err){
        console.error("Error saving trial field:", err);
        showError("Error saving field: " + (err && (err.message || err.code) || "Unknown error"));
        if(saveBtn) saveBtn.disabled = false;
      }
    }

    /* ---------- boot ---------- */

    (async function boot(){
      await ready;
      STATE.db = getFirestore();

      const shell = document.querySelector('fv-shell');
      if(shell && NAV_MENU) shell.nav = NAV_MENU;

      toastEl = document.getElementById("toast");
      errorBox = document.getElementById("errBox");

      // parse trialId
      STATE.trialId = getQueryParam("trialId");
      if(!STATE.trialId){
        showError("Missing trialId in URL. Use this page from the Trials screen.");
        return;
      }

      // grab DOM refs
      trialSummaryRow = document.getElementById("trialSummaryRow");
      trialNameSpan   = document.getElementById("trialName");
      trialCropSpan   = document.getElementById("trialCrop");

      fieldFarmBtn    = document.getElementById("fieldFarmBtn");
      fieldFarmPanel  = document.getElementById("fieldFarmPanel");
      fieldFarmList   = document.getElementById("fieldFarmList");

      fieldFieldBtn   = document.getElementById("fieldFieldBtn");
      fieldFieldPanel = document.getElementById("fieldFieldPanel");
      fieldFieldList  = document.getElementById("fieldFieldList");
      fieldFieldSearch= document.getElementById("fieldFieldSearch");

      trialAcresInput = document.getElementById("trialAcres");
      trialAcresHelp  = document.getElementById("trialAcresHelp");
      notesInput      = document.getElementById("notes");
      micBtn          = document.getElementById("notesMic");

      const btnBack   = document.getElementById("btnBack");
      const btnCancel = document.getElementById("btnCancel");
      const btnSave   = document.getElementById("btnSave");

      if(btnBack){
        btnBack.addEventListener("click", ()=>{
          window.location.href = CONFIG.RETURN_URL;
        });
      }
      if(btnCancel){
        btnCancel.addEventListener("click", ()=>{
          window.location.href = CONFIG.RETURN_URL;
        });
      }
      if(btnSave){
        btnSave.addEventListener("click", handleSave);
      }

      // wire mic
      if(notesInput && micBtn){
        notesInput.classList.add("with-mic");
        wireMic(micBtn, notesInput);
      }

      // build combos
      farmCombo = makeCombo({
        btn: fieldFarmBtn,
        panel: fieldFarmPanel,
        list: fieldFarmList,
        searchable: true,
        formatter: x=>x.label,
        onPick: farm=>{
          STATE.selectedFarm = STATE.farms.find(f=>f.id === farm.id) || null;
          refreshFieldComboForFarm(farm.id);
        }
      });

      fieldCombo = makeCombo({
        btn: fieldFieldBtn,
        panel: fieldFieldPanel,
        list: fieldFieldList,
        searchInput: fieldFieldSearch,
        searchable: true,
        formatter: x=>x.label,
        onPick: item=>{
          STATE.selectedField = item.raw;
          // If field has farmId, snap farm combo
          if(item.raw.farmId){
            const farm = STATE.farms.find(f=>f.id === item.raw.farmId);
            if(farm){
              STATE.selectedFarm = farm;
              refreshFieldComboForFarm(farm.id);
              // Keep this field selected after refresh
              STATE.selectedField = item.raw;
              if(fieldFieldBtn){
                fieldFieldBtn.textContent = item.label;
              }
            }
          }else{
            if(fieldFieldBtn){
              fieldFieldBtn.textContent = item.label;
            }
          }

          // set max acres
          const max = item.raw.tillable != null ? item.raw.tillable : null;
          STATE.selectedFieldMaxAcres = max;
          if(max != null && trialAcresHelp){
            trialAcresHelp.textContent =
              `Max trial acres for this field: ${max}. Trial acres cannot be more than the tillable acres.`;
          }else if(trialAcresHelp){
            trialAcresHelp.textContent = '';
          }
        }
      });

      try{
        await loadTrial();
        await loadFarmsAndFields();
        refreshFarmCombo();
        refreshFieldComboForFarm(null);
      }catch(err){
        console.error("Initial load error:", err);
        showError("Error loading data. Check console or network.");
      }
    })();
  </script>
</head>

<body>
  <fv-shell>
    <div class="wrap">
      <section class="hero">
        <header class="hero-head">
          <div class="hero-head-main">
            <div class="icon" aria-hidden="true">üß™</div>
            <div>
              <h1>Add Field to Trial</h1>
              <p class="muted">
                Pick a farm and field, then enter the acres that are part of this trial.
                Trial acres can‚Äôt be more than the field‚Äôs tillable acres.
              </p>
            </div>
          </div>
          <div class="hero-head-actions">
            <button id="btnBack" type="button" class="btn btn-quiet">
              ‚Üê Back to Trials
            </button>
          </div>
        </header>

        <div class="body">
          <div id="errBox" class="error-box"></div>

          <!-- Trial summary -->
          <div id="trialSummaryRow" class="trial-summary">
            <span class="trial-chip">
              <span class="trial-chip-label">Trial</span>
              <span id="trialName">Loading‚Ä¶</span>
            </span>
            <span class="trial-chip">
              <span class="trial-chip-label">Crop</span>
              <span id="trialCrop">‚Äî</span>
            </span>
          </div>

          <!-- Farm / Field -->
          <div class="row">
            <div class="field combo">
              <label for="fieldFarmBtn">Farm</label>
              <div class="combo-anchor">
                <button id="fieldFarmBtn" class="buttonish has-caret" type="button">
                  ‚Äî Select farm ‚Äî
                </button>
                <div id="fieldFarmPanel" class="combo-panel" role="listbox" aria-label="Farm list">
                  <div class="list" id="fieldFarmList"></div>
                </div>
              </div>
              <div class="helper">Pick the farm where this trial strip is located.</div>
            </div>

            <div class="field combo">
              <label for="fieldFieldBtn">Field</label>
              <div class="combo-anchor">
                <button id="fieldFieldBtn" class="buttonish has-caret" type="button">
                  ‚Äî Select field ‚Äî
                </button>
                <div id="fieldFieldPanel" class="combo-panel" role="listbox" aria-label="Field list">
                  <div class="search">
                    <input id="fieldFieldSearch" type="search" placeholder="Search fields‚Ä¶" />
                  </div>
                  <div class="list" id="fieldFieldList"></div>
                </div>
              </div>
              <div class="helper">You can pick a field first and the farm will auto-fill.</div>
            </div>
          </div>

          <!-- Trial acres -->
          <div class="row">
            <div class="field">
              <label for="trialAcres">Trial Acres</label>
              <input id="trialAcres" class="input" type="number" step="0.01"
                     placeholder="Acres in this field that are part of the trial" />
              <div id="trialAcresHelp" class="helper"></div>
            </div>

            <div class="field">
              <label>Submitted / Status</label>
              <div class="helper">
                When you save, this trial will be marked <strong>Active</strong>.
              </div>
            </div>
          </div>

          <!-- Notes -->
          <div class="field">
            <label for="notes">Notes</label>
            <div class="ta-wrap">
              <textarea id="notes" class="textarea with-mic"
                        placeholder="Strip layout, passes, timing, or anything the crew needs to remember."></textarea>
              <button id="notesMic" type="button" class="mic-btn" aria-label="Dictate notes">
                <svg class="mic-svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                  <path d="M12 14a3 3 0 0 0 3-3V6a3 3 0 1 0-6 0v5a3 3 0 0 0 3 3zm5-3a5 5 0 0 1-10 0H5a7 7 0 0 0 6 6.92V21H9v2h6v-2h-2v-3.08A7 7 0 0 0 19 11h-2z"/>
                </svg>
              </button>
            </div>
            <div class="helper">Optional, but really helpful when you come back to review results.</div>
          </div>

          <!-- Actions -->
          <div class="actions">
            <button id="btnCancel" type="button" class="btn">Cancel</button>
            <button id="btnSave" type="button" class="btn btn-primary">Save Field</button>
          </div>
        </div>
      </section>
    </div>
  </fv-shell>

  <div id="toast" class="toast" role="status" aria-live="polite">Saved.</div>
</body>
</html>

