<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FarmVista ‚Ä¢ Trial Field Yields (Multi-Hybrid)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#3B7E46" />

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest" />
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png" />
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png" />
  <script src="/Farm-vista/js/theme-boot.js"></script>

  <!-- Dictation + swipe helpers (ES modules that also attach to window.*) -->
  <script type="module" src="/Farm-vista/js/fv-dictation.js"></script>
  <script type="module" src="/Farm-vista/js/fv-swipe-list.js"></script>

  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css" />
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css" />
  <!-- Match normal trial page swipe styles -->
  <link rel="stylesheet" href="/Farm-vista/assets/css/swipe-list.css" />

  <style>
    :root{
      --card-max: 900px;
      --page-bottom-gap: 72px;
      --accent: #2F6C3C;

      /* Combo + modal vars used by the MH helper */
      --combo-gap: 4px;
      --combo-radius: 12px;
      --combo-btn-radius: 10px;
      --combo-shadow: 0 12px 26px rgba(0,0,0,.18);
      --combo-item-pad: 10px 8px;
      /* tall list so you can see a bunch of hybrids */
      --combo-max-h: 60vh;
    }

    html{-webkit-text-size-adjust:100%}
    body{
      background: var(--app-bg,var(--surface));
      overflow-x:hidden;
    }

    .wrap{
      max-width: var(--card-max);
      margin: 0 auto;
      padding: clamp(14px,3vw,22px);
      padding-bottom: calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + var(--page-bottom-gap)) !important;
      box-sizing:border-box;
      display:grid;
      gap:16px;
    }

    .hero{
      border:1px solid var(--border);
      border-radius:18px;
      background:var(--surface);
      box-shadow:var(--shadow,0 12px 28px rgba(0,0,0,.12));
      overflow:visible;
    }

    .hero-head{
      display:flex;
      align-items:flex-start;
      gap:12px;
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);
    }

    .hero-head .icon{
      width:24px;
      height:24px;
      color:var(--accent);
      display:grid;
      place-items:center;
      margin-top:2px;
    }

    .hero-head h1{
      margin:0;
      font-size:clamp(20px,3.2vw,26px);
      line-height:1.2;
    }

    .muted{color:var(--muted,#67706B)}

    .body{
      padding:16px;
      display:grid;
      gap:14px;
    }

    .top-row-actions-left{
      display:flex;
      flex-wrap:wrap;
      align-items:flex-start;
      justify-content:flex-start;
      gap:10px;
    }

    .top-row{
      display:flex;
      flex-wrap:wrap;
      align-items:flex-start;
      justify-content:flex-start;
      gap:10px 16px;
    }

    .trial-summary{
      display:grid;
      gap:4px;
      font-size:0.9rem;
    }

    .trial-summary-title{
      font-weight:800;
      font-size:1rem;
    }

    .trial-summary-line{
      font-size:0.85rem;
      color:var(--muted,#67706B);
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:140px;
      padding:11px 16px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--card-surface,var(--surface));
      font-weight:800;
      font-size:0.95rem;
      text-decoration:none;
      cursor:pointer;
      user-select:none;
      color:var(--text)!important;
      gap:6px;
    }
    .btn-primary{
      border-color:transparent;
      background:#2F6C3C;
      color:#fff!important;
    }
    .btn-quiet{
      min-width:auto;
      padding-inline:10px;
    }
    .btn-small{
      padding:6px 10px;
      min-width:auto;
      font-size:0.8rem;
      border-radius:999px;
    }

    /* Keep btnOpenModal for helper, but hide it visually */
    .visually-hidden{
      position:absolute;
      width:1px;
      height:1px;
      padding:0;
      margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      white-space:nowrap;
      border:0;
    }

    .fields-hero{
      border:1px solid var(--border);
      border-radius:18px;
      background:var(--surface);
      box-shadow:var(--shadow,0 10px 22px rgba(0,0,0,.08));
      overflow:hidden;
    }
    .fields-head{
      padding:12px 16px;
      border-bottom:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .fields-head h2{
      margin:0;
      font-size:1rem;
    }
    .fields-body{
      padding:14px 16px 16px;
      display:grid;
      gap:12px;
    }

    .field-card{
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--card-surface,var(--surface));
      padding:9px 10px;
      display:grid;
      gap:4px;
      font-size:0.9rem;
      cursor:pointer;
      transition:background 0.12s ease, box-shadow 0.12s ease, transform 0.08s ease;
    }
    .field-card:hover{
      background:rgba(0,0,0,.03);
      box-shadow:0 4px 10px rgba(0,0,0,.08);
      transform:translateY(-1px);
    }

    /* Desktop-only: card is NOT a button ‚Äì no pointer/hover feel */
    @media (min-width:641px){
      .field-card{
        cursor:default;
        transition:none;
      }
      .field-card:hover{
        background:var(--card-surface,var(--surface));
        box-shadow:none;
        transform:none;
      }
    }

    .field-card-top{
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:flex-start;
    }
    .field-card-title{
      font-weight:700;
    }
    .field-card-sub{
      font-size:0.82rem;
      color:var(--muted,#67706B);
    }
    .field-card-note{
      font-size:0.83rem;
      color:var(--muted,#67706B);
      margin-top:2px;
    }

    /* On phones: hide the desktop button, swipe handles yield */
    @media (max-width:640px){
      .field-card-top .btn-small{ display:none; }
    }

    .fields-hint{
      font-size:0.78rem;
      color:var(--muted,#67706B);
      margin-top:4px;
    }

    /* ========== Modal shell ========== */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.4);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:9999;
    }
    .modal-backdrop.hidden{ display:none; }

    .modal{
      max-width:720px;
      width:96vw;
      background:var(--surface);
      border-radius:16px;
      box-shadow:0 18px 45px rgba(0,0,0,.28);
      border:1px solid var(--border);
      display:flex;
      flex-direction:column;
      max-height:calc(100vh - 24px);
      margin:12px;
      /* keep everything inside the box; header/footer stay put */
      overflow:hidden;
    }
    .modal-header{
      padding:12px 16px;
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }
    .modal-header h3{
      margin:0;
      font-size:1rem;
    }
    .modal-close{
      border:none;
      background:transparent;
      color:var(--muted,#67706B);
      font-size:0;
      line-height:1;
      cursor:pointer;
      padding:4px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .modal-close svg{
      width:18px;
      height:18px;
      display:block;
    }
    .modal-body{
      padding:14px 16px 10px;
      font-size:0.9rem;
      display:grid;
      gap:10px;
      flex:1;
      min-height:0;
      /* contents scroll INSIDE the box */
      overflow-y:auto;
    }
    .modal-footer{
      padding:10px 16px 12px;
      border-top:1px solid var(--border);
      display:flex;
      justify-content:flex-end;
      gap:10px;
      flex-shrink:0;
      background:var(--surface);
    }

    /* Mobile: keep header/footer visible, scroll inside, add top/bottom gap */
    @media (max-width:640px){
      .modal-backdrop{
        align-items:flex-start;
        padding:12px 10px calc(12px + env(safe-area-inset-bottom,0px));
        box-sizing:border-box;
      }
      .modal{
        width:100%;
        max-width:100%;
        max-height:100%;
        margin:0;
        border-radius:16px;
      }
      .modal-body{
        flex:1;
        min-height:0;
      }
    }

    .yield-summary{
      display:grid;
      gap:4px;
    }
    .yield-summary .muted{ font-size:0.82rem; }

    .primary-full-btn{
      margin-top:4px;
      margin-bottom:4px;
      border-radius:999px;
      padding:11px 16px;
      border:none;
      width:100%;
      font-weight:800;
      font-size:0.95rem;
      cursor:pointer;
      background:#2F6C3C;
      color:#fff;
      box-shadow:0 8px 18px rgba(46,123,53,0.35);
    }

    /* === Extra field / combo styles used by the helper === */

    .row{
      display:grid;
      gap:10px;
      grid-template-columns:1fr 1fr;
    }
    @media (max-width:880px){
      .row{grid-template-columns:1fr;}
    }
    .field{ position:relative; }
    .field label{
      display:block;
      font-weight:800;
      margin:0 0 6px;
    }
    .input,
    .select{
      width:100%;
      font:inherit;
      font-size:16px;
      color:var(--text);
      background:var(--card-surface,var(--surface));
      border:1px solid var(--border);
      border-radius:10px;
      padding:12px;
      outline:none;
      box-sizing:border-box;
    }
    .help{
      font-size:13px;
      color:var(--muted,#67706B);
      margin-top:6px;
    }

    .combo{ position:relative; }
    .combo .combo-anchor{
      position:relative; display:inline-block; width:100%;
    }
    .buttonish{
      width:100%; font:inherit; font-size:16px; color:var(--text);
      background:var(--card-surface,var(--surface)); border:1px solid var(--border);
      border-radius:var(--combo-btn-radius); padding:12px; outline:none;
      cursor:pointer; text-align:left; position:relative; padding-right:42px;
      box-sizing:border-box;
    }
    .buttonish.has-caret::after{
      content:""; position:absolute; right:14px; top:50%; width:0; height:0;
      border-left:6px solid transparent; border-right:6px solid transparent;
      border-top:7px solid var(--muted,#67706B); transform:translateY(-50%); pointer-events:none;
    }

    /* Dropdown is part of normal flow so it pushes content down */
    .combo-panel{
      position:relative;
      left:auto;
      right:auto;
      top:auto;
      bottom:auto;
      margin-top:var(--combo-gap);
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--combo-radius);
      box-shadow:var(--combo-shadow);
      z-index:1;
      padding:8px;
      display:none;
    }
    .combo-panel.show{ display:block; }

    .combo-panel .list{
      max-height:var(--combo-max-h);
      overflow:auto;
      border-top:1px solid var(--border);
    }
    .combo-item{
      padding:var(--combo-item-pad);
      border-bottom:1px solid var(--border);
      cursor:pointer;
      font-size:0.9rem;
    }
    .combo-item:last-child{ border-bottom:none; }
    .combo-item:hover{ background:rgba(0,0,0,.04); }
    .combo-empty{ padding:var(--combo-item-pad); color:#67706B; }

    .setup-panel{
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--surface);
      padding:10px 12px;
      display:grid;
      gap:10px;
    }
    .setup-hybrids-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }
    .setup-hybrids-header h3{
      margin:0;
      font-size:0.9rem;
    }
    .entry-label{
      font-size:0.8rem;
      font-weight:600;
      white-space:nowrap;
    }
    .setup-hybrid-row{
      display:grid;
      grid-template-columns:auto minmax(0,2.3fr) minmax(0,1.2fr) auto;
      gap:6px;
      align-items:center;
      padding:6px 8px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--surface-soft,var(--surface));
    }
    .check-indicator{
      display:inline-flex;
      align-items:center;
      gap:4px;
      font-size:0.78rem;
      white-space:nowrap;
      cursor:pointer;
    }
    .check-dot{
      width:10px;
      height:10px;
      border-radius:999px;
      border:2px solid #9ca3af;
      box-sizing:border-box;
    }
    .check-dot--on{
      border-color:#166534;
      background:#16a34a;
    }
    .row-remove{
      border:none;
      background:transparent;
      color:var(--muted,#67706B);
      font-size:0;
      line-height:1;
      cursor:pointer;
      padding:4px;
      border-radius:999px;
      display:none;
    }
    .row-remove svg{
      width:14px;
      height:14px;
      display:block;
    }
    @media (min-width:641px){
      .row-remove{
        display:flex;
        align-items:center;
        justify-content:center;
      }
    }
    .setup-errors{
      font-size:0.8rem;
      color:#b3261e;
    }

    .blocks-panel{
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--surface);
      padding:10px 12px;
      display:grid;
      gap:8px;
    }
    .blocks-panel-header{
      font-size:0.85rem;
      margin-bottom:4px;
    }

    .yield-block-card{
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--surface-soft,var(--surface));
      padding:8px 10px;
      display:grid;
      gap:6px;
      font-size:0.88rem;
    }
    .yield-block-head{
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:flex-start;
    }
    .yield-block-title{
      font-weight:700;
    }
    .yield-block-sub{
      font-size:0.8rem;
      color:var(--muted,#67706B);
    }

    .field-mini{
      display:flex;
      flex-direction:column;
      gap:3px;
    }
    .field-mini span{
      font-size:0.8rem;
      font-weight:600;
    }

    .yield-extra{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:8px;
    }

    .notes-shell{
      position:relative;
    }
    .notes-input{
      width:100%;
      min-height:96px;
      padding-right:52px;
      resize:vertical;
    }

    .mic-btn{
      position:absolute;
      right:10px;
      bottom:10px;
      width:36px;
      height:36px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--surface);
      display:grid;
      place-items:center;
      cursor:pointer;
      color:var(--text);
    }
    .mic-btn[disabled]{
      opacity:.6;
      cursor:not-allowed;
    }
    .mic-btn.mic-active{
      background:#2F6C3C;
      color:#fff;
      border-color:#2F6C3C;
    }
    .mic-svg{
      width:18px;
      height:18px;
      display:block;
    }

    .files-shell{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .hidden-file{
      display:none;
    }
    .file-list{
      margin:0;
      padding:0;
      list-style:none;
      font-size:0.8rem;
    }
    .file-list li{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:6px;
      padding:4px 6px;
      border-radius:6px;
      border:1px solid var(--border);
      background:var(--surface);
    }
    .file-name{
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width:200px;
    }
    .file-remove{
      border:none;
      background:transparent;
      font-size:14px;
      line-height:1;
      cursor:pointer;
      padding:2px 4px;
      border-radius:999px;
      color:var(--muted,#67706B);
    }
    .file-remove:hover{
      background:rgba(0,0,0,.06);
    }

    .hidden{display:none;}
  </style>

  <!-- Lazy-load fv-shell if needed -->
  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true;
        document.head.appendChild(s);
      }
    })();
  </script>
</head>

<body>
  <fv-shell>
    <div class="wrap">
      <section class="hero">
        <header class="hero-head">
          <div class="icon" aria-hidden="true">üß™</div>
          <div>
            <h1>Trial Field Yields (Multi-Hybrid)</h1>
            <p class="muted">
              This page is dedicated to multi-hybrid seed variety trials. It uses the same FarmVista look and feel,
              but with a yield pop-up designed for multiple hybrids, notes, attachments, and swipe on mobile.
            </p>
          </div>
        </header>

        <div class="body">
          <div class="top-row-actions-left">
            <button id="btnBack" type="button" class="btn btn-quiet">
              ‚Üê Back to Trials
            </button>

            <!-- Needed for helper; visually hidden so there is no extra big green button -->
            <button type="button" class="btn btn-primary visually-hidden" id="btnOpenModal">
              Open Yield Popup
            </button>
          </div>

          <!-- Summary block ‚Äì driven by Firestore -->
          <div class="top-row">
            <div class="trial-summary">
              <div class="trial-summary-title" id="mhTrialName">Multi-Hybrid Trial</div>
              <div class="trial-summary-line">
                <strong>Crop:</strong>
                <span id="mhCropLine">‚Äî</span>
              </div>
              <div class="trial-summary-line" id="mhCheckLine"></div>
              <div class="trial-summary-line" id="mhVarietyLine"></div>
              <div class="trial-summary-line" id="mhPlantDateLine"></div>
            </div>
          </div>
        </div>
      </section>

      <section class="fields-hero">
        <header class="fields-head">
          <h2>Field in this multi-hybrid trial</h2>
        </header>
        <div class="fields-body">
          <div class="field-card" id="devFieldCard">
            <div class="field-card-top">
              <div>
                <div class="field-card-title" id="mhFieldTitle">
                  Divernon‚ÄìFarmersville ‚Ä¢ 0702-Grandmas TestPlot
                </div>
                <div class="field-card-sub" id="mhFieldSub">
                  Trial acres: <strong>20.00 ac</strong> (Max tillable: 39.45)
                </div>
                <div class="field-card-note" id="devFieldSummary"></div>
              </div>
              <div>
                <!-- Desktop-only button (hidden on phones via @media) -->
                <button type="button" class="btn btn-small" id="btnFieldYield">
                  View / Add Yield
                </button>
              </div>
            </div>
          </div>

          <div class="fields-hint">
            On a phone, swipe right on the field card to add yield. On desktop, use ‚ÄúView / Add Yield.‚Äù
          </div>
        </div>
      </section>
    </div>
  </fv-shell>

  <!-- Yield modal shell the helper owns -->
  <div id="yieldModalBackdrop" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-labelledby="yieldModalTitle">
    <div class="modal">
      <div class="modal-header">
        <h3 id="yieldModalTitle">Yield Entry</h3>
        <button id="btnYieldClose" type="button" class="modal-close" aria-label="Close">
          <svg viewBox="0 0 16 16" aria-hidden="true">
            <path d="M4.22 4.22a.75.75 0 0 1 1.06 0L8 6.94l2.72-2.72a.75.75 0 1 1 1.06 1.06L9.06 8l2.72 2.72a.75.75 0 0 1-1.06 1.06L8 9.06l-2.72 2.72a.75.75 0 0 1-1.06-1.06L6.94 8 4.22 5.28a.75.75 0 0 1 0-1.06z"></path>
          </svg>
        </button>
      </div>
      <div class="modal-body">
        <div id="yieldSummary" class="yield-summary"></div>

        <button type="button" class="primary-full-btn" id="btnSetUpPlot">
          Set Up Plot
        </button>

        <div id="mhStageShell"></div>
      </div>
      <div class="modal-footer">
        <button id="btnYieldOk" type="button" class="btn btn-primary">Save &amp; Close</button>
      </div>
    </div>
  </div>

  <script type="module">
    import {
      ready,
      getFirestore,
      doc,
      getDoc,
      collection,
      getDocs
    } from '/Farm-vista/js/firebase-init.js';

    import { NAV_MENU } from '/Farm-vista/js/menu.js';
    import { initMhYieldHelper } from '/Farm-vista/js/trials-mh-yield-helper.js';

    const CONFIG = {
      COLLECTION_TRIALS: 'fieldTrials',
      RETURN_URL: '/Farm-vista/pages/crop-production/trials/trials-edit.html'
    };

    const STATE = {
      db: null,
      trialId: null,
      trial: null,
      fieldDocId: null,
      field: null
    };

    const $ = (sel, root = document) => root.querySelector(sel);

    function getQueryParam(name){
      const params = new URLSearchParams(window.location.search);
      return params.get(name) || null;
    }

    async function loadTrial(){
      if(!STATE.trialId || !STATE.db) return;

      try{
        const ref = doc(STATE.db, CONFIG.COLLECTION_TRIALS, STATE.trialId);
        const snap = await getDoc(ref);
        if(!snap.exists()) return;

        const t = snap.data() || {};
        STATE.trial = t;

        const trialNameEl   = $('#mhTrialName');
        const cropLineEl    = $('#mhCropLine');
        const checkLineEl   = $('#mhCheckLine');
        const varietyLineEl = $('#mhVarietyLine');
        const plantDateEl   = $('#mhPlantDateLine');

        if(trialNameEl){
          trialNameEl.textContent = t.trialName || 'Multi-Hybrid Trial';
        }

        if(cropLineEl){
          const bits = [];
          if (t.cropYear != null) bits.push(t.cropYear);
          if (t.crop) bits.push(t.crop);
          cropLineEl.textContent = bits.length ? bits.join(' ‚Ä¢ ') : '‚Äî';
        }

        if(checkLineEl){
          const checkName = t.checkVariety || t.check || '';
          checkLineEl.textContent = checkName ? `Check variety: ${checkName}` : '';
        }

        if(varietyLineEl){
          const count = t.varietyCount ?? t.hybridCount ?? null;
          varietyLineEl.textContent = count ? `Total varieties in this trial: ${count}` : '';
        }

        if(plantDateEl){
          let label = '';
          const pd = t.plantDate;
          if(pd){
            if(typeof pd === 'string'){
              label = pd;
            }else if(pd.toDate){
              const d = pd.toDate();
              label = d.toLocaleDateString();
            }
          }
          plantDateEl.textContent = label ? `Plant date: ${label}` : '';
        }
      }catch(err){
        console.error('Error loading MH trial:', err);
      }
    }

    async function loadField(){
      const fieldTitleEl = $('#mhFieldTitle');
      const fieldSubEl   = $('#mhFieldSub');
      const fieldNoteEl  = $('#devFieldSummary');
      const params       = new URLSearchParams(window.location.search);

      const fallbackFromParams = () => {
        const farmName  = params.get('farmName') || '';
        const fieldName = params.get('fieldName');
        const trialAc   = params.get('trialAc');
        const tillable  = params.get('tillable');

        if(fieldName && fieldTitleEl){
          fieldTitleEl.textContent = farmName
            ? `${farmName} ‚Ä¢ ${fieldName}`
            : fieldName;
        }

        if(fieldSubEl && trialAc){
          const tillText = tillable ? ` (Max tillable: ${tillable})` : '';
          fieldSubEl.innerHTML =
            `Trial acres: <strong>${Number(trialAc).toFixed(2)} ac</strong>${tillText}`;
        }
      };

      if(!STATE.db || !STATE.trialId){
        fallbackFromParams();
        return;
      }

      try{
        // If we weren't passed a fieldDocId, auto-pick the first field
        if(!STATE.fieldDocId){
          const fieldsCol = collection(
            STATE.db,
            CONFIG.COLLECTION_TRIALS,
            STATE.trialId,
            'fields'
          );
          const snapAll = await getDocs(fieldsCol);
          if(snapAll.empty){
            fallbackFromParams();
            return;
          }
          const first = snapAll.docs[0];
          STATE.fieldDocId = first.id;
          const f = first.data() || {};
          STATE.field = f;

          const farmName  = f.farmName || f.farm || '';
          const fieldName = f.fieldName || f.field || '';
          const trialAc   = f.trialAcres ?? f.trialAc ?? null;
          const tillable  = f.maxTillableAcres ?? f.tillableAc ?? f.fieldAcres ?? null;

          if(fieldTitleEl){
            const parts = [];
            if(farmName)  parts.push(farmName);
            if(fieldName) parts.push(fieldName);
            fieldTitleEl.textContent = parts.length
              ? parts.join(' ‚Ä¢ ')
              : 'Field in multi-hybrid trial';
          }

          if(fieldSubEl){
            let html = '';
            if(trialAc != null){
              html += `Trial acres: <strong>${Number(trialAc).toFixed(2)} ac</strong>`;
            }
            if(tillable != null){
              html += ` (Max tillable: ${Number(tillable).toFixed(2)})`;
            }
            fieldSubEl.innerHTML = html || '';
          }

          if(fieldNoteEl){
            const bits = [];
            if(f.township) bits.push(f.township);
            if(f.range)    bits.push(f.range);
            if(f.section)  bits.push(`Sec ${f.section}`);
            fieldNoteEl.textContent = bits.join(' ‚Ä¢ ');
          }

          return; // we're done
        }

        // Normal path: we *have* a fieldDocId
        const fieldRef = doc(
          STATE.db,
          CONFIG.COLLECTION_TRIALS,
          STATE.trialId,
          'fields',
          STATE.fieldDocId
        );
        const snap = await getDoc(fieldRef);

        if(!snap.exists()){
          fallbackFromParams();
          return;
        }

        const f = snap.data() || {};
        STATE.field = f;

        const farmName  = f.farmName || f.farm || '';
        const fieldName = f.fieldName || f.field || '';
        const trialAc   = f.trialAcres ?? f.trialAc ?? null;
        const tillable  = f.maxTillableAcres ?? f.tillableAc ?? f.fieldAcres ?? null;

        if(fieldTitleEl){
          const parts = [];
          if(farmName)  parts.push(farmName);
          if(fieldName) parts.push(fieldName);
          fieldTitleEl.textContent = parts.length
            ? parts.join(' ‚Ä¢ ')
            : 'Field in multi-hybrid trial';
        }

        if(fieldSubEl){
          let html = '';
          if(trialAc != null){
            html += `Trial acres: <strong>${Number(trialAc).toFixed(2)} ac</strong>`;
          }
          if(tillable != null){
            html += ` (Max tillable: ${Number(tillable).toFixed(2)})`;
          }
          fieldSubEl.innerHTML = html || '';
        }

        if(fieldNoteEl){
          const bits = [];
          if(f.township) bits.push(f.township);
          if(f.range)    bits.push(f.range);
          if(f.section)  bits.push(`Sec ${f.section}`);
          fieldNoteEl.textContent = bits.join(' ‚Ä¢ ');
        }
      }catch(err){
        console.error('Error loading MH trial field:', err);
        fallbackFromParams();
      }
    }

    function updateYieldSummaryFromDom(){
      const trialName = $('#mhTrialName')?.textContent || '‚Äî';
      const fieldName = $('#mhFieldTitle')?.textContent || '‚Äî';
      const fieldSub  = $('#mhFieldSub')?.textContent || '';
      const summaryEl = document.getElementById('yieldSummary');
      if(!summaryEl) return;

      summaryEl.innerHTML = `
        <div>
          <strong>Trial:</strong> ${trialName}<br>
          <strong>Field:</strong> ${fieldName}<br>
          <span>${fieldSub}</span>
        </div>
        <div class="muted">
          Multi-hybrid helper. Set up plot length, width, entries, and check variety. Then we‚Äôll show one yield card
          per entry using weight-only data.
        </div>
      `;
    }

    // ===== Inline mic wiring (same pattern as working maintenance page) =====
    function makeInlineMic(btnEl, taEl){
      if(!btnEl || !taEl) return;

      const ok = ('webkitSpeechRecognition' in window) || ('SpeechRecognition' in window);
      if(!ok){
        // Browser / PWA doesn't support speech ‚Äì hide mic
        btnEl.style.display = 'none';
        return;
      }

      const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
      const rec = new Rec();
      rec.lang = 'en-US';
      rec.interimResults = true;
      rec.continuous = false;

      let active = false;
      let baseText = '';

      const setMic = (on) => {
        btnEl.classList.toggle('mic-active', on);
        btnEl.setAttribute('aria-label', on ? 'Stop dictation' : 'Dictate notes');
      };

      btnEl.addEventListener('click', () => {
        if(!active){
          baseText = taEl.value ? (taEl.value + ' ') : '';
          try{
            rec.start();
            active = true;
            setMic(true);
          }catch(err){
            // ignore double-start errors
          }
        }else{
          try{
            rec.stop();
            rec.abort();
          }catch(err){
            // ignore
          }
          active = false;
          setMic(false);
        }
      });

      rec.onresult = (ev) => {
        let txt = '';
        for(let i = ev.resultIndex; i < ev.results.length; i++){
          txt += ev.results[i][0].transcript;
        }
        taEl.value = baseText + txt;
        // fire input so helper can capture changes into state
        taEl.dispatchEvent(new Event('input', { bubbles:true }));
      };

      rec.onend = () => {
        active = false;
        setMic(false);
      };

      rec.onerror = () => {
        active = false;
        setMic(false);
      };
    }

    function wireNotesMics(root = document){
      const shells = root.querySelectorAll('.notes-shell');
      shells.forEach(shell => {
        if(shell.dataset.micWired === '1') return;

        const btn = shell.querySelector('.mic-btn');
        // prefer specific notes-input class but fall back to any textarea
        const ta  = shell.querySelector('textarea.notes-input, textarea');
        if(!btn || !ta) return;

        makeInlineMic(btn, ta);
        shell.dataset.micWired = '1';
      });
    }
    // ===== End inline mic wiring =====

    (async function boot(){
      await ready;

      const shell = document.querySelector('fv-shell');
      if(shell && NAV_MENU){
        shell.nav = NAV_MENU;
      }

      STATE.db        = getFirestore();
      STATE.trialId   = getQueryParam('trialId');
      STATE.fieldDocId= getQueryParam('fieldDocId');

      await loadTrial();
      await loadField();
      updateYieldSummaryFromDom();

      // Expose context in case you want it later
      window.MH_TRIAL_CONTEXT = {
        db: STATE.db,
        trialId: STATE.trialId,
        trial: STATE.trial,
        fieldDocId: STATE.fieldDocId,
        field: STATE.field
      };

      const params = new URLSearchParams(window.location.search);

      const btnBack = $('#btnBack');
      if(btnBack){
        btnBack.addEventListener('click', () => {
          const ret = params.get('returnUrl') || CONFIG.RETURN_URL;
          window.location.href = ret;
        });
      }

      // Initialize the MH helper ‚Äì now wired to Firestore (and entryNumber)
      initMhYieldHelper({
        db: STATE.db,
        trialId: STATE.trialId,
        fieldDocId: STATE.fieldDocId
      });

      // Wire any notes/mic that helper has already rendered
      wireNotesMics();

      // Watch for the helper adding/replacing content under mhStageShell
      const mhShell = document.getElementById('mhStageShell');
      if(mhShell && 'MutationObserver' in window){
        const obs = new MutationObserver(() => {
          wireNotesMics(mhShell);
        });
        obs.observe(mhShell, { childList:true, subtree:true });
      }

      // ===== Desktop-only: only "View / Add Yield" opens modal =====
      const fieldCard   = document.getElementById('devFieldCard');
      const hiddenOpen  = document.getElementById('btnOpenModal');

      if(fieldCard){
        fieldCard.addEventListener('click', (ev) => {
          const isMobile = window.matchMedia('(max-width: 640px)').matches;

          // On phones, let existing swipe / handlers work untouched
          if(isMobile) return;

          const btnHit = ev.target.closest('#btnFieldYield');
          if(btnHit && hiddenOpen){
            // Desktop: only this button opens the helper modal
            ev.preventDefault();
            ev.stopPropagation();
            hiddenOpen.click();
          }else{
            // Click anywhere else on the card: do nothing
            ev.preventDefault();
            ev.stopPropagation();
          }
        }, true); // capture so we can block other click handlers on the card
      }
      // ===== End desktop-only click control =====
    })();
  </script>
</body>
</html>
