<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista ‚Ä¢ Add Field Trial</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- ===========================
       ABSOLUTE PATHS (REQUIRED)
       =========================== -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>

  <!-- Theme + base app styles -->
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <!-- Ensure fv-shell (global header/footer/menu) -->
  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true;
        document.head.appendChild(s);
      }
    })();
  </script>

  <!-- ===========================
       PAGE CSS
       =========================== -->
  <style>
    :root{
      --card-max:1100px;
      --page-bottom-gap:96px;
      --accent:#2F6C3C;

      /* Combo vars */
      --combo-gap:4px;
      --combo-radius:12px;
      --combo-btn-radius:10px;
      --combo-shadow:0 12px 26px rgba(0,0,0,.18);
      --combo-item-pad:10px 8px;
      --combo-max-h:50vh;
    }
    body{ background:var(--app-bg,var(--surface)); }

    .wrap{
      max-width:var(--card-max);
      margin:0 auto;
      padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + var(--page-bottom-gap))!important;
    }

    /* HERO WITH HEADER */
    .hero{
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));
      overflow:hidden;
      margin-bottom:18px;
    }
    .hero-head{
      display:grid;
      grid-template-columns:32px 1fr;
      gap:12px;
      align-items:center;
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);
    }
    .hero-head .icon{
      width:28px;height:28px;
      color:var(--accent);
      display:grid;place-items:center;
      font-size:22px;
    }
    .hero-head-main h1{
      margin:0;
      font-size:clamp(20px,3.2vw,26px);
      line-height:1.2;
    }
    .muted{color:var(--muted,#67706B);margin:4px 0 0;font-size:14px}

    /* BACK BUTTON (matches other pages) */
    .back-link{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 16px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--card-surface,var(--surface));
      font-size:15px;
      font-weight:700;
      cursor:pointer;
      white-space:nowrap;
      box-shadow:0 8px 18px rgba(0,0,0,.05);
    }
    .back-link span[aria-hidden="true"]{
      font-size:18px;
      transform:translateY(-1px);
    }
    .back-row{
      margin-bottom:12px;
    }

    @media (max-width:720px){
      .hero-head{
        grid-template-columns:32px 1fr;
        align-items:flex-start;
      }
      .back-link{
        width:auto;
      }
    }

    .body{padding:16px;display:grid;gap:14px}

    .row{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    @media (max-width:880px){.row{grid-template-columns:1fr}}

    .field{position:relative}
    .field label{display:block;font-weight:800;margin:0 0 6px}

    .input,.select,.textarea,.buttonish{
      width:100%;
      font:inherit;
      font-size:16px;
      color:var(--text);
      background:var(--card-surface,var(--surface));
      border:1px solid var(--border);
      border-radius:10px;
      padding:12px;
      outline:none;
    }
    .select{padding-right:36px}
    .textarea{min-height:110px;resize:vertical}
    .help{font-size:13px;color:var(--muted,#67706B);margin-top:6px}

    .actions{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:6px;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:160px;
      padding:12px 16px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--card-surface,var(--surface));
      font-weight:800;
      color:var(--text)!important;
      cursor:pointer;
    }
    .btn-primary{
      border-color:transparent;
      background:#2F6C3C;
      color:#fff!important;
    }
    .btn-ghost{
      background:transparent;
    }
    .btn-small{
      min-width:0;
      font-size:14px;
      padding:8px 12px;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:calc(env(safe-area-inset-bottom,0px) + 72px);
      transform:translateX(-50%);
      background:#2F6C3C;
      color:#fff;
      padding:10px 14px;
      border-radius:10px;
      box-shadow:0 6px 20px rgba(0,0,0,.25);
      z-index:99999;
      display:none;
    }
    .toast.show{display:block;animation:fadeout 5s forwards}
    @keyframes fadeout{
      0%{opacity:1}
      85%{opacity:1}
      100%{opacity:0}
    }

    .error{color:#b00020;font-weight:700}

    /* Trial fields section card */
    .trial-section{
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.04));
      padding:16px;
      display:grid;
      gap:14px;
      margin-bottom:var(--page-bottom-gap);
    }
    .trial-section-head{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
    }
    .trial-section-head h2{
      margin:0;
      font-size:18px;
    }
    .trial-section-head p{
      margin:4px 0 0;
      font-size:13px;
      color:var(--muted,#67706B);
    }

    .trial-fields-list{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:4px;
    }
    .trial-field-pill{
      border-radius:999px;
      border:1px solid var(--border);
      padding:8px 10px 8px 12px;
      display:flex;
      align-items:center;
      gap:8px;
      background:var(--card-surface,var(--surface));
      font-size:14px;
      flex-wrap:wrap;
    }
    .trial-field-text{
      flex:1 1 auto;
      min-width:0;
    }
    .trial-field-main{
      font-weight:700;
      margin:0;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .trial-field-sub{
      margin:0;
      font-size:12px;
      color:var(--muted,#67706B);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pill-remove{
      border-radius:999px;
      border:1px solid var(--border);
      background:transparent;
      padding:4px 10px;
      font-size:12px;
      cursor:pointer;
      flex:0 0 auto;
    }

    /* ======================
       Combo styles
       ====================== */
    .buttonish{
      cursor:pointer;
      text-align:left;
      position:relative;
      padding-right:42px;
      border-radius:var(--combo-btn-radius);
    }
    .buttonish.has-caret::after{
      content:"";
      position:absolute;
      right:14px;
      top:50%;
      width:0;height:0;
      border-left:6px solid transparent;
      border-right:6px solid transparent;
      border-top:7px solid var(--muted,#67706B);
      transform:translateY(-50%);
      pointer-events:none;
    }

    .combo{position:relative}
    .combo .combo-anchor{
      position:relative;
      display:inline-block;
      width:100%;
    }
    .combo-panel{
      position:absolute;
      left:0;right:0;
      top:calc(100% + var(--combo-gap));
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--combo-radius);
      box-shadow:var(--combo-shadow);
      z-index:9999;
      padding:8px;
      display:none;
    }
    .combo-panel.show{display:block}
    .combo-panel .search{
      padding:4px 2px 8px;
    }
    .combo-panel .search input{
      width:100%;
      padding:10px;
      border:1px solid var(--border);
      border-radius:var(--combo-btn-radius);
      font:inherit;
      font-size:15px;
    }
    .combo-panel .list{
      max-height:var(--combo-max-h);
      overflow:auto;
      border-top:1px solid var(--border);
    }
    .combo-item{
      padding:var(--combo-item-pad);
      border-bottom:1px solid var(--border);
      cursor:pointer;
    }
    .combo-item:hover{
      background:rgba(0,0,0,.04);
    }
    .combo-item:last-child{border-bottom:none}
    .combo-empty{
      padding:var(--combo-item-pad);
      color:#67706B;
    }
  </style>
</head>

<body>
  <fv-shell>
    <div class="wrap">
      <!-- HERO: trial header -->
      <section class="hero">
        <header class="hero-head">
          <div class="icon" aria-hidden="true">üß™</div>
          <div class="hero-head-main">
            <h1>Add Field / Product Trial</h1>
            <p id="heroSub" class="muted">
              Set crop year, crop, and trial type, then attach all participating fields below.
            </p>
          </div>
        </header>

        <div class="body">
          <!-- Back button row -->
          <div class="back-row">
            <button class="back-link" type="button"
              onclick="window.location.href='/Farm-vista/pages/crop-production/crop-trials.html'">
              <span aria-hidden="true">‚Üê</span>
              <span>Back to Trials</span>
            </button>
          </div>

          <!-- Crop year / Crop -->
          <div class="row">
            <div class="field combo" id="yearCombo">
              <label for="yearBtn">Crop Year</label>
              <div class="combo-anchor">
                <button id="yearBtn" class="buttonish has-caret" type="button">‚Äî Select year ‚Äî</button>
                <div class="combo-panel" id="yearPanel" role="listbox" aria-label="Year list">
                  <div class="list" id="yearList"></div>
                </div>
              </div>
              <div id="yearHelp" class="help">Defaulted to this crop year.</div>
            </div>

            <div class="field combo" id="cropCombo">
              <label for="cropBtn">Crop</label>
              <div class="combo-anchor">
                <button id="cropBtn" class="buttonish has-caret" type="button">‚Äî Select crop ‚Äî</button>
                <div class="combo-panel" id="cropPanel" role="listbox" aria-label="Crop list">
                  <div class="list" id="cropList"></div>
                </div>
              </div>
              <div id="cropHelp" class="help">Corn, soybeans, wheat, etc.</div>
            </div>
          </div>

          <!-- Operation Task / Trial Name -->
          <div class="row">
            <div class="field combo" id="opTaskCombo">
              <label for="opTaskBtn">Operation Task</label>
              <div class="combo-anchor">
                <button id="opTaskBtn" class="buttonish has-caret" type="button">‚Äî Select task ‚Äî</button>
                <div class="combo-panel" id="opTaskPanel" role="listbox" aria-label="Operation task list">
                  <div class="list" id="opTaskList"></div>
                </div>
              </div>
              <div id="opTaskHelp" class="help">
                Which operation is this trial tied to? Planting, spraying, aerial apps, or fertilizer.
              </div>
            </div>

            <div class="field">
              <label for="trialName">Trial Name / Nickname</label>
              <input id="trialName" class="input" placeholder="e.g. Blueprint 2026 Corn Large-Scale Trial">
              <div class="help">Short label you‚Äôll recognize on reports and maps.</div>
            </div>
          </div>

          <!-- Trial type -->
          <div class="row">
            <div class="field combo" id="typeCombo">
              <label for="typeBtn">Trial Type</label>
              <div class="combo-anchor">
                <button id="typeBtn" class="buttonish has-caret" type="button">‚Äî Select type ‚Äî</button>
                <div class="combo-panel" id="typePanel" role="listbox" aria-label="Trial type list">
                  <div class="list" id="typeList"></div>
                </div>
              </div>
              <div id="typeHelp" class="help">Seed, fungicide, biological, fertility, etc.</div>
            </div>
          </div>

          <!-- Treatment / Check -->
          <div class="row">
            <div class="field">
              <label for="treatmentName">Treatment / Product</label>
              <input id="treatmentName" class="input" placeholder="e.g. Blueprint 1742Q + $80 fungicide program">
              <div class="help">What is being tested? Product, rate, timing, or full program.</div>
            </div>

            <div class="field">
              <label for="checkDesc">Check / Comparison</label>
              <input id="checkDesc" class="input" placeholder="e.g. Standard 1742Q, no fungicide">
              <div class="help">What is the baseline you‚Äôll compare against?</div>
            </div>
          </div>

          <!-- Notes -->
          <div class="field">
            <label for="notes">Trial-Level Notes</label>
            <textarea id="notes" class="textarea"
                      placeholder="Overall setup, strip design, planter/boom, planned timings, etc."></textarea>
          </div>

          <!-- Files -->
          <div class="field">
            <label for="files">Optional Files / Photos</label>
            <input id="files" class="input" type="file"
                   accept="image/*,.jpg,.jpeg,.png,.heic,.pdf" multiple>
            <div id="fileHelp" class="help">
              Attach maps, aerial photos, or setup pictures for the overall trial.
            </div>
          </div>

          <div id="err" class="help error" hidden></div>

          <div class="actions">
            <button id="btnClear" class="btn btn-ghost" type="button">Clear</button>
            <button id="btnSave" class="btn btn-primary" type="button">Save Trial</button>
          </div>
          <div class="help">
            ‚ÄúSave Trial‚Äù will save the trial header and <strong>all fields listed below</strong> in one step.
          </div>
        </div>
      </section>

      <!-- TRIAL FIELDS SECTION (multi-field support) -->
      <section class="trial-section">
        <div class="trial-section-head">
          <div>
            <h2>Fields in This Trial</h2>
            <p>
              Add every farm + field where this trial runs. Later, harvest and operation records
              can tie back to these trial fields.
            </p>
          </div>
        </div>

        <!-- Add field form -->
        <div class="row">
          <div class="field combo" id="farmCombo">
            <label for="farmBtn">Farm</label>
            <div class="combo-anchor">
              <button id="farmBtn" class="buttonish has-caret" type="button">‚Äî Select farm ‚Äî</button>
              <div class="combo-panel" id="farmPanel" role="listbox" aria-label="Farm list">
                <div class="search">
                  <input id="farmSearch" type="search" placeholder="Search farms‚Ä¶">
                </div>
                <div class="list" id="farmList"></div>
              </div>
            </div>
            <div id="farmHelp" class="help">Choose a farm to filter fields (optional).</div>
          </div>

          <div class="field combo" id="fieldCombo">
            <label for="fieldBtn">Field</label>
            <div class="combo-anchor">
              <button id="fieldBtn" class="buttonish has-caret" type="button">‚Äî Select field ‚Äî</button>
              <div class="combo-panel" id="fieldPanel" role="listbox" aria-label="Field list">
                <div class="search">
                  <input id="fieldSearch" type="search" placeholder="Search fields‚Ä¶">
                </div>
                <div class="list" id="fieldList"></div>
              </div>
            </div>
            <div id="fieldHelp" class="help">478 field(s) loaded.</div>
          </div>
        </div>

        <div class="row">
          <!-- Variety / Hybrid is for the trial product on this field -->
          <div class="field combo" id="varietyCombo">
            <label for="tfVarietyBtn">Variety / Hybrid (for this trial)</label>
            <div class="combo-anchor">
              <button id="tfVarietyBtn" class="buttonish has-caret" type="button">‚Äî Select variety ‚Äî</button>
              <div class="combo-panel" id="tfVarietyPanel" role="listbox" aria-label="Seed varieties list">
                <div class="search">
                  <input id="tfVarietySearch" type="search" placeholder="Search varieties‚Ä¶">
                </div>
                <div class="list" id="tfVarietyList"></div>
              </div>
            </div>
            <div id="tfVarietyHelp" class="help">
              Which variety of the trial product is used on this field?
            </div>
          </div>

          <div class="field">
            <label for="tfPlacement">Placement / Application (of trial product)</label>
            <select id="tfPlacement" class="select">
              <option value="">‚Äî Select placement ‚Äî</option>
              <option value="ON_SEED">On seed</option>
              <option value="IN_FURROW">In-furrow</option>
              <option value="FOLIAR_VT_R1">Foliar VT / R1</option>
              <option value="SIDEDRESS">Side-dress / Y-drop</option>
              <option value="OTHER">Other / mixed program</option>
            </select>
            <div class="help">For the trial product, note if it‚Äôs on-seed vs in-furrow vs foliar, etc.</div>
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label for="tfPlantDate">Planting Date (for this field)</label>
            <input id="tfPlantDate" class="input" type="date">
            <div class="help">When this trial crop was planted on this field.</div>
          </div>

          <div class="field">
            <label for="tfFieldNotes">Field-Specific Notes</label>
            <input id="tfFieldNotes" class="input"
                   placeholder="Pop, strips, passes, planter row set, etc.">
            <div class="help">Any notes that only apply to this farm + field combo.</div>
          </div>
        </div>

        <!-- Trial acres in this field -->
        <div class="row">
          <div class="field">
            <label for="tfTrialAcres">Trial Acres in This Field</label>
            <input id="tfTrialAcres" class="input" type="number" min="0" step="0.01"
                   placeholder="e.g. 12.5">
            <div id="tfTrialAcresHelp" class="help">
              Acres of this field that are actually in the trial (not total field acres).
            </div>
          </div>
        </div>

        <div class="actions">
          <button id="btnAddField" type="button" class="btn btn-small btn-primary">
            + Add Field to Trial
          </button>
        </div>

        <!-- List of fields already attached -->
        <div id="trialFieldsList" class="trial-fields-list">
          <p class="help">No fields added yet. Add each farm + field where this trial will run.</p>
        </div>
      </section>
    </div>
  </fv-shell>

  <div id="toast" class="toast" role="status" aria-live="polite">Saved.</div>

  <!-- ===========================
       JS: Firebase + Combos
       =========================== -->
  <script type="module">
    import {
      ready,
      getFirestore, getAuth,
      collection, getDocs, addDoc, doc, updateDoc,
      serverTimestamp, query, orderBy
    } from '/Farm-vista/js/firebase-init.js';

    const $  = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    const state = {
      farm:null,
      field:null,
      year:null,
      crop:null,
      type:null,
      operationTask:null,   // planting / spraying / aerial / fertilizer
      seedProduct:null,     // selected seed product for this field
      trialFields:[]
    };

    let allFarms = [];
    let allFields = [];
    let allSeedProducts = [];

    function showToast(msg="Saved.", ms=5000){
      const t=$(" #toast ".trim()) || document.getElementById("toast");
      t.textContent=msg;
      t.classList.remove("show");
      void t.offsetWidth;
      t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"), ms);
    }
    function showError(msg){
      const e = $("#err");
      e.textContent = msg || "";
      e.hidden = !msg;
    }

    function updateHeroSubtitle(){
      const el = $("#heroSub");
      if(!el) return;
      const parts = [];
      if(state.year) parts.push(state.year.label);
      if(state.crop) parts.push(state.crop.label);
      if(state.type) parts.push(state.type.label);
      if(parts.length){
        el.textContent = parts.join(" ‚Ä¢ ");
      }else{
        el.textContent = "Set crop year, crop, and trial type, then attach all participating fields below.";
      }
    }

    /* =========================
       Lazy Storage loader
       ========================= */
    async function loadStorageFns(){
      const m = await import('/Farm-vista/js/firebase-init.js');
      const fns = {
        getStorage:m.getStorage,
        ref:m.ref,
        uploadBytes:m.uploadBytes,
        getDownloadURL:m.getDownloadURL
      };
      if (fns.getStorage && fns.ref && fns.uploadBytes && fns.getDownloadURL) return fns;
      throw new Error('Storage exports missing in /js/firebase-init.js');
    }

    /* =========================
       Combo framework
       ========================= */
    function closeAllCombos(except=null){
      $$('.combo-panel.show').forEach(p=>{
        if(p!==except) p.classList.remove('show');
      });
    }

    document.addEventListener('click', ()=> closeAllCombos());
    document.addEventListener('keydown', e=>{
      if(e.key === 'Escape') closeAllCombos();
    });

    function makeCombo({ btn, panel, list, items=[], searchable=false, formatter=x=>String(x?.label??x), onPick }){
      panel.addEventListener('click', e=> e.stopPropagation());
      panel.addEventListener('mousedown', e=> e.stopPropagation());

      let _items = Array.isArray(items) ? items.slice() : [];

      function render(q=""){
        const qq = (q||"").toLowerCase();
        const filtered = _items.filter(x=>{
          const label = formatter(x).toLowerCase();
          return !qq || label.includes(qq);
        });
        list.innerHTML = filtered.length
          ? filtered.map(x=>`<div class="combo-item" data-id="${String(x.id)}">${formatter(x)}</div>`).join('')
          : '<div class="combo-empty">(no matches)</div>';
      }

      function open(){
        closeAllCombos(panel);
        panel.classList.add('show');
        render("");
        if(searchable){
          const inp = panel.querySelector('input');
          if(inp){ inp.value=""; inp.focus(); }
        }
      }
      function close(){ panel.classList.remove('show'); }

      btn.addEventListener('click', e=>{
        e.stopPropagation();
        panel.classList.contains('show') ? close() : open();
      });

      list.addEventListener('mousedown', e=>{
        const row = e.target.closest('.combo-item');
        if(!row) return;
        const id = row.dataset.id;
        const it = _items.find(x=>String(x.id)===id);
        if(!it) return;
        onPick?.(it);
        close();
      });

      if(searchable){
        const s = panel.querySelector('input');
        if(s) s.addEventListener('input', e=> render(e.target.value));
      }

      return {
        setItems(arr){
          _items = Array.isArray(arr) ? arr.slice() : [];
          render("");
        },
        open, close
      };
    }

    /* =========================
       Farm / Field helpers (bi-directional like maintenance-add)
       ========================= */
    function selectFarmById(farmId){
      if(!farmId) return;
      const farm = allFarms.find(f=>f.id === farmId);
      if(!farm) return;
      state.farm = farm;
      const btn = $("#farmBtn");
      if(btn) btn.textContent = farm.label;
      const help = $("#farmHelp");
      if(help) help.textContent = "Farm selected for this trial field.";
    }

    function resetTrialAcresHelp(){
      const h = $("#tfTrialAcresHelp");
      if(h){
        h.textContent = "Acres of this field that are actually in the trial (not total field acres).";
      }
    }

    function refreshFieldComboForFarm(farmId){
      let list = allFields.slice();
      const fieldHelp = $("#fieldHelp");

      if(farmId){
        list = list.filter(f=>f.farmId === farmId);
        if(fieldHelp){
          fieldHelp.textContent = list.length
            ? `${list.length} field(s) on this farm.`
            : "No fields found for this farm.";
        }
      }else{
        if(fieldHelp){
          fieldHelp.textContent = list.length
            ? `${list.length} field(s) loaded.`
            : "No fields found.";
        }
      }

      fieldCombo.setItems(list);

      // If the current field belongs to a different farm, clear it
      if(state.field && farmId && state.field.farmId !== farmId){
        state.field = null;
        const fb = $("#fieldBtn");
        if(fb) fb.textContent = "‚Äî Select field ‚Äî";
        resetTrialAcresHelp();
      }
    }

    function updateTrialAcresHelpForField(fieldObj){
      const h = $("#tfTrialAcresHelp");
      if(!h) return;

      const ac = (fieldObj && typeof fieldObj.acres === "number" && !Number.isNaN(fieldObj.acres))
        ? fieldObj.acres
        : null;

      if(ac != null){
        const acText = ac.toLocaleString(undefined,{maximumFractionDigits:2});
        h.textContent =
          `Acres of this field that are actually in the trial (not total field acres). ` +
          `Field total: ${acText} ac (trial acres cannot exceed this).`;
      }else{
        resetTrialAcresHelp();
      }
    }

    /* =========================
       Farm / Field / Variety combos for trial fields
       ========================= */
    const farmCombo = makeCombo({
      btn:  $("#farmBtn"),
      panel:$("#farmPanel"),
      list: $("#farmList"),
      items: [],
      searchable:true,
      formatter:x=>x.label,
      onPick(it){
        // Match maintenance-add behavior: set farm and filter fields for that farm
        selectFarmById(it.id);
        refreshFieldComboForFarm(it.id);
      }
    });

    const fieldCombo = makeCombo({
      btn:  $("#fieldBtn"),
      panel:$("#fieldPanel"),
      list: $("#fieldList"),
      items: [],
      searchable:true,
      formatter:x=>x.label,
      onPick(it){
        state.field = it;
        $("#fieldBtn").textContent = it.label;
        $("#fieldHelp").textContent = "Field selected for this trial.";

        // Back-flow farm selection like maintenance-add
        if(it.farmId){
          selectFarmById(it.farmId);
          refreshFieldComboForFarm(it.farmId);
        }

        // Update trial acres help with field's total acres
        updateTrialAcresHelpForField(it);
      }
    });

    const varietyCombo = makeCombo({
      btn:  $("#tfVarietyBtn"),
      panel:$("#tfVarietyPanel"),
      list: $("#tfVarietyList"),
      items: [],
      searchable:true,
      formatter:x=>x.label,
      onPick(it){
        state.seedProduct = it;
        $("#tfVarietyBtn").textContent = it.label;
        const h = $("#tfVarietyHelp");
        if(h) h.textContent = "Variety selected for this trial field.";
      }
    });

    function applyVarietyFilter(){
      const cropCode = state.crop?.value || null; // 'CORN', 'SOY', etc.
      let filtered = allSeedProducts.slice();
      if(cropCode){
        filtered = filtered.filter(p => p.cropCode === cropCode);
      }
      varietyCombo.setItems(filtered);

      const help = $("#tfVarietyHelp");
      if(help){
        if(filtered.length){
          help.textContent = cropCode
            ? `Choose from ${filtered.length} seed products for this crop.`
            : `Choose from ${filtered.length} seed products.`;
        }else{
          help.textContent = cropCode
            ? "No seed products found for this crop."
            : "No seed products found.";
        }
      }

      state.seedProduct = null;
      $("#tfVarietyBtn").textContent = "‚Äî Select variety ‚Äî";
    }

    async function loadFarmsAndFields(db){
      const farmHelp = $("#farmHelp");
      const fieldHelp = $("#fieldHelp");

      try{
        // Farms
        farmHelp.textContent = "Loading farms‚Ä¶";
        let farms = [];
        try{
          const snap = await getDocs(query(collection(db,'farms'), orderBy('name')));
          snap.forEach(d=>{
            const x = d.data() || {};
            const name = String(x.name || x.farmName || "").trim();
            if(name) farms.push({ id:d.id, label:name });
          });
        }catch(e){
          console.warn("Farm indexed query failed, falling back:", e.message);
          const snap = await getDocs(collection(db,'farms'));
          snap.forEach(d=>{
            const x = d.data() || {};
            const name = String(x.name || x.farmName || "").trim();
            if(name) farms.push({ id:d.id, label:name });
          });
        }
        farms.sort((a,b)=>a.label.localeCompare(b.label));
        allFarms = farms;
        farmCombo.setItems(allFarms);
        farmHelp.textContent = farms.length ? `${farms.length} farm(s) loaded.` : "No farms found.";

        // Fields
        fieldHelp.textContent = "Loading fields‚Ä¶";
        let fields = [];
        try{
          const snap = await getDocs(query(collection(db,'fields'), orderBy('name')));
          snap.forEach(d=>{
            const x = d.data() || {};
            const name = String(x.name || x.fieldName || "").trim();
            const farmId = x.farmId || x.farm || null;

            // Try to infer total acres from common field keys
            let totalAcres = null;
            const candidates = [
              x.tillableAcres,
              x.totalAcres,
              x.fieldAcres,
              x.acres
            ];
            for(const c of candidates){
              if(typeof c === "number"){
                totalAcres = c;
                break;
              }
              if(typeof c === "string" && c.trim()){
                const n = Number(c);
                if(!Number.isNaN(n)){
                  totalAcres = n;
                  break;
                }
              }
            }

            if(name) fields.push({
              id: d.id,
              label: name,
              farmId: farmId || null,
              acres: totalAcres
            });
          });
        }catch(e){
          console.warn("Field indexed query failed, falling back:", e.message);
          const snap = await getDocs(collection(db,'fields'));
          snap.forEach(d=>{
            const x = d.data() || {};
            const name = String(x.name || x.fieldName || "").trim();
            const farmId = x.farmId || x.farm || null;

            let totalAcres = null;
            const candidates = [
              x.tillableAcres,
              x.totalAcres,
              x.fieldAcres,
              x.acres
            ];
            for(const c of candidates){
              if(typeof c === "number"){
                totalAcres = c;
                break;
              }
              if(typeof c === "string" && c.trim()){
                const n = Number(c);
                if(!Number.isNaN(n)){
                  totalAcres = n;
                  break;
                }
              }
            }

            if(name) fields.push({
              id: d.id,
              label: name,
              farmId: farmId || null,
              acres: totalAcres
            });
          });
        }
        fields.sort((a,b)=>a.label.localeCompare(b.label));
        allFields = fields;

        // Initial field list (no farm filter yet)
        fieldCombo.setItems(allFields);
        fieldHelp.textContent = allFields.length ? `${allFields.length} field(s) loaded.` : "No fields found.";
      }catch(err){
        console.error(err);
        farmHelp.textContent = "Failed to load farms.";
        fieldHelp.textContent = "Failed to load fields.";
        showError(`Error loading farms/fields: ${err.message}`);
      }
    }

    /* =========================
       Seed products (productsSeed) for variety dropdown
       ========================= */
    function formatSeedLabel(x){
      const brand = String(x.brand || "").trim();
      const variety = String(x.variety || "").trim();
      const traitLabel = String(x.traitLabel || x.trait || "").trim();

      const parts = [];
      if(brand) parts.push(brand);
      if(variety) parts.push(variety);
      let label = parts.join(" ");
      if(traitLabel) label += ` (${traitLabel})`;
      return label || "Unnamed seed product";
    }

    async function loadSeedProducts(db){
      const help = $("#tfVarietyHelp");
      if(help) help.textContent = "Loading seed products‚Ä¶";

      try{
        let items = [];
        try{
          const snap = await getDocs(query(collection(db,'productsSeed')));
          snap.forEach(d=>{
            const x = d.data() || {};
            const cropCode =
              x.cropCorn ? 'CORN' :
              x.cropSoy  ? 'SOY'  :
              String(x.crop || "").toUpperCase() || 'OTHER';

            const label = formatSeedLabel(x);

            items.push({
              id:d.id,
              label,
              varietyLabel: label,
              cropCode,
              rawCrop: x.crop || null,
              brand: x.brand || null,
              variety: x.variety || null,
              maturity: x.maturity || null,
              trait: x.trait || null,
              traitLabel: x.traitLabel || null
            });
          });
        }catch(e){
          console.error("productsSeed query failed:", e);
          const snap = await getDocs(collection(db,'productsSeed'));
          snap.forEach(d=>{
            const x = d.data() || {};
            const cropCode =
              x.cropCorn ? 'CORN' :
              x.cropSoy  ? 'SOY'  :
              String(x.crop || "").toUpperCase() || 'OTHER';
            const label = formatSeedLabel(x);
            items.push({
              id:d.id,
              label,
              varietyLabel: label,
              cropCode,
              rawCrop: x.crop || null,
              brand: x.brand || null,
              variety: x.variety || null,
              maturity: x.maturity || null,
              trait: x.trait || null,
              traitLabel: x.traitLabel || null
            });
          });
        }

        items.sort((a,b)=>a.label.localeCompare(b.label));
        allSeedProducts = items;
        applyVarietyFilter();
      }catch(err){
        console.error(err);
        if(help) help.textContent = "Failed to load seed products.";
      }
    }

    /* =========================
       Static combos: Year / Crop / Type / Operation Task
       ========================= */
    const yearCombo = makeCombo({
      btn:  $("#yearBtn"),
      panel:$("#yearPanel"),
      list: $("#yearList"),
      items: [],
      searchable:false,
      formatter:x=>x.label,
      onPick(it){
        state.year = it;
        $("#yearBtn").textContent = it.label;
        $("#yearHelp").textContent = "Crop year selected.";
        updateHeroSubtitle();
      }
    });

    const cropCombo = makeCombo({
      btn:  $("#cropBtn"),
      panel:$("#cropPanel"),
      list: $("#cropList"),
      items: [],
      searchable:false,
      formatter:x=>x.label,
      onPick(it){
        state.crop = it;
        $("#cropBtn").textContent = it.label;
        $("#cropHelp").textContent = "Crop selected.";
        updateHeroSubtitle();
        applyVarietyFilter(); // re-filter seed products by crop
      }
    });

    const typeCombo = makeCombo({
      btn:  $("#typeBtn"),
      panel:$("#typePanel"),
      list: $("#typeList"),
      items: [],
      searchable:false,
      formatter:x=>x.label,
      onPick(it){
        state.type = it;
        $("#typeBtn").textContent = it.label;
        $("#typeHelp").textContent = "Trial type selected.";
        updateHeroSubtitle();
      }
    });

    const opTaskCombo = makeCombo({
      btn:  $("#opTaskBtn"),
      panel:$("#opTaskPanel"),
      list: $("#opTaskList"),
      items: [],
      searchable:false,
      formatter:x=>x.label,
      onPick(it){
        state.operationTask = it;
        $("#opTaskBtn").textContent = it.label;
        const h = $("#opTaskHelp");
        if(h) h.textContent = "Operation task selected for this trial.";
      }
    });

    function initStaticCombos(){
      const y = new Date().getFullYear();
      const years = [y-1, y, y+1].map(v=>({
        id:String(v),
        label:String(v),
        value:v
      }));
      yearCombo.setItems(years);
      const thisYear = years.find(x=>x.value===y) || years[1] || years[0];
      if(thisYear){
        state.year = thisYear;
        $("#yearBtn").textContent = thisYear.label;
        $("#yearHelp").textContent = "Defaulted to this crop year.";
      }

      const crops = [
        { id:'corn',      label:'Corn',      value:'CORN' },
        { id:'soybeans',  label:'Soybeans',  value:'SOY' },
        { id:'wheat',     label:'Wheat',     value:'WHEAT' },
        { id:'sorghum',   label:'Sorghum',   value:'SORGHUM' },
        { id:'other',     label:'Other',     value:'OTHER' }
      ];
      cropCombo.setItems(crops);

      const types = [
        { id:'seed',       label:'Seed / Hybrid / Variety', value:'SEED' },
        { id:'fungicide',  label:'Fungicide Program',       value:'FUNGICIDE' },
        { id:'fertility',  label:'Fertility / Nutrient',    value:'FERTILITY' },
        { id:'biological', label:'Biological / Additive',   value:'BIOLOGICAL' },
        { id:'other',      label:'Other',                   value:'OTHER' }
      ];
      typeCombo.setItems(types);

      const tasks = [
        { id:'planting',   label:'Planting',            value:'PLANTING' },
        { id:'spraying',   label:'Spraying',            value:'SPRAYING' },
        { id:'aerial',     label:'Aerial Application',  value:'AERIAL_APP' },
        { id:'fertilizer', label:'Fertilizer',          value:'FERTILIZER' },
        { id:'other',      label:'Other Operation',     value:'OTHER' }
      ];
      opTaskCombo.setItems(tasks);

      updateHeroSubtitle();
    }

    /* =========================
       Trial fields list helpers
       ========================= */
    function renderTrialFieldsList(){
      const listEl = $("#trialFieldsList");
      if(!listEl) return;
      if(!state.trialFields.length){
        listEl.innerHTML = '<p class="help">No fields added yet. Add each farm + field where this trial will run.</p>';
        return;
      }
      listEl.innerHTML = state.trialFields.map(f=>`
        <div class="trial-field-pill">
          <div class="trial-field-text">
            <p class="trial-field-main">${f.farmName} ‚Ä¢ ${f.fieldName}</p>
            <p class="trial-field-sub">
              ${f.variety ? f.variety + ' ‚Ä¢ ' : ''}
              ${f.placementLabel || ''}
              ${f.plantingDate ? ' ‚Ä¢ Planted ' + f.plantingDate : ''}
              ${f.trialAcres ? ' ‚Ä¢ ' + f.trialAcres + ' ac' : ''}
            </p>
          </div>
          <button type="button" class="pill-remove" data-id="${f.id}">Remove</button>
        </div>
      `).join("");
    }

    function handleAddFieldToTrial(){
      showError("");

      if(!state.farm){
        showError("Select a farm before adding a trial field.");
        return;
      }
      if(!state.field){
        showError("Select a field before adding a trial field.");
        return;
      }

      const placement = ($("#tfPlacement").value || "").trim();
      const plantDate = ($("#tfPlantDate").value || "").trim();
      const notes     = ($("#tfFieldNotes").value || "").trim();
      const trialAcresRaw = ($("#tfTrialAcres").value || "").trim();

      let trialAcresNum = null;
      const totalAcres = (state.field && typeof state.field.acres === "number" && !Number.isNaN(state.field.acres))
        ? state.field.acres
        : null;

      if(trialAcresRaw){
        const val = Number(trialAcresRaw);
        if(Number.isNaN(val) || val <= 0){
          showError("Trial acres must be a positive number.");
          return;
        }
        if(totalAcres != null && val > totalAcres + 0.0001){
          const t = val.toLocaleString(undefined,{maximumFractionDigits:2});
          const f = totalAcres.toLocaleString(undefined,{maximumFractionDigits:2});
          showError(`Trial acres (${t} ac) cannot exceed field acres (${f} ac).`);
          return;
        }
        trialAcresNum = val;
      }

      const placementLabel = (()=> {
        const sel = $("#tfPlacement");
        if(!sel) return "";
        const opt = sel.options[sel.selectedIndex];
        return opt && opt.value ? opt.textContent.trim() : "";
      })();

      const seed = state.seedProduct || null;

      const id = 'loc_' + Date.now() + '_' + Math.random().toString(36).slice(2,7);

      state.trialFields.push({
        id,
        farmId: state.farm.id,
        farmName: state.farm.label,
        fieldId: state.field.id,
        fieldName: state.field.label,

        // Seed details from productsSeed (if selected)
        seedProductId: seed ? seed.id : null,
        variety: seed ? (seed.varietyLabel || seed.variety || seed.label) : null,
        seedBrand: seed ? (seed.brand || null) : null,
        seedTrait: seed ? (seed.traitLabel || seed.trait || null) : null,
        seedMaturity: seed ? (seed.maturity || null) : null,

        placement: placement || null,
        placementLabel: placementLabel || null,
        plantingDate: plantDate || null,
        notes: notes || null,
        trialAcres: (trialAcresNum && !Number.isNaN(trialAcresNum)) ? trialAcresNum : null
      });

      // Reset draft field inputs
      state.farm = null;
      state.field = null;
      state.seedProduct = null;
      $("#farmBtn").textContent = "‚Äî Select farm ‚Äî";
      $("#fieldBtn").textContent = "‚Äî Select field ‚Äî";
      $("#tfVarietyBtn").textContent = "‚Äî Select variety ‚Äî";
      $("#tfPlacement").value = "";
      $("#tfPlantDate").value = "";
      $("#tfFieldNotes").value = "";
      $("#tfTrialAcres").value = "";
      $("#farmHelp").textContent = "Choose a farm to filter fields (optional).";
      $("#fieldHelp").textContent = allFields.length
        ? `${allFields.length} field(s) loaded.`
        : "No fields found.";
      resetTrialAcresHelp();
      const vHelp = $("#tfVarietyHelp");
      if(vHelp){
        vHelp.textContent = allSeedProducts.length
          ? "Which variety of the trial product is used on this field?"
          : "No seed products found.";
      }

      renderTrialFieldsList();
    }

    $("#trialFieldsList")?.addEventListener("click", e=>{
      const btn = e.target.closest(".pill-remove");
      if(!btn) return;
      const id = btn.dataset.id;
      state.trialFields = state.trialFields.filter(f=>f.id !== id);
      renderTrialFieldsList();
    });

    /* =========================
       Save handler
       ========================= */
    async function handleSave(db, auth, ctx){
      showError("");

      const trialName     = ($("#trialName").value || "").trim();
      const treatmentName = ($("#treatmentName").value || "").trim();
      const checkDesc     = ($("#checkDesc").value || "").trim();
      const notes         = ($("#notes").value || "").trim();

      if(!state.year){ showError("Please choose a crop year."); return; }
      if(!state.crop){ showError("Please choose a crop."); return; }
      if(!state.type){ showError("Please choose a trial type."); return; }
      if(!trialName){ showError("Please enter a trial name or nickname."); return; }
      if(!state.trialFields.length){
        showError("Add at least one farm + field to this trial before saving.");
        return;
      }

      const user = auth.currentUser || {};
      const docData = {
        accountId: ctx?.accountId || null,

        cropYear: state.year?.value || null,
        cropYearLabel: state.year?.label || null,
        cropCode: state.crop?.value || null,
        cropLabel: state.crop?.label || null,
        trialType: state.type?.value || null,
        trialTypeLabel: state.type?.label || null,

        operationTaskCode: state.operationTask?.value || null,
        operationTaskLabel: state.operationTask?.label || null,

        trialName,
        treatmentName,
        checkDescription: checkDesc,
        notes,
        status: 'planned',

        fieldCount: state.trialFields.length,
        fields: state.trialFields.map(f=>({
          farmId: f.farmId,
          farmName: f.farmName,
          fieldId: f.fieldId,
          fieldName: f.fieldName,

          seedProductId: f.seedProductId || null,
          variety: f.variety || null,
          seedBrand: f.seedBrand || null,
          seedTrait: f.seedTrait || null,
          seedMaturity: f.seedMaturity || null,

          placement: f.placement || null,
          placementLabel: f.placementLabel || null,
          plantingDate: f.plantingDate || null,
          notes: f.notes || null,
          trialAcres: f.trialAcres || null
        })),

        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp(),
        createdBy: user.uid || null,
        createdByEmail: user.email || null
      };

      // NOTE: reusing "fieldTrials" collection as the trial header.
      const ref = await addDoc(collection(db,'fieldTrials'), docData);

      const files = Array.from(($("#files").files || []));
      if(files.length){
        try{
          const { getStorage, ref:stRef, uploadBytes, getDownloadURL } = await loadStorageFns();
          const st = getStorage();
          const uploaded = [];

          for(const f of files){
            const safe = (Date.now() + '-' + f.name).replace(/[^\w.\-]+/g,'_');
            const path = `trials/${ref.id}/${safe}`;
            const r = stRef(st, path);
            await uploadBytes(r, f, { contentType: f.type || 'application/octet-stream' });
            const url = await getDownloadURL(r);
            uploaded.push({
              name:f.name,
              url,
              path,
              size:f.size || null,
              type:f.type || null
            });
          }

          await updateDoc(doc(db,'fieldTrials',ref.id), {
            files: uploaded,
            updatedAt: serverTimestamp()
          });
        }catch(stErr){
          console.error(stErr);
          showError(`Trial saved but file upload failed: ${stErr.message}`);
        }
      }

      showToast("Trial saved.");
      // After save, send user back to Trials portal for a cleaner flow
      setTimeout(()=>{
        window.location.href = '/Farm-vista/pages/crop-production/crop-trials.html';
      }, 900);
    }

    function clearForm(){
      // Reset text inputs
      $("#trialName").value = "";
      $("#treatmentName").value = "";
      $("#checkDesc").value = "";
      $("#notes").value = "";
      $("#files").value = "";

      // Reset selections (keep year default)
      state.crop = null;
      state.type = null;
      state.operationTask = null;
      state.trialFields = [];
      state.seedProduct = null;

      $("#cropBtn").textContent = "‚Äî Select crop ‚Äî";
      $("#typeBtn").textContent = "‚Äî Select type ‚Äî";
      $("#opTaskBtn").textContent = "‚Äî Select task ‚Äî";
      $("#tfVarietyBtn").textContent = "‚Äî Select variety ‚Äî";

      // Reset trial field draft controls
      state.farm = null;
      state.field = null;
      $("#farmBtn").textContent = "‚Äî Select farm ‚Äî";
      $("#fieldBtn").textContent = "‚Äî Select field ‚Äî";
      $("#tfPlacement").value = "";
      $("#tfPlantDate").value = "";
      $("#tfFieldNotes").value = "";
      $("#tfTrialAcres").value = "";
      $("#farmHelp").textContent = "Choose a farm to filter fields (optional).";
      $("#fieldHelp").textContent = allFields.length
        ? `${allFields.length} field(s) loaded.`
        : "No fields found.";
      resetTrialAcresHelp();
      applyVarietyFilter();

      renderTrialFieldsList();
      updateHeroSubtitle();
      showError("");
    }

    /* =========================
       Boot
       ========================= */
    (async()=>{
      const ctx  = await ready;
      const db   = getFirestore();
      const auth = getAuth();
      console.log("‚úÖ Firebase Ready:", ctx.mode, auth.currentUser?.email || '(anon)');

      initStaticCombos();

      await Promise.all([
        loadFarmsAndFields(db),
        loadSeedProducts(db)
      ]);

      renderTrialFieldsList();

      $("#btnSave").addEventListener("click", ()=> handleSave(db, auth, ctx));
      $("#btnClear").addEventListener("click", ()=> clearForm());
      $("#btnAddField").addEventListener("click", handleAddFieldToTrial);

      window.addEventListener('online', ()=> showToast("Back online ‚Äî syncing‚Ä¶", 4000));
      window.addEventListener('offline',()=> showToast("Currently offline ‚Äî using saved data", 4000));
    })();

    // END MODULE
  </script>

  <!-- ===========================
       NOTES
       ===========================
       ‚Ä¢ This page treats one doc in "fieldTrials" as the TRIAL HEADER.
       ‚Ä¢ Operation Task ties the trial back to planting/spraying/aerial/fertilizer workflows.
       ‚Ä¢ Multiple fields are stored as an embedded "fields" array with farm/field IDs.
       ‚Ä¢ Each field now tracks seed product, placement, planting date, notes,
         and trialAcres for that field.
       ‚Ä¢ Trial acres are validated so they cannot exceed the field‚Äôs total acres (when known).
       ‚Ä¢ Seed products: loaded from "productsSeed", filtered by cropCorn/cropSoy.
       ‚Ä¢ File storage path: trials/{trialId}/{filename}.
       ‚Ä¢ After save, user is returned to the Trials Portal for a cleaner flow.
  -->
</body>
</html>
