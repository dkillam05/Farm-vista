<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FarmVista ‚Ä¢ Edit Field Trials</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#3B7E46" />

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest" />
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png" />
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png" />
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css" />
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css" />

  <style>
    :root{
      --card-max: 1200px;
      --page-bottom-gap: 96px;
      --accent: #2F6C3C;

      --combo-gap:4px;
      --combo-radius:12px;
      --combo-btn-radius:10px;
      --combo-shadow:0 12px 26px rgba(0,0,0,.18);
      --combo-item-pad:10px 8px;
      --combo-max-h:50vh;
    }

    html{-webkit-text-size-adjust:100%}
    body{
      background: var(--app-bg, var(--surface));
      overflow-x:hidden;
    }

    .wrap{
      max-width: var(--card-max);
      margin: 0 auto;
      padding: clamp(14px,3vw,22px);
      padding-bottom: calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + var(--page-bottom-gap)) !important;
      box-sizing:border-box;
      display:grid;
      gap:16px;
    }

    .hero{
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));
      overflow:hidden;
    }

    .hero-head{
      display:grid;
      grid-template-columns:36px 1fr;
      gap:12px;
      align-items:center;
      padding:14px 16px;
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);
      border-bottom:1px solid var(--border);
    }

    .hero-head .icon{
      width:24px;
      height:24px;
      color:var(--accent);
      display:grid;
      place-items:center;
    }

    .hero-head h1{
      margin:0;
      font-size:clamp(20px,3.2vw,26px);
      line-height:1.2;
    }

    .muted{ color:var(--muted,#67706B); }

    .body{
      padding:16px;
      display:grid;
      gap:14px;
    }

    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:flex-end;
      justify-content:space-between;
    }

    .toolbar-left{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }

    .toolbar-right{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:flex-end;
      font-size:0.9rem;
      opacity:0.8;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:120px;
      padding:10px 14px;
      border-radius:12px;
      border:1px solid var(--border);
      font-weight:800;
      text-decoration:none;
      cursor:pointer;
      user-select:none;
      color:var(--text) !important;
      background:var(--card-surface,var(--surface));
      font-size:0.9rem;
      gap:6px;
    }

    .btn-quiet{
      min-width:auto;
      padding-inline:10px;
    }

    /* Trial list */

    .trial-list{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:8px;
    }

    .trial-empty{
      padding:14px 16px;
      border-radius:12px;
      border:1px dashed var(--border);
      background:var(--card-surface, var(--surface));
      font-size:0.95rem;
      opacity:0.9;
    }

    .trial-card{
      position:relative;
      border-radius:14px;
      border:1px solid var(--card-border, var(--border));
      background:var(--card-surface, var(--surface));
      box-shadow:var(--shadow-soft, var(--shadow));
      padding:12px 14px 10px;
      display:flex;
      flex-direction:column;
      gap:6px;
      transition:transform .06s, box-shadow .12s, border-color .12s, background .12s;
      cursor:pointer;
    }

    .trial-card:active{
      transform:scale(.995);
      box-shadow:var(--shadow);
    }

    .trial-row-top{
      display:flex;
      align-items:flex-start;
      gap:10px;
    }

    .trial-main{
      flex:1 1 auto;
      min-width:0;
      padding-right:110px; /* room for Add Fields btn */
    }

    .trial-title{
      font-weight:700;
      font-size:0.98rem;
      line-height:1.3;
    }

    .trial-sub{
      font-size:0.86rem;
      opacity:0.9;
      margin-top:2px;
    }

    .trial-meta{
      display:flex;
      flex-wrap:wrap;
      gap:6px 10px;
      margin-top:4px;
      font-size:0.8rem;
      opacity:0.85;
    }

    .trial-meta span{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 7px;
      border-radius:999px;
      background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
    }

    .trial-meta-label{
      font-weight:600;
    }

    .trial-bottom-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      font-size:0.78rem;
      opacity:0.8;
      margin-top:4px;
      flex-wrap:wrap;
    }

    .trial-status-chip{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 8px;
      border-radius:999px;
      font-size:0.78rem;
      text-transform:uppercase;
      letter-spacing:0.06em;
      background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
    }

    .trial-card-actions{
      position:absolute;
      top:10px;
      right:12px;
      display:flex;
      gap:8px;
      align-items:center;
    }

    .trial-add-btn{
      border-radius:999px;
      border:1px solid var(--border);
      padding:5px 12px;
      font-size:0.78rem;
      font-weight:700;
      background:var(--surface-strong, var(--surface));
      cursor:pointer;
      white-space:nowrap;
    }

    .trial-add-btn:hover{
      background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
    }

    /* Detail panel */

    .trial-detail-panel{
      margin-top:10px;
      border-radius:10px;
      border:1px solid var(--card-border, var(--border));
      background:var(--card-surface, var(--surface));
      box-shadow:var(--shadow-soft, var(--shadow));
      padding:14px 16px 12px;
      display:none;
      flex-direction:column;
      gap:8px;
    }

    .trial-detail-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }

    .trial-detail-title{
      font-weight:700;
      font-size:1rem;
    }

    .trial-detail-close{
      border:none;
      outline:none;
      border-radius:999px;
      padding:4px 9px;
      font-size:0.8rem;
      background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
      cursor:pointer;
    }

    .trial-detail-grid{
      display:grid;
      grid-template-columns:minmax(0,1fr);
      gap:6px 16px;
      font-size:0.9rem;
      margin-top:4px;
    }

    @media (min-width:700px){
      .trial-detail-grid{
        grid-template-columns:repeat(2, minmax(0,1fr));
      }
    }

    .trial-detail-item-label{
      font-size:0.8rem;
      text-transform:uppercase;
      letter-spacing:0.06em;
      opacity:0.7;
      margin-bottom:1px;
    }

    .trial-detail-item-value{
      font-size:0.92rem;
    }

    .trial-detail-notes{
      margin-top:8px;
      padding-top:8px;
      border-top:1px solid var(--border);
      font-size:0.92rem;
      white-space:pre-wrap;
    }

    .trial-detail-notes-label{
      font-size:0.8rem;
      text-transform:uppercase;
      letter-spacing:0.06em;
      opacity:0.7;
      margin-bottom:2px;
    }

    .trial-detail-notes-body{
      margin-top:2px;
    }

    .trial-detail-footer{
      margin-top:10px;
      font-size:0.8rem;
      opacity:0.8;
    }

    .trial-detail-pill{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 8px;
      border-radius:999px;
      background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
      font-size:0.8rem;
      margin-left:6px;
    }

    /* Attachments */

    .trial-attachments{
      margin-top:8px;
      padding-top:8px;
      border-top:1px solid var(--border);
      font-size:0.9rem;
    }

    .trial-attachments-label{
      font-size:0.8rem;
      text-transform:uppercase;
      letter-spacing:0.06em;
      opacity:0.7;
      margin-bottom:4px;
    }

    .trial-attachments-grid{
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .trial-attachment-item{
      display:flex;
      align-items:flex-start;
      gap:8px;
    }

    .trial-attachment-thumb{
      width:64px;
      height:64px;
      border-radius:10px;
      overflow:hidden;
      border:1px solid var(--border);
      background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:0.8rem;
      cursor:pointer;
    }

    .trial-attachment-thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }

    .trial-attachment-meta{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:2px;
    }

    .trial-attachment-name{
      font-size:0.9rem;
      font-weight:600;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .trial-attachment-link{
      font-size:0.8rem;
      cursor:pointer;
      border:none;
      background:transparent;
      padding:0;
      text-align:left;
      color:var(--accent);
    }

    .trial-attachment-empty{
      font-size:0.86rem;
      opacity:0.8;
    }

    /* File viewer modal */

    .file-modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:100000;
    }
    .file-modal.show{
      display:flex;
    }
    .file-backdrop{
      position:absolute;
      inset:0;
      background:rgba(0,0,0,.6);
    }
    .file-sheet{
      position:relative;
      max-width:90vw;
      max-height:90vh;
      background:var(--surface);
      border-radius:14px;
      border:1px solid var(--border);
      box-shadow:0 20px 40px rgba(0,0,0,.4);
      padding:8px 10px 10px;
      display:flex;
      flex-direction:column;
      gap:6px;
      z-index:1;
    }
    .file-close-row{
      display:flex;
      justify-content:flex-end;
      margin-bottom:4px;
    }
    .file-close-btn{
      border:none;
      border-radius:999px;
      padding:4px 10px;
      font-size:0.85rem;
      cursor:pointer;
      background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
      color:var(--text);
    }
    .file-content-wrap{
      border-radius:12px;
      overflow:hidden;
      background:#000;
      max-width:calc(90vw - 20px);
      max-height:calc(80vh - 40px);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .file-content-wrap img{
      max-width:100%;
      max-height:100%;
      display:block;
    }
    .file-content-wrap iframe{
      border:0;
      width:calc(90vw - 20px);
      height:calc(80vh - 40px);
      background:#fff;
    }

    /* Combos (maintenance-add style) */

    .field{ position:relative; }

    .buttonish{
      width:100%;
      font:inherit;
      font-size:16px;
      color:var(--text);
      background:var(--card-surface,var(--surface));
      border:1px solid var(--border);
      border-radius:var(--combo-btn-radius);
      padding:12px;
      padding-right:42px;
      outline:none;
      text-align:left;
      cursor:pointer;
      position:relative;
    }
    .buttonish.has-caret::after{
      content:"";
      position:absolute;
      right:14px;
      top:50%;
      width:0;
      height:0;
      border-left:6px solid transparent;
      border-right:6px solid transparent;
      border-top:7px solid var(--muted,#67706B);
      transform:translateY(-50%);
      pointer-events:none;
    }

    .combo{ position:relative; }
    .combo .combo-anchor{
      position:relative;
      display:inline-block;
      width:100%;
    }
    .combo-panel{
      position:absolute;
      left:0; right:0;
      top:calc(100% + var(--combo-gap));
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--combo-radius);
      box-shadow:var(--combo-shadow);
      padding:8px;
      display:none;
      z-index:9999;
    }
    .combo-panel.show{ display:block; }
    .combo-panel .search{
      padding:4px 2px 8px;
    }
    .combo-panel .search input{
      width:100%;
      padding:10px;
      border:1px solid var(--border);
      border-radius:var(--combo-btn-radius);
      background:var(--card-surface,var(--surface));
      color:var(--text);
    }
    .combo-panel .list{
      max-height:var(--combo-max-h);
      overflow:auto;
      border-top:1px solid var(--border);
    }
    .combo-item{
      padding:var(--combo-item-pad);
      border-bottom:1px solid var(--border);
      cursor:pointer;
    }
    .combo-item:hover{
      background:rgba(0,0,0,.04);
    }
    .combo-item:last-child{ border-bottom:none; }
    .combo-empty{
      padding:var(--combo-item-pad);
      color:#67706B;
    }

    /* Add Field modal */

    .field-modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:100010;
    }
    .field-modal.show{
      display:flex;
    }
    .field-backdrop{
      position:absolute;
      inset:0;
      background:rgba(0,0,0,.55);
    }
    .field-sheet{
      position:relative;
      max-width:min(560px, 94vw);
      max-height:90vh;
      background:var(--surface);
      border-radius:16px;
      border:1px solid var(--border);
      box-shadow:0 20px 40px rgba(0,0,0,.4);
      padding:14px 16px 16px;
      display:flex;
      flex-direction:column;
      gap:10px;
      z-index:1;
      overflow:auto;
    }
    .field-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }
    .field-title{
      font-size:1.05rem;
      font-weight:700;
    }
    .field-close-btn{
      border:none;
      border-radius:999px;
      padding:4px 10px;
      font-size:0.85rem;
      cursor:pointer;
      background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
    }
    .field-subtitle{
      font-size:0.86rem;
      opacity:0.9;
    }
    .field-form{
      display:grid;
      gap:10px;
      margin-top:4px;
      font-size:0.9rem;
    }
    .field-group{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .field-label{
      font-size:0.8rem;
      text-transform:uppercase;
      letter-spacing:0.06em;
      opacity:0.75;
    }
    .field-input,
    .field-textarea{
      border-radius:10px;
      border:1px solid var(--border);
      padding:7px 9px;
      font:inherit;
      background:var(--surface);
      resize:vertical;
      min-height:38px;
    }
    .field-textarea{
      min-height:80px;
    }
    .field-help{
      font-size:0.8rem;
      opacity:0.8;
      margin-top:2px;
    }
    .field-actions{
      margin-top:4px;
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }
    .field-btn{
      border-radius:12px;
      border:1px solid var(--border);
      padding:8px 14px;
      font-size:0.9rem;
      font-weight:700;
      background:var(--surface);
      cursor:pointer;
    }
    .field-btn-primary{
      background:var(--accent);
      border-color:var(--accent);
      color:#fff;
    }
    .field-mic-row{
      display:flex;
      justify-content:flex-end;
      margin-top:4px;
    }
    .field-mic-btn{
      border:none;
      border-radius:999px;
      padding:4px 10px;
      font-size:0.8rem;
      cursor:pointer;
      background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
    }
    .field-mic-btn.mic-active{
      background:#2F6C3C;
      color:#fff;
      border-color:#2F6C3C;
    }
    .field-note-hint{
      font-size:0.8rem;
      opacity:0.75;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:calc(env(safe-area-inset-bottom,0px) + 72px);
      transform:translateX(-50%);
      background:#2F6C3C;
      color:#fff;
      padding:10px 14px;
      border-radius:10px;
      box-shadow:0 6px 20px rgba(0,0,0,.25);
      z-index:99999;
      display:none;
    }
    .toast.show{
      display:block;
      animation:fadeout 5s forwards;
    }
    @keyframes fadeout{
      0%{opacity:1}
      85%{opacity:1}
      100%{opacity:0}
    }
  </style>

  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true;
        document.head.appendChild(s);
      }
    })();
  </script>

  <script type="module">
    import {
      ready,
      getFirestore,
      collection, query, where, getDocs,
      addDoc, doc, updateDoc,
      serverTimestamp
    } from '/Farm-vista/js/firebase-init.js';

    import { NAV_MENU } from '/Farm-vista/js/menu.js';

    const CONFIG = {
      COLLECTION_TRIALS: 'fieldTrials',
      COLLECTION_FARMS:  'farms',
      COLLECTION_FIELDS: 'fields',
      STATUS_FIELD:  'status',
      STATUS_PENDING:'pending',
      STATUS_ACTIVE: 'active'
    };

    const STATE = {
      db: null,
      items: [],
      selectedId: null,
      fieldForId: null,
      farms: [],
      fields: [],
      selectedFarmId: null,
      selectedField: null,
      selectedFieldMaxAcres: null
    };

    const $  = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    let toastEl;

    // file viewer
    let fileModal, fileBackdrop, fileCloseBtn, fileContentWrap;

    // add field modal
    let fieldModal, fieldBackdrop, fieldCloseBtn, fieldForm;
    let fieldTrialLabel, fieldFarmBtn, fieldFarmPanel, fieldFarmList;
    let fieldFieldBtn, fieldFieldPanel, fieldFieldList, fieldFieldSearch;
    let fieldAcresInput, fieldAcresHelp, fieldNotesInput, fieldMicBtn, fieldCancelBtn;

    let farmCombo, fieldCombo;

    function showToast(msg="Saved.", ms=4000){
      if(!toastEl) return;
      toastEl.textContent = msg;
      toastEl.classList.remove('show');
      void toastEl.offsetWidth;
      toastEl.classList.add('show');
      setTimeout(()=>toastEl.classList.remove('show'), ms);
    }

    function getTime(ts){
      if(!ts) return 0;
      try{
        if(ts.toMillis) return ts.toMillis();
        if(ts.toDate)   return ts.toDate().getTime();
        if(ts instanceof Date) return ts.getTime();
        return new Date(ts).getTime() || 0;
      }catch{
        return 0;
      }
    }

    function isImageUrl(url){
      if(!url || typeof url !== 'string') return false;
      const u = url.split('?')[0].toLowerCase();
      return u.endsWith('.jpg') || u.endsWith('.jpeg') || u.endsWith('.png') ||
             u.endsWith('.gif') || u.endsWith('.webp') || u.endsWith('.heic');
    }

    function closeAllCombos(except=null){
      $$('.combo-panel.show').forEach(p => { if(p !== except) p.classList.remove('show'); });
    }

    document.addEventListener('click', () => closeAllCombos());
    document.addEventListener('keydown', e=>{
      if(e.key === 'Escape'){
        closeAllCombos();
        if(fieldModal && fieldModal.classList.contains('show')) closeFieldModal();
        if(fileModal && fileModal.classList.contains('show')) closeFileViewer();
      }
    });

    function makeCombo({ btn, panel, list, searchInput=null, items=[], searchable=false, formatter=x=>String(x?.label??x), onPick }){
      if(!btn || !panel || !list) return;

      panel.addEventListener('click', e=>e.stopPropagation());
      panel.addEventListener('mousedown', e=>e.stopPropagation());

      let DATA = items || [];

      function render(q=""){
        const qq = (q||"").toLowerCase();
        const html = (DATA || [])
          .filter(x => {
            const label = formatter(x).toLowerCase();
            return !qq || label.includes(qq);
          })
          .map(x => `<div class="combo-item" data-id="${String(x.id)}">${formatter(x)}</div>`)
          .join('') || `<div class="combo-empty">(no matches)</div>`;
        list.innerHTML = html;
      }

      function open(){
        closeAllCombos(panel);
        panel.classList.add('show');
        render("");
        if(searchable && searchInput){
          searchInput.value = "";
          searchInput.focus();
        }
      }

      function close(){
        panel.classList.remove('show');
      }

      btn.addEventListener('click', e=>{
        e.stopPropagation();
        panel.classList.contains('show') ? close() : open();
      });

      list.addEventListener('mousedown', e=>{
        const row = e.target.closest('.combo-item');
        if(!row) return;
        const id = row.dataset.id;
        const it = (DATA || []).find(x => String(x.id) === id);
        if(!it) return;
        onPick?.(it);
        close();
      });

      if(searchable && searchInput){
        searchInput.addEventListener('input', e=>render(e.target.value));
      }

      return {
        setItems(arr){
          DATA = Array.isArray(arr) ? arr : [];
          render("");
        }
      };
    }

    // ---------- mic / dictation helper ----------

    function wireMic(btnId, textareaId){
      const btn = document.getElementById(btnId);
      const ta  = document.getElementById(textareaId);
      if(!btn || !ta) return;

      const ok = ('webkitSpeechRecognition' in window) || ('SpeechRecognition' in window);
      if(!ok){
        // Hide mic if browser doesn't support it
        btn.style.display = 'none';
        return;
      }

      const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
      const rec = new Rec();
      rec.lang = 'en-US';
      rec.interimResults = true;
      rec.continuous = false;

      let active = false;
      let baseText = '';

      const setMic = (on)=>{
        btn.classList.toggle('mic-active', on);
        btn.setAttribute('aria-label', on ? 'Stop dictation' : 'Dictate notes');
      };

      btn.addEventListener('click', ()=>{
        if(!active){
          baseText = ta.value ? (ta.value + ' ') : '';
          try{
            rec.start();
            active = true;
            setMic(true);
          }catch(err){
            console.error('SpeechRecognition start error:', err);
          }
        }else{
          try{
            rec.stop();
            rec.abort();
          }catch{}
          active = false;
          setMic(false);
        }
      });

      rec.onresult = (ev)=>{
        let txt = '';
        for(let i=ev.resultIndex; i<ev.results.length; i++){
          txt += ev.results[i][0].transcript;
        }
        ta.value = baseText + txt;
      };

      rec.onend = ()=>{
        active = false;
        setMic(false);
      };

      rec.onerror = (e)=>{
        console.error('SpeechRecognition error:', e);
        active = false;
        setMic(false);
      };
    }

    // ---------- Detail panel & attachments ----------

    function clearDetails(){
      const panel = $('.trial-detail-panel');
      if(!panel) return;
      panel.style.display = 'none';
      panel.dataset.id = '';
      const titleEl = $('.trial-detail-title', panel);
      if(titleEl) titleEl.textContent = 'Trial Details';
      const grid = $('.trial-detail-grid', panel);
      if(grid) grid.innerHTML = '';
      const notesBody = $('.trial-detail-notes-body', panel);
      if(notesBody) notesBody.textContent = '';
      const footer = $('.trial-detail-footer', panel);
      if(footer) footer.innerHTML = '';
      const attGrid = $('#trialDetailAttachments');
      if(attGrid) attGrid.innerHTML = '';
    }

    function openFileViewer(att){
      if(!fileModal || !fileContentWrap || !att || !att.url) return;
      fileContentWrap.innerHTML = '';
      if(isImageUrl(att.url)){
        const img = document.createElement('img');
        img.src = att.url;
        img.alt = att.name || 'Attachment';
        fileContentWrap.appendChild(img);
      }else{
        const iframe = document.createElement('iframe');
        iframe.src = att.url;
        fileContentWrap.appendChild(iframe);
      }
      fileModal.classList.add('show');
      document.body.style.overflow = 'hidden';
    }

    function closeFileViewer(){
      if(!fileModal) return;
      fileModal.classList.remove('show');
      if(fileContentWrap) fileContentWrap.innerHTML = '';
      document.body.style.overflow = '';
    }

    function renderDetails(){
      const panel = $('.trial-detail-panel');
      if(!panel) return;
      const item = STATE.items.find(x => x.id === STATE.selectedId);
      if(!item){
        clearDetails();
        return;
      }

      const d = item.data;

      const title = d.trialName || 'Field Trial';
      const cropYear = d.cropYear ?? null;
      const crop = d.crop || '';
      const trialType = d.trialType || '';
      const operationTask = d.operationTask || '';
      const treatment = d.treatmentProduct || '';
      const check = d.check || '';
      const status = d[CONFIG.STATUS_FIELD] || '';
      const createdBy = d.createdByName || d.createdByEmail || '';
      const when = d.createdAt && d.createdAt.toDate ? d.createdAt.toDate()
                 : (d.createdAt ? new Date(d.createdAt) : null);
      const notes = d.notes || '';

      panel.dataset.id = item.id;

      const titleEl = $('.trial-detail-title', panel);
      if(titleEl){
        titleEl.textContent = title;
      }

      const grid = $('.trial-detail-grid', panel);
      if(grid){
        grid.innerHTML = `
          ${(cropYear !== null || crop) ? `
          <div>
            <div class="trial-detail-item-label">Crop Year / Crop</div>
            <div class="trial-detail-item-value">
              ${cropYear !== null ? cropYear : ''}${cropYear && crop ? ' ‚Ä¢ ' : ''}${crop}
            </div>
          </div>` : ''}

          ${trialType ? `
          <div>
            <div class="trial-detail-item-label">Trial Type</div>
            <div class="trial-detail-item-value">${trialType}</div>
          </div>` : ''}

          ${operationTask ? `
          <div>
            <div class="trial-detail-item-label">Operation</div>
            <div class="trial-detail-item-value">${operationTask}</div>
          </div>` : ''}

          ${treatment ? `
          <div>
            <div class="trial-detail-item-label">Treatment Product</div>
            <div class="trial-detail-item-value">${treatment}</div>
          </div>` : ''}

          ${check ? `
          <div>
            <div class="trial-detail-item-label">Check</div>
            <div class="trial-detail-item-value">${check}</div>
          </div>` : ''}

          ${createdBy ? `
          <div>
            <div class="trial-detail-item-label">Created By</div>
            <div class="trial-detail-item-value">${createdBy}</div>
          </div>` : ''}

          ${when ? `
          <div>
            <div class="trial-detail-item-label">Created</div>
            <div class="trial-detail-item-value">${when.toLocaleString()}</div>
          </div>` : ''}
        `;
      }

      const notesBody = $('.trial-detail-notes-body', panel);
      if(notesBody){
        notesBody.textContent = notes || 'No additional notes recorded.';
      }

      const attGrid = $('#trialDetailAttachments');
      if(attGrid){
        attGrid.innerHTML = '';
        const files = Array.isArray(d.files) ? d.files : [];
        if(files.length){
          files.forEach(raw => {
            if(!raw || !raw.url) return;
            const att = {
              url: raw.url,
              name: raw.name || raw.path || 'Attachment'
            };
            const itemEl = document.createElement('div');
            itemEl.className = 'trial-attachment-item';

            const thumb = document.createElement('div');
            thumb.className = 'trial-attachment-thumb';

            if(isImageUrl(att.url)){
              const img = document.createElement('img');
              img.src = att.url;
              img.alt = att.name;
              thumb.appendChild(img);
            }else{
              thumb.textContent = 'FILE';
            }

            const meta = document.createElement('div');
            meta.className = 'trial-attachment-meta';

            const nameEl = document.createElement('div');
            nameEl.className = 'trial-attachment-name';
            nameEl.textContent = att.name;

            const linkEl = document.createElement('button');
            linkEl.type = 'button';
            linkEl.className = 'trial-attachment-link';
            linkEl.textContent = 'Open';

            const openFn = (ev)=>{
              ev.stopPropagation();
              openFileViewer(att);
            };
            thumb.addEventListener('click', openFn);
            linkEl.addEventListener('click', openFn);

            meta.appendChild(nameEl);
            meta.appendChild(linkEl);
            itemEl.appendChild(thumb);
            itemEl.appendChild(meta);
            attGrid.appendChild(itemEl);
          });
        }else{
          const empty = document.createElement('div');
          empty.className = 'trial-attachment-empty';
          empty.textContent = 'No files or photos attached.';
          attGrid.appendChild(empty);
        }
      }

      const footer = $('.trial-detail-footer', panel);
      if(footer){
        footer.innerHTML = `
          Current status:
          <span class="trial-detail-pill">${status || 'unknown'}</span>
        `;
      }

      panel.style.display = 'flex';
    }

    // ---------- List ----------

    function renderList(){
      const listEl  = $('.trial-list');
      const emptyEl = $('.trial-empty');
      const countEl = $('#trialCount');

      listEl.innerHTML = '';

      if(!STATE.items.length){
        if(emptyEl) {
          emptyEl.style.display = 'block';
          emptyEl.textContent = 'No pending trials right now. New field trials will appear here after they are created.';
        }
        if(countEl) countEl.textContent = '0 pending trials';
        clearDetails();
        return;
      }

      if(emptyEl){
        emptyEl.style.display = 'none';
      }

      for(const item of STATE.items){
        const d = item.data;
        const id = item.id;

        const title = d.trialName || 'Field Trial';
        const cropYear = d.cropYear ?? null;
        const crop = d.crop || '';
        const trialType = d.trialType || '';
        const operationTask = d.operationTask || '';
        const statusRaw = (d.status || '').toString() || 'pending';
        const createdAt = d.createdAt || null;
        const when = createdAt && createdAt.toDate ? createdAt.toDate()
                   : (createdAt ? new Date(createdAt) : null);

        const friendlyStatus =
          statusRaw.toLowerCase() === 'active'  ? 'Active'  :
          statusRaw.toLowerCase() === 'pending' ? 'Pending' :
          statusRaw;

        const card = document.createElement('article');
        card.className = 'trial-card';
        card.dataset.id = id;

        card.innerHTML = `
          <div class="trial-card-actions">
            <button type="button" class="trial-add-btn">Add Fields</button>
          </div>

          <div class="trial-row-top">
            <div class="trial-main">
              <div class="trial-title">
                ${title}
              </div>
              <div class="trial-sub">
                ${cropYear !== null ? cropYear : ''}${cropYear && crop ? ' ‚Ä¢ ' : ''}${crop}
                ${trialType ? ` ‚Ä¢ ${trialType}` : ''}
              </div>
              <div class="trial-meta">
                ${operationTask ? `
                  <span><span class="trial-meta-label">Operation</span> ${operationTask}</span>
                ` : ''}
                ${trialType ? `
                  <span><span class="trial-meta-label">Type</span> ${trialType}</span>
                ` : ''}
              </div>
            </div>
          </div>

          <div class="trial-bottom-row">
            <div>
              ${when ? `Created ${when.toLocaleDateString()} ${when.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}` : ''}
            </div>
            <div class="trial-status-chip">${friendlyStatus}</div>
          </div>
        `;

        card.addEventListener('click', () => {
          STATE.selectedId = id;
          renderDetails();
        });

        const addBtn = card.querySelector('.trial-add-btn');
        if(addBtn){
          addBtn.addEventListener('click', (ev) => {
            ev.stopPropagation();
            openFieldModal(item);
          });
        }

        listEl.appendChild(card);
      }

      if(countEl){
        countEl.textContent = `${STATE.items.length} pending trial${STATE.items.length === 1 ? '' : 's'}`;
      }
    }

    async function loadPendingTrials(){
      const db  = STATE.db;
      const ref = collection(db, CONFIG.COLLECTION_TRIALS);

      try{
        const qRef = query(ref, where(CONFIG.STATUS_FIELD, '==', CONFIG.STATUS_PENDING));
        const snap = await getDocs(qRef);

        const items = snap.docs.map(d => ({
          id: d.id,
          data: d.data()
        }));

        items.sort((a,b) => {
          const ta = getTime(a.data.createdAt);
          const tb = getTime(b.data.createdAt);
          return tb - ta;
        });

        STATE.items = items;
        renderList();
      }catch(err){
        console.error('Error loading trials:', err);
        const emptyEl = $('.trial-empty');
        const countEl = $('#trialCount');
        if(emptyEl){
          emptyEl.textContent = 'Error loading trials. Check console or Firestore indexes.';
          emptyEl.style.display = 'block';
        }
        if(countEl) countEl.textContent = 'Error loading trials';
        clearDetails();
      }
    }

    // ---------- Farms + Fields ----------

    async function loadFarmsAndFields(){
      const db = STATE.db;

      try{
        const farmSnap = await getDocs(collection(db, CONFIG.COLLECTION_FARMS));
        const farms = [];
        farmSnap.forEach(docSnap => {
          const data = docSnap.data() || {};
          const name = data.name || data.farmName || data.shortName;
          if(!name) return;
          farms.push({ id: docSnap.id, name: String(name) });
        });
        farms.sort((a,b)=>a.name.localeCompare(b.name));
        STATE.farms = farms;
      }catch(err){
        console.error('Error loading farms:', err);
        STATE.farms = [];
      }

      try{
        const fieldSnap = await getDocs(collection(db, CONFIG.COLLECTION_FIELDS));
        const fields = [];
        fieldSnap.forEach(docSnap => {
          const data = docSnap.data() || {};
          const fieldName = data.name || data.fieldName;
          if(!fieldName) return;
          const farmId = data.farmId || data.farmDocId || data.farm || null;
          const farmName = data.farmName || data.farm || '';
          const tillable =
            data.tillable ??
            data.tillableAcres ??
            data.acres ??
            null;
          fields.push({
            id: docSnap.id,
            fieldName: String(fieldName),
            farmId,
            farmName: farmName ? String(farmName) : null,
            tillable: tillable != null ? Number(tillable) : null
          });
        });
        STATE.fields = fields;
      }catch(err){
        console.error('Error loading fields:', err);
        STATE.fields = [];
      }
    }

    function refreshFieldComboForFarm(farmId){
      STATE.selectedFarmId = farmId || null;
      STATE.selectedField = null;
      STATE.selectedFieldMaxAcres = null;

      if(fieldFieldBtn) fieldFieldBtn.textContent = '‚Äî Select field ‚Äî';
      if(fieldAcresHelp) fieldAcresHelp.textContent = '';

      const items = STATE.fields
        .filter(f => {
          if(!farmId) return true;
          return f.farmId === farmId;
        })
        .map(f => ({
          id: f.id,
          label: f.farmName ? `${f.farmName} ‚Ä¢ ${f.fieldName}` : f.fieldName,
          raw: f
        }))
        .sort((a,b)=>a.label.localeCompare(b.label));

      fieldCombo && fieldCombo.setItems(items);
    }

    // ---------- Add Field modal ----------

    function openFieldModal(item){
      if(!fieldModal || !fieldForm) return;

      STATE.fieldForId = item.id;
      STATE.selectedFarmId = null;
      STATE.selectedField = null;
      STATE.selectedFieldMaxAcres = null;

      fieldForm.reset();
      if(fieldAcresHelp) fieldAcresHelp.textContent = '';

      const d = item.data;
      const cropYear = d.cropYear ?? null;
      const crop = d.crop || '';
      const trialName = d.trialName || 'Field Trial';

      const pieces = [trialName];
      const sub = [
        cropYear !== null ? cropYear : null,
        crop || null
      ].filter(Boolean).join(' ‚Ä¢ ');
      if(sub) pieces.push(sub);
      if(fieldTrialLabel) fieldTrialLabel.textContent = pieces.join(' ‚Äî ');

      if(fieldFarmBtn) fieldFarmBtn.textContent = '‚Äî Select farm ‚Äî';
      if(fieldFieldBtn) fieldFieldBtn.textContent = '‚Äî Select field ‚Äî';

      const farmItems = STATE.farms.map(f => ({
        id: f.id,
        label: f.name
      }));
      farmCombo && farmCombo.setItems(farmItems);
      fieldCombo && fieldCombo.setItems([]);

      fieldModal.classList.add('show');
      document.body.style.overflow = 'hidden';
    }

    function closeFieldModal(){
      if(!fieldModal) return;
      fieldModal.classList.remove('show');
      document.body.style.overflow = '';
      STATE.fieldForId = null;
    }

    async function handleFieldSubmit(ev){
      ev.preventDefault();
      if(!STATE.fieldForId){
        closeFieldModal();
        return;
      }

      const trialId = STATE.fieldForId;
      const fieldObj = STATE.selectedField;

      if(!STATE.selectedFarmId){
        alert('Please select a farm.');
        return;
      }
      if(!fieldObj){
        alert('Please select a field.');
        return;
      }

      // extra safety: enforce farm/field match
      if(fieldObj.farmId && fieldObj.farmId !== STATE.selectedFarmId){
        alert('Selected field does not belong to the selected farm. Please choose a matching farm and field.');
        return;
      }

      const acresStr = fieldAcresInput.value.trim();
      const notes    = fieldNotesInput.value.trim();

      let acres = acresStr ? Number(acresStr) : null;
      if(acresStr && isNaN(acres)){
        alert('Trial acres must be a number.');
        return;
      }

      const maxAcres = STATE.selectedFieldMaxAcres;
      if(maxAcres != null && acres != null && acres > maxAcres + 0.0001){
        alert(`Trial acres cannot be more than the field tillable acres (${maxAcres}).`);
        return;
      }

      const db = STATE.db;

      try{
        const fieldsCol = collection(db, CONFIG.COLLECTION_TRIALS, trialId, 'fields');
        await addDoc(fieldsCol, {
          farmId: STATE.selectedFarmId,
          farmName: fieldObj.farmName || null,
          fieldId: fieldObj.id,
          fieldName: fieldObj.fieldName,
          tillable: maxAcres != null ? maxAcres : null,
          trialAcres: acres != null ? acres : null,
          notes: notes || null,
          createdAt: serverTimestamp()
        });

        const trialRef = doc(db, CONFIG.COLLECTION_TRIALS, trialId);
        await updateDoc(trialRef, {
          status: CONFIG.STATUS_ACTIVE,
          updatedAt: serverTimestamp()
        });

        showToast('Field added and trial marked Active.');
        closeFieldModal();
        await loadPendingTrials(); // trial drops off pending list
      }catch(err){
        console.error('Error adding field to trial:', err);
        alert('Error saving field: ' + (err && (err.message || err.code) || 'Unknown error (check console).'));
      }
    }

    (async function boot(){
      await ready;
      STATE.db = getFirestore();

      const shell = document.querySelector('fv-shell');
      if (shell) shell.nav = NAV_MENU;

      toastEl = document.getElementById('toast');

      const backBtn = document.getElementById('btnBack');
      if(backBtn){
        backBtn.addEventListener('click', () => {
          location.href = '/Farm-vista/pages/crop-production/trials.html';
        });
      }

      const closeDetailBtn = $('#trialDetailClose');
      if(closeDetailBtn){
        closeDetailBtn.addEventListener('click', () => {
          STATE.selectedId = null;
          clearDetails();
        });
      }

      // file viewer wiring
      fileModal       = $('#fileModal');
      fileBackdrop    = $('#fileBackdrop');
      fileCloseBtn    = $('#fileModalClose');
      fileContentWrap = $('#fileContentWrap');

      if(fileBackdrop){
        fileBackdrop.addEventListener('click', closeFileViewer);
      }
      if(fileCloseBtn){
        fileCloseBtn.addEventListener('click', closeFileViewer);
      }

      // add field modal refs
      fieldModal      = $('#fieldModal');
      fieldBackdrop   = $('#fieldBackdrop');
      fieldCloseBtn   = $('#fieldModalClose');
      fieldForm       = $('#fieldForm');
      fieldTrialLabel = $('#fieldTrialLabel');
      fieldFarmBtn    = $('#fieldFarmBtn');
      fieldFarmPanel  = $('#fieldFarmPanel');
      fieldFarmList   = $('#fieldFarmList');
      fieldFieldBtn   = $('#fieldFieldBtn');
      fieldFieldPanel = $('#fieldFieldPanel');
      fieldFieldList  = $('#fieldFieldList');
      fieldFieldSearch= $('#fieldFieldSearch');
      fieldAcresInput = $('#fieldAcres');
      fieldAcresHelp  = $('#fieldAcresHelp');
      fieldNotesInput = $('#fieldNotes');
      fieldMicBtn     = $('#fieldMic');
      fieldCancelBtn  = $('#fieldCancel');

      if(fieldBackdrop){
        fieldBackdrop.addEventListener('click', closeFieldModal);
      }
      if(fieldCloseBtn){
        fieldCloseBtn.addEventListener('click', closeFieldModal);
      }
      if(fieldCancelBtn){
        fieldCancelBtn.addEventListener('click', (ev)=>{
          ev.preventDefault();
          closeFieldModal();
        });
      }
      if(fieldForm){
        fieldForm.addEventListener('submit', handleFieldSubmit);
      }

      // dictation hookup
      if(fieldNotesInput){
        fieldNotesInput.id = 'fieldNotes';
      }
      if(fieldMicBtn){
        wireMic('fieldMic', 'fieldNotes');
      }

      // combos
      farmCombo = makeCombo({
        btn: fieldFarmBtn,
        panel: fieldFarmPanel,
        list: fieldFarmList,
        searchInput: null,
        searchable: true,
        formatter: x => x.label,
        onPick: farm => {
          if(fieldFarmBtn) fieldFarmBtn.textContent = farm.label;
          refreshFieldComboForFarm(farm.id);
        }
      });

      fieldCombo = makeCombo({
        btn: fieldFieldBtn,
        panel: fieldFieldPanel,
        list: fieldFieldList,
        searchInput: fieldFieldSearch,
        searchable: true,
        formatter: x => x.label,
        onPick: it => {
          if(fieldFieldBtn) fieldFieldBtn.textContent = it.label;
          STATE.selectedField = it.raw;

          // set farm to match field's farmId if possible
          if(it.raw.farmId){
            const farm = STATE.farms.find(f => f.id === it.raw.farmId);
            if(farm){
              if(fieldFarmBtn) fieldFarmBtn.textContent = farm.name;
              refreshFieldComboForFarm(farm.id);
              // keep this field selected after refresh
              STATE.selectedField = it.raw;
              if(fieldFieldBtn) fieldFieldBtn.textContent = it.label;
            }
          }

          const max = it.raw.tillable != null ? it.raw.tillable : null;
          STATE.selectedFieldMaxAcres = max;
          if(max != null && fieldAcresHelp){
            fieldAcresHelp.textContent =
              `Max trial acres for this field: ${max}. Trial acres cannot be more than the tillable acres.`;
          }else if(fieldAcresHelp){
            fieldAcresHelp.textContent = '';
          }
        }
      });

      await loadFarmsAndFields();
      await loadPendingTrials();
    })();
  </script>
</head>

<body>
  <fv-shell>
    <div class="wrap">
      <section class="hero">
        <header class="hero-head">
          <div class="icon" aria-hidden="true">üß™</div>
          <div>
            <h1>Edit Field Trials</h1>
            <p class="muted">
              Add fields to <strong>pending</strong> trials. Once you add trial acres for at least one field,
              the trial will move to <strong>Active</strong>.
            </p>
          </div>
        </header>

        <div class="body">
          <div class="toolbar">
            <div class="toolbar-left">
              <button id="btnBack" type="button" class="btn btn-quiet">
                ‚Üê Back to Trials
              </button>
            </div>
            <div class="toolbar-right">
              <span id="trialCount">0 pending trials</span>
            </div>
          </div>

          <section aria-label="Pending field trials">
            <div class="trial-empty">
              No pending trials right now.
            </div>
            <div class="trial-list"></div>
          </section>

          <section class="trial-detail-panel" aria-label="Trial details">
            <div class="trial-detail-header">
              <div class="trial-detail-title">Trial Details</div>
              <button type="button" id="trialDetailClose" class="trial-detail-close">
                Close
              </button>
            </div>

            <div class="trial-detail-grid">
              <!-- filled by JS -->
            </div>

            <div class="trial-detail-notes">
              <div class="trial-detail-notes-label">Trial Notes</div>
              <div class="trial-detail-notes-body"></div>
            </div>

            <div class="trial-attachments">
              <div class="trial-attachments-label">Files &amp; Photos</div>
              <div class="trial-attachments-grid" id="trialDetailAttachments"></div>
            </div>

            <div class="trial-detail-footer">
              <!-- status pill by JS -->
            </div>
          </section>
        </div>
      </section>
    </div>
  </fv-shell>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite">Saved.</div>

  <!-- File viewer modal -->
  <div id="fileModal" class="file-modal" role="dialog" aria-modal="true" aria-label="Trial attachment">
    <div id="fileBackdrop" class="file-backdrop"></div>
    <div class="file-sheet">
      <div class="file-close-row">
        <button id="fileModalClose" type="button" class="file-close-btn">Close</button>
      </div>
      <div id="fileContentWrap" class="file-content-wrap"></div>
    </div>
  </div>

  <!-- Add Field modal -->
  <div id="fieldModal" class="field-modal" role="dialog" aria-modal="true" aria-label="Add field to trial">
    <div id="fieldBackdrop" class="field-backdrop"></div>
    <div class="field-sheet">
      <div class="field-header">
        <div>
          <div class="field-title">Add Field</div>
          <div class="field-subtitle" id="fieldTrialLabel"></div>
        </div>
        <button id="fieldModalClose" type="button" class="field-close-btn">Close</button>
      </div>

      <form id="fieldForm" class="field-form">
        <div class="field-group combo">
          <label class="field-label" for="fieldFarmBtn">Farm</label>
          <div class="combo-anchor">
            <button id="fieldFarmBtn" class="buttonish has-caret" type="button">‚Äî Select farm ‚Äî</button>
            <div id="fieldFarmPanel" class="combo-panel" role="listbox" aria-label="Farm list">
              <div class="list" id="fieldFarmList"></div>
            </div>
          </div>
        </div>

        <div class="field-group combo">
          <label class="field-label" for="fieldFieldBtn">Field</label>
          <div class="combo-anchor">
            <button id="fieldFieldBtn" class="buttonish has-caret" type="button">‚Äî Select field ‚Äî</button>
            <div id="fieldFieldPanel" class="combo-panel" role="listbox" aria-label="Field list">
              <div class="search"><input id="fieldFieldSearch" type="search" placeholder="Search fields‚Ä¶"></div>
              <div class="list" id="fieldFieldList"></div>
            </div>
          </div>
        </div>

        <div class="field-group">
          <label class="field-label" for="fieldAcres">Trial Acres</label>
          <input id="fieldAcres" class="field-input" type="number" step="0.01" placeholder="Trial acres in this field">
          <div id="fieldAcresHelp" class="field-help"></div>
        </div>

        <div class="field-group">
          <label class="field-label" for="fieldNotes">Notes</label>
          <textarea id="fieldNotes" class="field-textarea" placeholder="Any notes about this field in the trial..."></textarea>
          <div class="field-mic-row">
            <button id="fieldMic" type="button" class="field-mic-btn" data-target="fieldNotes">
              Dictate notes
            </button>
          </div>
          <div class="field-note-hint">
            Use this for strip layout, passes, or anything the guys need to remember.
          </div>
        </div>

        <div class="field-actions">
          <button id="fieldCancel" type="button" class="field-btn">Cancel</button>
          <button id="fieldSave" type="submit" class="field-btn field-btn-primary">Save Field</button>
        </div>
      </form>
    </div>
  </div>
</body>
</html>
