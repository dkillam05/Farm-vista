<!-- ===== Part 1 of 8: Head, styles, basic helpers (Field Trials) ===== -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FarmVista ‚Ä¢ Field Trials</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#3B7E46" />

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest" />
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png" />
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png" />
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css" />
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css" />

  <!-- Data helper for more reliable Firebase binding -->
  <script src="/Farm-vista/js/fv-data.js"></script>

  <style>
    :root{
      --card-max: 1200px;
      --page-bottom-gap: 96px;
      --accent: #2F6C3C;

      /* Combo vars */
      --combo-gap: 4px;
      --combo-radius: 12px;
      --combo-btn-radius: 10px;
      --combo-shadow: 0 12px 26px rgba(0,0,0,.18);
      --combo-item-pad: 10px 8px;
      --combo-max-h: 50vh;
    }

    [hidden]{display:none!important}
    html{-webkit-text-size-adjust:100%}
    body{
      background:var(--app-bg,var(--surface));
      overflow-x:hidden; /* guard against horizontal scroll */
    }

    /* No blue links, even in dark mode */
    a,
    a:visited{
      color:var(--text);
      text-decoration:none;
    }

    /* Main page wrapper */
    .page{
      max-width:var(--card-max);
      margin:0 auto;
      padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + var(--page-bottom-gap))!important;
      box-sizing:border-box;
      display:grid;
      gap:16px;
    }

    .hero{
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));
      /* allow filter dropdowns to extend outside the hero card */
      overflow:visible;
    }
    .hero-head{
      display:grid;
      grid-template-columns:36px 1fr;
      gap:12px;
      align-items:center;
      padding:14px 16px;
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);
      border-bottom:1px solid var(--border);
    }
    .hero-head .icon{
      width:24px;
      height:24px;
      color:var(--accent);
      display:grid;
      place-items:center;
    }
    .hero-head h1{
      margin:0;
      font-size:clamp(20px,3.2vw,26px);
      line-height:1.2;
      color:var(--text);
    }
    .muted{color:var(--muted,#67706B);}

    .hero-body{
      padding:16px;
      display:grid;
      gap:14px;
    }

    /* Toolbar + filters */
    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:flex-end;
      justify-content:space-between;
    }
    .toolbar-left{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .toolbar-right{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:flex-end;
      font-size:0.9rem;
      opacity:0.85;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:120px;
      padding:10px 14px;
      border-radius:12px;
      border:1px solid var(--border);
      font-weight:800;
      cursor:pointer;
      user-select:none;
      background:var(--card-surface,var(--surface));
      font-size:0.9rem;
      gap:6px;
      text-decoration:none;
      color:var(--text)!important; /* default buttons use body text color */
    }
    .btn-quiet{
      min-width:auto;
      padding-inline:10px;
    }
    .btn-primary{
      border-radius:999px;
      border:1px solid transparent;
      background:var(--green,#3B7E46);
    }
    .btn.btn-primary{
      color:#fff !important; /* FORCE white text on green, all modes */
    }
    .btn-small{
      min-width:0;
      padding:6px 10px;
      font-size:0.82rem;
    }

    .field{position:relative;}
    .field label{
      display:block;
      font-weight:800;
      margin:0 0 4px;
      font-size:0.86rem;
    }
    .select,
    .input{
      width:100%;
      font:inherit;
      font-size:0.9rem;
      color:var(--text);
      background:var(--card-surface,var(--surface));
      border:1px solid var(--border);
      border-radius:999px;
      padding:8px 10px;
      outline:none;
      box-sizing:border-box;
    }
    .input{border-radius:10px;}

    /* Filters: 3 clean equal columns */
    .filters-grid{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr));
      gap:10px;
    }
    @media(max-width:900px){
      .filters-grid{grid-template-columns:repeat(2,minmax(0,1fr));}
    }
    @media(max-width:640px){
      .filters-grid{grid-template-columns:1fr;}
    }

    .help-text{
      font-size:0.78rem;
      color:var(--muted,#67706B);
      margin-top:3px;
    }

    /* Combo styles */
    .buttonish{
      width:100%;
      font:inherit;
      font-size:0.9rem;
      color:var(--text);
      background:var(--card-surface,var(--surface));
      border:1px solid var(--border);
      border-radius:var(--combo-btn-radius);
      padding:8px 32px 8px 10px;
      outline:none;
      text-align:left;
      cursor:pointer;
      position:relative;
    }
    .buttonish.has-caret::after{
      content:"";
      position:absolute;
      right:12px;
      top:50%;
      width:0;height:0;
      border-left:6px solid transparent;
      border-right:6px solid transparent;
      border-top:7px solid var(--muted,#67706B);
      transform:translateY(-50%);
      pointer-events:none;
    }
    .combo{position:relative;}
    .combo .combo-anchor{position:relative;display:inline-block;width:100%;}
    .combo-panel{
      position:absolute;
      left:0;right:0;
      top:calc(100% + var(--combo-gap));
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--combo-radius);
      box-shadow:var(--combo-shadow);
      /* lower z-index so dropdowns can sit behind the footer, not on top of it */
      z-index:40;
      padding:8px;
      display:none;
    }
    .combo-panel.show{display:block;}
    .combo-panel .search{padding:4px 2px 8px;}
    .combo-panel .search input{
      width:100%;
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:var(--combo-btn-radius);
      font:inherit;
      font-size:0.9rem;
    }
    .combo-panel .list{
      max-height:var(--combo-max-h);
      overflow:auto;
      border-top:1px solid var(--border);
    }
    .combo-item{
      padding:var(--combo-item-pad);
      border-bottom:1px solid var(--border);
      cursor:pointer;
      font-size:0.9rem;
    }
    .combo-item:last-child{border-bottom:none;}
    .combo-item:hover{background:rgba(0,0,0,.04);}
    .combo-empty{padding:var(--combo-item-pad);color:#67706B;font-size:0.85rem;}

    /* Trial cards */
    .trial-list{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:8px;
    }
    .trial-empty{
      padding:14px 16px;
      border-radius:12px;
      border:1px dashed var(--border);
      background:var(--card-surface,var(--surface));
      font-size:0.95rem;
      opacity:0.9;
    }
    .trial-card{
      border-radius:14px;
      border:1px solid var(--card-border,var(--border));
      background:var(--card-surface,var(--surface));
      box-shadow:var(--shadow-soft,var(--shadow));
      padding:12px 14px 10px;
      display:flex;
      flex-direction:column;
      gap:6px;
      cursor:pointer;
      transition:transform .06s, box-shadow .12s, border-color .12s, background .12s;
    }
    .trial-card:active{
      transform:scale(.995);
      box-shadow:var(--shadow);
    }
    .trial-row-top{
      display:flex;
      align-items:flex-start;
      gap:10px;
    }
    .trial-main{flex:1 1 auto;min-width:0;}
    .trial-title{
      font-weight:700;
      font-size:0.98rem;
      line-height:1.3;
      color:var(--text);
    }
    .trial-sub{
      font-size:0.86rem;
      opacity:0.9;
      margin-top:2px;
    }
    .trial-meta{
      display:flex;
      flex-wrap:wrap;
      gap:6px 10px;
      margin-top:4px;
      font-size:0.8rem;
      opacity:0.9;
    }
    .trial-meta span{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 7px;
      border-radius:999px;
      background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
    }
    .trial-meta-label{
      font-weight:600;
    }
    .trial-status-chip{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 8px;
      border-radius:999px;
      font-size:0.78rem;
      text-transform:uppercase;
      letter-spacing:0.06em;
      background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
      color:var(--text);
    }
    .trial-bottom-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      font-size:0.78rem;
      opacity:0.85;
      margin-top:4px;
    }

    /* Shared scroll helper for panels */
    .scroll-panel{
      max-height:92vh;
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
      border-radius:inherit;
    }

    /* Overlays */
    .trial-overlay,
    .modal-overlay,
    .field-overlay{
      position:fixed;
      inset:0;
      background:color-mix(in srgb, #000 45%, transparent);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:9999;
      overscroll-behavior:contain;
    }

    .trial-panel,
    .modal-panel,
    .field-panel{
      width:min(820px, 100% - 24px);
      border-radius:18px;
      background:var(--surface-raised,var(--card-surface,var(--surface)));
      box-shadow:var(--shadow-strong,0 18px 45px rgba(0,0,0,.35));
      padding:16px 16px 14px;
      display:flex;
      flex-direction:column;
      gap:12px;
      box-sizing:border-box;
      overflow-x:hidden;
      max-height:92vh;
    }

    .modal-panel{
      width:min(520px,100% - 24px);
    }

    .field-panel{
      width:min(720px,100% - 24px);
      font-size:0.86rem;
    }

    @media(max-width:700px){
      .trial-panel,
      .modal-panel,
      .field-panel{
        width:100%;
        max-width:100%;
        border-radius:18px;
        align-self:center; /* center on mobile instead of bottom */
      }
    }

    .trial-panel-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      cursor:pointer;
    }
    .trial-panel-title{
      font-weight:700;
      font-size:1rem;
      line-height:1.3;
      color:var(--text);
    }
    .trial-panel-sub{
      font-size:0.86rem;
      opacity:0.9;
      margin-top:2px;
    }
    .trial-panel-close{
      border:none;
      background:transparent;
      font-size:1.3rem;
      line-height:1;
      cursor:pointer;
      padding:4px;
      border-radius:999px;
      color:var(--text);
    }
    .trial-header-chips{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:6px;
      font-size:0.78rem;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 8px;
      border-radius:999px;
      background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
      font-size:0.78rem;
      color:var(--text);
    }
    .chip-label{font-weight:600;}

    .trial-section{
      border-top:1px solid var(--border-soft,var(--border));
      padding-top:8px;
      margin-top:4px;
      font-size:0.86rem;
    }
    .trial-section h3{
      font-size:0.9rem;
      margin:0 0 4px;
    }
    .trial-notes{
      font-size:0.84rem;
      white-space:pre-wrap;
    }

    .pill-list{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-top:4px;
    }
    .field-pill{
      border-radius:999px;
      border:1px solid var(--border);
      padding:8px 10px;
      display:flex;
      align-items:center;
      gap:8px;
      background:var(--card-surface,var(--surface));
      font-size:0.84rem;
      cursor:pointer;
    }
    .field-pill-main{
      font-weight:700;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      color:var(--text); /* prevent blue link styling */
    }
    .field-pill-sub{
      font-size:0.78rem;
      color:var(--muted,#67706B);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .trial-error{
      color:#b00020;
      font-size:0.8rem;
      margin-top:4px;
    }

    .trial-footer{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-top:6px;
      font-size:0.8rem;
      opacity:0.85;
    }

    /* Green gradient divider like Field Maintenance popup */
    .modal-divider{
      height:3px;
      margin:10px -4px 10px;
      border-radius:8px;
      background:linear-gradient(90deg,#3B7E46,#AFCF71);
    }

    /* Edit Trial modal */
    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
    }
    .modal-header h2{
      margin:0;
      font-size:1rem;
      color:var(--text);
    }
    .modal-actions{
      display:flex;
      justify-content:flex-end;
      gap:8px;
      margin-top:6px;
    }

    /* Field overlay */
    .field-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:8px;
    }
    .field-title{font-weight:700;font-size:0.98rem;color:var(--text);}
    .field-sub{font-size:0.82rem;opacity:0.9;margin-top:2px;}

    .field-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:8px;
    }
    @media(max-width:600px){
      .field-grid{grid-template-columns:1fr;}
    }

    .textarea{
      width:100%;
      min-height:80px;
      resize:vertical;
      font:inherit;
      font-size:0.86rem;
      padding:6px 8px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--surface);
      color:var(--text);
      box-sizing:border-box;
    }

    .yield-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
      gap:6px;
      margin-top:4px;
    }
    .yield-list{
      margin-top:6px;
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:0.8rem;
    }
    .yield-pill{
      border-radius:10px;
      border:1px solid var(--border);
      padding:6px 8px;
      background:var(--card-surface,var(--surface));
    }

    /* Yield header row for button placement */
    .yield-header-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:calc(env(safe-area-inset-bottom,0px) + 72px);
      transform:translateX(-50%);
      background:#2F6C3C;
      color:#fff;
      padding:10px 14px;
      border-radius:10px;
      box-shadow:0 6px 20px rgba(0,0,0,.25);
      z-index:12000;
      display:none;
      font-size:0.86rem;
    }
    .toast.show{display:block;animation:fadeout 4.5s forwards;}
    @keyframes fadeout{0%{opacity:1}85%{opacity:1}100%{opacity:0}}

    .text-danger{color:#b00020;}
    .fw-bold{font-weight:700;}
  </style>

  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true;
        document.head.appendChild(s);
      }
    })();
  </script>
  <!-- End Part 1 of 8 -->

      <!-- ===== Part 2 of 8: Trial detail overlay HTML (Add Field button theme, Mark Completed footer shell) ===== -->

    <!-- Trial detail overlay -->
    <div id="trialOverlay" class="trial-overlay" hidden>
      <div id="trialPanel" class="trial-panel scroll-panel" role="dialog" aria-modal="true" aria-labelledby="trialHdrTitle">
        <header id="trialHdrClickArea" class="trial-panel-header" title="Tap to edit trial details">
          <div>
            <div id="trialHdrTitle" class="trial-panel-title">Trial name</div>
            <div id="trialHdrSub" class="trial-panel-sub">Year ¬∑ Crop ¬∑ Trial type</div>
            <div id="trialHdrChips" class="trial-header-chips"></div>
          </div>
          <!-- Close button (Mark Completed button currently injected by JS near header, will be moved to footer in later part) -->
          <button type="button" id="trialCloseBtn" class="trial-panel-close" aria-label="Close trial">
            √ó
          </button>
        </header>

        <div class="trial-section">
          <div class="trial-footer">
            <div>
              <div id="trialMetaCreated"></div>
            </div>
            <div>
              <span class="trial-status-chip" id="trialMetaStatus">Active</span>
            </div>
          </div>
        </div>

        <section class="trial-section">
          <h3>Trial-level notes</h3>
          <div id="trialNotes" class="trial-notes">
            No trial-level notes yet.
          </div>
        </section>

        <!-- Green gradient divider like Field Maintenance popup -->
        <div class="modal-divider"></div>

        <section class="trial-section">
          <h3>Fields in this trial</h3>
          <div id="trialMetaFields" class="help-text">0 fields in this trial</div>
          <div id="trialFieldsList" class="pill-list" style="margin-top:6px;"></div>
        </section>

        <section class="trial-section">
          <button type="button" id="openAddFieldModalBtn" class="btn btn-quiet btn-small">
            Add Field
          </button>
        </section>

        <!-- Bottom-right Mark Completed shell; wired up in Part 3 -->
        <section class="trial-section">
          <div class="trial-footer">
            <div></div>
            <div>
              <button
                type="button"
                id="trialMarkCompletedBtn"
                class="btn btn-quiet btn-small"
                hidden
              >
                Mark Completed
              </button>
            </div>
          </div>
        </section>
      </div>
    </div>
    <!-- End Part 2 of 8 -->

  <!-- ===== Part 3 of 8: Trial detail JS ‚Äì move Mark Completed to bottom-right, no emoji, theme button ===== -->

  /* ============ Trial Detail overlay with MARK COMPLETED button ============ */
  function openTrialDetail(item){
    STATE.currentTrial = item;
    const overlay = $('#trialOverlay');
    const d = item.data || {};

    const titleEl = $('#trialHdrTitle');
    const subEl   = $('#trialHdrSub');
    const chipsEl = $('#trialHdrChips');
    const notesEl = $('#trialNotes');
    const createdEl = $('#trialMetaCreated');
    const statusEl  = $('#trialMetaStatus');
    const fieldsCountEl = $('#trialMetaFields');

    const trialName = d.trialName || 'Untitled trial';
    const cropYear = d.cropYear || null;
    const cropLabelRaw = d.cropLabel || d.cropCode || '';
    const typeLabelRaw = d.trialTypeLabel || d.trialType || '';
    const opTaskRaw = d.operationTaskLabel || d.operationTaskCode || '';
    const cropLabel = smartLabel(cropLabelRaw);
    const typeLabel = smartLabel(typeLabelRaw);
    const opTask = smartLabel(opTaskRaw);

    const statusRaw = d.status || 'active';
    const bucket = statusBucket(statusRaw);
    const fieldCount = d.fieldCount || (Array.isArray(d.fields)? d.fields.length : 0);
    const ts = d.createdAt || null;
    const when = ts && ts.toDate ? ts.toDate() : null;

    if(titleEl) titleEl.textContent = trialName;
    if(subEl){
      const pieces = [];
      if(cropYear) pieces.push(cropYear);
      if(cropLabel) pieces.push(cropLabel);
      if(typeLabel) pieces.push(typeLabel);
      subEl.textContent = pieces.join(' ¬∑ ') || 'Trial details';
    }

    /* STATUS CHIP */
    if(statusEl){
      statusEl.textContent = bucketLabel(bucket);
    }

    /* Configure bottom-right ‚ÄúMark Completed‚Äù button (no emoji, theme style) */
    insertMarkCompletedButton(bucket === 'completed');

    if(chipsEl){
      chipsEl.innerHTML = '';
      if(opTask){
        const span = document.createElement('span');
        span.className = 'chip';
        span.innerHTML = `<span class="chip-label">Operation</span> ${opTask}`;
        chipsEl.appendChild(span);
      }
      const fcSpan = document.createElement('span');
      fcSpan.className = 'chip';
      fcSpan.innerHTML = `<span class="chip-label">Fields</span> ${fieldCount}`;
      chipsEl.appendChild(fcSpan);
    }

    if(notesEl){
      const n = d.notes || '';
      notesEl.textContent = n || 'No trial-level notes yet.';
    }
    if(createdEl){
      createdEl.textContent = when
        ? `Created ${when.toLocaleDateString()} ${when.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}`
        : '';
    }
    if(fieldsCountEl){
      fieldsCountEl.textContent = `${fieldCount} field${fieldCount===1?'':'s'} in this trial`;
    }

    STATE.currentFieldIdx = null;
    renderFieldsList(d);

    overlay.hidden = false;
    document.body.style.overflow = 'hidden';
  }

  function insertMarkCompletedButton(isCompleted){
    const btn = $('#trialMarkCompletedBtn');
    if(!btn) return;

    // If trial already completed, hide the button
    if(isCompleted){
      btn.hidden = true;
      btn.onclick = null;
      return;
    }

    // Show themed button, no emoji
    btn.hidden = false;
    btn.textContent = 'Mark Completed';
    btn.className = 'btn btn-quiet btn-small';

    btn.onclick = async (ev)=>{
      ev.stopPropagation();
      await markTrialCompleted();
    };
  }

  async function markTrialCompleted(){
    const item = STATE.currentTrial;
    if(!item || !STATE.db) return;

    try{
      await updateDoc(doc(STATE.db,'fieldTrials',item.id), {
        status: 'completed',
        updatedAt: serverTimestamp()
      });

      item.data.status = 'completed';
      showToast('Trial marked completed.');

      closeTrialDetail();
      applyFilters();
    }catch(err){
      console.error('Failed to mark completed:', err);
      alert('Could not update trial status.');
    }
  }

  /* ===== End Part 3 of 8 ===== */

    <!-- ===== Part 4 of 8: Field overlay button theming + ‚ÄúAdd Yield Data‚Äù label ===== -->

    <!-- Field-in-Trial overlay (includes yield blocks) -->
    <div id="fieldOverlay" class="field-overlay" hidden>
      <div class="field-panel scroll-panel" role="dialog" aria-modal="true">
        <header class="field-header">
          <div>
            <div id="fieldTitle" class="field-title">Field ¬∑ Farm</div>
            <div id="fieldSub" class="field-sub">Farm</div>
            <div id="fieldTrialBadge" class="help-text" style="margin-top:4px;">Trial ¬∑ Year ¬∑ Crop</div>
          </div>
          <button type="button" id="fieldCloseBtn" class="trial-panel-close" aria-label="Close">√ó</button>
        </header>

        <section class="trial-section">
          <h3>Trial info for this field</h3>
          <div class="field-grid">
            <div class="field">
              <label for="fieldVariety">Variety / hybrid (for this field)</label>
              <input id="fieldVariety" class="input" placeholder="e.g. P1742Q" />
            </div>
            <div class="field">
              <label for="fieldPlacement">Placement / application</label>
              <input id="fieldPlacement" class="input" placeholder="e.g. South end, across rows" />
            </div>
            <div class="field">
              <label for="fieldPlantingDate">Planting date</label>
              <input id="fieldPlantingDate" type="date" class="input" />
            </div>
            <div class="field">
              <label for="fieldTrialAcres">Trial acres (for this field)</label>
              <input id="fieldTrialAcres" class="input" type="number" min="0" step="0.01" inputmode="decimal" placeholder="e.g. 12.5" />
              <div class="help-text">Acres of this field that are actually in the trial.</div>
            </div>
            <div class="field" style="grid-column:1/-1;">
              <label for="fieldNotes">Field-specific notes</label>
              <textarea id="fieldNotes" class="textarea" placeholder="Pop, passes, planter rows, etc."></textarea>
            </div>
          </div>
          <div id="fieldInfoError" class="trial-error" hidden></div>
          <div style="margin-top:6px;">
            <!-- Themed button (non-green) -->
            <button type="button" id="fieldSaveInfoBtn" class="btn btn-quiet btn-small">
              Save field trial info
            </button>
          </div>
        </section>

        <section class="trial-section">
          <div class="yield-header-row">
            <h3>Yield blocks for this field</h3>
            <!-- Renamed + de-greened: ‚ÄúAdd Yield Data‚Äù -->
            <button type="button" id="openYieldFormBtn" class="btn btn-quiet btn-small">
              Add Yield Data
            </button>
          </div>

          <div id="yieldForm" hidden>
            <div class="yield-grid" style="margin-top:6px;">
              <div class="field">
                <label for="yBlockAcres">Block acres</label>
                <input id="yBlockAcres" type="number" step="0.01" min="0" inputmode="decimal" class="input" placeholder="e.g. 12.5" />
              </div>
              <div class="field">
                <label for="yBlockLbs">Pounds of grain</label>
                <input id="yBlockLbs" type="text" inputmode="numeric" pattern="[0-9,]*" class="input" placeholder="e.g. 65,000" />
              </div>
              <div class="field">
                <label for="yBlockMoisture">Moisture (%)</label>
                <input id="yBlockMoisture" type="number" step="0.01" min="5" max="40" inputmode="decimal" class="input" placeholder="e.g. 21.0" />
              </div>
              <div class="field">
                <label for="yBlockCombines"># combines (info only)</label>
                <input id="yBlockCombines" type="number" step="1" min="0" inputmode="numeric" class="input" placeholder="e.g. 2" />
              </div>
            </div>
            <div class="field" style="margin-top:6px;">
              <label for="yBlockNotes">Notes (optional)</label>
              <textarea id="yBlockNotes" class="textarea" placeholder="Strip name, direction, program label, etc."></textarea>
            </div>
            <div id="yBlockYieldHelper" class="help-text" style="margin-top:4px;">
              Enter acres, pounds, and moisture to see calculated yield.
            </div>
            <div id="fieldYieldError" class="trial-error" hidden></div>
            <div style="margin-top:6px;">
              <!-- Themed button (non-green) -->
              <button type="button" id="saveYieldBlockBtn" class="btn btn-quiet btn-small">
                Save yield block
              </button>
            </div>
          </div>

          <div id="yieldList" class="yield-list"></div>
        </section>

        <footer class="trial-footer" style="margin-top:8px;">
          <button type="button" id="fieldCancelBtn" class="btn btn-quiet btn-small">Close</button>
        </footer>
      </div>
    </div>
    <!-- End Part 4 of 8 -->

   <!-- ===== Part 5 of 8: Yield block remove/delete behavior (desktop button + prep for swipe) ===== -->

  <script type="module">
    import {
      ready as fbReady,
      getFirestore,
      collection, getDocs, doc, updateDoc, addDoc, deleteDoc,
      query, orderBy,
      serverTimestamp
    } from '/Farm-vista/js/firebase-init.js';

    import { NAV_MENU } from '/Farm-vista/js/menu.js';

    const $  = (sel, root=document)=>root.querySelector(sel);
    const $$ = (sel, root=document)=>Array.from(root.querySelectorAll(sel));

    const STATE = {
      db: null,
      trials: [],
      filtered: [],
      filters: {
        status: 'active',  // 'active' | 'completed' | 'all'
        year: null,
        type: null
      },
      combos: {},
      currentTrial: null,
      currentFieldIdx: null,
      currentFieldYields: [],
      currentYieldEditId: null // null = add mode, id = edit mode
    };

    /* ... (all existing helpers and functions above renderYieldList stay the same) ... */

    function renderYieldList(){
      const listEl = $('#yieldList');
      if(!listEl) return;

      if(!STATE.currentFieldYields.length){
        listEl.innerHTML = '<div class="help-text">No yield blocks saved for this field yet.</div>';
        return;
      }

      listEl.innerHTML = STATE.currentFieldYields.map(y=>{
        const d = y.data || {};
        const acres = d.blockAcres ?? '?';
        const lbs   = d.lbs ?? '?';
        const moist = d.moisture ?? '?';
        const wet   = d.yieldWet?.toFixed?.(1) ?? '?';
        const adj   = d.yieldAdj?.toFixed?.(1) ?? '?';
        const combines = d.combines ? `¬∑ # combines: ${d.combines}` : '';
        const notes = d.notes ? `<div class="help-text">${d.notes}</div>` : '';

        return `
          <div class="yield-pill" data-yid="${y.id}">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;">
              <div>
                <div>
                  <span class="fw-bold">${acres} ac</span> ¬∑ ${lbs} lbs ¬∑ ${moist}%
                </div>
                <div class="help-text">
                  Yield: ${wet} bu/ac (wet), ${adj} bu/ac adj. ${combines}
                </div>
                ${notes}
              </div>
              <!-- Desktop-visible Remove button -->
              <button
                type="button"
                class="btn btn-quiet btn-small yield-pill-remove"
                aria-label="Remove yield block"
              >
                Remove
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    async function deleteYieldBlock(yieldId){
      const item = STATE.currentTrial;
      const db = STATE.db;
      if(!item || !db || !yieldId) return;

      const confirmDelete = window.confirm('Remove this yield data block?');
      if(!confirmDelete) return;

      try{
        await deleteDoc(doc(db,'fieldTrials', item.id, 'yieldBlocks', yieldId));

        // Remove from local STATE and re-render
        STATE.currentFieldYields = STATE.currentFieldYields.filter(y=>y.id !== yieldId);
        renderYieldList();
        showToast('Yield block removed.');
      }catch(err){
        console.error('Failed to delete yield block:', err);
        const errEl = $('#fieldYieldError');
        if(errEl){
          errEl.textContent = `Error removing yield block: ${err.message}`;
          errEl.hidden = false;
        }
      }
    }

    /* ... inside boot() after other listeners ... */

    (async function boot(){
      await Promise.all([
        fbReady,
        window.FVData && window.FVData.ready ? window.FVData.ready() : Promise.resolve()
      ]);

      const db  = getFirestore();
      STATE.db = db;

      const shell = document.querySelector('fv-shell');
      if(shell) shell.nav = NAV_MENU;

      $('#btnBack')?.addEventListener('click', ()=>{
        location.href = '/Farm-vista/pages/crop-production/trials.html';
      });

      initFilterCombos();
      initAddFieldCombos();

      await loadFarmsAndFields();
      await loadTrials();

      /* ... existing overlay bindings ... */

      // Click to edit OR delete yield blocks
      $('#yieldList')?.addEventListener('click', e=>{
        const removeBtn = e.target.closest('.yield-pill-remove');
        if(removeBtn){
          const pill = removeBtn.closest('.yield-pill');
          if(!pill) return;
          const yid = pill.dataset.yid;
          if(yid) deleteYieldBlock(yid);
          return; // don‚Äôt fall through to edit
        }

        const pill = e.target.closest('.yield-pill');
        if(!pill) return;
        const yid = pill.dataset.yid;
        const yItem = STATE.currentFieldYields.find(y=>y.id === yid);
        if(yItem) openYieldEdit(yItem);
      });

      window.addEventListener('online', ()=> showToast('Back online ‚Äî syncing‚Ä¶', 3500));
      window.addEventListener('offline',()=> showToast('Currently offline ‚Äî using saved data', 3500));
    })();
 </script>
    /* ===== End Part 5 of 8 ===== */
 
  <!-- ===== Part 6 of 8: Completion validation modal + logic (Mark Completed) ===== -->

  <!-- üîπ New ‚ÄúMissing Yield Data‚Äù modal (put this with your other modals, e.g. under Edit Trial modal) -->
  <div id="completionModalOverlay" class="modal-overlay" hidden>
    <div class="modal-panel scroll-panel" role="dialog" aria-modal="true" aria-labelledby="completionModalTitle">
      <header class="modal-header">
        <h2 id="completionModalTitle">Missing Yield Data</h2>
        <button type="button" id="completionModalCloseX" class="trial-panel-close" aria-label="Close">√ó</button>
      </header>

      <p class="help-text">
        The following fields do not have yield data saved. They will stay part of this trial,
        but they will <strong>not</strong> appear in the yield results.
      </p>

      <ul id="completionMissingList" class="pill-list" style="margin-top:8px;">
        <!-- Filled by JS -->
      </ul>

      <div class="trial-error" id="completionModalError" hidden></div>

      <div class="modal-actions">
        <button type="button" id="completionCancelBtn" class="btn btn-quiet btn-small">
          Cancel
        </button>
        <button type="button" id="completionConfirmBtn" class="btn btn-quiet btn-small">
          Mark Complete Anyway
        </button>
      </div>
    </div>
  </div>
  <!-- üî∏ End Missing Yield Data modal -->


  <script type="module">
    import {
      ready as fbReady,
      getFirestore,
      collection, getDocs, doc, updateDoc, addDoc, deleteDoc,
      query, orderBy,
      serverTimestamp
    } from '/Farm-vista/js/firebase-init.js';

    import { NAV_MENU } from '/Farm-vista/js/menu.js';

    const $  = (sel, root=document)=>root.querySelector(sel);
    const $$ = (sel, root=document)=>Array.from(root.querySelectorAll(sel));

    /* üîπ Updated STATE to track completion validation */
    const STATE = {
      db: null,
      trials: [],
      filtered: [],
      filters: {
        status: 'active',  // 'active' | 'completed' | 'all'
        year: null,
        type: null
      },
      combos: {},
      currentTrial: null,
      currentFieldIdx: null,
      currentFieldYields: [],
      currentYieldEditId: null, // null = add mode, id = edit mode
      completionMissingFields: []  // array of { fieldName, farmName }
    };

    /* ... all your existing helper functions (showToast, smartLabel, combos, filters, list, etc.) stay the same ... */


    /* ============ Trial Detail overlay with MARK COMPLETED button ============ */
    function openTrialDetail(item){
      STATE.currentTrial = item;
      const overlay = $('#trialOverlay');
      const d = item.data || {};

      const titleEl = $('#trialHdrTitle');
      const subEl   = $('#trialHdrSub');
      const chipsEl = $('#trialHdrChips');
      const notesEl = $('#trialNotes');
      const createdEl = $('#trialMetaCreated');
      const statusEl  = $('#trialMetaStatus');
      const fieldsCountEl = $('#trialMetaFields');

      const trialName = d.trialName || 'Untitled trial';
      const cropYear = d.cropYear || null;
      const cropLabelRaw = d.cropLabel || d.cropCode || '';
      const typeLabelRaw = d.trialTypeLabel || d.trialType || '';
      const opTaskRaw = d.operationTaskLabel || d.operationTaskCode || '';
      const cropLabel = smartLabel(cropLabelRaw);
      const typeLabel = smartLabel(typeLabelRaw);
      const opTask = smartLabel(opTaskRaw);

      const statusRaw = d.status || 'active';
      const bucket = statusBucket(statusRaw);
      const fieldCount = d.fieldCount || (Array.isArray(d.fields)? d.fields.length : 0);
      const ts = d.createdAt || null;
      const when = ts && ts.toDate ? ts.toDate() : null;

      if(titleEl) titleEl.textContent = trialName;
      if(subEl){
        const pieces = [];
        if(cropYear) pieces.push(cropYear);
        if(cropLabel) pieces.push(cropLabel);
        if(typeLabel) pieces.push(typeLabel);
        subEl.textContent = pieces.join(' ¬∑ ') || 'Trial details';
      }

      /* STATUS CHIP */
      if(statusEl){
        statusEl.textContent = bucketLabel(bucket);
      }

      /* Configure bottom-right ‚ÄúMark Completed‚Äù button (no emoji, theme style) */
      insertMarkCompletedButton(bucket === 'completed');

      if(chipsEl){
        chipsEl.innerHTML = '';
        if(opTask){
          const span = document.createElement('span');
          span.className = 'chip';
          span.innerHTML = `<span class="chip-label">Operation</span> ${opTask}`;
          chipsEl.appendChild(span);
        }
        const fcSpan = document.createElement('span');
        fcSpan.className = 'chip';
        fcSpan.innerHTML = `<span class="chip-label">Fields</span> ${fieldCount}`;
        chipsEl.appendChild(fcSpan);
      }

      if(notesEl){
        const n = d.notes || '';
        notesEl.textContent = n || 'No trial-level notes yet.';
      }
      if(createdEl){
        createdEl.textContent = when
          ? `Created ${when.toLocaleDateString()} ${when.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}`
          : '';
      }
      if(fieldsCountEl){
        fieldsCountEl.textContent = `${fieldCount} field${fieldCount===1?'':'s'} in this trial`;
      }

      STATE.currentFieldIdx = null;
      renderFieldsList(d);

      overlay.hidden = false;
      document.body.style.overflow = 'hidden';
    }

    function insertMarkCompletedButton(isCompleted){
      const btn = $('#trialMarkCompletedBtn');
      if(!btn) return;

      if(isCompleted){
        btn.hidden = true;
        btn.onclick = null;
        return;
      }

      // Show themed button, no emoji
      btn.hidden = false;
      btn.textContent = 'Mark Completed';
      btn.className = 'btn btn-quiet btn-small';

      btn.onclick = handleMarkCompletedClick;
    }

    /* üîπ Figure out which fields are missing yield data */
    async function computeMissingYieldFields(item){
      const db = STATE.db;
      if(!db || !item) return [];

      const d = item.data || {};
      const fieldsArr = Array.isArray(d.fields) ? d.fields : [];
      if(!fieldsArr.length) return [];

      // Load yieldBlocks for this trial
      const col = collection(db,'fieldTrials', item.id, 'yieldBlocks');
      const snap = await getDocs(col);
      const withYield = new Set();

      snap.forEach(docSnap=>{
        const y = docSnap.data() || {};
        if(y.fieldId){
          withYield.add(String(y.fieldId));
        }
      });

      const missing = [];
      for(const f of fieldsArr){
        const fid = f.fieldId ? String(f.fieldId) : null;
        if(!fid || !withYield.has(fid)){
          missing.push({
            fieldName: f.fieldName || 'Field ?',
            farmName: f.farmName || ''
          });
        }
      }
      return missing;
    }

    function openCompletionModal(missing){
      const overlay = $('#completionModalOverlay');
      const listEl  = $('#completionMissingList');
      const errEl   = $('#completionModalError');
      if(!overlay || !listEl) return;

      listEl.innerHTML = missing.map(m=>{
        const label = m.farmName
          ? `${m.fieldName} ¬∑ ${m.farmName}`
          : m.fieldName;
        return `<li class="field-pill"><span class="field-pill-main">${label}</span></li>`;
      }).join('');

      if(!missing.length){
        listEl.innerHTML = '<li class="help-text">All fields have yield data.</li>';
      }

      if(errEl){
        errEl.textContent = '';
        errEl.hidden = true;
      }

      overlay.hidden = false;
    }

    function closeCompletionModal(){
      const overlay = $('#completionModalOverlay');
      if(overlay) overlay.hidden = true;
    }

    /* üîπ Click handler for Mark Completed (runs validation first) */
    async function handleMarkCompletedClick(ev){
      ev.stopPropagation();
      const item = STATE.currentTrial;
      if(!item || !STATE.db) return;

      try{
        const missing = await computeMissingYieldFields(item);
        STATE.completionMissingFields = missing;

        if(missing.length){
          openCompletionModal(missing);
        }else{
          await markTrialCompleted();
        }
      }catch(err){
        console.error('Error during completion validation:', err);
        const errEl = $('#completionModalError');
        if(errEl){
          errEl.textContent = `Error checking yield data: ${err.message}`;
          errEl.hidden = false;
          openCompletionModal([]); // show modal so error is visible
        }
      }
    }

    /* üîπ Actual write of status=completed (called after confirm or no-missing case) */
    async function markTrialCompleted(){
      const item = STATE.currentTrial;
      if(!item || !STATE.db) return;

      try{
        await updateDoc(doc(STATE.db,'fieldTrials',item.id), {
          status: 'completed',
          updatedAt: serverTimestamp()
        });

        item.data.status = 'completed';
        showToast('Trial marked completed.');

        closeCompletionModal();
        closeTrialDetail();
        applyFilters();
      }catch(err){
        console.error('Failed to mark completed:', err);
        alert('Could not update trial status.');
      }
    }

    /* ... your existing renderFieldsList, field overlay, yield helpers, renderYieldList, saveYieldBlock, etc. stay the same (including Part 5 remove logic) ... */


    /* ============ Boot ============ */
    (async function boot(){
      await Promise.all([
        fbReady,
        window.FVData && window.FVData.ready ? window.FVData.ready() : Promise.resolve()
      ]);

      const db  = getFirestore();
      STATE.db = db;

      const shell = document.querySelector('fv-shell');
      if(shell) shell.nav = NAV_MENU;

      $('#btnBack')?.addEventListener('click', ()=>{
        location.href = '/Farm-vista/pages/crop-production/trials.html';
      });

      initFilterCombos();
      initAddFieldCombos();

      await loadFarmsAndFields();
      await loadTrials();

      // Trial overlay
      $('#trialOverlay')?.addEventListener('click', e=>{
        if(e.target.id === 'trialOverlay') closeTrialDetail();
      });
      $('#trialCloseBtn')?.addEventListener('click', closeTrialDetail);

      $('#trialHdrClickArea')?.addEventListener('click', openEditTrialModal);

      // Edit Trial modal
      $('#editTrialOverlay')?.addEventListener('click', e=>{
        if(e.target.id === 'editTrialOverlay') closeEditTrialModal();
      });
      $('#editTrialCloseX')?.addEventListener('click', closeEditTrialModal);
      $('#editTrialCancel')?.addEventListener('click', closeEditTrialModal);
      $('#editTrialSave')?.addEventListener('click', saveEditTrial);

      // Add field modal
      $('#openAddFieldModalBtn')?.addEventListener('click', openAddFieldModal);
      $('#addFieldOverlay')?.addEventListener('click', e=>{
        if(e.target.id === 'addFieldOverlay') closeAddFieldModal();
      });
      $('#addFieldCancelBtn')?.addEventListener('click', closeAddFieldModal);
      $('#trialAddFieldBtnSave')?.addEventListener('click', handleAddFieldToTrial);

      // Field overlay
      $('#trialFieldsList')?.addEventListener('click', e=>{
        const pill = e.target.closest('.field-pill');
        if(!pill) return;
        const idx = Number(pill.dataset.idx);
        openFieldOverlay(idx);
      });

      $('#fieldOverlay')?.addEventListener('click', e=>{
        if(e.target.id === 'fieldOverlay') closeFieldOverlay();
      });
      $('#fieldCloseBtn')?.addEventListener('click', closeFieldOverlay);
      $('#fieldCancelBtn')?.addEventListener('click', closeFieldOverlay);
      $('#fieldSaveInfoBtn')?.addEventListener('click', saveFieldTrialInfo);

      // Yield form open, editing, and input events
      $('#openYieldFormBtn')?.addEventListener('click', openYieldFormNew);

      $('#yBlockAcres')?.addEventListener('input', updateYieldHelper);
      $('#yBlockMoisture')?.addEventListener('input', updateYieldHelper);
      $('#yBlockCombines')?.addEventListener('input', updateYieldHelper);

      // Pounds input with commas
      const lbsInput = $('#yBlockLbs');
      if(lbsInput){
        lbsInput.addEventListener('input', (e)=>{
          let raw = e.target.value;
          raw = raw.replace(/[^\d]/g,'');
          if(!raw){
            e.target.value = '';
            updateYieldHelper();
            return;
          }
          const num = Number(raw);
          e.target.value = num.toLocaleString();
          updateYieldHelper();
        });
      }

      $('#saveYieldBlockBtn')?.addEventListener('click', saveYieldBlock);

      // Click to edit OR delete yield blocks (desktop remove from Part 5)
      $('#yieldList')?.addEventListener('click', e=>{
        const removeBtn = e.target.closest('.yield-pill-remove');
        if(removeBtn){
          const pill = removeBtn.closest('.yield-pill');
          if(!pill) return;
          const yid = pill.dataset.yid;
          if(yid) deleteYieldBlock(yid);
          return; // don‚Äôt fall through to edit
        }

        const pill = e.target.closest('.yield-pill');
        if(!pill) return;
        const yid = pill.dataset.yid;
        const yItem = STATE.currentFieldYields.find(y=>y.id === yid);
        if(yItem) openYieldEdit(yItem);
      });

      // Completion modal events
      $('#completionModalOverlay')?.addEventListener('click', e=>{
        if(e.target.id === 'completionModalOverlay') closeCompletionModal();
      });
      $('#completionModalCloseX')?.addEventListener('click', closeCompletionModal);
      $('#completionCancelBtn')?.addEventListener('click', closeCompletionModal);
      $('#completionConfirmBtn')?.addEventListener('click', async ()=>{
        await markTrialCompleted();
      });

      window.addEventListener('online', ()=> showToast('Back online ‚Äî syncing‚Ä¶', 3500));
      window.addEventListener('offline',()=> showToast('Currently offline ‚Äî using saved data', 3500));
    })();
</script>
    /* ===== End Part 6 of 8 ===== */
  
    <!-- ===== Part 7 of 8: Field overlay Variety / Placement dropdowns (no free text) ===== -->

    <!-- Field-in-Trial overlay (includes yield blocks) -->
    <div id="fieldOverlay" class="field-overlay" hidden>
      <div class="field-panel scroll-panel" role="dialog" aria-modal="true">
        <header class="field-header">
          <div>
            <div id="fieldTitle" class="field-title">Field ¬∑ Farm</div>
            <div id="fieldSub" class="field-sub">Farm</div>
            <div id="fieldTrialBadge" class="help-text" style="margin-top:4px;">Trial ¬∑ Year ¬∑ Crop</div>
          </div>
          <button type="button" id="fieldCloseBtn" class="trial-panel-close" aria-label="Close">√ó</button>
        </header>

        <section class="trial-section">
          <h3>Trial info for this field</h3>
          <div class="field-grid">
            <!-- Variety dropdown (no free text) -->
            <div class="field combo">
              <label for="fieldVarietyBtn">Variety / hybrid (for this field)</label>
              <div class="combo-anchor">
                <button id="fieldVarietyBtn" type="button" class="buttonish has-caret">
                  ‚Äî Select variety ‚Äî
                </button>
                <div id="fieldVarietyPanel" class="combo-panel" role="listbox" aria-label="Variety list">
                  <div class="search">
                    <input id="fieldVarietySearch" type="search" placeholder="Search varieties‚Ä¶" />
                  </div>
                  <div class="list" id="fieldVarietyList"></div>
                </div>
              </div>
              <div id="fieldVarietyHelp" class="help-text">Varieties not loaded yet.</div>
            </div>

            <!-- Placement dropdown (no free text) -->
            <div class="field combo">
              <label for="fieldPlacementBtn">Placement / application</label>
              <div class="combo-anchor">
                <button id="fieldPlacementBtn" type="button" class="buttonish has-caret">
                  ‚Äî Select placement ‚Äî
                </button>
                <div id="fieldPlacementPanel" class="combo-panel" role="listbox" aria-label="Placement list">
                  <div class="list" id="fieldPlacementList"></div>
                </div>
              </div>
              <div id="fieldPlacementHelp" class="help-text">Choose where this trial sits in the field.</div>
            </div>

            <div class="field">
              <label for="fieldPlantingDate">Planting date</label>
              <input id="fieldPlantingDate" type="date" class="input" />
            </div>
            <div class="field">
              <label for="fieldTrialAcres">Trial acres (for this field)</label>
              <input id="fieldTrialAcres" class="input" type="number" min="0" step="0.01" inputmode="decimal" placeholder="e.g. 12.5" />
              <div class="help-text">Acres of this field that are actually in the trial.</div>
            </div>
            <div class="field" style="grid-column:1/-1;">
              <label for="fieldNotes">Field-specific notes</label>
              <textarea id="fieldNotes" class="textarea" placeholder="Pop, passes, planter rows, etc."></textarea>
            </div>
          </div>
          <div id="fieldInfoError" class="trial-error" hidden></div>
          <div style="margin-top:6px;">
            <!-- Themed button (non-green) -->
            <button type="button" id="fieldSaveInfoBtn" class="btn btn-quiet btn-small">
              Save field trial info
            </button>
          </div>
        </section>

        <!-- (Yield section from earlier parts stays the same) -->
        <section class="trial-section">
          <div class="yield-header-row">
            <h3>Yield blocks for this field</h3>
            <button type="button" id="openYieldFormBtn" class="btn btn-quiet btn-small">
              Add Yield Data
            </button>
          </div>

          <!-- ... yield form + list from earlier parts ... -->
          <div id="yieldForm" hidden>
            <!-- unchanged from Part 4 -->
          </div>

          <div id="yieldList" class="yield-list"></div>
        </section>

        <footer class="trial-footer" style="margin-top:8px;">
          <button type="button" id="fieldCancelBtn" class="btn btn-quiet btn-small">Close</button>
        </footer>
      </div>
    </div>
    <!-- End Part 7 of 8 (HTML section) -->

    <!-- ===== Part 8 of 8: Field-level + Yield-block attachments, swipe-to-delete ===== -->

    <!-- üîπ UPDATED Field-in-Trial overlay (adds Attachments under notes) -->
    <div id="fieldOverlay" class="field-overlay" hidden>
      <div class="field-panel scroll-panel" role="dialog" aria-modal="true">
        <header class="field-header">
          <div>
            <div id="fieldTitle" class="field-title">Field ¬∑ Farm</div>
            <div id="fieldSub" class="field-sub">Farm</div>
            <div id="fieldTrialBadge" class="help-text" style="margin-top:4px;">Trial ¬∑ Year ¬∑ Crop</div>
          </div>
          <button type="button" id="fieldCloseBtn" class="trial-panel-close" aria-label="Close">√ó</button>
        </header>

        <section class="trial-section">
          <h3>Trial info for this field</h3>
          <div class="field-grid">
            <!-- Variety dropdown from Part 7 -->
            <div class="field combo">
              <label for="fieldVarietyBtn">Variety / hybrid (for this field)</label>
              <div class="combo-anchor">
                <button id="fieldVarietyBtn" type="button" class="buttonish has-caret">
                  ‚Äî Select variety ‚Äî
                </button>
                <div id="fieldVarietyPanel" class="combo-panel" role="listbox" aria-label="Variety list">
                  <div class="search">
                    <input id="fieldVarietySearch" type="search" placeholder="Search varieties‚Ä¶" />
                  </div>
                  <div class="list" id="fieldVarietyList"></div>
                </div>
              </div>
              <div id="fieldVarietyHelp" class="help-text">Varieties not loaded yet.</div>
            </div>

            <!-- Placement dropdown from Part 7 -->
            <div class="field combo">
              <label for="fieldPlacementBtn">Placement / application</label>
              <div class="combo-anchor">
                <button id="fieldPlacementBtn" type="button" class="buttonish has-caret">
                  ‚Äî Select placement ‚Äî
                </button>
                <div id="fieldPlacementPanel" class="combo-panel" role="listbox" aria-label="Placement list">
                  <div class="list" id="fieldPlacementList"></div>
                </div>
              </div>
              <div id="fieldPlacementHelp" class="help-text">Choose where this trial sits in the field.</div>
            </div>

            <div class="field">
              <label for="fieldPlantingDate">Planting date</label>
              <input id="fieldPlantingDate" type="date" class="input" />
            </div>
            <div class="field">
              <label for="fieldTrialAcres">Trial acres (for this field)</label>
              <input id="fieldTrialAcres" class="input" type="number" min="0" step="0.01" inputmode="decimal" placeholder="e.g. 12.5" />
              <div class="help-text">Acres of this field that are actually in the trial.</div>
            </div>

            <div class="field" style="grid-column:1/-1;">
              <label for="fieldNotes">Field-specific notes</label>
              <textarea id="fieldNotes" class="textarea" placeholder="Pop, passes, planter rows, etc."></textarea>
            </div>

            <!-- üîπ NEW: Field-level attachments block -->
            <div class="field" style="grid-column:1/-1;">
              <label>Attachments</label>
              <div class="help-text">Photos and files that support this field‚Äôs setup.</div>
              <div id="fieldAttachmentsList" class="pill-list" style="margin-top:4px;"></div>
              <button type="button" id="fieldAddAttachmentBtn" class="btn btn-quiet btn-small" style="margin-top:4px;">
                Add Attachments
              </button>
              <input id="fieldAttachmentInput" type="file" multiple hidden />
            </div>
          </div>

          <div id="fieldInfoError" class="trial-error" hidden></div>
          <div style="margin-top:6px;">
            <button type="button" id="fieldSaveInfoBtn" class="btn btn-quiet btn-small">
              Save field trial info
            </button>
          </div>
        </section>

        <section class="trial-section">
          <div class="yield-header-row">
            <h3>Yield blocks for this field</h3>
            <button type="button" id="openYieldFormBtn" class="btn btn-quiet btn-small">
              Add Yield Data
            </button>
          </div>

          <div id="yieldForm" hidden>
            <div class="yield-grid" style="margin-top:6px;">
              <div class="field">
                <label for="yBlockAcres">Block acres</label>
                <input id="yBlockAcres" type="number" step="0.01" min="0" inputmode="decimal" class="input" placeholder="e.g. 12.5" />
              </div>
              <div class="field">
                <label for="yBlockLbs">Pounds of grain</label>
                <input id="yBlockLbs" type="text" inputmode="numeric" pattern="[0-9,]*" class="input" placeholder="e.g. 65,000" />
              </div>
              <div class="field">
                <label for="yBlockMoisture">Moisture (%)</label>
                <input id="yBlockMoisture" type="number" step="0.01" min="5" max="40" inputmode="decimal" class="input" placeholder="e.g. 21.0" />
              </div>
              <div class="field">
                <label for="yBlockCombines"># combines (info only)</label>
                <input id="yBlockCombines" type="number" step="1" min="0" inputmode="numeric" class="input" placeholder="e.g. 2" />
              </div>
            </div>

            <div class="field" style="margin-top:6px;">
              <label for="yBlockNotes">Notes (optional)</label>
              <textarea id="yBlockNotes" class="textarea" placeholder="Strip name, direction, program label, etc."></textarea>
            </div>

            <!-- üîπ NEW: Per-yield-block attachments -->
            <div class="field" style="margin-top:6px;">
              <label>Supporting documents</label>
              <div class="help-text">Photos/files tied to this specific yield block.</div>
              <div id="yBlockAttachmentsList" class="pill-list" style="margin-top:4px;"></div>
              <button type="button" id="yBlockAddAttachmentBtn" class="btn btn-quiet btn-small">
                Add Supporting Documents
              </button>
              <input id="yBlockAttachmentInput" type="file" multiple hidden />
            </div>

            <div id="yBlockYieldHelper" class="help-text" style="margin-top:4px;">
              Enter acres, pounds, and moisture to see calculated yield.
            </div>
            <div id="fieldYieldError" class="trial-error" hidden></div>
            <div style="margin-top:6px;">
              <button type="button" id="saveYieldBlockBtn" class="btn btn-quiet btn-small">
                Save yield block
              </button>
            </div>
          </div>

          <div id="yieldList" class="yield-list"></div>
        </section>

        <footer class="trial-footer" style="margin-top:8px;">
          <button type="button" id="fieldCancelBtn" class="btn btn-quiet btn-small">Close</button>
        </footer>
      </div>
    </div>
    <!-- üî∏ End HTML for Part 8 of 8 -->

  
