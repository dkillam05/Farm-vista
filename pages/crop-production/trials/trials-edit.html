<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FarmVista • Field Trials</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#3B7E46" />

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest" />
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png" />
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png" />
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css" />
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css" />

  <style>
    :root{
      --card-max: 1200px;
      --page-bottom-gap: 96px;
      --accent: #2F6C3C;

      /* Combo vars */
      --combo-gap: 4px;
      --combo-radius: 12px;
      --combo-btn-radius: 10px;
      --combo-shadow: 0 12px 26px rgba(0,0,0,.18);
      --combo-item-pad: 10px 8px;
      --combo-max-h: 50vh;
    }

    [hidden]{display:none!important}
    html{-webkit-text-size-adjust:100%}
    body{
      background:var(--app-bg,var(--surface));
      overflow-x:hidden; /* guard against horizontal scroll */
    }

    a, a:visited{
      color:var(--text);
      text-decoration:none;
    }

    /* Main page wrapper */
    .page{
      max-width:var(--card-max);
      margin:0 auto;
      padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + var(--page-bottom-gap))!important;
      box-sizing:border-box;
      display:grid;
      gap:16px;
    }

    .hero{
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));
      overflow:hidden;
    }
    .hero-head{
      display:grid;
      grid-template-columns:36px 1fr;
      gap:12px;
      align-items:center;
      padding:14px 16px;
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);
      border-bottom:1px solid var(--border);
    }
    .hero-head .icon{
      width:24px;
      height:24px;
      color:var(--accent);
      display:grid;
      place-items:center;
    }
    .hero-head h1{
      margin:0;
      font-size:clamp(20px,3.2vw,26px);
      line-height:1.2;
      color:var(--text);
    }
    .muted{color:var(--muted,#67706B);}

    .hero-body{
      padding:16px;
      display:grid;
      gap:14px;
    }

    /* Toolbar + filters */
    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:flex-end;
      justify-content:space-between;
    }
    .toolbar-left{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .toolbar-right{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:flex-end;
      font-size:0.9rem;
      opacity:0.85;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:120px;
      padding:10px 14px;
      border-radius:12px;
      border:1px solid var(--border);
      font-weight:800;
      cursor:pointer;
      user-select:none;
      color:var(--text)!important;
      background:var(--card-surface,var(--surface));
      font-size:0.9rem;
      gap:6px;
      text-decoration:none;
    }
    .btn-quiet{
      min-width:auto;
      padding-inline:10px;
    }
    .btn-primary{
      border-radius:999px;
      border:1px solid transparent;
      background:var(--green,#3B7E46);
    }
    .btn.btn-primary{
      color:#fff !important; /* force white text on green */
    }
    .btn-small{
      min-width:0;
      padding:6px 10px;
      font-size:0.82rem;
    }

    .field{position:relative;}
    .field label{
      display:block;
      font-weight:800;
      margin:0 0 4px;
      font-size:0.86rem;
    }
    .select, .input{
      width:100%;
      font:inherit;
      font-size:0.9rem;
      color:var(--text);
      background:var(--card-surface,var(--surface));
      border:1px solid var(--border);
      border-radius:999px;
      padding:8px 10px;
      outline:none;
      box-sizing:border-box;
    }
    .input{border-radius:10px;}

    .filters-grid{
      display:grid;
      grid-template-columns:repeat(3,minmax(0,1fr)); /* 3 equal columns */
      gap:10px;
    }
    @media(max-width:900px){
      .filters-grid{grid-template-columns:repeat(2,minmax(0,1fr));}
    }
    @media(max-width:640px){
      .filters-grid{grid-template-columns:1fr;}
    }

    .help-text{
      font-size:0.78rem;
      color:var(--muted,#67706B);
      margin-top:3px;
    }

    /* Combo styles */
    .buttonish{
      width:100%;
      font:inherit;
      font-size:0.9rem;
      color:var(--text);
      background:var(--card-surface,var(--surface));
      border:1px solid var(--border);
      border-radius:var(--combo-btn-radius);
      padding:8px 32px 8px 10px;
      outline:none;
      text-align:left;
      cursor:pointer;
      position:relative;
    }
    .buttonish.has-caret::after{
      content:"";
      position:absolute;
      right:12px;
      top:50%;
      width:0;height:0;
      border-left:6px solid transparent;
      border-right:6px solid transparent;
      border-top:7px solid var(--muted,#67706B);
      transform:translateY(-50%);
      pointer-events:none;
    }
    .combo{position:relative;}
    .combo .combo-anchor{position:relative;display:inline-block;width:100%;}
    .combo-panel{
      position:absolute;
      left:0;right:0;
      top:calc(100% + var(--combo-gap));
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:var(--combo-radius);
      box-shadow:var(--combo-shadow);
      z-index:9999;
      padding:8px;
      display:none;
    }
    .combo-panel.show{display:block;}
    .combo-panel .search{padding:4px 2px 8px;}
    .combo-panel .search input{
      width:100%;
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius:var(--combo-btn-radius);
      font:inherit;
      font-size:0.9rem;
    }
    .combo-panel .list{
      max-height:var(--combo-max-h);
      overflow:auto;
      border-top:1px solid var(--border);
    }
    .combo-item{
      padding:var(--combo-item-pad);
      border-bottom:1px solid var(--border);
      cursor:pointer;
      font-size:0.9rem;
    }
    .combo-item:last-child{border-bottom:none;}
    .combo-item:hover{background:rgba(0,0,0,.04);}
    .combo-empty{padding:var(--combo-item-pad);color:#67706B;font-size:0.85rem;}

    /* Trial cards */
    .trial-list{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:8px;
    }
    .trial-empty{
      padding:14px 16px;
      border-radius:12px;
      border:1px dashed var(--border);
      background:var(--card-surface,var(--surface));
      font-size:0.95rem;
      opacity:0.9;
    }
    .trial-card{
      border-radius:14px;
      border:1px solid var(--card-border,var(--border));
      background:var(--card-surface,var(--surface));
      box-shadow:var(--shadow-soft,var(--shadow));
      padding:12px 14px 10px;
      display:flex;
      flex-direction:column;
      gap:6px;
      cursor:pointer;
      transition:transform .06s, box-shadow .12s, border-color .12s, background .12s;
    }
    .trial-card:active{
      transform:scale(.995);
      box-shadow:var(--shadow);
    }
    .trial-row-top{
      display:flex;
      align-items:flex-start;
      gap:10px;
    }
    .trial-main{flex:1 1 auto;min-width:0;}
    .trial-title{
      font-weight:700;
      font-size:0.98rem;
      line-height:1.3;
      color:var(--text);
    }
    .trial-sub{
      font-size:0.86rem;
      opacity:0.9;
      margin-top:2px;
    }
    .trial-meta{
      display:flex;
      flex-wrap:wrap;
      gap:6px 10px;
      margin-top:4px;
      font-size:0.8rem;
      opacity:0.9;
    }
    .trial-meta span{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 7px;
      border-radius:999px;
      background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
    }
    .trial-meta-label{
      font-weight:600;
    }
    .trial-status-chip{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 8px;
      border-radius:999px;
      font-size:0.78rem;
      text-transform:uppercase;
      letter-spacing:0.06em;
      background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
    }
    .trial-bottom-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      font-size:0.78rem;
      opacity:0.85;
      margin-top:4px;
    }

    /* Shared scroll helper for panels */
    .scroll-panel{
      max-height:92vh;
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
      border-radius:inherit;
    }

    /* Overlays */
    .trial-overlay,
    .modal-overlay,
    .field-overlay{
      position:fixed;
      inset:0;
      background:color-mix(in srgb, #000 45%, transparent);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:9999;
      overscroll-behavior:contain;
    }

    .trial-panel,
    .modal-panel,
    .field-panel{
      width:min(820px, 100% - 24px);
      border-radius:18px;
      background:var(--surface-raised,var(--card-surface,var(--surface)));
      box-shadow:var(--shadow-strong,0 18px 45px rgba(0,0,0,.35));
      padding:16px 16px 14px;
      display:flex;
      flex-direction:column;
      gap:12px;
      box-sizing:border-box;
      overflow-x:hidden;
      max-height:92vh;
    }

    .modal-panel{
      width:min(520px,100% - 24px);
    }

    .field-panel{
      width:min(720px,100% - 24px);
      font-size:0.86rem;
    }

    @media(max-width:700px){
      .trial-panel,
      .modal-panel,
      .field-panel{
        width:100%;
        max-width:100%;
        border-radius:18px;
        align-self:flex-end;
      }
    }

    .trial-panel-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      cursor:pointer;
    }
    .trial-panel-title{
      font-weight:700;
      font-size:1rem;
      line-height:1.3;
      color:var(--text);
    }
    .trial-panel-sub{
      font-size:0.86rem;
      opacity:0.9;
      margin-top:2px;
    }
    .trial-panel-close{
      border:none;
      background:transparent;
      font-size:1.3rem;
      line-height:1;
      cursor:pointer;
      padding:4px;
      border-radius:999px;
    }
    .trial-header-chips{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:6px;
      font-size:0.78rem;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 8px;
      border-radius:999px;
      background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
      font-size:0.78rem;
    }
    .chip-label{font-weight:600;}

    .trial-section{
      border-top:1px solid var(--border-soft,var(--border));
      padding-top:8px;
      margin-top:4px;
      font-size:0.86rem;
    }
    .trial-section h3{
      font-size:0.9rem;
      margin:0 0 4px;
    }
    .trial-notes{
      font-size:0.84rem;
      white-space:pre-wrap;
    }

    .pill-list{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-top:4px;
    }
    .field-pill{
      border-radius:999px;
      border:1px solid var(--border);
      padding:8px 10px;
      display:flex;
      align-items:center;
      gap:8px;
      background:var(--card-surface,var(--surface));
      font-size:0.84rem;
      cursor:pointer;
    }
    .field-pill-main{
      font-weight:700;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .field-pill-sub{
      font-size:0.78rem;
      color:var(--muted,#67706B);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .trial-error{
      color:#b00020;
      font-size:0.8rem;
      margin-top:4px;
    }

    .trial-footer{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-top:6px;
      font-size:0.8rem;
      opacity:0.85;
    }

    /* Edit Trial modal */
    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
    }
    .modal-header h2{
      margin:0;
      font-size:1rem;
      color:var(--text);
    }
    .modal-actions{
      display:flex;
      justify-content:flex-end;
      gap:8px;
      margin-top:6px;
    }

    /* Field overlay */
    .field-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:8px;
    }
    .field-title{font-weight:700;font-size:0.98rem;color:var(--text);}
    .field-sub{font-size:0.82rem;opacity:0.9;margin-top:2px;}

    .field-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:8px;
    }
    @media(max-width:600px){
      .field-grid{grid-template-columns:1fr;}
    }

    .textarea{
      width:100%;
      min-height:80px;
      resize:vertical;
      font:inherit;
      font-size:0.86rem;
      padding:6px 8px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--surface);
      color:var(--text);
      box-sizing:border-box;
    }

    .yield-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
      gap:6px;
      margin-top:4px;
    }
    .yield-list{
      margin-top:6px;
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:0.8rem;
    }
    .yield-pill{
      border-radius:10px;
      border:1px solid var(--border);
      padding:6px 8px;
      background:var(--card-surface,var(--surface));
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:calc(env(safe-area-inset-bottom,0px) + 72px);
      transform:translateX(-50%);
      background:#2F6C3C;
      color:#fff;
      padding:10px 14px;
      border-radius:10px;
      box-shadow:0 6px 20px rgba(0,0,0,.25);
      z-index:12000;
      display:none;
      font-size:0.86rem;
    }
    .toast.show{display:block;animation:fadeout 4.5s forwards;}
    @keyframes fadeout{0%{opacity:1}85%{opacity:1}100%{opacity:0}}

    .text-danger{color:#b00020;}
    .fw-bold{font-weight:700;}
  </style>

  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true;
        document.head.appendChild(s);
      }
    })();
  </script>

  <script type="module">
    import {
      ready,
      getFirestore,
      collection, getDocs, doc, updateDoc, addDoc,
      query, orderBy,
      serverTimestamp
    } from '/Farm-vista/js/firebase-init.js';

    import { NAV_MENU } from '/Farm-vista/js/menu.js';

    const $  = (sel, root=document)=>root.querySelector(sel);
    const $$ = (sel, root=document)=>Array.from(root.querySelectorAll(sel));

    const STATE = {
      db: null,
      trials: [],
      filtered: [],
      filters: {
        status: 'active',  // 'active' | 'completed' | 'all'
        year: null,
        type: null
      },
      combos: {},
      currentTrial: null,
      currentFieldIdx: null,
      currentFieldYields: []
    };

    /* ============ Helpers ============ */
    function showToast(msg='Saved.', ms=4500){
      const t = $('#toast');
      if(!t) return;
      t.textContent = msg;
      t.classList.remove('show');
      void t.offsetWidth;
      t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'), ms);
    }

    function smartLabel(str){
      if(!str) return '';
      const s = String(str);
      // If it's ALL CAPS or has underscores, prettify
      if(s === s.toUpperCase() || s.includes('_')){
        const cleaned = s.replace(/_/g,' ');
        return cleaned.toLowerCase().replace(/\b\w/g,c=>c.toUpperCase());
      }
      return s;
    }

    /* ============ Combos ============ */
    function closeAllCombos(except=null){
      $$('.combo-panel.show').forEach(p=>{ if(p!==except) p.classList.remove('show'); });
    }
    document.addEventListener('click', ()=> closeAllCombos());
    document.addEventListener('keydown', e=>{
      if(e.key==='Escape') closeAllCombos();
    });

    function makeCombo({btn, panel, list, items=[], searchable=false, formatter=x=>String(x?.label??x), onPick}){
      if(!btn || !panel || !list) return null;

      panel.addEventListener('click', e=> e.stopPropagation());
      panel.addEventListener('mousedown', e=> e.stopPropagation());

      let _items = Array.isArray(items)? items.slice():[];

      function render(q=""){
        const qq = (q||"").toLowerCase();
        const filtered = _items.filter(x=>{
          const lbl = formatter(x).toLowerCase();
          return !qq || lbl.includes(qq);
        });
        list.innerHTML = filtered.length
          ? filtered.map(x=>`<div class="combo-item" data-id="${String(x.id)}">${formatter(x)}</div>`).join('')
          : `<div class="combo-empty">(no matches)</div>`;
      }
      function open(){
        closeAllCombos(panel);
        panel.classList.add('show');
        render('');
        if(searchable){
          const inp = panel.querySelector('input');
          if(inp){ inp.value=''; inp.focus(); }
        }
      }
      function close(){ panel.classList.remove('show'); }

      btn.addEventListener('click', e=>{
        e.stopPropagation();
        panel.classList.contains('show') ? close() : open();
      });

      list.addEventListener('mousedown', e=>{
        const row = e.target.closest('.combo-item');
        if(!row) return;
        const id = row.dataset.id;
        const it = _items.find(x=>String(x.id)===id);
        if(!it) return;
        onPick?.(it);
        close();
      });

      if(searchable){
        const s = panel.querySelector('input');
        if(s) s.addEventListener('input', e=> render(e.target.value));
      }

      return {
        setItems(arr){
          _items = Array.isArray(arr)? arr.slice():[];
          render('');
        },
        open, close
      };
    }

    /* ============ Filters ============ */
    function initFilterCombos(){
      const nowYear = new Date().getFullYear();
      const years = [nowYear-1, nowYear, nowYear+1, nowYear+2].map(v=>({
        id:String(v), label:String(v), value:v
      }));
      const yearCombo = makeCombo({
        btn:  $('#fltYearBtn'),
        panel:$('#fltYearPanel'),
        list: $('#fltYearList'),
        items: years,
        searchable:false,
        formatter:x=>x.label,
        onPick(it){
          STATE.filters.year = it.value;
          $('#fltYearBtn').textContent = it.label;
          applyFilters();
        }
      });
      STATE.combos.year = yearCombo;

      const types = [
        { id:'ALL',       label:'All trial types',           value:null },
        { id:'SEED',      label:'Seed / Hybrid / Variety',   value:'SEED' },
        { id:'FUNGICIDE', label:'Fungicide Program',         value:'FUNGICIDE' },
        { id:'FERTILITY', label:'Fertility / Nutrient',      value:'FERTILITY' },
        { id:'BIO',       label:'Biological / Additive',     value:'BIOLOGICAL' },
        { id:'OTHER',     label:'Other',                     value:'OTHER' }
      ];
      const typeCombo = makeCombo({
        btn:  $('#fltTypeBtn'),
        panel:$('#fltTypePanel'),
        list: $('#fltTypeList'),
        items: types,
        searchable:false,
        formatter:x=>x.label,
        onPick(it){
          STATE.filters.type = it.value;
          $('#fltTypeBtn').textContent = it.label;
          applyFilters();
        }
      });
      STATE.combos.type = typeCombo;

      $('#fltYearBtn').textContent = 'All years';
      $('#fltTypeBtn').textContent = 'All trial types';

      const statusSel = $('#fltStatus');
      if(statusSel){
        statusSel.addEventListener('change', ()=>{
          STATE.filters.status = statusSel.value || 'active';
          applyFilters();
        });
      }
    }

    function statusBucket(statusRaw){
      const s = (statusRaw || '').toString().toLowerCase();
      if(s==='completed' || s==='done' || s==='archived'){
        return 'completed';
      }
      return 'active';
    }

    function bucketLabel(bucket){
      return bucket === 'completed' ? 'Completed / Archived' : 'Active';
    }

    function applyFilters(){
      const { status, year, type } = STATE.filters;
      let arr = STATE.trials.slice();

      arr = arr.filter(item=>{
        const d = item.data || {};

        const bucket = statusBucket(d.status);
        if(status !== 'all' && bucket !== status) return false;

        if(year != null){
          const cy = d.cropYear || d.year || null;
          if(Number(cy) !== Number(year)) return false;
        }

        if(type){
          const t = (d.trialType || '').toString().toUpperCase();
          if(t !== type) return false;
        }

        return true;
      });

      arr.sort((a,b)=>{
        const ta = (a.data.createdAt && a.data.createdAt.toMillis ? a.data.createdAt.toMillis() : 0);
        const tb = (b.data.createdAt && b.data.createdAt.toMillis ? b.data.createdAt.toMillis() : 0);
        return tb - ta;
      });

      STATE.filtered = arr;
      renderTrialList();
    }

    /* ============ Load trials ============ */
    async function loadTrials(){
      const db = STATE.db;
      const snap = await getDocs(query(collection(db,'fieldTrials'), orderBy('createdAt','desc')));
      const items = [];
      snap.forEach(d=>{
        items.push({id:d.id, data:d.data() || {}});
      });
      STATE.trials = items;
      applyFilters();
    }

    function renderTrialList(){
      const listEl  = $('#trialList');
      const emptyEl = $('#trialEmpty');
      const countEl = $('#trialCount');

      listEl.innerHTML = '';

      if(!STATE.filtered.length){
        if(emptyEl) emptyEl.hidden = false;
        if(countEl) countEl.textContent = '0 trials match filters';
        return;
      }
      if(emptyEl) emptyEl.hidden = true;

      for(const item of STATE.filtered){
        const d = item.data || {};
        const id = item.id;

        const trialName = d.trialName || d.name || 'Untitled trial';
        const cropYear = d.cropYear || d.year || null;
        const cropLabelRaw = d.cropLabel || d.cropCode || '';
        const typeLabelRaw = d.trialTypeLabel || d.trialType || '';
        const opTaskRaw = d.operationTaskLabel || d.operationTaskCode || '';

        const cropLabel = smartLabel(cropLabelRaw);
        const typeLabel = smartLabel(typeLabelRaw);
        const opTask = smartLabel(opTaskRaw);

        const fieldCount = d.fieldCount || (Array.isArray(d.fields)? d.fields.length : 0);
        const statusRaw = d.status || 'active';
        const bucket = statusBucket(statusRaw);
        const ts = d.createdAt || null;
        const when = ts && ts.toDate ? ts.toDate() : null;

        const card = document.createElement('article');
        card.className = 'trial-card';
        card.dataset.id = id;

        card.innerHTML = `
          <div class="trial-row-top">
            <div class="trial-main">
              <div class="trial-title">
                ${trialName}
              </div>
              <div class="trial-sub">
                ${cropYear ? cropYear : 'Year ?'} · ${cropLabel || 'Crop ?'} · ${typeLabel || 'Type ?'}
              </div>
              <div class="trial-meta">
                ${fieldCount ? `
                  <span><span class="trial-meta-label">Fields</span> ${fieldCount}</span>
                ` : ''}
                ${opTask ? `
                  <span><span class="trial-meta-label">Operation</span> ${opTask}</span>
                ` : ''}
              </div>
            </div>
            <div>
              <div class="trial-status-chip">${bucketLabel(bucket)}</div>
            </div>
          </div>
          <div class="trial-bottom-row">
            <div>${when ? `Created ${when.toLocaleDateString()} ${when.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}` : ''}</div>
            <div>${bucketLabel(bucket)}</div>
          </div>
        `;

        card.addEventListener('click', ()=> openTrialDetail(item));
        listEl.appendChild(card);
      }

      if(countEl){
        countEl.textContent = `${STATE.filtered.length} trial${STATE.filtered.length===1?'':'s'} match filters`;
      }
    }

    /* ===== Modal select helpers ===== */
    function ensureOptionSelected(selectEl, value, label){
      if(!selectEl) return;
      if(value === undefined || value === null || value === '') return;
      const val = String(value);
      let opt = Array.from(selectEl.options).find(o => String(o.value) === val);
      if(!opt){
        opt = document.createElement('option');
        opt.value = val;
        opt.textContent = label || val;
        selectEl.appendChild(opt);
      }
      selectEl.value = val;
    }

    function mapTrialTypeLabelToCode(label){
      if(!label) return null;
      const t = label.toString().toLowerCase();
      if(t.includes('seed') || t.includes('hybrid') || t.includes('variety')) return 'SEED';
      if(t.includes('fungicide')) return 'FUNGICIDE';
      if(t.includes('fertility') || t.includes('nutrient')) return 'FERTILITY';
      if(t.includes('biological') || t.includes('additive')) return 'BIOLOGICAL';
      return 'OTHER';
    }

    function mapOpLabelToCode(label){
      if(!label) return null;
      const t = label.toString().toLowerCase();
      if(t.includes('plant')) return 'PLANTING';
      if(t.includes('spray')) return 'SPRAYING';
      if(t.includes('aerial')) return 'AERIAL_APP';
      if(t.includes('fert')) return 'FERTILIZER';
      return 'OTHER';
    }

    /* ============ Trial Detail overlay ============ */
    function openTrialDetail(item){
      STATE.currentTrial = item;
      const overlay = $('#trialOverlay');
      const d = item.data || {};

      const titleEl = $('#trialHdrTitle');
      const subEl   = $('#trialHdrSub');
      const chipsEl = $('#trialHdrChips');
      const notesEl = $('#trialNotes');
      const createdEl = $('#trialMetaCreated');
      const statusEl  = $('#trialMetaStatus');
      const fieldsCountEl = $('#trialMetaFields');

      const trialName = d.trialName || d.name || 'Untitled trial';
      const cropYear = d.cropYear || d.year || null;
      const cropLabelRaw = d.cropLabel || d.cropCode || '';
      const typeLabelRaw = d.trialTypeLabel || d.trialType || '';
      const opTaskRaw = d.operationTaskLabel || d.operationTaskCode || '';
      const cropLabel = smartLabel(cropLabelRaw);
      const typeLabel = smartLabel(typeLabelRaw);
      const opTask = smartLabel(opTaskRaw);

      const statusRaw = d.status || 'active';
      const bucket = statusBucket(statusRaw);
      const fieldCount = d.fieldCount || (Array.isArray(d.fields)? d.fields.length : 0);
      const ts = d.createdAt || null;
      const when = ts && ts.toDate ? ts.toDate() : null;

      if(titleEl) titleEl.textContent = trialName;
      if(subEl){
        const pieces = [];
        if(cropYear) pieces.push(cropYear);
        if(cropLabel) pieces.push(cropLabel);
        if(typeLabel) pieces.push(typeLabel);
        subEl.textContent = pieces.join(' · ') || 'Trial details';
      }

      if(chipsEl){
        chipsEl.innerHTML = '';
        if(opTask){
          const span = document.createElement('span');
          span.className = 'chip';
          span.innerHTML = `<span class="chip-label">Operation</span> ${opTask}`;
          chipsEl.appendChild(span);
        }
        const fcSpan = document.createElement('span');
        fcSpan.className = 'chip';
        fcSpan.innerHTML = `<span class="chip-label">Fields</span> ${fieldCount}`;
        chipsEl.appendChild(fcSpan);
      }

      if(notesEl){
        const n = d.notes || d.trialNotes || '';
        notesEl.textContent = n || 'No trial-level notes yet.';
      }
      if(createdEl){
        createdEl.textContent = when
          ? `Created ${when.toLocaleDateString()} ${when.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}`
          : '';
      }
      if(statusEl){
        statusEl.textContent = bucketLabel(bucket);
      }
      if(fieldsCountEl){
        fieldsCountEl.textContent = `${fieldCount} field${fieldCount===1?'':'s'} in this trial`;
      }

      STATE.currentFieldIdx = null;
      renderFieldsList(d);

      overlay.hidden = false;
      document.body.style.overflow = 'hidden';
    }

    function closeTrialDetail(){
      const overlay = $('#trialOverlay');
      if(overlay) overlay.hidden = true;
      document.body.style.overflow = '';
      STATE.currentTrial = null;
      STATE.currentFieldIdx = null;
    }

    function renderFieldsList(trialData){
      const listEl = $('#trialFieldsList');
      if(!listEl) return;

      const arr = Array.isArray(trialData.fields) ? trialData.fields : [];
      if(!arr.length){
        listEl.innerHTML = '<div class="help-text">No fields added yet. Use “Add field to trial” below.</div>';
        return;
      }

      listEl.innerHTML = arr.map((f,idx)=>`
        <button type="button" class="field-pill" data-idx="${idx}">
          <div>
            <div class="field-pill-main">
              ${f.fieldName || 'Field ?'}${f.farmName ? ' · '+f.farmName : ''}
            </div>
            <div class="field-pill-sub">
              ${(f.variety || f.seedBrand) ? (f.variety || f.seedBrand) + ' · ' : ''}
              ${f.trialAcres ? (f.trialAcres + ' ac') : ''}
            </div>
          </div>
        </button>
      `).join('');
    }

    /* ============ Edit Trial modal ============ */
    function openEditTrialModal(){
      const item = STATE.currentTrial;
      if(!item) return;
      const d = item.data || {};

      const modal = $('#editTrialOverlay');
      if(!modal) return;

      $('#editTrialName').value = d.trialName || '';
      $('#editTrialNotes').value = d.notes || d.trialNotes || '';

      const yearSel = $('#editCropYear');
      const yearVal = d.cropYear || d.cropYearLabel || d.year || '';
      if(yearSel){
        yearSel.value = yearVal ? String(yearVal) : '';
        if(!yearSel.value && yearVal){
          ensureOptionSelected(yearSel, yearVal, yearVal);
        }
      }

      const cropSel = $('#editCrop');
      let cropCodeSaved = d.cropCode || d.crop || '';
      let cropLabelSaved = d.cropLabel || d.cropName || cropCodeSaved;
      if(!cropCodeSaved && cropLabelSaved){
        cropCodeSaved = cropLabelSaved.toUpperCase();
      }
      if(cropSel){
        cropSel.value = cropCodeSaved || '';
        if(!cropSel.value && cropCodeSaved){
          ensureOptionSelected(cropSel, cropCodeSaved, smartLabel(cropLabelSaved || cropCodeSaved));
        }
      }

      const trialSel = $('#editTrialType');
      let trialCodeSaved = d.trialType || d.trialTypeCode || mapTrialTypeLabelToCode(d.trialTypeLabel);
      let trialLabelSaved = d.trialTypeLabel || trialCodeSaved;
      if(trialSel){
        trialSel.value = trialCodeSaved || '';
        if(!trialSel.value && trialCodeSaved){
          ensureOptionSelected(trialSel, trialCodeSaved, smartLabel(trialLabelSaved || trialCodeSaved));
        }
      }

      const opSel = $('#editOpTask');
      let opCodeSaved = d.operationTaskCode || d.operationTask || mapOpLabelToCode(d.operationTaskLabel);
      let opLabelSaved = d.operationTaskLabel || opCodeSaved;
      if(opSel){
        opSel.value = opCodeSaved || '';
        if(!opSel.value && opCodeSaved){
          ensureOptionSelected(opSel, opCodeSaved, smartLabel(opLabelSaved || opCodeSaved));
        }
      }

      $('#editTrialError').textContent = '';
      $('#editTrialError').hidden = true;

      modal.hidden = false;
    }

    function closeEditTrialModal(){
      const modal = $('#editTrialOverlay');
      if(modal) modal.hidden = true;
    }

    async function saveEditTrial(){
      const item = STATE.currentTrial;
      if(!item || !STATE.db) return;

      const name = $('#editTrialName').value.trim();
      const notes = $('#editTrialNotes').value.trim();
      const errEl = $('#editTrialError');

      if(!name){
        errEl.textContent = 'Trial name is required.';
        errEl.hidden = false;
        return;
      }

      const yearSel = $('#editCropYear');
      const yearVal = yearSel ? yearSel.value : '';
      const yearNum = yearVal ? Number(yearVal) : null;

      const cropSel = $('#editCrop');
      const cropCode = cropSel ? (cropSel.value || null) : null;
      const cropLabel = cropCode
        ? (cropSel.options[cropSel.selectedIndex]?.textContent || cropCode)
        : null;

      const trialSel = $('#editTrialType');
      const typeCode = trialSel ? (trialSel.value || null) : null;
      const typeLabel = typeCode
        ? (trialSel.options[trialSel.selectedIndex]?.textContent || typeCode)
        : null;

      const opSel = $('#editOpTask');
      const opCode = opSel ? (opSel.value || null) : null;
      const opLabel = opCode
        ? (opSel.options[opSel.selectedIndex]?.textContent || opCode)
        : null;

      const updates = {
        trialName: name,
        notes,
        cropYear: yearNum,
        cropYearLabel: yearVal || null,
        cropCode: cropCode,
        cropLabel: cropLabel,
        trialType: typeCode,
        trialTypeLabel: typeLabel,
        operationTaskCode: opCode,
        operationTaskLabel: opLabel,
        updatedAt: serverTimestamp()
      };

      try{
        await updateDoc(doc(STATE.db,'fieldTrials',item.id), updates);
        Object.assign(item.data, updates);
        closeEditTrialModal();
        openTrialDetail(item);
        applyFilters();
        showToast('Trial details updated.');
      }catch(err){
        console.error('Failed to update trial:', err);
        errEl.textContent = `Failed to save: ${err.message}`;
        errEl.hidden = false;
      }
    }

    /* ============ Farms & Fields (Add Field flow) ============ */
    let allFarms = [];
    let allFields = [];
    let farmCombo = null;
    let fieldCombo = null;

    async function loadFarmsAndFields(){
      const db = STATE.db;
      const farmHelp = $('#trialAddFarmHelp');
      const fieldHelp = $('#trialAddFieldHelp');

      try{
        if(farmHelp) farmHelp.textContent = 'Loading farms…';
        const farmsSnap = await getDocs(collection(db,'farms'));
        const farms = [];
        farmsSnap.forEach(d=>{
          const x = d.data() || {};
          const name = String(x.name || x.farmName || '').trim();
          if(name) farms.push({id:d.id, label:name});
        });
        farms.sort((a,b)=>a.label.localeCompare(b.label));
        allFarms = farms;
        farmCombo?.setItems(allFarms);
        if(farmHelp) farmHelp.textContent = farms.length ? `${farms.length} farm(s) loaded.` : 'No farms found.';

        if(fieldHelp) fieldHelp.textContent = 'Loading fields…';
        const fieldsSnap = await getDocs(collection(db,'fields'));
        const fields = [];
        fieldsSnap.forEach(d=>{
          const x = d.data() || {};
          const name = String(x.name || x.fieldName || '').trim();
          const farmId = x.farmId || x.farm || null;
          if(name){
            fields.push({
              id:d.id,
              label:name,
              farmId:farmId || null
            });
          }
        });
        fields.sort((a,b)=>a.label.localeCompare(b.label));
        allFields = fields;
        fieldCombo?.setItems(allFields);
        if(fieldHelp) fieldHelp.textContent = fields.length ? `${fields.length} field(s) loaded.` : 'No fields found.';
      }catch(err){
        console.error('Error loading farms/fields:', err);
        if(farmHelp) farmHelp.textContent = 'Error loading farms.';
        if(fieldHelp) fieldHelp.textContent = 'Error loading fields.';
      }
    }

    function initAddFieldCombos(){
      farmCombo = makeCombo({
        btn:  $('#trialAddFarmBtn'),
        panel:$('#trialAddFarmPanel'),
        list: $('#trialAddFarmList'),
        items: [],
        searchable:true,
        formatter:x=>x.label,
        onPick(it){
          $('#trialAddFarmBtn').textContent = it.label;
          $('#trialAddFarmHelp').textContent = 'Farm selected.';
          const subset = allFields.filter(f=>f.farmId === it.id);
          fieldCombo.setItems(subset.length ? subset : allFields);
          $('#trialAddFieldBtn').textContent = '— Select field —';
          $('#trialAddFieldHelp').textContent = subset.length
            ? `${subset.length} field(s) on this farm.`
            : `${allFields.length} field(s) loaded.`;
        }
      });

      fieldCombo = makeCombo({
        btn:  $('#trialAddFieldBtn'),
        panel:$('#trialAddFieldPanel'),
        list: $('#trialAddFieldList'),
        items: [],
        searchable:true,
        formatter:x=>x.label,
        onPick(it){
          $('#trialAddFieldBtn').textContent = it.label;
          $('#trialAddFieldHelp').textContent = 'Field selected.';
        }
      });
    }

    function openAddFieldModal(){
      const overlay = $('#addFieldOverlay');
      if(!overlay) return;
      $('#trialAddFieldError').textContent = '';
      $('#trialAddFieldError').hidden = true;
      overlay.hidden = false;
    }

    function closeAddFieldModal(){
      const overlay = $('#addFieldOverlay');
      if(overlay) overlay.hidden = true;
    }

    async function handleAddFieldToTrial(){
      const item = STATE.currentTrial;
      const db = STATE.db;
      if(!item || !db) return;

      const farmLabel = $('#trialAddFarmBtn').textContent.trim();
      const fieldLabel = $('#trialAddFieldBtn').textContent.trim();
      const acresRaw = $('#trialAddAcres').value.trim();
      const errEl = $('#trialAddFieldError');

      const farmObj = allFarms.find(f=>f.label === farmLabel);
      const fieldObj = allFields.find(f=>f.label === fieldLabel);

      if(!farmObj){
        errEl.textContent = 'Select a farm.';
        errEl.hidden = false;
        return;
      }
      if(!fieldObj){
        errEl.textContent = 'Select a field.';
        errEl.hidden = false;
        return;
      }

      let trialAcres = null;
      if(acresRaw){
        const n = Number(acresRaw);
        if(Number.isNaN(n) || n <= 0){
          errEl.textContent = 'Trial acres must be a positive number.';
          errEl.hidden = false;
          return;
        }
        trialAcres = n;
      }

      errEl.textContent = '';
      errEl.hidden = true;

      const d = item.data;
      const fieldsArr = Array.isArray(d.fields) ? d.fields.slice() : [];

      fieldsArr.push({
        farmId: farmObj.id,
        farmName: farmObj.label,
        fieldId: fieldObj.id,
        fieldName: fieldObj.label,
        trialAcres
      });

      try{
        await updateDoc(doc(db,'fieldTrials',item.id), {
          fields: fieldsArr,
          fieldCount: fieldsArr.length,
          updatedAt: serverTimestamp()
        });
        d.fields = fieldsArr;
        d.fieldCount = fieldsArr.length;
        renderFieldsList(d);
        applyFilters();

        $('#trialAddFarmBtn').textContent = '— Select farm —';
        $('#trialAddFieldBtn').textContent = '— Select field —';
        $('#trialAddAcres').value = '';
        $('#trialAddFarmHelp').textContent = `${allFarms.length} farm(s) loaded.`;
        $('#trialAddFieldHelp').textContent = `${allFields.length} field(s) loaded.`;

        closeAddFieldModal();
        showToast('Field added to trial.');
      }catch(err){
        console.error('Failed to add field to trial:', err);
        errEl.textContent = `Error saving: ${err.message}`;
        errEl.hidden = false;
      }
    }

    /* ============ Field overlay + yields ============ */
    function openFieldOverlay(fieldIdx){
      const item = STATE.currentTrial;
      if(!item) return;

      const d = item.data || {};
      const fieldsArr = Array.isArray(d.fields) ? d.fields : [];
      const fieldObj = fieldsArr[fieldIdx];
      if(!fieldObj) return;

      STATE.currentFieldIdx = fieldIdx;
      STATE.currentFieldYields = [];

      const overlay = $('#fieldOverlay');
      if(!overlay) return;

      const titleEl = $('#fieldTitle');
      const subEl   = $('#fieldSub');
      const trialBadgeEl = $('#fieldTrialBadge');
      const acresInput = $('#fieldTrialAcres');
      const notesInput = $('#fieldNotes');
      const yieldErrEl = $('#fieldYieldError');

      const trialName = d.trialName || 'Trial';
      const cropYear = d.cropYear || d.year || '';
      const cropLabelRaw = d.cropLabel || d.cropCode || '';
      const cropLabel = smartLabel(cropLabelRaw);

      if(titleEl) titleEl.textContent = fieldObj.fieldName || 'Field';
      if(subEl) subEl.textContent = fieldObj.farmName || '';
      if(trialBadgeEl) trialBadgeEl.textContent =
        `${trialName} • ${cropYear || ''} ${cropLabel || ''}`.trim();

      if(acresInput) acresInput.value = fieldObj.trialAcres != null ? fieldObj.trialAcres : '';
      if(notesInput) notesInput.value = fieldObj.notes || '';
      if(yieldErrEl){
        yieldErrEl.textContent = '';
        yieldErrEl.hidden = true;
      }

      $('#yBlockAcres').value = '';
      $('#yBlockLbs').value = '';
      $('#yBlockMoisture').value = '';
      $('#yBlockCombines').value = '';
      $('#yBlockNotes').value = '';
      $('#yBlockYieldHelper').textContent = 'Enter acres, pounds, and moisture to see calculated yield.';

      $('#yieldList').innerHTML = '<div class="help-text">Loading yield blocks…</div>';

      overlay.hidden = false;
      loadYieldBlocksForField().catch(err=>{
        console.error('Error loading yields:', err);
        $('#yieldList').innerHTML = '<div class="help-text">No yield blocks saved for this field yet.</div>';
      });
    }

    function closeFieldOverlay(){
      const overlay = $('#fieldOverlay');
      if(overlay) overlay.hidden = true;
      STATE.currentFieldIdx = null;
      STATE.currentFieldYields = [];
    }

    async function saveFieldTrialInfo(){
      const item = STATE.currentTrial;
      const db = STATE.db;
      if(!item || !db) return;
      const d = item.data || {};
      const idx = STATE.currentFieldIdx;
      const arr = Array.isArray(d.fields) ? d.fields.slice() : [];
      const fieldObj = arr[idx];
      if(!fieldObj) return;

      const acresRaw = $('#fieldTrialAcres').value.trim();
      const notesVal = $('#fieldNotes').value.trim();
      const errEl = $('#fieldInfoError');

      let acresNum = null;
      if(acresRaw){
        const n = Number(acresRaw);
        if(Number.isNaN(n) || n <= 0){
          errEl.textContent = 'Trial acres must be a positive number.';
          errEl.hidden = false;
          return;
        }
        acresNum = n;
      }

      errEl.textContent = '';
      errEl.hidden = true;

      fieldObj.trialAcres = acresNum;
      fieldObj.notes = notesVal || null;
      arr[idx] = fieldObj;

      try{
        await updateDoc(doc(db,'fieldTrials',item.id), {
          fields: arr,
          updatedAt: serverTimestamp()
        });
        d.fields = arr;
        renderFieldsList(d);
        showToast('Field trial info updated.');
      }catch(err){
        console.error('Failed to save field info:', err);
        errEl.textContent = `Error saving: ${err.message}`;
        errEl.hidden = false;
      }
    }

    function computeYield(acres, lbs, moisture){
      if(!acres || !lbs) return null;
      const wetBu = lbs / 56;
      const wetYld = wetBu / acres;
      let adjYld = wetYld;
      if(moisture != null && !Number.isNaN(moisture)){
        const m = moisture;
        const std = 15.5;
        if(m > std){
          const shrinkFactor = (100 - m) / (100 - std);
          adjYld = wetYld * shrinkFactor;
        }else{
          adjYld = wetYld; // no bonus bushels below standard
        }
      }
      return {
        wet: wetYld,
        adj: adjYld
      };
    }

    function updateYieldHelper(){
      const acres = Number($('#yBlockAcres').value || '0');
      const lbs = Number($('#yBlockLbs').value || '0');
      const m = $('#yBlockMoisture').value ? Number($('#yBlockMoisture').value) : null;
      const helper = $('#yBlockYieldHelper');

      const res = computeYield(acres, lbs, m);
      if(!res){
        helper.textContent = 'Enter acres, pounds, and moisture to see calculated yield.';
        return;
      }
      helper.textContent = `Approx yield: ${res.wet.toFixed(1)} bu/ac (wet), ${res.adj.toFixed(1)} bu/ac (to 15.5%).`;
    }

    async function loadYieldBlocksForField(){
      const item = STATE.currentTrial;
      const db = STATE.db;
      const idx = STATE.currentFieldIdx;
      if(!item || !db || idx==null) return;

      const d = item.data || {};
      const fieldsArr = Array.isArray(d.fields) ? d.fields : [];
      const fieldObj = fieldsArr[idx];
      if(!fieldObj) return;

      const yieldsCol = collection(db,'fieldTrials', item.id, 'yieldBlocks');
      const snap = await getDocs(yieldsCol);
      const arr = [];
      snap.forEach(docSnap=>{
        const y = docSnap.data() || {};
        if(y.fieldId === fieldObj.fieldId){
          arr.push({id:docSnap.id, data:y});
        }
      });
      arr.sort((a,b)=>{
        const ta = a.data.createdAt && a.data.createdAt.toMillis ? a.data.createdAt.toMillis() : 0;
        const tb = b.data.createdAt && b.data.createdAt.toMillis ? b.data.createdAt.toMillis() : 0;
        return tb - ta;
      });

      STATE.currentFieldYields = arr;
      renderYieldList();
    }

    function renderYieldList(){
      const listEl = $('#yieldList');
      if(!listEl) return;

      if(!STATE.currentFieldYields.length){
        listEl.innerHTML = '<div class="help-text">No yield blocks saved for this field yet.</div>';
        return;
      }

      listEl.innerHTML = STATE.currentFieldYields.map(y=>{
        const d = y.data || {};
        const acres = d.blockAcres;
        const lbs = d.lbs;
        const m = d.moisture;
        const wet = d.yieldWet;
        const adj = d.yieldAdj;
        const combines = d.combines;
        const note = d.notes;

        return `
          <div class="yield-pill">
            <div><span class="fw-bold">${acres ?? '?'} ac</span> · ${lbs ?? '?'} lbs · ${m ?? '?'}% moisture</div>
            <div class="help-text">
              Yield: ${wet != null ? wet.toFixed(1) : '?'} bu/ac (wet),
              ${adj != null ? adj.toFixed(1) : '?'} bu/ac adj.
              ${combines ? ` · # combines: ${combines}` : ''}
            </div>
            ${note ? `<div class="help-text">${note}</div>`:''}
          </div>
        `;
      }).join('');
    }

    async function saveYieldBlock(){
      const item = STATE.currentTrial;
      const db = STATE.db;
      const idx = STATE.currentFieldIdx;
      if(!item || !db || idx==null) return;

      const d = item.data || {};
      const fieldsArr = Array.isArray(d.fields) ? d.fields : [];
      const fieldObj = fieldsArr[idx];
      if(!fieldObj) return;

      const acresRaw = $('#yBlockAcres').value.trim();
      const lbsRaw = $('#yBlockLbs').value.trim();
      const mRaw   = $('#yBlockMoisture').value.trim();
      const combRaw= $('#yBlockCombines').value.trim();
      const note   = $('#yBlockNotes').value.trim();
      const errEl  = $('#fieldYieldError');

      const acres = Number(acresRaw);
      const lbs   = Number(lbsRaw);
      const m     = mRaw ? Number(mRaw) : null;
      const combines = combRaw ? Number(combRaw) : null;

      if(Number.isNaN(acres) || acres<=0){
        errEl.textContent = 'Block acres must be a positive number.';
        errEl.hidden = false;
        return;
      }
      if(Number.isNaN(lbs) || lbs<=0){
        errEl.textContent = 'Pounds of grain must be a positive number.';
        errEl.hidden = false;
        return;
      }
      if(m!=null && (Number.isNaN(m) || m<0 || m>50)){
        errEl.textContent = 'Moisture % looks invalid.';
        errEl.hidden = false;
        return;
      }
      errEl.textContent = '';
      errEl.hidden = true;

      const yRes = computeYield(acres, lbs, m);
      const docData = {
        trialId: item.id,
        fieldId: fieldObj.fieldId,
        fieldName: fieldObj.fieldName || null,
        farmName: fieldObj.farmName || null,
        blockAcres: acres,
        lbs,
        moisture: m,
        combines: combines || null,
        yieldWet: yRes ? yRes.wet : null,
        yieldAdj: yRes ? yRes.adj : null,
        notes: note || null,
        createdAt: serverTimestamp()
      };

      try{
        const ref = await addDoc(collection(db,'fieldTrials',item.id,'yieldBlocks'), docData);
        STATE.currentFieldYields.unshift({id:ref.id, data:docData});
        renderYieldList();
        $('#yBlockAcres').value = '';
        $('#yBlockLbs').value = '';
        $('#yBlockMoisture').value = '';
        $('#yBlockCombines').value = '';
        $('#yBlockNotes').value = '';
        updateYieldHelper();
        showToast('Yield block saved.');
      }catch(err){
        console.error('Failed to save yield block:', err);
        errEl.textContent = `Error saving: ${err.message}`;
        errEl.hidden = false;
      }
    }

    /* ============ Boot ============ */
    (async function boot(){
      await ready;
      const db  = getFirestore();
      STATE.db = db;

      const shell = document.querySelector('fv-shell');
      if(shell) shell.nav = NAV_MENU;

      $('#btnBack')?.addEventListener('click', ()=>{
        location.href = '/Farm-vista/pages/crop-production/trials.html';
      });

      initFilterCombos();
      initAddFieldCombos();
      await loadFarmsAndFields();
      await loadTrials();

      $('#trialOverlay')?.addEventListener('click', e=>{
        if(e.target.id === 'trialOverlay') closeTrialDetail();
      });
      $('#trialCloseBtn')?.addEventListener('click', closeTrialDetail);

      $('#trialHdrClickArea')?.addEventListener('click', openEditTrialModal);

      $('#editTrialOverlay')?.addEventListener('click', e=>{
        if(e.target.id === 'editTrialOverlay') closeEditTrialModal();
      });
      $('#editTrialCloseX')?.addEventListener('click', closeEditTrialModal);
      $('#editTrialCancel')?.addEventListener('click', closeEditTrialModal);
      $('#editTrialSave')?.addEventListener('click', saveEditTrial);

      $('#openAddFieldModalBtn')?.addEventListener('click', openAddFieldModal);
      $('#addFieldOverlay')?.addEventListener('click', e=>{
        if(e.target.id === 'addFieldOverlay') closeAddFieldModal();
      });
      $('#addFieldCancelBtn')?.addEventListener('click', closeAddFieldModal);
      $('#trialAddFieldBtnSave')?.addEventListener('click', handleAddFieldToTrial);

      $('#trialFieldsList')?.addEventListener('click', e=>{
        const pill = e.target.closest('.field-pill');
        if(!pill) return;
        const idx = Number(pill.dataset.idx);
        openFieldOverlay(idx);
      });

      $('#fieldOverlay')?.addEventListener('click', e=>{
        if(e.target.id === 'fieldOverlay') closeFieldOverlay();
      });
      $('#fieldCloseBtn')?.addEventListener('click', closeFieldOverlay);
      $('#fieldCancelBtn')?.addEventListener('click', closeFieldOverlay);
      $('#fieldSaveInfoBtn')?.addEventListener('click', saveFieldTrialInfo);

      $('#yBlockAcres')?.addEventListener('input', updateYieldHelper);
      $('#yBlockLbs')?.addEventListener('input', updateYieldHelper);
      $('#yBlockMoisture')?.addEventListener('input', updateYieldHelper);
      $('#saveYieldBlockBtn')?.addEventListener('click', saveYieldBlock);

      window.addEventListener('online', ()=> showToast('Back online — syncing…', 3500));
      window.addEventListener('offline',()=> showToast('Currently offline — using saved data', 3500));
    })();
  </script>
</head>

<body>
  <fv-shell>
    <div class="page">
      <section class="hero">
        <header class="hero-head">
          <div class="icon" aria-hidden="true">🧪</div>
          <div>
            <h1>Field Trials</h1>
            <p class="muted">
              Filter by status, crop year, and trial type. Tap a trial to see details,
              add fields, or manage yield blocks for each field.
            </p>
          </div>
        </header>

        <div class="hero-body">
          <div class="toolbar">
            <div class="toolbar-left">
              <button id="btnBack" type="button" class="btn btn-quiet">
                ← Back to Trials Portal
              </button>
            </div>
            <div class="toolbar-right">
              <span id="trialCount">0 trials</span>
            </div>
          </div>

          <div class="filters-grid" aria-label="Trial filters">
            <div class="field">
              <label for="fltStatus">Status</label>
              <select id="fltStatus" class="select">
                <option value="active">Active (planned / in progress)</option>
                <option value="completed">Completed / archived</option>
                <option value="all">All statuses</option>
              </select>
              <div class="help-text">Use this to flip between active and completed trials.</div>
            </div>

            <div class="field combo">
              <label for="fltYearBtn">Crop year</label>
              <div class="combo-anchor">
                <button id="fltYearBtn" type="button" class="buttonish has-caret">All years</button>
                <div id="fltYearPanel" class="combo-panel" role="listbox" aria-label="Crop year list">
                  <div class="list" id="fltYearList"></div>
                </div>
              </div>
              <div class="help-text">Filter to a specific crop year.</div>
            </div>

            <div class="field combo">
              <label for="fltTypeBtn">Trial type</label>
              <div class="combo-anchor">
                <button id="fltTypeBtn" type="button" class="buttonish has-caret">All trial types</button>
                <div id="fltTypePanel" class="combo-panel" role="listbox" aria-label="Trial type list">
                  <div class="list" id="fltTypeList"></div>
                </div>
              </div>
              <div class="help-text">Seed, fungicide, biological, etc.</div>
            </div>
          </div>

          <section aria-label="Trials list">
            <div id="trialEmpty" class="trial-empty">
              No trials match the current filters. Try changing the status, year, or trial type.
            </div>
            <div id="trialList" class="trial-list"></div>
          </section>
        </div>
      </section>
    </div>

    <!-- Trial detail overlay -->
    <div id="trialOverlay" class="trial-overlay" hidden>
      <div id="trialPanel" class="trial-panel scroll-panel" role="dialog" aria-modal="true" aria-labelledby="trialHdrTitle">
        <header id="trialHdrClickArea" class="trial-panel-header" title="Tap to edit trial details">
          <div>
            <div id="trialHdrTitle" class="trial-panel-title">Trial name</div>
            <div id="trialHdrSub" class="trial-panel-sub">Year · Crop · Trial type</div>
            <div id="trialHdrChips" class="trial-header-chips"></div>
          </div>
          <button type="button" id="trialCloseBtn" class="trial-panel-close" aria-label="Close trial">
            ×
          </button>
        </header>

        <div class="trial-section">
          <div class="trial-footer">
            <div>
              <div id="trialMetaCreated"></div>
            </div>
            <div>
              <span class="trial-status-chip" id="trialMetaStatus">Active</span>
            </div>
          </div>
        </div>

        <section class="trial-section">
          <h3>Trial-level notes</h3>
          <div id="trialNotes" class="trial-notes">
            No trial-level notes yet.
          </div>
        </section>

        <section class="trial-section">
          <h3>Fields in this trial</h3>
          <div id="trialMetaFields" class="help-text">0 fields in this trial</div>
          <div id="trialFieldsList" class="pill-list" style="margin-top:6px;"></div>
        </section>

        <section class="trial-section">
          <button type="button" id="openAddFieldModalBtn" class="btn btn-primary btn-small">
            + Add field to trial
          </button>
        </section>
      </div>
    </div>

    <!-- Edit Trial modal -->
    <div id="editTrialOverlay" class="modal-overlay" hidden>
      <div class="modal-panel scroll-panel" role="dialog" aria-modal="true">
        <header class="modal-header">
          <h2>Edit trial details</h2>
          <button type="button" id="editTrialCloseX" class="trial-panel-close" aria-label="Close">×</button>
        </header>

        <div class="field">
          <label for="editTrialName">Trial name</label>
          <input id="editTrialName" class="input" placeholder="e.g. Blueprint 2026 Corn Large-Scale Trial" />
        </div>

        <div class="field">
          <label for="editCropYear">Crop year</label>
          <select id="editCropYear" class="select">
            <option value="">— Leave as-is —</option>
            <option value="2024">2024</option>
            <option value="2025">2025</option>
            <option value="2026">2026</option>
            <option value="2027">2027</option>
          </select>
        </div>

        <div class="field">
          <label for="editCrop">Crop</label>
          <select id="editCrop" class="select">
            <option value="">— Leave as-is —</option>
            <option value="CORN">Corn</option>
            <option value="SOY">Soybeans</option>
            <option value="WHEAT">Wheat</option>
            <option value="SORGHUM">Sorghum</option>
            <option value="OTHER">Other</option>
          </select>
        </div>

        <div class="field">
          <label for="editTrialType">Trial type</label>
          <select id="editTrialType" class="select">
            <option value="">— Leave as-is —</option>
            <option value="SEED">Seed / Hybrid / Variety</option>
            <option value="FUNGICIDE">Fungicide Program</option>
            <option value="FERTILITY">Fertility / Nutrient</option>
            <option value="BIOLOGICAL">Biological / Additive</option>
            <option value="OTHER">Other</option>
          </select>
        </div>

        <div class="field">
          <label for="editOpTask">Operation task</label>
          <select id="editOpTask" class="select">
            <option value="">— Leave as-is —</option>
            <option value="PLANTING">Planting</option>
            <option value="SPRAYING">Spraying</option>
            <option value="AERIAL_APP">Aerial Application</option>
            <option value="FERTILIZER">Fertilizer</option>
            <option value="OTHER">Other Operation</option>
          </select>
        </div>

        <div class="field">
          <label for="editTrialNotes">Trial-level notes</label>
          <textarea id="editTrialNotes" class="textarea"
            placeholder="Overall setup, strip design, programs, etc."></textarea>
        </div>

        <div id="editTrialError" class="trial-error" hidden></div>

        <div class="modal-actions">
          <button type="button" id="editTrialCancel" class="btn btn-quiet btn-small">Cancel</button>
          <button type="button" id="editTrialSave" class="btn btn-primary btn-small">Save changes</button>
        </div>
      </div>
    </div>

    <!-- Add Field to Trial modal -->
    <div id="addFieldOverlay" class="modal-overlay" hidden>
      <div class="field-panel scroll-panel" role="dialog" aria-modal="true">
        <header class="field-header">
          <div>
            <div class="field-title">Add field to trial</div>
            <div class="field-sub">Select farm, field, and trial acres.</div>
          </div>
          <button type="button" id="addFieldCancelBtn" class="trial-panel-close" aria-label="Close">×</button>
        </header>

        <section class="trial-section">
          <div class="field-grid">
            <div class="field combo">
              <label for="trialAddFarmBtn">Farm</label>
              <div class="combo-anchor">
                <button id="trialAddFarmBtn" type="button" class="buttonish has-caret">— Select farm —</button>
                <div id="trialAddFarmPanel" class="combo-panel" role="listbox" aria-label="Farm list">
                  <div class="search">
                    <input id="trialAddFarmSearch" type="search" placeholder="Search farms…" />
                  </div>
                  <div class="list" id="trialAddFarmList"></div>
                </div>
              </div>
              <div id="trialAddFarmHelp" class="help-text">Farms loading…</div>
            </div>

            <div class="field combo">
              <label for="trialAddFieldBtn">Field</label>
              <div class="combo-anchor">
                <button id="trialAddFieldBtn" type="button" class="buttonish has-caret">— Select field —</button>
                <div id="trialAddFieldPanel" class="combo-panel" role="listbox" aria-label="Field list">
                  <div class="search">
                    <input id="trialAddFieldSearch" type="search" placeholder="Search fields…" />
                  </div>
                  <div class="list" id="trialAddFieldList"></div>
                </div>
              </div>
              <div id="trialAddFieldHelp" class="help-text">Fields loading…</div>
            </div>

            <div class="field">
              <label for="trialAddAcres">Trial acres (optional)</label>
              <input id="trialAddAcres" type="number" step="0.01" min="0" class="input" placeholder="e.g. 12.5" />
              <div class="help-text">Acres of this field that are actually in the trial.</div>
            </div>
          </div>

          <div id="trialAddFieldError" class="trial-error" hidden></div>

          <div style="margin-top:10px;display:flex;justify-content:flex-end;">
            <button type="button" id="trialAddFieldBtnSave" class="btn btn-primary btn-small">
              Save field to trial
            </button>
          </div>
        </section>
      </div>
    </div>

    <!-- Field-in-Trial overlay (includes yield blocks) -->
    <div id="fieldOverlay" class="field-overlay" hidden>
      <div class="field-panel scroll-panel" role="dialog" aria-modal="true">
        <header class="field-header">
          <div>
            <div id="fieldTitle" class="field-title">Field · Farm</div>
            <div id="fieldSub" class="field-sub">Farm</div>
            <div id="fieldTrialBadge" class="help-text" style="margin-top:4px;">Trial · Year · Crop</div>
          </div>
          <button type="button" id="fieldCloseBtn" class="trial-panel-close" aria-label="Close">×</button>
        </header>

        <section class="trial-section">
          <h3>Trial info for this field</h3>
          <div class="field-grid">
            <div class="field">
              <label for="fieldTrialAcres">Trial acres (for this field)</label>
              <input id="fieldTrialAcres" class="input" type="number" min="0" step="0.01" placeholder="e.g. 12.5" />
              <div class="help-text">Acres of this field that are actually in the trial.</div>
            </div>
            <div class="field">
              <label for="fieldNotes">Field-specific notes</label>
              <textarea id="fieldNotes" class="textarea" placeholder="Pop, passes, planter rows, etc."></textarea>
            </div>
          </div>
          <div id="fieldInfoError" class="trial-error" hidden></div>
          <div style="margin-top:6px;">
            <button type="button" id="fieldSaveInfoBtn" class="btn btn-primary btn-small">
              Save field trial info
            </button>
          </div>
        </section>

        <section class="trial-section">
          <h3>Yield blocks for this field</h3>
          <div class="yield-grid">
            <div class="field">
              <label for="yBlockAcres">Block acres</label>
              <input id="yBlockAcres" type="number" step="0.01" min="0" class="input" placeholder="e.g. 12.5" />
            </div>
            <div class="field">
              <label for="yBlockLbs">Pounds of grain</label>
              <input id="yBlockLbs" type="number" step="1" min="0" class="input" placeholder="e.g. 65000" />
            </div>
            <div class="field">
              <label for="yBlockMoisture">Moisture (%)</label>
              <input id="yBlockMoisture" type="number" step="0.1" min="0" max="50" class="input" placeholder="e.g. 21.0" />
            </div>
            <div class="field">
              <label for="yBlockCombines"># combines (info only)</label>
              <input id="yBlockCombines" type="number" step="1" min="0" class="input" placeholder="e.g. 2" />
            </div>
          </div>
          <div class="field" style="margin-top:6px;">
            <label for="yBlockNotes">Notes (optional)</label>
            <textarea id="yBlockNotes" class="textarea" placeholder="Strip name, direction, program label, etc."></textarea>
          </div>
          <div id="yBlockYieldHelper" class="help-text" style="margin-top:4px;">
            Enter acres, pounds, and moisture to see calculated yield.
          </div>
          <div id="fieldYieldError" class="trial-error" hidden></div>
          <div style="margin-top:6px;">
            <button type="button" id="saveYieldBlockBtn" class="btn btn-primary btn-small">
              + Add yield block
            </button>
          </div>

          <div id="yieldList" class="yield-list"></div>
        </section>

        <footer class="trial-footer" style="margin-top:8px;">
          <button type="button" id="fieldCancelBtn" class="btn btn-quiet btn-small">Close</button>
        </footer>
      </div>
    </div>
  </fv-shell>

  <div id="toast" class="toast" role="status" aria-live="polite">Saved.</div>
</body>
</html>
