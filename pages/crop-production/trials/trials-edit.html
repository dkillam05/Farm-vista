<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FarmVista • Add Field and Yield to Trials</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#3B7E46" />

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest" />
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png" />
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png" />
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css" />
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css" />
  <!-- Swipe list styles for mobile swipe actions -->
  <link rel="stylesheet" href="/Farm-vista/assets/css/swipe-list.css" />

  <style>
    :root{
      --card-max: 1200px;
      --page-bottom-gap: 96px;
      --accent: #2F6C3C;
    }

    html{-webkit-text-size-adjust:100%}
    body{
      background: var(--app-bg, var(--surface));
      overflow-x:hidden;
    }

    .wrap{
      max-width: var(--card-max);
      margin: 0 auto;
      padding: clamp(14px,3vw,22px);
      padding-bottom: calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + var(--page-bottom-gap)) !important;
      box-sizing:border-box;
      display:grid;
      gap:12px;
    }

    .hero{
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));
      overflow:visible;
    }

    .hero-head{
      display:grid;
      grid-template-columns:36px 1fr;
      gap:12px;
      align-items:center;
      padding:14px 16px;
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);
      border-bottom:1px solid var(--border);
    }

    .hero-head .icon{
      width:24px;
      height:24px;
      color:var(--accent);
      display:grid;
      place-items:center;
    }

    .hero-head h1{
      margin:0;
      font-size:clamp(20px,3.2vw,26px);
      line-height:1.2;
    }

    .muted{ color:var(--muted,#67706B); }

    .body{
      padding:16px;
      display:grid;
      gap:12px;
    }

    .toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }

    .toolbar-left{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }

    .toolbar-right{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      font-size:0.9rem;
      opacity:0.9;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:120px;
      padding:10px 14px;
      border-radius:12px;
      border:1px solid var(--border);
      font-weight:800;
      text-decoration:none;
      cursor:pointer;
      user-select:none;
      color:var(--text) !important;
      background:var(--card-surface,var(--surface));
      font-size:0.9rem;
      gap:6px;
    }

    .btn-quiet{
      min-width:auto;
      padding-inline:10px;
    }

    /* Status dropdown – now INSIDE hero */
    .status-filter-wrap{
      display:flex;
      flex-direction:column;
      gap:3px;
      font-size:0.85rem;
      margin-top:4px;
      max-width:220px;
    }

    .status-filter-label{
      font-size:0.78rem;
      text-transform:uppercase;
      letter-spacing:0.06em;
      opacity:0.7;
    }

    .status-filter-select{
      min-width:180px;
      padding:7px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--card-surface, var(--surface));
      font-size:0.9rem;
    }

    /* Trial list */

    .trial-list{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:4px;
    }

    .trial-empty{
      padding:14px 16px;
      border-radius:12px;
      border:1px dashed var(--border);
      background:var(--card-surface, var(--surface));
      font-size:0.95rem;
      opacity:0.9;
    }

    .trial-card{
      position:relative;
      border-radius:14px;
      border:1px solid var(--card-border, var(--border));
      background:var(--card-surface, var(--surface));
      box-shadow:var(--shadow-soft, var(--shadow));
      padding:12px 14px 10px;
      display:flex;
      flex-direction:column;
      gap:6px;
      transition:transform .06s, box-shadow .12s, border-color .12s, background .12s;
      cursor:pointer;
    }

    .trial-card:active{
      transform:scale(.995);
      box-shadow:var(--shadow);
    }

    .trial-row-top{
      display:flex;
      align-items:flex-start;
      gap:10px;
    }

    .trial-main{
      flex:1 1 auto;
      min-width:0;
      padding-right:160px; /* room for Add Fields + Add Yield buttons */
    }

    .trial-title{
      font-weight:700;
      font-size:0.98rem;
      line-height:1.3;
    }

    .trial-sub{
      font-size:0.86rem;
      opacity:0.9;
      margin-top:2px;
    }

    .trial-meta{
      font-size:0.8rem;
      opacity:0.85;
      margin-top:4px;
      display:flex;
      flex-wrap:wrap;
      gap:6px 10px;
    }

    .trial-meta span{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 7px;
      border-radius:999px;
      background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
    }

    .trial-meta-label{
      font-weight:600;
    }

    .trial-meta-value{
      font-weight:600;
    }

    .trial-bottom-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      font-size:0.78rem;
      opacity:0.8;
      margin-top:4px;
      flex-wrap:wrap;
    }

    .trial-status-chip{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 8px;
      border-radius:999px;
      font-size:0.78rem;
      text-transform:uppercase;
      letter-spacing:0.06em;
      background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
    }

    .trial-card-actions{
      position:absolute;
      top:10px;
      right:12px;
      display:flex;
      gap:8px;
      align-items:center;
    }

    .trial-add-btn{
      border-radius:999px;
      border:1px solid var(--border);
      padding:5px 12px;
      font-size:0.78rem;
      font-weight:700;
      background:var(--surface-strong, var(--surface));
      cursor:pointer;
      white-space:nowrap;
      color:var(--accent);
    }

    .trial-add-btn:hover{
      background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
    }

    /* Detail panel */

    .trial-detail-panel{
      margin-top:10px;
      border-radius:10px;
      border:1px solid var(--card-border, var(--border));
      background:var(--card-surface, var(--surface));
      box-shadow:var(--shadow-soft, var(--shadow));
      padding:14px 16px 12px;
      display:none;
      flex-direction:column;
      gap:8px;
    }

    .trial-detail-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
    }

    .trial-detail-title-area{
      display:flex;
      flex-direction:column;
      gap:2px;
    }

    .trial-detail-title{
      font-weight:700;
      font-size:1rem;
      cursor:text;
    }

    .trial-detail-title-input{
      display:none;
      font-size:1rem;
      font-weight:700;
      padding:4px 6px;
      border-radius:8px;
      border:1px solid var(--border);
      background:var(--surface-strong, var(--surface));
      color:var(--text);
      max-width:100%;
    }

    .trial-detail-edit-hint{
      font-size:0.72rem;
      text-transform:uppercase;
      letter-spacing:0.08em;
      opacity:0.6;
    }

    .trial-detail-close{
      border:none;
      outline:none;
      background:transparent;
      padding:0;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:28px;
      height:28px;
      border-radius:999px;
      color:var(--muted,#67706B);
    }

    .trial-detail-close:hover{
      background:color-mix(in srgb, var(--surface) 60%, var(--border) 40%);
      color:var(--text);
    }

    .trial-detail-close svg{
      width:16px;
      height:16px;
      display:block;
    }

    .visually-hidden{
      position:absolute;
      width:1px;
      height:1px;
      padding:0;
      margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      white-space:nowrap;
      border:0;
    }

    .trial-detail-grid{
      display:grid;
      grid-template-columns:minmax(0,1fr);
      gap:6px 16px;
      font-size:0.9rem;
      margin-top:4px;
    }

    @media (min-width:700px){
      .trial-detail-grid{
        grid-template-columns:repeat(2, minmax(0,1fr));
      }
    }

    .trial-detail-item-label{
      font-size:0.8rem;
      text-transform:uppercase;
      letter-spacing:0.06em;
      opacity:0.7;
      margin-bottom:1px;
    }

    .trial-detail-item-value{
      font-size:0.92rem;
    }

    .trial-detail-notes{
      margin-top:8px;
      padding-top:8px;
      border-top:1px solid var(--border);
      font-size:0.92rem;
      white-space:pre-wrap;
    }

    .trial-detail-notes-label{
      font-size:0.8rem;
      text-transform:uppercase;
      letter-spacing:0.06em;
      opacity:0.7;
      margin-bottom:2px;
    }

    .trial-detail-notes-body{
      margin-top:2px;
    }

    .trial-attachments{
      margin-top:8px;
      padding-top:8px;
      border-top:1px solid var(--border);
      font-size:0.9rem;
    }

    .trial-attachments-label{
      font-size:0.8rem;
      text-transform:uppercase;
      letter-spacing:0.06em;
      opacity:0.7;
      margin-bottom:4px;
    }

    .trial-attachments-grid{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }

    .trial-attachment-thumb{
      width:64px;
      height:64px;
      border-radius:10px;
      overflow:hidden;
      border:1px solid var(--border);
      background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:0.8rem;
      cursor:pointer;
      padding:0;
    }

    .trial-attachment-thumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }

    .trial-attachment-empty{
      font-size:0.86rem;
      opacity:0.8;
    }

    /* New: Fields list in details */
    .trial-fields{
      margin-top:8px;
      padding-top:8px;
      border-top:1px solid var(--border);
      font-size:0.9rem;
    }
    .trial-fields-label{
      font-size:0.8rem;
      text-transform:uppercase;
      letter-spacing:0.06em;
      opacity:0.7;
      margin-bottom:4px;
    }
    .trial-fields-list{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .trial-field-row{
      padding:6px 8px;
      border-radius:8px;
      background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
    }
    .trial-field-name{
      font-weight:600;
      font-size:0.9rem;
    }
    .trial-field-meta{
      font-size:0.82rem;
      opacity:0.85;
      margin-top:1px;
    }
    .trial-fields-empty{
      font-size:0.86rem;
      opacity:0.8;
    }

    .trial-actions{
      margin-top:10px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }

    .trial-actions-left{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      align-items:center;
    }

    .trial-actions-right{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      align-items:center;
      margin-left:auto;
    }

    .btn-complete{
      background:var(--accent);
      border-color:var(--accent);
      color:#fff !important;
    }

    .btn-complete[disabled]{
      opacity:.6;
      cursor:not-allowed;
    }

    /* Delete trial button */
    .trial-delete-btn{
      width:32px;
      height:32px;
      border-radius:999px;
      border:1px solid #C53030;
      background:transparent;
      color:#C53030;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
    }

    .trial-delete-btn:hover{
      background:rgba(197,48,48,0.08);
    }

    .trial-delete-btn svg{
      width:16px;
      height:16px;
      display:block;
    }

    .trial-detail-footer{
      margin-top:10px;
      font-size:0.8rem;
      opacity:0.8;
    }

    .trial-detail-pill{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 8px;
      border-radius:999px;
      background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
      font-size:0.8rem;
      margin-left:6px;
    }

    /* File viewer modal */

    .file-modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:100000;
    }
    .file-modal.show{
      display:flex;
    }
    .file-backdrop{
      position:absolute;
      inset:0;
      background:rgba(0,0,0,.6);
    }
    .file-sheet{
      position:relative;
      max-width:90vw;
      max-height:90vh;
      background:var(--surface);
      border-radius:14px;
      border:1px solid var(--border);
      box-shadow:0 20px 40px rgba(0,0,0,.4);
      padding:8px 10px 10px;
      display:flex;
      flex-direction:column;
      gap:6px;
      z-index:1;
    }
    .file-close-row{
      display:flex;
      justify-content:flex-end;
      margin-bottom:4px;
    }
    .file-close-btn{
      border:none;
      border-radius:999px;
      padding:4px 10px;
      font-size:0.85rem;
      cursor:pointer;
      background:color-mix(in srgb, var(--surface) 70%, var(--border) 30%);
      color:var(--text);
    }
    .file-content-wrap{
      border-radius:12px;
      overflow:hidden;
      background:#000;
      max-width:calc(90vw - 20px);
      max-height:calc(80vh - 40px);
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .file-content-wrap img{
      max-width:100%;
      max-height:100%;
      display:block;
    }
    .file-content-wrap iframe{
      border:0;
      width:calc(90vw - 20px);
      height:calc(80vh - 40px);
      background:#fff;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:calc(env(safe-area-inset-bottom,0px) + 72px);
      transform:translateX(-50%);
      background:#2F6C3C;
      color:#fff;
      padding:10px 14px;
      border-radius:10px;
      box-shadow:0 6px 20px rgba(0,0,0,.25);
      z-index:99999;
      display:none;
    }
    .toast.show{
      display:block;
      animation:fadeout 5s forwards;
    }
    @keyframes fadeout{
      0%{opacity:1}
      85%{opacity:1}
      100%{opacity:0}
    }

    /* Edit-mode inputs in detail panel */
    .trial-edit-input,
    .trial-edit-select,
    .trial-edit-notes{
      width:100%;
      padding:6px 8px;
      border-radius:8px;
      border:1px solid var(--border);
      background:var(--surface-strong, var(--surface));
      font-size:0.9rem;
      box-sizing:border-box;
    }

    .trial-edit-notes{
      min-height:80px;
      resize:vertical;
      white-space:pre-wrap;
    }

    /* ===== Mobile simplification ===== */
    @media (max-width: 600px){
      .trial-card{
        padding:10px 12px;
      }
      .trial-main{
        padding-right:90px;
      }
      .trial-meta,
      .trial-bottom-row{
        display:none;
      }
      /* Hide desktop action buttons on phone – rely on swipe */
      .trial-card-actions{
        display:none;
      }
    }
  </style>

  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true;
        document.head.appendChild(s);
      }
    })();
  </script>

  <script type="module">
    import {
      ready,
      getFirestore,
      collection,
      getDocs,
      doc,
      updateDoc,
      deleteDoc
    } from '/Farm-vista/js/firebase-init.js';

    import { NAV_MENU } from '/Farm-vista/js/menu.js';
    import { initSwipeList } from '/Farm-vista/js/fv-swipe-list.js';

    const CONFIG = {
      COLLECTION_TRIALS: 'fieldTrials',
      STATUS_FIELD:  'status',
      STATUS_ALL: 'all',
      STATUS_PENDING:'pending',
      STATUS_ACTIVE: 'active',
      STATUS_COMPLETED:'completed',
      ADD_FIELD_URL: '/Farm-vista/pages/crop-production/trials/trial-field-add.html',
      ADD_YIELD_URL: '/Farm-vista/pages/crop-production/trials/trial-field-yield.html',
      ADD_YIELD_MH_URL: '/Farm-vista/pages/crop-production/trials/trial-field-yield-mh.html'
    };

    const STATE = {
      db: null,
      allItems: [],
      items: [],
      selectedId: null,
      filterStatus: null,
      loaded: false,
      pendingFilter: null,
      isLoading: false,
      retryCount: 0,
      // trialId -> boolean (true = has field, false = no field) for MH trials
      mhHasFieldByTrial: {},
      // inline title editing
      isEditingTitle: false,
      // inline setup editing
      isEditingSetup: false,
      // trialId -> aggregate stats + fields cache
      trialStats: {},
      trialFields: {},
      trialStatsPromises: {}
    };

    const $  = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));

    function fmtNumber(value, decimals){
      const n = Number(value);
      if(!isFinite(n)) return null;
      return n.toFixed(decimals);
    }

    let toastEl;
    let fileModal, fileBackdrop, fileCloseBtn, fileContentWrap;

    function getTime(ts){
      if(!ts) return 0;
      try{
        if(ts.toMillis) return ts.toMillis();
        if(ts.toDate)   return ts.toDate().getTime();
        if(ts instanceof Date) return ts.getTime();
        return new Date(ts).getTime() || 0;
      }catch{
        return 0;
      }
    }

    // NEW: sort trials by type (A–Z), then trialName (A–Z), then newest createdAt
    function sortTrialsList(items){
      if(!Array.isArray(items)) return items;
      items.sort((a, b) => {
        const da = a.data || {};
        const db = b.data || {};

        let typeA = (da.trialType || '').toString().trim().toLowerCase();
        let typeB = (db.trialType || '').toString().trim().toLowerCase();

        // Push missing types to the bottom
        if(!typeA) typeA = '\uffff';
        if(!typeB) typeB = '\uffff';

        if(typeA < typeB) return -1;
        if(typeA > typeB) return 1;

        let nameA = (da.trialName || '').toString().trim().toLowerCase();
        let nameB = (db.trialName || '').toString().trim().toLowerCase();

        if(!nameA) nameA = '\uffff';
        if(!nameB) nameB = '\uffff';

        if(nameA < nameB) return -1;
        if(nameA > nameB) return 1;

        // If same type + name, keep newest first
        const ta = getTime(da.createdAt);
        const tb = getTime(db.createdAt);
        return tb - ta;
      });
      return items;
    }

    function getStatusLabel(code){
      if(!code) return '';
      const c = String(code).toLowerCase();
      if(c === CONFIG.STATUS_ALL)       return 'All';
      if(c === CONFIG.STATUS_PENDING)   return 'Pending';
      if(c === CONFIG.STATUS_ACTIVE)    return 'Active';
      if(c === CONFIG.STATUS_COMPLETED) return 'Completed';
      return code;
    }

    function isImageUrl(url){
      if(!url || typeof url !== 'string') return false;
      const u = url.split('?')[0].toLowerCase();
      return u.endsWith('.jpg') || u.endsWith('.jpeg') || u.endsWith('.png') ||
             u.endsWith('.gif') || u.endsWith('.webp') || u.endsWith('.heic');
    }

    function showToast(message){
      if(!toastEl) return;
      toastEl.textContent = message || 'Saved.';
      toastEl.classList.remove('show');
      void toastEl.offsetWidth;
      toastEl.classList.add('show');
    }

    function isMultiHybridTrialData(d){
      if (!d) return false;

      // explicit flags still win
      if (d.isMultiHybrid === true || d.multiHybrid === true) return true;

      const trialType     = (d.trialType      || '').toString().toLowerCase();
      const seedTrialType = (d.seedTrialType  || '').toString().toLowerCase();
      const trialSubtype  = (d.trialSubtype   || '').toString().toLowerCase();

      // Your current structure: Seed Varieties + Multiple Hybrid Trial
      if (trialType === 'seed varieties' &&
          seedTrialType === 'multiple hybrid trial') {
        return true;
      }

      // Fallback: any subtype text that literally says multi + hybrid
      if (seedTrialType.includes('multi') && seedTrialType.includes('hybrid')) return true;
      if (trialSubtype.includes('multi')  && trialSubtype.includes('hybrid'))  return true;
      if (trialType.includes('multi')     && trialType.includes('hybrid'))     return true;

      return false;
    }

    function buildYieldUrl(trialId, data){
      const isMh = isMultiHybridTrialData(data);
      const base = isMh ? CONFIG.ADD_YIELD_MH_URL : CONFIG.ADD_YIELD_URL;
      return `${base}?trialId=${encodeURIComponent(trialId)}`;
    }

    // Apply stats to a given trial card DOM node
    function applyStatsToCard(card, stats){
      if(!card) return;
      const acresEl = card.querySelector('[data-role="stat-acres"] .trial-meta-value');
      const checkEl = card.querySelector('[data-role="stat-check"] .trial-meta-value');
      const trialEl = card.querySelector('[data-role="stat-trial"] .trial-meta-value');

      if(acresEl){
        if(stats && stats.totalTrialAcres != null && isFinite(stats.totalTrialAcres)){
          const v = fmtNumber(stats.totalTrialAcres, 1);
          acresEl.textContent = v !== null ? v : '—';
        }else{
          acresEl.textContent = '—';
        }
      }

      if(checkEl){
        if(stats && stats.avgCheckYield != null && isFinite(stats.avgCheckYield)){
          const v = fmtNumber(stats.avgCheckYield, 1);
          checkEl.textContent = v !== null ? v : '—';
        }else{
          checkEl.textContent = '—';
        }
      }

      if(trialEl){
        if(stats && stats.avgTrialYield != null && isFinite(stats.avgTrialYield)){
          const v = fmtNumber(stats.avgTrialYield, 1);
          trialEl.textContent = v !== null ? v : '—';
        }else{
          trialEl.textContent = '—';
        }
      }
    }

    // Load fields + stats (total acres + weighted avg yields) for a trial, with caching
    async function loadTrialStats(trialId){
      if(!STATE.db || !trialId) return { stats: null, fields: [] };

      if(STATE.trialStatsPromises[trialId]){
        return STATE.trialStatsPromises[trialId];
      }

      const p = (async () => {
        const db = STATE.db;
        const fieldsRef = collection(db, CONFIG.COLLECTION_TRIALS, trialId, 'fields');
        const fieldsSnap = await getDocs(fieldsRef);

        const fields = [];
        let totalTrialAcres = 0;
        let checkWeighted = 0;
        let checkAcres = 0;
        let trialWeighted = 0;
        let trialAcresBlocks = 0;

        for(const fDoc of fieldsSnap.docs){
          const fData = fDoc.data() || {};
          const fieldId = fDoc.id;

          const trialAcres = Number(fData.trialAcres) || 0;
          const tillable   = Number(fData.tillable)   || 0;

          fields.push({
            id: fieldId,
            farmName: fData.farmName || '',
            fieldName: fData.fieldName || '',
            trialAcres,
            tillable
          });

          totalTrialAcres += trialAcres;

          // Yield blocks under this field
          const blocksRef = collection(
            db,
            CONFIG.COLLECTION_TRIALS,
            trialId,
            'fields',
            fieldId,
            'yieldBlocks'
          );
          const blocksSnap = await getDocs(blocksRef);
          for(const bDoc of blocksSnap.docs){
            const blk = bDoc.data() || {};
            const chk = blk.check || {};
            const tr  = blk.trial || {};

            const chkAcres = Number(chk.acres) || 0;
            const trAcres  = Number(tr.acres)  || 0;
            const chkYield = Number(chk.yieldBuAc);
            const trYield  = Number(tr.yieldBuAc);

            if(chkAcres > 0 && !isNaN(chkYield)){
              checkWeighted += chkYield * chkAcres;
              checkAcres    += chkAcres;
            }
            if(trAcres > 0 && !isNaN(trYield)){
              trialWeighted    += trYield * trAcres;
              trialAcresBlocks += trAcres;
            }
          }
        }

        const stats = {
          totalTrialAcres,
          avgCheckYield: checkAcres > 0 ? (checkWeighted / checkAcres) : null,
          avgTrialYield: trialAcresBlocks > 0 ? (trialWeighted / trialAcresBlocks) : null
        };

        STATE.trialStats[trialId] = stats;
        STATE.trialFields[trialId] = fields;

        return { stats, fields };
      })().catch(err => {
        console.error('Error loading trial stats for', trialId, err);
        const fallback = { stats: null, fields: [] };
        STATE.trialStats[trialId] = null;
        STATE.trialFields[trialId] = [];
        return fallback;
      });

      STATE.trialStatsPromises[trialId] = p;
      return p;
    }

    // Render "Fields in this trial" section in detail panel
    function renderTrialFields(trialId){
      const listEl = document.getElementById('trialFieldsList');
      if(!listEl || !trialId) return;

      listEl.innerHTML = '<div class="trial-fields-empty">Loading fields...</div>';

      loadTrialStats(trialId).then(({ fields }) => {
        if(!listEl) return;
        listEl.innerHTML = '';

        if(!fields || !fields.length){
          const empty = document.createElement('div');
          empty.className = 'trial-fields-empty';
          empty.textContent = 'No fields assigned yet.';
          listEl.appendChild(empty);
          return;
        }

        fields.forEach(f => {
          const row = document.createElement('div');
          row.className = 'trial-field-row';

          const trialAcresText = (f.trialAcres && isFinite(f.trialAcres))
            ? `${fmtNumber(f.trialAcres, 1)} ac trial`
            : '';

          const tillableText = (f.tillable && isFinite(f.tillable))
            ? `${fmtNumber(f.tillable, 1)} ac tillable`
            : '';

          const metaParts = [];
          if(trialAcresText) metaParts.push(trialAcresText);
          if(tillableText)   metaParts.push(tillableText);

          row.innerHTML = `
            <div class="trial-field-name">
              ${f.farmName || ''}${f.farmName && f.fieldName ? ' • ' : ''}${f.fieldName || ''}
            </div>
            ${metaParts.length ? `
            <div class="trial-field-meta">
              ${metaParts.join(' • ')}
            </div>` : ''}
          `;
          listEl.appendChild(row);
        });
      }).catch(err => {
        console.error('Error rendering fields for trial', trialId, err);
        listEl.innerHTML = '';
        const empty = document.createElement('div');
        empty.className = 'trial-fields-empty';
        empty.textContent = 'Error loading fields for this trial.';
        listEl.appendChild(empty);
      });
    }

    // For MH trials, figure out whether a field already exists and
    // show/hide Add Fields / Add Yield buttons on the card.
    async function configureMhButtonsForTrial(card, trialId, data){
      if (!STATE.db) return;
      if (!isMultiHybridTrialData(data)) return;

      const addFieldBtn = card.querySelector('.trial-add-fields-btn');
      const addYieldBtn = card.querySelector('.trial-add-yield-btn');

      // Optimistic default while loading: allow Add Field, hide Add Yield
      if(addFieldBtn) addFieldBtn.style.display = 'none';
      if(addYieldBtn) addYieldBtn.style.display = 'none';

      try{
        const fieldsRef = collection(
          STATE.db,
          CONFIG.COLLECTION_TRIALS,
          trialId,
          'fields'
        );
        const snap = await getDocs(fieldsRef);
        const hasField = !snap.empty;
        STATE.mhHasFieldByTrial[trialId] = hasField;

        if(hasField){
          // MH trial already has a field: hide Add Field, show Add Yield
          if(addFieldBtn) addFieldBtn.style.display = 'none';
          if(addYieldBtn) addYieldBtn.style.display = '';
        }else{
          // No field yet: show Add Field, hide Add Yield
          if(addFieldBtn) addFieldBtn.style.display = '';
          if(addYieldBtn) addYieldBtn.style.display = 'none';
        }
      }catch(err){
        console.error('Error checking MH field status:', err);
        // On error, prefer to allow adding a field, but keep yield hidden
        STATE.mhHasFieldByTrial[trialId] = false;
        if(addFieldBtn) addFieldBtn.style.display = '';
        if(addYieldBtn) addYieldBtn.style.display = 'none';
      }
    }

    function setTrialTitleView(title){
      const textEl  = document.getElementById('trialDetailTitleText');
      const inputEl = document.getElementById('trialDetailTitleInput');
      if(!textEl || !inputEl) return;
      STATE.isEditingTitle = false;
      textEl.textContent = title || 'Field Trial';
      textEl.style.display = 'block';
      inputEl.style.display = 'none';
    }

    function beginEditTrialTitle(){
      const id = STATE.selectedId;
      if(!id || !STATE.db) return;
      const textEl  = document.getElementById('trialDetailTitleText');
      const inputEl = document.getElementById('trialDetailTitleInput');
      if(!textEl || !inputEl) return;

      STATE.isEditingTitle = true;
      inputEl.value = (textEl.textContent || '').trim();
      textEl.style.display = 'none';
      inputEl.style.display = 'inline-block';
      inputEl.focus();
      inputEl.select();
    }

    function cancelEditTrialTitle(){
      const id = STATE.selectedId;
      const item = STATE.items.find(x => x.id === id);
      const name = item?.data?.trialName || 'Field Trial';
      setTrialTitleView(name);
    }

    async function commitEditTrialTitle(){
      const id = STATE.selectedId;
      const db = STATE.db;
      if(!id || !db){
        cancelEditTrialTitle();
        return;
      }

      const inputEl = document.getElementById('trialDetailTitleInput');
      if(!inputEl){
        cancelEditTrialTitle();
        return;
      }

      let newName = (inputEl.value || '').trim();
      if(!newName){
        newName = 'Field Trial';
      }

      const itemAll = STATE.allItems.find(x => x.id === id);
      const oldName = itemAll?.data?.trialName || 'Field Trial';

      // No change – just flip back to display mode
      if(newName === oldName){
        setTrialTitleView(newName);
        return;
      }

      inputEl.disabled = true;

      try{
        const ref = doc(db, CONFIG.COLLECTION_TRIALS, id);
        await updateDoc(ref, { trialName: newName });

        if(itemAll){
          itemAll.data.trialName = newName;
        }
        const itemFiltered = STATE.items.find(x => x.id === id);
        if(itemFiltered){
          itemFiltered.data.trialName = newName;
        }

        setTrialTitleView(newName);
        renderList();
        showToast('Trial name updated.');
      }catch(err){
        console.error('Error updating trial name:', err);
        showToast('Error updating trial name.');
        // fall back to old name
        setTrialTitleView(oldName);
      }finally{
        inputEl.disabled = false;
      }
    }

    function resetDetailButtonsForViewMode(){
      const editBtn   = $('#trialEditBtn');
      const saveBtn   = $('#trialSaveBtn');
      const cancelBtn = $('#trialCancelBtn');
      const completeBtn = $('#trialCompleteBtn');
      const delBtn      = $('#trialDeleteBtn');

      STATE.isEditingSetup = false;

      if(editBtn){
        editBtn.style.display = STATE.selectedId ? 'inline-flex' : 'none';
        editBtn.disabled = !STATE.selectedId;
      }
      if(saveBtn){
        saveBtn.style.display = 'none';
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Changes';
      }
      if(cancelBtn){
        cancelBtn.style.display = 'none';
        cancelBtn.disabled = false;
      }
      if(completeBtn){
        completeBtn.disabled = false;
      }
      if(delBtn){
        delBtn.disabled = false;
      }
    }

    function clearDetails(){
      const panel = $('.trial-detail-panel');
      if(!panel) return;
      panel.style.display = 'none';
      panel.dataset.id = '';

      setTrialTitleView('Trial Details');

      const grid = $('.trial-detail-grid', panel);
      if(grid) grid.innerHTML = '';
      const notesBody = $('.trial-detail-notes-body', panel);
      if(notesBody) notesBody.textContent = '';
      const footer = $('.trial-detail-footer', panel);
      if(footer) footer.innerHTML = '';
      const attGrid = $('#trialDetailAttachments');
      if(attGrid) attGrid.innerHTML = '';
      const fieldsList = document.getElementById('trialFieldsList');
      if(fieldsList){
        fieldsList.innerHTML = '';
      }
      const completeBtn = $('#trialCompleteBtn');
      if(completeBtn){
        completeBtn.style.display = 'none';
        completeBtn.disabled = false;
        completeBtn.textContent = 'Mark Trial Completed';
        delete completeBtn.dataset.id;
      }
      const delBtn = $('#trialDeleteBtn');
      if(delBtn){
        delBtn.disabled = false;
      }

      resetDetailButtonsForViewMode();
    }

    function openFileViewer(att){
      if(!fileModal || !fileContentWrap || !att || !att.url) return;
      fileContentWrap.innerHTML = '';
      if(isImageUrl(att.url)){
        const img = document.createElement('img');
        img.src = att.url;
        img.alt = att.name || 'Attachment';
        fileContentWrap.appendChild(img);
      }else{
        const iframe = document.createElement('iframe');
        iframe.src = att.url;
        fileContentWrap.appendChild(iframe);
      }
      fileModal.classList.add('show');
      document.body.style.overflow = 'hidden';
    }

    function closeFileViewer(){
      if(!fileModal) return;
      fileModal.classList.remove('show');
      if(fileContentWrap) fileContentWrap.innerHTML = '';
      document.body.style.overflow = '';
    }

    function renderDetails(){
      const panel = $('.trial-detail-panel');
      if(!panel) return;
      const item = STATE.items.find(x => x.id === STATE.selectedId);
      if(!item){
        clearDetails();
        return;
      }

      const d = item.data;

      const title = d.trialName || 'Field Trial';
      const cropYear = d.cropYear ?? null;
      const crop = d.crop || '';
      const trialType = d.trialType || '';
      const operationTask = d.operationTask || '';
      const treatment = d.treatmentProduct || '';
      const check = d.check || '';
      const status = d[CONFIG.STATUS_FIELD] || '';
      const statusLower = String(status || '').toLowerCase();
      const createdBy = d.createdByName || d.createdByEmail || '';
      const when = d.createdAt && d.createdAt.toDate ? d.createdAt.toDate()
                 : (d.createdAt ? new Date(d.createdAt) : null);
      const notes = d.notes || '';

      panel.dataset.id = item.id;

      setTrialTitleView(title);

      const grid = $('.trial-detail-grid', panel);
      if(grid){
        grid.innerHTML = `
          ${(cropYear !== null || crop) ? `
          <div>
            <div class="trial-detail-item-label">Crop Year / Crop</div>
            <div class="trial-detail-item-value">
              ${cropYear !== null ? cropYear : ''}${cropYear && crop ? ' • ' : ''}${crop}
            </div>
          </div>` : ''}

          ${trialType ? `
          <div>
            <div class="trial-detail-item-label">Trial Type</div>
            <div class="trial-detail-item-value">${trialType}</div>
          </div>` : ''}

          ${operationTask ? `
          <div>
            <div class="trial-detail-item-label">Operation</div>
            <div class="trial-detail-item-value">${operationTask}</div>
          </div>` : ''}

          ${treatment ? `
          <div>
            <div class="trial-detail-item-label">Treatment Product</div>
            <div class="trial-detail-item-value">${treatment}</div>
          </div>` : ''}

          ${check ? `
          <div>
            <div class="trial-detail-item-label">Check</div>
            <div class="trial-detail-item-value">${check}</div>
          </div>` : ''}

          ${createdBy ? `
          <div>
            <div class="trial-detail-item-label">Created By</div>
            <div class="trial-detail-item-value">${createdBy}</div>
          </div>` : ''}

          ${when ? `
          <div>
            <div class="trial-detail-item-label">Created</div>
            <div class="trial-detail-item-value">${when.toLocaleString()}</div>
          </div>` : ''}

          ${status ? `
          <div>
            <div class="trial-detail-item-label">Status</div>
            <div class="trial-detail-item-value">${getStatusLabel(status)}</div>
          </div>` : ''}
        `;
      }

      const notesBody = $('.trial-detail-notes-body', panel);
      if(notesBody){
        notesBody.textContent = notes || 'No additional notes recorded.';
      }

      const attGrid = $('#trialDetailAttachments');
      if(attGrid){
        attGrid.innerHTML = '';
        const files = Array.isArray(d.files) ? d.files : [];
        if(files.length){
          files.forEach(raw => {
            if(!raw || !raw.url) return;
            const att = {
              url: raw.url,
              name: raw.name || raw.path || 'Attachment'
            };

            const thumbBtn = document.createElement('button');
            thumbBtn.type = 'button';
            thumbBtn.className = 'trial-attachment-thumb';
            thumbBtn.title = att.name;

            if(isImageUrl(att.url)){
              const img = document.createElement('img');
              img.src = att.url;
              img.alt = att.name;
              thumbBtn.appendChild(img);
            }else{
              thumbBtn.textContent = 'FILE';
            }

            thumbBtn.addEventListener('click', (ev)=>{
              ev.stopPropagation();
              openFileViewer(att);
            });

            attGrid.appendChild(thumbBtn);
          });
        }else{
          const empty = document.createElement('div');
          empty.className = 'trial-attachment-empty';
          empty.textContent = 'No files or photos attached.';
          attGrid.appendChild(empty);
        }
      }

      // Show fields in this trial
      renderTrialFields(item.id);

      const footer = $('.trial-detail-footer', panel);
      if(footer){
        footer.innerHTML = `
          Current status:
          <span class="trial-detail-pill">${getStatusLabel(status) || 'unknown'}</span>
        `;
      }

      const completeBtn = $('#trialCompleteBtn');
      if(completeBtn){
        if(statusLower === CONFIG.STATUS_COMPLETED){
          completeBtn.style.display = 'none';
          completeBtn.disabled = false;
          completeBtn.textContent = 'Mark Trial Completed';
          delete completeBtn.dataset.id;
        }else{
          completeBtn.style.display = 'inline-flex';
          completeBtn.disabled = false;
          completeBtn.textContent = 'Mark Trial Completed';
          completeBtn.dataset.id = item.id;
        }
      }

      const delBtn = $('#trialDeleteBtn');
      if(delBtn){
        delBtn.disabled = false;
      }

      resetDetailButtonsForViewMode();
      panel.style.display = 'flex';
    }

    function enterEditSetup(){
      const id = STATE.selectedId;
      if(!id || !STATE.db) return;
      const panel = $('.trial-detail-panel');
      if(!panel) return;
      const item = STATE.items.find(x => x.id === id);
      if(!item) return;
      const d = item.data || {};

      const grid = $('.trial-detail-grid', panel);
      if(!grid) return;

      STATE.isEditingSetup = true;

      const cropYear = d.cropYear ?? '';
      const crop = d.crop || '';
      const trialType = d.trialType || '';
      const operationTask = d.operationTask || '';
      const treatment = d.treatmentProduct || '';
      const check = d.check || '';
      const status = (d[CONFIG.STATUS_FIELD] || CONFIG.STATUS_PENDING).toString().toLowerCase();
      const notes = d.notes || '';

      grid.innerHTML = `
        <div>
          <div class="trial-detail-item-label">Crop Year</div>
          <input
            type="number"
            id="trialEditCropYear"
            class="trial-edit-input"
            inputmode="numeric"
            value="${cropYear !== '' ? String(cropYear) : ''}"
          />
        </div>

        <div>
          <div class="trial-detail-item-label">Crop</div>
          <input
            type="text"
            id="trialEditCrop"
            class="trial-edit-input"
            maxlength="40"
            value="${crop.replace(/"/g, '&quot;')}"
          />
        </div>

        <div>
          <div class="trial-detail-item-label">Trial Type</div>
          <input
            type="text"
            id="trialEditTrialType"
            class="trial-edit-input"
            maxlength="80"
            value="${trialType.replace(/"/g, '&quot;')}"
          />
        </div>

        <div>
          <div class="trial-detail-item-label">Operation</div>
          <input
            type="text"
            id="trialEditOperation"
            class="trial-edit-input"
            maxlength="80"
            value="${operationTask.replace(/"/g, '&quot;')}"
          />
        </div>

        <div>
          <div class="trial-detail-item-label">Treatment Product</div>
          <input
            type="text"
            id="trialEditTreatment"
            class="trial-edit-input"
            maxlength="120"
            value="${treatment.replace(/"/g, '&quot;')}"
          />
        </div>

        <div>
          <div class="trial-detail-item-label">Check</div>
          <input
            type="text"
            id="trialEditCheck"
            class="trial-edit-input"
            maxlength="120"
            value="${check.replace(/"/g, '&quot;')}"
          />
        </div>

        <div>
          <div class="trial-detail-item-label">Status</div>
          <select id="trialEditStatus" class="trial-edit-select">
            <option value="pending"${status === CONFIG.STATUS_PENDING ? ' selected' : ''}>Pending</option>
            <option value="active"${status === CONFIG.STATUS_ACTIVE ? ' selected' : ''}>Active</option>
            <option value="completed"${status === CONFIG.STATUS_COMPLETED ? ' selected' : ''}>Completed</option>
          </select>
        </div>
      `;

      const notesBody = $('.trial-detail-notes-body', panel);
      if(notesBody){
        notesBody.innerHTML = '';
        const ta = document.createElement('textarea');
        ta.id = 'trialEditNotes';
        ta.className = 'trial-edit-notes';
        ta.value = notes;
        notesBody.appendChild(ta);
      }

      const editBtn   = $('#trialEditBtn');
      const saveBtn   = $('#trialSaveBtn');
      const cancelBtn = $('#trialCancelBtn');
      const completeBtn = $('#trialCompleteBtn');
      const delBtn      = $('#trialDeleteBtn');

      if(editBtn){
        editBtn.style.display = 'none';
      }
      if(saveBtn){
        saveBtn.style.display = 'inline-flex';
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Changes';
      }
      if(cancelBtn){
        cancelBtn.style.display = 'inline-flex';
        cancelBtn.disabled = false;
      }
      if(completeBtn){
        completeBtn.disabled = true;
      }
      if(delBtn){
        delBtn.disabled = true;
      }
    }

    async function saveEditSetup(){
      const id = STATE.selectedId;
      const db = STATE.db;
      if(!id || !db) return;

      const cropYearEl   = $('#trialEditCropYear');
      const cropEl       = $('#trialEditCrop');
      const trialTypeEl  = $('#trialEditTrialType');
      const opEl         = $('#trialEditOperation');
      const treatmentEl  = $('#trialEditTreatment');
      const checkEl      = $('#trialEditCheck');
      const statusEl     = $('#trialEditStatus');
      const notesEl      = $('#trialEditNotes');

      if(!cropYearEl || !cropEl || !trialTypeEl || !opEl || !treatmentEl || !checkEl || !statusEl || !notesEl){
        // If something is off, just bail back to view mode
        STATE.isEditingSetup = false;
        renderDetails();
        return;
      }

      const editBtn   = $('#trialEditBtn');
      const saveBtn   = $('#trialSaveBtn');
      const cancelBtn = $('#trialCancelBtn');
      const completeBtn = $('#trialCompleteBtn');
      const delBtn      = $('#trialDeleteBtn');

      if(saveBtn){
        saveBtn.disabled = true;
        saveBtn.textContent = 'Saving...';
      }
      if(cancelBtn){
        cancelBtn.disabled = true;
      }

      const cropYearRaw = (cropYearEl.value || '').trim();
      const cropRaw = (cropEl.value || '').trim();
      const trialTypeRaw = (trialTypeEl.value || '').trim();
      const opRaw = (opEl.value || '').trim();
      const treatmentRaw = (treatmentEl.value || '').trim();
      const checkRaw = (checkEl.value || '').trim();
      const statusRaw = (statusEl.value || '').trim().toLowerCase();
      const notesRaw = notesEl.value || '';

      const updates = {};

      if(cropYearRaw){
        const n = Number(cropYearRaw);
        updates.cropYear = isFinite(n) ? n : null;
      }else{
        updates.cropYear = null;
      }

      updates.crop = cropRaw || '';
      updates.trialType = trialTypeRaw || '';
      updates.operationTask = opRaw || '';
      updates.treatmentProduct = treatmentRaw || '';
      updates.check = checkRaw || '';
      updates.notes = notesRaw;
      if(statusRaw){
        updates[CONFIG.STATUS_FIELD] = statusRaw;
      }

      try{
        const ref = doc(db, CONFIG.COLLECTION_TRIALS, id);
        await updateDoc(ref, updates);

        // Update local copies
        const itemAll = STATE.allItems.find(x => x.id === id);
        const itemFiltered = STATE.items.find(x => x.id === id);
        const targets = [itemAll, itemFiltered].filter(Boolean);

        targets.forEach(t => {
          t.data.cropYear = updates.cropYear;
          t.data.crop = updates.crop;
          t.data.trialType = updates.trialType;
          t.data.operationTask = updates.operationTask;
          t.data.treatmentProduct = updates.treatmentProduct;
          t.data.check = updates.check;
          t.data.notes = updates.notes;
          if(updates[CONFIG.STATUS_FIELD] !== undefined){
            t.data[CONFIG.STATUS_FIELD] = updates[CONFIG.STATUS_FIELD];
          }
        });

        STATE.isEditingSetup = false;
        // Re-apply filter (status might have changed)
        const currentFilter = STATE.filterStatus || CONFIG.STATUS_ALL;
        applyFilter(currentFilter);

        showToast('Trial setup updated.');
      }catch(err){
        console.error('Error updating trial setup:', err);
        showToast('Error updating trial setup.');
        STATE.isEditingSetup = false;
        renderDetails();
      }finally{
        if(editBtn){
          editBtn.disabled = false;
        }
        if(saveBtn){
          saveBtn.disabled = false;
          saveBtn.textContent = 'Save Changes';
        }
        if(cancelBtn){
          cancelBtn.disabled = false;
        }
        if(completeBtn){
          completeBtn.disabled = false;
        }
        if(delBtn){
          delBtn.disabled = false;
        }
      }
    }

    function cancelEditSetup(){
      STATE.isEditingSetup = false;
      renderDetails();
    }

    function setupMobileSwipe(listEl){
      if(!listEl) return;
      if(!window.matchMedia) return;
      const isMobile = window.matchMedia('(max-width: 600px)').matches;
      if(!isMobile) return;

      const cards = listEl.querySelectorAll('.trial-card');
      cards.forEach(card => {
        card.classList.add('fv-swipe-item');
      });

      initSwipeList(listEl, {
        itemSelector: '.fv-swipe-item',
        // Swipe RIGHT -> Add Yield (positive)
        leftAction: {
          label: 'Add Yield',
          onAction: (itemEl) => {
            const trialId = itemEl.dataset.trialId;
            if(!trialId) return;
            const item = STATE.items.find(x => x.id === trialId);
            if(!item) return;
            const data = item.data;

            (async () => {
              // For MH trials, only allow Add Yield if there is a field
              if (isMultiHybridTrialData(data)) {
                let hasField = STATE.mhHasFieldByTrial[trialId];
                if (typeof hasField !== 'boolean' && STATE.db) {
                  try{
                    const fieldsRef = collection(
                      STATE.db,
                      CONFIG.COLLECTION_TRIALS,
                      trialId,
                      'fields'
                    );
                    const snap = await getDocs(fieldsRef);
                    hasField = !snap.empty;
                    STATE.mhHasFieldByTrial[trialId] = hasField;
                  }catch(err){
                    console.error('Error checking MH field (swipe Add Yield):', err);
                  }
                }

                if(hasField === false){
                  showToast('Add a field to this multi-hybrid trial first.');
                  return;
                }
              }

              const url = buildYieldUrl(trialId, data);
              window.location.href = url;
            })();
          }
        },
        // Swipe LEFT -> Add Field
        rightAction: {
          label: 'Add Field',
          onAction: (itemEl) => {
            const trialId = itemEl.dataset.trialId;
            if(!trialId) return;
            const item = STATE.items.find(x => x.id === trialId);
            const data = item?.data;

            (async () => {
              // For MH trials, only allow Add Field if one doesn't already exist
              if (isMultiHybridTrialData(data)) {
                let hasField = STATE.mhHasFieldByTrial[trialId];
                if (typeof hasField !== 'boolean' && STATE.db) {
                  try{
                    const fieldsRef = collection(
                      STATE.db,
                      CONFIG.COLLECTION_TRIALS,
                      trialId,
                      'fields'
                    );
                    const snap = await getDocs(fieldsRef);
                    hasField = !snap.empty;
                    STATE.mhHasFieldByTrial[trialId] = hasField;
                  }catch(err){
                    console.error('Error checking MH field (swipe Add Field):', err);
                  }
                }

                if(hasField === true){
                  showToast('This multi-hybrid trial already has a field.');
                  return;
                }
              }

              const url = `${CONFIG.ADD_FIELD_URL}?trialId=${encodeURIComponent(trialId)}`;
              window.location.href = url;
            })();
          }
        }
      });
    }

    function renderList(){
      const listEl  = $('.trial-list');
      const emptyEl = $('.trial-empty');
      const countEl = $('#trialCount');

      if(!listEl) return;

      listEl.innerHTML = '';

      const statusCode  = STATE.filterStatus || CONFIG.STATUS_ALL;

      let labelLower = '';
      if(statusCode === CONFIG.STATUS_ALL){
        labelLower = 'trials';
      }else{
        const statusLabel = getStatusLabel(statusCode);
        labelLower  = statusLabel ? statusLabel.toLowerCase() : 'pending';
      }

      if(!STATE.items.length){
        if(emptyEl) {
          emptyEl.style.display = 'block';
          emptyEl.textContent = statusCode === CONFIG.STATUS_ALL
            ? 'No trials right now.'
            : `No ${labelLower} trials right now.`;
        }
        if(countEl){
          if(statusCode === CONFIG.STATUS_ALL){
            countEl.textContent = '0 trials';
          }else{
            countEl.textContent = `0 ${labelLower} trials`;
          }
        }
        clearDetails();
        return;
      }

      if(emptyEl){
        emptyEl.style.display = 'none';
      }

      for(const item of STATE.items){
        const d = item.data;
        const id = item.id;

        const title = d.trialName || 'Field Trial';
        const cropYear = d.cropYear ?? null;
        const crop = d.crop || '';
        const trialType = d.trialType || '';
        const operationTask = d.operationTask || '';
        const statusRaw = (d.status || '').toString() || CONFIG.STATUS_PENDING;
        const createdAt = d.createdAt || null;
        const when = createdAt && createdAt.toDate ? createdAt.toDate()
                   : (createdAt ? new Date(createdAt) : null);

        const statusLower = statusRaw.toLowerCase();
        const friendlyStatus =
          statusLower === CONFIG.STATUS_ACTIVE    ? 'Active'    :
          statusLower === CONFIG.STATUS_PENDING   ? 'Pending'   :
          statusLower === CONFIG.STATUS_COMPLETED ? 'Completed' :
          statusRaw;

        const card = document.createElement('article');
        card.className = 'trial-card';
        card.dataset.id = id;
        card.dataset.trialId = id;

        const isMhTrial = isMultiHybridTrialData(d);
        if(isMhTrial){
          card.dataset.isMh = '1';
        }

        card.innerHTML = `
          <div class="trial-card-actions">
            <button type="button" class="trial-add-btn trial-add-fields-btn">Add Fields</button>
            <button type="button" class="trial-add-btn trial-add-yield-btn">Add Yield</button>
          </div>

          <div class="trial-row-top">
            <div class="trial-main">
              <div class="trial-title">
                ${title}
              </div>
              <div class="trial-sub">
                ${cropYear !== null ? cropYear : ''}${cropYear && crop ? ' • ' : ''}${crop}
                ${trialType ? ` • ${trialType}` : ''}
              </div>
              <div class="trial-meta">
                ${operationTask ? `
                  <span><span class="trial-meta-label">Operation</span> ${operationTask}</span>
                ` : ''}
                ${trialType ? `
                  <span><span class="trial-meta-label">Type</span> ${trialType}</span>
                ` : ''}
                <span class="trial-meta-stat" data-role="stat-acres">
                  <span class="trial-meta-label">Trial acres</span>
                  <span class="trial-meta-value">—</span>
                </span>
                <span class="trial-meta-stat" data-role="stat-check">
                  <span class="trial-meta-label">Check avg</span>
                  <span class="trial-meta-value">—</span> bu/ac
                </span>
                <span class="trial-meta-stat" data-role="stat-trial">
                  <span class="trial-meta-label">Trial avg</span>
                  <span class="trial-meta-value">—</span> bu/ac
                </span>
              </div>
            </div>
          </div>

                  <div class="trial-bottom-row">
          <div>
            ${when ? `Created ${when.toLocaleDateString()} ${when.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}` : ''}
          </div>
          <div class="trial-status-chip">${friendlyStatus}</div>
        </div>
      `;


        listEl.appendChild(card);
      }

      if(countEl){
        if(statusCode === CONFIG.STATUS_ALL){
          countEl.textContent = `${STATE.items.length} trial${STATE.items.length === 1 ? '' : 's'}`;
        }else{
          countEl.textContent = `${STATE.items.length} ${labelLower} trial${STATE.items.length === 1 ? '' : 's'}`;
        }
      }

      // Wire click handlers AFTER we append to DOM (and fix template typo)
      const cards = listEl.querySelectorAll('.trial-card');
      cards.forEach(card => {
        const id = card.dataset.trialId;
        const item = STATE.items.find(x => x.id === id);
        if(!item) return;
        const d = item.data;

        card.addEventListener('click', () => {
          STATE.selectedId = id;
          STATE.isEditingSetup = false;
          renderDetails();
        });

        const addFieldBtn = card.querySelector('.trial-add-fields-btn');
        if(addFieldBtn){
          addFieldBtn.addEventListener('click', (ev)=>{
            ev.stopPropagation();
            const url = `${CONFIG.ADD_FIELD_URL}?trialId=${encodeURIComponent(id)}`;
            window.location.href = url;
          });
        }

        const addYieldBtn = card.querySelector('.trial-add-yield-btn');
        if(addYieldBtn){
          addYieldBtn.addEventListener('click', (ev)=>{
            ev.stopPropagation();
            const url = buildYieldUrl(id, d);
            window.location.href = url;
          });
        }

        const isMhTrial = isMultiHybridTrialData(d);
        if(isMhTrial){
          configureMhButtonsForTrial(card, id, d);
        }

        if(STATE.trialStats[id]){
          applyStatsToCard(card, STATE.trialStats[id]);
        }

        loadTrialStats(id).then(({ stats }) => {
          applyStatsToCard(card, stats);
        }).catch(err => {
          console.error('Error applying stats to card', id, err);
        });
      });

      // Wire mobile swipe after list is rendered
      setupMobileSwipe(listEl);
    }

    function applyFilter(statusCode){
      const raw = statusCode || CONFIG.STATUS_ALL;
      const status = String(raw).toLowerCase();

      STATE.filterStatus = status;

      const sel = $('#trialStatusFilter');
      if(sel && sel.value !== status){
        sel.value = status;
      }

      if(!STATE.loaded){
        STATE.pendingFilter = status;

        const emptyEl = $('.trial-empty');
        const countEl = $('#trialCount');
        const listEl  = $('.trial-list');

        if(listEl) listEl.innerHTML = '';
        if(emptyEl){
          emptyEl.style.display = 'block';
          emptyEl.textContent = 'Loading trials...';
        }
        if(countEl){
          countEl.textContent = 'Loading trials...';
        }
        clearDetails();
        return;
      }

      let filtered;
      if(status === CONFIG.STATUS_ALL){
        filtered = STATE.allItems.slice();
      }else{
        filtered = STATE.allItems.filter(item => {
          const s = (item.data[CONFIG.STATUS_FIELD] || CONFIG.STATUS_PENDING).toString().toLowerCase();
          return s === status;
        });
      }

      STATE.items = filtered;
      clearDetails();
      renderList();
    }

    async function loadAllTrials(){
      const db  = STATE.db;
      if(!db) return;
      if(STATE.isLoading) return;

      STATE.isLoading = true;

      // Reset caches whenever we reload trials
      STATE.mhHasFieldByTrial = {};
      STATE.trialStats = {};
      STATE.trialFields = {};
      STATE.trialStatsPromises = {};

      const emptyEl = $('.trial-empty');
      const countEl = $('#trialCount');
      const listEl  = $('.trial-list');

      const hadExisting = STATE.allItems.length > 0;

      if(!hadExisting){
        if(listEl) listEl.innerHTML = '';
        if(emptyEl){
          emptyEl.style.display = 'block';
          emptyEl.textContent = 'Loading trials...';
        }
        if(countEl){
          countEl.textContent = 'Loading trials...';
        }
        clearDetails();
      }else{
        if(countEl){
          countEl.textContent = 'Refreshing trials...';
        }
      }

      try{
        const ref = collection(db, CONFIG.COLLECTION_TRIALS);
        const snap = await getDocs(ref);

        const items = snap.docs.map(d => ({
          id: d.id,
          data: d.data()
        }));

        // Sort by type A–Z, then trialName A–Z, then newest
        sortTrialsList(items);

        STATE.allItems = items;
        STATE.loaded = true;
        STATE.retryCount = 0;

        const desired = STATE.pendingFilter || STATE.filterStatus || CONFIG.STATUS_ALL;
        STATE.pendingFilter = null;
        applyFilter(desired);
      }catch(err){
        console.error('Error loading trials:', err);

        if(STATE.allItems.length === 0){
          if(emptyEl){
            emptyEl.textContent = 'Error loading trials. Tap to retry.';
            emptyEl.style.display = 'block';
          }
          if(countEl) countEl.textContent = 'Error loading trials';
          clearDetails();
        }else{
          if(countEl){
            countEl.textContent = `${STATE.items.length} trials (using last known list – error loading live data)`;
          }
        }

        if(STATE.retryCount < 1){
          STATE.retryCount++;
          setTimeout(() => {
            STATE.loaded = false;
            STATE.pendingFilter = STATE.filterStatus || CONFIG.STATUS_ALL;
            loadAllTrials();
          }, 1500);
        }
      }finally{
        STATE.isLoading = false;
      }
    }

    async function markTrialCompleted(){
      const id = STATE.selectedId;
      if(!id || !STATE.db) return;
      if(STATE.isEditingSetup) return;

      const btn = $('#trialCompleteBtn');
      if(btn){
        btn.disabled = true;
        btn.textContent = 'Saving...';
      }

      try{
        const ref = doc(STATE.db, CONFIG.COLLECTION_TRIALS, id);
        await updateDoc(ref, {
          [CONFIG.STATUS_FIELD]: CONFIG.STATUS_COMPLETED
        });

        const itemAll = STATE.allItems.find(x => x.id === id);
        if(itemAll){
          itemAll.data[CONFIG.STATUS_FIELD] = CONFIG.STATUS_COMPLETED;
        }
        const itemFiltered = STATE.items.find(x => x.id === id);
        if(itemFiltered){
          itemFiltered.data[CONFIG.STATUS_FIELD] = CONFIG.STATUS_COMPLETED;
        }

        const currentFilter = STATE.filterStatus || CONFIG.STATUS_ALL;
        applyFilter(currentFilter);

        showToast('Trial marked as completed.');
      }catch(err){
        console.error('Error marking trial completed:', err);
        showToast('Error updating trial.');
        if(btn){
          btn.disabled = false;
          btn.textContent = 'Mark Trial Completed';
        }
      }
    }

    async function deleteTrial(){
      const id = STATE.selectedId;
      if(!id || !STATE.db) return;
      if(STATE.isEditingSetup) return;

      const ok = window.confirm('Delete this trial and ALL of its fields and yield blocks? This cannot be undone.');
      if(!ok) return;

      const delBtn = $('#trialDeleteBtn');
      if(delBtn){
        delBtn.disabled = true;
      }

      try{
        const db = STATE.db;

        // 1) Delete nested data under each field:
        //    - yieldBlocks subcollection
        //    - multiHybrid/state doc (if present)
        //    - then the field doc itself
        const fieldsRef = collection(db, CONFIG.COLLECTION_TRIALS, id, 'fields');
        const fieldsSnap = await getDocs(fieldsRef);

        await Promise.all(
          fieldsSnap.docs.map(async (fieldDoc) => {
            const fieldId = fieldDoc.id;

            // Delete nested yieldBlocks under this field
            const blocksRef = collection(
              db,
              CONFIG.COLLECTION_TRIALS,
              id,
              'fields',
              fieldId,
              'yieldBlocks'
            );
            const blocksSnap = await getDocs(blocksRef);
            await Promise.all(blocksSnap.docs.map(b => deleteDoc(b.ref)));

            // Delete multiHybrid/state doc if it exists (ignore errors)
            const mhStateRef = doc(
              db,
              CONFIG.COLLECTION_TRIALS,
              id,
              'fields',
              fieldId,
              'multiHybrid',
              'state'
            );
            try{
              await deleteDoc(mhStateRef);
            }catch(e){
              // ignore – doc may not exist
            }

            // Finally delete the field doc itself
            await deleteDoc(fieldDoc.ref);
          })
        );

        // 2) Legacy top-level yieldBlocks under the trial (if any)
        const yieldsRef = collection(db, CONFIG.COLLECTION_TRIALS, id, 'yieldBlocks');
        const yieldsSnap = await getDocs(yieldsRef);
        await Promise.all(yieldsSnap.docs.map(d => deleteDoc(d.ref)));

        // 3) Delete the trial doc
        const trialRef = doc(db, CONFIG.COLLECTION_TRIALS, id);
        await deleteDoc(trialRef);

        // 4) Update local state
        STATE.allItems = STATE.allItems.filter(x => x.id !== id);
        STATE.items = STATE.items.filter(x => x.id !== id);
        STATE.selectedId = null;

        applyFilter(STATE.filterStatus || CONFIG.STATUS_ALL);
        clearDetails();
        showToast('Trial deleted.');
      }catch(err){
        console.error('Error deleting trial:', err);
        showToast('Error deleting trial.');
        if(delBtn){
          delBtn.disabled = false;
        }
      }
    }

    (async function boot(){
      await ready;
      STATE.db = getFirestore();
      STATE.filterStatus = CONFIG.STATUS_ALL;
      STATE.loaded = false;
      STATE.pendingFilter = null;
      STATE.retryCount = 0;
      STATE.mhHasFieldByTrial = {};
      STATE.trialStats = {};
      STATE.trialFields = {};
      STATE.trialStatsPromises = {};

      const shell = document.querySelector('fv-shell');
      if (shell) shell.nav = NAV_MENU;

      toastEl = document.getElementById('toast');

      const backBtn = document.getElementById('btnBack');
      if(backBtn){
        backBtn.addEventListener('click', () => {
          location.href = '/Farm-vista/pages/crop-production/trials.html';
        });
      }

      const titleTextEl  = document.getElementById('trialDetailTitleText');
      const titleInputEl = document.getElementById('trialDetailTitleInput');
      if(titleTextEl && titleInputEl){
        titleTextEl.addEventListener('click', () => {
          if(!STATE.selectedId) return;
          beginEditTrialTitle();
        });

        titleInputEl.addEventListener('blur', () => {
          if(!STATE.isEditingTitle) return;
          commitEditTrialTitle();
        });

        titleInputEl.addEventListener('keydown', (ev) => {
          if(ev.key === 'Enter'){
            ev.preventDefault();
            titleInputEl.blur();
          }else if(ev.key === 'Escape'){
            ev.preventDefault();
            cancelEditTrialTitle();
          }
        });
      }

      const closeDetailBtn = $('#trialDetailClose');
      if(closeDetailBtn){
        closeDetailBtn.addEventListener('click', () => {
          STATE.selectedId = null;
          clearDetails();
        });
      }

      const completeBtn = $('#trialCompleteBtn');
      if(completeBtn){
        completeBtn.addEventListener('click', () => {
          if(!STATE.selectedId) return;
          markTrialCompleted();
        });
      }

      const deleteBtn = $('#trialDeleteBtn');
      if(deleteBtn){
        deleteBtn.addEventListener('click', () => {
          if(!STATE.selectedId) return;
          deleteTrial();
        });
      }

      const editBtn = $('#trialEditBtn');
      if(editBtn){
        editBtn.addEventListener('click', () => {
          if(!STATE.selectedId) return;
          enterEditSetup();
        });
      }

      const saveBtn = $('#trialSaveBtn');
      if(saveBtn){
        saveBtn.addEventListener('click', () => {
          if(!STATE.selectedId) return;
          saveEditSetup();
        });
      }

      const cancelBtn = $('#trialCancelBtn');
      if(cancelBtn){
        cancelBtn.addEventListener('click', () => {
          if(!STATE.selectedId) return;
          cancelEditSetup();
        });
      }

      fileModal       = $('#fileModal');
      fileBackdrop    = $('#fileBackdrop');
      fileCloseBtn    = $('#fileModalClose');
      fileContentWrap = $('#fileContentWrap');

      if(fileBackdrop){
        fileBackdrop.addEventListener('click', closeFileViewer);
      }
      if(fileCloseBtn){
        fileCloseBtn.addEventListener('click', closeFileViewer);
      }

      const statusSelect = $('#trialStatusFilter');
      if(statusSelect){
        statusSelect.value = CONFIG.STATUS_ALL;
        statusSelect.addEventListener('change', () => {
          const val = (statusSelect.value || CONFIG.STATUS_ALL).toLowerCase();
          applyFilter(val);
        });
      }

      const emptyEl = $('.trial-empty');
      if(emptyEl){
        emptyEl.addEventListener('click', () => {
          if(!STATE.db || STATE.isLoading) return;
          STATE.pendingFilter = STATE.filterStatus || CONFIG.STATUS_ALL;
          loadAllTrials();
        });
      }

      // Always hit Firestore on boot
      await loadAllTrials();
    })();

    // PWA / mobile reload helpers – always re-hit Firestore when you re-enter
    window.addEventListener('focus', () => {
      if(!STATE.db) return;
      STATE.pendingFilter = STATE.filterStatus || CONFIG.STATUS_ALL;
      loadAllTrials();
    });

    window.addEventListener('pageshow', (event) => {
      if(!STATE.db) return;
      if(event.persisted){
        STATE.pendingFilter = STATE.filterStatus || CONFIG.STATUS_ALL;
        loadAllTrials();
      }
    });
  </script>
</head>

<body>
  <fv-shell>
    <div class="wrap">
      <section class="hero">
        <header class="hero-head">
          <div class="icon" aria-hidden="true">🧪</div>
          <div>
            <h1>Add Field and Yield to Trials</h1>
            <p class="muted">
              Review trials, mark them completed, add fields to trials by swiping left and add yield to fields by swiping left. You can also delete a trial if made improperly.
            </p>
          </div>
        </header>

        <div class="body">
          <div class="toolbar">
            <div class="toolbar-left">
              <button id="btnBack" type="button" class="btn btn-quiet">
                ← Back to Trials
              </button>
            </div>
            <div class="toolbar-right">
              <span id="trialCount">Loading trials...</span>
            </div>
          </div>

          <div class="status-filter-wrap">
            <label for="trialStatusFilter" class="status-filter-label">Status</label>
            <select id="trialStatusFilter" class="status-filter-select">
              <option value="all">All</option>
              <option value="pending">Pending</option>
              <option value="active">Active</option>
              <option value="completed">Completed</option>
            </select>
          </div>

          <section aria-label="Field trials">
            <div class="trial-empty">
              Loading trials...
            </div>
            <div class="trial-list"></div>
          </section>
        </div>
      </section>

      <section class="trial-detail-panel" aria-label="Trial details">
        <div class="trial-detail-header">
          <div class="trial-detail-title-area">
            <div class="trial-detail-title" id="trialDetailTitleText">Trial Details</div>
            <input
              type="text"
              id="trialDetailTitleInput"
              class="trial-detail-title-input"
              maxlength="80"
              autocomplete="off"
            />
            <div class="trial-detail-edit-hint">Tap name to edit</div>
          </div>
          <button type="button" id="trialDetailClose" class="trial-detail-close">
            <span class="visually-hidden">Close</span>
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path d="M6.225 4.811 4.81 6.225 10.586 12l-5.775 5.775 1.414 1.414L12 13.414l5.775 5.775 1.414-1.414L13.414 12l5.775-5.775-1.414-1.414L12 10.586 6.225 4.811Z" fill="currentColor"/>
            </svg>
          </button>
        </div>

        <div class="trial-detail-grid"></div>

        <div class="trial-detail-notes">
          <div class="trial-detail-notes-label">Trial Notes</div>
          <div class="trial-detail-notes-body"></div>
        </div>

        <div class="trial-attachments">
          <div class="trial-attachments-label">Files &amp; Photos</div>
          <div class="trial-attachments-grid" id="trialDetailAttachments"></div>
        </div>

        <div class="trial-fields">
          <div class="trial-fields-label">Fields in this trial</div>
          <div class="trial-fields-list" id="trialFieldsList"></div>
        </div>

        <div class="trial-actions">
          <div class="trial-actions-left">
            <button type="button" id="trialEditBtn" class="btn btn-quiet" style="display:none;">
              Edit Setup
            </button>
            <button type="button" id="trialSaveBtn" class="btn btn-complete" style="display:none;">
              Save Changes
            </button>
            <button type="button" id="trialCancelBtn" class="btn btn-quiet" style="display:none;">
              Cancel
            </button>
          </div>
          <div class="trial-actions-right">
            <button type="button" id="trialCompleteBtn" class="btn btn-complete" style="display:none;">
              Mark Trial Completed
            </button>
            <button type="button" id="trialDeleteBtn" class="trial-delete-btn" aria-label="Delete trial">
              <svg viewBox="0 0 24 24" aria-hidden="true">
                <path d="M9 3a1 1 0 0 0-.894.553L7.382 5H5a1 1 0 1 0 0 2h.293l.853 11.093A2 2 0 0 0 8.14 20h7.72a2 2 0 0 0 1.994-1.907L18.707 7H19a1 1 0 1 0 0-2h-2.382l-.724-1.447A1 1 0 0 0 15 3H9Zm1.118 4a1 1 0 0 0-.996 1.09l.5 8a1 1 0 1 0 1.996-.124l-.5-8A1 1 0 0 0 10.118 7Zm3.764 0a1 1 0 0 0-.882 1.09l.5 8a1 1 0 0 0 1.996-.124l-.5-8A1 1 0 0 0 13.882 7Z" fill="currentColor"/>
              </svg>
            </button>
          </div>
        </div>

        <div class="trial-detail-footer"></div>
      </section>
    </div>
  </fv-shell>

  <div id="toast" class="toast" role="status" aria-live="polite">Saved.</div>

  <div id="fileModal" class="file-modal" role="dialog" aria-modal="true" aria-label="Trial attachment">
    <div id="fileBackdrop" class="file-backdrop"></div>
    <div class="file-sheet">
      <div class="file-close-row">
        <button id="fileModalClose" type="button" class="file-close-btn">Close</button>
      </div>
      <div id="fileContentWrap" class="file-content-wrap"></div>
    </div>
  </div>
</body>
</html>
