<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FarmVista ‚Ä¢ Trial Field Yields</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#3B7E46" />

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest" />
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png" />
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png" />
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css" />
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css" />

  <style>
    :root{
      --card-max: 900px;
      --page-bottom-gap: 72px;
      --accent: #2F6C3C;
    }

    html{-webkit-text-size-adjust:100%}
    body{
      background: var(--app-bg,var(--surface));
      overflow-x:hidden;
    }

    .wrap{
      max-width: var(--card-max);
      margin: 0 auto;
      padding: clamp(14px,3vw,22px);
      padding-bottom: calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + var(--page-bottom-gap)) !important;
      box-sizing:border-box;
      display:grid;
      gap:16px;
    }

    .hero{
      border:1px solid var(--border);
      border-radius:18px;
      background:var(--surface);
      box-shadow:var(--shadow,0 12px 28px rgba(0,0,0,.12));
      overflow:visible;
    }

    .hero-head{
      display:flex;
      align-items:flex-start;
      gap:12px;
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);
    }

    .hero-head .icon{
      width:24px;
      height:24px;
      color:var(--accent);
      display:grid;
      place-items:center;
      margin-top:2px;
    }

    .hero-head h1{
      margin:0;
      font-size:clamp(20px,3.2vw,26px);
      line-height:1.2;
    }

    .muted{ color:var(--muted,#67706B); }

    .body{
      padding:16px;
      display:grid;
      gap:14px;
    }

    .top-row{
      display:flex;
      flex-wrap:wrap;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px 16px;
    }

    .trial-summary{
      display:grid;
      gap:4px;
      font-size:0.9rem;
    }

    .trial-summary-title{
      font-weight:800;
      font-size:1rem;
    }

    .trial-summary-line{
      font-size:0.85rem;
      color:var(--muted,#67706B);
    }

    .top-row-actions{
      display:flex;
      align-items:flex-start;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:140px;
      padding:11px 16px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--card-surface,var(--surface));
      font-weight:800;
      font-size:0.95rem;
      text-decoration:none;
      cursor:pointer;
      user-select:none;
      color:var(--text)!important;
      gap:6px;
    }
    .btn-primary{
      border-color:transparent;
      background:#2F6C3C;
      color:#fff!important;
    }
    .btn-quiet{
      min-width:auto;
      padding-inline:10px;
    }
    .btn[disabled]{
      opacity:.6;
      cursor:not-allowed;
    }
    .btn-small{
      padding:6px 10px;
      min-width:auto;
      font-size:0.8rem;
      border-radius:999px;
    }

    .error-box{
      border:1px solid #b3261e;
      background:#fff;
      color:#b3261e;
      border-radius:10px;
      padding:10px 12px;
      display:none;
      font-size:0.85rem;
    }
    .error-box.show{
      display:block;
    }

    .fields-hero{
      border:1px solid var(--border);
      border-radius:18px;
      background:var(--surface);
      box-shadow:var(--shadow,0 10px 22px rgba(0,0,0,.08));
      overflow:hidden;
    }

    .fields-head{
      padding:12px 16px;
      border-bottom:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .fields-head h2{
      margin:0;
      font-size:1rem;
    }
    .fields-body{
      padding:14px 16px 16px;
      display:grid;
      gap:12px;
    }

    .field-list-label{
      font-size:0.78rem;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:var(--muted,#67706B);
      margin-bottom:4px;
    }

    .field-list-empty{
      font-size:0.9rem;
      color:var(--muted,#67706B);
    }

    .field-card{
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--card-surface,var(--surface));
      padding:9px 10px;
      display:grid;
      gap:4px;
      font-size:0.9rem;
      cursor:pointer;
      transition:background 0.12s ease, box-shadow 0.12s ease, transform 0.08s ease;
    }
    .field-card:hover{
      background:rgba(0,0,0,.03);
      box-shadow:0 4px 10px rgba(0,0,0,.08);
      transform:translateY(-1px);
    }

    .field-card-top{
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:flex-start;
    }
    .field-card-title{
      font-weight:700;
    }
    .field-card-sub{
      font-size:0.82rem;
      color:var(--muted,#67706B);
    }
    .field-card-note{
      font-size:0.85rem;
      color:var(--muted,#67706B);
    }

    .fields-hint{
      font-size:0.78rem;
      color:var(--muted,#67706B);
      margin-top:4px;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:calc(env(safe-area-inset-bottom,0px) + 72px);
      transform:translateX(-50%);
      background:#2F6C3C;
      color:#fff;
      padding:10px 14px;
      border-radius:10px;
      box-shadow:0 6px 20px rgba(0,0,0,.25);
      z-index:99999;
      display:none;
      white-space:nowrap;
      max-width:92vw;
      overflow:hidden;
      text-overflow:ellipsis;
      font-size:0.85rem;
    }
    .toast.show{
      display:block;
      animation:fadeout 3.2s forwards;
    }
    @keyframes fadeout{
      0%{opacity:1}
      85%{opacity:1}
      100%{opacity:0}
    }

    /* Simple modal for yield pop-up */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.4);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:9999;
    }
    .modal-backdrop.hidden{
      display:none;
    }
    .modal{
      max-width:480px;
      width:90vw;
      background:var(--surface);
      border-radius:16px;
      box-shadow:0 18px 45px rgba(0,0,0,.28);
      border:1px solid var(--border);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .modal-header{
      padding:12px 16px;
      border-bottom:1px solid var(--border);
    }
    .modal-header h3{
      margin:0;
      font-size:1rem;
    }
    .modal-body{
      padding:14px 16px;
      font-size:0.9rem;
      display:grid;
      gap:6px;
    }
    .modal-footer{
      padding:10px 16px 12px;
      border-top:1px solid var(--border);
      display:flex;
      justify-content:flex-end;
    }
  </style>

  <!-- Lazy-load fv-shell if needed -->
  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true;
        document.head.appendChild(s);
      }
    })();
  </script>

  <script type="module">
    import {
      ready,
      getFirestore, getAuth,
      collection, getDocs, getDoc, doc
    } from '/Farm-vista/js/firebase-init.js';

    import { NAV_MENU } from '/Farm-vista/js/menu.js';

    const CONFIG = {
      COLLECTION_TRIALS: 'fieldTrials',
      RETURN_URL: '/Farm-vista/pages/crop-production/trials/trials-edit.html'
    };

    const STATE = {
      db: null,
      user: null,
      trialId: null,
      fieldDocId: null,
      trial: null,
      fields: [],
      selectedField: null
    };

    const $  = (sel, root=document) => root.querySelector(sel);

    let toastEl, errBox;
    let trialNameMain, trialCropMain, trialTypeLine, trialTreatmentLine, fieldCountLine;
    let fieldListEl;
    let modalBackdrop, modalTitleEl, modalBodyEl;

    function getQueryParam(name){
      const params = new URLSearchParams(window.location.search);
      return params.get(name) || null;
    }

    function showToast(msg="Saved.", ms=3200){
      if(!toastEl) return;
      toastEl.textContent = msg;
      toastEl.classList.remove('show');
      void toastEl.offsetWidth;
      toastEl.classList.add('show');
      setTimeout(()=>toastEl.classList.remove('show'), ms);
    }

    function showError(msg){
      if(!errBox) return;
      if(msg){
        errBox.textContent = msg;
        errBox.classList.add('show');
      }else{
        errBox.textContent = '';
        errBox.classList.remove('show');
      }
    }

    async function waitForAuthReady() {
      const auth = getAuth();
      let tries = 40;
      return await new Promise(resolve => {
        const int = setInterval(() => {
          if (auth.currentUser) {
            clearInterval(int);
            resolve(auth.currentUser);
          }
          if (--tries <= 0) {
            clearInterval(int);
            resolve(null);
          }
        }, 100);
      });
    }

    async function loadTrial(){
      if(!STATE.trialId) return;
      try{
        const ref = doc(STATE.db, CONFIG.COLLECTION_TRIALS, STATE.trialId);
        const snap = await getDoc(ref);
        if(!snap.exists()){
          showError("This trial could not be found. It may have been deleted.");
          return;
        }
        const t = snap.data() || {};
        STATE.trial = t;

        if(trialNameMain) trialNameMain.textContent = t.trialName || "Field Trial";
        if(trialCropMain){
          const bits=[];
          if(t.cropYear!=null) bits.push(t.cropYear);
          if(t.crop) bits.push(t.crop);
          trialCropMain.textContent = bits.join(" ‚Ä¢ ") || "‚Äî";
        }
        if(trialTypeLine){
          const parts=[];
          if(t.trialType) parts.push(`Type: ${t.trialType}`);
          if(t.operationTask) parts.push(`Operation: ${t.operationTask}`);
          trialTypeLine.textContent = parts.join("  |  ") || "";
        }
        if(trialTreatmentLine){
          const parts=[];
          if(t.treatmentProduct) parts.push(`Treatment: ${t.treatmentProduct}`);
          if(t.check) parts.push(`Check: ${t.check}`);
          trialTreatmentLine.textContent = parts.join("  |  ") || "";
        }
      }catch(err){
        console.error("Error loading trial:", err);
        showError("Unable to load trial details.");
      }
    }

    async function loadFields(){
      if(!STATE.trialId) return;
      try{
        const path = `${CONFIG.COLLECTION_TRIALS}/${STATE.trialId}/fields`;
        const snap = await getDocs(collection(STATE.db, path));
        const rows = [];
        snap.forEach(d => {
          const data = d.data() || {};
          rows.push({
            docId: d.id,
            farmName: data.farmName || 'Unknown farm',
            fieldName: data.fieldName || 'Unknown field',
            tillable: data.tillable != null ? Number(data.tillable) : null,
            trialAcres: data.trialAcres != null ? Number(data.trialAcres) : null,
            notes: data.notes || ''
          });
        });
        STATE.fields = rows;
        renderFieldList();
      }catch(err){
        console.error("Error loading trial fields:", err);
        showError("Unable to load fields for this trial.");
      }
    }

    function renderFieldList(){
      if(!fieldListEl) return;
      fieldListEl.innerHTML = '';

      if(fieldCountLine){
        const c = STATE.fields.length;
        fieldCountLine.textContent = c ? `${c} field${c===1?'':'s'} in this trial` : "No fields linked yet";
      }

      if(!STATE.fields.length){
        fieldListEl.innerHTML =
          `<div class="field-list-empty">No fields are attached to this trial yet. Use the Add Field screen first, then come back here to enter yields.</div>`;
        return;
      }

      const label = document.createElement('div');
      label.className = 'field-list-label';
      label.textContent = 'Fields in this trial';
      fieldListEl.appendChild(label);

      STATE.fields.forEach((row, idx) => {
        const div = document.createElement('div');
        div.className = 'field-card';
        div.dataset.idx = String(idx);

        const acresText = row.trialAcres != null ? `${row.trialAcres.toFixed(2)} ac` : '‚Äî';

        div.innerHTML = `
          <div class="field-card-top">
            <div>
              <div class="field-card-title">${row.farmName} ‚Ä¢ ${row.fieldName}</div>
              <div class="field-card-sub">
                Trial acres: <strong>${acresText}</strong>
                ${row.tillable != null ? ` (Max tillable: ${row.tillable})` : ''}
              </div>
            </div>
            <div>
              <span class="btn btn-small">View / Add Yield</span>
            </div>
          </div>
          ${row.notes ? `<div class="field-card-note">${row.notes}</div>` : ''}
        `;

        div.addEventListener('click', () => openYieldModal(row));
        fieldListEl.appendChild(div);
      });
    }

    function openYieldModal(row){
      if(!modalBackdrop || !modalTitleEl || !modalBodyEl) return;
      STATE.selectedField = row || null;

      const trialName = STATE.trial?.trialName || 'Field Trial';
      modalTitleEl.textContent = row
        ? `${row.fieldName} ‚Ä¢ Yield Entry`
        : 'Yield Entry';

      const parts = [];
      parts.push(`<strong>Trial:</strong> ${trialName}`);
      parts.push(`<strong>Field:</strong> ${row.farmName} ‚Ä¢ ${row.fieldName}`);
      if(row.trialAcres != null){
        parts.push(`<strong>Trial acres:</strong> ${row.trialAcres.toFixed(2)} ac`);
      }
      if(row.tillable != null){
        parts.push(`<strong>Field tillable:</strong> ${row.tillable} ac`);
      }

      modalBodyEl.innerHTML = `
        <p>${parts.join('<br>')}</p>
        <p class="muted">
          This is the first pass. In the next step, this pop-up will collect yield numbers and
          upload photos / files for this field's yield checks.
        </p>
        <p class="muted">
          For now, tap <strong>OK</strong> to close and move between fields.
        </p>
      `;

      modalBackdrop.classList.remove('hidden');
    }

    function closeYieldModal(){
      if(!modalBackdrop) return;
      modalBackdrop.classList.add('hidden');
      STATE.selectedField = null;
    }

    (async function boot(){
      await ready;

      toastEl       = $('#toast');
      errBox        = $('#errBox');
      trialNameMain = $('#trialNameMain');
      trialCropMain = $('#trialCropMain');
      trialTypeLine = $('#trialTypeLine');
      trialTreatmentLine = $('#trialTreatmentLine');
      fieldCountLine = $('#trialFieldCount');
      fieldListEl   = $('#trialFieldList');

      modalBackdrop = $('#yieldModalBackdrop');
      modalTitleEl  = $('#yieldModalTitle');
      modalBodyEl   = $('#yieldModalBody');

      const btnBack = $('#btnBack');
      const btnModalOk = $('#btnYieldOk');

      if(btnBack){
        btnBack.addEventListener('click', () => {
          window.location.href = CONFIG.RETURN_URL;
        });
      }
      if(btnModalOk){
        btnModalOk.addEventListener('click', closeYieldModal);
      }
      if(modalBackdrop){
        modalBackdrop.addEventListener('click', (e)=>{
          if(e.target === modalBackdrop){
            closeYieldModal();
          }
        });
      }
      document.addEventListener('keydown', (e)=>{
        if(e.key === 'Escape'){
          closeYieldModal();
        }
      });

      const shell = document.querySelector('fv-shell');
      if(shell && NAV_MENU){
        shell.nav = NAV_MENU;
      }

      STATE.trialId   = getQueryParam('trialId');
      STATE.fieldDocId = getQueryParam('fieldDocId');

      if(!STATE.trialId){
        showError("Missing trialId in URL. Open this page from the Trials screen.");
        return;
      }

      const auth = getAuth();
      STATE.user = await waitForAuthReady();
      if(!STATE.user){
        showError("User is not signed in. Please log in again.");
        return;
      }

      STATE.db = getFirestore();

      await loadTrial();
      await loadFields();

      // If we arrived from the Add Field page with a specific fieldDocId,
      // auto-open that field's modal.
      if(STATE.fieldDocId && STATE.fields.length){
        const row = STATE.fields.find(f => f.docId === STATE.fieldDocId);
        if(row){
          openYieldModal(row);
        }
      }
    })();
  </script>
</head>

<body>
  <fv-shell>
    <div class="wrap">
      <section class="hero">
        <header class="hero-head">
          <div class="icon" aria-hidden="true">üß™</div>
          <div>
            <h1>Trial Field Yields</h1>
            <p class="muted">
              Review the fields in this trial and tap one to open a yield pop-up. This first version only
              shows the layout; yield entry and uploads will be wired next.
            </p>
          </div>
        </header>

        <div class="body">
          <div id="errBox" class="error-box"></div>

          <div class="top-row">
            <div class="trial-summary">
              <div class="trial-summary-title" id="trialNameMain">Loading trial‚Ä¶</div>
              <div class="trial-summary-line">
                <strong>Crop:</strong> <span id="trialCropMain">‚Äî</span>
              </div>
              <div class="trial-summary-line" id="trialTypeLine"></div>
              <div class="trial-summary-line" id="trialTreatmentLine"></div>
              <div class="trial-summary-line" id="trialFieldCount"></div>
            </div>
            <div class="top-row-actions">
              <button id="btnBack" type="button" class="btn btn-quiet">
                ‚Üê Back to Trials
              </button>
            </div>
          </div>
        </div>
      </section>

      <section class="fields-hero">
        <header class="fields-head">
          <h2>Fields in this trial</h2>
        </header>
        <div class="fields-body">
          <div id="trialFieldList"></div>
          <div class="fields-hint">
            Tap a field card to open the yield pop-up. Later, this will collect yield numbers and upload photos / files
            for each yield collection.
          </div>
        </div>
      </section>
    </div>
  </fv-shell>

  <!-- Simple yield modal (OK-only for first run) -->
  <div id="yieldModalBackdrop" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-labelledby="yieldModalTitle">
    <div class="modal">
      <div class="modal-header">
        <h3 id="yieldModalTitle">Yield Entry</h3>
      </div>
      <div id="yieldModalBody" class="modal-body">
        <!-- Filled by JS -->
      </div>
      <div class="modal-footer">
        <button id="btnYieldOk" type="button" class="btn btn-primary">OK</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite">Saved.</div>
</body>
</html>
