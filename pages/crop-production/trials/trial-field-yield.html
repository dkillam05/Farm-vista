<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FarmVista ‚Ä¢ Trial Field Yields</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#3B7E46" />

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest" />
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png" />
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png" />
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css" />
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css" />

  <style>
    :root{
      --card-max: 900px;
      --page-bottom-gap: 72px;
      --accent: #2F6C3C;
    }

    html{-webkit-text-size-adjust:100%}
    body{
      background: var(--app-bg,var(--surface));
      overflow-x:hidden;
    }

    .wrap{
      max-width: var(--card-max);
      margin: 0 auto;
      padding: clamp(14px,3vw,22px);
      padding-bottom: calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + var(--page-bottom-gap)) !important;
      box-sizing:border-box;
      display:grid;
      gap:16px;
    }

    .hero{
      border:1px solid var(--border);
      border-radius:18px;
      background:var(--surface);
      box-shadow:var(--shadow,0 12px 28px rgba(0,0,0,.12));
      overflow:visible;
    }

    .hero-head{
      display:flex;
      align-items:flex-start;
      gap:12px;
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);
    }

    .hero-head .icon{
      width:24px;
      height:24px;
      color:var(--accent);
      display:grid;
      place-items:center;
      margin-top:2px;
    }

    .hero-head h1{
      margin:0;
      font-size:clamp(20px,3.2vw,26px);
      line-height:1.2;
    }

    .muted{ color:var(--muted,#67706B); }

    .body{
      padding:16px;
      display:grid;
      gap:14px;
    }

    .top-row{
      display:flex;
      flex-wrap:wrap;
      align-items:flex-start;
      justify-content:flex-start;
      gap:10px 16px;
    }

    .trial-summary{
      display:grid;
      gap:4px;
      font-size:0.9rem;
    }

    .trial-summary-title{
      font-weight:800;
      font-size:1rem;
    }

    .trial-summary-line{
      font-size:0.85rem;
      color:var(--muted,#67706B);
    }

    .top-row-actions-left{
      display:flex;
      justify-content:flex-start;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:140px;
      padding:11px 16px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--card-surface,var(--surface));
      font-weight:800;
      font-size:0.95rem;
      text-decoration:none;
      cursor:pointer;
      user-select:none;
      color:var(--text)!important;
      gap:6px;
    }
    .btn-primary{
      border-color:transparent;
      background:#2F6C3C;
      color:#fff!important;
    }
    .btn-quiet{
      min-width:auto;
      padding-inline:10px;
    }
    .btn[disabled]{
      opacity:.6;
      cursor:not-allowed;
    }
    .btn-small{
      padding:6px 10px;
      min-width:auto;
      font-size:0.8rem;
      border-radius:999px;
    }

    .error-box{
      border:1px solid #b3261e;
      background:#fff;
      color:#b3261e;
      border-radius:10px;
      padding:10px 12px;
      display:none;
      font-size:0.85rem;
    }
    .error-box.show{
      display:block;
    }

    .fields-hero{
      border:1px solid var(--border);
      border-radius:18px;
      background:var(--surface);
      box-shadow:var(--shadow,0 10px 22px rgba(0,0,0,.08));
      overflow:hidden;
    }

    .fields-head{
      padding:12px 16px;
      border-bottom:1px solid var(--border);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .fields-head h2{
      margin:0;
      font-size:1rem;
    }
    .fields-body{
      padding:14px 16px 16px;
      display:grid;
      gap:12px;
    }

    .field-list-label{
      font-size:0.78rem;
      text-transform:uppercase;
      letter-spacing:0.08em;
      color:var(--muted,#67706B);
      margin-bottom:4px;
    }

    .field-list-empty{
      font-size:0.9rem;
      color:var(--muted,#67706B);
    }

    .field-card{
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--card-surface,var(--surface));
      padding:9px 10px;
      display:grid;
      gap:4px;
      font-size:0.9rem;
      cursor:pointer;
      transition:background 0.12s ease, box-shadow 0.12s ease, transform 0.08s ease;
    }
    .field-card:hover{
      background:rgba(0,0,0,.03);
      box-shadow:0 4px 10px rgba(0,0,0,.08);
      transform:translateY(-1px);
    }

    .field-card-top{
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:flex-start;
    }
    .field-card-title{
      font-weight:700;
    }
    .field-card-sub{
      font-size:0.82rem;
      color:var(--muted,#67706B);
    }
    .field-card-note{
      font-size:0.83rem;
      color:var(--muted,#67706B);
    }

    .fields-hint{
      font-size:0.78rem;
      color:var(--muted,#67706B);
      margin-top:4px;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:calc(env(safe-area-inset-bottom,0px) + 72px);
      transform:translateX(-50%);
      background:#2F6C3C;
      color:#fff;
      padding:10px 14px;
      border-radius:10px;
      box-shadow:0 6px 20px rgba(0,0,0,.25);
      z-index:99999;
      display:none;
      white-space:nowrap;
      max-width:92vw;
      overflow:hidden;
      text-overflow:ellipsis;
      font-size:0.85rem;
    }
    .toast.show{
      display:block;
      animation:fadeout 3.2s forwards;
    }
    @keyframes fadeout{
      0%{opacity:1}
      85%{opacity:1}
      100%{opacity:0}
    }

    /* Modal */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.4);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:9999;
    }
    .modal-backdrop.hidden{
      display:none;
    }
    .modal{
      max-width:720px;          /* a bit wider */
      width:96vw;
      background:var(--surface);
      border-radius:16px;
      box-shadow:0 18px 45px rgba(0,0,0,.28);
      border:1px solid var(--border);
      display:flex;
      flex-direction:column;
      overflow:hidden;
    }
    .modal-header{
      padding:12px 16px;
      border-bottom:1px solid var(--border);
    }
    .modal-header h3{
      margin:0;
      font-size:1rem;
    }
    .modal-body{
      padding:14px 16px 10px;
      font-size:0.9rem;
      display:grid;
      gap:10px;
      max-height:78vh;          /* taller */
      overflow-y:auto;
    }
    .modal-footer{
      padding:10px 16px 12px;
      border-top:1px solid var(--border);
      display:flex;
      justify-content:flex-end;
      gap:10px;
    }

    .yield-summary{
      display:grid;
      gap:4px;
    }

    .yield-summary .muted{
      font-size:0.82rem;
    }

    .btn-inline{
      min-width:auto;
      font-size:0.85rem;
      padding:7px 12px;
      border-radius:999px;
    }

    .block-type-dialog{
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--card-surface,var(--surface));
      padding:10px 12px;
      display:grid;
      gap:6px;
      font-size:0.88rem;
    }
    .block-type-dialog.hidden{
      display:none;
    }
    .block-type-dialog label{
      display:flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
    }
    .block-type-dialog input[type="radio"]{
      accent-color:var(--accent);
    }
    .block-type-actions{
      margin-top:4px;
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }

    .yield-block-card{
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--card-surface,var(--surface));
      padding:10px 12px;
      display:grid;
      gap:10px;
      font-size:0.88rem;
    }
    .yield-block-head{
      display:flex;
      justify-content:space-between;
      gap:8px;
      align-items:flex-start;
    }
    .yield-block-title{
      font-weight:700;
    }
    .yield-block-sub{
      font-size:0.8rem;
      color:var(--muted,#67706B);
    }
    .yield-block-remove{
      border:none;
      background:transparent;
      color:var(--muted,#67706B);
      font-size:0;
      line-height:1;
      cursor:pointer;
      padding:4px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .yield-block-remove svg{
      width:18px;
      height:18px;
      display:block;
    }

    .yield-block-grid{
      display:grid;
      grid-template-columns:repeat(3, minmax(0,1fr));
      gap:8px;
      align-items:flex-end;
    }
    @media (max-width:640px){
      .yield-block-grid{
        grid-template-columns:1fr;
      }
    }

    .yield-block-two-col{
      display:grid;
      grid-template-columns:repeat(2, minmax(0,1fr));
      gap:10px;
      align-items:stretch;
    }
    @media (max-width:640px){
      .yield-block-two-col{
        grid-template-columns:1fr;
      }
    }

    .yield-subcard{
      border-radius:10px;
      border:1px dashed var(--border);
      padding:8px 10px;
      display:grid;
      gap:6px;
    }
    .yield-subcard-title{
      font-size:0.8rem;
      font-weight:700;
      text-transform:uppercase;
      letter-spacing:0.06em;
      color:var(--muted,#67706B);
    }

    .field-mini{
      display:flex;
      flex-direction:column;
      gap:3px;
    }
    .field-mini span{
      font-size:0.8rem;
      font-weight:600;
    }
    .input{
      width:100%;
      font:inherit;
      font-size:0.9rem;
      color:var(--text);
      background:var(--card-surface,var(--surface));
      border:1px solid var(--border);
      border-radius:9px;
      padding:8px 10px;
      outline:none;
    }
    .input:focus{
      box-shadow:0 0 0 1px rgba(47,108,60,.28);
      border-color:var(--accent);
    }
    .input-error{
      border-color:#b3261e !important;
      box-shadow:0 0 0 1px rgba(179,38,30,.3);
      background:rgba(179,38,30,.03);
    }

    .yield-block-footer{
      display:flex;
      flex-wrap:wrap;
      justify-content:space-between;
      gap:6px;
      font-size:0.8rem;
      align-items:center;
    }
    .yield-block-yield{
      font-weight:600;
    }
    .yield-block-error{
      color:#b3261e;
    }

    .yield-empty{
      font-size:0.82rem;
      color:var(--muted,#67706B);
    }
  </style>

  <!-- Lazy-load fv-shell if needed -->
  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true;
        document.head.appendChild(s);
      }
    })();
  </script>

  <script type="module">
    import {
      ready,
      getFirestore, getAuth,
      collection, getDocs, getDoc, doc,
      addDoc, deleteDoc
    } from '/Farm-vista/js/firebase-init.js';

    import { NAV_MENU } from '/Farm-vista/js/menu.js';
    import {
      calcTrueYield,
      normalizeCropKind
    } from '/Farm-vista/js/fv-yield-math.js';

    const CONFIG = {
      COLLECTION_TRIALS: 'fieldTrials',
      RETURN_URL: '/Farm-vista/pages/crop-production/trials/trials-edit.html'
    };

    const STATE = {
      db: null,
      user: null,
      trialId: null,
      fieldDocId: null,
      trial: null,
      fields: [],
      selectedField: null,
      // yieldData: { [fieldDocId]: [ { id, type, check:{...}, trial:{...} } ] }
      yieldData: {}
    };

    const $  = (sel, root=document) => root.querySelector(sel);

    let toastEl, errBox;
    let trialNameMain, trialCropMain, trialTypeLine, trialTreatmentLine, fieldCountLine;
    let fieldListEl;
    let modalBackdrop, modalTitleEl, modalBodyEl;
    let yieldSummaryEl, yieldBlocksWrap, addBlockBtn;
    let blockTypeDialog, blockTypeConfirmBtn, blockTypeCancelBtn;

    function getQueryParam(name){
      const params = new URLSearchParams(window.location.search);
      return params.get(name) || null;
    }

    function showToast(msg="Saved.", ms=3200){
      if(!toastEl) return;
      toastEl.textContent = msg;
      toastEl.classList.remove('show');
      void toastEl.offsetWidth;
      toastEl.classList.add('show');
      setTimeout(()=>toastEl.classList.remove('show'), ms);
    }

    function showError(msg){
      if(!errBox) return;
      if(msg){
        errBox.textContent = msg;
        errBox.classList.add('show');
      }else{
        errBox.textContent = '';
        errBox.classList.remove('show');
      }
    }

    async function waitForAuthReady() {
      const auth = getAuth();
      let tries = 40;
      return await new Promise(resolve => {
        const int = setInterval(() => {
          if (auth.currentUser) {
            clearInterval(int);
            resolve(auth.currentUser);
          }
          if (--tries <= 0) {
            clearInterval(int);
            resolve(null);
          }
        }, 100);
      });
    }

    async function loadTrial(){
      if(!STATE.trialId) return;
      try{
        const ref = doc(STATE.db, CONFIG.COLLECTION_TRIALS, STATE.trialId);
        const snap = await getDoc(ref);
        if(!snap.exists()){
          showError("This trial could not be found. It may have been deleted.");
          return;
        }
        const t = snap.data() || {};
        STATE.trial = t;

        if(trialNameMain) trialNameMain.textContent = t.trialName || "Field Trial";
        if(trialCropMain){
          const bits=[];
          if(t.cropYear!=null) bits.push(t.cropYear);
          if(t.crop) bits.push(t.crop);
          trialCropMain.textContent = bits.join(" ‚Ä¢ ") || "‚Äî";
        }
        if(trialTypeLine){
          const parts=[];
          if(t.trialType) parts.push(`Type: ${t.trialType}`);
          if(t.operationTask) parts.push(`Operation: ${t.operationTask}`);
          trialTypeLine.textContent = parts.join("  |  ") || "";
        }
        if(trialTreatmentLine){
          const parts=[];
          if(t.treatmentProduct) parts.push(`Treatment: ${t.treatmentProduct}`);
          if(t.check) parts.push(`Check: ${t.check}`);
          trialTreatmentLine.textContent = parts.join("  |  ") || "";
        }
      }catch(err){
        console.error("Error loading trial:", err);
        showError("Unable to load trial details.");
      }
    }

    async function loadFields(){
      if(!STATE.trialId) return;
      try{
        const path = `${CONFIG.COLLECTION_TRIALS}/${STATE.trialId}/fields`;
        const snap = await getDocs(collection(STATE.db, path));
        const rows = [];
        snap.forEach(d => {
          const data = d.data() || {};
          rows.push({
            docId: d.id,
            farmName: data.farmName || 'Unknown farm',
            fieldName: data.fieldName || 'Unknown field',
            tillable: data.tillable != null ? Number(data.tillable) : null,
            trialAcres: data.trialAcres != null ? Number(data.trialAcres) : null,
            notes: data.notes || ''
          });
        });
        STATE.fields = rows;
        renderFieldList();
      }catch(err){
        console.error("Error loading trial fields:", err);
        showError("Unable to load fields for this trial.");
      }
    }

    async function loadAllYieldBlocks(){
      if(!STATE.trialId || !STATE.fields.length) return;
      try{
        for(const row of STATE.fields){
          const path = `${CONFIG.COLLECTION_TRIALS}/${STATE.trialId}/fields/${row.docId}/yieldBlocks`;
          const snap = await getDocs(collection(STATE.db, path));
          if(snap.empty) continue;
          const blocks = [];
          snap.forEach(ds => {
            const d = ds.data() || {};
            const check = d.check || {};
            const trial = d.trial || {};
            blocks.push({
              id: ds.id,
              type: d.blockType || 'combine',
              check: {
                acres: check.acres != null ? String(check.acres) : '',
                moisture: check.moisture != null ? String(check.moisture) : '',
                poundsRaw: check.pounds != null ? String(check.pounds) : '',
                yieldBuAc: check.yieldBuAc != null ? Number(check.yieldBuAc) : null
              },
              trial: {
                acres: trial.acres != null ? String(trial.acres) : '',
                moisture: trial.moisture != null ? String(trial.moisture) : '',
                poundsRaw: trial.pounds != null ? String(trial.pounds) : '',
                yieldBuAc: trial.yieldBuAc != null ? Number(trial.yieldBuAc) : null
              }
            });
          });
          if(blocks.length){
            STATE.yieldData[row.docId] = blocks;
          }
        }
      }catch(err){
        console.error("Error loading yield blocks:", err);
      }
    }

    function formatPounds(digits){
      if(!digits) return '';
      return digits.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    function recalcCombine(block, card){
      const cropKind = normalizeCropKind(STATE.trial?.crop);
      // Trials page standard: corn 15%, beans 13%
      const stdOverride =
        cropKind === 'corn' ? 15 :
        cropKind === 'soy'  ? 13 :
        undefined;

      const yields = { check: null, trial: null };
      const errors = [];

      ['check','trial'].forEach(side => {
        const data = block[side] || {};
        const label = side === 'check' ? 'Check' : 'Trial';

        let acresInput = null;
        let moistInput = null;
        let poundsInput = null;

        if(card){
          acresInput  = card.querySelector(`[data-role="${side}-acres"]`);
          moistInput  = card.querySelector(`[data-role="${side}-moisture"]`);
          poundsInput = card.querySelector(`[data-role="${side}-pounds"]`);
          [acresInput, moistInput, poundsInput].forEach(el=>{
            if(el) el.classList.remove('input-error');
          });
        }

        const acres    = data.acres !== '' && data.acres != null ? Number(data.acres) : NaN;
        const moisture = data.moisture !== '' && data.moisture != null ? Number(data.moisture) : NaN;
        const pounds   = data.poundsRaw ? Number(data.poundsRaw) : NaN;

        data.yieldBuAc = null;

        if(!acres && !moisture && !pounds){
          return; // side empty
        }

        if(!acres || !moisture || !pounds){
          errors.push(`${label}: enter acres, moisture, and pounds.`);
          return;
        }

        if(acres <= 0){
          errors.push(`${label}: acres must be greater than 0.`);
          if(acresInput) acresInput.classList.add('input-error');
        }
        if(moisture < 5 || moisture > 40){
          errors.push(`${label}: moisture must be between 5% and 40%.`);
          if(moistInput) moistInput.classList.add('input-error');
        }
        if(pounds <= 0){
          errors.push(`${label}: pounds of grain must be greater than 0.`);
          if(poundsInput) poundsInput.classList.add('input-error');
        }

        if(errors.length) return;

        const res = calcTrueYield({
          cropKind,
          wetWeightLbs: pounds,
          wetMoisturePct: moisture,
          acres,
          stdMoistOverride: stdOverride
        });

        if(!res){
          errors.push(`${label}: unable to compute yield.`);
          return;
        }

        const yld = res.yieldBuAc;
        data.yieldBuAc = yld;
        yields[side] = yld;

        if(cropKind === 'corn' && (yld < 50 || yld > 400)){
          errors.push(`${label}: yield seems out of range for corn (50‚Äì400 bu/ac).`);
        }else if(cropKind === 'soy' && (yld < 20 || yld > 150)){
          errors.push(`${label}: yield seems out of range for soybeans (20‚Äì150 bu/ac).`);
        }
      });

      if(card){
        const yieldTextEl = card.querySelector('[data-role="yieldText"]');
        const errorTextEl = card.querySelector('[data-role="errorText"]');

        if(yieldTextEl){
          let txt = '';
          if(yields.check == null && yields.trial == null){
            txt = 'Enter acres, moisture, and pounds for Check and/or Trial.';
          }else{
            const parts = [];
            if(yields.check != null) parts.push(`Check: ${yields.check.toFixed(1)} bu/ac`);
            if(yields.trial != null) parts.push(`Trial: ${yields.trial.toFixed(1)} bu/ac`);
            if(yields.check != null && yields.trial != null){
              const diff = yields.trial - yields.check;
              const sign = diff >= 0 ? '+' : '‚àí';
              parts.push(`Diff: ${sign}${Math.abs(diff).toFixed(1)} bu/ac`);
            }
            txt = parts.join('  |  ');
          }
          yieldTextEl.textContent = txt;
        }
        if(errorTextEl){
          errorTextEl.textContent = errors.join(' ');
        }
      }

      return { yields, errors };
    }

    function getFieldYieldSummary(fieldDocId){
      const blocks = STATE.yieldData[fieldDocId] || [];
      if(!blocks.length) return '';

      const lines = [];
      blocks.forEach((block, idx)=>{
        const c = block.check?.yieldBuAc;
        const t = block.trial?.yieldBuAc;
        if(c == null && t == null) return;

        const parts = [];
        if(c != null) parts.push(`Check ${c.toFixed(1)} bu/ac`);
        if(t != null) parts.push(`Trial ${t.toFixed(1)} bu/ac`);
        if(c != null && t != null){
          const diff = t - c;
          const sign = diff >= 0 ? '+' : '‚àí';
          parts.push(`Diff ${sign}${Math.abs(diff).toFixed(1)} bu/ac`);
        }
        lines.push(`Block ${idx+1}: ${parts.join(' ‚Ä¢ ')}`);
      });

      return lines.join('<br>');
    }

    function renderFieldList(){
      if(!fieldListEl) return;
      fieldListEl.innerHTML = '';

      if(fieldCountLine){
        const c = STATE.fields.length;
        fieldCountLine.textContent = c ? `${c} field${c===1?'':'s'} in this trial` : "No fields in this trial yet";
      }

      if(!STATE.fields.length){
        fieldListEl.innerHTML =
          `<div class="field-list-empty">No fields are attached to this trial yet. Use the Add Field screen first, then come back here to enter yields.</div>`;
        return;
      }

      const label = document.createElement('div');
      label.className = 'field-list-label';
      label.textContent = 'Fields in this trial';
      fieldListEl.appendChild(label);

      // Sort A‚ÄìZ by Farm + Field
      const sorted = [...STATE.fields].sort((a,b)=>{
        const A = ((a.farmName || '') + ' ' + (a.fieldName || '')).toLowerCase();
        const B = ((b.farmName || '') + ' ' + (b.fieldName || '')).toLowerCase();
        if(A < B) return -1;
        if(A > B) return 1;
        return 0;
      });

      sorted.forEach((row) => {
        const blocks = STATE.yieldData[row.docId] || [];
        const blockCount = blocks.length;

        const div = document.createElement('div');
        div.className = 'field-card';

        const acresText = row.trialAcres != null ? `${row.trialAcres.toFixed(2)} ac` : '‚Äî';
        const summaryHtml = getFieldYieldSummary(row.docId);

        div.innerHTML = `
          <div class="field-card-top">
            <div>
              <div class="field-card-title">${row.farmName} ‚Ä¢ ${row.fieldName}</div>
              <div class="field-card-sub">
                Trial acres: <strong>${acresText}</strong>
                ${row.tillable != null ? ` (Max tillable: ${row.tillable})` : ''}
              </div>
              ${blockCount
                ? `<div class="field-card-sub">${blockCount} trial block${blockCount===1?'':'s'} added</div>`
                : ''
              }
              ${summaryHtml
                ? `<div class="field-card-note">${summaryHtml}</div>`
                : ''
              }
            </div>
            <div>
              <span class="btn btn-small">View / Add Yield</span>
            </div>
          </div>
          ${row.notes ? `<div class="field-card-note">${row.notes}</div>` : ''}
        `;

        div.addEventListener('click', () => openYieldModal(row));
        fieldListEl.appendChild(div);
      });
    }

    function renderBlocksForField(fieldRow){
      if(!yieldBlocksWrap) return;
      const key = fieldRow.docId;
      const blocks = STATE.yieldData[key] || [];

      yieldBlocksWrap.innerHTML = '';

      if(!blocks.length){
        const p = document.createElement('p');
        p.className = 'yield-empty';
        p.textContent = 'No trial blocks added yet. Use ‚ÄúAdd Trial Block‚Äù to start capturing yield data for this field.';
        yieldBlocksWrap.appendChild(p);
        return;
      }

      blocks.forEach((block, idx)=>{
        const card = document.createElement('div');
        card.className = 'yield-block-card';

        if(block.type === 'combine'){
          block.check = block.check || { acres:'', moisture:'', poundsRaw:'', yieldBuAc:null };
          block.trial = block.trial || { acres:'', moisture:'', poundsRaw:'', yieldBuAc:null };

          const check = block.check;
          const trial = block.trial;

          card.innerHTML = `
            <div class="yield-block-head">
              <div>
                <div class="yield-block-title">Block ${idx+1} ‚Äì Combine Yield Data</div>
                <div class="yield-block-sub">
                  Each block tracks both Check and Trial passes for this field.
                </div>
              </div>
              <button type="button" class="yield-block-remove" aria-label="Remove block">
                <svg viewBox="0 0 16 16" aria-hidden="true">
                  <path d="M4.22 4.22a.75.75 0 0 1 1.06 0L8 6.94l2.72-2.72a.75.75 0 1 1 1.06 1.06L9.06 8l2.72 2.72a.75.75 0 0 1-1.06 1.06L8 9.06l-2.72 2.72a.75.75 0 0 1-1.06-1.06L6.94 8 4.22 5.28a.75.75 0 0 1 0-1.06z"></path>
                </svg>
              </button>
            </div>
            <div class="yield-block-two-col">
              <div class="yield-subcard">
                <div class="yield-subcard-title">Check</div>
                <div class="yield-block-grid">
                  <label class="field-mini">
                    <span>Acres</span>
                    <input type="text" inputmode="decimal" class="input" data-role="check-acres"
                      value="${check.acres ?? ''}" />
                  </label>
                  <label class="field-mini">
                    <span>Moisture %</span>
                    <input type="text" inputmode="decimal" class="input" data-role="check-moisture"
                      value="${check.moisture ?? ''}" />
                  </label>
                  <label class="field-mini">
                    <span>Weight (Lbs)</span>
                    <input type="text" inputmode="numeric" class="input" data-role="check-pounds"
                      value="${formatPounds(check.poundsRaw || '')}" />
                  </label>
                </div>
              </div>

              <div class="yield-subcard">
                <div class="yield-subcard-title">Trial</div>
                <div class="yield-block-grid">
                  <label class="field-mini">
                    <span>Acres</span>
                    <input type="text" inputmode="decimal" class="input" data-role="trial-acres"
                      value="${trial.acres ?? ''}" />
                  </label>
                  <label class="field-mini">
                    <span>Moisture %</span>
                    <input type="text" inputmode="decimal" class="input" data-role="trial-moisture"
                      value="${trial.moisture ?? ''}" />
                  </label>
                  <label class="field-mini">
                    <span>Weight (Lbs)</span>
                    <input type="text" inputmode="numeric" class="input" data-role="trial-pounds"
                      value="${formatPounds(trial.poundsRaw || '')}" />
                  </label>
                </div>
              </div>
            </div>
            <div class="yield-block-footer">
              <span class="yield-block-yield" data-role="yieldText"></span>
              <span class="yield-block-error" data-role="errorText"></span>
            </div>
          `;

          const removeBtn = card.querySelector('.yield-block-remove');
          if(removeBtn){
            removeBtn.addEventListener('click', (ev)=>{
              ev.stopPropagation();
              removeTrialBlock(fieldRow, idx);
            });
          }

          // Allow user to type decimals themselves, up to 2 places after the dot.
          const wireDecimal = (role, sideKey, prop) => {
            const el = card.querySelector(`[data-role="${role}"]`);
            if(!el) return;
            el.addEventListener('input', e => {
              let v = e.target.value;

              // Keep digits and a single decimal point
              v = v.replace(/[^0-9.]/g,'');
              const parts = v.split('.');
              if(parts.length > 2){
                v = parts[0] + '.' + parts.slice(1).join('');
              }
              // Limit to 2 digits after the decimal
              if(v.includes('.')){
                const [intPart, fracRaw=''] = v.split('.');
                const frac = fracRaw.slice(0, 2);
                v = frac === '' ? intPart + '.' : intPart + '.' + frac;
              }

              block[sideKey][prop] = v;
              e.target.value = v;
              recalcCombine(block, card);
              renderFieldList();
            });
          };

          const wirePounds = (role, sideKey) => {
            const el = card.querySelector(`[data-role="${role}"]`);
            if(!el) return;
            el.addEventListener('input', e => {
              const digits = e.target.value.replace(/[^\d]/g,'');
              block[sideKey].poundsRaw = digits;
              e.target.value = formatPounds(digits);
              recalcCombine(block, card);
              renderFieldList();
            });
          };

          wireDecimal('check-acres', 'check', 'acres');
          wireDecimal('check-moisture', 'check', 'moisture');
          wireDecimal('trial-acres', 'trial', 'acres');
          wireDecimal('trial-moisture', 'trial', 'moisture');
          wirePounds('check-pounds', 'check');
          wirePounds('trial-pounds', 'trial');

          // Initial calc
          recalcCombine(block, card);

        }else if(block.type === 'weight'){
          card.innerHTML = `
            <div class="yield-block-head">
              <div>
                <div class="yield-block-title">Block ${idx+1} ‚Äì Weight Data</div>
                <div class="yield-block-sub">
                  This will use the Combine Yield Check calculator you already built. We‚Äôll wire the fields in the next step.
                </div>
              </div>
              <button type="button" class="yield-block-remove" aria-label="Remove block">
                <svg viewBox="0 0 16 16" aria-hidden="true">
                  <path d="M4.22 4.22a.75.75 0 0 1 1.06 0L8 6.94l2.72-2.72a.75.75 0 1 1 1.06 1.06L9.06 8l2.72 2.72a.75.75 0 0 1-1.06 1.06L8 9.06l-2.72 2.72a.75.75 0 0 1-1.06-1.06L6.94 8 4.22 5.28a.75.75 0 0 1 0-1.06z"></path>
                </svg>
              </button>
            </div>
          `;
          const removeBtn = card.querySelector('.yield-block-remove');
          if(removeBtn){
            removeBtn.addEventListener('click', (ev)=>{
              ev.stopPropagation();
              removeTrialBlock(fieldRow, idx);
            });
          }
        }

        yieldBlocksWrap.appendChild(card);
      });
    }

    function removeTrialBlock(fieldRow, idx){
      const key = fieldRow.docId;
      const arr = STATE.yieldData[key];
      if(!arr || !arr[idx]) return;
      arr.splice(idx,1);
      renderBlocksForField(fieldRow);
      renderFieldList();
    }

    function openYieldModal(row){
      if(!modalBackdrop || !modalTitleEl || !yieldSummaryEl) return;
      STATE.selectedField = row || null;

      const trialName = STATE.trial?.trialName || 'Field Trial';
      modalTitleEl.textContent = row
        ? `${row.fieldName} ‚Ä¢ Yield Entry`
        : 'Yield Entry';

      const parts = [];
      parts.push(`<strong>Trial:</strong> ${trialName}`);
      parts.push(`<strong>Field:</strong> ${row.farmName} ‚Ä¢ ${row.fieldName}`);
      if(row.trialAcres != null){
        parts.push(`<strong>Trial acres:</strong> ${row.trialAcres.toFixed(2)} ac`);
      }
      if(row.tillable != null){
        parts.push(`<strong>Field tillable:</strong> ${row.tillable} ac`);
      }

      yieldSummaryEl.innerHTML = `
        <div>${parts.join('<br>')}</div>
        <div class="muted">
          Add one or more trial blocks for this field. Each block tracks <strong>Check</strong> vs
          <strong>Trial</strong> yields based on combine data.
        </div>
      `;

      const key = row.docId;
      if(!STATE.yieldData[key]){
        STATE.yieldData[key] = [];
      }
      renderBlocksForField(row);

      modalBackdrop.classList.remove('hidden');
    }

    function closeYieldModal(){
      if(!modalBackdrop) return;
      modalBackdrop.classList.add('hidden');
      STATE.selectedField = null;
    }

    function showBlockTypeDialog(){
      if(!blockTypeDialog || !STATE.selectedField) return;
      blockTypeDialog.classList.remove('hidden');
    }

    function hideBlockTypeDialog(){
      if(!blockTypeDialog) return;
      blockTypeDialog.classList.add('hidden');
    }

    function addTrialBlockOfType(type){
      if(!STATE.selectedField) return;
      const key = STATE.selectedField.docId;
      if(!STATE.yieldData[key]){
        STATE.yieldData[key] = [];
      }
      STATE.yieldData[key].push({
        id: 'local-' + Date.now() + '-' + Math.random().toString(16).slice(2),
        type,
        check: {
          acres: '',
          moisture: '',
          poundsRaw: '',
          yieldBuAc: null
        },
        trial: {
          acres: '',
          moisture: '',
          poundsRaw: '',
          yieldBuAc: null
        }
      });
      renderBlocksForField(STATE.selectedField);
      renderFieldList();
    }

    function validateBlocksForField(fieldId){
      const blocks = STATE.yieldData[fieldId] || [];
      if(!blocks.length){
        showError('Add at least one trial block or close without saving.');
        return false;
      }

      let ok = true;
      for(const block of blocks){
        if(block.type !== 'combine') continue;
        const c = block.check || {};
        const t = block.trial || {};
        const hasC = c.acres && c.moisture && c.poundsRaw && typeof c.yieldBuAc === 'number';
        const hasT = t.acres && t.moisture && t.poundsRaw && typeof t.yieldBuAc === 'number';
        if(!(hasC && hasT)){
          ok = false;
          break;
        }
      }

      if(!ok){
        showError('Each trial block must have valid acres, moisture, and pounds for both Check and Trial before saving. Either complete or remove any incomplete blocks.');
      }

      return ok;
    }

    // Return true on success, false on any validation or Firestore error
    async function saveYieldForSelectedField(){
      if(!STATE.selectedField || !STATE.db || !STATE.trialId) return false;
      const fieldId = STATE.selectedField.docId;
      const key = fieldId;
      const blocks = STATE.yieldData[key] || [];

      if(!validateBlocksForField(fieldId)){
        return false;
      }

      try{
        showError('');
        const colPath = `${CONFIG.COLLECTION_TRIALS}/${STATE.trialId}/fields/${fieldId}/yieldBlocks`;
        const colRef = collection(STATE.db, colPath);

        // wipe existing
        const existing = await getDocs(colRef);
        const dels = [];
        existing.forEach(ds => {
          dels.push(deleteDoc(ds.ref));
        });
        if(dels.length){
          await Promise.all(dels);
        }

        // write current blocks
        const writes = [];
        blocks.forEach((block, index)=>{
          const data = {
            blockType: block.type || 'combine',
            order: index,
            check: {
              acres: block.check?.acres ? Number(block.check.acres) : null,
              moisture: block.check?.moisture ? Number(block.check.moisture) : null,
              pounds: block.check?.poundsRaw ? Number(block.check.poundsRaw) : null,
              yieldBuAc: block.check?.yieldBuAc != null ? Number(block.check.yieldBuAc) : null
            },
            trial: {
              acres: block.trial?.acres ? Number(block.trial.acres) : null,
              moisture: block.trial?.moisture ? Number(block.trial.moisture) : null,
              pounds: block.trial?.poundsRaw ? Number(block.trial.poundsRaw) : null,
              yieldBuAc: block.trial?.yieldBuAc != null ? Number(block.trial.yieldBuAc) : null
            }
          };
          writes.push(addDoc(colRef, data));
        });

        if(writes.length){
          await Promise.all(writes);
        }

        showToast('Yield data saved for this field.');
        renderFieldList();
        return true;
      }catch(err){
        console.error('Error saving yield data:', err);
        if(err && (err.code === 'permission-denied' || err.code === 7)){
          showError('Firestore rules are blocking writes to yield data (permission denied). Your blocks stay on this page but are not saved in the cloud yet.');
        }else{
          showError('Unable to save yield data. Please try again.');
        }
        return false;
      }
    }

    (async function boot(){
      await ready;

      toastEl       = $('#toast');
      errBox        = $('#errBox');
      trialNameMain = $('#trialNameMain');
      trialCropMain = $('#trialCropMain');
      trialTypeLine = $('#trialTypeLine');
      trialTreatmentLine = $('#trialTreatmentLine');
      fieldCountLine = $('#trialFieldCount');
      fieldListEl   = $('#trialFieldList');

      modalBackdrop = $('#yieldModalBackdrop');
      modalTitleEl  = $('#yieldModalTitle');
      modalBodyEl   = $('#yieldModalBody');
      yieldSummaryEl = $('#yieldSummary');
      yieldBlocksWrap = $('#yieldBlocksWrap');
      addBlockBtn = $('#btnAddTrialBlock');

      blockTypeDialog = $('#blockTypeDialog');
      blockTypeConfirmBtn = $('#btnBlockTypeConfirm');
      blockTypeCancelBtn  = $('#btnBlockTypeCancel');

      const btnBack = $('#btnBack');
      const btnModalOk = $('#btnYieldOk');

      if(btnBack){
        btnBack.addEventListener('click', () => {
          window.location.href = CONFIG.RETURN_URL;
        });
      }
      if(btnModalOk){
        btnModalOk.addEventListener('click', async () => {
          const ok = await saveYieldForSelectedField();
          if(ok){
            closeYieldModal();
          }
        });
      }
      if(modalBackdrop){
        modalBackdrop.addEventListener('click', (e)=>{
          if(e.target === modalBackdrop){
            closeYieldModal();
          }
        });
      }
      document.addEventListener('keydown', (e)=>{
        if(e.key === 'Escape'){
          closeYieldModal();
        }
      });

      if(addBlockBtn){
        addBlockBtn.addEventListener('click', showBlockTypeDialog);
      }
      if(blockTypeCancelBtn){
        blockTypeCancelBtn.addEventListener('click', hideBlockTypeDialog);
      }
      if(blockTypeConfirmBtn){
        blockTypeConfirmBtn.addEventListener('click', ()=>{
          if(!STATE.selectedField) return;
          const choice = modalBodyEl.querySelector('input[name="blockType"]:checked');
          const type = choice ? choice.value : 'combine';
          addTrialBlockOfType(type);
          hideBlockTypeDialog();
        });
      }

      const shell = document.querySelector('fv-shell');
      if(shell && NAV_MENU){
        shell.nav = NAV_MENU;
      }

      STATE.trialId   = getQueryParam('trialId');
      STATE.fieldDocId = getQueryParam('fieldDocId');

      if(!STATE.trialId){
        showError("Missing trialId in URL. Open this page from the Trials screen.");
        return;
      }

      STATE.user = await waitForAuthReady();
      if(!STATE.user){
        showError("User is not signed in. Please log in again.");
        return;
      }

      STATE.db = getFirestore();

      await loadTrial();
      await loadFields();
      await loadAllYieldBlocks();
      renderFieldList();

      if(STATE.fieldDocId && STATE.fields.length){
        const row = STATE.fields.find(f => f.docId === STATE.fieldDocId);
        if(row){
          openYieldModal(row);
        }
      }
    })();
  </script>
</head>

<body>
  <fv-shell>
    <div class="wrap">
      <section class="hero">
        <header class="hero-head">
          <div class="icon" aria-hidden="true">üß™</div>
          <div>
            <h1>Trial Field Yields</h1>
            <p class="muted">
              Review the fields in this trial and tap one to open a yield pop-up. This version dries corn to 15% and
              soybeans to 13% and lets you build trial blocks, compare Check vs Trial, and save yield data for each field.
            </p>
          </div>
        </header>

        <div class="body">
          <div id="errBox" class="error-box"></div>

          <div class="top-row-actions-left">
            <button id="btnBack" type="button" class="btn btn-quiet">
              ‚Üê Back to Trials
            </button>
          </div>

          <div class="top-row">
            <div class="trial-summary">
              <div class="trial-summary-title" id="trialNameMain">Loading trial‚Ä¶</div>
              <div class="trial-summary-line">
                <strong>Crop:</strong> <span id="trialCropMain">‚Äî</span>
              </div>
              <div class="trial-summary-line" id="trialTypeLine"></div>
              <div class="trial-summary-line" id="trialTreatmentLine"></div>
              <div class="trial-summary-line" id="trialFieldCount"></div>
            </div>
          </div>
        </div>
      </section>

      <section class="fields-hero">
        <header class="fields-head">
          <h2>Fields in this trial</h2>
        </header>
        <div class="fields-body">
          <div id="trialFieldList"></div>
          <div class="fields-hint">
            Tap a field card to open the yield pop-up. Each field can have many trial blocks, and every block
            can be based on combine yield data or weight data.
          </div>
        </div>
      </section>
    </div>
  </fv-shell>

  <!-- Yield modal -->
  <div id="yieldModalBackdrop" class="modal-backdrop hidden" role="dialog" aria-modal="true" aria-labelledby="yieldModalTitle">
    <div class="modal">
      <div class="modal-header">
        <h3 id="yieldModalTitle">Yield Entry</h3>
      </div>
      <div id="yieldModalBody" class="modal-body">
        <div id="yieldSummary" class="yield-summary"></div>

        <div class="block-type-dialog hidden" id="blockTypeDialog">
          <div><strong>What type of trial block is this?</strong></div>
          <label>
            <input type="radio" name="blockType" value="combine" checked />
            Combine Yield Data
          </label>
          <label>
            <input type="radio" name="blockType" value="weight" />
            Weight Data
          </label>
          <div class="block-type-actions">
            <button id="btnBlockTypeCancel" type="button" class="btn btn-quiet btn-inline">Cancel</button>
            <button id="btnBlockTypeConfirm" type="button" class="btn btn-primary btn-inline">Add Block</button>
          </div>
        </div>

        <button id="btnAddTrialBlock" type="button" class="btn btn-primary btn-inline">
          + Add Trial Block
        </button>

        <div id="yieldBlocksWrap"></div>
      </div>
      <div class="modal-footer">
        <button id="btnYieldOk" type="button" class="btn btn-primary">Save &amp; Close</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite">Saved.</div>
</body>
</html>
