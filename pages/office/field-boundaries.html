<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>FarmVista • Field Boundary Fix Request</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#3B7E46">

  <!-- Absolute paths (FarmVista standard) -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest">
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png">
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png">
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css">
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css">

  <!-- Boot + FVData (Firestore/Storage helpers) -->
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <script src="/Farm-vista/js/firebase-config.js"></script>
  <script src="/Farm-vista/js/fv-data.js"></script>
  <script>(function(){
    if(!customElements.get('fv-shell')){
      const s=document.createElement('script');
      s.src='/Farm-vista/js/fv-shell.js'; s.defer=true; document.head.appendChild(s);
    }
  })();</script>

  <style>
    :root{
      --card-max: 1100px;
      --page-bottom-gap: 96px;
      --accent:#2F6C3C;
      --hero-icon-col: 36px;
      --hero-icon-size: 24px;
    }
    html{-webkit-text-size-adjust:100%}
    body{ background: var(--app-bg, var(--surface)); }
    .wrap{ max-width: var(--card-max); margin: 0 auto; padding: clamp(14px,3vw,22px);
      padding-bottom: calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + var(--page-bottom-gap)) !important; }

    .hero{ border:1px solid var(--border); border-radius:14px; background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08)); overflow:hidden; margin-bottom: var(--page-bottom-gap); }
    .hero-head{ display:grid; grid-template-columns: var(--hero-icon-col) 1fr; gap:12px; align-items:center;
      padding:14px 16px; background:linear-gradient(90deg, rgba(47,108,60,.12), transparent); border-bottom:1px solid var(--border); }
    .hero-head .icon{ width:var(--hero-icon-size); height:var(--hero-icon-size); color:var(--accent); display:grid; place-items:center; }
    .hero-head h1{ margin:0; font-size:clamp(20px,3.2vw,26px); line-height:1.2; }
    .muted{ color:var(--muted,#67706B); }

    .body{ padding:16px; display:grid; gap:14px; }
    .row{ display:grid; gap:10px; grid-template-columns: 1fr 1fr; }
    .row-3{ grid-template-columns: 1fr 1fr 1fr; }
    .row-4{ grid-template-columns: 1fr 1fr 1fr 1fr; }
    @media (max-width:880px){ .row, .row-3, .row-4 { grid-template-columns: 1fr; } }

    .field label{ display:block; font-weight:800; margin:0 0 6px 0; }
    .input, .select, .textarea{
      width:100%; font:inherit; font-size:16px; color:var(--text);
      background:var(--card-surface,var(--surface)); border:1px solid var(--border);
      border-radius:10px; padding:12px 12px; outline:none;
    }
    .textarea{ min-height:110px; resize:vertical; }
    .help{ font-size:13px; color:var(--muted,#67706B); margin-top:6px; }

    .actions{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-top:6px; }
    .btn{ display:inline-flex; align-items:center; justify-content:center; min-width:160px; padding:12px 16px; border-radius:12px;
      border:1px solid var(--border); background:var(--card-surface,var(--surface)); font-weight:800; color:var(--text) !important;
      text-decoration:none; cursor:pointer; user-select:none; }
    .btn-primary{ border-color:transparent; background:#2F6C3C; color:#fff !important; }

    .panel{ border:1px solid var(--border); border-radius:12px; padding:12px; background:var(--card-surface,var(--surface)); }
    .panel h3{ margin:0 0 8px 0; font-size:16px; }

    .open-list{ display:grid; gap:10px; }
    .open-item{ border:1px solid var(--border); border-radius:10px; padding:10px; display:grid; gap:6px; background:var(--surface); }
    .open-head{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .badge{ display:inline-block; font-size:12px; font-weight:800; padding:4px 8px; border-radius:999px;
      color:#114; background:rgba(47,108,60,.12); border:1px solid var(--border); }

    .thumbs{ display:flex; gap:10px; flex-wrap:wrap; }
    .thumb{ width:92px; height:92px; border:1px solid var(--border); border-radius:10px; overflow:hidden;
      display:grid; place-items:center; background:#f6f7f6; position:relative; }
    .thumb img{ width:100%; height:100%; object-fit:cover; }
    .thumb button{ position:absolute; inset:auto 6px 6px auto; font-size:12px; padding:4px 6px; border-radius:8px;
      border:1px solid var(--border); background:var(--surface); cursor:pointer; }

    .hist-head{ display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-top:1px solid var(--border); }
    .hist-title{ font-size:clamp(18px, 2.6vw, 22px); font-weight:800; }
    .hist-clear{ border:1px solid var(--border); background:var(--surface); border-radius:10px; padding:8px 12px; font-weight:700; cursor:pointer; color:var(--text) !important; }
    .hist{ padding:14px 16px; display:grid; gap:12px; }
    .hist-item{ border:1px solid var(--border); border-radius:12px; padding:12px; background:var(--card-surface,var(--surface));
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .hist-item .hline{ font-weight:800; }
    .hist-item .view{ border:1px solid var(--border); background:var(--surface); border-radius:10px; padding:8px 12px; font-weight:700; cursor:pointer; color:var(--text) !important; }

    .modal{ position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.42);
      z-index:9999; transition:opacity .15s; opacity:0; }
    .modal[open]{ display:grid; opacity:1; }
    .dialog{ width:min(760px,92vw); max-height:85vh; display:flex; flex-direction:column; background:var(--surface); color:var(--text);
      border-radius:14px; border:1px solid var(--border); box-shadow:0 16px 36px rgba(0,0,0,.28); }
    .dialog-head{ padding:12px 14px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
    .dialog-body{ padding:14px; overflow:auto; flex:1 1 auto; min-height:0; -webkit-overflow-scrolling:touch; }
    .closex{ border:1px solid var(--border); background:var(--surface); border-radius:10px; padding:8px 12px; cursor:pointer; font-weight:700; color:var(--text) !important; }
    .kv{ display:grid; grid-template-columns:1fr auto; gap:8px 12px; align-items:baseline; }
    .kv .val{ font-weight:800; }

    .note{ font-size:13px; padding:8px 10px; border-radius:10px; border:1px dashed var(--border);
      background:linear-gradient(180deg, rgba(47,108,60,.06), transparent); }

    .toast{ position:fixed; left:50%; bottom:calc(env(safe-area-inset-bottom,0px) + 72px); transform:translateX(-50%);
      background:#2F6C3C; color:#fff; padding:10px 14px; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,.25); z-index:99999; display:none; }
    .toast.show{ display:block; animation:fadeout 3.2s forwards; }
    @keyframes fadeout{0%{opacity:1}85%{opacity:1}100%{opacity:0}}

    html.no-scroll, body.no-scroll{ overflow:hidden; }
  </style>
</head>
<body>
  <fv-shell>
    <div class="wrap">
      <section class="hero">
        <header class="hero-head">
          <div class="icon" aria-hidden="true">
            <!-- device-desktop-cog -->
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                 width="24" height="24" fill="none" stroke="currentColor"
                 stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <rect x="3" y="4" width="18" height="12" rx="2"/>
              <path d="M7 20h10M9 16v4M15 16v4"/>
              <circle cx="17.5" cy="9.5" r="2"/>
              <path d="M17.5 6.5v1M17.5 11.5v1M14.9 9.5h1M19.1 9.5h1M15.6 7.6l.7.7M18.7 10.7l.7.7M15.6 11.4l.7-.7M18.7 8.3l.7-.7"/>
            </svg>
          </div>
          <div>
            <h1 id="title">Field Boundary Fix Request</h1>
            <p id="subtitle" class="muted">Pick a field, mark Interior or Exterior, describe what’s off, attach photos. Saves to FVData.</p>
          </div>
        </header>

        <div id="form" class="body">
          <div class="row">
            <div class="field">
              <label for="fieldName">Field</label>
              <select id="fieldName" class="select" data-field="field" data-label="Field" data-summary="1">
                <option value="">— Select field —</option>
              </select>
              <div class="help">Fields load from FVData (Settings → Fields). Type to jump.</div>
            </div>
            <div class="field">
              <label for="boundaryType">Boundary Type</label>
              <select id="boundaryType" class="select" data-field="boundaryType" data-label="Boundary Type" data-summary="2">
                <option value="">—</option>
                <option>Exterior</option>
                <option>Interior</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="scope">Scope</label>
              <select id="scope" class="select" data-field="scope" data-label="Scope" data-summary="3">
                <option value="">—</option>
                <option>Small section</option>
                <option>Entire field</option>
              </select>
            </div>
            <div class="field">
              <label for="when">Date</label>
              <input id="when" type="date" class="input" data-field="when" data-label="Date">
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="submittedBy">Submitted By</label>
              <select id="submittedBy" class="select" data-field="submittedBy" data-label="Submitted By"></select>
              <div class="help" id="submittedByHelp"></div>
            </div>
            <div class="field">
              <label for="contact">Contact (optional)</label>
              <input id="contact" class="input" placeholder="Phone or email" data-field="contact" data-label="Contact">
            </div>
          </div>

          <div class="field">
            <label for="notes">Notes</label>
            <textarea id="notes" class="textarea" placeholder="Describe what’s wrong and where (e.g., NW corner 50–80 ft too wide)" data-field="notes" data-label="Notes"></textarea>
          </div>

          <div class="field">
            <label for="photos">Photos (optional)</label>
            <input id="photos" class="input" type="file" accept="image/*" multiple capture="environment">
            <div id="thumbs" class="thumbs" aria-live="polite"></div>
            <div id="photoNote" class="help"></div>
          </div>

          <div id="openPanel" class="panel" hidden>
            <h3>Open requests already on <span id="openFieldLabel"></span></h3>
            <div id="openList" class="open-list"></div>
            <div id="openNone" class="muted">No other open requests for this field.</div>
          </div>

          <div class="actions">
            <button id="clear" class="btn" type="button">Clear Inputs</button>
            <button id="primary" class="btn btn-primary" type="button">Submit Request</button>
          </div>

          <div id="summary" class="panel note" hidden></div>
        </div>

        <div class="hist-head">
          <div class="hist-title" id="histTitle">Recent Requests</div>
          <button id="clearHist" class="hist-clear" type="button">Clear Local History</button>
        </div>
        <div id="history" class="hist">
          <div class="muted">No recent requests.</div>
        </div>
      </section>
    </div>
  </fv-shell>

  <div id="modal" class="modal" aria-hidden="true">
    <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="mdTitle">
      <div class="dialog-head">
        <h3 id="mdTitle">Details</h3>
        <button class="closex" id="mdClose" type="button">Back</button>
      </div>
      <div class="dialog-body" id="mdBody"></div>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite">Saved.</div>

  <script type="module">
    const $ = id => document.getElementById(id);
    const toast = $("toast");
    const showToast = (msg="Saved.") => { toast.textContent=msg; toast.classList.remove("show"); void toast.offsetWidth; toast.classList.add("show"); };

    const COLL = "boundary_requests";
    const STORAGE_FOLDER = "boundary-photos";
    const LS_KEY = "df_boundary_requests_local_v1";
    const MAX_HIST_LOCAL = 20;

    const firebase = window.firebase || {};
    const HAS_FS = !!(firebase && firebase.firestore);
    const HAS_STG = !!(firebase && firebase.storage);
    const db  = HAS_FS ? firebase.firestore() : null;
    const stg = HAS_STG ? firebase.storage() : null;

    const todayISO = ()=> new Date(Date.now()-new Date().getTimezoneOffset()*60000).toISOString().slice(0,10);
    const esc = s => String(s||"").replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;",'"':"&quot;","'":"&#39;"}[m]));
    const fmtDate = iso => iso ? new Date(iso).toLocaleDateString() : "";

    const fieldSel = $("fieldName");
    const submittedBy = $("submittedBy");
    const submittedByHelp = $("submittedByHelp");
    const boundaryType = $("boundaryType");
    const scope = $("scope");
    const when = $("when");
    const contact = $("contact");
    const notes = $("notes");
    const photos = $("photos");
    const thumbs = $("thumbs");
    const photoNote = $("photoNote");
    const openPanel = $("openPanel");
    const openFieldLabel = $("openFieldLabel");
    const openList = $("openList");
    const openNone = $("openNone");

    // ---------- FVData helpers ----------
    async function fvReady(){
      if(!window.FVData) throw new Error("FVData not found");
      if(FVData.ready) await FVData.ready();
      return FVData;
    }

    // Load fields from FVData: try 'fields' then 'ss_fields'
    async function loadFieldsFV(){
      const FV = await fvReady();
      const pulls = [];
      if(FV.list) {
        pulls.push(FV.list("fields", { limit: 5000 }));
        pulls.push(FV.list("ss_fields", { limit: 5000 }));
      } else {
        pulls.push(FV.loadAll("fields"));
        pulls.push(FV.loadAll("ss_fields"));
      }
      const [a,b] = await Promise.allSettled(pulls);
      const rows = []
        .concat(a.status==="fulfilled" ? (a.value||[]) : [])
        .concat(b.status==="fulfilled" ? (b.value||[]) : []);
      const names = rows.map(r => r.data ? r.data.name : (r.name||"")).filter(Boolean);
      const uniq = Array.from(new Set(names)).sort((x,y)=>x.localeCompare(y));
      return uniq;
    }

    // Load employees from FVData
    async function loadEmployeesFV(){
      const FV = await fvReady();
      const rows = FV.list ? await FV.list("employees", { limit: 5000 }) : await FV.loadAll("employees");
      return (rows||[]).map(r => {
        const d = r.data ? r.data : r;
        const name = d.displayName || d.name || "";
        const email = d.email || d.id || "";
        return { id: r.id || email || name, name: name || email, email };
      }).filter(x=>x.id).sort((a,b)=>a.name.localeCompare(b.name));
    }

    // Default to current user in employees select
    async function fillSubmittedBy(employees){
      const sel = submittedBy;
      const me = (window.__FV_USER && (window.__FV_USER.displayName || window.__FV_USER.email))
        ? { name: window.__FV_USER.displayName || window.__FV_USER.email, email: window.__FV_USER.email || "" }
        : (firebase && firebase.auth && firebase.auth().currentUser
            ? { name: firebase.auth().currentUser.displayName || firebase.auth().currentUser.email, email: firebase.auth().currentUser.email }
            : null);
      sel.innerHTML = '';
      employees.forEach(emp=>{
        const opt=document.createElement("option");
        opt.value = emp.name || emp.email || emp.id;
        opt.textContent = emp.name + (emp.email ? ` — ${emp.email}` : "");
        if(me && (emp.email && emp.email.toLowerCase() === (me.email||"").toLowerCase()
                  || emp.name && emp.name === me.name)){
          opt.selected = true;
        }
        sel.appendChild(opt);
      });
      if(!employees.length){
        const opt=document.createElement("option");
        opt.value = me ? me.name : "";
        opt.textContent = me ? (me.name + (me.email?` — ${me.email}`:"")) : "(no employees found)";
        sel.appendChild(opt);
      }
      submittedByHelp.textContent = "Defaults to your account; choose another employee if submitting on their behalf.";
    }

    async function fillFields(){
      // FVData → local cache → static JSON as last resort
      let names = [];
      try { names = await loadFieldsFV(); } catch(e){ console.warn("FVData fields failed:", e); }
      if(!names.length){
        try {
          const raw = localStorage.getItem("df_fields");
          if(raw){ const arr = JSON.parse(raw); if(Array.isArray(arr)) names = arr.map(x=>typeof x==="string"?x:(x.name||"")).filter(Boolean); }
        } catch(e){}
      }
      if(!names.length){
        try {
          const res = await fetch("/Farm-vista/assets/data/fields.json",{cache:"no-store"});
          if(res.ok){ const tmp = await res.json(); if(Array.isArray(tmp)) names = tmp.map(x=>typeof x==="string"?x:(x.name||"")).filter(Boolean); }
        } catch(e){}
      }
      names = Array.from(new Set(names)).sort((a,b)=>a.localeCompare(b));
      fieldSel.innerHTML = '<option value="">— Select field —</option>' + names.map(n=>`<option>${esc(n)}</option>`).join("");
    }

    // ---------- Thumbs ----------
    let selectedFiles=[];
    photos.addEventListener("change", ()=>{
      selectedFiles = Array.from(photos.files||[]);
      renderThumbs();
      photoNote.textContent = window.FVData ? "Photos will upload with the request." :
                              HAS_STG ? "Uploading via Firebase Storage." :
                              "Preview only (no cloud upload available).";
    });
    function renderThumbs(){
      thumbs.innerHTML = "";
      selectedFiles.forEach((file, idx)=>{
        const div = document.createElement("div"); div.className="thumb";
        const img = document.createElement("img"); img.alt=file.name; img.src=URL.createObjectURL(file);
        const rm = document.createElement("button"); rm.type="button"; rm.textContent="Remove";
        rm.addEventListener("click", ()=>{ selectedFiles.splice(idx,1); renderThumbs(); });
        div.appendChild(img); div.appendChild(rm); thumbs.appendChild(div);
      });
    }

    // ---------- Collect / Validate ----------
    const FIELDS = Array.from(document.querySelectorAll("[data-field]"));
    function collect(){
      const o={}; FIELDS.forEach(el=>o[el.dataset.field]=el.value);
      o.status="Open"; o.t=Date.now(); o.timestampISO=new Date(o.t).toISOString();
      return o;
    }
    function validate(o){
      if(!o.field) return "Please select a field.";
      if(!o.boundaryType) return "Please choose Interior or Exterior.";
      if(!o.scope) return "Please choose Small section or Entire field.";
      if(!o.submittedBy || !o.submittedBy.trim()) return "Please choose who is submitting this.";
      if(!o.when) return "Please set the date.";
      return "";
    }

    // ---------- FVData write (primary) ----------
    async function saveRequestFV(obj){
      const FV = await fvReady();
      const ref = FV.save ? await FV.save(COLL, obj) : await FV.add(COLL, obj);
      // FV.save may return id or full record; normalize
      const id = (ref && (ref.id || ref.key)) ? (ref.id || ref.key) : (typeof ref === "string" ? ref : null);
      return id;
    }
    async function uploadManyFV(docId, files){
      if(!files.length) return [];
      const FV = await fvReady();
      const uploads = [];
      for(const f of files){
        const safe = (Date.now()+"-"+f.name).replace(/[^\w.\-]+/g,"_");
        const path = `${STORAGE_FOLDER}/${docId}/${safe}`;
        const res = FV.upload ? await FV.upload(path, f, { contentType: f.type }) : null;
        const url = res?.url || (FV.getDownloadURL ? await FV.getDownloadURL(path) : null);
        uploads.push({ name:f.name, url: url || "" });
      }
      return uploads;
    }

    // ---------- Firebase SDK fallback ----------
    async function saveRequestFS(obj){
      if(!db) throw new Error("Firestore unavailable");
      const FieldValue = firebase.firestore.FieldValue;
      const ref = await db.collection(COLL).add({ ...obj, createdAt: FieldValue.serverTimestamp ? FieldValue.serverTimestamp() : null });
      return ref.id;
    }
    async function uploadManyFS(docId, files){
      if(!stg || !files.length) return [];
      const out=[];
      for(const f of files){
        const safe=(Date.now()+"-"+f.name).replace(/[^\w.\-]+/g,"_");
        const ref = stg.ref().child(`${STORAGE_FOLDER}/${docId}/${safe}`);
        await ref.put(f);
        const url = await ref.getDownloadURL();
        out.push({ name:f.name, url });
      }
      return out;
    }

    // ---------- Queries for open items / recent ----------
    async function queryOpenByFieldFV(fieldName){
      const FV = await fvReady();
      const all = FV.list ? await FV.list(COLL, { where:[["field","==",fieldName],["status","==","Open"]], orderBy:"timestampISO", desc:true, limit:25 }) : await FV.loadAll(COLL);
      const rows = (all||[]).map(r=>r.data?({id:r.id,...r.data}):r).filter(x=>x.field===fieldName && x.status==="Open");
      rows.sort((a,b)=> (b.timestampISO||b.t||0) > (a.timestampISO||a.t||0) ? 1 : -1);
      return rows;
    }
    async function recentFV(limit=20){
      const FV = await fvReady();
      const rows = FV.list ? await FV.list(COLL, { orderBy:"timestampISO", desc:true, limit }) : await FV.loadAll(COLL);
      return (rows||[]).map(r=>r.data?({id:r.id, ...r.data}):r)
                       .sort((a,b)=> (b.timestampISO||b.t||0) - (a.timestampISO||a.t||0));
    }
    async function queryOpenByFieldFS(fieldName){
      const snap = await db.collection(COLL).where("field","==",fieldName).where("status","==","Open")
        .orderBy("timestampISO","desc").limit(25).get();
      return snap.docs.map(d=>({id:d.id, ...d.data()}));
    }
    async function recentFS(limit=20){
      const snap = await db.collection(COLL).orderBy("timestampISO","desc").limit(limit).get();
      return snap.docs.map(d=>({id:d.id, ...d.data()}));
    }

    // ---------- Local history ----------
    function loadLocal(){ try{ const a=JSON.parse(localStorage.getItem(LS_KEY)||"[]"); return Array.isArray(a)?a:[]; }catch(e){ return []; } }
    function saveLocal(a){ localStorage.setItem(LS_KEY, JSON.stringify(a.slice(0,MAX_HIST_LOCAL))); }

    function summaryLine(o){
      const parts=[]; if(o.field) parts.push(o.field); if(o.boundaryType) parts.push(o.boundaryType); if(o.when) parts.push(new Date(o.when).toLocaleDateString());
      return parts.join(" • ");
    }

    async function refreshOpenForField(){
      const fieldName = fieldSel.value;
      if(!fieldName){ openPanel.hidden = true; return; }
      openFieldLabel.textContent = fieldName;

      let items=[];
      try{ items = await queryOpenByFieldFV(fieldName); }
      catch(e){
        console.warn("FVData open-by-field failed, trying FS/local:", e);
        if(db){ try{ items = await queryOpenByFieldFS(fieldName); } catch(e2){} }
        if(!items.length){ items = loadLocal().filter(x=>x.field===fieldName && x.status==="Open"); }
      }

      openList.innerHTML = "";
      if(!items.length){ openNone.hidden=false; }
      else{
        openNone.hidden=true;
        items.forEach(it=>{
          const div=document.createElement("div"); div.className="open-item";
          div.innerHTML = `
            <div class="open-head">
              <div><strong>${esc(it.boundaryType||"-")}</strong> • ${esc(it.scope||"-")}</div>
              <span class="badge">${esc(it.status||"Open")}</span>
            </div>
            <div class="muted">${fmtDate(it.when)} • ${esc(it.submittedBy||"Unknown")}</div>
            <div>${esc(it.notes||"(no notes)")}</div>
          `;
          openList.appendChild(div);
        });
      }
      openPanel.hidden=false;
    }

    async function renderHistory(){
      const box = $("history");
      $("histTitle").textContent = window.FVData || db ? "Recent Requests" : "Recent Requests (this device)";
      let items=[];
      try{ items = await recentFV(20); }
      catch(e){
        console.warn("FVData recent failed; trying FS/local:", e);
        if(db){ try{ items = await recentFS(20); }catch(e2){} }
        if(!items.length){ items = loadLocal(); }
      }
      if(!items.length){ box.innerHTML = '<div class="muted">No recent requests.</div>'; return; }
      box.innerHTML = "";
      items.forEach(it=>{
        const div=document.createElement("div"); div.className="hist-item";
        div.innerHTML = `<div class="hline">${esc(summaryLine(it) || "(untitled)")}</div>
                         <button class="view" type="button">View</button>`;
        div.querySelector(".view").addEventListener("click", ()=> openDetail(it));
        box.appendChild(div);
      });
    }

    // ---------- Modal ----------
    const modal = $("modal"), mdBody=$("mdBody"), mdClose=$("mdClose"); let lastFocus=null;
    function openDetail(it){
      $("mdTitle").textContent = "Request Details";
      const rows = [
        ["Field", it.field], ["Boundary Type", it.boundaryType], ["Scope", it.scope],
        ["Date", it.when ? new Date(it.when).toLocaleDateString() : ""],
        ["Submitted By", it.submittedBy], ["Contact", it.contact],
        ["Status", it.status||"Open"], ["Notes", it.notes]
      ].map(([k,v])=>`<div>${esc(k)}</div><div class="val">${esc(v||"")}</div>`).join("");
      const photosBlock = Array.isArray(it.photos) && it.photos.length
        ? `<div style="grid-column:1/-1"><div class="thumbs">${
            it.photos.map(p=>`<a href="${esc(p.url||"#")}" target="_blank" class="thumb" title="${esc(p.name||"photo")}">${p.url?`<img src="${esc(p.url)}" alt="">`:"<span>No URL</span>"}</a>`).join("")
          }</div></div>` : "";
      mdBody.innerHTML = `<div class="kv">${rows}${photosBlock}</div>`;
      modal.setAttribute("open",""); modal.setAttribute("aria-hidden","false");
      document.documentElement.classList.add("no-scroll"); document.body.classList.add("no-scroll");
      lastFocus=document.activeElement; mdClose.focus();
    }
    function closeModal(){
      modal.removeAttribute("open"); modal.setAttribute("aria-hidden","true");
      document.documentElement.classList.remove("no-scroll"); document.body.classList.remove("no-scroll");
      if(lastFocus && lastFocus.focus) lastFocus.focus();
    }
    mdClose.addEventListener("click", closeModal);
    modal.addEventListener("click", e=>{ if(e.target===modal) closeModal(); });
    document.addEventListener("keydown", e=>{ if(e.key==="Escape" && modal.hasAttribute("open")) closeModal(); });

    // ---------- Submit ----------
    $("primary").addEventListener("click", async ()=>{
      const o = collect();
      const err = validate(o);
      if(err){ alert(err); return; }
      if(!o.when) o.when = todayISO();

      $("summary").hidden=false; $("summary").textContent="Submitting…";

      let id=null, uploaded=[];
      try{
        // FVData first
        try{
          id = await saveRequestFV(o);
          if(selectedFiles.length){ uploaded = await uploadManyFV(id, selectedFiles); }
        }catch(e){
          console.warn("FVData save/upload failed, trying Firebase SDK:", e);
          if(!id && db){ id = await saveRequestFS(o); }
          if(selectedFiles.length && stg){ uploaded = await uploadManyFS(id||("local-"+o.t), selectedFiles); }
        }
        if((id && uploaded.length) && (window.FVData || db)){
          // Patch record with photos
          try{
            if(window.FVData){
              const FV = await fvReady();
              if(FV.update) await FV.update(COLL, id, { photos: uploaded });
              else if(FV.save) await FV.save(COLL, { id, photos: uploaded });
            }else if(db){
              await db.collection(COLL).doc(id).update({ photos: uploaded });
            }
            o.photos = uploaded;
          }catch(e){ console.warn("Photo URL patch failed:", e); }
        }
        // Local echo
        const rec = loadLocal(); rec.unshift({ ...o, id: id || ("local-"+o.t) }); saveLocal(rec);

        $("summary").innerHTML = `<strong>Submitted:</strong> ${esc((o.field||"") + (o.boundaryType? " • "+o.boundaryType : "") + (o.when? " • "+new Date(o.when).toLocaleDateString() : ""))}`;
        showToast(window.FVData || db ? "Request saved." : "Saved locally (offline).");

        // reset light
        ["fieldName","boundaryType","scope"].forEach(id=>$(id).selectedIndex=0);
        $("when").value = todayISO();
        ["contact","notes"].forEach(id=>$(id).value="");
        $("photos").value = ""; selectedFiles=[]; renderThumbs();
        await renderHistory(); await refreshOpenForField();
        window.scrollTo({top:0, behavior:"smooth"});
      }catch(e){
        console.error(e);
        alert("Sorry, something went wrong saving the request.");
        $("summary").hidden=true;
      }
    });

    $("clear").addEventListener("click", ()=>{
      ["fieldName","boundaryType","scope"].forEach(id=>$(id).selectedIndex=0);
      $("when").value = todayISO();
      ["contact","notes"].forEach(id=>$(id).value="");
      $("photos").value = ""; selectedFiles=[]; renderThumbs();
      $("openPanel").hidden=true; $("summary").hidden=true;
    });

    $("clearHist").addEventListener("click", ()=>{
      if(!confirm("Clear local fallback history? (Does not delete FVData records.)")) return;
      saveLocal([]); renderHistory();
    });

    fieldSel.addEventListener("change", refreshOpenForField);

    // ---------- Boot ----------
    (async function boot(){
      try{
        $("when").value = todayISO();
        // Fields + Employees
        await fillFields();
        let employees=[];
        try{ employees = await loadEmployeesFV(); } catch(e){ console.warn("FVData employees failed:", e); }
        await fillSubmittedBy(employees);
        await renderHistory();
      }catch(e){ console.error(e); }
    })();
  </script>
</body>
</html>