<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>FarmVista • Field Boundary Fix Request</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#3B7E46"/>

  <!-- Standard includes (ABSOLUTE paths) -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <!-- Ensure fv-shell -->
  <script>(function(){if(!customElements.get('fv-shell')){const s=document.createElement('script');s.src='/Farm-vista/js/fv-shell.js';s.defer=true;document.head.appendChild(s);}})();</script>

  <style>
    :root{ --card-max:1100px; --page-bottom-gap:96px; --accent:#2F6C3C; --hero-icon-col:36px; --hero-icon-size:24px; }
    body{ background:var(--app-bg,var(--surface)); }
    .wrap{max-width:var(--card-max);margin:0 auto;padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px)+var(--ftr-h,42px)+var(--page-bottom-gap))!important;}
    .hero{border:1px solid var(--border);border-radius:14px;background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));overflow:hidden;margin-bottom:var(--page-bottom-gap);}
    .hero-head{display:grid;grid-template-columns:var(--hero-icon-col) 1fr;gap:12px;align-items:center;
      padding:14px 16px;background:linear-gradient(90deg,rgba(47,108,60,.12),transparent);border-bottom:1px solid var(--border);}
    .hero-head .icon{width:var(--hero-icon-size);height:var(--hero-icon-size);color:var(--accent);display:grid;place-items:center;}
    .hero-head h1{margin:0;font-size:clamp(20px,3.2vw,26px);line-height:1.2}
    .muted{color:var(--muted,#67706B)}
    .body{padding:16px;display:grid;gap:14px}
    .row{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    @media (max-width:880px){.row{grid-template-columns:1fr}}
    .field label{display:block;font-weight:800;margin:0 0 6px}
    .input,.select,.textarea{width:100%;font:inherit;font-size:16px;color:var(--text);
      background:var(--card-surface,var(--surface));border:1px solid var(--border);border-radius:10px;padding:12px;outline:none}
    .textarea{min-height:110px;resize:vertical}
    .help{font-size:13px;color:var(--muted,#67706B);margin-top:6px}
    .actions{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:6px}
    .btn{display:inline-flex;align-items:center;justify-content:center;min-width:160px;padding:12px 16px;border-radius:12px;
      border:1px solid var(--border);background:var(--card-surface,var(--surface));font-weight:800;color:var(--text)!important;cursor:pointer}
    .btn-primary{border-color:transparent;background:#2F6C3C;color:#fff!important}
    .error{color:#b00020;font-weight:700}
    .note{font-size:13px;padding:8px 10px;border-radius:10px;border:1px dashed var(--border);background:linear-gradient(180deg,rgba(47,108,60,.06),transparent)}
  </style>
</head>
<body>
  <fv-shell>
    <div class="wrap">
      <section class="hero">
        <header class="hero-head">
          <div class="icon" aria-hidden="true">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
              <rect x="3" y="4" width="18" height="12" rx="2"/><path d="M7 20h10M9 16v4M15 16v4"/><circle cx="17.5" cy="9.5" r="2"/>
              <path d="M17.5 6.5v1M17.5 11.5v1M14.9 9.5h1M19.1 9.5h1M15.6 7.6l.7.7M18.7 10.7l.7.7M15.6 11.4l.7-.7M18.7 8.3l.7-.7"/>
            </svg>
          </div>
          <div>
            <h1>Field Boundary Fix Request</h1>
            <p class="muted">Pick a field, mark Interior or Exterior, describe what’s off.</p>
          </div>
        </header>

        <div class="body">
          <!-- Row 1 -->
          <div class="row">
            <div class="field">
              <label for="fieldName">Field</label>
              <!-- RTK-style: value = doc.id, label = name -->
              <select id="fieldName" class="select" data-field="fieldId" data-label="Field">
                <option value="">— Select field —</option>
              </select>
              <div class="help" id="fieldHelp">0 fields</div>
            </div>

            <div class="field">
              <label for="boundaryType">Boundary Type</label>
              <select id="boundaryType" class="select" data-field="boundaryType" data-label="Boundary Type">
                <option value="">—</option>
                <option>Exterior</option>
                <option>Interior</option>
              </select>
            </div>
          </div>

          <!-- Row 2 -->
          <div class="row">
            <div class="field">
              <label for="scope">Scope</label>
              <select id="scope" class="select" data-field="scope" data-label="Scope">
                <option value="">—</option>
                <option>Small section</option>
                <option>Entire field</option>
              </select>
            </div>

            <div class="field">
              <label for="when">Date</label>
              <input id="when" type="date" class="input" data-field="when" data-label="Date">
            </div>
          </div>

          <!-- Row 3 -->
          <div class="row">
            <div class="field">
              <label for="submittedBy">Submitted By</label>
              <select id="submittedBy" class="select" data-field="submittedBy" data-label="Submitted By"></select>
              <div class="help">Defaults to the currently signed-in user.</div>
            </div>
            <div class="field"></div>
          </div>

          <!-- Notes -->
          <div class="field">
            <label for="notes">Notes</label>
            <textarea id="notes" class="textarea" placeholder="Describe what’s wrong and where (e.g., NW corner 50–80 ft too wide)" data-field="notes" data-label="Notes"></textarea>
          </div>

          <!-- Actions -->
          <div class="actions">
            <button id="clear" class="btn" type="button">Clear Inputs</button>
            <button id="primary" class="btn btn-primary" type="button">Submit Request</button>
          </div>

          <div id="summary" class="panel note" hidden></div>
          <div id="err" class="help error" hidden></div>
        </div>
      </section>
    </div>
  </fv-shell>

  <script type="module">
    import {
      ready,
      getFirestore, getAuth,
      collection, getDocs, addDoc, serverTimestamp
    } from '/Farm-vista/js/firebase-init.js';

    const $ = id => document.getElementById(id);
    const esc = s => String(s||"").replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;",'"':"&quot;","'":"&#39;"}[m]));
    const todayISO = ()=> new Date(Date.now()-new Date().getTimezoneOffset()*60000).toISOString().slice(0,10);
    const titleCase = s => String(s||"").toLowerCase().split(/[\s._-]+/).filter(Boolean).map(w=>w[0].toUpperCase()+w.slice(1)).join(" ");

    const fieldSel = $("fieldName");
    const fieldHelp = $("fieldHelp");
    const submittedBySel = $("submittedBy");
    const when = $("when");
    const boundaryType = $("boundaryType");
    const scope = $("scope");
    const notes = $("notes");
    const summary = $("summary");
    const errBox = $("err");

    when.value = todayISO();

    async function currentUser(){
      const auth = getAuth();
      const u = auth.currentUser;
      if (u) return { name: u.displayName || titleCase(String(u.email||"").replace(/@.*/,"").replace(/\./g," ")), email: u.email||"" };
      // ready waits auth; but if null, still return empty
      return {name:"",email:""};
    }

    async function loadFields(db){
      errBox.hidden = true; fieldHelp.textContent = "Loading…";
      try{
        const snap = await getDocs(collection(db, 'fields'));
        const items = [];
        snap.forEach(d=>{
          const data = d.data()||{};
          const name = String(data.name||"").trim();
          if (name) items.push({ id:d.id, name });
        });
        items.sort((a,b)=>a.name.localeCompare(b.name));
        fieldSel.innerHTML = '<option value="">— Select field —</option>' +
          items.map(x=>`<option value="${esc(x.id)}" data-name="${esc(x.name)}">${esc(x.name)}</option>`).join("");
        fieldHelp.textContent = `${items.length} fields`;
        if (!items.length){
          errBox.textContent = 'No fields found. Verify rules allow READ on "fields".';
          errBox.hidden = false;
        }
      }catch(e){
        console.error(e);
        errBox.textContent = `Could not load "fields": ${e.message}`;
        errBox.hidden = false;
        fieldHelp.textContent = "0 fields";
      }
    }

    function empName(d){
      const full = (d.fullName||"").trim();
      if(full) return full;
      const fn=(d.firstName||"").trim(), ln=(d.lastName||"").trim();
      if(fn||ln) return (fn+" "+ln).trim();
      if(d.displayName) return d.displayName;
      if(d.name) return d.name;
      return (d.email||"").replace(/@.*/,"");
    }

    async function loadEmployees(db){
      const me = await currentUser(); // {name,email}
      let emps = [];
      try{
        const snap = await getDocs(collection(db, 'employees'));
        snap.forEach(doc=>{
          const d = doc.data()||{};
          const nm = empName(d);
          if(nm) emps.push({ name:nm, email:d.email||"" });
        });
      }catch(_){ /* ignore and fallback to current user */ }

      const norm = s => String(s||"").trim().toLowerCase();
      const hasMe = emps.some(e => (e.email && norm(e.email)===norm(me.email)) || norm(e.name)===norm(me.name));
      if(!hasMe && (me.name || me.email)){
        emps.unshift({ name: me.name || titleCase(String(me.email||"").replace(/@.*/,"").replace(/\./g," ")), email: me.email||"" });
      }

      emps = emps.filter(x=>x.name).sort((a,b)=>a.name.localeCompare(b.name));
      submittedBySel.innerHTML = emps.map(e=>`<option value="${esc(e.name)}" data-email="${esc(e.email)}">${esc(e.name)}</option>`).join("");

      let idx = emps.findIndex(e => norm(e.email)===norm(me.email));
      if (idx<0) idx = emps.findIndex(e => norm(e.name)===norm(me.name));
      if (idx>=0) submittedBySel.selectedIndex = idx;
    }

    const DATA_FIELDS = () => Array.from(document.querySelectorAll("[data-field]"));
    function collect(){
      const o={}; DATA_FIELDS().forEach(el=>o[el.dataset.field]=el.value);
      const opt = fieldSel.options[fieldSel.selectedIndex];
      o.field = (opt?.dataset?.name || opt?.text || "").trim();
      const sbOpt = submittedBySel.options[submittedBySel.selectedIndex];
      o.submittedByEmail = (sbOpt?.dataset?.email || "").trim();
      o.status="Open"; o.t=Date.now(); o.timestampISO=new Date(o.t).toISOString();
      return o;
    }
    function validate(o){
      if(!o.fieldId || !o.field) return "Please select a field.";
      if(!o.boundaryType) return "Please choose Interior or Exterior.";
      if(!o.scope) return "Please choose Small section or Entire field.";
      if(!o.submittedBy || !o.submittedBy.trim()) return "Please choose who is submitting this.";
      if(!o.when) return "Please set the date.";
      return "";
    }

    async function save(db, obj){
      const ref = await addDoc(collection(db, 'boundary_requests'), {
        ...obj,
        createdAt: serverTimestamp()
      });
      return ref.id;
    }

    $("primary").addEventListener("click", async ()=>{
      const o = collect(); const err = validate(o); if(err){ alert(err); return; }
      summary.hidden=false; summary.textContent="Submitting…";
      try{
        const db = getFirestore();
        await save(db, o);
        summary.innerHTML = `<strong>Submitted:</strong> ${esc(o.field)}${o.boundaryType?` • ${esc(o.boundaryType)}`:""}${o.when?` • ${new Date(o.when).toLocaleDateString()}`:""}`;
        fieldSel.selectedIndex=0; ["boundaryType","scope"].forEach(id=>document.getElementById(id).selectedIndex=0);
        when.value=todayISO(); notes.value="";
        window.scrollTo({top:0,behavior:"smooth"});
      }catch(e){
        alert("Save failed: " + e.message);
        summary.hidden=true;
      }
    });

    $("clear").addEventListener("click", ()=>{
      fieldSel.selectedIndex=0; ["boundaryType","scope"].forEach(id=>document.getElementById(id).selectedIndex=0);
      when.value=todayISO(); notes.value=""; summary.hidden=true;
    });

    // ===== Boot with the SAME modular flow as Fields page =====
    (async function(){
      const ctx = await ready; // waits Firebase init + (typically) auth
      const db = getFirestore();
      await loadFields(db);
      await loadEmployees(db);
    })();
  </script>
</body>
</html>
