<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>FarmVista • Field Boundary Fix Request</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#3B7E46">

  <!-- Absolute paths -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest">
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png">
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png">

  <!-- CSS -->
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css">
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css">

  <!-- Boot + data helpers -->
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <script src="/Farm-vista/js/firebase-config.js"></script>
  <script src="/Farm-vista/js/fv-data.js"></script>
  <script>(function(){ if(!customElements.get('fv-shell')){ const s=document.createElement('script'); s.src='/Farm-vista/js/fv-shell.js'; s.defer=true; document.head.appendChild(s);} })();</script>

  <style>
    :root{ --card-max:1100px; --page-bottom-gap:96px; --accent:#2F6C3C; --hero-icon-col:36px; --hero-icon-size:24px; }
    body{ background:var(--app-bg,var(--surface)); }
    .wrap{max-width:var(--card-max);margin:0 auto;padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px)+var(--ftr-h,42px)+var(--page-bottom-gap))!important;}
    .hero{border:1px solid var(--border);border-radius:14px;background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));overflow:hidden;margin-bottom:var(--page-bottom-gap);}
    .hero-head{display:grid;grid-template-columns:var(--hero-icon-col) 1fr;gap:12px;align-items:center;
      padding:14px 16px;background:linear-gradient(90deg,rgba(47,108,60,.12),transparent);border-bottom:1px solid var(--border);}
    .hero-head .icon{width:var(--hero-icon-size);height:var(--hero-icon-size);color:var(--accent);display:grid;place-items:center;}
    .hero-head h1{margin:0;font-size:clamp(20px,3.2vw,26px);line-height:1.2}
    .muted{color:var(--muted,#67706B)}
    .body{padding:16px;display:grid;gap:14px}
    .row{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    @media (max-width:880px){.row{grid-template-columns:1fr}}
    .field label{display:block;font-weight:800;margin:0 0 6px}
    .input,.select,.textarea{width:100%;font:inherit;font-size:16px;color:var(--text);
      background:var(--card-surface,var(--surface));border:1px solid var(--border);border-radius:10px;padding:12px;outline:none}
    .textarea{min-height:110px;resize:vertical}
    .help{font-size:13px;color:var(--muted,#67706B);margin-top:6px}
    .actions{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:6px}
    .btn{display:inline-flex;align-items:center;justify-content:center;min-width:160px;padding:12px 16px;border-radius:12px;
      border:1px solid var(--border);background:var(--card-surface,var(--surface));font-weight:800;color:var(--text)!important;cursor:pointer}
    .btn-primary{border-color:transparent;background:#2F6C3C;color:#fff!important}
    .thumbs{display:flex;gap:10px;flex-wrap:wrap}
    .thumb{width:92px;height:92px;border:1px solid var(--border);border-radius:10px;overflow:hidden;display:grid;place-items:center;background:#f6f7f6;position:relative}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .thumb .tools{position:absolute;inset:auto 6px 6px 6px;display:flex;gap:6px}
    .thumb .tools button{font-size:12px;padding:4px 6px;border-radius:8px;border:1px solid var(--border);background:var(--surface);cursor:pointer}
    .modal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.42);z-index:9999;transition:opacity .15s;opacity:0}
    .modal[open]{display:grid;opacity:1}
    .dialog{width:min(760px,92vw);max-height:85vh;display:flex;flex-direction:column;background:var(--surface);color:var(--text);
      border-radius:14px;border:1px solid var(--border);box-shadow:0 16px 36px rgba(0,0,0,.28)}
    .dialog-head{padding:12px 14px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .dialog-body{padding:14px;overflow:auto;flex:1 1 auto;min-height:0;-webkit-overflow-scrolling:touch}
    .dialog-foot{display:flex;gap:10px;justify-content:flex-end;padding:12px 14px;border-top:1px solid var(--border)}
    .closex{border:1px solid var(--border);background:var(--surface);border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:700;color:var(--text)!important}
    html.no-scroll, body.no-scroll{overflow:hidden}
    .note{font-size:13px;padding:8px 10px;border-radius:10px;border:1px dashed var(--border);background:linear-gradient(180deg,rgba(47,108,60,.06),transparent)}
  </style>
</head>
<body>
  <fv-shell>
    <div class="wrap">
      <section class="hero">
        <header class="hero-head">
          <div class="icon" aria-hidden="true">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
            <rect x="3" y="4" width="18" height="12" rx="2"/><path d="M7 20h10M9 16v4M15 16v4"/><circle cx="17.5" cy="9.5" r="2"/></svg>
          </div>
          <div>
            <h1>Field Boundary Fix Request</h1>
            <p class="muted">Pick a field, mark Interior or Exterior, describe what’s off, and attach photos.</p>
          </div>
        </header>

        <div class="body">
          <div class="row">
            <div class="field">
              <label for="fieldName">Field</label>
              <select id="fieldName" class="select" data-field="fieldId" data-label="Field">
                <option value="">— Select field —</option>
              </select>
              <div class="help" id="fieldHelp"></div>
            </div>
            <div class="field">
              <label for="boundaryType">Boundary Type</label>
              <select id="boundaryType" class="select" data-field="boundaryType" data-label="Boundary Type">
                <option value="">—</option>
                <option>Exterior</option>
                <option>Interior</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="scope">Scope</label>
              <select id="scope" class="select" data-field="scope" data-label="Scope">
                <option value="">—</option>
                <option>Small section</option>
                <option>Entire field</option>
              </select>
            </div>
            <div class="field">
              <label for="when">Date</label>
              <input id="when" type="date" class="input" data-field="when" data-label="Date">
            </div>
          </div>

          <div class="row">
            <div class="field">
              <label for="submittedBy">Submitted By</label>
              <select id="submittedBy" class="select" data-field="submittedBy" data-label="Submitted By"></select>
              <div class="help">Defaults to the currently signed-in user.</div>
            </div>
            <div class="field"></div>
          </div>

          <div class="field">
            <label for="notes">Notes</label>
            <textarea id="notes" class="textarea" placeholder="Describe what’s wrong and where (e.g., NW corner 50–80 ft too wide)" data-field="notes" data-label="Notes"></textarea>
          </div>

          <div class="field">
            <label for="photos">Photos (optional)</label>
            <input id="photos" class="input" type="file" accept="image/*,.jpg,.jpeg,.png,.heic" multiple>
            <div id="thumbs" class="thumbs" aria-live="polite"></div>
            <div id="photoNote" class="help"></div>
          </div>

          <div class="actions">
            <button id="clear" class="btn" type="button">Clear Inputs</button>
            <button id="primary" class="btn btn-primary" type="button">Submit Request</button>
          </div>

          <div id="summary" class="panel note" hidden></div>
        </div>
      </section>
    </div>
  </fv-shell>

  <div id="modal" class="modal" aria-hidden="true">
    <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="mdTitle">
      <div class="dialog-head">
        <h3 id="mdTitle">Annotate Photo</h3>
        <button class="closex" id="mdClose" type="button">Back</button>
      </div>
      <div class="dialog-body" id="mdBody"></div>
      <div class="dialog-foot" id="mdFoot" hidden>
        <button class="btn" id="mdReset" type="button">Clear</button>
        <button class="btn btn-primary" id="mdSave" type="button">Save Annotation</button>
      </div>
    </div>
  </div>

  <script type="module">
    const $ = id => document.getElementById(id);
    const DEBUG = location.hash.includes('debug');

    const COLL_REQUESTS = "boundary_requests";
    const COLL_FIELDS   = "fields";
    const COLL_EMPLOYEES= "employees";
    const STORAGE_FOLDER= "boundary-photos";

    const fb = window.firebase || {};
    const HAS_FS  = !!(fb && fb.firestore);
    const HAS_STG = !!(fb && fb.storage);
    const db  = HAS_FS  ? fb.firestore() : null;
    const stg = HAS_STG ? fb.storage()   : null;

    const todayISO = ()=> new Date(Date.now()-new Date().getTimezoneOffset()*60000).toISOString().slice(0,10);
    const esc = s => String(s||"").replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;",'"':"&quot;","'":"&#39;"}[m]));

    const fieldSel = $("fieldName");
    const fieldHelp = $("fieldHelp");
    const submittedBySel = $("submittedBy");
    const when = $("when");
    const boundaryType = $("boundaryType");
    const scope = $("scope");
    const notes = $("notes");
    const photos = $("photos");
    const thumbs = $("thumbs");
    const photoNote = $("photoNote");
    const summary = $("summary");

    when.value = todayISO();

    /* ===== Robust waits (avoid racing Firebase init/auth) ===== */
    async function waitForFirebaseReady(maxMs=8000){
      const t0 = Date.now();
      while (Date.now()-t0 < maxMs) {
        if (window.firebase?.apps?.length) return true;
        await new Promise(r=>setTimeout(r,100));
      }
      return true;
    }
    async function waitAuthReady(maxMs=8000){
      if (!fb?.auth) return null;
      const cur = fb.auth().currentUser;
      if (cur) return cur;
      return new Promise(resolve=>{
        const to = setTimeout(()=>{ off&&off(); resolve(null); }, maxMs);
        const off = fb.auth().onAuthStateChanged(u=>{ clearTimeout(to); off&&off(); resolve(u||null); });
      });
    }
    async function fvReady(){
      if(!window.FVData) return null;
      if(FVData.ready) await FVData.ready();
      return FVData;
    }

    function titleCase(s){
      return String(s||"").toLowerCase().split(/[\s._-]+/).filter(Boolean).map(w=>w[0].toUpperCase()+w.slice(1)).join(" ");
    }
    async function currentUserIdentity(){
      const ctx = window.FVUserContext || {};
      const ctxName = ctx.displayName || ctx.name;
      const ctxEmail = ctx.email;
      if (ctxName || ctxEmail) {
        return { name: ctxName ? ctxName : (ctxEmail ? titleCase(String(ctxEmail).replace(/@.*/,"").replace(/\./g," ")) : ""), email: ctxEmail || "" };
      }
      const u = await waitAuthReady();
      if (u) {
        const email = u.email || "";
        const name = u.displayName || (email ? titleCase(email.replace(/@.*/,"").replace(/\./g," ")) : "");
        return { name, email };
      }
      return { name:"", email:"" };
    }

    /* ---------- Fields: exact 3-step loader like Grain Bags ---------- */
    async function loadFields(){
      let rows = [];
      try{
        const FV = await fvReady();
        if (FV?.list) rows = await FV.list(COLL_FIELDS, { limit: 5000 });
        if ((!rows || !rows.length) && FV?.loadAll) rows = await FV.loadAll(COLL_FIELDS);
        if (DEBUG) console.log('[fields] FVData rows:', rows?.length);
      }catch(e){ if (DEBUG) console.warn('[fields] FVData error', e); }

      if ((!rows || !rows.length) && db){
        try{
          const snap = await db.collection(COLL_FIELDS).get(); // no where/orderBy → no index needed
          rows = snap.docs.map(d=>({ id:d.id, data:d.data() }));
          if (DEBUG) console.log('[fields] Firestore rows:', rows?.length);
        }catch(e){ if (DEBUG) console.warn('[fields] Firestore error', e); }
      }

      const items = (rows||[])
        .map(r => {
          const d = r.data ?? r;
          return { id: r.id || r.key || r.docId, name: (d?.name ?? r.name ?? "").trim() };
        })
        .filter(x => x.id && x.name)
        .sort((a,b)=>a.name.localeCompare(b.name));

      fieldSel.innerHTML = '<option value="">— Select field —</option>' +
        items.map(x=>`<option value="${esc(x.id)}" data-name="${esc(x.name)}">${esc(x.name)}</option>`).join("");

      fieldHelp.textContent = `${items.length} fields`;
      if (DEBUG) console.log('[fields] rendered', items.length);
    }

    /* ---------- Employees + default to current user ---------- */
    function empName(d){
      const full = (d.fullName||"").trim();
      if(full) return full;
      const fn = (d.firstName||"").trim(), ln=(d.lastName||"").trim();
      if(fn||ln) return (fn+" "+ln).trim();
      if(d.displayName) return d.displayName;
      if(d.name) return d.name;
      return (d.email||"").replace(/@.*/,"");
    }
    async function loadEmployees(){
      const me = await currentUserIdentity();
      let emps=[];
      try{
        const FV = await fvReady();
        const rows = FV?.list ? await FV.list(COLL_EMPLOYEES,{limit:5000}) : (FV?.loadAll ? await FV.loadAll(COLL_EMPLOYEES) : []);
        emps = (rows||[]).map(r => { const d = r.data ?? r; return { id:r.id || d.email || empName(d), email:d.email||"", name: empName(d) }; });
      }catch(e){ if (DEBUG) console.warn('[employees] FV error', e); }

      if ((!emps || !emps.length) && db){
        try{
          const snap = await db.collection(COLL_EMPLOYEES).get();
          emps = snap.docs.map(doc => { const d = doc.data(); return { id:doc.id, email:d.email||"", name: empName(d) }; });
        }catch(e){ if (DEBUG) console.warn('[employees] FS error', e); }
      }

      const norm = s => String(s||"").trim().toLowerCase();
      const hasMe = emps.some(e => (e.email && norm(e.email)===norm(me.email)) || norm(e.name)===norm(me.name));
      if(!hasMe && (me.name || me.email)){
        emps.unshift({ id: me.email || "current-user", email: me.email || "", name: me.name || titleCase((me.email||"").replace(/@.*/,"").replace(/\./g," ")) });
      }

      emps = emps.filter(x=>x.name).sort((a,b)=>a.name.localeCompare(b.name));
      submittedBySel.innerHTML = emps.map(e=>`<option value="${esc(e.name)}" data-email="${esc(e.email)}">${esc(e.name)}</option>`).join("");

      let idx = emps.findIndex(e => e.email && norm(e.email)===norm(me.email));
      if (idx<0) idx = emps.findIndex(e => norm(e.name)===norm(me.name));
      if (idx>=0) submittedBySel.selectedIndex = idx;

      if (DEBUG) console.log('[employees] rendered', emps.length, 'default idx', idx, 'me', me);
    }

    /* ---------- Photos & annotate (unchanged) ---------- */
    let selectedFiles = [];
    photos.addEventListener("change", ()=>{
      selectedFiles = Array.from(photos.files||[]);
      renderThumbs();
      photoNote.textContent = (window.FVData||stg) ? "Photos will upload with the request." : "Preview only (no cloud upload available).";
    });
    function renderThumbs(){
      thumbs.innerHTML = "";
      selectedFiles.forEach((file, idx)=>{
        const div = document.createElement("div"); div.className="thumb";
        const img = document.createElement("img"); img.alt=file.name; img.src=URL.createObjectURL(file);
        const tools = document.createElement("div"); tools.className="tools";
        const btnAnn = document.createElement("button"); btnAnn.textContent="Annotate";
        const btnRm  = document.createElement("button"); btnRm.textContent="Remove";
        btnAnn.addEventListener("click", ()=> openAnnotate(idx));
        btnRm.addEventListener("click", ()=>{ selectedFiles.splice(idx,1); renderThumbs(); });
        tools.appendChild(btnAnn); tools.appendChild(btnRm);
        div.appendChild(img); div.appendChild(tools); thumbs.appendChild(div);
      });
    }
    const modal = $("modal"), mdBody=$("mdBody"), mdClose=$("mdClose"), mdFoot=$("mdFoot"), mdReset=$("mdReset"), mdSave=$("mdSave");
    let ann = { canvas:null, ctx:null, drawing:false, img:null, idx:null, scale:1 };
    function openAnnotate(idx){
      const file = selectedFiles[idx]; if(!file) return;
      ann.idx=idx;
      mdBody.innerHTML = `<canvas id="annCvs" style="max-width:100%;touch-action:none"></canvas>`;
      mdFoot.hidden = false;
      const cvs = $("annCvs"); ann.canvas=cvs; ann.ctx=cvs.getContext("2d");
      const img = new Image(); ann.img=img;
      img.onload = ()=>{
        const maxW = Math.min(720, window.innerWidth*0.9);
        const scale = Math.min(1, maxW / img.width);
        ann.scale = scale;
        cvs.width = Math.round(img.width * scale);
        cvs.height= Math.round(img.height* scale);
        ann.ctx.drawImage(img,0,0,cvs.width,cvs.height);
        ann.ctx.lineWidth = 3; ann.ctx.strokeStyle = "#ff0000";
      };
      img.src = URL.createObjectURL(file);
      const pos = e => { const r=cvs.getBoundingClientRect(); if(e.touches?.length){ return {x:e.touches[0].clientX-r.left, y:e.touches[0].clientY-r.top}; } return {x:e.clientX-r.left, y:e.clientY-r.top}; };
      const start = e=>{ ann.drawing=true; const p=pos(e); ann.ctx.beginPath(); ann.ctx.moveTo(p.x,p.y); e.preventDefault(); };
      const move  = e=>{ if(!ann.drawing) return; const p=pos(e); ann.ctx.lineTo(p.x,p.y); ann.ctx.stroke(); e.preventDefault(); };
      const end   = ()=>{ ann.drawing=false; };
      cvs.addEventListener("mousedown", start); cvs.addEventListener("mousemove", move); window.addEventListener("mouseup", end);
      cvs.addEventListener("touchstart", start,{passive:false}); cvs.addEventListener("touchmove", move,{passive:false}); window.addEventListener("touchend", end);
      openModal("Annotate Photo");
    }
    mdReset.addEventListener("click", ()=>{ if(ann.img && ann.canvas){ ann.ctx.clearRect(0,0,ann.canvas.width,ann.canvas.height); ann.ctx.drawImage(ann.img,0,0,ann.canvas.width,ann.canvas.height); } });
    mdSave.addEventListener("click", async ()=>{
      if(!ann.canvas || ann.idx==null) return;
      ann.canvas.toBlob(b=>{
        if(!b) return;
        const orig = selectedFiles[ann.idx];
        const ext = (orig?.name||"image").replace(/^.*(\.\w+)$/,'$1') || ".png";
        const named = new File([b], (orig?.name?.replace(/\.\w+$/,'')||"annotated") + "-annotated"+ext, { type: b.type || "image/png" });
        selectedFiles.splice(ann.idx,1,named);
        renderThumbs();
        closeModal();
      }, "image/png", 0.92);
    });
    function openModal(title){ document.getElementById("mdTitle").textContent = title || "Details"; modal.setAttribute("open",""); modal.setAttribute("aria-hidden","false"); document.documentElement.classList.add("no-scroll"); document.body.classList.add("no-scroll"); }
    function closeModal(){ modal.removeAttribute("open"); modal.setAttribute("aria-hidden","true"); mdBody.innerHTML = ""; mdFoot.hidden=true; ann={canvas:null,ctx:null,drawing:false,img:null,idx:null,scale:1}; document.documentElement.classList.remove("no-scroll"); document.body.classList.remove("no-scroll"); }
    mdClose.addEventListener("click", closeModal);
    modal.addEventListener("click", e=>{ if(e.target===modal) closeModal(); });
    document.addEventListener("keydown", e=>{ if(e.key==="Escape" && modal.hasAttribute("open")) closeModal(); });

    /* ---------- Collect / Validate ---------- */
    const FIELDS = Array.from(document.querySelectorAll("[data-field]"));
    function collect(){
      const o={}; FIELDS.forEach(el=>o[el.dataset.field]=el.value);
      const opt = fieldSel.options[fieldSel.selectedIndex];
      o.field = (opt?.dataset?.name || opt?.text || "").trim();
      const sbOpt = submittedBySel.options[submittedBySel.selectedIndex];
      o.submittedByEmail = (sbOpt?.dataset?.email || "").trim();
      o.status="Open"; o.t=Date.now(); o.timestampISO=new Date(o.t).toISOString();
      return o;
    }
    function validate(o){
      if(!o.fieldId || !o.field) return "Please select a field.";
      if(!o.boundaryType) return "Please choose Interior or Exterior.";
      if(!o.scope) return "Please choose Small section or Entire field.";
      if(!o.submittedBy || !o.submittedBy.trim()) return "Please choose who is submitting this.";
      if(!o.when) return "Please set the date.";
      return "";
    }

    /* ---------- Save / Upload ---------- */
    async function fvAdd(coll,obj){
      try{
        const FV = await fvReady();
        if (FV?.add) {
          const id = await FV.add(coll,obj);
          return typeof id==="string" ? id : (id?.id || id?.key || null);
        }
        if (FV?.save) {
          const r = await FV.save(coll,obj);
          return typeof r==="string" ? r : (r?.id || r?.key || null);
        }
      }catch(e){ if (DEBUG) console.warn('[fvAdd] error', e); }
      if (db){
        const FieldValue = fb.firestore.FieldValue;
        const ref = await db.collection(coll).add({ ...obj, createdAt: FieldValue?.serverTimestamp ? FieldValue.serverTimestamp() : null });
        return ref.id;
      }
      throw new Error('No datastore available');
    }
    async function uploadPhotos(docId, files){
      if(!files.length) return [];
      try{
        const FV = await fvReady();
        const out=[];
        for(const f of files){
          const safe=(Date.now()+"-"+f.name).replace(/[^\w.\-]+/g,"_");
          const path = `${STORAGE_FOLDER}/${docId}/${safe}`;
          const res = FV?.upload ? await FV.upload(path,f,{contentType:f.type}) : null;
          const url = res?.url || (FV?.getDownloadURL ? await FV.getDownloadURL(path) : null);
          out.push({name:f.name,url:url||""});
        }
        return out;
      }catch(e){ if (DEBUG) console.warn('[upload] FV error', e); }
      if (stg){
        const out=[];
        for(const f of files){
          const safe=(Date.now()+"-"+f.name).replace(/[^\w.\-]+/g,"_");
          const ref = stg.ref().child(`${STORAGE_FOLDER}/${docId}/${safe}`);
          await ref.put(f);
          const url = await ref.getDownloadURL();
          out.push({name:f.name,url});
        }
        return out;
      }
      return [];
    }

    /* ---------- Actions ---------- */
    $("primary").addEventListener("click", async ()=>{
      const o = collect(); const err = validate(o); if(err){ alert(err); return; }
      if(!o.when) o.when = todayISO();
      summary.hidden=false; summary.textContent="Submitting…";
      try{
        const id = await fvAdd(COLL_REQUESTS,o);
        const uploaded = await uploadPhotos(id, selectedFiles);
        if(uploaded.length){
          try{
            const FV = await fvReady();
            if(FV?.update) await FV.update(COLL_REQUESTS, id, { photos: uploaded });
            else if(db) await db.collection(COLL_REQUESTS).doc(id).update({ photos: uploaded });
          }catch(_){}
        }
        summary.innerHTML = `<strong>Submitted:</strong> ${esc(o.field)}${o.boundaryType?` • ${esc(o.boundaryType)}`:""}${o.when?` • ${new Date(o.when).toLocaleDateString()}`:""}`;
        fieldSel.selectedIndex = 0; ["boundaryType","scope"].forEach(i=>$(i).selectedIndex=0);
        when.value=todayISO(); notes.value=""; photos.value=""; selectedFiles=[]; renderThumbs();
        window.scrollTo({top:0,behavior:"smooth"});
      }catch(e){
        console.error(e); alert("Sorry, something went wrong saving the request."); summary.hidden=true;
      }
    });

    $("clear").addEventListener("click", ()=>{
      fieldSel.selectedIndex = 0; ["boundaryType","scope"].forEach(i=>$(i).selectedIndex=0);
      when.value=todayISO(); notes.value=""; photos.value=""; selectedFiles=[]; renderThumbs();
      summary.hidden=true;
    });

    /* ---------- Boot (wait for Firebase + Auth first) ---------- */
    (async function boot(){
      await waitForFirebaseReady();
      await waitAuthReady();
      await loadFields();
      await loadEmployees();
    })();
  </script>
</body>
</html>
