<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>FarmVista - Vehicle Registration</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="theme-color" content="#3B7E46">

  <!-- paths from /pages/office/vehicle-registration.html -->
  <link rel="manifest" href="../../manifest.webmanifest">
  <link rel="stylesheet" href="../../assets/css/theme.css">
  <link rel="stylesheet" href="../../assets/css/app.css">
  <script defer src="../../js/theme-boot.js"></script>
  <script defer src="../../js/fv-shell.js"></script>

  <style>
    :root{
      --card-max: 1100px;
      --page-bottom-gap: 96px; /* keep clear of fixed footer */
      --accent: #2F6C3C;
    }
    html{-webkit-text-size-adjust:100%}
    body{ background: var(--app-bg, var(--surface)); }

    .wrap{
      max-width: var(--card-max);
      margin: 0 auto;
      padding: clamp(14px,3vw,22px);
      padding-bottom: calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + var(--page-bottom-gap)) !important;
    }

    /* Hero card */
    .hero{
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));
      overflow:hidden;
      margin-bottom: var(--page-bottom-gap);
    }
    .hero-head{
      display:flex; gap:12px; align-items:flex-start;
      padding:14px 16px;
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);
      border-bottom:1px solid var(--border);
    }
    .hero-head .icon{ width:28px; height:28px; color:var(--accent); margin-top:2px; }
    .hero-head h1{ margin:0; font-size:clamp(20px,3.2vw,26px); line-height:1.2; }
    .muted{ color:var(--muted,#67706B); }

    /* Form layout */
    .body{ padding:16px; display:grid; gap:14px; }
    .row{
      display:grid; gap:10px;
      grid-template-columns: 1fr 1fr;
    }
    .row-3{ grid-template-columns: 1fr 1fr 1fr; }
    .row-4{ grid-template-columns: 1fr 1fr 1fr 1fr; }
    @media (max-width:880px){ .row, .row-3, .row-4 { grid-template-columns: 1fr; } }

    .field label{ display:block; font-weight:800; margin:0 0 6px 0; }
    .input, .select, .textarea{
      width:100%; font:inherit; font-size:16px;
      color:var(--text);
      background:var(--card-surface,var(--surface));
      border:1px solid var(--border);
      border-radius:10px;
      padding:12px 12px;
      outline:none;
    }
    .textarea{ min-height:88px; resize:vertical; }

    /* Buttons row */
    .actions{
      display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-top:6px;
    }
    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      min-width:160px; padding:12px 16px; border-radius:12px; border:1px solid var(--border);
      font-weight:800; text-decoration:none; cursor:pointer; user-select:none;
      color:var(--text) !important; background:var(--card-surface,var(--surface));
    }
    .btn-primary{
      border-color:transparent; background:#2F6C3C; color:#fff !important;
    }

    /* Summary card */
    .summary{
      border:1px solid var(--border); border-radius:12px; padding:14px;
      background:linear-gradient(180deg, rgba(47,108,60,.06), transparent);
    }

    /* History list */
    .hist-head{ display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-top:1px solid var(--border); }
    .hist-title{ font-size:clamp(18px, 2.6vw, 22px); font-weight:800; }
    .hist-clear{ border:1px solid var(--border); background:var(--surface); border-radius:10px; padding:8px 12px; font-weight:700; cursor:pointer; color:var(--text) !important; }
    .hist{ padding:14px 16px; display:grid; gap:12px; }
    .hist-item{
      border:1px solid var(--border); border-radius:12px; padding:12px; background:var(--card-surface,var(--surface));
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
    }
    .hist-item .hline{ font-weight:800; }
    .hist-item .view{ border:1px solid var(--border); background:var(--surface); border-radius:10px; padding:8px 12px; font-weight:700; cursor:pointer; color:var(--text) !important; }

    /* Modal dialog (same pattern you liked) */
    .modal{ position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.42);
      z-index:9999; transition:opacity .15s; opacity:0; }
    .modal[open]{ display:grid; opacity:1; }
    .dialog{ width:min(760px,92vw); max-height:85vh; display:flex; flex-direction:column; background:var(--surface); color:var(--text);
      border-radius:14px; border:1px solid var(--border); box-shadow:0 16px 36px rgba(0,0,0,.28); }
    .dialog-head{ padding:12px 14px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
    .dialog-body{ padding:14px; overflow:auto; flex:1 1 auto; min-height:0; -webkit-overflow-scrolling:touch; }
    .closex{
      border:1px solid var(--border); background:var(--surface); border-radius:10px;
      padding:8px 12px; cursor:pointer; font-weight:700; color:var(--text) !important;
    }
    .kv{ display:grid; grid-template-columns:1fr auto; gap:8px 12px; align-items:baseline; }
    .kv .val{ font-weight:800; }

    html.no-scroll, body.no-scroll{ overflow:hidden; }
  </style>
</head>
<body>
  <fv-shell>
    <div class="wrap">
      <section class="hero">
        <header class="hero-head">
          <div class="icon" aria-hidden="true">
            <!-- simple license-plate icon -->
            <svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="5" width="18" height="14" rx="2"/>
              <path d="M7 9h4M15 9h2M7 15h10"/>
            </svg>
          </div>
          <div>
            <h1>Vehicle Registration</h1>
            <p class="muted">Choose an asset (truck or trailer) or enter details, then Save Registration. History keeps the last 10.</p>
          </div>
        </header>

        <div class="body">
          <!-- Asset selection -->
          <div class="row">
            <div class="field">
              <label for="asset">Asset</label>
              <select id="asset" class="select">
                <option value="">Manual entryâ€¦</option>
              </select>
            </div>
            <div class="field">
              <label for="unit">Unit ID / Nickname</label>
              <input id="unit" class="input" placeholder="e.g., Pete 579 #12">
            </div>
          </div>

          <!-- Identity -->
          <div class="row-4">
            <div class="field">
              <label for="type">Type</label>
              <select id="type" class="select">
                <option value="truck">Truck</option>
                <option value="trailer">Trailer</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="field">
              <label for="year">Year</label>
              <input id="year" class="input" inputmode="numeric" pattern="[0-9]{4}" maxlength="4" placeholder="e.g., 2021">
            </div>
            <div class="field">
              <label for="make">Make</label>
              <input id="make" class="input" placeholder="e.g., Peterbilt">
            </div>
            <div class="field">
              <label for="model">Model</label>
              <input id="model" class="input" placeholder="e.g., 579">
            </div>
          </div>

          <!-- VIN / Plate -->
          <div class="row-3">
            <div class="field">
              <label for="vin">VIN</label>
              <input id="vin" class="input" maxlength="17" placeholder="17 chars" style="text-transform:uppercase">
            </div>
            <div class="field">
              <label for="plate">Plate #</label>
              <input id="plate" class="input" placeholder="e.g., 123 456">
            </div>
            <div class="field">
              <label for="state">State</label>
              <select id="state" class="select"></select>
            </div>
          </div>

          <!-- Registration specifics -->
          <div class="row-3">
            <div class="field">
              <label for="regtype">Registration Type</label>
              <select id="regtype" class="select">
                <option value="farm">Farm</option>
                <option value="apportioned">Apportioned (IRP)</option>
                <option value="commercial">Commercial</option>
                <option value="trailer">Trailer</option>
                <option value="other">Other</option>
              </select>
            </div>
            <div class="field">
              <label for="gvwr">GVWR</label>
              <input id="gvwr" class="input" inputmode="numeric" placeholder="e.g., 80,000 lb">
            </div>
            <div class="field">
              <label for="exp">Expiration</label>
              <input id="exp" class="input" type="date">
            </div>
          </div>

          <!-- Insurance -->
          <div class="row-3">
            <div class="field">
              <label for="carrier">Insurance Carrier</label>
              <input id="carrier" class="input" placeholder="e.g., Farm Bureau">
            </div>
            <div class="field">
              <label for="policy">Policy #</label>
              <input id="policy" class="input" placeholder="e.g., ABC-123456">
            </div>
            <div class="field">
              <label for="iexp">Policy Expiration</label>
              <input id="iexp" class="input" type="date">
            </div>
          </div>

          <div class="field">
            <label for="notes">Notes</label>
            <textarea id="notes" class="textarea" placeholder="Optional notes (permits, IFTA, DOT, etc.)"></textarea>
          </div>

          <!-- Actions -->
          <div class="actions">
            <button id="clear" class="btn" type="button">Clear Inputs</button>
            <button id="save" class="btn btn-primary" type="button">Save Registration</button>
          </div>

          <!-- Simple summary preview -->
          <div id="summary" class="summary" hidden></div>
        </div>

        <!-- History -->
        <div class="hist-head">
          <div class="hist-title">Previous Registrations</div>
          <button id="clearHist" class="hist-clear" type="button">Clear History</button>
        </div>
        <div id="history" class="hist">
          <div class="muted">No previous registrations.</div>
        </div>
      </section>
    </div>
  </fv-shell>

  <!-- Modal -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="mdTitle">
      <div class="dialog-head">
        <h3 id="mdTitle">Registration Details</h3>
        <button class="closex" id="mdClose" type="button">Back</button>
      </div>
      <div class="dialog-body" id="mdBody"></div>
    </div>
  </div>

  <script>
  (function(){
    "use strict";

    /* ---------- Utilities ---------- */
    function $(id){ return document.getElementById(id); }
    function escapeHTML(s){ return String(s||"").replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&gt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]).replace("&gt;","&gt;")); }
    const fmtComma = n => (n==null || n==="") ? "" : Number(String(n).replace(/,/g,"")).toLocaleString();

    const LS_KEY = "fv_vehicle_regs_v1";
    const MAX_HIST = 10;

    /* ---------- State lists ---------- */
    const STATES = ["AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY"];
    (function fillStates(){
      const sel = $("state"); sel.innerHTML = '<option value="">â€”</option>' + STATES.map(s=>`<option value="${s}">${s}</option>`).join("");
    })();

    /* ---------- Asset feed (trucks + trailers) ---------- */
    function loadAssets(){
      let trucks=[], trailers=[];
      try{ trucks = JSON.parse(localStorage.getItem("fv_trucks_v1")||"[]"); }catch(e){}
      try{ trailers = JSON.parse(localStorage.getItem("fv_trailers_v1")||"[]"); }catch(e){}
      let assets = []
        .concat((Array.isArray(trucks)?trucks:[]).map(t => ({...t, type:"truck"})))
        .concat((Array.isArray(trailers)?trailers:[]).map(t => ({...t, type:"trailer"})));

      // Seed a couple if none present so UI is demonstrable
      if(!assets.length){
        assets = [
          { id:"trk1", type:"truck", unit:"Pete 579 #12", year:2021, make:"Peterbilt", model:"579", vin:"1XPBDP9X1MD123456", plate:"123456", state:"IL" },
          { id:"trl1", type:"trailer", unit:"Wilson 43' Hopper", year:2018, make:"Wilson", model:"PSAG", vin:"1W1MAFZA0J1234567", plate:"T123456", state:"IL" }
        ];
      }
      return assets;
    }

    function fillAssetSelect(){
      const sel = $("asset");
      const assets = loadAssets();
      assets.forEach(a=>{
        const label = `${a.type === "truck" ? "Truck" : "Trailer"} â€¢ ${a.unit || (a.make||"")+" "+(a.model||"")}`.trim();
        const opt = document.createElement("option");
        opt.value = a.id || (a.unit||"");
        opt.textContent = label;
        opt.dataset.payload = JSON.stringify(a);
        sel.appendChild(opt);
      });
    }
    fillAssetSelect();

    $("asset").addEventListener("change", function(){
      const opt = this.selectedOptions[0];
      if(!opt || !opt.dataset.payload) return;
      const a = JSON.parse(opt.dataset.payload);
      $("unit").value = a.unit || "";
      $("type").value = (a.type||"other");
      $("year").value = a.year || "";
      $("make").value = a.make || "";
      $("model").value = a.model || "";
      $("vin").value = (a.vin||"").toUpperCase().slice(0,17);
      $("plate").value = a.plate || "";
      $("state").value = (a.state||"").toUpperCase();
    });

    /* ---------- History helpers ---------- */
    function loadHist(){
      try{
        const arr = JSON.parse(localStorage.getItem(LS_KEY)||"[]");
        return Array.isArray(arr)?arr:[];
      }catch(e){ return []; }
    }
    function saveHist(arr){
      localStorage.setItem(LS_KEY, JSON.stringify(arr.slice(0,MAX_HIST)));
    }

    function renderHist(){
      const box = $("history");
      const h = loadHist();
      if(!h.length){ box.innerHTML = '<div class="muted">No previous registrations.</div>'; return; }
      box.innerHTML = "";
      h.forEach((it, idx)=>{
        const div = document.createElement("div");
        div.className = "hist-item";
        const line = [
          it.unit || (it.year && it.make ? `${it.year} ${it.make} ${it.model||""}`.trim() : "Unit"),
          (it.plate ? `â€¢ ${it.state || ""} ${it.plate}`.trim() : ""),
          (it.exp ? `â€¢ Expires ${new Date(it.exp).toLocaleDateString()}` : "")
        ].join(" ").replace(/\s+/g," ").trim();
        div.innerHTML = `<div class="hline">${escapeHTML(line)}</div>
                         <button class="view" type="button">View</button>`;
        div.querySelector(".view").addEventListener("click", ()=> openDetail(it));
        box.appendChild(div);
      });
    }

    /* ---------- Modal ---------- */
    const modal = $("modal"), mdBody=$("mdBody"), mdClose=$("mdClose");
    let lastFocus=null;
    function openDetail(it){
      $("mdTitle").textContent = (it.unit || `${it.year||""} ${it.make||""} ${it.model||""}`).trim() || "Registration Details";
      mdBody.innerHTML =
        `<div class="kv">
          <div>Type</div><div class="val">${escapeHTML(it.type||"")}</div>
          <div>Unit</div><div class="val">${escapeHTML(it.unit||"")}</div>
          <div>Year</div><div class="val">${escapeHTML(it.year||"")}</div>
          <div>Make</div><div class="val">${escapeHTML(it.make||"")}</div>
          <div>Model</div><div class="val">${escapeHTML(it.model||"")}</div>
          <div>VIN</div><div class="val">${escapeHTML(it.vin||"")}</div>
          <div>Plate</div><div class="val">${escapeHTML((it.state?it.state+" ":"") + (it.plate||""))}</div>
          <div>Reg Type</div><div class="val">${escapeHTML((it.regtype||"").toUpperCase())}</div>
          <div>GVWR</div><div class="val">${escapeHTML(fmtComma(it.gvwr))} lb</div>
          <div>Expiration</div><div class="val">${it.exp? new Date(it.exp).toLocaleDateString():""}</div>
          <div>Insurance</div><div class="val">${escapeHTML(it.carrier||"")}</div>
          <div>Policy #</div><div class="val">${escapeHTML(it.policy||"")}</div>
          <div>Policy Exp.</div><div class="val">${it.iexp? new Date(it.iexp).toLocaleDateString():""}</div>
          ${it.notes ? `<div>Notes</div><div class="val">${escapeHTML(it.notes)}</div>` : ""}
        </div>`;
      modal.setAttribute("open","");
      modal.setAttribute("aria-hidden","false");
      document.documentElement.classList.add("no-scroll"); document.body.classList.add("no-scroll");
      lastFocus=document.activeElement; mdClose.focus();
    }
    function closeModal(){
      modal.removeAttribute("open"); modal.setAttribute("aria-hidden","true");
      document.documentElement.classList.remove("no-scroll"); document.body.classList.remove("no-scroll");
      if(lastFocus && lastFocus.focus) lastFocus.focus();
    }
    mdClose.addEventListener("click", closeModal);
    modal.addEventListener("click", e=>{ if(e.target===modal) closeModal(); });
    document.addEventListener("keydown", e=>{ if(e.key==="Escape" && modal.hasAttribute("open")) closeModal(); });

    /* ---------- Save / Clear ---------- */
    function collect(){
      const it = {
        t: Date.now(),
        assetId: $("asset").value || "",
        unit: $("unit").value.trim(),
        type: $("type").value,
        year: $("year").value.trim(),
        make: $("make").value.trim(),
        model: $("model").value.trim(),
        vin: $("vin").value.trim().toUpperCase().slice(0,17),
        plate: $("plate").value.trim(),
        state: $("state").value.trim().toUpperCase(),
        regtype: $("regtype").value,
        gvwr: $("gvwr").value.replace(/,/g,"").trim(),
        exp: $("exp").value,
        carrier: $("carrier").value.trim(),
        policy: $("policy").value.trim(),
        iexp: $("iexp").value,
        notes: $("notes").value.trim()
      };
      return it;
    }

    function validate(it){
      // Require: some identifier (unit or year/make/model), and either VIN or Plate, and an expiration date
      const hasId = it.unit || (it.year && it.make);
      if(!hasId) return "Enter at least Unit or Year + Make.";
      if(!it.vin && !it.plate) return "Enter VIN or Plate #.";
      if(!it.exp) return "Choose an expiration date.";
      return "";
    }

    function showSummary(it){
      const el = $("summary");
      const line = [
        it.unit || `${it.year||""} ${it.make||""} ${it.model||""}`.trim(),
        (it.plate ? `â€¢ ${it.state||""} ${it.plate}` : ""),
        (it.exp ? `â€¢ Expires ${new Date(it.exp).toLocaleDateString()}` : "")
      ].join(" ").replace(/\s+/g," ").trim();
      el.innerHTML = `<strong>Saved:</strong> ${escapeHTML(line)}`;
      el.hidden = false;
    }

    $("gvwr").addEventListener("blur", ()=>{ $("gvwr").value = fmtComma($("gvwr").value); });
    $("vin").addEventListener("input", e=>{ e.target.value = e.target.value.toUpperCase().slice(0,17); });

    $("save").addEventListener("click", function(){
      const it = collect();
      const err = validate(it);
      if(err){
        alert(err);
        return;
      }
      const h = loadHist();
      h.unshift(it);
      saveHist(h);
      renderHist();
      showSummary(it);
      window.scrollTo({top:0, behavior:"smooth"});
    });

    $("clear").addEventListener("click", function(){
      ["asset","unit","type","year","make","model","vin","plate","state","regtype","gvwr","exp","carrier","policy","iexp","notes"].forEach(id=>{
        const el=$(id);
        if(el.tagName==="SELECT") el.selectedIndex = 0;
        else el.value = "";
      });
      $("summary").hidden = true;
    });

    $("clearHist").addEventListener("click", function(){
      if(!confirm("Clear previous registrations?")) return;
      saveHist([]); renderHist();
    });

    /* initial paint */
    renderHist();
  })();
  </script>
</body>
</html>