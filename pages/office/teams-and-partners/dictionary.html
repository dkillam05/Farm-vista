<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista â€¢ Dictionary</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- Standard includes -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>
  <script src="/Farm-vista/js/theme-boot.js" defer></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <style>
    .page{max-width:1100px;margin:0 auto;padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + 72px)!important;}

    .page-title{margin:0 0 8px 0;}
    .page-sub{margin:0 0 14px 0;color:var(--muted,#67706B);}

    .toolbar{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:10px 0 16px}
    .search{flex:1;min-width:220px;display:flex;align-items:center;gap:10px;
      border:1px solid var(--border);border-radius:12px;background:var(--surface);padding:10px 12px;}
    .search input{border:none;outline:none;background:transparent;width:100%;font:inherit;font-size:16px;}
    .count{color:var(--muted,#67706B);font-weight:700}

    .section{border:1px solid var(--border);border-radius:14px;background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));overflow:hidden;}

    .group-head{position:sticky;top:0;background:linear-gradient(90deg, rgba(47,108,60,.10), transparent);
      border-bottom:1px solid var(--border);padding:10px 14px;font-weight:900;color:#2F6C3C;z-index:1}

    .list{display:block}
    .item{padding:14px;border-bottom:1px solid var(--border);display:grid;gap:6px}
    .item:last-child{border-bottom:none}
    .term{display:flex;justify-content:space-between;gap:12px;align-items:flex-start}
    .term strong{font-size:16px}
    .badge{font-size:12px;font-weight:800;color:#2F6C3C;background:#E7F1EA;border:1px solid #CFE4D6;border-radius:999px;padding:2px 8px}

    .short{color:var(--text);opacity:.85}
    .desc{color:var(--muted,#67706B);line-height:1.45}
    .tags{display:flex;gap:8px;flex-wrap:wrap}
    .tag{font-size:12px;border:1px dashed var(--border);border-radius:999px;padding:2px 8px;color:var(--muted,#67706B)}
    .meta{color:var(--muted,#67706B);font-size:12px}

    .empty{padding:24px;text-align:center;color:var(--muted,#67706B)}
  </style>

  <!-- Ensure fv-shell is available -->
  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');s.src='/Farm-vista/js/fv-shell.js';s.defer=true;document.head.appendChild(s);
      }
    })();
  </script>

  <!-- Firebase config + init (module so we can import the helpers) -->
  <script src="/Farm-vista/js/firebase-config.js" defer></script>
  <script type="module" src="/Farm-vista/js/firebase-init.js"></script>
</head>
<body>
  <fv-shell>
    <div class="page container">
      <h1 class="page-title">Dictionary</h1>
      <p class="page-sub">Common terms, acronyms, and definitions used across FarmVista and operations.</p>

      <div class="toolbar">
        <div class="search" role="search">
          <span aria-hidden="true">ðŸ”Ž</span>
          <input id="q" type="search" placeholder="Search term, tag, or descriptionâ€¦" autocomplete="off" />
        </div>
        <div class="count"><span id="shown">0</span>/<span id="total">0</span> items</div>
      </div>

      <section id="dict" class="section">
        <div id="list" class="list" role="list"></div>
        <div id="empty" class="empty" hidden>No entries found.</div>
      </section>
    </div>
  </fv-shell>

  <script type="module">
    import {
      ready,
      getFirestore,
      collection,
      query,
      orderBy,
      onSnapshot
    } from '/Farm-vista/js/firebase-init.js';

    const COLLECTION = 'dictionary'; // change here if your collection name differs

    const $ = id => document.getElementById(id);
    const elList = $('list');
    const elEmpty = $('empty');
    const elShown = $('shown');
    const elTotal = $('total');
    const elQ = $('q');

    let all = [];   // full dataset from Firestore
    let view = [];  // filtered view

    const safe = (v) => (v ?? '');
    const toTags = (t) => Array.isArray(t) ? t : (t ? String(t).split(',') : []);
    const fmtDate = (ts) => {
      try {
        // Support Firestore Timestamp or ISO/string/number
        const d = ts?.toDate ? ts.toDate() : (ts ? new Date(ts) : null);
        if(!d || isNaN(d.getTime())) return '';
        return d.toLocaleDateString(undefined, {year:'numeric', month:'short', day:'2-digit'});
      } catch { return ''; }
    };

    function render(items){
      elList.innerHTML = '';
      if(!items.length){
        elEmpty.hidden = false;
        elShown.textContent = '0';
        elTotal.textContent = String(all.length);
        return;
      }
      elEmpty.hidden = true;

      // Group by first letter of term
      let curHead = '';
      items.forEach(entry=>{
        const letter = (safe(entry.term).trim()[0] || '#').toUpperCase();
        if(letter !== curHead){
          curHead = letter;
          const head = document.createElement('div');
          head.className = 'group-head';
          head.textContent = curHead;
          elList.appendChild(head);
        }
        const row = document.createElement('div');
        row.className = 'item';
        row.setAttribute('role', 'listitem');

        const tags = toTags(entry.tags).map(s=>String(s).trim()).filter(Boolean);

        row.innerHTML = `
          <div class="term">
            <strong>${safe(entry.term) || '(untitled)'}</strong>
            ${entry.short ? `<span class="badge">${safe(entry.short)}</span>` : ''}
          </div>
          ${entry.description ? `<div class="desc">${safe(entry.description)}</div>` : ''}
          ${tags.length ? `<div class="tags">${tags.map(t=>`<span class="tag">#${t}</span>`).join('')}</div>` : ''}
          <div class="meta">${fmtDate(entry.updatedAt || entry.createdAt) ? `Updated ${fmtDate(entry.updatedAt || entry.createdAt)}` : ''}</div>
        `;
        elList.appendChild(row);
      });

      elShown.textContent = String(items.length);
      elTotal.textContent = String(all.length);
    }

    function filter(q){
      const needle = (q||'').toLowerCase().trim();
      if(!needle){ view = all.slice(); render(view); return; }

      view = all.filter(e=>{
        const hay = [
          e.term, e.short, e.description,
          ...(Array.isArray(e.tags)?e.tags: String(e.tags||'').split(','))
        ].join(' ').toLowerCase();
        return hay.includes(needle);
      });
      render(view);
    }

    // Debounce for search input
    let t = 0;
    elQ.addEventListener('input', ()=>{
      clearTimeout(t);
      t = setTimeout(()=>filter(elQ.value), 120);
    });

    // Live Firestore subscription
    (async function init(){
      try{
        await ready; // ensure SDK initialized
        const db = getFirestore();
        const qRef = query(collection(db, COLLECTION), orderBy('term', 'asc'));
        onSnapshot(qRef, (snap)=>{
          const rows = [];
          snap.forEach(doc=>{
            const d = doc.data() || {};
            rows.push({
              id: doc.id,
              term: d.term ?? d.name ?? '',
              short: d.short ?? d.abbrev ?? '',
              description: d.description ?? d.desc ?? '',
              tags: d.tags ?? d.labels ?? [],
              createdAt: d.createdAt ?? null,
              updatedAt: d.updatedAt ?? null
            });
          });
          all = rows;
          filter(elQ.value);
        }, (err)=>{
          console.error('[Dictionary] onSnapshot error:', err);
          elEmpty.hidden = false;
          elEmpty.textContent = 'Failed to load dictionary. Check network and Firestore rules.';
        });
      } catch(err){
        console.error('[Dictionary] init failed:', err);
        elEmpty.hidden = false;
        elEmpty.textContent = 'Failed to initialize Firebase.';
      }
    })();
  </script>
</body>
</html>