<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FarmVista • Add Employee</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
  <meta name="theme-color" content="#3B7E46" />

  <!-- PWA + brand -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest" />
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png" />
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png" />

  <!-- Global theme + auth guard + sync injection -->
  <script defer src="/Farm-vista/js/theme-boot.js"></script>

  <!-- Styles -->
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css" />
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css" />

  <style>
    .page { max-width: 940px; margin: 0 auto; padding: clamp(14px, 3vw, 22px); }
    .form { display: grid; gap: 14px; }
    .row2 { display: grid; gap: 12px; grid-template-columns: 1fr 1fr; }
    @media (max-width: 800px){ .row2 { grid-template-columns: 1fr; } }

    .field { display: grid; gap: 6px; }
    .field label { font-weight: 700; font-size: 14px; color: var(--text); }
    .muted { color: var(--muted); }

    .actions { display: flex; gap: 10px; margin-top: 6px; }
    .btn {
      appearance: none; border: 1px solid var(--border); border-radius: 10px;
      padding: 12px 16px; font-weight: 800; cursor: pointer;
      background: var(--surface); color: var(--text);
    }
    .btn.primary { background: var(--green); color: #fff; border-color: color-mix(in srgb, var(--green) 60%, transparent); }
    .btn.ghost { background: transparent; }
    .btn[disabled] { opacity: .6; cursor: not-allowed; }

    /* full-screen lightweight saving scrim */
    .scrim {
      position: fixed; inset: 0; background: color-mix(in srgb, #000 35%, transparent);
      display: none; align-items: center; justify-content: center; z-index: 2000;
    }
    .scrim.show { display: flex; }
    .spinner {
      width: 46px; height: 46px; border-radius: 50%;
      border: 4px solid color-mix(in srgb, #fff 25%, transparent);
      border-top-color: #fff; animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* little toast */
    .toast {
      position: fixed; left: 50%; bottom: calc(16px + env(safe-area-inset-bottom,0px));
      transform: translateX(-50%); background: #111; color: #fff;
      padding: 10px 14px; border-radius: 10px; box-shadow: 0 14px 36px rgba(0,0,0,.35);
      opacity: 0; pointer-events: none; z-index: 2100; transition: opacity .18s, transform .18s;
      font-size: 14px;
    }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(-4px); }
  </style>
</head>
<body>
  <fv-shell>
    <div class="page container">
      <h1 class="page-title">Add Employee</h1>
      <p class="page-sub">Create a new employee/partner record. You can edit these later from the team list.</p>

      <div class="card">
        <form id="empForm" class="form" novalidate>
          <div class="row2">
            <div class="field">
              <label for="first">First Name</label>
              <input id="first" name="first" class="fv-input" type="text" autocomplete="given-name" required />
            </div>
            <div class="field">
              <label for="last">Last Name</label>
              <input id="last" name="last" class="fv-input" type="text" autocomplete="family-name" required />
            </div>
          </div>

          <div class="row2">
            <div class="field">
              <label for="email">Email</label>
              <input id="email" name="email" class="fv-input" type="email" autocomplete="email" placeholder="you@farm.com" required />
            </div>
            <div class="field">
              <label for="phone">Mobile</label>
              <input id="phone" name="phone" class="fv-input" type="tel" autocomplete="tel" placeholder="(555) 555-5555" />
            </div>
          </div>

          <div class="row2">
            <div class="field">
              <label for="role">Role / Title</label>
              <input id="role" name="role" class="fv-input" type="text" placeholder="Operator, Agronomy, Office…" />
            </div>
            <div class="field">
              <label for="type">Type</label>
              <select id="type" name="type" class="fv-input">
                <option value="employee">Employee</option>
                <option value="contractor">Contractor</option>
                <option value="partner">Partner</option>
              </select>
            </div>
          </div>

          <div class="row2">
            <div class="field">
              <label for="start">Start Date</label>
              <input id="start" name="start" class="fv-input" type="date" />
            </div>
            <div class="field">
              <label for="status">Status</label>
              <select id="status" name="status" class="fv-input">
                <option value="active" selected>Active</option>
                <option value="inactive">Inactive</option>
              </select>
            </div>
          </div>

          <div class="field">
            <label for="perm">Permission Group</label>
            <select id="perm" name="permissionGroup" class="fv-input">
              <option value="standard" selected>Standard</option>
              <option value="manager">Manager</option>
              <option value="admin">Admin</option>
              <option value="read-only">Read-only</option>
            </select>
            <div class="muted" style="font-size:13px">This controls app privileges (you can fine-tune later).</div>
          </div>

          <div class="field">
            <label for="notes">Notes</label>
            <textarea id="notes" name="notes" class="fv-textarea" placeholder="Certifications, endorsements, equipment, etc."></textarea>
          </div>

          <div class="actions">
            <button type="submit" class="btn primary" id="saveBtn">Save Employee</button>
            <button type="button" class="btn ghost" id="cancelBtn">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </fv-shell>

  <!-- Saving overlay + toast -->
  <div class="scrim" id="scrim" aria-hidden="true"><div class="spinner" aria-label="Saving…"></div></div>
  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <!-- Page logic: save to Firestore -->
  <script type="module">
    import { ready, auth, db } from '/Farm-vista/js/firebase-init.js';
    import {
      addDoc, collection, serverTimestamp
    } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js';
    import { onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js';

    await ready;

    const form   = document.getElementById('empForm');
    const saveBtn= document.getElementById('saveBtn');
    const cancel = document.getElementById('cancelBtn');
    const scrim  = document.getElementById('scrim');
    const toast  = document.getElementById('toast');

    const showToast = (msg, ms=1600) => {
      toast.textContent = msg;
      toast.classList.add('show');
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> toast.classList.remove('show'), ms);
    };
    const showScrim = (on) => scrim.classList.toggle('show', !!on);

    cancel.addEventListener('click', () => {
      if (history.length > 1) history.back();
      else location.replace('/Farm-vista/pages/office/teams-and-partners/');
    });

    function getVal(id){ return (document.getElementById(id)?.value || '').trim(); }

    function validate(){
      const first = getVal('first');
      const last  = getVal('last');
      const email = getVal('email');
      if (!first || !last || !email || !email.includes('@')) {
        showToast('Please enter first, last, and a valid email.', 2200);
        return null;
      }
      return {
        first, last, email,
        phone: getVal('phone'),
        role:  getVal('role'),
        type:  getVal('type') || 'employee',
        status:getVal('status') || 'active',
        permissionGroup: getVal('perm') || 'standard',
        startDate: getVal('start') || null,
        notes: getVal('notes')
      };
    }

    let currentUser = null;
    onAuthStateChanged(auth, (u)=> currentUser = u || null);

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const data = validate();
      if (!data) return;

      saveBtn.disabled = true;
      showScrim(true);

      try {
        const payload = {
          ...data,
          displayName: `${data.first} ${data.last}`.trim(),
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
          createdBy: currentUser?.uid || null,
          createdByEmail: currentUser?.email || null,
          // room for future linking (e.g., farm/org ids) if you add later
        };

        await addDoc(collection(db, 'employees'), payload);

        showToast('Employee saved');
        // brief pause so user sees feedback
        setTimeout(()=>{
          if (history.length > 1) history.back();
          else location.replace('/Farm-vista/pages/office/teams-and-partners/');
        }, 500);
      } catch (err) {
        console.warn('[FV] employee save failed:', err);
        showToast('Save failed. Check your connection and try again.', 2600);
      } finally {
        showScrim(false);
        saveBtn.disabled = false;
      }
    });
  </script>

  <noscript>
    <div class="container"><div class="card">JavaScript is required to add employees.</div></div>
  </noscript>
</body>
</html>