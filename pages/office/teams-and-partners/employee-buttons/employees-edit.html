<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista â€¢ Edit Employee</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>
  <script src="/Farm-vista/js/theme-boot.js" defer></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <style>
    .page{max-width:1100px;margin:0 auto;padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + 96px)!important;}
    .page-title{margin:0 0 8px 0;}
    .page-sub{margin:0 0 14px 0;color:var(--muted,#67706B);}

    .section{border:1px solid var(--border);border-radius:14px;background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));overflow:hidden;}
    .section-head{display:grid;grid-template-columns:36px 1fr;gap:12px;align-items:center;
      padding:14px 16px;border-bottom:1px solid var(--border);
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);}
    .section-head .icon{width:24px;height:24px;color:#2F6C3C;display:grid;place-items:center;}
    .section-body{padding:16px;display:grid;gap:14px;}

    .row{display:grid;gap:10px;grid-template-columns:1fr auto}
    @media(max-width:720px){.row{grid-template-columns:1fr}}

    .grid2{display:grid;gap:12px;grid-template-columns:1fr 1fr}
    @media(max-width:720px){.grid2{grid-template-columns:1fr}}

    .field label{display:block;font-weight:800;margin:0 0 6px 0;}
    .input{width:100%;font:inherit;font-size:16px;color:var(--text);background:var(--card-surface,var(--surface));
      border:1px solid var(--border);border-radius:10px;padding:12px;outline:none;}

    .toolbar{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:6px 0 14px}
    .picker{flex:1;min-width:260px;display:flex;gap:10px;align-items:center;
      padding:10px 12px;border:1px solid var(--border);border-radius:12px;background:var(--surface)}
    .picker input{border:none;outline:none;background:transparent;width:100%;font:inherit;font-size:16px;}
    .idnote{color:var(--muted,#67706B);font-size:12px}

    .actions{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .btn{display:inline-flex;align-items:center;justify-content:center;min-width:148px;padding:12px 16px;border-radius:12px;
      border:1px solid var(--border);background:var(--card-surface,var(--surface));font-weight:800;color:var(--text);cursor:pointer;}
    .btn-primary{border-color:transparent;background:#2F6C3C;color:#fff;}
    .btn-accent{border-color:#2F6C3C;background:#E7F1EA;color:#2F6C3C;}
    .btn-quiet{min-width:auto;padding:8px 12px}

    input:-webkit-autofill, input:-webkit-autofill:focus,
    textarea:-webkit-autofill, select:-webkit-autofill{
      -webkit-text-fill-color: var(--text) !important;
      box-shadow: 0 0 0 44px var(--card-surface, var(--surface)) inset !important;
      caret-color: var(--text);
      transition: background-color 9999s ease-in-out 0s;
    }

    .toast{position:fixed;left:50%;bottom:calc(env(safe-area-inset-bottom,0px) + 72px);transform:translateX(-50%);
      background:#2F6C3C;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.25);z-index:99999;display:none;}
    .toast.show{display:block;animation:fadeout 2.8s forwards;}
    @keyframes fadeout{0%{opacity:1}85%{opacity:1}100%{opacity:0}}
  </style>

  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');s.src='/Farm-vista/js/fv-shell.js';s.defer=true;document.head.appendChild(s);
      }
    })();
  </script>

  <!-- Config first so init sees window.FV_FIREBASE_CONFIG -->
  <script src="/Farm-vista/js/firebase-config.js" defer></script>
</head>
<body>
  <fv-shell>
    <div class="page container">
      <h1 class="page-title">Edit Employee</h1>
      <p class="page-sub">Search or open with <span class="idnote">?id=&lt;documentId&gt;</span>. Update info or resend an invite.</p>

      <div class="toolbar">
        <div class="picker">
          <span aria-hidden="true">ðŸ”Ž</span>
          <input id="pick" list="empList" placeholder="Type a name or email to select an employeeâ€¦" autocomplete="off"/>
          <datalist id="empList"></datalist>
        </div>
        <div class="idnote" id="docHint" hidden></div>
      </div>

      <section class="section" aria-live="polite">
        <header class="section-head">
          <div class="icon" aria-hidden="true">ðŸ‘¤</div>
          <div><strong>Employee Details</strong></div>
        </header>

        <div class="section-body">
          <div class="grid2">
            <div class="field">
              <label for="first">First Name</label>
              <input id="first" class="input" type="text" autocomplete="given-name" required />
            </div>
            <div class="field">
              <label for="last">Last Name</label>
              <input id="last" class="input" type="text" autocomplete="family-name" required />
            </div>
          </div>

          <div class="grid2">
            <div class="field">
              <label for="email">Email</label>
              <input id="email" class="input" type="email" autocomplete="email" placeholder="you@farm.com" />
            </div>
            <div class="field">
              <label for="phone">Mobile</label>
              <input id="phone" class="input" type="tel" inputmode="tel" autocomplete="tel" placeholder="(555) 555-5555" />
            </div>
          </div>

          <div class="field">
            <label for="role">Role / Title</label>
            <input id="role" class="input" type="text" placeholder="Operator, Agronomy, Officeâ€¦" />
          </div>

          <div class="grid2">
            <div class="field">
              <label for="type">Type</label>
              <select id="type" class="input">
                <option>Employee</option>
                <option>Partner</option>
                <option>Contractor</option>
              </select>
            </div>
            <div class="field">
              <label for="start">Start Date</label>
              <input id="start" class="input" type="date" />
            </div>
          </div>

          <div class="grid2">
            <div class="field">
              <label for="status">Status</label>
              <select id="status" class="input">
                <option selected>Active</option>
                <option>On Leave</option>
                <option>Inactive</option>
              </select>
            </div>
            <div class="field">
              <label for="perm">Permission Group</label>
              <select id="perm" class="input">
                <option selected>Standard</option>
                <option>Manager</option>
                <option>Admin</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="field" style="min-width:0">
              <label for="notes">Notes</label>
              <textarea id="notes" class="input" rows="3" placeholder="Certifications, endorsements, PTO notes, etc."></textarea>
            </div>
            <div class="actions">
              <button id="reset" class="btn" type="button">Reset</button>
              <button id="save" class="btn btn-primary" type="button">Save</button>
              <button id="saveInvite" class="btn btn-accent" type="button">Save &amp; Invite</button>
            </div>
          </div>
        </div>
      </section>
    </div>
  </fv-shell>

  <div id="toast" class="toast" role="status" aria-live="polite">Saved.</div>

  <!-- Page logic (single module; imports from firebase-init.js) -->
  <script type="module">
    import {
      ready,
      getFirestore,
      collection,
      doc,
      getDoc,
      setDoc,
      serverTimestamp,
      query,
      orderBy,
      onSnapshot,
      getAuth,
      sendPasswordResetEmail
    } from '/Farm-vista/js/firebase-init.js';

    const COLL = 'employees';

    const $ = id => document.getElementById(id);
    const toast = $('toast');
    const elPick = $('pick');
    const elList = $('empList');
    const elHint = $('docHint');

    let currentId = null;
    let latestLoaded = null;

    function showToast(msg="Saved."){
      toast.textContent = msg;
      toast.classList.remove("show"); void toast.offsetWidth;
      toast.classList.add("show");
    }

    function digitsOnly(s=""){ return String(s||'').replace(/\D+/g,''); }
    function formatUSPhone(raw){
      const d = digitsOnly(raw);
      if(!d) return "";
      const core = d.length===11 && d.startsWith("1") ? d.slice(1) : d;
      if(core.length===10) return `(${core.slice(0,3)}) ${core.slice(3,6)}-${core.slice(6)}`;
      return raw.trim();
    }
    $('phone').addEventListener('blur', e => e.target.value = formatUSPhone(e.target.value));

    function requireNames(){
      const first = $('first'), last = $('last');
      if(!first.checkValidity()){ first.reportValidity(); return false; }
      if(!last.checkValidity()){ last.reportValidity(); return false; }
      return true;
    }

    function collect(){
      if(!requireNames()) return null;
      const vals = {
        first: $('first').value.trim(),
        last:  $('last').value.trim(),
        email: $('email').value.trim(),
        phone: formatUSPhone($('phone').value),
        role:  $('role').value.trim(),
        type:  $('type').value,
        start: $('start').value,
        status:$('status').value,
        perm:  $('perm').value,
        notes: $('notes').value.trim()
      };
      const fullName = `${vals.first} ${vals.last}`.trim();
      return {
        payload: {
          firstName: vals.first,
          lastName:  vals.last,
          fullName,
          email:     vals.email,
          phone:     vals.phone,
          role:      vals.role,
          type:      vals.type,
          startDate: vals.start || null,
          status:    vals.status,
          permissionGroup: vals.perm,
          notes:     vals.notes,
          search: [fullName.toLowerCase(), vals.first.toLowerCase(), vals.last.toLowerCase(), vals.email.toLowerCase()].filter(Boolean),
          active: vals.status === 'Active',
          updatedAt: serverTimestamp()
        },
        email: vals.email
      };
    }

    function fillForm(d){
      $('first').value = d.firstName || '';
      $('last').value  = d.lastName  || '';
      $('email').value = d.email     || '';
      $('phone').value = formatUSPhone(d.phone || '');
      $('role').value  = d.role      || '';
      $('type').value  = d.type      || 'Employee';
      $('start').value = (typeof d.startDate === 'string') ? d.startDate : '';
      $('status').value= d.status    || 'Active';
      $('perm').value  = d.permissionGroup || 'Standard';
      $('notes').value = d.notes     || '';
    }

    function resetForm(){
      if(latestLoaded) fillForm(latestLoaded);
    }
    $('reset').addEventListener('click', resetForm);

    async function loadEmployeeById(id){
      try{
        await ready;
        const db = getFirestore();
        const snap = await getDoc(doc(db, COLL, id));
        if(!snap.exists()){
          alert('Employee not found.');
          return;
        }
        currentId = id;
        latestLoaded = snap.data() || {};
        fillForm(latestLoaded);
        elHint.hidden = false;
        elHint.textContent = `Editing ID: ${id}`;
      }catch(err){
        console.error(err);
        alert('Failed to load employee.\n\n' + (err?.message || err));
      }
    }

    // Live picker
    (async function initPicker(){
      try{
        await ready;
        const db = getFirestore();
        onSnapshot(query(collection(db, COLL), orderBy('fullName','asc')), (snap)=>{
          elList.innerHTML = '';
          snap.forEach(docSnap=>{
            const d = docSnap.data() || {};
            const name = d.fullName || [d.firstName, d.lastName].filter(Boolean).join(' ') || '(Unnamed)';
            const opt = document.createElement('option');
            opt.value = `${name} â€” ${d.email || ''}`;
            opt.dataset.id = docSnap.id;
            elList.appendChild(opt);
          });
        }, (err)=>{
          console.error('picker snapshot error:', err);
        });
      }catch(err){
        console.error('picker init failed:', err);
      }
    })();

    // Choose from datalist
    elPick.addEventListener('change', ()=>{
      const val = elPick.value;
      const match = Array.from(elList.options).find(o => o.value === val);
      if(match && match.dataset.id){
        loadEmployeeById(match.dataset.id);
      }
    });

    // Deep-link ?id=
    (function handleQueryId(){
      const params = new URLSearchParams(location.search);
      const id = params.get('id');
      if(id) loadEmployeeById(id);
    })();

    // Save
    $('save').addEventListener('click', async ()=>{
      const pack = collect(); if(!pack) return;
      if(!currentId){ alert('Pick an employee first.'); return; }
      try{
        await ready;
        const db = getFirestore();
        await setDoc(doc(db, COLL, currentId), pack.payload, { merge:true });
        showToast('Employee updated.');
      }catch(err){
        console.error(err);
        alert('Save failed.\n\n' + (err?.message || err));
      }
    });

    // Save & Invite
    $('saveInvite').addEventListener('click', async ()=>{
      const pack = collect(); if(!pack) return;
      if(!currentId){ alert('Pick an employee first.'); return; }
      if(!pack.email){ alert('Enter an email to send the invite.'); return; }

      try{
        await ready;
        const db = getFirestore();
        await setDoc(doc(db, COLL, currentId), pack.payload, { merge:true });

        const auth = getAuth();
        await sendPasswordResetEmail(auth, pack.email);

        showToast('Saved & invite sent.');
      }catch(err){
        console.error(err);
        if (err?.code === 'auth/user-not-found') {
          alert('Invite failed: this email is not a Firebase Auth user yet.\nCreate the user in Authentication (or enable email-link sign-in), then try again.');
        } else {
          alert('Invite failed.\n\n' + (err?.message || err));
        }
      }
    });
  </script>
</body>
</html>