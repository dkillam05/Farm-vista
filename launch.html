<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista • Launch</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>
  <!-- IMPORTANT: No theme-boot.js here so this page stays public -->
  <style>
    :root{--muted:#6b7280;--border:#e5e7eb}
    body{margin:0;background:#f6f7f6;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto}
    .wrap{min-height:100dvh;display:grid;place-items:center;padding:24px}
    .card{background:#fff;border:1px solid var(--border);border-radius:16px;box-shadow:0 1px 0 rgba(0,0,0,.04);padding:22px;max-width:560px;width:100%;text-align:center}
    .spinner{width:36px;height:36px;border:3px solid var(--border);border-top-color:#3B7E46;border-radius:50%;margin:14px auto;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:12px 16px;border-radius:999px;border:1px solid var(--border);background:#3B7E46;color:#fff;font-weight:700;text-decoration:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="spinner" aria-hidden="true"></div>
      <div id="fallback" style="margin-top:10px;display:none">
        <a class="btn" id="fallbackBtn" href="#">Open Now</a>
      </div>
      <noscript>
        <a class="btn" href="/Farm-vista/index.html">Open FarmVista</a>
      </noscript>
    </div>
  </div>

  <script type="module">
    // Public launcher that decides: go straight to target if signed in; else go to login with redirect.
    const APP_SCOPE = '/Farm-vista/';
    const DEFAULT_TARGET = APP_SCOPE + 'index.html';

    const params = new URLSearchParams(location.search);
    const rawTo = params.get('to') || DEFAULT_TARGET;

    const abs = (u) => {
      try { return new URL(u).href; }
      catch { const p = u.startsWith('/') ? u : ('/' + u); return location.origin + p; }
    };

    const webUrl  = abs(rawTo);
    const inScope = webUrl.startsWith(location.origin + APP_SCOPE);
    const appPath = inScope ? webUrl.replace(location.origin, '') : null;

    const isStandalone = () =>
      (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) ||
      (window.navigator.standalone === true); // iOS legacy

    // Choose your real login path here. If you use /auth/, this is correct.
    // If your login is at /pages/login/, change LOGIN_PATH accordingly.
    const LOGIN_PATH = APP_SCOPE + 'auth/index.html';

    const loginUrl = (nextHref) => {
      const u = new URL(LOGIN_PATH, location.origin);
      u.searchParams.set('next', nextHref);
      return u.toString();
    };

    // Show manual button if navigation gets blocked
    const fallback = document.getElementById('fallback');
    const fallbackBtn = document.getElementById('fallbackBtn');
    fallbackBtn.href = webUrl;
    let navigated = false;
    const timer = setTimeout(() => { if (!navigated) fallback.style.display = 'block'; }, 1200);
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'hidden') { navigated = true; clearTimeout(timer); }
    });

    // Try to detect signed-in status without theme-boot: import firebase-init.js directly.
    try {
      const mod = await import('/Farm-vista/js/firebase-init.js');   // must exist
      const ctx = await mod.ready;                                   // provided by your init
      const auth = ctx && ctx.auth;

      const waitAuth = () => new Promise((res) => {
        try {
          if (auth && auth.currentUser) return res(auth.currentUser);
          const off = mod.onAuthStateChanged(auth, u => { off && off(); res(u); });
          setTimeout(() => res(auth && auth.currentUser || null), 800);
        } catch { res(null); }
      });

      const user = await waitAuth();

      if (user) {
        // User is signed in in THIS context
        if (isStandalone() && appPath) location.replace(appPath);
        else location.href = webUrl;
      } else {
        // Not signed in → send to login with redirect to the intended target
        const next = inScope ? (appPath || APP_SCOPE) : webUrl;
        location.replace(loginUrl(next));
      }
    } catch (e) {
      // If firebase-init.js isn't available, just go to web target as a fallback.
      // Your normal page guard will then decide what to do.
      if (isStandalone() && appPath) location.replace(appPath);
      else location.href = webUrl;
    }
  </script>
</body>
</html>
