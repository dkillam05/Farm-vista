<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FarmVista â€¢ Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
  <meta name="theme-color" content="#3B7E46" />

  <!-- IMPORTANT: make all relative URLs resolve under /Farm-vista/ -->
  <base href="/Farm-vista/">

  <!-- Standard includes (relative to <base>) -->
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="apple-touch-icon" href="assets/icons/apple-touch-icon.png" />
  <link rel="icon" href="assets/icons/icon-192.png" />
  <link rel="stylesheet" href="assets/css/theme.css?v=PV1" />
  <link rel="stylesheet" href="assets/css/app.css?v=PV1" />

  <!-- Firebase config + FVData (needed to read messages from Firestore) -->
  <script src="js/firebase-config.js"></script>
  <script src="js/fv-data.js"></script>

  <!-- Load core first (theme + App API), then the shell -->
  <script src="js/core.js?v=PV1"></script>
  <script src="js/fv-shell.js?v=PV1" defer></script>

  <style>
    body{background:var(--app-bg,var(--surface));min-height:100vh}
    .page{max-width:1100px;margin:0 auto;padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + 96px)!important;}
    .page-title{margin:0 0 8px 0;}
    .section{border:1px solid var(--border);border-radius:14px;background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));overflow:hidden;}
    .section-head{display:grid;grid-template-columns:36px 1fr;gap:12px;align-items:center;
      padding:14px 16px;border-bottom:1px solid var(--border);
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);}
    .section-head .icon{width:24px;height:24px;color:#2F6C3C;display:grid;place-items:center;}
    .section-body{padding:16px;display:grid;gap:10px}
    .msg{border:1px solid var(--border);border-radius:12px;padding:12px;background:var(--card-surface,var(--surface))}
    .msg .title{font-weight:800;margin:0 0 4px 0}
    .chips{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
    .chip{font-size:12px;border:1px solid var(--border);border-radius:999px;padding:4px 8px;color:var(--muted,#67706B);background:var(--surface)}
    .empty{color:var(--muted,#67706B)}

    /* ============================
       FarmVista Copilot (AI box)
       ============================ */
    .ai-section .section-head strong{
      display:block;
    }
    .ai-section .section-head .sub{
      font-size:12px;
      color:var(--muted,#67706B);
      margin-top:2px;
    }
    .ai-body{
      display:grid;
      gap:12px;
      grid-template-rows:minmax(160px, 260px) auto;
    }
    .ai-log{
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
      background:var(--card-surface,var(--surface));
      display:flex;
      flex-direction:column;
      gap:8px;
      overflow:auto;
      max-height:260px;
      font-size:14px;
    }
    .ai-empty{
      color:var(--muted,#67706B);
      font-size:13px;
    }
    .ai-msg{
      border-radius:10px;
      padding:8px 10px;
      line-height:1.4;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .ai-msg-user{
      align-self:flex-end;
      background:rgba(59,126,70,0.12);
      border:1px solid rgba(59,126,70,0.25);
    }
    .ai-msg-assistant{
      align-self:flex-start;
      background:var(--surface);
      border:1px solid var(--border);
    }
    .ai-msg-meta{
      font-size:11px;
      color:var(--muted,#67706B);
      margin-bottom:2px;
      opacity:0.85;
    }

    .ai-form{
      display:grid;
      gap:6px;
    }

    /* Mic inside textarea, professional icon */
    .ai-input-wrap{
      position:relative;
      display:block;
    }
    .ai-input{
      width:100%;
      resize:none;
      border-radius:16px;
      border:1px solid var(--border);
      padding:10px 42px 10px 12px; /* space on right for mic */
      min-height:40px;
      max-height:80px;
      font:inherit;
      background:var(--surface);
      color:inherit;
      line-height:1.4;
    }
    .ai-input:focus{
      outline:2px solid rgba(59,126,70,0.4);
      outline-offset:1px;
    }
    .ai-mic{
      position:absolute;
      right:10px;
      top:50%;
      transform:translateY(-50%);
      width:24px;
      height:24px;
      border:none;
      background:transparent;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      outline:none;
      color:var(--muted,#67706B);
      padding:0;
    }
    .ai-mic-icon{
      width:18px;
      height:18px;
      display:block;
      stroke:currentColor;
      stroke-width:1.8;
      stroke-linecap:round;
      stroke-linejoin:round;
      fill:none;
    }
    .ai-mic:hover:not([disabled]){
      transform:translateY(-50%) scale(1.05);
    }
    .ai-mic[disabled]{
      opacity:0.5;
      cursor:default;
    }
    .ai-mic.recording{
      color:#cc3030; /* subtle red when recording */
    }

    .ai-actions{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      flex-wrap:wrap;
    }
    .ai-send{
      border-radius:999px;
      border:1px solid var(--border);
      background:#3B7E46;
      padding:8px 16px;
      font-size:14px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      color:#fff;
      min-height:36px;
      outline:none;
    }
    .ai-send[disabled]{
      opacity:0.5;
      cursor:default;
    }
    .ai-hint{
      font-size:12px;
      color:var(--muted,#67706B);
    }
    .ai-status{
      font-size:12px;
      color:var(--muted,#67706B);
      flex:1;
      text-align:right;
    }
  </style>
</head>
<body>
  <fv-shell>
    <div class="page container">
      <h1 class="page-title">Dashboard</h1>

      <!-- =======================
           Message Board (existing)
           ======================= -->
      <section class="section" aria-label="Message Board">
        <header class="section-head">
          <div class="icon" aria-hidden="true">ðŸ“¢</div>
          <div><strong>Message Board</strong></div>
        </header>
        <div class="section-body" id="board">
          <div class="msg empty">No messages at this time.</div>
        </div>
      </section>

      <!-- ============================
           FarmVista Copilot (AI Box)
           ============================ -->
      <section class="section ai-section" aria-label="FarmVista Copilot">
        <header class="section-head">
          <div class="icon" aria-hidden="true">ðŸ¤–</div>
          <div>
            <strong>FarmVista Copilot (beta)</strong>
            <div class="sub">Ask questions about your fields, equipment, work orders, and more.</div>
          </div>
        </header>
        <div class="section-body ai-body">
          <div id="ai-chat-log" class="ai-log" aria-live="polite">
            <div class="ai-empty">
              Start by asking something like:<br>
              â€¢ "Show me pending field maintenance for today."<br>
              â€¢ "Summarize all grain bags at Farm 02."<br>
              â€¢ "Draft a report for yesterdayâ€™s combine work orders."
            </div>
          </div>

          <form id="ai-chat-form" class="ai-form" autocomplete="off">
            <div class="ai-input-wrap">
              <textarea
                id="ai-input"
                class="ai-input"
                rows="1"
                placeholder="Ask FarmVista Copilot..."
              ></textarea>
              <button type="button" id="ai-mic" class="ai-mic" aria-label="Start voice dictation">
                <svg class="ai-mic-icon" viewBox="0 0 24 24" aria-hidden="true">
                  <!-- mic capsule -->
                  <path d="M12 5a2.5 2.5 0 0 1 2.5 2.5v4a2.5 2.5 0 0 1-5 0v-4A2.5 2.5 0 0 1 12 5z" />
                  <!-- stem -->
                  <path d="M9.75 11.5v.5a2.25 2.25 0 0 0 4.5 0v-.5" />
                  <!-- outer curve + base -->
                  <path d="M8 11.5v.5a4 4 0 0 0 8 0v-.5" />
                  <path d="M12 15.5v3" />
                  <path d="M9.5 18.5h5" />
                </svg>
              </button>
            </div>

            <div class="ai-actions">
              <button type="submit" id="ai-send" class="ai-send" aria-label="Send question">
                Send
              </button>
              <div class="ai-status" id="ai-status" aria-live="polite"></div>
            </div>

            <div class="ai-hint">
              Connected to your FarmVista AI backend. Early beta â€“ answers may be generic for now.
            </div>
          </form>
        </div>
      </section>
    </div>
  </fv-shell>

  <!-- ==========================
       Message Board JS (existing)
       ========================== -->
  <script>
  (function(){
    "use strict";

    const COL = "messageBoard";                 // Firestore collection used by mb-admin.js
    const FALLBACK_KEYS = [                     // legacy/local fallback keys (just in case)
      "df_message_board_fallback",
      "df_message_board",
      "fv_message_board_v1"
    ];
    const box = document.getElementById("board");

    const toMs = (v)=>{
      if (v == null || v === "") return null;
      if (typeof v === "number") return v;
      const t = Date.parse(v);
      return Number.isFinite(t) ? t : null;
    };
    const tsToMs = (t)=>{
      // Firestore Timestamp -> ms
      if (t && typeof t === "object" && typeof t.seconds === "number") return t.seconds*1000;
      if (typeof t === "number") return t;
      return null;
    };
    const fmtDate = (ms)=>{
      try{
        return new Date(ms).toLocaleString(undefined, { month:"short", day:"numeric", hour:"numeric", minute:"2-digit" });
      }catch{ return ""; }
    };

    async function loadFromFirestore(){
      if (!window.FVData || typeof FVData.list !== "function") return null;
      try{
        await FVData.ready();
        // show all messages (rules control access); mobile-friendly cap
        const arr = await FVData.list(COL, { limit: 200, mine: false });
        return Array.isArray(arr) ? arr.map(d => ({
          id: d.id,
          title: (d.title||"").toString(),
          body: (d.body||"").toString(),
          pinned: !!d.pinned,
          authorName: (d.authorName||"").toString(),
          createdAt: tsToMs(d.createdAt) || Date.now(),
          expiresAt: toMs(d.expiresAt)
        })) : [];
      }catch(e){
        console.warn("[dashboard] Firestore read failed, falling back:", e);
        return null;
      }
    }

    function loadFromLocal(){
      for (const k of FALLBACK_KEYS){
        try{
          const raw = localStorage.getItem(k);
          if (!raw) continue;
          const arr = JSON.parse(raw);
          if (Array.isArray(arr) && arr.length){
            // normalize legacy shapes
            return arr.map(m => ({
              id: m.id || String(Math.random()),
              title: (m.title||"").toString(),
              body: (m.body || m.text || "").toString(),
              pinned: !!m.pinned,
              authorName: (m.authorName||"").toString(),
              createdAt: toMs(m.createdAt) || Date.now(),
              expiresAt: toMs(m.expiresAt)
            }));
          }
        }catch{}
      }
      return [];
    }

    function render(list){
      const now = Date.now();
      const active = (list||[]).filter(m => !m.expiresAt || m.expiresAt > now);

      // sort: pinned first, then newest
      active.sort((a,b)=> (b.pinned - a.pinned) || ((b.createdAt||0) - (a.createdAt||0)));

      if (!active.length){
        box.innerHTML = '<div class="msg empty">No messages at this time.</div>';
        return;
      }

      box.innerHTML = "";
      active.forEach(m=>{
        const el = document.createElement("div");
        el.className = "msg";
        el.innerHTML = `
          ${m.title ? `<div class="title">${m.title}</div>` : ``}
          <div class="body" style="white-space:pre-wrap">${m.body}</div>
          <div class="chips">
            ${m.authorName ? `<span class="chip">Post By: ${m.authorName}</span>` : ``}
            ${m.createdAt ? `<span class="chip">Date Posted: ${fmtDate(m.createdAt)}</span>` : ``}
          </div>
        `;
        box.appendChild(el);
      });
    }

    async function refresh(){
      // Try Firestore first, then fall back
      const fs = await loadFromFirestore();
      if (fs) { render(fs); return; }
      render(loadFromLocal());
    }

    // Initial load + refresh when returning to tab
    refresh();
    document.addEventListener("visibilitychange", ()=>{ if(document.visibilityState==="visible") refresh(); });

  })();
  </script>

  <!-- ==========================
       FarmVista Copilot JS (AI UI)
       ========================== -->
  <script>
  (function(){
    "use strict";

    const logEl   = document.getElementById("ai-chat-log");
    const formEl  = document.getElementById("ai-chat-form");
    const inputEl = document.getElementById("ai-input");
    const micEl   = document.getElementById("ai-mic");
    const sendEl  = document.getElementById("ai-send");
    const statusEl= document.getElementById("ai-status");

    if (!logEl || !formEl || !inputEl || !micEl || !sendEl) return;

    let isThinking = false;

    function clearEmptyState(){
      const empty = logEl.querySelector(".ai-empty");
      if (empty) empty.remove();
    }

    function appendMessage(role, text){
      clearEmptyState();
      const wrap = document.createElement("div");
      wrap.className = "ai-msg " + (role === "user" ? "ai-msg-user" : "ai-msg-assistant");
      const who = role === "user" ? "You" : "Copilot";
      wrap.innerHTML = `
        <div class="ai-msg-meta">${who}</div>
        <div>${text.replace(/</g, "&lt;")}</div>
      `;
      logEl.appendChild(wrap);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function setStatus(msg){
      statusEl.textContent = msg || "";
    }

    function setThinking(on){
      isThinking = !!on;
      sendEl.disabled = isThinking;
      inputEl.disabled = isThinking;
      micEl.disabled = isThinking;
      setStatus(isThinking ? "Thinkingâ€¦" : "");
    }

    // ======================
    // REAL AI CALL (Cloud Run)
    // ======================
    async function callAssistant(prompt){
      const endpoint = "https://chatbot-api-300398089669.us-central1.run.app/chat";
      const res = await fetch(endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: prompt })
      });

      if (!res.ok){
        throw new Error("API error " + res.status);
      }

      const data = await res.json();
      return data && data.reply ? data.reply.toString() : "(No response)";
    }

    // Handle submit
    formEl.addEventListener("submit", async (evt)=>{
      evt.preventDefault();
      if (isThinking) return;

      const text = (inputEl.value || "").trim();
      if (!text) return;

      appendMessage("user", text);
      inputEl.value = "";
      inputEl.style.height = "auto";

      setThinking(true);
      try{
        const reply = await callAssistant(text);
        appendMessage("assistant", reply || "(No response)");
      }catch(e){
        console.warn("[copilot] error:", e);
        appendMessage("assistant", "Sorry, I couldn't process that request right now.");
      }finally{
        setThinking(false);
      }
    });

    // Auto-grow textarea
    inputEl.addEventListener("input", ()=>{
      inputEl.style.height = "auto";
      inputEl.style.height = Math.min(inputEl.scrollHeight, 80) + "px";
    });

    // ======================
    // Speech recognition
    // ======================
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition = null;
    let isRecording = false;

    if (SpeechRecognition){
      recognition = new SpeechRecognition();
      recognition.lang = "en-US";
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      recognition.addEventListener("start", ()=>{
        isRecording = true;
        micEl.classList.add("recording");
        setStatus("Listeningâ€¦");
      });

      recognition.addEventListener("end", ()=>{
        isRecording = false;
        micEl.classList.remove("recording");
        if (!isThinking) setStatus("");
      });

      recognition.addEventListener("result", (event)=>{
        const result = event.results && event.results[0] && event.results[0][0];
        const text = result ? result.transcript : "";
        if (text){
          const existing = inputEl.value.trim();
          inputEl.value = existing ? (existing + " " + text) : text;
          inputEl.dispatchEvent(new Event("input"));
          inputEl.focus();
        }
      });

      micEl.addEventListener("click", ()=>{
        if (isThinking) return;
        if (isRecording){
          recognition.stop();
          return;
        }
        try{
          recognition.start();
        }catch(e){
          console.warn("[copilot] recognition error:", e);
        }
      });
    }else{
      // Speech not supported â€“ keep mic visible but disabled, with status
      micEl.disabled = true;
      setStatus("Voice dictation not supported in this browser.");
    }
  })();
  </script>

  <!-- One-time SW reset for path change -->
  <script>
  (async () => {
    try {
      if ('serviceWorker' in navigator) {
        const regs = await navigator.serviceWorker.getRegistrations();
        await Promise.all(regs.map(r => r.unregister()));
        await navigator.serviceWorker.register('serviceworker.js?rev=PV1'); // respects <base>
        if (navigator.serviceWorker.controller) {
          navigator.serviceWorker.controller.postMessage('SKIP_WAITING');
        }
      }
      if ('caches' in window) {
        const keys = await caches.keys();
        await Promise.all(keys.map(k => caches.delete(k)));
      }
    } catch (e) { console.warn(e); }
  })();
  </script>
</body>
</html>
