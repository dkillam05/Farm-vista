<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista â€¢ Page Title Here</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- ===========================
       ABSOLUTE PATHS (REQUIRED)
       =========================== -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>

  <!-- Theme + base app styles -->
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <!-- Ensure fv-shell (global header/footer/menu) -->
  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js';
        s.defer=true;
        document.head.appendChild(s);
      }
    })();
  </script>

  <!-- ===========================
       PAGE CSS (keep tiny; use theme tokens)
       =========================== -->
  <style>
    :root{
      --card-max:1100px;
      --page-bottom-gap:96px;
      --accent:#2F6C3C;
    }
    body{ background:var(--app-bg,var(--surface)); }

    /* Standard wrapper */
    .wrap{
      max-width:var(--card-max);
      margin:0 auto;
      padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + var(--page-bottom-gap))!important;
    }

    /* Hero card */
    .hero{
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));
      overflow:hidden;
      margin-bottom:var(--page-bottom-gap);
    }
    .hero-head{
      display:grid;grid-template-columns:36px 1fr;gap:12px;align-items:center;
      padding:14px 16px;border-bottom:1px solid var(--border);
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);
    }
    .hero-head .icon{width:24px;height:24px;color:var(--accent);display:grid;place-items:center}
    .hero-head h1{margin:0;font-size:clamp(20px,3.2vw,26px);line-height:1.2}
    .muted{color:var(--muted,#67706B)}
    .body{padding:16px;display:grid;gap:14px}

    /* Grid rows */
    .row{display:grid;gap:10px;grid-template-columns:1fr 1fr}
    @media (max-width:880px){.row{grid-template-columns:1fr}}

    /* Inputs */
    .field label{display:block;font-weight:800;margin:0 0 6px}
    .input,.select,.textarea{
      width:100%;font:inherit;font-size:16px;color:var(--text);
      background:var(--card-surface,var(--surface));border:1px solid var(--border);
      border-radius:10px;padding:12px;outline:none
    }
    .textarea{min-height:110px;resize:vertical}
    .help{font-size:13px;color:var(--muted,#67706B);margin-top:6px}

    /* Buttons */
    .actions{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-top:6px}
    .btn{display:inline-flex;align-items:center;justify-content:center;min-width:160px;
      padding:12px 16px;border-radius:12px;border:1px solid var(--border);
      background:var(--card-surface,var(--surface));font-weight:800;color:var(--text)!important;cursor:pointer}
    .btn-primary{border-color:transparent;background:#2F6C3C;color:#fff!important}

    /* Tiny toast (match app look) */
    .toast{position:fixed;left:50%;bottom:calc(env(safe-area-inset-bottom,0px) + 72px);transform:translateX(-50%);
      background:#2F6C3C;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.25);z-index:99999;display:none}
    .toast.show{display:block;animation:fadeout 5s forwards}
    @keyframes fadeout{0%{opacity:1}85%{opacity:1}100%{opacity:0}}

    .error{color:#b00020;font-weight:700}
  </style>
</head>

<body>
  <!-- All content must live inside <fv-shell> -->
  <fv-shell>
    <div class="wrap">
      <section class="hero">
        <header class="hero-head">
          <div class="icon" aria-hidden="true">ðŸ§­</div>
          <div>
            <h1>Page Title Goes Here</h1>
            <p class="muted">Short description or helper text.</p>
          </div>
        </header>

        <div class="body">
          <!-- Example form layout -->
          <div class="row">
            <div class="field">
              <label for="exampleSelect">Example Dropdown (from Firestore)</label>
              <select id="exampleSelect" class="select">
                <option value="">â€” Loadingâ€¦ â€”</option>
              </select>
              <div id="exHelp" class="help">0 items</div>
            </div>

            <div class="field">
              <label for="exampleInput">Example Input</label>
              <input id="exampleInput" class="input" placeholder="Type here"/>
            </div>
          </div>

          <div class="field">
            <label for="notes">Notes</label>
            <textarea id="notes" class="textarea" placeholder="Optional details"></textarea>
          </div>

          <!-- Optional file picker (shows Camera, Photos, and Files on iOS; no capture attr) -->
          <div class="field">
            <label for="files">Optional Files</label>
            <input id="files" class="input" type="file" accept="image/*,.jpg,.jpeg,.png,.heic,.pdf" multiple>
            <div id="fileHelp" class="help">You can annotate images later (Storage is loaded lazily only if needed).</div>
          </div>

          <div id="err" class="help error" hidden></div>

          <div class="actions">
            <button id="btnClear" class="btn" type="button">Clear</button>
            <button id="btnSave" class="btn btn-primary" type="button">Save</button>
          </div>
        </div>
      </section>
    </div>
  </fv-shell>

  <!-- App toast -->
  <div id="toast" class="toast" role="status" aria-live="polite">Saved.</div>

  <!-- ===========================
       MODULAR FIREBASE (LAZY METHOD)
       - Import DB/AUTH up-front; STORAGE only when needed.
       - Always `await ready` before touching Firebase.
       =========================== -->
  <script type="module">
    import {
      ready,
      getFirestore, getAuth,
      collection, getDocs, addDoc, doc, updateDoc,
      serverTimestamp, query, orderBy, where
    } from '/Farm-vista/js/firebase-init.js';

    /* ---------- Small utilities ---------- */
    const $ = id => document.getElementById(id);
    const esc = s => String(s||"").replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;","&gt;":"&gt;",'"':"&quot;","'":"&#39;"}[m]));
    function showToast(msg="Saved.", ms=5000){
      const t=$("toast"); t.textContent=msg; t.classList.remove("show"); void t.offsetWidth; t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"), ms);
    }

    /* ---------- LAZY STORAGE LOADER ----------
       Only load these heavy functions when we actually upload something.
       Your /js/firebase-init.js must export: getStorage, ref, uploadBytes, getDownloadURL
    ----------------------------------------- */
    async function loadStorageFns(){
      const m = await import('/Farm-vista/js/firebase-init.js');
      const fns = { getStorage:m.getStorage, ref:m.ref, uploadBytes:m.uploadBytes, getDownloadURL:m.getDownloadURL };
      if (fns.getStorage && fns.ref && fns.uploadBytes && fns.getDownloadURL) return fns;
      throw new Error('Storage exports missing in /js/firebase-init.js');
    }

    /* ---------- Example: populate a dropdown from Firestore ---------- */
    async function populateExampleSelect(db){
      const sel = $("exampleSelect"), help=$("exHelp");
      try{
        sel.innerHTML = '<option value="">â€” Loadingâ€¦ â€”</option>';
        const snap = await getDocs(query(collection(db,'fields'), orderBy('name'))); // change collection as needed
        const items = [];
        snap.forEach(d=>{
          const data = d.data()||{};
          const name = String(data.name||"").trim();
          if(name) items.push({id:d.id, name});
        });
        items.sort((a,b)=>a.name.localeCompare(b.name));
        sel.innerHTML = '<option value="">â€” Select â€”</option>' + items.map(x=>`<option value="${esc(x.id)}">${esc(x.name)}</option>`).join('');
        help.textContent = `${items.length} items`;
      }catch(e){
        // Fallback if an index is missing (e.g., where+orderBy combo)
        console.warn('Indexed query failed, falling back:', e.message);
        try{
          const all = await getDocs(collection(db,'fields'));
          const items=[];
          all.forEach(d=>{
            const data=d.data()||{}; const name=String(data.name||"").trim();
            if(name) items.push({id:d.id, name});
          });
          items.sort((a,b)=>a.name.localeCompare(b.name));
          sel.innerHTML = '<option value="">â€” Select â€”</option>' + items.map(x=>`<option value="${esc(x.id)}">${esc(x.name)}</option>`).join('');
          help.textContent = `${items.length} items (unsorted fallback)`;
        }catch(err2){
          $("err").hidden=false;
          $("err").textContent = `Failed to load list: ${err2.message}`;
          sel.innerHTML = '<option value="">â€” Error â€”</option>';
        }
      }
    }

    /* ---------- Example: save + lazy-upload files ---------- */
    async function handleSave(db){
      $("err").hidden = true;
      const pick = $("exampleSelect").value;
      const name = $("exampleInput").value.trim();
      if(!pick){ alert("Please choose an option."); return; }
      if(!name){ alert("Please enter a value."); return; }

      // Base doc (fast)
      const ref = await addDoc(collection(db,'demo'), {
        selectId: pick,
        name,
        notes: $("notes").value.trim(),
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });

      // Only load Storage if we actually have files
      const files = Array.from(($("files").files||[]));
      if(files.length){
        try{
          const { getStorage, ref:stRef, uploadBytes, getDownloadURL } = await loadStorageFns();
          const st = getStorage();
          const out = [];
          for(const f of files){
            const safe = (Date.now()+'-'+f.name).replace(/[^\w.\-]+/g,'_');
            const path = `demo/${ref.id}/${safe}`;
            const r = stRef(st, path);
            await uploadBytes(r, f, { contentType: f.type || 'application/octet-stream' });
            const url = await getDownloadURL(r);
            out.push({name:f.name, url, path});
          }
          await updateDoc(doc(db,'demo',ref.id), { files: out, updatedAt: serverTimestamp() });
        }catch(stErr){
          console.error(stErr);
          $("err").hidden=false;
          $("err").textContent = `Saved but file upload failed: ${stErr.message}`;
        }
      }

      showToast("Saved.");
      // reset UI
      $("exampleSelect").selectedIndex = 0;
      $("exampleInput").value = "";
      $("notes").value = "";
      $("files").value = "";
    }

    /* ---------- Boot ---------- */
    (async()=>{
      const ctx = await ready;                // wait for Firebase + Auth
      const db  = getFirestore();
      const auth = getAuth();
      console.log("âœ… Firebase Ready:", ctx.mode, auth.currentUser?.email || '(anon)');

      // Populate example dropdown (from Firestore)
      await populateExampleSelect(db);

      // Wire actions
      $("btnSave").addEventListener("click", ()=> handleSave(db));
      $("btnClear").addEventListener("click", ()=>{
        $("exampleSelect").selectedIndex=0;
        $("exampleInput").value=""; $("notes").value=""; $("files").value="";
      });

      // Helpful network toasts
      window.addEventListener('online', ()=> showToast("Back online â€” syncingâ€¦", 4000));
      window.addEventListener('offline',()=> showToast("Currently offline â€” using saved data", 4000));
    })();
  </script>

  <!-- ===========================
       NOTES FOR FUTURE PAGES
       ===========================
       â€¢ All paths are absolute (/Farm-vista/...).
       â€¢ Every page lives under: /Farm-vista/pages/{module}/
       â€¢ Wrap content in <fv-shell> for header/footer/menu.
       â€¢ Always use modular Firebase from /js/firebase-init.js.
       â€¢ Wait for `await ready` before calling Firestore/Auth.
       â€¢ LAZY STORAGE: import storage functions only when needed.
       â€¢ iOS camera/library/files chooser: omit `capture` attribute.
       â€¢ If Firestore shows â€œrequires composite indexâ€, create it in
         Console â†’ Firestore â†’ Indexes (Composite) once for the project,
         or provide a graceful client-side fallback as shown.
       â€¢ Keep page CSS tiny; use theme tokens & shared components.
  -->
</body>
</html>