<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FarmVista â€¢ Report â€¢ Bugs & Ideas Feedback</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#3B7E46" />

  <!-- IMPORTANT: adjust <base> if you place this outside /Farm-vista/ -->
  <base href="/Farm-vista/">

  <!-- Standard includes -->
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="apple-touch-icon" href="assets/icons/apple-touch-icon.png" />
  <link rel="icon" href="assets/icons/icon-192.png" />
  <script src="js/theme-boot.js"></script>
  <link rel="stylesheet" href="assets/css/theme.css" />
  <link rel="stylesheet" href="assets/css/app.css" />

  <!-- For template/demo we still want fv-shell + core -->
  <script src="js/core.js"></script>
  <script src="js/fv-shell.js" defer></script>

  <style>
    body{
      background:var(--app-bg,var(--surface));
      min-height:100vh;
    }
    .page{
      max-width:1100px;
      margin:0 auto;
      padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + 64px)!important;
    }

    /* Hero / header */
    .report-hero{
      border-radius:18px;
      padding:16px 18px;
      background:linear-gradient(125deg, rgba(59,126,70,0.11), rgba(59,126,70,0.02));
      border:1px solid rgba(59,126,70,0.30);
      box-shadow:0 10px 26px rgba(0,0,0,0.08);
      margin-bottom:16px;
      display:flex;
      flex-wrap:wrap;
      gap:14px 18px;
      align-items:flex-start;
      position:relative;
    }
    .report-hero-main{
      flex:1 1 220px;
      min-width:0;
    }
    .report-kicker{
      font-size:12px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color:var(--muted,#5e6a63);
      margin-bottom:4px;
      font-weight:600;
    }
    .report-title{
      font-size:22px;
      font-weight:700;
      margin:0 0 4px 0;
    }
    .report-sub{
      font-size:13px;
      color:var(--muted,#5e6a63);
    }
    .report-tags{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:8px;
    }
    .report-tag{
      font-size:11px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,0.12);
      padding:3px 9px;
      background:rgba(255,255,255,0.9);
      color:var(--muted,#5e6a63);
    }

    .report-stats{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:stretch;
    }
    .stat-pill{
      min-width:120px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,0.10);
      background:rgba(255,255,255,0.96);
      padding:8px 10px;
      font-size:12px;
      display:flex;
      flex-direction:column;
      justify-content:center;
    }
    .stat-label{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.10em;
      color:var(--muted,#5e6a63);
      margin-bottom:2px;
    }
    .stat-value{
      font-size:18px;
      font-weight:700;
    }
    .stat-sub{
      font-size:11px;
      color:var(--muted,#5e6a63);
    }

    /* Filters row */
    .report-filters{
      margin:6px 0 14px 0;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:flex-end;
    }
    .filter-field{
      display:flex;
      flex-direction:column;
      gap:3px;
      min-width:120px;
      flex:1 1 140px;
    }
    .filter-label{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--muted,#5e6a63);
    }
    .filter-select,
    .filter-input{
      border-radius:999px;
      border:1px solid var(--border,#D1D5DB);
      padding:6px 10px;
      font-size:13px;
      background:#fff;
      min-height:32px;
    }
    .filter-input::placeholder{
      color:var(--muted,#9CA3AF);
    }

    .filter-actions{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }
    .btn-pill{
      border-radius:999px;
      border:1px solid var(--border,#D1D5DB);
      padding:7px 14px;
      font-size:13px;
      background:#fff;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      text-decoration:none;
      color:inherit;
    }
    .btn-pill-primary{
      background:#3B7E46;
      border-color:#3B7E46;
      color:#fff;
    }

    /* Body / list */
    .report-body{
      border-radius:16px;
      border:1px solid var(--border,#E5E7EB);
      background:var(--surface,#fff);
      box-shadow:0 8px 20px rgba(0,0,0,0.05);
      padding:10px 12px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    .report-header-row{
      display:grid;
      grid-template-columns: minmax(0,2.2fr) minmax(0,1.4fr) minmax(0,1.2fr) minmax(0,0.9fr);
      gap:10px;
      padding:4px 4px 6px;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.12em;
      color:var(--muted,#6B7280);
      border-bottom:1px solid var(--border,#E5E7EB);
    }

    .report-list{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:4px;
    }

    .report-row{
      border-radius:12px;
      border:1px solid var(--border,#E5E7EB);
      padding:8px 10px;
      display:grid;
      grid-template-columns: minmax(0,2.2fr) minmax(0,1.4fr) minmax(0,1.2fr) minmax(0,0.9fr);
      gap:10px;
      font-size:13px;
      background:var(--card-surface,#fff);
    }

    .report-cell-main{
      display:flex;
      flex-direction:column;
      gap:3px;
      min-width:0;
    }
    .cell-title{
      font-weight:600;
      white-space:nowrap;
      text-overflow:ellipsis;
      overflow:hidden;
    }
    .cell-notes{
      font-size:12px;
      color:var(--muted,#4B5563);
      white-space:nowrap;
      text-overflow:ellipsis;
      overflow:hidden;
    }
    .cell-meta{
      font-size:12px;
      color:var(--muted,#6B7280);
      display:flex;
      flex-direction:column;
      gap:3px;
    }
    .cell-tags{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      font-size:11px;
    }
    .tag{
      border-radius:999px;
      border:1px solid rgba(0,0,0,0.10);
      padding:2px 7px;
      background:rgba(249,250,251,0.95);
    }
    .tag-green{
      border-color:rgba(59,126,70,0.45);
      background:rgba(59,126,70,0.10);
      color:#1f5c2d;
    }
    .tag-idea{
      border-color:rgba(208,197,66,0.6);
      background:rgba(208,197,66,0.14);
      color:#4b4910;
    }
    .attachment-pill{
      border-radius:999px;
      border:1px dashed rgba(0,0,0,0.18);
      padding:2px 7px;
      font-size:11px;
      background:rgba(249,250,251,0.95);
      max-width:180px;
      white-space:nowrap;
      text-overflow:ellipsis;
      overflow:hidden;
    }

    .report-empty{
      padding:18px 8px;
      font-size:13px;
      color:var(--muted,#6B7280);
      text-align:center;
    }

    .report-footer{
      margin-top:10px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      justify-content:space-between;
      font-size:12px;
      color:var(--muted,#6B7280);
    }

    @media (max-width: 720px){
      .report-header-row{
        display:none;
      }
      .report-row{
        grid-template-columns:1fr;
      }
      .cell-meta{
        flex-direction:row;
        flex-wrap:wrap;
        gap:4px 12px;
      }
    }
  </style>
</head>
<body>
  <fv-shell>
    <div class="page container">

      <!-- HERO -->
      <section class="report-hero" aria-label="Feedback report â€“ bugs and ideas">
        <div class="report-hero-main">
          <div class="report-kicker">Feedback Report</div>
          <h1 class="report-title">Bugs & Ideas from the FarmVista App</h1>
          <p class="report-sub">
            Lists all submitted bugs and ideas, grouped by where they occurred in the app. Use this
            to review issues and prioritize fixes.
          </p>
          <div class="report-tags">
            <span class="report-tag" id="tag-type">Types: Bugs &amp; Ideas</span>
            <span class="report-tag" id="tag-date-range">Date range: All time</span>
            <span class="report-tag">
              Generated <span id="tag-generated-at"></span>
            </span>
          </div>
        </div>

        <div class="report-stats" aria-label="Summary">
          <div class="stat-pill">
            <div class="stat-label">Total Feedback</div>
            <div class="stat-value" id="stat-total">â€“</div>
            <div class="stat-sub">Bugs + ideas captured.</div>
          </div>
          <div class="stat-pill">
            <div class="stat-label">Bugs vs Ideas</div>
            <div class="stat-value" id="stat-mix">â€“</div>
            <div class="stat-sub" id="stat-mix-sub">Breakdown by type.</div>
          </div>
          <div class="stat-pill">
            <div class="stat-label">Latest Submission</div>
            <div class="stat-value" id="stat-latest">â€“</div>
            <div class="stat-sub" id="stat-latest-sub">Most recent feedback received.</div>
          </div>
        </div>
      </section>

      <!-- FILTERS -->
      <section class="report-filters" aria-label="Filters">
        <div class="filter-field">
          <label class="filter-label" for="filter-type">Type</label>
          <select id="filter-type" class="filter-select">
            <option value="all">All types</option>
            <option value="bugs">Bugs only</option>
            <option value="ideas">Ideas only</option>
          </select>
        </div>

        <div class="filter-field">
          <label class="filter-label" for="filter-main-menu">Main menu</label>
          <select id="filter-main-menu" class="filter-select">
            <option value="all">All sections</option>
          </select>
        </div>

        <div class="filter-field">
          <label class="filter-label" for="filter-search">Search</label>
          <input
            id="filter-search"
            class="filter-input"
            type="search"
            placeholder="Search notes, menu, submitterâ€¦"
          />
        </div>

        <div class="filter-actions">
          <button type="button" class="btn-pill" id="filter-clear">Clear filters</button>
          <button type="button" class="btn-pill btn-pill-primary" id="btn-print">
            Print / Save PDF
          </button>
        </div>
      </section>

      <!-- BODY -->
      <section class="report-body" aria-label="Feedback list">
        <div class="report-header-row">
          <div>Notes / Summary</div>
          <div>Where in App</div>
          <div>Submitted</div>
          <div>Type / Attachments</div>
        </div>

        <div id="report-list" class="report-list">
          <div class="report-empty" id="report-empty">
            No matching feedback. Adjust filters to see more results.
          </div>
        </div>

        <div class="report-footer">
          <div>
            Template preview â€“ currently using demo JSON. When wired, this will use the
            <code>feedback</code> collection (types: <code>bugs</code>, <code>ideas</code>).
          </div>
          <div>
            Tip: Use your browserâ€™s print dialog to save as PDF, or point your PDF service at this URL.
          </div>
        </div>
      </section>

    </div>
  </fv-shell>

  <script>
  (function(){
    "use strict";

    // ==============================
    // Demo data for template preview
    // ==============================
    // Real docs will come from `feedback` collection with a shape like:
    // {
    //   type: "bugs" | "ideas",
    //   notes: string,
    //   date: "YYYY-MM-DD",
    //   createdAt: ISO string or Timestamp,
    //   mainMenu: { id, label },
    //   subMenu: { id, label },
    //   submittedBy: { name, email, uid },
    //   appVersion: { number, date, tagline },
    //   attachments: [ { name, url, contentType, size, path } ]
    // }
    const demoFeedbackData = [
      {
        id: "FGP9i1CpCssY7eJVHArF",
        type: "ideas",
        notes: "just using this as a test section for now",
        date: "2025-12-06",
        createdAt: "2025-12-06T13:27:41.899Z",
        mainMenu: { id:"grain", label:"Grain" },
        subMenu: { id:"grain-tix", label:"Grain Tickets (OCR)" },
        submittedBy: {
          name: "Dane Killam",
          email: "danekillam@gmail.com",
          uid: "zD2ssHGNE6RmBSqAyg8r3s3tBKl2"
        },
        appVersion: {
          date: "2025-11-02",
          number: "11.29.03",
          tagline: "Farm Data - Simplified"
        },
        attachments: [
          {
            contentType: "image/jpeg",
            name: "2025-11-30 11.25.51.jpg",
            path: "feedback/ideas/FGP9i1CpCssY7eJVHArF/screenshots/1765027663066-0-2025-11-30_11.25.51.jpg",
            size: 6517304,
            url: "https://firebasestorage.googleapis.com/v0/b/dowsonfarms-illinois.firebasestorage.app/o/feedback%2Fideas%2FFGP9i1CpCssY7eJVHArF%2Fscreenshots%2F1765027663066-0-2025-11-30_11.25.51.jpg?alt=media&token=49a3a83b-62c6-4262-80fd-143e12934d55"
          }
        ]
      },
      {
        id: "BUG-EXAMPLE",
        type: "bugs",
        notes: "Spraying portal buttons look clickable but go nowhere.",
        date: "2025-12-01",
        createdAt: "2025-12-01T15:12:00.000Z",
        mainMenu: { id:"ops", label:"Operational Records" },
        subMenu: { id:"spraying", label:"Spraying Portal" },
        submittedBy: {
          name: "Operator A",
          email: "operator@example.com",
          uid: "operator-uid"
        },
        appVersion: {
          date: "2025-11-30",
          number: "11.30.01",
          tagline: "Farm Data - Simplified"
        },
        attachments: []
      }
    ];

    // ===== DOM refs =====
    const listEl      = document.getElementById("report-list");
    const emptyEl     = document.getElementById("report-empty");
    const typeSel     = document.getElementById("filter-type");
    const mainMenuSel = document.getElementById("filter-main-menu");
    const searchEl    = document.getElementById("filter-search");
    const clearBtn    = document.getElementById("filter-clear");
    const printBtn    = document.getElementById("btn-print");

    const statTotal   = document.getElementById("stat-total");
    const statMix     = document.getElementById("stat-mix");
    const statMixSub  = document.getElementById("stat-mix-sub");
    const statLatest  = document.getElementById("stat-latest");
    const statLatestSub = document.getElementById("stat-latest-sub");
    const tagGeneratedAt = document.getElementById("tag-generated-at");

    if (!listEl) return;

    function toDate(isoOrNull){
      try{
        if (!isoOrNull) return null;
        return new Date(isoOrNull);
      }catch{
        return null;
      }
    }

    function formatDateShort(iso){
      if (!iso) return "";
      try{
        const d = new Date(iso);
        return d.toLocaleDateString(undefined,{
          month:"short", day:"numeric", year:"numeric"
        });
      }catch{
        return "";
      }
    }

    function formatDateTimeShort(iso){
      if (!iso) return "";
      try{
        const d = new Date(iso);
        return d.toLocaleString(undefined,{
          month:"short", day:"numeric", hour:"numeric", minute:"2-digit"
        });
      }catch{
        return "";
      }
    }

    function updateGeneratedTag(){
      try{
        tagGeneratedAt.textContent = new Date().toLocaleString(undefined,{
          month:"short", day:"numeric", hour:"numeric", minute:"2-digit"
        });
      }catch{
        tagGeneratedAt.textContent = "";
      }
    }

    // Populate main menu dropdown from data
    function populateMainMenuFilter(data){
      const menus = new Map();
      data.forEach(d => {
        if (!d.mainMenu || !d.mainMenu.label) return;
        menus.set(d.mainMenu.id || d.mainMenu.label, d.mainMenu.label);
      });

      while (mainMenuSel.options.length > 1){
        mainMenuSel.remove(1);
      }

      Array.from(menus.entries())
        .sort((a,b)=> (a[1] || "").localeCompare(b[1] || ""))
        .forEach(([id,label])=>{
          const opt = document.createElement("option");
          opt.value = id;
          opt.textContent = label;
          mainMenuSel.appendChild(opt);
        });
    }

    function applyFilters(data){
      const typeFilter = (typeSel.value || "all").toLowerCase();
      const menuFilter = mainMenuSel.value || "all";
      const q          = (searchEl.value || "").trim().toLowerCase();

      return data.filter(d => {
        const t = String(d.type || "").toLowerCase();
        if (typeFilter !== "all" && t !== typeFilter) return false;

        if (menuFilter !== "all"){
          const id = (d.mainMenu && (d.mainMenu.id || d.mainMenu.label)) || "";
          if (id !== menuFilter) return false;
        }

        if (q){
          const hay = [
            d.notes,
            d.type,
            d.mainMenu && d.mainMenu.label,
            d.subMenu && d.subMenu.label,
            d.submittedBy && d.submittedBy.name,
            d.submittedBy && d.submittedBy.email,
            d.appVersion && d.appVersion.number
          ].join(" ").toLowerCase();
          if (!hay.includes(q)) return false;
        }

        return true;
      });
    }

    function renderStats(data){
      const total = data.length;
      statTotal.textContent = total.toString();

      const bugCount  = data.filter(d => String(d.type || "").toLowerCase() === "bugs").length;
      const ideaCount = data.filter(d => String(d.type || "").toLowerCase() === "ideas").length;

      if (!total){
        statMix.textContent = "â€“";
        statMixSub.textContent = "No feedback recorded.";
      }else{
        statMix.textContent = bugCount + " / " + ideaCount;
        statMixSub.textContent = `Bugs / ideas (total ${total})`;
      }

      if (!total){
        statLatest.textContent = "â€“";
        statLatestSub.textContent = "No feedback received yet.";
      }else{
        const latest = data.reduce((max,d)=>{
          const t = toDate(d.createdAt || d.date)?.getTime() ?? 0;
          return (t > max.t) ? { t, d } : max;
        }, { t: 0, d: null });

        const latestLabel = latest.d ? formatDateShort(latest.d.createdAt || latest.d.date) : "";
        statLatest.textContent = latestLabel || "â€“";

        const who = latest.d && latest.d.submittedBy && latest.d.submittedBy.name;
        const which = latest.d && (latest.d.type || "").toLowerCase();
        const whichLabel = which ? (which === "bugs" ? "bug" : "idea") : "feedback";

        statLatestSub.textContent = latestLabel
          ? `Most recent ${whichLabel}${who ? " from " + who : ""}.`
          : "Most recent feedback.";
      }
    }

    function renderList(data){
      const filtered = applyFilters(data);

      // Stats are based on ALL data, not just filtered
      renderStats(data);

      listEl.innerHTML = "";

      if (!filtered.length){
        emptyEl.style.display = "block";
        listEl.appendChild(emptyEl);
        return;
      }

      emptyEl.style.display = "none";

      filtered
        .slice() // copy
        .sort((a,b)=>{
          return new Date(b.createdAt || b.date || 0) - new Date(a.createdAt || a.date || 0);
        })
        .forEach(d => {
          const type    = (d.type || "").toLowerCase();
          const notes   = d.notes || "";
          const where   = [
            d.mainMenu && d.mainMenu.label,
            d.subMenu && d.subMenu.label
          ].filter(Boolean).join(" â†’ ") || "(Unknown location)";
          const when    = formatDateShort(d.createdAt || d.date) || "";
          const whenTs  = formatDateTimeShort(d.createdAt || d.date) || "";
          const who     = d.submittedBy && d.submittedBy.name || "";
          const email   = d.submittedBy && d.submittedBy.email || "";
          const version = d.appVersion && d.appVersion.number || "";
          const attachCount = Array.isArray(d.attachments) ? d.attachments.length : 0;

          const typeLabel = type === "bugs" ? "Bug" : (type === "ideas" ? "Idea" : "Other");
          const typeClass = type === "bugs" ? "tag-green" : (type === "ideas" ? "tag-idea" : "");

          const attachmentsHtml = (d.attachments || []).slice(0,3).map(a => {
            const baseName = a.name || (a.path || "").split("/").pop() || "Attachment";
            return `<a href="${a.url || "#"}" target="_blank" rel="noopener" class="attachment-pill" title="${baseName}">
                      ðŸ“Ž ${baseName}
                    </a>`;
          }).join("");

          const extraAttachmentNote = attachCount > 3
            ? `<div style="font-size:11px;opacity:.75;">+${attachCount - 3} more in storage</div>`
            : "";

          const notesTitle = notes.replace(/"/g,'&quot;');

          const row = document.createElement("article");
          row.className = "report-row";
          row.innerHTML = `
            <div class="report-cell-main">
              <div class="cell-title">${notes ? notes.split("\n")[0] : "(No notes)"}${notes && notes.length > 80 ? "â€¦" : ""}</div>
              <div class="cell-notes" title="${notesTitle}">
                ${notes || "<span style='opacity:.7'>(No description entered)</span>"}
              </div>
            </div>
            <div class="cell-meta">
              <div>${where}</div>
              ${version ? `<div style="opacity:.8;">App v${version}</div>` : ""}
            </div>
            <div class="cell-meta">
              ${when ? `<div>${when}</div>` : ""}
              ${whenTs ? `<div style="opacity:.8;">${whenTs}</div>` : ""}
              ${who ? `<div style="opacity:.85;">By: ${who}</div>` : ""}
              ${email ? `<div style="opacity:.75;">${email}</div>` : ""}
            </div>
            <div class="cell-meta">
              <div class="cell-tags">
                <span class="tag ${typeClass}">${typeLabel}</span>
              </div>
              <div class="cell-tags" style="margin-top:4px;">
                ${attachmentsHtml || "<span style='font-size:11px;opacity:.7;'>(No attachments)</span>"}
              </div>
              ${extraAttachmentNote}
            </div>
          `;
          listEl.appendChild(row);
        });
    }

    function bindEvents(data){
      const refresh = () => renderList(data);

      typeSel.addEventListener("change", refresh);
      mainMenuSel.addEventListener("change", refresh);
      searchEl.addEventListener("input", refresh);

      clearBtn.addEventListener("click", () => {
        typeSel.value = "all";
        mainMenuSel.value = "all";
        searchEl.value = "";
        renderList(data);
      });

      printBtn.addEventListener("click", () => {
        // For Cloud Run PDF, you can also just point it at this URL.
        window.print();
      });
    }

    function init(){
      updateGeneratedTag();
      populateMainMenuFilter(demoFeedbackData);
      bindEvents(demoFeedbackData);
      renderList(demoFeedbackData);
    }

    document.addEventListener("DOMContentLoaded", init);
  })();
  </script>
</body>
</html>
