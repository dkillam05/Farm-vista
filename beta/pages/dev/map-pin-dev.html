<!-- =====================================================================
/Farm-vista/pages/dev/map-pin-dev.html
Dev page ‚Äì Map pin tester using modal + fv-map.js
Flow:
 ‚Ä¢ Button: "Mark Location (Optional)"
 ‚Ä¢ Opens modal with satellite map + "Use my location"
 ‚Ä¢ Tap to drop pin, then "Save location" closes modal + shows toast
 ‚Ä¢ Lat/long stored in hidden inputs for future Firestore save
===================================================================== -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>FarmVista ‚Ä¢ Map Pin Dev</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#3B7E46" />

  <!-- ABSOLUTE PATHS -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest" />
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png" />
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png" />
  <script src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css" />
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css" />

  <!-- Ensure fv-shell -->
  <script>
    (function () {
      if (!customElements.get('fv-shell')) {
        const s = document.createElement('script');
        s.src = '/Farm-vista/js/fv-shell.js';
        s.defer = true;
        document.head.appendChild(s);
      }
    })();
  </script>

  <style>
    :root{
      --card-max: 1100px;
      --page-bottom-gap: 96px;
      --accent: #2F6C3C;
    }

    body{
      background: var(--app-bg, var(--surface));
    }

    .wrap{
      max-width: var(--card-max);
      margin: 0 auto;
      padding: clamp(14px,3vw,22px);
      padding-bottom: calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + var(--page-bottom-gap)) !important;
      box-sizing: border-box;
    }

    .hero{
      border:1px solid var(--border);
      border-radius:14px;
      background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));
      overflow:hidden;
      margin-bottom: var(--page-bottom-gap);
    }

    .hero-head{
      display:grid;
      grid-template-columns:36px 1fr;
      gap:12px;
      align-items:center;
      padding:14px 16px;
      background:linear-gradient(90deg, rgba(47,108,60,.12), transparent);
      border-bottom:1px solid var(--border);
    }
    .hero-head .icon{
      width:24px;
      height:24px;
      display:grid;
      place-items:center;
      color:var(--accent);
    }
    .hero-head h1{
      margin:0;
      font-size:clamp(20px,3.2vw,26px);
      line-height:1.2;
    }
    .muted{ color:var(--muted,#67706B); }

    .body{
      padding:16px;
      display:grid;
      gap:14px;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:160px;
      padding:12px 18px;
      border-radius:12px;
      border:1px solid var(--border);
      font-weight:800;
      text-decoration:none;
      cursor:pointer;
      user-select:none;
      color:var(--text) !important;
      background:var(--card-surface,var(--surface));
      -webkit-appearance:none;
      appearance:none;
    }
    .btn-primary{
      background:#2F6C3C;
      border-color:#2F6C3C;
      color:#fff !important;
    }
    .btn-quiet{
      background:transparent;
    }
    .btn[disabled]{ opacity:.6; cursor:not-allowed; }

    .muted-line{
      font-size:13px;
      color:var(--muted,#67706B);
    }

    /* Modal shell ‚Äì same pattern as other pages */
    .modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index:100000;
    }
    .modal.show{ display:flex; }
    .backdrop{
      position:absolute;
      inset:0;
      background:rgba(0,0,0,.45);
    }
    .sheet{
      position:relative;
      width:min(100vw,760px);
      max-width:90vw;
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:14px;
      box-shadow:0 20px 40px rgba(0,0,0,.35);
      display:flex;
      flex-direction:column;
      max-height:90vh;
      overflow:hidden;
    }
    .sheet header{
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      font-weight:800;
      display:flex;
      align-items:center;
      justify-content:space-between;
      color:var(--text);
      flex:0 0 auto;
    }
    .sheet header .close{
      border:none;
      background:transparent;
      font:inherit;
      font-weight:800;
      cursor:pointer;
      padding:6px 10px;
      border-radius:10px;
      color:var(--text);
    }
    .sheet header .close:hover{
      background:var(--hover,rgba(0,0,0,.06));
    }

    .map-modal-body{
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      flex:1 1 auto;
      min-height:0;
    }

    .map-shell{
      border-radius:14px;
      border:1px solid var(--border);
      overflow:hidden;
      background:#111;
    }
    #fvMap{
      width:100%;
      height:360px;
      background:#111;
    }
    .map-footer{
      padding:8px 10px;
      background:var(--surface);
      border-top:1px solid var(--border);
      font-size:13px;
    }

    .sheet footer{
      padding:10px 12px 12px;
      border-top:1px solid var(--border);
      display:flex;
      justify-content:flex-end;
      gap:8px;
      flex:0 0 auto;
    }

    @media (max-width:640px){
      #fvMap{ height:320px; }
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:calc(env(safe-area-inset-bottom,0px) + 72px);
      transform:translateX(-50%);
      background:#2F6C3C;
      color:#fff;
      padding:10px 14px;
      border-radius:10px;
      box-shadow:0 6px 20px rgba(0,0,0,.25);
      z-index:110000;
      display:none;
      white-space:nowrap;
      max-width:92vw;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .toast.show{
      display:block;
      animation:fadeout 3.0s forwards;
    }
    @keyframes fadeout{
      0%{opacity:1}
      85%{opacity:1}
      100%{opacity:0}
    }
  </style>
</head>
<body>
  <fv-shell>
    <div class="wrap">
      <section class="hero">
        <header class="hero-head">
          <div class="icon" aria-hidden="true">üìç</div>
          <div>
            <h1>Map Pin Dev</h1>
            <p class="muted">
              Use this page to test dropping a satellite map pin inside a modal.
              Later, these coordinates will be saved with your field maintenance forms.
            </p>
          </div>
        </header>

        <div class="body">
          <button id="btnOpenMap" type="button" class="btn btn-primary">
            Mark Location (Optional)
          </button>
          <p class="muted-line">
            When you tap ‚ÄúMark Location (Optional)‚Äù, a full-screen map will open.
            Drop a pin, hit ‚ÄúSave location‚Äù, and then continue filling out your form.
          </p>
        </div>
      </section>
    </div>
  </fv-shell>

  <!-- Hidden storage for coordinates (for future Firestore save) -->
  <input id="latHidden" type="hidden" value="" />
  <input id="lngHidden" type="hidden" value="" />

  <!-- Map modal -->
  <div id="mapModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="mapModalTitle">
    <div class="backdrop" data-close></div>
    <div class="sheet">
      <header>
        <div id="mapModalTitle">Mark Location</div>
        <button class="close" type="button" data-close>Close</button>
      </header>

      <div class="map-modal-body">
        <button id="btnUseLocation" type="button" class="btn">
          Use my location
        </button>
        <div id="mapHelp" class="muted-line">
          Loading map‚Ä¶
        </div>
        <div class="map-shell">
          <div id="fvMap"></div>
          <div class="map-footer">
            <span id="locationStatus" class="muted-line"></span>
          </div>
        </div>
      </div>

      <footer>
        <button id="btnCancelLocation" type="button" class="btn btn-quiet">
          Cancel
        </button>
        <button id="btnSaveLocation" type="button" class="btn btn-primary">
          Save location
        </button>
      </footer>
    </div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite">Location saved.</div>

  <!-- Map helper (must be before Google script so callback exists) -->
  <script src="/Farm-vista/js/fv-map.js"></script>

  <!-- Google Maps JavaScript API
       NOTE: key is public; keep it restricted to your GitHub Pages domain. -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCzKBEQ1-wCJ8_nv1dR3wQI0nTk1IrgWzY&callback=fvMapInit"
    async
    defer>
  </script>

  <!-- Page wiring -->
  <script type="module">
    import { NAV_MENU } from '/Farm-vista/js/menu.js';

    const shell = document.querySelector('fv-shell');
    if (shell && NAV_MENU) shell.nav = NAV_MENU;

    const $ = (id) => document.getElementById(id);
    const modal = $("mapModal");
    const toast = $("toast");
    const latHidden = $("latHidden");
    const lngHidden = $("lngHidden");

    function showModal() {
      if (!modal) return;
      modal.classList.add("show");
      document.body.style.overflow = "hidden";
    }
    function hideModal() {
      if (!modal) return;
      modal.classList.remove("show");
      document.body.style.overflow = "";
    }

    function showToast(msg = "Location saved.") {
      if (!toast) return;
      toast.textContent = msg;
      toast.classList.remove("show");
      // force reflow
      void toast.offsetWidth;
      toast.classList.add("show");
      setTimeout(() => {
        toast.classList.remove("show");
      }, 3000);
    }

    // Open modal
    $("btnOpenMap").addEventListener("click", () => {
      showModal();
    });

    // Close modal (X or backdrop or Cancel)
    modal.querySelectorAll("[data-close], #btnCancelLocation").forEach((el) => {
      el.addEventListener("click", () => {
        hideModal();
      });
    });
    modal.querySelector(".backdrop").addEventListener("click", () => {
      hideModal();
    });

    // Use my location
    $("btnUseLocation").addEventListener("click", () => {
      if (window.FVMap && typeof window.FVMap.useMyLocation === "function") {
        window.FVMap.useMyLocation();
      }
    });

    // Save location from modal
    $("btnSaveLocation").addEventListener("click", () => {
      if (!(window.FVMap && typeof window.FVMap.getLastLatLng === "function")) {
        showToast("Map not ready yet.");
        return;
      }
      const ll = window.FVMap.getLastLatLng();
      if (!ll) {
        showToast("Tap on the map to drop a pin first.");
        return;
      }

      // Hidden fields already updated by fv-map.js; just close + toast
      console.log("Saved map location:", latHidden.value, lngHidden.value);
      hideModal();
      showToast("Location saved.");
    });
  </script>
</body>
</html>