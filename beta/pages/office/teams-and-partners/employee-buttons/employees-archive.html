<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <title>FarmVista â€¢ Archived / Inactive Employees</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#3B7E46"/>

  <!-- Absolute app paths to match your other employee pages -->
  <link rel="manifest" href="/Farm-vista/manifest.webmanifest"/>
  <link rel="apple-touch-icon" href="/Farm-vista/assets/icons/apple-touch-icon.png"/>
  <link rel="icon" href="/Farm-vista/assets/icons/icon-192.png"/>
  <script defer src="/Farm-vista/js/theme-boot.js"></script>
  <link rel="stylesheet" href="/Farm-vista/assets/css/theme.css"/>
  <link rel="stylesheet" href="/Farm-vista/assets/css/app.css"/>

  <!-- Ensure fv-shell is available -->
  <script>
    (function(){
      if(!customElements.get('fv-shell')){
        const s=document.createElement('script');
        s.src='/Farm-vista/js/fv-shell.js'; s.defer=true; document.head.appendChild(s);
      }
    })();
  </script>

  <!-- Firebase config FIRST -->
  <script src="/Farm-vista/js/firebase-config.js"></script>

  <style>
    .page{max-width:1100px;margin:0 auto;padding:clamp(14px,3vw,22px);
      padding-bottom:calc(env(safe-area-inset-bottom,0px) + var(--ftr-h,42px) + 96px)!important;}
    .title{margin:0 0 6px 0}
    .sub{margin:0 0 16px 0;color:var(--muted,#6f7772)}

    .search{display:flex;align-items:center;gap:10px;border:1px solid var(--border);
      border-radius:12px;background:var(--surface);padding:10px 12px;margin:0 0 12px 0}
    .search input{flex:1;background:transparent;border:0;outline:none;font:inherit}

    .list{display:grid;gap:12px}
    .card{border:1px solid var(--border);border-radius:14px;background:var(--surface);
      box-shadow:var(--shadow,0 8px 20px rgba(0,0,0,.08));padding:12px 14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .name{font-weight:800;font-size:1.02rem}
    .badges{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0}
    .badge{padding:4px 10px;border-radius:999px;font-size:13px;font-weight:800;background:#eef0ee;color:#3d4741}
    .badge.green{background:#e7f1ea;color:#2F6C3C}
    .muted{color:var(--muted,#87908a)}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
    .btn{display:inline-flex;align-items:center;justify-content:center;min-width:120px;padding:10px 14px;border-radius:12px;
      border:1px solid var(--border);background:var(--card-surface,var(--surface));font-weight:800;color:var(--text);cursor:pointer;}
    .btn[disabled]{opacity:.5;pointer-events:none}
    .btn-primary{border-color:transparent;background:#2F6C3C;color:#fff;}
    .btn-danger{border-color:#b3261e;color:#b3261e;background:var(--surface);}
    .count{margin:10px 0;font-weight:700;color:var(--muted,#6f7772)}
    .empty{color:var(--muted,#87908a);padding:6px 2px}

    .toast{position:fixed;left:50%;bottom:calc(env(safe-area-inset-bottom,0px) + 72px);transform:translateX(-50%);
      background:#2F6C3C;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,.25);z-index:99999;display:none;}
    .toast.show{display:block;animation:fadeout 2.8s forwards;}
    @keyframes fadeout{0%{opacity:1}85%{opacity:1}100%{opacity:0}}
  </style>
</head>
<body>
  <fv-shell>
    <div class="page container">
      <h1 class="title">Employee Archive</h1>
      <p class="sub">Anyone marked <strong>Inactive</strong> shows up here. Archive them for record keeping, or permanently delete if they arenâ€™t referenced anywhere.</p>

      <div class="search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M21 21l-4.2-4.2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <circle cx="11" cy="11" r="7" stroke="currentColor" stroke-width="2"/></svg>
        <input id="q" type="search" placeholder="Search" autocomplete="off"/>
      </div>

      <p id="count" class="count">0 entries</p>
      <div id="list" class="list" aria-live="polite"></div>
      <p id="empty" class="empty" style="display:none">No inactive employees.</p>
    </div>
  </fv-shell>

  <div id="toast" class="toast" role="status" aria-live="polite">Done.</div>

  <script type="module">
    import {
      ready,
      getFirestore, collection, query, where, onSnapshot,
      doc, getDoc, setDoc, deleteDoc, serverTimestamp, getDocs
    } from '/Farm-vista/js/firebase-init.js';

    const $ = id => document.getElementById(id);
    const listEl = $("list"), countEl = $("count"), emptyEl = $("empty"), qEl = $("q");
    const toast = $("toast");
    const showToast = (m="Done.")=>{ toast.textContent=m; toast.classList.remove("show"); void toast.offsetWidth; toast.classList.add("show"); };

    let ALL = []; // {id, data}

    // ðŸ”Ž Configure where to look for usage BEFORE allowing delete.
    // Each entry: { col: 'collectionName', fields: ['employeeId','assignee','createdBy'] }
    // If you don't need checks, leave array empty and deletes will be allowed.
    const USAGE_CHECKS = [
      // Example guesses â€” edit to match your schema or leave empty.
      { col:'assignments', fields:['employeeId','assignee'] },
      { col:'workOrders',  fields:['assignedTo','createdBy'] },
      { col:'grainTickets',fields:['enteredBy','driverId'] },
    ];

    const emailKey = s => String(s||'').trim().toLowerCase();

    function render(){
      const q = (qEl.value||'').toLowerCase().trim();
      const rows = ALL.filter(x=>{
        if(q==='') return true;
        const d=x.data, blob=[d.fullName,d.firstName,d.lastName,d.email,d.role,d.permissionGroup].join(' ').toLowerCase();
        return blob.includes(q);
      }).sort((a,b)=>(a.data.fullName||'').localeCompare(b.data.fullName||''));

      countEl.textContent = `${rows.length}/${ALL.length} entries`;
      listEl.innerHTML = '';
      emptyEl.style.display = rows.length ? 'none' : 'block';

      for(const it of rows){
        const d = it.data;
        const card = document.createElement('div'); card.className='card';

        const header = document.createElement('div'); header.className='row';
        const name = document.createElement('div'); name.className='name'; name.textContent = d.fullName || '(no name)';
        header.appendChild(name);

        const badges = document.createElement('div'); badges.className='badges';
        badges.innerHTML = `
          <span class="badge">Inactive</span>
          ${d.permissionGroup? `<span class="badge">${d.permissionGroup}</span>`:''}
          ${d.archived? `<span class="badge green">Archived</span>`:''}
        `;

        const meta = document.createElement('div'); meta.className='muted';
        const email = d.email ? `âœ‰ï¸ ${d.email}` : '';
        const phone = d.phone ? ` â€¢ ðŸ“ž ${d.phone}` : '';
        meta.textContent = (email || '') + (phone || '');

        const actions = document.createElement('div'); actions.className='actions';
        const btnArchive = document.createElement('button');
        btnArchive.className='btn btn-primary';
        btnArchive.textContent = d.archived ? 'Archived' : 'Archive';
        btnArchive.disabled = !!(d.archived);
        btnArchive.addEventListener('click', ()=> archiveEmployee(it.id));

        const btnDelete = document.createElement('button');
        btnDelete.className='btn btn-danger';
        btnDelete.textContent = 'Delete';
        btnDelete.addEventListener('click', ()=> confirmDelete(it.id, d.fullName || it.id));

        actions.append(btnArchive, btnDelete);

        card.append(header, badges, meta, actions);
        listEl.appendChild(card);
      }
    }

    async function archiveEmployee(id){
      try{
        const db = getFirestore();
        const ref = doc(db, 'employees', id);
        await setDoc(ref, { archived:true, archivedAt: serverTimestamp() }, { merge:true });
        showToast('Archived.');
      }catch(err){
        console.error(err); alert('Archive failed.\n\n'+(err?.message||err));
      }
    }

    async function findUsageCount(id){
      if(!USAGE_CHECKS.length) return 0;
      const db = getFirestore();
      let total = 0;

      // naive fan-out: OR across fields by running multiple where() queries
      for(const check of USAGE_CHECKS){
        for(const f of (check.fields||[])){
          try{
            const qref = query(collection(db, check.col), where(f, '==', id));
            const snap = await getDocs(qref);
            total += snap.size;
            if(total>0) return total; // early exit if any reference exists
          }catch(e){ /* ignore missing collections */ }
        }
      }
      return total;
    }

    async function confirmDelete(id, label){
      try{
        const usage = await findUsageCount(id);
        if(usage>0){
          alert(`Cannot delete "${label}" â€” ${usage} linked record${usage>1?'s':''} found.\nArchive instead to keep history.`);
          return;
        }
        if(!confirm(`Delete "${label}" permanently?\nThis cannot be undone.`)) return;
        const db = getFirestore();
        await deleteDoc(doc(db,'employees',id));
        showToast('Deleted.');
      }catch(err){
        console.error(err); alert('Delete failed.\n\n'+(err?.message||err));
      }
    }

    function startLive(){
      const db = getFirestore();
      // Inactive = status != 'Active' OR active:false
      const q1 = query(collection(db,'employees'), where('active','==',false));
      const q2 = query(collection(db,'employees'), where('status','!=','Active')); // note: != uses "not equal"; may need composite index

      // Merge two snapshots into a unique set
      const map = new Map();
      const apply = (snap)=>{
        snap.docChanges().forEach(ch=>{
          const id = ch.doc.id; const d = ch.doc.data()||{};
          if(ch.type==='removed'){ map.delete(id); return; }
          const status = String(d.status||'').toLowerCase();
          const inactive = (status!=='active') || (d.active===false);
          if(inactive){ map.set(id,{id, data:d}); } else { map.delete(id); }
        });
        ALL = Array.from(map.values());
        render();
      };

      onSnapshot(q1, apply, console.error);
      onSnapshot(q2, apply, console.error);
    }

    qEl.addEventListener('input', render);

    ready.then(startLive).catch(console.error);
  </script>
</body>
</html>